services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.1
    container_name: webjetcms-keycloak
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: "admin"
      KC_BOOTSTRAP_ADMIN_PASSWORD: "${CODECEPT_DEFAULT_PASSWORD}"
      KC_HTTP_PORT: 18080
      KC_HTTPS_PORT: 18443
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_LOG_LEVEL: "INFO"
      CODECEPT_DEFAULT_PASSWORD: "${CODECEPT_DEFAULT_PASSWORD}"
    ports:
      - "18080:18080"
      - "18443:18443"
    entrypoint: /bin/bash
    command:
      - -c
      - |
        mkdir -p /opt/keycloak/data/import
        sed "s/\${CODECEPT_DEFAULT_PASSWORD}/$CODECEPT_DEFAULT_PASSWORD/g" /opt/keycloak/realm-template/realm-export.json.template > /opt/keycloak/data/import/realm-export.json
        exec /opt/keycloak/bin/kc.sh start-dev --import-realm
    volumes:
      - webjetcms-keycloakdata:/opt/keycloak/data
      - ./realm-export.json.template:/opt/keycloak/realm-template/realm-export.json.template:ro
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/18080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G

volumes:
  webjetcms-keycloakdata:
