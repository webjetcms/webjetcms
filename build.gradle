import org.apache.tools.ant.taskdefs.condition.Os

/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds/
 */

plugins {
    id 'java-library'
    id 'war'
    id 'org.gretty' version "3.1.1"
    id "com.jfrog.artifactory" version "4.26.1"
    id 'idea'
    //https://docs.freefair.io/gradle-plugins/current/reference/ + https://projectlombok.org
    id "io.freefair.lombok" version "8.0.1"
    id "org.owasp.dependencycheck" version "8.2.1"
    id 'maven-publish'
    id 'jacoco'
}

repositories {
    mavenCentral()
    maven {
        url "https://pd4ml.tech/maven2/"
    }
    flatDir {
       dirs 'libs'
   }
}

ext {
    //pri zmene verzie je potrebne to zmenit aj v build.xml a compile.xml
    mapstructVersion = "1.4.2.Final";
    springVersion = "5.3.+";
    springSecurityVersion = "5.8.+";
}

war {
    zip64 = true
    exclude('**/node_modules/**')
    exclude('**/node_scripts/**')
    exclude('**/src/**')
    exclude('**/tmp/**')
    exclude('**/*.log')
    exclude('**/*.map')
    exclude('**/*.md')
    exclude('**/*.sh')
    exclude('**/.npmrc')
    exclude('**/.editorconfig')
    exclude('**/gulpfile.js')
    exclude('**/package-lock.json')
    exclude('**/package.json')
    exclude('**/webpack*.js')
    exclude('**/WEB-INF/imgcache/**')
    exclude('**/scss/**')
    exclude('scratchpad*.jsp')
    exclude('localconf*.jsp')
    exclude('**/LICENSE')
    exclude('**/*.psd')
    exclude('**/*.zip')

    //pug files
    exclude('**/pug/**')
    exclude('**/admin/v9/views/**')
    exclude('**/*.pug')
    exclude('**/prepros-6.config')

    //templates
    exclude('templates/bare/**')
    exclude('templates/agency/**')
    exclude('templates/creative/**')
    exclude('templates/firma/**')
    exclude('templates/interway/**')
    exclude('templates/kostal/**')
    exclude('templates/wa/**')
    exclude('templates/vesmir/**')

    rootSpec.exclude('**/poolman-*.xml')
}

sourceSets {
    main {
        java {
            srcDirs 'src/main/java'
            srcDirs 'src/webjet8/java'
        }
    }
 }

dependencies {

    //WebJET dependencies
    implementation("com.amazonaws:aws-java-sdk-core:1.12.+")
    implementation("com.amazonaws:aws-java-sdk-ses:1.12.+")
    implementation("bsf:bsf:2.4.0")
    implementation("commons-beanutils:commons-beanutils:1.9.4")
    implementation("commons-chain:commons-chain:1.2")
    implementation("org.apache.commons:commons-collections4:4.4")
    implementation("org.apache.commons:commons-compress:1.21")
    implementation("commons-dbcp:commons-dbcp:1.4")
    implementation("commons-digester:commons-digester:2.0")
    implementation("commons-fileupload:commons-fileupload:1.+")
    implementation("commons-io:commons-io:2.11.0")
    implementation("commons-lang:commons-lang:2.6")
    implementation("org.apache.commons:commons-lang3:3.12.0")
    implementation("org.apache.directory.studio:org.apache.commons.pool:1.6")
    implementation("commons-validator:commons-validator:1.3.1")
    implementation("sk.iway:wjcron4j:2.2.5-SNAPSHOT")
    implementation("taglibs:datetime:1.0.1")
    implementation("sk.iway:wjdisplaytag:1.2-SNAPSHOT")
    implementation("org.eclipse.persistence:eclipselink:2.7.+")
    implementation("org.freemarker:freemarker:2.3.28")
    implementation("com.google.code.gson:gson:2.8.9")
    implementation("org.hibernate.validator:hibernate-validator:6.0.22.Final")
    implementation("org.apache.httpcomponents:httpclient:4.5.13")
    implementation("org.apache.httpcomponents:fluent-hc:4.5.13")
    implementation("com.fasterxml.jackson.core:jackson-annotations:2.15.+")
    implementation("com.fasterxml.jackson.core:jackson-databind:2.15.+")
    implementation("sk.iway:wjjcaptcha:1.0-SNAPSHOT")
    implementation("net.htmlparser.jericho:jericho-html:3.1")
    implementation("joda-time:joda-time:2.10.13")
    implementation("io.bit3:jsass:5.1.1")
    implementation("org.jsoup:jsoup:1.15.3")
    implementation("net.sourceforge.jtds:jtds:1.3.1")
    implementation("net.sourceforge.jexcelapi:jxl:2.6.10")
    implementation("org.apache.lucene:lucene-core:3.6.2")
    implementation("org.apache.lucene:lucene-spellchecker:3.6.2")
    implementation("org.apache.lucene:lucene-highlighter:3.6.2")
    implementation("org.apache.lucene:lucene-memory:3.6.2")
    implementation("org.apache.lucene:lucene-analyzers:3.6.2")
    implementation("org.mariadb.jdbc:mariadb-java-client:2.7.5")
    implementation("com.drewnoakes:metadata-extractor:2.18.0")
    implementation("com.oracle.database.jdbc:ojdbc8:19.8.0.0")
    implementation("org.mcavallo:opencloud:0.3")
    implementation("com.pd4ml:pd4ml:4.0.+")
    implementation("org.apache.pdfbox:pdfbox:2.0.25")
    implementation("org.apache.poi:poi-ooxml:5.2.2")
    implementation("org.apache.poi:poi-scratchpad:5.2.2")
    implementation("org.apache.poi:poi:5.2.2")
    implementation("io.github.duckasteroid.cdb:sg-cdb-library:1.0.3")
    implementation("org.springframework:spring-aop:${springVersion}")
    implementation("org.springframework:spring-beans:${springVersion}")
    implementation("org.springframework:spring-context:${springVersion}")
    implementation("org.springframework.data:spring-data-commons:2.6.1")
    implementation("org.springframework.data:spring-data-jpa:2.6.1")
    implementation("org.springframework:spring-orm:${springVersion}")
    implementation("org.springframework:spring-tx:${springVersion}")
    implementation("org.springframework.security:spring-security-core:${springSecurityVersion}")
    implementation("org.springframework.security:spring-security-config:${springSecurityVersion}")
    implementation("org.springframework.security:spring-security-web:${springSecurityVersion}")
    implementation("org.springframework:spring-webmvc:${springVersion}")
    implementation("org.springframework:spring-context-support:${springVersion}")
    implementation("org.springframework:spring-test:${springVersion}")
    implementation("org.springframework.plugin:spring-plugin-core:2.0.0.RELEASE")
    implementation("org.springframework.plugin:spring-plugin-metadata:2.0.0.RELEASE")
    implementation("io.springfox:springfox-core:3.0.0")
    implementation("io.springfox:springfox-swagger2:3.0.0")
    implementation("io.swagger.core.v3:swagger-annotations:2.1.12")
    implementation("sk.iway:wjstripes:1.6.0-SNAPSHOT")
    implementation("net.sf.trove4j:trove4j:2.1.0")
    implementation("net.sf.uadetector:uadetector-core:0.9.22")
    implementation("net.sf.uadetector:uadetector-resources:2014.10")
    implementation("org.apache.velocity.tools:velocity-tools-generic:3.1")
    implementation("org.apache.velocity:velocity-engine-core:2.3")
    implementation("org.json:json:20231013")
    implementation("cryptix:cryptix:3.2.0")
    implementation("com.sun.mail:javax.mail:1.6.2")
    implementation("org.springframework:spring-messaging:${springVersion}")
    implementation("com.google.crypto.tink:tink:1.12.0")
    implementation("com.google.protobuf:protobuf-java:3.21.7")
    implementation("ch.qos.logback:logback-core:1.3.14")
    implementation("ch.qos.logback:logback-classic:1.3.14")
    implementation("org.slf4j:slf4j-api:1.7.36")
    implementation("org.slf4j:jcl-over-slf4j:1.7.36")
    implementation("org.slf4j:log4j-over-slf4j:1.7.36")
    implementation("org.apache.logging.log4j:log4j-to-slf4j:2.17.1")
    implementation("com.google.code.findbugs:jsr305:3.0.2")
    implementation("org.aspectj:aspectjrt:1.9.19")
    implementation("org.aspectj:aspectjweaver:1.9.19")
    implementation("xerces:xercesImpl:2.12.2")
    implementation("org.apache.taglibs:taglibs-standard-spec:1.2.5")
    implementation("org.apache.taglibs:taglibs-standard-impl:1.2.5")

    //backport WJ8 tried
    implementation('com.mchange:c3p0:0.9.5.5')
    implementation('com.oracle.database.jdbc:ucp:19.8.0.0')

    implementation("sk.iway.wjstruts:wjstruts-core:1.3.10")
    implementation("sk.iway.wjstruts:wjstruts-taglib:1.3.10")
    implementation("sk.iway:wjdaisydiff:1.0-SNAPSHOT")

    providedCompile 'javax.servlet:javax.servlet-api:3.1.0'
    providedCompile "javax.servlet:servlet-api:2.5"
    providedCompile "javax.servlet.jsp:javax.servlet.jsp-api:2.3.3"
    providedCompile 'javax.el:javax.el-api:3.0.0'
    providedCompile 'javax.annotation:jsr250-api:1.0'

    //  https://mvnrepository.com/artifact/org.thymeleaf/thymeleaf-spring5
    implementation group: 'org.thymeleaf', name: 'thymeleaf-spring5', version: '3.1.2.RELEASE'

    //mapstruct, upgradnuty z WJ8 na 1.4.2
    implementation "org.mapstruct:mapstruct:${mapstructVersion}"
    annotationProcessor "org.mapstruct:mapstruct-processor:${mapstructVersion}"

    // https://mvnrepository.com/artifact/com.googlecode.owasp-java-html-sanitizer/owasp-java-html-sanitizer
    implementation group: 'com.googlecode.owasp-java-html-sanitizer', name: 'owasp-java-html-sanitizer', version: '20220608.1'

    //Java 11/17 - JAXB-API - do not update to v3, packages changed from javax.xml.bind to jakarta.xml.bind
    implementation 'jakarta.xml.bind:jakarta.xml.bind-api:2.3.3'
    implementation 'com.sun.xml.bind:jaxb-ri:2.3.3'

    testImplementation group: 'org.springframework.boot', name: 'spring-boot-starter-web', version: '2.7.6'
    testImplementation group: 'org.springframework', name: 'spring-test', version: "${springVersion}"
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.8.2'
    testImplementation 'org.junit.jupiter:junit-jupiter-params:5.8.2'
    testImplementation 'org.hamcrest:hamcrest:2.2'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.8.2'
    testRuntimeOnly 'org.glassfish:javax.el:3.0.0'
}

configurations {
    all*.exclude group: 'org.slf4j', module: 'slf4j-log4j12'
    all*.exclude group: 'org.slf4j', module: 'jcl104-over-slf4j' //je nahradene novsim jcl-over-slf4j
    all*.exclude group: 'commons-logging', module: 'commons-logging'
    all*.exclude group: 'log4j', module: 'log4j'
    all*.exclude group: 'xml-apis', module: 'xml-apis'

    //javax.xml.stream:stax-api:1.0-2 -> stax:stax-api:1.0.1
    all*.exclude group: 'javax.xml.stream', module: 'stax-api'

    grettyRunnerTomcat85 {

    }
    grettyRunnerTomcat9 {
        // gretty pouziva staru verziu commons-io, ktora koliduje s nasou
        // https://mvnrepository.com/artifact/commons-io/commons-io
        exclude group: 'commons-io', module: 'commons-io'
    }
}

test {
    useJUnitPlatform()
}

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

compileJava {
    options.incremental = true
    options.fork = true
    options.failOnError = true
    options.encoding = "utf-8"
    options.forkOptions.memoryMaximumSize = '1g'
    //options.forkOptions.jvmArgs = ['-XX:MaxPermSize=512m', '-Xms512m', '-Xmx1g']
}

lombok {
    version = "1.18.28"
    //zrusene kvoli zbytocnym problemom s ActiveRecord config['lombok.accessors.chain'] = 'true'
    //config['lombok.addLombokGeneratedAnnotation'] = 'false'
}

//TASKY
task npmwatch(type:Exec) {
    workingDir 'src/main/webapp/admin/v9/'
    project.ext."npmExe" = Os.isFamily(Os.FAMILY_WINDOWS) ? "npm.cmd" : "npm"
    commandLine project.ext.'npmExe', 'run', 'watch'
}

task npmbuild(type:Exec) {
    workingDir 'src/main/webapp/admin/v9/'
    project.ext."npmExe" = Os.isFamily(Os.FAMILY_WINDOWS) ? "npm.cmd" : "npm"
    commandLine project.ext.'npmExe', 'run', 'prod'
}

task npminstall {
    doLast {
        exec {
            workingDir 'src/main/webapp/admin/v9/'
            project.ext."npmExe" = Os.isFamily(Os.FAMILY_WINDOWS) ? "npm.cmd" : "npm"
            commandLine project.ext.'npmExe', 'install'
        }
    }
}

task docs {
    doLast {
        exec {
            workingDir 'docs'
            project.ext."npmExe" = Os.isFamily(Os.FAMILY_WINDOWS) ? "npm.cmd" : "npm"
            commandLine 'npx', 'http-server', '.'
        }
    }
}

//CI-CD tasky
task rsyncExplodedWar() {
    doLast {
        exec {
            workingDir "./ant/"
            commandLine "ant","finalwar"
        }
        exec {
            commandLine "cp","src/main/resources/poolman.xml","build/updatezip/finalwar/WEB-INF/classes/"
        }
        exec {
            commandLine "/usr/local/bin/wj-rsync.sh","webjet4.dev.iway.sk","build/updatezip/finalwar","/www/tomcat_au27/webapps/${rootProject.name}","tomcat_au27.service","tomcat_au27"
        }
        exec {
            commandLine "cp","src/main/resources/poolman-pentest.xml","build/updatezip/finalwar/WEB-INF/classes/poolman.xml"
        }
        exec {
            commandLine "/usr/local/bin/wj-rsync.sh","webjet2b.srv.iway.local","build/updatezip/finalwar","/www/tomcat_au20/webapps/webjet8v9_pentest","tomcat_au20","tomcat_au20"
        }
    }
}
task rsyncDocs() {
    doLast {
        exec {
            workingDir 'docs'
            project.ext."npmExe" = Os.isFamily(Os.FAMILY_WINDOWS) ? "npm.cmd" : "npm"
            commandLine project.ext.'npmExe', 'install'
        }
        exec {
            workingDir "docs"
            project.ext."npmExe" = Os.isFamily(Os.FAMILY_WINDOWS) ? "npm.cmd" : "npm"
            commandLine project.ext.'npmExe', 'run', 'sitemap'
        }
        exec {
            commandLine "/usr/local/bin/wj-rsync.sh","webjet2b.srv.iway.local","docs","/www/tomcat_au20/webapps/docs.webjetcms.sk/latest/","tomcat_au20","tomcat_au20"
        }
    }
}

//testovanie
task npminstalltest {
    doLast {
        exec {
            workingDir 'src/test/webapp/'
            project.ext."npmExe" = Os.isFamily(Os.FAMILY_WINDOWS) ? "npm.cmd" : "npm"
            commandLine project.ext.'npmExe', 'install'
        }
    }
}

task rune2etest {
    doLast {
        exec {
            workingDir 'src/test/webapp/'
            commandLine './npx-allure.sh', 'chromium'
        }
    }
}

task rune2etestfirefox {
    doLast {
        exec {
            workingDir 'src/test/webapp/'
            commandLine './npx-allure.sh', 'firefox'
        }
    }
}

//dependency check
dependencyCheck {
    scanConfigurations=["runtimeClasspath"]
    //format vid https://gist.github.com/milo-minderbinder/1e1ed911c5b2264dc659578f1baaef16
    suppressionFiles=[
        file(new File(project.rootDir, 'dependency-check-suppressions.xml')),
        file(new File(project.rootDir, 'dependency-check-suppressions-project.xml'))
    ]
    analyzers {
        assemblyEnabled=false
        nodeEnabled=false
        nodeAudit {
            yarnEnabled=false
            skipDevDependencies=true
            pnpmEnabled=false
        }
    }
}

jacoco {
    //set latest version
    toolVersion = "+"
}

gretty {
    // supported values:
    // 'jetty7', 'jetty8', 'jetty9', 'jetty9.3', 'jetty9.4', 'tomcat7', 'tomcat8'
    servletContainer = 'tomcat9'
    contextPath = ''
    httpPort = 80
    httpsEnabled = true
    httpsPort = 443
    //hard mod spusti WJ rovno z src/main/webapp co zrychli start (netreba kopirovat JSP subory niekde inde)
    inplaceMode = 'hard'
    //scanovania pre hotswap
    scanInterval = 0
    scanner = 'jetty'
    scanDir "${projectDir}/build/classes/java/main"
    fastReload = true
    //managedClassReload = true - nie je mozne pouzit s Java > 8
    //chceme aby sa tomcat nereloadol po zmene triedy, v IDE je potrebne kliknut na Hot Code Replace pre aplikovanie zmeny v triede
    reloadOnClassChange = false
    debugSuspend = false

    extraResourceBase 'src/webjet8/webapp'

    //JVM parametre
    jvmArgs = [
        //odporucane premenne pre Tomcat
        '-Dsun.net.client.defaultConnectTimeout=300000',
        '-Dsun.net.client.defaultReadTimeout=300000',
        '-Dfile.encoding=utf-8',
        '-Duser.language=sk',
        '-Duser.country=SK',
        //povolenie remote debug na porte 5005
        '-Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005',
        //lokalny poolman-local.xml subor
        //'-DwebjetPoolmanPath=/poolman-local.xml',
        //Uprava konfiguracie pre WebJET, tymto sa prepisuju hodnoty z databazy v Ovladaci panel->Konfiguracia
        //'-Dwebjet.useSMTPServer=true',
        '-Dwebjet.smtpServer=mxrelay.dev.iway.sk',
        "-DwebjetDbname=${System.env.webjetDbname}",
        '-Dwebjet.serverMonitoringEnableJPA=true',
        '-Dwebjet.webEnableIPs=1,2,3,4,5,6,7,8,9,0',
        '-Dwebjet.adminEnableIPs=1,2,3,4,5,6,7,8,9,0'
    ]

    //enable jacoco also for appStart and appStartDebug tasks
    afterEvaluate {
        tasks.appStart {
            file("${rootDir}/build/jacoco/appStart.exec").delete()
            jacoco {
                enabled = true
            }
            finalizedBy tasks.generateJacocoReport
        }
        tasks.appStartDebug {
            file("${rootDir}/build/jacoco/appStartDebug.exec").delete()
            jacoco {
                //enabled = true
            }
            //finalizedBy tasks.generateJacocoReport
        }
        tasks.appAfterIntegrationTest {
            finalizedBy tasks.generateJacocoReport
        }
    }
}

//generate HTML report from jacoco.exec files
task('generateJacocoReport', type: JacocoReport) {

  executionData fileTree(project.rootDir.absolutePath).include("**/build/jacoco/*.exec")

  sourceDirectories.setFrom project.files(project.sourceSets.main.allSource.srcDirs)
  classDirectories.setFrom project.sourceSets.main.output

  def reportDir = project.reporting.file("${rootDir}/build/jacoco/report")
  reports {
    html.outputLocation = reportDir
  }
  doLast {
    System.out.println "Jacoco report for server created: file://${reportDir.toURI().path}index.html"
  }
}

//generovanie javadoc dokumentacie
//generovat pocas buildu, aby sa dali generovat aj triedy, ktore tu nemame, napr. Constants
javadoc {
  failOnError = false
  title = "WebJET CMS"
  destinationDir = file('docs/javadoc')
  options.addStringOption('Xdoclint:none', '-quiet')
  options.addStringOption('Xmaxerrs', '65536')
  options.addStringOption('Xmaxwarns', '65536')
  include (
        'sk/iway/iwcm/'
  )
  exclude (
    '/de/innosystec/unrar/unpack/ComprDataIO.java',
    'sun/reflect/generics/',
    'sk/iway/iwcm/common/FileIndexerTools.java'
  )
}

publishing {
    publications {
        maven(MavenPublication) {
            groupId = System.getProperty("wjgroup")
            artifactId = System.getProperty("wjname")
            version = System.getProperty("wjversion")

            pom {
                name = 'webjet'
                description = 'WebJET CMS - Web Content Management in Java/Spring'
                url = 'https://www.webjetcms.com'
                licenses {
                    license {
                        name = 'The Apache License, Version 2.0'
                        url = 'http://www.apache.org/licenses/LICENSE-2.0.txt'
                    }
                }
                developers {
                    developer {
                        name = 'Lubos Balat'
                        email = 'info@webjet.eu'
                        organization = 'InterWay, a. s.'
                        organizationUrl = 'https://www.interway.sk'
                    }
                }
                scm {
                    connection = 'scm:git:git://github.com/webjetcms/webjetcms.git'
                    developerConnection = 'scm:git:ssh://github.com:/webjetcms/webjetcms.git'
                    url = 'https://github.com/webjetcms/webjetcms/tree/master'
                }
            }

            from components.java
        }
    }
}

//vygeneruje POM subor pre maven deployment
task writePom() {

    dependsOn tasks.withType(GenerateMavenPom)

    //vrati zo zadanych 2 cisel verzii najnovsiu verziu (napr. 1.11.1034,1.12.276=>1.12.276)
    ext.mostRecentVersion = { List versions ->
        def sorted = versions.sort(false) { a, b ->

            List verA = a.tokenize('.')
            List verB = b.tokenize('.')

            def commonIndices = Math.min(verA.size(), verB.size())

            for (int i = 0; i < commonIndices; ++i) {
                if (verA[i].equals("+")) verA[i] = "0"
                if (verB[i].equals("+")) verB[i] = "0"
                def numA = 0;
                try { numA = verA[i].replace("-SNAPSHOT", "").replace("-RC1", "").replace("-RC2", "").replace("-RC3", "").toInteger(); } catch (Exception ex) {}
                def numB = 0;
                try { numB = verB[i].replace("-SNAPSHOT", "").replace("-RC1", "").replace("-RC2", "").replace("-RC3", "").toInteger(); } catch (Exception ex) {}

                if (numA != numB) {
                    return numA <=> numB
                }
            }

            // If we got this far then all the common indices are identical, so whichever version is longer must be more recent
            verA.size() <=> verB.size()
        }

        //println "sorted versions: $sorted"
        sorted[-1]
    }

    doLast {
        //generate pom file
        def wjversion = System.getProperty("wjversion");
        if (wjversion == null) wjversion = "unknown"

        /*pom {
            project {
                groupId 'sk.iway'
                artifactId 'webjet'
                version wjversion
                name 'webjet'
            }
        }.writeTo("build/pom.xml")*/

        // Get existing pom file
        Node xml = new XmlParser().parse("build/publications/maven/pom-default.xml")
        //verziu je mozne zadat v gradle ako 5.3.+, do POM to potrebujeme resolvnut na konkretnu verziu 5.3.22
        Map resolvedVersionMap = new HashMap()
        Set<ResolvedArtifact> resolvedArtifacts = configurations.runtimeClasspath.getResolvedConfiguration().getResolvedArtifacts()
        //resolvedArtifacts.addAll(configurations.testImplementation.getResolvedConfiguration().getResolvedArtifacts())
        resolvedArtifacts.each {
            def version = it.getModuleVersion().getId().getVersion();
            def currentVersion = resolvedVersionMap.get(it.getName());
            def mostRecent = version;
            if (currentVersion != null) mostRecent = mostRecentVersion([currentVersion, version]);

            println("resolvedVersion: name="+it.getName()+" versionFull="+it.getModuleVersion()+" version="+version+" currentVersion="+currentVersion+" mostRecent="+mostRecent)
            resolvedVersionMap.put(it.getName(), mostRecent);
        }

        // Update dependencies with resolved versions
        Node dependencies = xml.dependencies.first();
        Iterator<Node> i = dependencies.iterator();
        while (i.hasNext()) {
            it = i.next()
            Node artifactId = it.get("artifactId").first()
            def groupId = it.get("groupId").first().value().first()
            def artifactName = artifactId.value().first()
            def version = it.get("version").first().value().first()
            //println "Checking: groupId: "+groupId+" artifactId:"+artifactName+" version="+version+" scope="+it.get("scope")

            def artifactVersion = resolvedVersionMap.get(artifactName)
            Node versionNode = it.get("version").first()
            if (artifactVersion!=null) {
                def mostRecent = mostRecentVersion([artifactVersion, version]);
                //println "artifact version=" + artifactVersion + " mostRecent=" + mostRecent
                if (mostRecent.equals(version)==false) {
                    println "---> changing version: " + version + "->" + artifactVersion + " mostRecent=" + mostRecent
                    versionNode.value = mostRecent
                }
            }

            //zmaz exclusions, to tam fakt nepotrebujeme
            it.remove(it.get("exclusions"))

            //zmen scope z runtime na compile
            Node scope = it.get("scope").first()
            def scopeValue = scope.value().first()
            if ("runtime".equals(scopeValue)) scope.value = "compile";

            if (artifactName.endsWith("servlet-api") || artifactName.endsWith(".jsp-api") || artifactName.endsWith(".el-api") || "jsr250-api".equals(artifactName)) scope.value = "provided";

            if ("test".equals(scopeValue) || "8.9-SNAPSHOT-wj9".equals(version)) {
                println "----> removing: "+artifactName
                i.remove();
            }

            //remove sk.iway artifacts, they are packages to webjet-VERSION-libs.jar
            if (groupId.startsWith("sk.iway") && "pd4ml".equals(artifactName)==false) {
                println "----> removing: "+artifactName
                i.remove();
            }
        }

        // zapis pom subor
        def printWriter = new PrintWriter(new FileWriter("build/updatezip/artifacts/webjetcms-"+wjversion+".pom"));
        printWriter.println('<?xml version="1.0" encoding="UTF-8"?>');
        XmlNodePrinter xmlNodePrinter = new XmlNodePrinter(printWriter)
        xmlNodePrinter.with {
            preserveWhitespace = true
            expandEmptyElements = true
        }
        xmlNodePrinter.print(xml)

        delete files("build/pom.xml")
    }
}