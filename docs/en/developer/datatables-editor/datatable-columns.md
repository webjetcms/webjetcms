# Datatables columns

The JSON field "columns" for DataTables can be generated by annotating over the Java object properties. The JSON is inserted into the pug file using the call:

```javascript
let columns = [(${layout.getDataTableColumns('sk.iway.iwcm.components.gallery.GalleryEntity')})];
```

Where `sk.iway.iwcm.components.gallery.GalleryEntity` is an object managed via DataTables.

All fields of the object that have an annotation are mapped to JSON `@DataTableColumn`.

Annotation `@DataTableColumn` has the same properties as [original columns object](../datatables/README.md). It is also possible to set certain properties using the inputType shortcut, which are defined `enum dataTableColumnType`.

Properties for the editor are set using the annotation `DataTableColumnEditorAttr`. The value can be entered directly or by using the prefix `constant:` get from the configuration variable:

```java
    @DataTableColumn(inputType = DataTableColumnType.JSON, tab = "basic", className = "dt-tree-dir-simple", title="components.file_archiv.target_directory", hidden = true, editor = {
        @DataTableColumnEditor(
            attr = {
                @DataTableColumnEditorAttr(key = "data-dt-field-root", value = "constant:fileArchivDefaultDirPath"),
                @DataTableColumnEditorAttr(key = "data-dt-field-skipFolders", value = "fileArchivInsertLaterDirPath"),
            }
        )
    })
    private String dir;
```

## Examples

```java
//TranslationKeyDto
@DataTableColumn(inputType = DataTableColumnType.ID)
private Integer id;

@DataTableColumn(inputType = DataTableColumnType.OPEN_EDITOR)
private String key;

@DataTableColumn(renderFormat = "dt-format-text-wrap", editor = {
        @DataTableColumnEditor(
                type = "textarea"
        )
})
private String value;

@DataTableColumn(renderFormat = "dt-format-text-wrap", editor = {
        @DataTableColumnEditor(
                type = "text",
                attr = {
                        @DataTableColumnEditorAttr(key = "disabled", value = "disabled")
                }
        )
})
private String oldValue;

@DataTableColumn(renderFormat =  "dt-format-date-time", editor = {
        @DataTableColumnEditor(
                type = "datetime",
                attr = {
                        @DataTableColumnEditorAttr(key = "disabled", value = "disabled")
                }
        )
})
private Date updateDate;


//GalleryEntity
@Size(max = 255)
@Column(name = "image_name")
@DataTableColumn(inputType = DataTableColumnType.OPEN_EDITOR, tab = "metadata", title="[[#{components.gallery.fileName}]]")
private String imageName;

@Size(max = 255)
@Column(name = "image_path")
@DataTableColumn(inputType = DataTableColumnType.TEXT, title="admin.temp_group_list.directory", tab = "metadata",
    editor = {
        @DataTableColumnEditor(attr = {
                @DataTableColumnEditorAttr(key = "disabled", value = "disabled"),
                @DataTableColumnEditorAttr(key = "data-dt-field-hr", value = "after")
        })
})
private String imagePath;

//nastavenie unselectedValue pre pole checkboxov a atributu sortAfter
@DataTableColumn(
        inputType = DataTableColumnType.CHECKBOX,
        title = "[[#{editor.access_restrictions_enable}]]",
        tab = "access",
        sortAfter = "editorFields.loggedSitemap",
        editor = {
                @DataTableColumnEditor(
                attr = {
                        @DataTableColumnEditorAttr(key = "data-dt-field-hr", value = "before"),
                        @DataTableColumnEditorAttr(key = "data-dt-field-headline", value = "editor.access_restrictions"),
                        @DataTableColumnEditorAttr(key = "unselectedValue", value = "")
                },
                options = {
                        @DataTableColumnEditorAttr(key = "editor.menu_show", value = "true"),
                        @DataTableColumnEditorAttr(key = "editor.menu_hide", value = "false")
                }
                )
        }
)
private Integer[] passwordProtected;
```

## Properties @DataTableColumn

Original documentation on the site [datatables.net](https://datatables.net/reference/option/columns:)

Required fields:
- `inputType` - Abbreviation, `enum DataTableColumnType` - specifies the data field type. It is also possible to use a concatenated value (e.g.: `inputType = { DataTableColumnType.OPEN_EDITOR, DataTableColumnType.JSON },`).
- `title` - if not specified is automatically generated as `components.meno_beanu_bez_dto_alebo_bean_na_konci.name` - https://datatables.net/reference/option/columns.title, see documentation for [translated by](#translations-of-column-headings). **Warning:** if title is empty (or hard space) then the attribute is automatically set to the column `hidden=true`.

Optional fields:
- `tab` - shortcut for setting `{editor: {tab: String}}`
- `className` - additional CSS style set to `TD` element, if you want to replace the CSS style set by `inputType` enter it with the sign `!` at the beginning - https://datatables.net/reference/option/columns.className. There are special CSS classes:
  - `disabled` - sets the field to gray, which evokes that it is non-editable.
  - `DTE_Field_Has_Checkbox` - sets the offset from the bottom to `-14px` so that no gap is left before the next field.
  - `hide-on-create` - hides the field when creating a new record.
  - `hide-on-edit` - hides the field when editing a record.
  - `hide-on-duplicate` - hides the field when duplicating a record.
  - `not-export` - the field will not be exported.
  - `show-html` - the HTML code in the value is displayed, including entities of type `&#39;`, sets the attribute to the column `entityDecode: false`.
  - `wrap` - enables text wrapping, primarily used in fields of type `textarea`.
  - `multiweb-noteditable` - in the MultiWeb installation, the field is shown in grey, which evokes that it is non-editable.
- `name` - https://datatables.net/reference/option/columns.name
- `data` - https://datatables.net/reference/option/columns.data
- `defaultContent` - https://datatables.net/reference/option/columns.defaultContent
- `orderable` - `true/false` value to enable the layout option in the datatable
- `renderFormat` - https://datatables.net/reference/option/columns.renderFormat
- `renderFormatLinkTemplate` - https://datatables.net/reference/option/columns.renderFormatLinkTemplate
- `renderFormatPrefix` - https://datatables.net/reference/option/columns.renderFormatPrefix
- `sortAfter` - the name of the field after which this field is added in the order
- `editor` - object `DataTableColumnEditor`
- `hidden` - field does not appear in the datatable and the user does not `visible` cannot display, the field can be used in the editor
- `hiddenEditor` - if `true` the column is not displayed in the editor
- `visible` - the field is hidden, but the user can view it https://datatables.net/reference/option/columns.visible
- `filter` - if false, the filter is not displayed in the table header
- `perms` - value for checking rights (e.g. multiDomain), the field will not be displayed unless the logged in user has the specified right enabled
- `defaultValue` - default value for new record (only used if set `fetchOnCreate` at `false` because for this case the data preset from the server will be returned). It can contain macros:
  - `{currentDomain}` - is replaced with the currently selected domain
  - `{currentDate}` - shall be replaced by the current date
  - `{currentDateTimeSeconds}` - is replaced by the current date and time including seconds
  - `{currentTime}` - is replaced for the current time
- `alwaysCopyProperties` - when editing a record, the blank `null` values are preserved and copied from an existing object in the database. This does not apply to date/time fields, they are overwritten automatically. If you need to use this for another type of field and also transfer `null` set the attribute value to `true`, or to `false` if you don't want automatic overwriting for date fields.

## Properties @DataTableColumnEditor

- `type` - type `input` element
- `label` - the translation key of the field name in the editor (if different from `DatatableColumn.title`)
- `message` - translation key for tooltip display, if not specified automatically searches for translation key according to `DatatableColumn.title.tooltip`. Supports specifying formatting using basic [Markdown](../frameworks/webjetjs.md#markdown-parser).
- `tab` - [the tab in which the field is located](README.md#tabs-in-the-editor)
- `attr` - `HashMap` HTML attributes to be set to the input field
  - `data-dt-field-hr` (`before/after`) - adds a dividing line before or after the element
  - `data-dt-field-headline` (translation key) - adds a title before the element
  - `data-dt-field-full-headline` (translation key) - adds a full-width title in front of the element (including the gray area with element names), used for the title in front of a nested datatable in a separate tab
- `multiple` - sets the attribute `multiple` on the HTML field (used for fields of type `MULTISELECT`).
- `separator` - sets the separator character for the type field `MULTISELECT`. If empty the data is sent and received as an array, if set as a string separated by the specified character (typically a comma).
- `data-dt-escape-slash` - by setting it to `true` turn on character replacement `/` for the entity `&#47;`. It is used in the case of a web page and a folder where a character in the title is needed `/` replace, as it is used to separate the road.

Translation key for tooltip is automatically searched by translation key `title` with suffix `.tooltip`. So if you have an annotation `@DataTableColumn(title = "group.superior_directory"` automatically searches for the translation text with the key `group.superior_directory.tooltip`. If it exists, it shall be used.

## DataTableColumnType properties

Sets the field type, more in the list [standard form fields](standard-fields.md).
- `ID` - primary key column
- `OPEN_EDITOR` - automatically creates a link on the column to open the editor, it should be used on the main text field, ideally the first one in the sequence
- `TEXT` - standard text field (one line)
- `TEXTAREA` - standard field for entering multiple lines of text
- `SELECT` - selection field, we recommend sending the options via [REST service](../datatables/restcontroller.md#dials-for-select-boxes)
- `MULTISELECT` - selection box for multiple choice
- `BOOLEAN` - check box with options `true/false`
- `CHECKBOX` - checkbox with special value, option for selected and unselected value can be set by editor attribute `@DataTableColumnEditorAttr(key = "unselectedValue", value = "")`
- `DISABLED` - the displayed field will not be editable

Numerical:
- `NUMBER` - numeric field
- `TEXT_NUMBER` - displays the rounded number, for a higher number it prints in text form, e.g. `10 tis.` instead of `10000`
- `TEXT_NUMBER_INVISIBLE` - a numeric field that does not appear in the table or in the editor

Dated:
- `DATE` - date entry field, click in the field to display the calendar selection
- `DATETIME` - date and time entry field, after clicking in the field a calendar selection with the option to enter the time is displayed
- `TIME_HM` - field for entering time only, after clicking in the field a selection will appear with the option to choose hours and minutes
- `TIME_HMS` - field for entering time only, after clicking in the field a selection is displayed with the option to choose hours, minutes and seconds

Special:
- `GALLERY_IMAGE` - special field type for displaying an image with the column caption turned off
- `QUILL` - simple editor with basic HTML code formatting such as bold, italics, etc.
- `WYSIWYG` - full-featured HTML code editor for web page
- `JSON` - selection field [directory](field-json.md)
- `DATATABLE` - [nested datatable](field-datatable.md)
- `ELFINDER` - [link selection](field-elfinder.md) to file/web page
- `UPLOAD` - [file upload](field-file-upload.md)

## Selection field options

Field type `DataTableColumnType.SELECT` you can set `option` values over:
- [REST service](../datatables/restcontroller.md#Dials-for-select-boxes) and setting dials for select boxes. This is the preferred solution for standard datatables.
- Setting options attributes directly using annotation `@DataTableColumnEditorAttr(key = "Slovensky", value = "sk")`.
- By calling a static method using annotation `@DataTableColumnEditorAttr(key = "method:sk.iway.basecms.contact.ContactRestController.getCountries", value = "label:value")`. V `key` attribute is specified by prefix `method:` class and the method that must return `List` objects. In the attribute `value = "label:value"` annotation is given the attribute name for the description and the attribute name for the value of the selection field (in the example it is called `objekt.getLabel() a objekt.getValue()`).
- Connecting to the dials application by entering `@DataTableColumnEditorAttr(key = "enumeration:Okresne Mestá", value = "string1:string2")`. V `key` prefix is specified in the attribute `enumeration:` name or dial ID. In the attribute `value = "string1:string2"` annotation is given the name of the attribute for the description and the name of the attribute for the value of the selection field - in the example it is called `objekt.getString1() a objekt.getString2()`.

```java
@DataTableColumn(inputType = DataTableColumnType.SELECT, tab = "basic", editor = {
        @DataTableColumnEditor(
                options = {
                //klasicky option tag
                @DataTableColumnEditorAttr(key = "Slovensky", value = "sk"),
                @DataTableColumnEditorAttr(key = "Česky", value = "cz"),

                //ukazka ziskania zoznamu krajin volanim statickej metody, vo value su mena property pre text a hodnotu option pola
                @DataTableColumnEditorAttr(key = "method:sk.iway.basecms.contact.ContactRestController.getCountries", value = "label:value"),

                //ukazka napojenia na ciselnik, mozne je zadat meno alebo ID ciselnika, vo value su mena property pre text a hodnotu option pola
                @DataTableColumnEditorAttr(key = "enumeration:Okresne Mestá", value = "string1:string2")
                }
        )
})
private String country;
```

## Required fields

Required fields can be annotated:
- `@NotEmpty` - does not empty the field, does not allow to enter a space or tab
- `@NotBlank` - does not empty the field, but allows to enter a space

Other validation options are described in the documentation for [restcontroller](../datatables/restcontroller.md#validation---required-fields).

## Validation

Standard annotations are supported for field validations using [javax.validation.Validator](https://www.baeldung.com/javax-validation). Example of field length validation:

```java
        @Size(min = 10, max = 20, message = "form.p2.size")
        private String p2;
```

translation key for displaying the specific set value for min and max:

```properties
form.p2.size=Pole P2 musí byť medzi {min} a {max} znakmi
```

## JS Helper for extending properties

File `app-init.js` contains the function `WJ.DataTable.mergeColumns` to add properties, based on the object name (array name). It iterates through an array of columns objects, finds an object with the same name as the argument object and uses the `jQuery.extend` this object will expand.

```javascript
WJ.DataTable.mergeColumns(columns, {
    name: "datatableImage",
    render: function (data, type, row) {
        return '<div class="img" style="background-image:url(/thumb' + row.imagePath + '/' + row.imageName + '?w=600&h=400&q=90&v=' + (new Date()).getTime() + ');"></div>';
    },
    className: "dt-image",
    renderFormat: "dt-format-none"
});
```

If you just need to add a new column you can do it by simply adding it to the list. In the example it is about adding *Hidden* field (attribute `visible: false`):

```javascript
columns.push({
        data : "availableGroups",
        name : "availableGroups",
        title : "[[\#{admin.temp.edit.showForDir}]]",
        visible: false,
        editor: {
                type : "text",
                tab : "accessTab"
        }
});
```

## Nested attributes

It is often necessary to add additional attributes to the entity for the editor (e.g. `checkbox` for applying the change to child entities, additional information fields, etc.). For this purpose, the entity can be extended with a new attribute (which is not stored in the database) containing additional data. Typically, we call it `editorFields` and implement the necessary class for the entity. Examples are in [DocEditorFields](../../../src/main/java/sk/iway/iwcm/doc/DocEditorFields.java) or [GroupEditorFields](../../../src/main/java/sk/iway/iwcm/doc/GroupEditorField.java). In the classes there is only the editorField attribute, e.g. `private DocEditorFields editorFields = null;`.

Implemented class `EditorFields`, e.g. [DocEditorFields](../../../src/main/java/sk/iway/iwcm/doc/DocEditorFields.java) typically contains methods `fromDocDetails` for setting attributes in `editorFields` class before editing and `toDocDetails` for setting attributes back in `DocDetails` before saving. These methods need to be called implicitly in your Java code.

!>**Warning:** if the entity is cached (as e.g. [GroupDetails](../../../src/main/java/sk/iway/iwcm/doc/GroupDetails.java)) attribute setting `editorFields` will also remain in the cache and may unnecessarily take up memory and create unnecessarily large data during JSON serialization. V `GroupDetails` in editorFields refers to `parentGroupDetails`.

In the standard procedure, each `GroupDetails` objects set `editorFields` object. When serializing a deeply nested directory, the objects editorFields.parentGroupDetails.editorFields.parentGroupDetails, etc., are then nested. The GroupDetails object just didn't have the necessary first editorFields. The solution is to first object `GroupDetails` clone it and then set into it `editorFields`. An example is in `GroupEditorField.fromGroupDetails` which clones the object and then returns it. The usage in the code is then as `group = gef.fromGroupDetails(group);`.

Common methods for datatable are in the class [BaseEditorFields](../../../src/main/java/sk/iway/iwcm/system/datatable/BaseEditorFields.java) that your class can extend. Includes methods for adding a CSS class line and adding an icon to a caption. See the documentation for [styling of the datatable](../datatables/README.md#line-styling).

For embedding annotation of nested attributes it is possible to use the annotation `@DatatableColumnNested` such as in [DocDetails](../../../src/main/java/sk/iway/iwcm/doc/DocDetails.java) on the attribute `editorFields`:

```java
@DataTableColumnNested
@Transient
private DocEditorFields editorFields = null;
```

the annotated attribute will be scanned for annotation `@DatatableColumn` recursive. This will result in the generation of a nested annotation. Note the data and name attribute containing the prefix `editorFields.`. If you need to set a custom prefix (variable name) you can use the prefix parameter `@DataTableColumnNested(prefix = "menoPremennej")`. You can also set the prefix to an empty value, then the prefix is not generated.

```javascript
{
  "data" : "editorFields.allowChangeUrl",
  "name" : "editorFields.allowChangeUrl",
  "title" : "Povolit zmenu URL",
  "renderFormat" : "dt-format-boolean-true",
  "editor" : {
    "type" : "checkbox",
    "tab" : "basic"
  }
}, {
  "data" : "editorFields.test",
  "name" : "editorFields.test",
  "title" : "TeST hodNOTa",
  "renderFormat" : "dt-format-text",
  "editor" : {
    "type" : "text",
    "tab" : "basic"
  }
}
```

Annotation `@Transient` Tells JPA entities that the attribute is not stored in the database.

To set the data between the entity and `editorFields` it is possible to implement methods in the REST controller `processFromEntity` for setting `editorFields` attributes or `processToEntity` for setting attributes in entity z `editorFields`. An example can be seen in [UserDetailsController](../../../src/main/java/sk/iway/iwcm/components/users/userdetail/UserDetailsController.java). Methods are automatically called when reading all records, retrieving a single record, searching, or saving data.

```java
    /**
         * Vykona upravy v entite pred vratenim cez REST rozhranie
         * napr. vyvola potrebne editorFields nastavenia (from entity to editorFields)
         * @param entity
         * @param action - typ zmeny - create,edit,getall...
         */
    @Override
    public UserDetailsEntity processFromEntity(UserDetailsEntity entity, ProcessItemAction action) {
        boolean loadSubQueries = false;
        if (ProcessItemAction.GETONE.equals(action)) {
            loadSubQueries = true;
            if (entity == null) entity = new UserDetailsEntity();
        }

        if(entity != null && entity.getEditorFields() == null) {
            UserDetailsEditorFields udef = new UserDetailsEditorFields();
            udef.fromUserDetailsEntity(entity, loadSubQueries, getRequest());
        }
        return entity;
    }

    /**
	 * Vykona upravy v entite pri zapise cez REST rozhranie
	 * napr. vyvola potrebne editorFields nastavenia (from editorFields to entity)
	 * @param entity
	 * @param action - typ zmeny - create,edit,getall,
	 */
    @Override
    public UserDetailsEntity processToEntity(UserDetailsEntity entity, ProcessItemAction action) {
        if(entity != null) {
            //Call toUserDetailsEntity to set new entity values from EditorFields
            UserDetailsEditorFields udef = new UserDetailsEditorFields();
            udef.toUserDetailsEntity(entity, getRequest());
        }
        return entity;
    }
```

## Sorting the order of fields

By default, the fields are arranged in the order they are written in the source code (although the annotation specification doesn't guarantee this, it does work that way). But if you use nested attributes the order cannot be set by the order in the code.

Therefore, it is possible to use the attribute `sortAfter` into which you enter the data attribute of the previous field. The annotated field is then added to the JSON output after the specified field. The logic is implemented in the method [DataTableColumnsFactory.sortColumns](../../../src/main/java/sk/iway/iwcm/system/datatable/DataTableColumnsFactory.java).

If necessary, a special value can be entered `sortAfter = "FIRST"` to move the field to the top of the list. This should be used in the case of extended entities via `@MappedSuperclass` if even the first `id` attribute is in this entity.

Example of use:

```java
    @DataTableColumn(inputType = DataTableColumnType.BOOLEAN, title = "Povolit zmenu URL", tab = "basic",
        sortAfter = "virtualPath"
    )
    private Boolean allowChangeUrl=false;
```

## Translations of column headings

As mentioned above, the attribute `title` contains the column name. Due to translation reasons, you cannot use the column name directly, you need to use the translation key.

When the attribute `title` you do not enter, the translation key is automatically searched for in the format `components.meno_beanu_bez_dto_alebo_bean_na_konci.name`, e.g. `components.monitoring.date_insert`.

**If you are editing an existing application/component** from WebJET 8 to WebJET 2021, it is best to search for the original translation keys. This saves time in translation, as WeBJET 8 is already translated into several languages.

In the file [src/main/webapp/files/text.properties](../../../../src/main/webapp/WEB-INF/classes/text.properties) is the original translation file from WebJET 8 (just for example, do not modify it in any way). You can search for the desired text in it and into the `title` attribute to specify the translation key found.

Another option is to display the original page with the URL parameter `?showTextKeys=true` which causes the translation keys to be displayed before the text. The page will probably be broken from a design point of view (as the text will be too long), but you can look at the keys through the inspector.

For example:

```
http://iwcm.interway.sk/components/server_monitoring/admin_monitoring_all.jsp?showTextKeys=true
```

If you already submit the form on the page, you will of course see the original texts, the parameter you add as `&showTextKeys=true`, but you will probably see a 403/404 page due to WebJET protection. The solution is to use the JavaScript console where you type:

```javascript
window.location.href=window.location.href+"&showTextKeys=true";
```

it will correctly pass through WebJET's protection and the keys will be displayed to you.

**If you have created a new application or have not found a suitable translation key** it needs to be added to the file [text-webjet9.properties](../../../src/main/webapp/WEB-INF/classes/text-webjet9.properties).

After adding the translation you need to reload the file `text-webjet9.properties` WebJETom. You do this by calling [home page with parameter ?userlngr=true](http://iwcm.interway.sk/admin/?userlngr=true) or by restarting the application server.
