# Deployment of the build on artifactory/maven server

The deployment of jar archives for use in client projects is based on the preparation of jar archives compatible with the original WebJET 8 structure.

## Before creating the build

Before creating a build, you need to manually perform/check the following steps:
- prepare a description of the changes in the file `docs/CHANGELOG.md`
- edit file `docs/README.md` - add the latest version from the changelog to the top
- edit translation key `admin.overview.changelog` with a summary of changes to the current version displayed below the welcome text on the home screen
- Edit by `src/main/webapp/admin/v9/json/wjnews.LANG.json` - add a summary and link to the changelog of the latest version

If the version changes, update it in:
- `ant/build.xml`

from there it is also transferred to `build.properties` to view the version in the administration.

## ANT task

[Build file](../../../../ant/build.xml) contains several `task` elements, the final one is `deploy` that has the correct dependencies set, so just run that one. List `taskov`:
- `setup` - recovers dependencies and generates `WAR` archive
- `updatezip` - prepare the temporary structure in `build/updatezip` directory. The structure contains an unpacked `WAR` archive, unpacked `webjet-XXXX.jar` files (i.e. the complete structure of the /admin, /components and /WEB-INF/classes directories)
- `preparesrc` - withdraws `SRC` jar file and prepares the structure for the jar archive with source files (linked from the jar archive and WebJET 2021 source code)
- `define-artifact-properties` - defines properties for generating artifacts, here in `artifact.version` sets the version of the generated artifact
- `makejars` - prepares jar archives of classes, /admin and /components directories and source files
- `download` - auxiliary task to download a jar of archives that are not being modified (`struts, daisydiff, jtidy, swagger`)
- `makepom` - generation `POM` file, this is generated by the gradle task `writePom` based on the defined dependencies in `build.gradle`. The task ensures that the correct version is also obtained from version definitions of type `5.3.+` and removing dependencies on WebJET itself (which comes from dependencies on v8).
- `finalwar` - creates in the folder `build/updatezip/finalwar` new structure with compiled classes including `AspectJ`. Creates JAR archives `WEB-INF/lib/webjet-VERZIA.jar` with Java classes, JSP files of the admin part and applications in the form of `JarPackaging`.
- `prepareAllJars` - prepares all JAR files for publishing to repositories.
- `deployGithub` - deploy SNAPSHOT versions to [GitHub Packages](https://github.com/webjetcms/webjetcms/packages/2426502/versions).
- `deployMavenCentral` - deploy version at https://repo1.maven.org/maven2/com/webjetcms/webjetcms/, before running it you need to call the task `prepareAllJars`, carried out in the project from `github`.

The procedure for generating a new version:

```shell
#nezabudni vypnut beziaci npm watch a Tomcat !!!
cd ant
ant deploy
```

*Note*: in directory `build/updatezip` an unpacked structure is created, it can be zipped and used as an update package for WebJET in the old structure (not using `jar` archives).

## Complete source code compilation

In WebJET 2021, an existing class from version 8 is often modified, which can lead to class incompatibility. For this reason, there is a special ANT task `compile` in the file `ant/compile.xml`. It uses the original source code for version 8, unpacks it into a temporary directory, adds the source code from version 2021, and then compiles everything, including the use of `AspectJ` compiler.

Everything happens in the directory `/build/updatezip`, the following commands must be called before starting compilation:

```sh
ant updatezip
ant download
```

The procedure is as follows:
- task `prepareSrc`
  - merges the source code of the current and version 8 of `/src/main/java`, `/src/webjet8/java` a `/src/main/aspectj` to `src-utf8`
- task `delombok`
  - shall be performed `delombok` - extrapolation of lombok annotations, whereas `AspectJ` has a problem with lombok annotations
  - the result is in the directory `/src-delombok/`
- task `compileMapstruct`
  - compiled via standard `javac` all classes from the directory `/src-delombok/` because `AspectJ` cannot compile correctly `mapstruct` classes (create them `Impl` version)
  - additional spring library takes from the directory `/ant/libs`, these are classes that are in the old WebJET code and are needed for compilation, but are no longer needed to run WebJET CMS
  - the result of the compilation is in `/WebContent/WEB-INF/classes/`
  - to the directory `/src-aspectj/` the source code is copied, but all mapstruct classes are deleted (those that contain the `mapper/mappers`)
  - from the directory `/WebContent/WEB-INF/classes/` all compiled classes are deleted except `mapper` classes
  - from the classes that remain a JAR file is created `/WebContent/WEB-INF/generated-sources/mapper-impl.jar`
- task `compile`
  - to be executed by `AspectJ` compiling from a directory `/src-aspectj/` to the directory `/WebContent/WEB-INF/classes`
  - uses a JAR file `/WebContent/WEB-INF/generated-sources/` with compiled `mapper` classes
  - to the resulting directory `/WebContent/WEB-INF/classes` expands the content `mapper-impl.jar` with compiled `MapperImpl.class` classes in order to `classes` the directory contained all classes
  - to `classes` directory copies from `/src-delombok/` files of the type `*.properties` a `*.xml`

The result is that in the directory `/WebContent/WEB-INF/classes` is all compiled against the complete source code of WebJET version 8 and the current version.

Calling this separate ant `tasku` is integrated directly into the main build, where there is a task `compile` calling this separate task. So no additional compilation call is needed when the deployment process starts, everything is done automatically.

## Use in client projects

In client projects, just set the appropriate version in build.gradle:

```gradle
ext {
    webjetVersion = "2023.0-SNAPSHOT";
}
```

we have experimentally verified the basic functionality on projects with MariaDB, Microsoft SQL and Oracle DB.
