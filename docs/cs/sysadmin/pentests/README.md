# Bezpečnostní testy

Zabezpečení WebJET CMS je podmíněno jeho korektní konfigurací a korektním nastavením přístupových práv. Informace na této stránce je třeba nastavit před spuštěním do produkčního provozu a následně kontrolovat minimálně na kvartální bázi a vždy před provedením bezpečnostních testů.

## Nastavení systému

### Skupiny práv

Přes WebJET CMS lze upravovat i programové soubory, proto je třeba před penetračními testy nastavit omezení práv. Doporučujeme vytvořit níže uvedené [skupiny práv](../../admin/users/perm-groups.md). **Jiné skupiny uživatelů, nebo přímo uživatelé, by níže uvedená jednotková práva neměla mít povolena**.

**Správa uživatelů**

Skupina obsahuje práva, která umožňují modifikovat oprávnění. Uživatel s takovou skupinou práv musí být dostatečně obezřetný a musí mu být jasné, že má nejvyšší možnosti práv (protože dokáže nastavovat práva sám sobě, nebo jiným uživatelům).

Uživatel s takovým právem dokáže kompromitovat celý systém (např. dokáže si nastavit oprávnění tak, že dokáže smazat všechny web stránky, nebo všechny soubory).

Skupině práv nastavte následující práva:
- správa administrátorů - právo umožňuje nastavovat oprávnění uživatelům v administraci
- Skupiny práv - právo umožňuje nastavovat oprávnění na skupiny

**Programátor**

Standardní nastavení by mělo být takové, že uživatelé (redaktoři) nemohou nahrávat a modifikovat programové soubory. Programátor ale často potřebuje provést rychlou změnu (`hotfix`) programového kódu a potřebuje tedy modifikovat i programové soubory. Zároveň má přidána práva pro změnu všech konfiguračních proměnných a editaci všech překladových textů.

Uživatel s takovým právem dokáže kompromitovat celý systém (např. dokáže nahrát škodlivý kód, který na serveru může provést libovolnou operaci včetně smazání souborů na serveru, nebo kompletního smazání databáze).

- Neomezené nahrávání souborů (přípony a velikosti)
- Konfigurace - zobrazení všech proměnných
- Editace textů - zobrazení všech textů

Poznámka: seznam konf. proměnných bez oprávnění "Konfigurace - zobrazení všech proměnných" se nastavuje v konf. proměnné `configEnabledKeys`, seznam překladových klíčů bez oprávnění "Editace textů - zobrazení všech textů" v konf. proměnné `propertiesEnabledKeys`. V překladových klíčích se zároveň filtruje HTML kód, pravidla nastavení jsou popsána níže v sekci `Stored XSS cez úpravu prekladových kľúčov`.

Kromě oprávnění je třeba povolit přístup k zápisu do adresářů souborového systému:
- `/apps` - obsahuje kód aplikací
- `/components` - obsahuje kód aplikací
- `/templates` - obsahuje designové šablony

Pokud je prostředí nasazováno přímo z GIT repozitáře a nepředpokládáte provedení `hot-fixov` přímo přes WebJET CMS nemusíte výše uvedená práva na zápis do souborového systému nastavovat. Navíc pro tento případ doporučujeme nastavit na souborovém systému oprávnění zápisu pouze pro adresáře (ostatní adresáře a soubory mají oprávnění pouze ke čtení):
- `/images` - obsahuje obrázky nahrané redaktory CMS
- `/files` - obsahuje soubory nahrané redaktory CMS
- `/shared` - obsahuje obrázky a soubory nahrané redaktory CMS sdílené mezi doménami
- `/WEB-INF/tmp` - obsahuje dočasné soubory CMS
- `/WEB-INF/imgcache` - obsahuje generované zmenšeniny a výřezy obrázků pro použití přes `/thumb` prefix
- `/WEB-INF/formfiles` - obsahuje soubory nahrané přes formuláře na web stránce vytvořené přes aplikaci Formuláře

### Konfigurace

Nastavte a zkontrolujte následující konfigurační proměnné (v administraci Nastavení->Konfigurace):
- `defaultDisableUpload=true` - aktivuje režim, ve kterém má uživatel práva na souborový systém pouze pro nastavené adresáře. Pokud nemá nastaven žádný adresář nebude mít právo zápisu souboru do žádného adresáře.
- `emailProtectionSenderEmail` - nastavte vhodnou emailovou adresu typu `noreply@domena.sk`, která se použije jako email adresa odesílaných emailů (původní hodnota se nastaví do `Reply-To` hlavičky emailu).
- `adminEnabledIPs` - obsahuje čárkou oddělený seznam IP adres, ze kterých je povolen přístup do `/admin` části.
- `multidomainAdminHost` - umožňuje nastavit samostatnou doménovou adresu pro přístup do `/admin` části, například. `cms.domena.sk`. Po nastavení bude volání `/admin` adresy na ostatních doménách vracet chybu 404 - Stránka neexistuje.
- `serverBeyoundProxy` - je-li aplikační server za Load Balancerem / proxy je třeba nastavit hodnotu na `true` (jinak nastavte hodnotu `false`). Load Balancer musí následně posílat v HTTP hlavičce `x-forwarded-for` IP adresu návštěvníka web stránky a v hlavičce `x-forwarded-proto` protokol (`http` nebo `https`). Ověřte v auditu (např. po vyplnění formuláře na web stránce) korektní zaznamenání IP adresy návštěvníka web stránky.
- `serverName` - ve výchozím nastavení `unknown` - nastavuje hodnotu HTTP hlavičky `Server` při HTTP odpovědi. Máte-li aplikační server za Load Balancerem/proxy ověřte v HTTP odpovědi hodnotu této hlavičky a případně ji nastavte na Load Balanceru/proxy serveru na vhodnou neznámou hodnotu.

Omezení pro nahrávané soubory redaktory v administraci:
- `FCKConfig.UploadMaxSize[Default][image]` - ve výchozím nastavení 0 - limit velikosti v kB pro nahrávání **obrázků**, doporučujeme nastavit na hodnotu nap. 10000 pro nahrání max. 10 MB obrázku
- `FCKConfig.UploadMaxSize[Basic][image]` - ve výchozím nastavení 2048 - limit velikosti v kB pro nahrávání **obrázků** pro uživatele, který **nemají právo Kompletní menu v editoru**
- `FCKConfig.UploadMaxSize[Default][file]` - ve výchozím nastavení 0 - limit velikosti v kB pro nahrávání **souborů**, doporučujeme nastavit na hodnotu nap. 50000 pro nahrání max. 50 MB souboru
- `FCKConfig.UploadMaxSize[Basic][file]` - ve výchozím nastavení 2048 - limit velikosti v kB pro nahrávání **souborů** pro uživatele, který **nemají právo Kompletní menu v editoru**
- `FCKConfig.UploadFileTypes[Default][image]` - ve výchozím stavu prázdné = bez omezení - limity typů **obrázků**, doporučujeme nastavit na hodnotu `jpg,jpeg,png,gif,svg,mp3,mp4`. Možnost povolení přípony SVG je třeba zvážit, viz potencionální riziko níže v bloku `Stored XSS cez SVG obrázok`.
- `FCKConfig.UploadFileTypes[Basic][image]` - ve výchozím nastavení `jpg,jpeg,png,gif,mp4` - limity typů **obrázků** pro uživatele, který **nemají právo Kompletní menu v editoru**
- `FCKConfig.UploadFileTypes[Default][file]` - ve výchozím stavu prázdné = bez omezení - limity typů **souborů**, doporučujeme nastavit na hodnotu `pdf,docx,xlsx,pptx,ppsx,zip,rtf`
- `FCKConfig.UploadFileTypes[Basic][file]` - ve výchozím nastavení `doc,docx,xls,xlsx,pdf,zip,rtf` - limity typů **souborů** pro uživatele, který **nemají právo Kompletní menu v editoru**

Můžete zkontrolovat ještě následující konf. proměnné:
- `overviewJsonUrl` - definuje URL adresu, ze které se čte seznam novinek ve WebJETu. Pokud uživatelé nemají dostupný internet z prohlížeče, můžete nastavit na hodnotu `/admin/v9/json/` pro čtení z lokální instance. Uživatelé ale nebudou vidět novinky v nových verzích WebJET CMS.
- `springSecurityAllowedAuths` - seznam povolených metod autorizace pro REST služby, ve výchozím nastavení `basic,api-token`. Pokud projekt nepotřebuje jiné než standardní přihlášení přes formulář, nastavte na prázdnou hodnotu. Po změně hodnoty je třeba restartovat aplikační server.

### HTTP hlavičky

V aplikaci Konfigurace můžete nastavit hodnoty bezpečnostních hlaviček:
- `contentSecurityPolicy` - nastavení hlavičky `Content-Security-Policy`. Omezení jak má stránka načítat různé zdroje. Máte-li httpS certifikát můžete nastavit na hodnotu: `default-src 'none'; script-src https: blob: data: 'unsafe-inline' 'unsafe-eval'; worker-src https: blob:; child-src https: blob:; style-src https: data: 'unsafe-inline' 'unsafe-eval'; img-src https: data: 'unsafe-inline'; font-src https: data:; object-src blob: 'self'; base-uri 'none'; frame-ancestors 'self'; connect-src blob: 'self'; frame-src 'self'`. Ve výchozím nastavení prázdné (hlavička se nenastavuje).
- `contentSecurityPolicySvg` - specifické omezení pro SVG obrázky z důvodu jejich jiného zpracování v Internet Explorer.
- `featurePolicyHeader` - hodnota HTTP hlavičky `Feature-Policy/Permissions-Policy` (např.: `microphone 'none'; geolocation 'none'`), více na: https://developer.mozilla.org/en-US/docs/Web/HTTP/Feature\_Policy. Ve výchozím nastavení prázdné.
- `refererPolicy` - nastavení HTTP hlavičky `Referrer-Policy`, doporučujeme nastavit na hodnotu `same-origin`. Ve výchozím nastavení `same-origin`.
- `serverName` - hodnota hlavičky `Server` v HTTP odpovědích. Ve výchozím nastavení `unknown`. Nelze nastavit na prázdnou hodnotu, protože pak tam vloží hlavičku aplikační server.
- `strictTransportSecurity` - ve výchozím stavu prázdné - nastavuje HTTP hlavičku [Strict-Transport-Security](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) v HTTP odpovědích, což zajistí přesměrování HTTP požadavků na zabezpečený httpS, doporučujeme nastavit na hodnotu: `max-age=31536000 ; includeSubDomains`. Vyžaduje, aby aplikační server byl dostupný přes zabezpečený httpS protokol.
- `xContentTypeOptions` - hodnota hlavičky `X-Content-Type-Options` pro nastavení určování typů souborů podle obsahu (ignorování přípony). Ve výchozím nastavení `nosniff`.
- `xFrameOptions` - hodnota hlavičky `X-Frame-Options` pro ochranu před CSRF útokem. Ve výchozím nastavení `SAMEORIGIN`.
- `xRobotsTagValue` - hodnota hlavičky `X-Robots-Tag` pro URL adresy nastavené v proměnné `xRobotsTagUrls`. Ve výchozím nastavení `noindex, nofollow`.
- `xRobotsTagUrls` - seznam začátků URL adres oddělených čárkou pro nastavení hlavičky `X-Robots-Tag`. Pokud seznam obsahuje hodnotu `NOT_SEARCHABLE_PAGE` nastaví se hlavička i pro stránky, které mají vypnuté vyhledávání. Ve výchozím nastavení `/components/,NOT_SEARCHABLE_PAGE`.
- `xXssProtection` - hodnota hlavičky `X-XSS-Protection` pro ochranu před XSS útokem. Ve výchozím nastavení `1; mode=block`.

Nastavení hlavičky `Access-Control` pro přístup k REST službám z jiných serverů:
- `accessControlAllowOriginValue` - hodnota hlavičky `Access-Control-Allow-Origin` pro URL nastaveno v proměnné `accessControlAllowOriginUrls`. V hodnotě můžete použít makro (viz níže). Výchozí nastavení na `{HTTP_PROTOCOL}://{SERVER_NAME}:{HTTP_PORT}`.
- `accessControlAllowOriginUrls` - seznam začátků URL adres oddělených čárkou pro nastavení hlavičky `Access-Control-Allow-Origin`. Výchozí nastavení na `/rest/,/private/rest/,/admin/rest/`.
- `accessControlAllowHeaders` - hodnota pro nastavení hlavičky `Access-Control-Allow-Headers`, nastavuje se jen při generování hlavičky `Access-Control-Allow-Origin`. Ve výchozím nastavení `Origin, Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers, x-csrf-token`.
- `accessControlAllowMethods` - hodnota pro nastavení hlavičky `Access-Control-Allow-Methods`, nastavuje se jen při generování hlavičky `Access-Control-Allow-Origin`. Ve výchozím nastavení `HEAD,POST,GET,OPTIONS,PUT`.
- `accessControlMaxAge` - hodnota pro nastavení hlavičky `Access-Control-Max-Age`, nastavuje se jen při generování hlavičky `Access-Control-Allow-Origin`. Ve výchozím nastavení `1800`.
- `accessControlAllowedOrigins` - není-li prázdné, vyžaduje při požadavku hlavičku `origin`, jejíž hodnota se musí nacházet v tomto seznamu (čárkou/novým řádkem oddělený seznam). Nastavuje se jen při generování hlavičky `Access-Control-Allow-Origin`. Ve výchozím nastavení prázdné.

Pokud potřebujete nastavit jinou HTTP hlavičku můžete použít aplikaci [HTTP hlavičky](../../admin/settings/response-header/README.md) v sekci Nastavení.

V hodnotě můžete použít makro `{HTTP_PROTOCOL}, {SERVER_NAME}/{DOMAIN_NAME}/{DOMAIN_ALIAS}, {HTTP_PORT}`, které bude nahrazeno za hodnotu získanou na serveru. `SERVER_NAME` je doménové jméno z `request.getServerName()`, `DOMAIN_NAME` a `DOMAIN_ALIAS` jsou hodnoty domén nebo alias-u nastaveny ve web stránkách. Hodnota `{INSTALL_NAME}` reprezentuje jméno instalace. Hodnota `{HEADER_ORIGIN}` obsahuje hodnotu HTTP hlavičky `origin`.

Ve starších instalacích bylo možné nastavit HTTP hlavičky i přes konf. proměnnou `responseHeaders` ve které umíte nastavit hlavičku pro URL prefix (začátek URL adresy). Na každý řádek zadáte hodnotu ve formátu: `url-prefix:hlavička:hodnota`, například:

```
/admin:X-Accel-Buffering:no
/rest/calculators/:Access-Control-Allow-Origin:*
/rest/calculators/:Access-Control-Allow-Headers:origin,x-requested-with,access-control-request-headers,content-type,access-control-request-method,accept,x-csrf-token
/rest/calculators/:Access-Control-Allow-Methods:GET,OPTIONS
```

Hodnoty nastavené přes konf. proměnnou `responseHeaders` jsou globální bez ohledu na aktuální doménu.

### Pravidla hesel

Pravidla pro hesla lze nastavit přes následující konfigurační proměnné (u proměnné je v závorce uvedena standardní hodnota):
- `passwordAdminMinLength` - Určuje minimálně jaké délky má být heslo pro administrátora (5).
- `passwordAdminMinCountOfSpecialSigns` - Určuje minimální počet výskytu speciálních znaků v hesle pro administrátora (0).
- `passwordAdminMinUpperCaseLetters` - Určuje minimální počet výskytu velkých písmen v hesle pro administrátora (1).
- `passwordAdminMinLowerCaseLetters` - Určuje minimální počet výskytu malých písmen v hesle pro administrátora (0).
- `passwordAdminMinCountOfDigits` - Určuje minimální počet výskytu čísel v hesle pro administrátora (1).
- `passwordAdminExpiryDays` - Určuje počet dní platnosti hesla pro administrátora. Po uplynutí času, bude uživatel vyzván si změnit heslo. Hodnota 0 znamená, že se nekontroluje expirace hesla (0).

Podobně lze nastavit pravidla hesel i pro přihlášení do zabezpečené zóny web stránky (ne administrace), proměnné jsou stejné, ale neobsahují výraz `Admin`. Čili jméno proměnné je například. `passwordMinUpperCaseLetters`.

Nastavením konfigurační proměnné `isGoogleAuthRequiredForAdmin` na `true` bude pro přístup do `/admin` části vyžadována dvou faktorové ověřování. Každý uživatel ji předem musí nastavit v administraci kliknutím na své jméno vpravo nahoře a zvolením možnosti **Dvoustupňové ověřování**, respektive otevřením stránky `/admin/2factorauth.jsp`.

Dvoustupňové ověřování doporučujeme nastavit minimálně na všechny účty, přes které lze spravovat uživatelské účty a práva a nastavovat konfiguraci systému.

WebJET kontroluje při změně hesla historii a nepovoluje opakovaně použít stejné heslo. Ovlivňují to následující konf. proměnné:
- `passwordHistoryLength` - počet použitých hesel uživatele, která se pamatují v historii (výchozí 6).
- `passwordHistoryEnabled` - pokud je nastaveno na `true` je kontrolována v databázi i historie hesel a není povoleno při změně hesla použít takové, které bylo v minulosti (výchozí `true`).

Při požadavku na změnu hesla jsou použity následující proměnné:
- `passwordResetValidityInMinutes` - časová platnost v minutách pro zaslaný odkaz na změnu hesla (výchozí 30).
- `changePasswordPageUrl` - adresa stránky pro změnu hesla (výchozí `/components/user/change_password.jsp`).

### Blokování přihlášení

Po nesprávné kombinaci jména a hesla WebJET blokuje další přihlášení ze stejné IP adresy. Lze nastavit následující konf. proměnné:
- `logonBlockedDelay` - čas v sekundách, během kterých nebude možné se znovu přihlásit po zadání špatného jména/hesla (výchozí 10).
- `logonBlockedAfterUnsuccessCount` - počet neúspěšných přihlášení po kterých se aplikuje zdržení definované v `logonLoginBlockedDelay` (výchozí 5).
- `logonLoginBlockedDelay` - čas v sekundách, během kterých nebude možné znovu se přihlásit po zadání špatného hesla a `logonBlockedAfterUnsuccessCount` počtu neúspěšných přihlášení pro zadané přihlašovací jméno (výchozí 60).

Standardně se tedy aplikuje hodnota 10 sekund (`logonBlockedDelay`), pokud se zadá za sebou více než 5 krát (`logonBlockedAfterUnsuccessCount`) aplikuje se zdržení 60 sekund (`logonLoginBlockedDelay`).

Během doby blokování přihlášení se nadále nezvyšuje počítadlo neúspěšných pokusů a neprodlužuje se čas, protože nedochází vůbec k volání kódu přihlašování.

### Algoritmus hashování hesel

Od verze `2022.40` se používá k hashování hesel algoritmus BCrypt v implementaci `org.springframework.security.crypto.bcrypt.BCrypt`.

Možná nastavení:
- `bcryptSaltRounds` (výchozí 12) - log2 počtu opakování saltování
- `passwordHashAlgorithm` (výchozí `bcrypt`) - jméno algoritmu pro hashování, možné hodnoty `bcrypt` nebo `sha-512`.

Starší verze používaly algoritmus `SHA-512` se 100 násobným opakováním. Starší hash hodnoty hesla se změní na bcrypt algoritmus při změně hesla uživatele. Chcete-li vynutit změnu algoritmu můžete nastavit konf. proměnnou `passwordAdminExpiryDays` na nenulovou hodnotu, což vyvolá požadavek na změnu hesla po přihlášení uživatele.

### Přihlašování do administrace

Přihlašování do administrace ovlivňují již i výše zmíněné konfigurační proměnné:
- `adminEnabledIPs` - obsahuje čárkou oddělený seznam IP adres, ze kterých je povolen přístup do `/admin` části.
- `multidomainAdminHost` - umožňuje nastavit samostatnou doménovou adresu pro přístup do `/admin` části, například. `cms.domena.sk`. Po nastavení bude volání `/admin` adresy na ostatních doménách vracet chybu 404 - Stránka neexistuje.
- `isGoogleAuthRequiredForAdmin` - zapnutí dvou faktorového ověřování při přihlášení do administrace `/admin`.
- `clusterMyNodeType` - v případě clusteru nastavuje režim uzlu, jen uzly nastavené na hodnotu `full` obsahují administraci a umožňují přihlášení do ní.
- `auditDontLogUsrlogon` - po nastavení na `true` se nebude auditovat běžné (nikoli administrátorské) přihlášení uživatele. Vhodné na vysoce zatížený intranet kde to zbytečně zahlcuje audit (výchozí `false`).

Uživatel, který se úspěšně autorizuje, musí navíc splňovat následující kritéria:
- `Schválený používateľ` - účet musí mít zvolenou uvedenou možnost.
- `Začiatok platnosti` - je-li zadaná hodnota musí být starší než aktuální datum.
- `Koniec platnosti` - je-li zadaná hodnota musí být větší než aktuální datum.
- `Povoliť vstup do admin sekcie (správa web sídla)` - účet musí mít povolenou uvedenou možnost, jinak není možný přístup do administrace.

V případě speciálních požadavků na přihlašování/ověřování uživatele je možné implementovat vlastní Java třídu přihlašování a nastavit ji přes konf. proměnnou `adminLogonMethod`. Následně se použije zadaná Java třída namísto standardního přihlášení.

Při přihlašování se při nesprávných údajích [blokuje přihlášení](#blokování-přihlášení).

### Ověřování vůči LDAP serveru

Při ověřování uživatele vůči LDAP serveru lze nastavit následující konf. proměnné:
- `ldapProviderUrl` - URL adresa LDAP serveru pro přihlašování přes LDAP ve tvaru `ldap://ldap.local:389/DC=firma,DC=com??base`.
- `ldapPassword` - přihlašovací jméno technického uživatele pro získání údajů z LDAP.
- `ldapUsername` - přihlašovací heslo technického uživatele pro získání údajů z LDAP.
- `ldapUseSslProtocol` - použije SSL při komunikaci s LDAP serverem. Je třeba mít povoleno SSL na portu 636 LDAP serveru. Pokud se používá ldapS://, nechat hodnotu na false.
- `NTLMForbiddenURL` - URL adresa zamítnutého přístupu (výchozí `/500.jsp`).
- `NTLMDomainController` - jméno doménového řadiče.
- `ldapDomainAppend` - je-li třeba přihlašování s celou doménou zde je možné zadat její doplnění k zadanému přihlašovacímu jménu uživatele.
- `ldapSecurityPrincipalDn` - nastaví pro LDAP speciální `SECURITY_PRINCIPAL` Např. `cn=!USERNAME!,dc=ad,dc=interway,dc=sk` s tím, že `!USERNAME!` zamění za přihlašovací jméno. Pokud je prázdné použije se `ldapUsername+ldapDomainAppend`.
- `ldapFilter` - přihlašovací filtr pro LDAP přihlašování se kterým se provede vyhledání účtu (výchozí `(&(objectClass=Person) (&(sAMAccountName=!USERNAME!)))`).
- `basicNtlmLogonAttrs` - seznam atributů, které se mají číst z LDAP serveru při přihlašování. Pokud je prázdné, ověří se pouze přihlášení a uživatel se neaktualizuje hodnotami v LDAP serveru. Ve výchozím nastavení `mail,title,givenName,sn,streetAddress,l,postalCode,co,company,telephoneNumber,mobile,description,memberOf,distinguishedName,thumbnailPhoto`.
- `ntlmDefaultUserPhoto` - pokud je zadáno na neprázdnou hodnotu a uživatel nemá v LDAP fotografii nastaví fotku podle zadané URL adresy.

Nastavení práv:

Po přihlášení se automaticky kontroluje shoda jména skupiny uživatelů a skupiny práv vůči skupinám v LDAP (atribut `memberOf`). Pokud se jméno shoduje skupina ve WebJETu se uživateli přiřadí. Kromě toho lze nastavit:
- `NTLMAdminGroupName` - jméno skupiny v LDAP která identifikuje, že účet má přístup do administrace (např. WebJETAdmins).
- `passwordProtectedAutoId` - čárkou oddělený seznam ID skupin uživatelů, které budou přiřazeny automaticky uživateli po úspěšném přihlášení.

### Konfigurace aplikačního serveru Tomcat

Předpokládáme, že web stránka/aplikace bude dostupná přes zabezpečený httpS protokol. Proto je třeba nastavit atribut `secure="true"`, [HTTP/AJP konektoru](https://tomcat.apache.org/tomcat-9.0-doc/config/http.html), aby session cookie byla dostupná pouze přes zabezpečený httpS protokol. Nastavení provedete v souboru `tomcat/conf/server.xml`. Atribut `useBodyEncodingForURI="true"` nastavuje stejné kódování znaků pro URL adresu jako je použito pro tělo stránky.

```xml
<Connector
    ...
    secure="true"
    useBodyEncodingForURI="true"
    ...
/>
```

pokud použijete nezabezpečený HTTP protokol nebude session cookie v prohlížeči akceptována a session nebude držena (projeví se to opakovaným zobrazením přihlašovacího okna hned po zadání správných přihlašovacích údajů).

Aby se při zobrazení chyby nezobrazila verze aplikačního serveru `Tomcat` a `Stack Trace` je třeba v server.xml do `<Host` elementu přidat konfiguraci [ErrorReportValve](https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Error_Report_Valve):

```xml
<Host ...>
    <Valve className="org.apache.catalina.valves.ErrorReportValve"
        showReport="false"
        showServerInfo="false" />
</Host>
```

v případě potřeby můžete vytvořit i statickou html stránku v kódování `utf-8` s chybovou zprávou a nakonfigurovat ji jako:

```xml
<Valve className="org.apache.catalina.valves.ErrorReportValve"
    errorCode.400="webapps/error400.html"
    errorCode.0="webapps/errorOthers.html"
    showReport="false"
    showServerInfo="false" />
```

V konfiguračním souboru `server.xml` doporučujeme správně nastavit možnost `defaultHost`. Útočníci mohou modifikovat hlavičku `Host` a tedy směřovat požadavek z internetu například. na administrační host, který nemusel být z internetu dostupný (pokud na jednom aplikačním serveru běží administrační i veřejný uzel clusteru). Příkladem je použití `localhost`, které může být přiřazeno k administračnímu serveru a tedy upravený požadavek může skončit na administračním nodu.

Hodnotu `defaultHost` doporučujeme směřovat na neexistující `<Host` element, v takovém případě vyhlásí aplikační server chybu, že takový `host` nezná. Aplikační server tedy nezpracuje neznámé domény. Nevýhoda takového řešení je, že po přidání nové domény je třeba ji přidat jako `<Alias` i do aplikačního serveru.

Pokud používáte Load Balancer je třeba zajistit, aby na aplikační server posílal jen známé (whitelist) domény. Pro neznámé domény musí odpovídat chybou.

```xml
<Engine name="Catalina" defaultHost="localhost">

    <Host name="localhost"...>
        <Alias>admin.domain.eu</Alias>
    </Host>
```

### Notifikace při změně

Doporučujeme nastavit notifikace posílané bezpečnostnímu technikovi na následující typy událostí:
- `CONF_UPDATE` a `CONF_DELETE` - změna/smazání konfigurační proměnné
- `PROP_UPDATE` a `PROP_DELETE` - změna/smazání překladového klíče (přes překladový klíč lze vkládat i JavaScript kód)

Notifikace nastavíte v administraci v části Audit->Notifikace. Bezpečnostní technik bude mít přehled o těchto změnách a v případě podezření na útok může zareagovat.

### Bezpečnost serveru

Důležitá je i bezpečnost samotného serveru a použitého softwaru. Aktualizujte software na aktuálně podporované verze. Vhodné je instalovat na server i antivirus, který bude kontrolovat nahrávané soubory a v případě detekce viru v souboru zamezí k tomuto souboru přístup.

## Nastavení Load Balanceru

Pokud je před aplikačními servery předřazen Load Balancer je třeba zajistit:
- Směrovat na aplikační server pouze definované domény, aby nemohl nastat útok modifikováním `Host` hlavičky. Load Balancer nesmí povolit poslání neznámé domény na aplikační server.
- WebJET přebírá nastavení IP adresy z HTTP hlavičky `X-Forwarded-For` při nastavení konfigurační proměnné `serverBeyoundProxy=true`. Je tedy třeba zajistit, aby taková HTTP hlavička neprocházela z internetu, ale Load Balancer ji vždy přepsal na korektní hodnotu - IP adresu návštěvníka. Totéž platí pro HTTP hlavičku `x-forwarded-proto`. Nesprávné nastavení záhlaví může vést ke zpřístupnění částí, které jsou povoleny pouze pro specifické IP adresy, jako například administrace.

## Nastavení WAF

Pokud je před aplikačním serverem předřazen `Web Application Firewall/WAF` je třeba nastavit **výjimky pro administraci**. Některé HTTP požadavky v administraci mohou být detekovány jako útok typu XSS/SQL Injection, protože HTTP požadavek může odesílat JavaScript kód, nebo SQL příkaz. Příkladem je ukládání web stránky, kde v poli HTML kód do hlavičky může být vložen potřebný JavaScript kód nebo ukládání záznamů v aplikaci Skripty, kde se přímo vkládá JavaScript kód.

Ideální řešení je použít cluster řešení s dedikovaným CMS uzlem v lokální síti, který je nedostupný z vnějšího prostředí. Pro tento případ lze WAF pro CMS nod nepoužít.

Administrace používá REST služby začínající na URL adresu `/admin/rest`, viz doporučení pro [pravidla URL adres](../../custom-apps/spring/rest-url.md#pravidla-url-adres). Na WAF je třeba nastavit výjimky pro URL adresy začínající na:
- `/admin/rest/web-pages` - ukládání web stránek
- `/admin/rest/components/insert-script` - aplikace Skripty
- `/admin/v9/settings/translation-keys` - překladové klíče - v některých případech může být nutné vkládat HTML kód do překladového klíče
- `/admin/rest/settings/configuration` - konfigurace, platí podobné jako pro překladové klíče
- `/admin/searchall.jsp` - vyhledávání v administraci, může být nutné hledat i HTML/JavaScript výraz
- `/admin/replaceall.jsp` - nahrazení výrazu v administraci, platí podobné jako pro vyhledávání
- `/admin/updatedb.jsp` - provedení zadaného SQL příkazu

Další URL adresy je vhodné nastavit na základě používaných aplikací.

## Řešení bezpečnostních nálezů

- `Sensitive Data Exposure`

Prostřednictvím chybových odpovědí se serveru se podařilo odhalit typ a verzi použitého webového serveru.

Řešení: ověřte nastavení HTTP hlavičky `Server`, ve WebJETu lze přestavit v konfigurační proměnné `serverName`, viz výše.

- `RCE via uploaded JSP file`

WebJET CMS umožňuje nahrávání libovolných souborů včetně souborů typu JSP, které umožňují provádění libovolných příkazů na běžícím serveru.

Chybě lze zabránit nastavení práv pro nahrávání souborů, nebo úplným zamezením zápisu programových souborů.

Řešení: upravte nastavení práv pro nahrávání souborů přes konfigurační proměnné `FCKConfig.Upload*`, viz výše.

- `MaliciousFileUpload`

Na serveru chybí antivirová kontrola, je tedy možné na server nahrát škodlivé soubory.

Řešení: nainstalujte na server antivirus.

- `Missing Secure cookie flag`

Session cookie (`JSESSIONID`) nemá nastaven bezpečnostní atribut `Secure`.

Řešení: zkontrolujte a nastavte `secure` atribut v souboru [server.xml](https://tomcat.apache.org/tomcat-9.0-doc/config/http.html) aplikačního serveru Tomcat, viz výše.
- `Missing HTTP Strict Transport Security policy`

Aplikace nenastavuje HTTP hlavičku `Strict Transport Security`.

Řešení: hodnotu [hlavičky Strict Transport Security](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) lze nastavit v konfigurační proměnné `strictTransportSecurity=max-age=31536000 ; includeSubDomains`, viz. výše.
- `Stored XSS cez SVG obrázok`

SVG soubor umožňuje vložit do těla i JavaScript kód, v případě přímého zobrazení takového souboru v prohlížeči se JavaScript kód provede (při standardním vložení přes `img` se kód neprovede a zobrazení je bezpečné).

Řešení: omezit možnost nahrávání SVG souborů, viz nastavení práv výše. Jak ochranu WebJET CMS generuje pro soubory typu SVG HTTP hlavičku `Content-Security-Policy` s hodnotou `default-src 'self'`, která [zamezí provedení javascript kódu](https://github.com/digininja/svg_xss) při přímém zobrazení obrázku. Hodnota je nastavitelná přes konfigurační proměnnou `contentSecurityPolicySvg`.

Pro ověření chování vytvořte SVG soubor s následujícím obsahem, nahrajte jej do WebJET CMS a vložte do testovací stránky a ověřte jeho zobrazení a (ne)provedení XSS útoku:

```xml
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg"> <polygon id="triangle" points="0,0 0,100 100,0" fill="#3e70b7"
stroke="#004400"/>
<script type="text/javascript">
alert("SVG XSS");
</script>
</svg>
```
- `Stored XSS` přes úpravu překladových klíčů

Přes překladové texty je redaktor schopen provést útok typu `Cross Site Scripting` vůči ostatním návštěvníkům webu, nebo jiným administrátorům.

Překladové klíče se používají také pro vkládání HTML kódu (např. odkazu na obchodní podmínky v kalkulačce, zvýraznění tučným písmem, nastavení CSS stylů), proto tato aplikace technicky umožňuje vkládat i HTML/JavaScript kód (jedná se o vlastnost, nikoli chybu). Třeba si uvědomit, že redaktor může vložit JavaScript kód i přímo v editoru stránek, není zásadní důvod mu v tom zabraňovat iv editaci překladových klíčů.

Řešení: Minimalizovat počet uživatelů s přístupem k aplikaci Překladové texty. Zároveň uživatelé, kteří nemají právo „Editace textů – zobrazení všech textů“ mají omezené možnosti editace. Mohou editovat jen vybrané klíče (nastavené přes konf. proměnnou `propertiesEnabledKeys`) a zároveň upravená hodnota je filtrována a povolí pouze definované HTML značky a atributy. Ty se nastavují v konf. proměnné `propAllowedTags` kde jsou standardně povoleny značky `p,div,a,sub,sup,br,strong` a atributy v konf. proměnné `propAllowedAttrs` kde jsou standardně povoleny atributy `href,src,style,class,rel`. Chcete-li zcela zabránit možnosti vkládání HTML kódu pro uživatele bez oprávnění "Editace textů - zobrazení všech textů" můžete nastavit konf. proměnnou `propAllowedTags` na prázdnou hodnotu (nebo znak `-`). Nastavením na znak `*` se ochrana vypne.

Zároveň jako další ochranu doporučujeme nastavit notifikace při změně na bezpečnostního technika, viz výše.

- `Insecure Deserialization`

Import web stránek obsahuje .xml dokumenty se serializovanými java objekty. Tyto .xml dokumenty lze však změnit a podstrčit vlastní serializované java objekty typu `<object class="java.lang.Runtime" method="getRuntime">`, které provedou zadanou operaci přímo na serveru.

Pro úspěšnou exploitaci je třeba upravit konf. proměnnou `XMLDecoderAllowedClasses`, která obsahuje seznam povolených deserializovaných objektů a přidat tam hodnotou `java.lang.Runtime`.

Řešení: běžný uživatel nesmí mít oprávnění k úpravě konfiguračních proměnných, ty by měla upravovat pouze vyhrazena osoba. Jako další ochranu jsme přímo do kódu (bez možnosti upravit tento seznam) doplnili nepovolené typy objektů, které nelze přes konfiguraci přidat (povolit).

- `Cookies: Set the 'SameSite' flag as a counter measure to cross-site request forgery`

Pro `cookies` lze nastavit atribut [SameSite](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite) pro zamezení posílání cookies při CSRF útoku (zamezení posílání cookies jiným doménám).

Aktuálně se v `servlet-api` připravuje podpora nastavení této hodnoty ve verzi 5.x, což může znamenat dlouhé čekání na přímou podporu při programování. Při použití Apache Tomcat je ale možné tuto hodnotu nastavit v konfiguraci pomocí [CookieProcessor](https://tomcat.apache.org/tomcat-8.5-doc/config/cookie-processor.html), který ve standardní implementaci umožňuje hodnotu nastavit:

```xml
<Context>
    ...
    <CookieProcessor sameSiteCookies="strict"/>
</Context>
```
