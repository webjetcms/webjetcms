<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReservationEditorFields.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.components.reservation.jpa</a> &gt; <span class="el_source">ReservationEditorFields.java</span></div><h1>ReservationEditorFields.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.components.reservation.jpa;

import java.util.Calendar;
import java.util.Date;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import lombok.Getter;
import lombok.Setter;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.components.reservation.rest.ReservationService;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.system.datatable.DataTableColumnType;
import sk.iway.iwcm.system.datatable.ProcessItemAction;
import sk.iway.iwcm.system.datatable.annotations.DataTableColumn;
import sk.iway.iwcm.system.datatable.annotations.DataTableColumnEditor;
import sk.iway.iwcm.system.datatable.annotations.DataTableColumnEditorAttr;
import sk.iway.iwcm.system.jpa.DefaultTimeValueConverter;
import sk.iway.iwcm.users.UsersDB;

@Getter
@Setter
public class ReservationEditorFields {

<span class="fc" id="L28">    public ReservationEditorFields() {</span>
        //
<span class="fc" id="L30">    }</span>

    @DataTableColumn(
        inputType = DataTableColumnType.OPEN_EDITOR,
        title=&quot;reservation.reservation_object.selected_object&quot;,
        hiddenEditor = true,
        sortAfter = &quot;email&quot;,
        orderable = false
    )
    private String selectedReservation;

    //Hidden field, we just must know
    @DataTableColumn(
        inputType = DataTableColumnType.BOOLEAN,
        title = &quot;&amp;nbsp;&quot;,
        hiddenEditor = true,
        hidden = true
    )
    private Boolean needPasswordToDelete;

    @DataTableColumn(
        inputType = DataTableColumnType.TIME_HM,
        title=&quot;reservation.reservations.time_from&quot;,
        sortAfter = &quot;dateFrom&quot;,
        tab = &quot;basic&quot;
    )
    private Date reservationTimeFrom;

    @DataTableColumn(
        inputType = DataTableColumnType.TIME_HM,
        title=&quot;reservation.reservations.time_to&quot;,
        sortAfter = &quot;dateTo&quot;,
        tab = &quot;basic&quot;
    )
    private Date reservationTimeTo;

    @DataTableColumn(
        inputType = DataTableColumnType.BOOLEAN,
        title = &quot;components.reservation.allow_history_save&quot;,
        visible = false,
        sortAfter = &quot;accepted&quot;,
        tab = &quot;basic&quot;
    )
    private Boolean allowHistorySave;

    @DataTableColumn(
        inputType = DataTableColumnType.BOOLEAN,
        title = &quot;components.reservation.allow_overbooking&quot;,
        visible = false,
        sortAfter = &quot;editorFields.allowHistorySave&quot;,
        tab = &quot;basic&quot;
    )
    private Boolean allowOverbooking;

    @DataTableColumn(
        inputType = DataTableColumnType.TEXTAREA,
        title = &quot;reservation.reservations.info_title&quot;,
        tab = &quot;basic&quot;,
        className = &quot;wrap not-export&quot;,
        hidden = true
    )
    private String infoLabel;

    @DataTableColumn(
        inputType = DataTableColumnType.TEXT,
        title=&quot;dayfull.mo&quot;,
        visible = false,
        tab = &quot;basic&quot;,
        editor = {
            @DataTableColumnEditor(
                attr = {
                    @DataTableColumnEditorAttr(key = &quot;data-dt-field-headline&quot;, value = &quot;reservation.reservations.reservation_object_times&quot;),
                    @DataTableColumnEditorAttr(key = &quot;disabled&quot;, value = &quot;disabled&quot;)
                }
            )
        }
    )
    private String reservationTimeRangeA;

    @DataTableColumn(
        inputType = DataTableColumnType.TEXT,
        title=&quot;dayfull.tu&quot;,
        visible = false,
        tab = &quot;basic&quot;,
        editor = @DataTableColumnEditor( attr = @DataTableColumnEditorAttr(key = &quot;disabled&quot;, value = &quot;disabled&quot;))
    )
    private String reservationTimeRangeB;

    @DataTableColumn(
        inputType = DataTableColumnType.TEXT,
        title=&quot;dayfull.we&quot;,
        visible = false,
        tab = &quot;basic&quot;,
        editor = @DataTableColumnEditor( attr = @DataTableColumnEditorAttr(key = &quot;disabled&quot;, value = &quot;disabled&quot;))
    )
    private String reservationTimeRangeC;

    @DataTableColumn(
        inputType = DataTableColumnType.TEXT,
        title=&quot;dayfull.th&quot;,
        visible = false,
        tab = &quot;basic&quot;,
        editor = @DataTableColumnEditor( attr = @DataTableColumnEditorAttr(key = &quot;disabled&quot;, value = &quot;disabled&quot;))
    )
    private String reservationTimeRangeD;

    @DataTableColumn(
        inputType = DataTableColumnType.TEXT,
        title=&quot;dayfull.fr&quot;,
        visible = false,
        tab = &quot;basic&quot;,
        editor = @DataTableColumnEditor( attr = @DataTableColumnEditorAttr(key = &quot;disabled&quot;, value = &quot;disabled&quot;))
    )
    private String reservationTimeRangeE;

    @DataTableColumn(
        inputType = DataTableColumnType.TEXT,
        title=&quot;dayfull.sa&quot;,
        visible = false,
        tab = &quot;basic&quot;,
        editor = @DataTableColumnEditor( attr = @DataTableColumnEditorAttr(key = &quot;disabled&quot;, value = &quot;disabled&quot;))
    )
    private String reservationTimeRangeF;

    @DataTableColumn(
        inputType = DataTableColumnType.TEXT,
        title=&quot;dayfull.su&quot;,
        visible = false,
        tab = &quot;basic&quot;,
        editor = @DataTableColumnEditor( attr = @DataTableColumnEditorAttr(key = &quot;disabled&quot;, value = &quot;disabled&quot;))
    )
    private String reservationTimeRangeG;

    //special anotation, create a ReservationObjectPrice table inside specialPrice tab
    @DataTableColumn(inputType = DataTableColumnType.DATATABLE, title = &quot;&amp;nbsp;&quot;,
        tab = &quot;specialPrice&quot;,
        hidden = true,
        editor = { @DataTableColumnEditor(
            attr = {
                @DataTableColumnEditorAttr(key = &quot;data-dt-field-dt-url&quot;, value = &quot;/admin/rest/reservation/reservation-object-price?object-id={reservationObjectId}&quot;),
                @DataTableColumnEditorAttr(key = &quot;data-dt-field-dt-columns&quot;, value = &quot;sk.iway.iwcm.components.reservation.jpa.ReservationObjectPriceEntity&quot;),
                @DataTableColumnEditorAttr(key = &quot;data-dt-field-dt-hideButtons&quot;, value = &quot;create,edit,duplicate,import,celledit,remove&quot;),
                @DataTableColumnEditorAttr(key = &quot;data-dt-field-dt-serverSide&quot;, value = &quot;false&quot;)
            }
        )
    })
    private List&lt;ReservationObjectPriceEntity&gt; objectPrices;

    @DataTableColumn(
        inputType = DataTableColumnType.TIME_HM,
        title=&quot;reservation.reservations.arrival_time&quot;,
        sortAfter = &quot;dateFrom&quot;,
        tab = &quot;basic&quot;,
        hidden = true
    )
    private Date arrivingTime;

    @DataTableColumn(
        inputType = DataTableColumnType.TIME_HM,
        title=&quot;reservation.reservations.departure_time&quot;,
        sortAfter = &quot;dateTo&quot;,
        tab = &quot;basic&quot;,
        hidden = true
    )
    private Date departureTime;

    public void fromReservationEntity(ReservationEntity originalEntity, ProcessItemAction action, HttpServletRequest request) {

<span class="fc" id="L198">        ReservationObjectEntity selected = originalEntity.getReservationObjectForReservation();</span>

<span class="fc bfc" id="L200" title="All 2 branches covered.">        if(action == ProcessItemAction.CREATE) {</span>
            //Logged user
<span class="fc" id="L202">            Identity user = UsersDB.getCurrentUser(request);</span>
<span class="fc" id="L203">            originalEntity.setName(user.getFirstName());</span>
<span class="fc" id="L204">            originalEntity.setSurname(user.getLastName());</span>
<span class="fc" id="L205">            originalEntity.setEmail(user.getEmail());</span>

            //Set default reservation date on tomorrow
<span class="fc" id="L208">            Calendar cld = Calendar.getInstance();</span>
<span class="fc" id="L209">            cld.setTime(new Date());</span>
<span class="fc" id="L210">            cld.add(Calendar.DAY_OF_YEAR, 1);</span>
<span class="fc" id="L211">            originalEntity.setDateFrom(cld.getTime());</span>
<span class="fc" id="L212">            originalEntity.setDateTo(cld.getTime());</span>

            // !! CANT set time while CREATING - because we dont know if first selected reservationObject in select is for whole day or not
<span class="fc" id="L215">        } else {</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">            if(selected != null) {</span>
<span class="fc" id="L217">                reservationTimeFrom = DefaultTimeValueConverter.getValidTimeValue(originalEntity.getDateFrom());</span>
<span class="fc" id="L218">                reservationTimeTo = DefaultTimeValueConverter.getValidTimeValue(originalEntity.getDateTo());</span>

<span class="fc bfc" id="L220" title="All 2 branches covered.">                if(Tools.isTrue(selected.getReservationForAllDay())) {</span>
<span class="fc" id="L221">                    arrivingTime = DefaultTimeValueConverter.getValidTimeValue(originalEntity.getDateFrom());</span>
<span class="fc" id="L222">                    departureTime = DefaultTimeValueConverter.getValidTimeValue(originalEntity.getDateTo());</span>
                }
            }
        }

<span class="fc bfc" id="L227" title="All 2 branches covered.">        if(selected != null) {</span>
<span class="fc" id="L228">            selectedReservation = selected.getName();</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">            if(Tools.isNotEmpty(selected.getPassword())) needPasswordToDelete = Boolean.TRUE;</span>
<span class="fc" id="L230">            else needPasswordToDelete = Boolean.FALSE;</span>
        }

<span class="fc" id="L233">        originalEntity.setEditorFields(this);</span>
<span class="fc" id="L234">    }</span>

    public void toReservationEntity(ReservationEntity originalEntity, ReservationRepository rr, HttpServletRequest request, boolean skipPrepare, boolean isImporting, ProcessItemAction action) {
        //Set domain id for new entity
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if(originalEntity.getDomainId() == null) originalEntity.setDomainId(CloudToolsForCore.getDomainId());</span>

<span class="fc" id="L240">        ReservationObjectEntity reservationObject = originalEntity.getReservationObjectForReservation();</span>

<span class="fc" id="L242">        String error = null;</span>
<span class="fc" id="L243">        ReservationService reservationService = new ReservationService(Prop.getInstance(request));</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">        if(skipPrepare == false) {</span>
<span class="fc" id="L245">            reservationService.prepareReservationToValidation(originalEntity, Tools.isTrue(reservationObject.getReservationForAllDay()) );</span>
        }

<span class="fc" id="L248">        boolean doCheck = true;</span>
<span class="fc bfc" id="L249" title="All 4 branches covered.">        if(isImporting == false &amp;&amp; action == ProcessItemAction.EDIT) {</span>
            //IF action is edit AND reservation object with reservation date/time wans NOT changed, we dont need to check it
<span class="fc" id="L251">            doCheck = ReservationService.wasReservationChanged(originalEntity, rr);</span>
        }

<span class="fc bfc" id="L254" title="All 4 branches covered.">        if(originalEntity.getId() != null &amp;&amp; originalEntity.getId() &gt; 0) {</span>
            //Acceptation MUST be actual value from DB - because it can be changed using processAction, while editing
<span class="fc" id="L256">            Boolean acceptedDB = rr.findAcceptedByIdAndDomainId(originalEntity.getId(), originalEntity.getDomainId());</span>
<span class="fc" id="L257">            originalEntity.setAccepted(acceptedDB);</span>
        }

<span class="fc bfc" id="L260" title="All 2 branches covered.">        if(doCheck) {</span>
            //If reservationObject can be reserve only for whole day, we dont need to check time range (time range is set automatically)
<span class="fc bfc" id="L262" title="All 2 branches covered.">            if(Tools.isFalse(reservationObject.getReservationForAllDay())) {</span>
                //In this case we can select even time, so we need check time validity
<span class="fc" id="L264">                error = reservationService.checkReservationTimeRangeValidity(originalEntity, reservationObject);</span>
                //Check if error was returned
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">                if(error != null) reservationService.throwError(error);</span>
            }

            //Validate reservation range
<span class="fc" id="L270">            error = reservationService.checkReservationOverlappingValidity(originalEntity, reservationObject, rr, isImporting);</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">            if(error != null) reservationService.throwError(error);</span>

            //Now decide if reservation need acceptation or not
<span class="fc bfc" id="L274" title="All 2 branches covered.">            if(!ReservationService.acceptation(originalEntity, request))  {</span>
                // !! Send mail - &gt; in after save because we dont have ID yet
            }
        }
<span class="fc" id="L278">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>