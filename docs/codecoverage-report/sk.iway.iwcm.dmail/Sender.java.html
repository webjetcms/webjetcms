<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Sender.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.dmail</a> &gt; <span class="el_source">Sender.java</span></div><h1>Sender.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.dmail;

import java.io.BufferedInputStream;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLConnection;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.sql.Types;
import java.util.*;

import net.sourceforge.stripes.mock.MockHttpServletRequest;
import net.sourceforge.stripes.mock.MockHttpSession;
import org.apache.commons.codec.binary.Base64;

import sk.iway.Password;
import sk.iway.iwcm.*;
import sk.iway.iwcm.components.domainRedirects.DomainRedirectDB;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.doc.ShowDoc;
import sk.iway.iwcm.helpers.MailHelper;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.utils.Pair;

/**
 *  Rozposielac emailov
 *
 *@Title        magma-web
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       unascribed
 *@version      1.0
 *@created      Pondelok, 2003, jun 2
 *@modified     $Date: 2004/03/04 22:16:19 $
 */

public class Sender extends TimerTask
{
	private final Timer timer;
<span class="fc" id="L43">	private static Random rand = new Random();</span>

<span class="fc" id="L45">	private boolean runActive = false;</span>
<span class="fc" id="L46">	private int toSendCount = 0;</span>


	/**
	 *  Description of the Field
	 */
<span class="fc" id="L52">	public static int MAX_RETRY_COUNT = 5; //NOSONAR</span>

	/**
	 *  Description of the Field
	 */
	public static final String CONTEXT_NAME = &quot;dmail_sender&quot;;
<span class="fc" id="L58">	private boolean active = false;</span>


	public static final String FROM_EMAIL_ID_KEY = &quot;sk.iway.iwcm.dmail.Sender.fromEmailId&quot;;
	/**
	 * ked je v DB vela zaznamov je vyber pomaly, toto je ID emailu od ktoreho vyberame z DB
	 * pre ulozenie hodnoty sa pouzije cache s 5 minutovym intervalom
	 * @return id emailu od ktoreho sa robi vyber z DB
	 */
	private int getFromEmailId()
	{
<span class="fc" id="L69">		Cache c = Cache.getInstance();</span>
<span class="fc" id="L70">		Integer fromEmailId = (Integer)c.getObject(FROM_EMAIL_ID_KEY);</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">		if (fromEmailId == null)</span>
		{
<span class="fc" id="L73">			Connection db_conn = null;</span>
<span class="fc" id="L74">			PreparedStatement ps = null;</span>
<span class="fc" id="L75">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L78">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L79">				ps = db_conn.prepareStatement(&quot;SELECT min(email_id) FROM emails WHERE sent_date IS NULL AND (send_at IS null OR send_at &lt;= ?) AND disabled=?&quot;);</span>
<span class="fc" id="L80">				ps.setTimestamp(1, new Timestamp(Tools.getNow()));</span>
<span class="fc" id="L81">				ps.setBoolean(2, false);</span>
<span class="fc" id="L82">				rs = ps.executeQuery();</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">				if (rs.next())</span>
				{
<span class="fc" id="L85">					fromEmailId = Integer.valueOf(rs.getInt(1)-1);</span>
<span class="fc" id="L86">					Logger.debug(Sender.class, &quot;fromEmailId1=&quot;+fromEmailId);</span>
				}
<span class="fc" id="L88">				rs.close();</span>
<span class="fc" id="L89">				ps.close();</span>

<span class="pc bpc" id="L91" title="1 of 4 branches missed.">				if (fromEmailId == null || fromEmailId.intValue() &lt; 0)</span>
				{
					//nie je nic neodoslane, takze pouzijeme maximalnu hodnotu
<span class="fc" id="L94">					ps = db_conn.prepareStatement(&quot;SELECT max(email_id) FROM emails&quot;);</span>
<span class="fc" id="L95">					rs = ps.executeQuery();</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">					if (rs.next())</span>
					{
<span class="fc" id="L98">						fromEmailId = Integer.valueOf(rs.getInt(1));</span>
<span class="fc" id="L99">						Logger.debug(Sender.class, &quot;fromEmailId2=&quot;+fromEmailId);</span>
					}
<span class="fc" id="L101">					rs.close();</span>
<span class="fc" id="L102">					ps.close();</span>
				}

<span class="fc" id="L105">				db_conn.close();</span>
<span class="fc" id="L106">				rs = null;</span>
<span class="fc" id="L107">				ps = null;</span>
<span class="fc" id="L108">				db_conn = null;</span>
			}
<span class="nc" id="L110">			catch (Exception ex)</span>
			{
<span class="nc" id="L112">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L119">						rs.close();</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L121">						ps.close();</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L123">						db_conn.close();</span>
				}
<span class="nc" id="L125">				catch (Exception ex2)</span>
				{
<span class="nc" id="L127">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L128">				}</span>
			}

<span class="pc bpc" id="L131" title="1 of 2 branches missed.">			if (fromEmailId == null)</span>
			{
<span class="nc" id="L133">				fromEmailId = Integer.valueOf(0);</span>
			}

<span class="fc" id="L136">			Logger.debug(Sender.class, &quot;fromEmailId3=&quot;+fromEmailId);</span>
<span class="fc" id="L137">			c.setObject(FROM_EMAIL_ID_KEY, fromEmailId, 5);</span>
		}

<span class="fc" id="L140">		return fromEmailId.intValue();</span>
	}

	/**
	 * Sender sa dotazuje databazy len raz za nejaky cas, toto ho zresetuje
	 */
	public static void resetSenderWait()
	{
<span class="fc" id="L148">		Cache c = Cache.getInstance();</span>
<span class="fc" id="L149">		c.removeObject(FROM_EMAIL_ID_KEY);</span>
<span class="fc" id="L150">	}</span>

	/**
	 *  Gets the instance attribute of the Sender class
	 *
	 *@return    The instance value
	 */
	public static Sender getInstance()
	{
<span class="fc" id="L159">		Sender sender = null;</span>

<span class="fc bfc" id="L161" title="All 2 branches covered.">		if (Constants.getServletContext().getAttribute(CONTEXT_NAME) != null)</span>
		{
<span class="fc" id="L163">			sender = (Sender) Constants.getServletContext().getAttribute(CONTEXT_NAME);</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">			if (sender.isActive() == false)</span>
			{
<span class="nc" id="L166">				Constants.getServletContext().removeAttribute(CONTEXT_NAME);</span>
<span class="nc" id="L167">				sender = null;</span>
			}
			else
			{
<span class="fc" id="L171">				Logger.debug(Sender.class,&quot;Sender je uz aktivny...&quot;);</span>
			}
		}

<span class="fc bfc" id="L175" title="All 2 branches covered.">		if (sender == null)</span>
		{
<span class="fc" id="L177">			sender = new Sender();</span>
<span class="fc" id="L178">			Logger.debug(Sender.class,&quot;Sender.getInstance() - je null, schedulujem&quot;);</span>
		}
		else
		{
<span class="fc" id="L182">			Logger.debug(Sender.class,&quot;Sender.getInstance() - nie je null&quot;);</span>
		}

<span class="fc" id="L185">		return (sender);</span>
	}

	/**
	 *  Constructor for the Sender object
	 */
	public Sender()
<span class="fc" id="L192">	{</span>
<span class="fc" id="L193">		Logger.debug(this,&quot;Sender Constructor&quot;);</span>
<span class="fc" id="L194">		setActive(true);</span>
		//ziskaj pocet, kolko treba este poslat
<span class="fc" id="L196">		Connection db_conn = null;</span>
<span class="fc" id="L197">		PreparedStatement ps = null;</span>
<span class="fc" id="L198">		ResultSet rs = null;</span>
		try
		{
			//ziskaj udaje z db
<span class="fc" id="L202">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L203">			ps = db_conn.prepareStatement(&quot;SELECT count(email_id) FROM emails WHERE email_id&gt;? AND sent_date IS NULL AND retry&gt;=0 AND (send_at IS null OR send_at &lt;= ?) AND disabled=?&quot;);</span>
<span class="fc" id="L204">			ps.setInt(1, getFromEmailId());</span>
<span class="fc" id="L205">			ps.setTimestamp(2, new Timestamp(Tools.getNow()));</span>
<span class="fc" id="L206">			ps.setBoolean(3, false);</span>
<span class="fc" id="L207">			rs = ps.executeQuery();</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">			if (rs.next())</span>
			{
<span class="fc" id="L210">				toSendCount = rs.getInt(1);</span>
			}
<span class="fc" id="L212">			rs.close();</span>
<span class="fc" id="L213">			ps.close();</span>
<span class="fc" id="L214">			db_conn.close();</span>
<span class="fc" id="L215">			rs = null;</span>
<span class="fc" id="L216">			ps = null;</span>
<span class="fc" id="L217">			db_conn = null;</span>
		}
<span class="nc" id="L219">		catch (Exception ex)</span>
		{
<span class="nc" id="L221">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L228">					rs.close();</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L230">					ps.close();</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L232">					db_conn.close();</span>
			}
<span class="nc" id="L234">			catch (Exception ex2)</span>
			{
<span class="fc" id="L236">			}</span>
		}

<span class="fc" id="L239">		timer = new Timer(true);</span>
<span class="fc" id="L240">		timer.schedule(this, 30000, Constants.getInt(&quot;dmailWaitTimeout&quot;));</span>
<span class="fc" id="L241">		Constants.getServletContext().removeAttribute(CONTEXT_NAME);</span>
<span class="fc" id="L242">		Constants.getServletContext().setAttribute(CONTEXT_NAME, this);</span>
<span class="fc" id="L243">	}</span>

	/**
	 *  Main processing method for the Sender object
	 */
	@Override
	public void run()
	{
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">		if (&quot;false&quot;.equals(Constants.getString(&quot;useSMTPServer&quot;) ))</span>
		{
<span class="nc" id="L253">			return;</span>
		}

<span class="pc bpc" id="L256" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;disableDMailSender&quot;)) return;</span>

<span class="fc" id="L258">		String senderRunOnNode = Constants.getString(&quot;senderRunOnNode&quot;);</span>
<span class="pc bpc" id="L259" title="3 of 4 branches missed.">		if (Tools.isNotEmpty(senderRunOnNode) &amp;&amp; (&quot;,&quot;+senderRunOnNode+&quot;,&quot;).indexOf(Constants.getString(&quot;clusterMyNodeName&quot;))==-1)</span>
		{
<span class="nc" id="L261">			return;</span>
		}

		//Logger.println(this,&quot;counter=&quot; + counter);
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">		if (runActive)</span>
		{
<span class="nc" id="L267">			Logger.debug(this,&quot;Sender.run method is allready active, skipping&quot;);</span>
		}

		//Logger.debug(Sender.class, &quot;Sender.run - toSendCount=&quot;+toSendCount);

<span class="fc" id="L272">		runActive = true;</span>

<span class="fc" id="L274">		Sender.setMaxRetryCount(Constants.getInt(&quot;dmailMaxRetryCount&quot;));</span>
<span class="fc" id="L275">		int sleepTime = Constants.getInt(&quot;dmailSleepTimeAfterException&quot;);</span>

		//Logger.println(this,&quot;counter=&quot; + counter);
<span class="fc" id="L278">	   Connection db_conn = null;</span>
<span class="fc" id="L279">		PreparedStatement ps = null;</span>
<span class="fc" id="L280">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L283">			db_conn = DBPool.getConnection();</span>

<span class="fc bfc" id="L285" title="All 2 branches covered.">			if (toSendCount &lt; 0)</span>
			{
				//soudruzi z NDR nekde udelali chybu...
<span class="fc" id="L288">				ps = db_conn.prepareStatement(&quot;SELECT count(email_id) FROM emails WHERE email_id&gt;? AND sent_date IS NULL AND (send_at IS null OR send_at &lt;= ?) AND retry&gt;=0  AND disabled=?&quot;);</span>
<span class="fc" id="L289">				ps.setInt(1, getFromEmailId());</span>
<span class="fc" id="L290">				ps.setTimestamp(2, new Timestamp(Tools.getNow()));</span>
<span class="fc" id="L291">				ps.setBoolean(3, false);</span>
<span class="fc" id="L292">				rs = ps.executeQuery();</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">				if (rs.next())</span>
				{
<span class="fc" id="L295">					toSendCount = rs.getInt(1);</span>
				}
<span class="fc" id="L297">				rs.close();</span>
<span class="fc" id="L298">				ps.close();</span>
<span class="fc" id="L299">				rs = null;</span>
<span class="fc" id="L300">				ps = null;</span>
			}

			//nacitaj si zoznam z DB
<span class="fc" id="L304">			String sql = &quot;&quot;;</span>
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">			if(Constants.DB_TYPE == Constants.DB_MSSQL) sql = (&quot;SELECT TOP 50 * FROM emails WHERE email_id&gt;? AND sent_date IS NULL AND (send_at IS null OR send_at &lt;= ?) AND disabled=? ORDER BY email_id ASC&quot;);</span>
<span class="pc bpc" id="L306" title="3 of 4 branches missed.">			else if(Constants.DB_TYPE == Constants.DB_MYSQL || Constants.DB_TYPE == Constants.DB_PGSQL) sql = (&quot;SELECT * FROM emails WHERE email_id&gt;? AND sent_date IS NULL AND (send_at IS null OR send_at &lt;= ?) AND disabled=? ORDER BY email_id ASC LIMIT 50&quot;);</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">			else if(Constants.DB_TYPE == Constants.DB_ORACLE) sql = (&quot;SELECT * FROM emails WHERE ROWNUM &lt;= 50 AND email_id&gt;? AND sent_date IS NULL AND (send_at IS null OR send_at &lt;= ?) AND disabled=? ORDER BY email_id ASC&quot;);</span>
<span class="fc" id="L308">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L309">			ps.setInt(1, getFromEmailId());</span>
<span class="fc" id="L310">			ps.setTimestamp(2, new Timestamp(Tools.getNow()));</span>
<span class="fc" id="L311">			ps.setBoolean(3, false);</span>
<span class="fc" id="L312">			rs = ps.executeQuery();</span>
<span class="fc" id="L313">			boolean hasResult = false;</span>
<span class="fc" id="L314">			String recipientEmail = null;</span>
<span class="fc" id="L315">			String recipientName = null;</span>
<span class="fc" id="L316">			String senderName = null;</span>
<span class="fc" id="L317">			String senderEmail = null;</span>
<span class="fc" id="L318">			String replyTo = null;</span>
<span class="fc" id="L319">			String ccEmail = null;</span>
<span class="fc" id="L320">			String bccEmail = null;</span>
<span class="fc" id="L321">			String subject = null;</span>
<span class="fc" id="L322">			String url = null;</span>
<span class="fc" id="L323">			String body = &quot;&quot;;</span>
<span class="fc" id="L324">			String attachments = null;</span>
<span class="fc" id="L325">			int retry = 0;</span>
<span class="fc" id="L326">			int emailId = -1;</span>
<span class="fc" id="L327">			int campainId = -1;</span>
<span class="fc" id="L328">			int toSendCountLimited = toSendCount;</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">			if (toSendCountLimited &gt; 50) toSendCountLimited = 50;</span>
<span class="fc" id="L330">			int random = 0;</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">			if (toSendCountLimited&gt;0) random = rand.nextInt(toSendCountLimited);</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">			if (random &lt; 0) random = 0;</span>
<span class="fc" id="L333">			int pocitadlo = 0;</span>
<span class="pc bpc" id="L334" title="1 of 4 branches missed.">			while (rs.next() &amp;&amp; pocitadlo &lt;= random)</span>
         {
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">				if (DomainThrottle.getInstance().canSend(DomainThrottle.getDomainFromEmail(DB.getDbString(rs, &quot;recipient_email&quot;)))==false)</span>
				{
					//ak na domenu nemozeme poslat email preskocime ho
<span class="nc" id="L339">					continue;</span>
				}

<span class="fc" id="L342">				hasResult = true;</span>
<span class="fc" id="L343">				setActive(true);</span>
<span class="fc" id="L344">				emailId = rs.getInt(&quot;email_id&quot;);</span>
<span class="fc" id="L345">				recipientEmail = DB.getDbString(rs, &quot;recipient_email&quot;);</span>
<span class="fc" id="L346">				replyTo = DB.getDbString(rs, &quot;reply_to&quot;);</span>
<span class="fc" id="L347">				ccEmail = DB.getDbString(rs, &quot;cc_email&quot;);</span>
<span class="fc" id="L348">				bccEmail = DB.getDbString(rs, &quot;bcc_email&quot;);</span>
<span class="fc" id="L349">				recipientName = DB.getDbString(rs, &quot;recipient_name&quot;);</span>
<span class="fc" id="L350">				senderName = DB.getDbString(rs, &quot;sender_name&quot;);</span>
<span class="fc" id="L351">				senderEmail = DB.getDbString(rs, &quot;sender_email&quot;);</span>
<span class="fc" id="L352">				subject = DB.getDbString(rs, &quot;subject&quot;);</span>
<span class="fc" id="L353">				url = DB.getDbString(rs, &quot;url&quot;);</span>
<span class="fc" id="L354">				body = DB.getDbString(rs, &quot;message&quot;);</span>
<span class="fc" id="L355">				attachments = DB.getDbString(rs, &quot;attachments&quot;);</span>
<span class="fc" id="L356">				retry = rs.getInt(&quot;retry&quot;);</span>
<span class="fc" id="L357">				campainId = rs.getInt(&quot;campain_id&quot;);</span>
				//recipientUserId = rs.getInt(&quot;recipient_user_id&quot;);

<span class="fc" id="L360">            pocitadlo++;</span>
			}
<span class="fc" id="L362">			rs.close();</span>
<span class="fc" id="L363">			ps.close();</span>
<span class="fc" id="L364">			rs = null;</span>
<span class="fc" id="L365">			ps = null;</span>

			//zatvorime, lebo moze posielanie, alebo url get na stranku trvat dlho a spojenie sa timeoutne
<span class="fc" id="L368">			db_conn.close();</span>
<span class="fc" id="L369">			db_conn = null;</span>

<span class="pc bpc" id="L371" title="2 of 6 branches missed.">			if (emailId &gt; 0 &amp;&amp; recipientEmail != null &amp;&amp; DomainThrottle.getInstance().canSend(DomainThrottle.getDomainFromEmail(recipientEmail)))</span>
			{
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">				if (retry &gt; MAX_RETRY_COUNT)</span>
				{
<span class="nc" id="L375">					db_conn = DBPool.getConnection();</span>
<span class="nc" id="L376">					ps = db_conn.prepareStatement(&quot;UPDATE emails SET retry=?, sent_date=? WHERE email_id=?&quot;);</span>
<span class="nc" id="L377">					ps.setInt(1, -1);</span>
<span class="nc" id="L378">					ps.setTimestamp(2, new Timestamp((new java.util.Date()).getTime()));</span>
<span class="nc" id="L379">					ps.setInt(3, emailId);</span>
<span class="nc" id="L380">					ps.execute();</span>
<span class="nc" id="L381">					ps.close();</span>
<span class="nc" id="L382">					ps = null;</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">					if (campainId &gt; 0)</span>
					{
<span class="nc" id="L385">						ps = db_conn.prepareStatement(&quot;UPDATE emails_campain SET count_of_sent_mails=count_of_sent_mails+1, last_sent_date=? WHERE emails_campain_id=?&quot;);</span>
<span class="nc" id="L386">						ps.setTimestamp(1, new Timestamp((new java.util.Date()).getTime()));</span>
<span class="nc" id="L387">						ps.setInt(2, campainId);</span>
<span class="nc" id="L388">						ps.execute();</span>
<span class="nc" id="L389">						ps.close();</span>
<span class="nc" id="L390">						ps = null;</span>
					}
<span class="nc" id="L392">					toSendCount--;</span>
<span class="nc" id="L393">					db_conn.close();</span>
<span class="nc" id="L394">					db_conn = null;</span>
				}
				else
				{
<span class="fc" id="L398">               db_conn = DBPool.getConnection();</span>
               // poznac si, ze odosielame
<span class="fc" id="L400">            	ps = db_conn.prepareStatement(&quot;UPDATE emails SET retry=?, sent_date=? WHERE email_id=?&quot;);</span>
<span class="fc" id="L401">               ps.setInt(1, 98);</span>
<span class="fc" id="L402">            	ps.setTimestamp(2, new Timestamp((new java.util.Date()).getTime()));</span>
<span class="fc" id="L403">               ps.setInt(3, emailId);</span>
<span class="fc" id="L404">               ps.execute();</span>
<span class="fc" id="L405">               ps.close();</span>
<span class="fc" id="L406">               db_conn.close();</span>
<span class="fc" id="L407">      			ps = null;</span>
<span class="fc" id="L408">      			db_conn = null;</span>
					//body = url;

<span class="fc" id="L411">               url = Tools.replace(url, &quot;:80/&quot;, &quot;/&quot;);</span>
               //toto uz nerobime, https je standard url = Tools.replace(url, &quot;https://&quot;, &quot;http://&quot;);

<span class="pc bpc" id="L414" title="3 of 6 branches missed.">					if ((url.startsWith(&quot;http://&quot;) || url.startsWith(&quot;https://&quot;)) &amp;&amp; Tools.isEmpty(body))</span>
					{
						try
						{
<span class="fc" id="L418">							String natUrl = Tools.natUrl(url);</span>

<span class="fc" id="L420">							Logger.debug(Sender.class,&quot;DOWNLOADING: &quot; + natUrl);</span>

							//nastav HASH
<span class="fc" id="L423">							ShowDoc.setActualUserHash(Password.generateStringHash(10));</span>

							//disable SSL verification for httpS hosts
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">							if (natUrl.startsWith(&quot;https://&quot;))</span>
							{
								//extract host name from URL
<span class="fc" id="L429">								String host = natUrl.substring(8);</span>
<span class="fc" id="L430">								int index = host.indexOf('/');</span>
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">								if (index != -1)</span>
								{
<span class="fc" id="L433">									host = host.substring(0, index);</span>
								}
								//disable SSL verification
<span class="fc" id="L436">								Tools.doNotVerifyCertificates(host);</span>
							}

							//body obsahuje URL adresu, ktoru je treba stiahnut
<span class="fc" id="L440">							URLConnection conn = null;</span>
<span class="fc" id="L441">							URL urlCon = new URL(natUrl);</span>
<span class="fc" id="L442">							conn = urlCon.openConnection();</span>
<span class="fc" id="L443">							conn.setAllowUserInteraction(false);</span>
<span class="fc" id="L444">							conn.setDoInput(true);</span>
<span class="fc" id="L445">							conn.setDoOutput(false);</span>
<span class="fc" id="L446">							conn.setRequestProperty(&quot;dmail&quot;, ShowDoc.ACTUAL_USER_HASH);</span>
<span class="fc" id="L447">							conn.connect();</span>

<span class="fc" id="L449">							String encoding = conn.getHeaderField(&quot;Content-Type&quot;);</span>
<span class="pc bpc" id="L450" title="2 of 4 branches missed.">							if (encoding==null || encoding.indexOf(&quot;charset=&quot;)==-1)</span>
							{
<span class="nc" id="L452">								encoding = SetCharacterEncodingFilter.getEncoding();</span>
							}
							else
							{
<span class="fc" id="L456">								encoding = encoding.substring(encoding.indexOf(&quot;charset=&quot;)+8).trim();</span>
							}

<span class="fc" id="L459">							StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L460">							BufferedInputStream is = new BufferedInputStream(conn.getInputStream());</span>
<span class="fc" id="L461">							InputStreamReader in = new InputStreamReader(is, encoding);</span>
<span class="fc" id="L462">							char[] buffer = new char[8000];</span>
<span class="fc" id="L463">							int n = 0;</span>
							while (true)
							{
<span class="fc" id="L466">								 n = in.read(buffer);</span>
<span class="fc bfc" id="L467" title="All 2 branches covered.">								 if (n &lt; 1)</span>
<span class="fc" id="L468">									  break;</span>
<span class="fc" id="L469">								 sb.append(buffer, 0, n);</span>
							}
<span class="fc" id="L471">							in.close();</span>
<span class="fc" id="L472">							body = sb.toString();</span>
						}
<span class="nc" id="L474">						catch (Exception ex)</span>
						{
<span class="nc" id="L476">							body = null;</span>
<span class="nc" id="L477">							sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L478">						}</span>
					}

<span class="fc" id="L481">					boolean success = false;</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(body))</span>
					{
						//ak by sa to tam nahodou este nachadzalo...
<span class="fc" id="L485">						body = Tools.replace(body, &quot;!name!&quot;, recipientName);</span>
<span class="fc" id="L486">						body = Tools.replace(body, &quot;!email!&quot;, recipientEmail);</span>
<span class="fc" id="L487">						body = Tools.replace(body, &quot;!RECIPIENT_NAME!&quot;, recipientName);</span>
<span class="fc" id="L488">						body = Tools.replace(body, &quot;!RECIPIENT_EMAIL!&quot;, recipientEmail);</span>
<span class="fc" id="L489">						body = Tools.replace(body, &quot;!LOGGED_USER_EMAIL!&quot;, recipientEmail);</span>
<span class="fc" id="L490">						body = Tools.replace(body, &quot;!LOGGED_USER_FIRSTNAME!&quot;, recipientName);</span>
<span class="fc" id="L491">						body = Tools.replace(body, &quot;!LOGGED_USER_LASTNAME!&quot;, recipientName);</span>
<span class="fc" id="L492">						body = Tools.replace(body, &quot;!EMAIL_ID!&quot;, String.valueOf(emailId));</span>

						//ak mame body, v URL je cesta (http://www.server.sk/nieco.html), ziskajme baseHref (http://www.server.sk)
<span class="fc" id="L495">						String baseHref = url;</span>
<span class="fc" id="L496">						int index = url.indexOf('/', 10);</span>
<span class="fc bfc" id="L497" title="All 2 branches covered.">						if (index != -1)</span>
						{
							//dalo by sa to aj z urlCon, ale to neviem zistit contextPath
<span class="fc" id="L500">							baseHref = url.substring(0, index);</span>
						}
<span class="pc bpc" id="L502" title="5 of 10 branches missed.">						if (body.contains(&quot;SENDER: DO NOT SEND THIS EMAIL&quot;) || body.contains(&quot;Chyba 404 - požadovaná stránka neexistuje&quot;) || body.contains(Prop.getInstance().getText(&quot;stat.error.404&quot;)) || body.contains(&quot;301 Moved Permanently&quot;) || body.contains(&quot;302 Found&quot;))</span>
						{
							//pre automaticky generovane emaily (napr. zoznam zmien)
							//ak obsahuje tento text, neposle sa to
<span class="nc" id="L506">							Logger.debug(Sender.class,&quot;Obsahuje text SENDER: DO NOT SEND THIS EMAIL, alebo je to 404, preskakujem&quot;);</span>
<span class="nc" id="L507">							success = true;</span>
						}
						else
						{
							//v pripade multiDomain s externym adresarom musime nafejkovat domenu pre ziskanie priloh z inych domen pri ziskavani cesty pomocou IwcmFile.fromVirtualPath(serverPath);
<span class="fc" id="L512">							boolean fakingDomain = false;</span>
<span class="pc bpc" id="L513" title="5 of 6 branches missed.">							if (Tools.isNotEmpty(Constants.getString(&quot;cloudStaticFilesDir&quot;)) &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;) &amp;&amp; url.startsWith(&quot;http&quot;))</span>
							{
								//ziskanie domeny z baseHref
<span class="nc" id="L516">								String baseHrefDomain = baseHref;</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">								if (Tools.isNotEmpty(baseHrefDomain))</span>
								{
<span class="nc" id="L519">									int urlColonAndTwoSlashes = baseHrefDomain.indexOf(&quot;://&quot;);</span>
<span class="nc bnc" id="L520" title="All 2 branches missed.">									if (urlColonAndTwoSlashes &gt; 0)</span>
									{
<span class="nc" id="L522">										baseHrefDomain = baseHrefDomain.substring(urlColonAndTwoSlashes + 3);</span>
<span class="nc" id="L523">										int urlPortColon = baseHrefDomain.indexOf(&quot;:&quot;);</span>
<span class="nc bnc" id="L524" title="All 2 branches missed.">										if (urlPortColon &gt; 0)</span>
<span class="nc" id="L525">											baseHrefDomain = baseHrefDomain.substring(0, urlPortColon);</span>
										else
										{
<span class="nc" id="L528">											int urlEndSlash = baseHrefDomain.indexOf(&quot;/&quot;);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">											if (urlEndSlash &gt; 0)</span>
<span class="nc" id="L530">												baseHrefDomain = baseHrefDomain.substring(0, urlEndSlash);</span>
										}
									}

<span class="nc" id="L534">									String domainName = DomainRedirectDB.getDomainFromAlias(baseHrefDomain);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">									if (Tools.isNotEmpty(domainName)) baseHrefDomain = domainName;</span>

									//kontrola, ci vo WJ taku domenu mame definovanu
<span class="nc" id="L538">									boolean foundWjDomain = false;</span>
<span class="nc" id="L539">									List&lt;String&gt; allWjDomains = GroupsDB.getInstance().getAllDomainsList();</span>
<span class="nc bnc" id="L540" title="All 2 branches missed.">									for(String wjDomain : allWjDomains)</span>
									{
<span class="nc bnc" id="L542" title="All 2 branches missed.">										if(baseHrefDomain.equals(wjDomain))</span>
<span class="nc" id="L543">											foundWjDomain = true;</span>
<span class="nc" id="L544">									}</span>

									//setnem fake domenu do RequestBean
<span class="nc bnc" id="L547" title="All 4 branches missed.">									if (foundWjDomain &amp;&amp; Tools.isNotEmpty(baseHrefDomain))</span>
									{
<span class="nc" id="L549">										MockHttpServletRequest request = new MockHttpServletRequest(null, &quot;/Sender&quot;);</span>
<span class="nc" id="L550">										MockHttpSession session = new MockHttpSession(null);</span>
<span class="nc" id="L551">										request.setSession(session);</span>
<span class="nc" id="L552">										request.setServerName(&quot;&quot;);</span>
<span class="nc" id="L553">										SetCharacterEncodingFilter.registerDataContext(request);</span>
<span class="nc" id="L554">										RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc" id="L555">										Logger.debug(Sender.class, &quot;baseHrefDomain=&quot; + baseHrefDomain + &quot;, RequestBean=&quot; + rb);</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">										if (rb != null) rb.setDomain(baseHrefDomain);</span>
<span class="nc" id="L557">										fakingDomain = true;</span>
									}
								}
							}

							//meranie pridavame len na stahovane texty (hromadny email) nie do mailov posielanych cez iny node clustra
<span class="pc bpc" id="L563" title="1 of 2 branches missed.">							if (url.startsWith(&quot;http&quot;))</span>
							{
								//uprav linky - pridaj info pre statistiku kliknuti
<span class="fc" id="L566">								body = addClickInfo(body, emailId, baseHref);</span>
<span class="fc" id="L567">								body = addOpenTrackingImg(body, emailId);</span>
							}

<span class="fc" id="L570">							String dmailListUnsubscribeBaseHref = Constants.getString(&quot;dmailListUnsubscribeBaseHref&quot;, baseHref);</span>
							//it must be httpS otherwise it will be ignored by Apple Mail and maybe other clients too
<span class="fc" id="L572">							StringBuilder unsubscribedUrl = new StringBuilder(&quot;&lt;&quot;).append(Tools.replace(dmailListUnsubscribeBaseHref, &quot;http://&quot;, &quot;https://&quot;));</span>
<span class="fc" id="L573">							String hash = getClickHash(emailId);</span>
<span class="fc" id="L574">							unsubscribedUrl.append(&quot;/rest/dmail/unsubscribe?&quot;+Constants.getString(&quot;dmailStatParam&quot;)+&quot;=&quot;+hash);</span>
<span class="fc" id="L575">							unsubscribedUrl.append(&quot;&gt;&quot;);</span>

<span class="fc" id="L577">							Pair&lt;Boolean, Exception&gt; result = new MailHelper()</span>
<span class="fc" id="L578">								.setFromName(senderName)</span>
<span class="fc" id="L579">								.setFromEmail(senderEmail)</span>
<span class="fc" id="L580">								.addRecipient(recipientEmail)</span>
<span class="fc" id="L581">								.setReplyTo(replyTo)</span>
<span class="fc" id="L582">								.setCcEmail(ccEmail)</span>
<span class="fc" id="L583">								.setBccEmail(bccEmail)</span>
<span class="fc" id="L584">								.setSubject(subject)</span>
<span class="fc" id="L585">								.setMessage(body)</span>
<span class="fc" id="L586">								.setBaseHref(baseHref)</span>
<span class="fc" id="L587">								.setAttachments(attachments)</span>
<span class="fc" id="L588">								.setSendLaterWhenException(false)</span>
<span class="fc" id="L589">								.setWriteToAuditLog(true)</span>
<span class="fc" id="L590">								.addHeader(&quot;List-Unsubscribe-Post&quot;, &quot;List-Unsubscribe=One-Click&quot;)</span>
<span class="fc" id="L591">								.addHeader(&quot;List-Unsubscribe&quot;, unsubscribedUrl.toString())</span>
<span class="fc" id="L592">								.sendCapturingException();</span>

							//odregistrujem data context, ktory bol vytvoreny kvoli fejkovaniu domen
<span class="pc bpc" id="L595" title="1 of 2 branches missed.">							if(fakingDomain) SetCharacterEncodingFilter.unRegisterDataContext();</span>

<span class="fc" id="L597">							DomainThrottle.getInstance().addEmail(DomainThrottle.getDomainFromEmail(recipientEmail), System.currentTimeMillis());</span>
<span class="fc" id="L598">							success = result.first;</span>
							//posielame email na zlu adresu, s tym nic nespravime ani na viacero pokusov
<span class="pc bpc" id="L600" title="3 of 4 branches missed.">							if (!success &amp;&amp; result.second != null)</span>
							{
<span class="nc" id="L602">								Logger.debug(Sender.class, &quot;Message: &quot;+result.second.getMessage());</span>
<span class="nc" id="L603">								StringTokenizer st = new StringTokenizer(Constants.getString(&quot;dmailBadEmailSmtpReplyStatuses&quot;), &quot;,;&quot;);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">								while (st.hasMoreTokens())</span>
								{
<span class="nc" id="L606">									String status = st.nextToken().trim();</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">									if (result.second.getMessage().contains(status))</span>
									{
<span class="nc" id="L609">										Logger.debug(Sender.class, &quot;Povazujem za success, server vratil &quot;+status);</span>
<span class="nc" id="L610">										success = true;</span>
<span class="nc" id="L611">										break;</span>
									}
<span class="nc" id="L613">								}</span>
							}
						}
					}

<span class="fc" id="L618">					db_conn = DBPool.getConnection();</span>

<span class="pc bpc" id="L620" title="1 of 2 branches missed.">					if (success)</span>
					{
<span class="fc" id="L622">						long now = (new java.util.Date()).getTime();</span>
<span class="fc" id="L623">						ps = db_conn.prepareStatement(&quot;UPDATE emails SET retry=?, sent_date=? WHERE email_id=?&quot;);</span>
<span class="fc" id="L624">						ps.setInt(1, retry + 1);</span>
<span class="fc" id="L625">						ps.setTimestamp(2, new Timestamp(now));</span>
<span class="fc" id="L626">						ps.setInt(3, emailId);</span>
<span class="fc" id="L627">						ps.execute();</span>
<span class="fc" id="L628">						ps.close();</span>
<span class="fc" id="L629">						ps = null;</span>
<span class="fc bfc" id="L630" title="All 2 branches covered.">						if (campainId &gt; 0)</span>
						{
<span class="fc" id="L632">							ps = db_conn.prepareStatement(&quot;UPDATE emails_campain SET count_of_sent_mails=count_of_sent_mails+1, last_sent_date=? WHERE emails_campain_id=?&quot;);</span>
<span class="fc" id="L633">							ps.setTimestamp(1, new Timestamp(now));</span>
<span class="fc" id="L634">							ps.setInt(2, campainId);</span>
<span class="fc" id="L635">							ps.execute();</span>
<span class="fc" id="L636">							ps.close();</span>
<span class="fc" id="L637">							ps = null;</span>
						}

<span class="fc" id="L640">						toSendCount--;</span>
<span class="fc" id="L641">					}</span>
					else
					{
<span class="nc" id="L644">						ps = db_conn.prepareStatement(&quot;UPDATE emails SET retry=?, sent_date=? WHERE email_id=?&quot;);</span>
<span class="nc" id="L645">						ps.setInt(1, retry + 1);</span>
<span class="nc" id="L646">						ps.setNull(2, Types.DATE);</span>
<span class="nc" id="L647">						ps.setInt(3, emailId);</span>
<span class="nc" id="L648">						ps.execute();</span>
<span class="nc" id="L649">						ps.close();</span>
<span class="nc" id="L650">						ps = null;</span>
					}
<span class="fc" id="L652">					db_conn.close();</span>
<span class="fc" id="L653">					db_conn = null;</span>
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">					if (!success)</span>
					{
						try
						{


<span class="nc" id="L660">							Logger.println(Sender.class,&quot;Sender: email from: &quot; + senderEmail + &quot; to: &quot; + recipientEmail);</span>
<span class="nc" id="L661">							Logger.println(Sender.class, &quot;- nepodarilo sa odoslat email, zaspavam na &quot;+sleepTime);</span>
							//pockajme, kym sa SMTP server spamata
<span class="nc bnc" id="L663" title="All 2 branches missed.">							if (sleepTime &gt; 0) Thread.sleep(sleepTime);</span>
						}
<span class="nc" id="L665">						catch (Exception e)</span>
						{
<span class="nc" id="L667">							sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L668">						}</span>
					}
				}
			}

<span class="fc bfc" id="L673" title="All 2 branches covered.">			if (hasResult == false)</span>
			{
				//this.cancel();
				//setActive(false);
			}
		}
<span class="nc" id="L679">		catch (Exception ex)</span>
		{
<span class="nc" id="L681">			sk.iway.iwcm.Logger.error(ex);</span>
			try
			{
<span class="nc" id="L684">				Logger.println(Sender.class, &quot;- nepodarilo sa odoslat email, zaspavam na 3x&quot;+sleepTime);</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">				if (sleepTime &gt; 0) Thread.sleep(sleepTime*3L);</span>
			}
<span class="nc" id="L687">			catch (Exception e)</span>
			{

<span class="nc" id="L690">			}</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L696" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L697">					rs.close();</span>
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L699">					ps.close();</span>
<span class="pc bpc" id="L700" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L701">					db_conn.close();</span>
			}
<span class="nc" id="L703">			catch (Exception ex2)</span>
			{
<span class="fc" id="L705">			}</span>
		}
<span class="fc" id="L707">		runActive = false;</span>
<span class="fc" id="L708">	}</span>


	private String addOpenTrackingImg(String body, int emailId)
	{
<span class="pc bpc" id="L713" title="2 of 4 branches missed.">		if(Tools.isEmpty(Constants.getString(&quot;dmailTrackopenGif&quot;)) || Constants.getString(&quot;dmailTrackopenGif&quot;).length()&lt;2)</span>
<span class="nc" id="L714">			return body;</span>
<span class="fc" id="L715">		Logger.debug(getClass(), &quot;Adding open tracking image&quot;);</span>
<span class="pc bpc" id="L716" title="1 of 2 branches missed.">		if (emailId &lt; 1) return(body);</span>
<span class="fc" id="L717">		String value = Integer.toString(emailId);</span>
<span class="fc" id="L718">		int endOfBody = body.indexOf(&quot;&lt;/body&gt;&quot;);</span>
<span class="fc bfc" id="L719" title="All 2 branches covered.">		if(endOfBody != -1)</span>
		{
<span class="fc" id="L721">			String trackGif = Constants.getString(&quot;dmailTrackopenGif&quot;);</span>
<span class="pc bpc" id="L722" title="2 of 4 branches missed.">			if (trackGif!=null &amp;&amp; trackGif.length()&gt;3)</span>
			{
<span class="fc" id="L724">				body = new StringBuffer(body).insert(endOfBody, (&quot;&lt;img src=\&quot;&quot;+trackGif+&quot;?emailId=&quot;+value+&quot;\&quot; style=\&quot;display:none;\&quot; /&gt;&quot;).toCharArray()).toString();</span>
			}
		}
<span class="fc" id="L727">		return body;</span>
	}

	public void cancelTask()
	{
<span class="fc" id="L732">		Logger.debug(Sender.class, &quot;destroying sender&quot;);</span>

<span class="pc bpc" id="L734" title="1 of 2 branches missed.">		if (timer != null) timer.cancel();</span>
<span class="fc" id="L735">		this.cancel();</span>
<span class="fc" id="L736">		setActive(false);</span>
<span class="fc" id="L737">		Constants.getServletContext().removeAttribute(CONTEXT_NAME);</span>
<span class="fc" id="L738">	}</span>

	/**
	 *  Sets the active attribute of the Sender object
	 *
	 *@param  active  The new active value
	 */
	public void setActive(boolean active)
	{
<span class="fc" id="L747">		this.active = active;</span>
<span class="fc" id="L748">	}</span>

	/**
	 *  Gets the active attribute of the Sender object
	 *
	 *@return    The active value
	 */
	public boolean isActive()
	{
<span class="fc" id="L757">		return active;</span>
	}
	public int getToSendCount()
	{
<span class="pc bpc" id="L761" title="1 of 2 branches missed.">		if (toSendCount &lt; 0) toSendCount = 0;</span>
<span class="fc" id="L762">		return toSendCount;</span>
	}

	/**
	 * Do tela stranky prida linkam statistiku pre kliknutia
	 * @param body
	 * @return
	 */
	public static String addClickInfo(String body, int emailId,String baseHref)
	{
<span class="pc bpc" id="L772" title="1 of 2 branches missed.">		if (emailId &lt; 1) return(body);</span>

<span class="fc" id="L774">		String value = getClickHash(emailId);</span>
<span class="fc" id="L775">		String param = Constants.getString(&quot;dmailStatParam&quot;);</span>

<span class="pc bpc" id="L777" title="2 of 4 branches missed.">		if (Tools.isEmpty(param) || param.length()&lt;2) return body;</span>

<span class="fc" id="L779">		int failsafe = 500;</span>
<span class="fc" id="L780">		int counter = 0;</span>
		int start;
		int end;
		String oldLink;
		String newLink;
<span class="fc" id="L785">		start = body.indexOf(&quot;href=\&quot;&quot;);</span>
<span class="pc bpc" id="L786" title="1 of 4 branches missed.">		while (counter &lt; failsafe &amp;&amp; start!=-1)</span>
		{
<span class="fc" id="L788">			end = body.indexOf(&quot;\&quot;&quot;, start+6);</span>
<span class="pc bpc" id="L789" title="1 of 2 branches missed.">			if (end &gt; start)</span>
			{
<span class="fc" id="L791">				oldLink = body.substring(start+6, end);</span>
<span class="pc bpc" id="L792" title="5 of 12 branches missed.">				if ( ( oldLink.trim().startsWith(&quot;http&quot;)==false || Constants.getBoolean(&quot;replaceExternalLinks&quot;))  &amp;&amp; oldLink.trim().startsWith(&quot;javascript&quot;)==false &amp;&amp; oldLink.trim().startsWith(&quot;mailto&quot;)==false  &amp;&amp; !oldLink.contains(baseHref) &amp;&amp; !oldLink.contains(&quot;/combine.jsp&quot;))</span>
				{
<span class="fc" id="L794">					newLink = baseHref;</span>
<span class="pc bpc" id="L795" title="1 of 2 branches missed.">					if (oldLink.trim().startsWith(&quot;http&quot;))</span>
					{
						//ten &amp;amp; vraj robil v niektorych mail klientoch chyby, tiket 9576
<span class="nc" id="L798">						newLink = Tools.addParameterToUrlNoAmp(baseHref, param, value);</span>

<span class="nc" id="L800">						Base64 b64 = new Base64();</span>
<span class="nc" id="L801">						String base64encoded = new String(b64.encode(oldLink.getBytes()));</span>
<span class="nc" id="L802">						base64encoded = Tools.replace(base64encoded, &quot;=&quot;, &quot;|&quot;);</span>

<span class="nc" id="L804">						newLink = Tools.addParameterToUrlNoAmp(newLink, &quot;extURL&quot;, base64encoded);</span>
<span class="nc" id="L805">					}</span>
					else
					{
<span class="fc" id="L808">						newLink = Tools.addParameterToUrlNoAmp(oldLink, param, value);</span>
					}
<span class="fc" id="L810">					body = Tools.replace(body, &quot;href=\&quot;&quot; + oldLink + &quot;\&quot;&quot;, &quot;href=\&quot;&quot; + newLink + &quot;\&quot;&quot;);</span>
				}
			}
<span class="fc" id="L813">			start = body.indexOf(&quot;href=\&quot;&quot;, end);</span>
<span class="fc" id="L814">			counter++;</span>
		}
<span class="fc" id="L816">		return(body);</span>
	}

	/**
	 * Vygeneruje a do DB ulozi nahodny hash pre zadany emailId
	 * @param emailId
	 * @return
	 */
	private static String getClickHash(int emailId) {
<span class="fc" id="L825">		String hash = (new SimpleQuery()).forString(&quot;SELECT click_hash FROM emails WHERE email_id=?&quot;, emailId);</span>
<span class="fc bfc" id="L826" title="All 2 branches covered.">		if (Tools.isEmpty(hash)) {</span>
<span class="fc" id="L827">			hash = String.valueOf(emailId) + Password.generateStringHash(16);</span>
			//uloz ho do DB
<span class="fc" id="L829">			(new SimpleQuery()).execute(&quot;UPDATE emails SET click_hash=? WHERE email_id=?&quot;, hash, emailId);</span>
		}
<span class="fc" id="L831">		return hash;</span>
	}

	/**
	 * Verifikuje, ci zadany hash pre kliknutie je platny, ak ano, vrati ID emailu (email_id), inak vrati -1
	 * @param hash
	 * @return
	 */
	public static int getEmailIdFromClickHash(String hash) {

		//v starej verzii bol hash rovno ID emailu, takze testujeme click_hash alebo email_id ak je to cislo
<span class="fc" id="L842">		int emailId = Tools.getIntValue(hash, 0);</span>
<span class="fc" id="L843">		int dbEmailId = (new SimpleQuery()).forInt(&quot;SELECT email_id FROM emails WHERE click_hash=? OR (click_hash IS NULL AND email_id=?)&quot;, hash, Integer.valueOf(emailId));</span>

<span class="fc bfc" id="L845" title="All 2 branches covered.">		if (dbEmailId&gt;0) return dbEmailId;</span>

<span class="fc" id="L847">		return -1;</span>
	}

	public static void setMaxRetryCount(int count) {
<span class="fc" id="L851">		Sender.MAX_RETRY_COUNT = count;</span>
<span class="fc" id="L852">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>