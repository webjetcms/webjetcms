<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QADB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.qa</a> &gt; <span class="el_source">QADB.java</span></div><h1>QADB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.qa;

import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.Iterator;
import java.util.List;
import java.util.Random;
import java.util.Set;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.struts.util.ResponseUtils;

import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.LabelValueDetails;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PageLng;
import sk.iway.iwcm.SendMail;
import sk.iway.iwcm.SpamProtection;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.ShowDoc;
import sk.iway.iwcm.helpers.BeanDiff;
import sk.iway.iwcm.helpers.BeanDiffPrinter;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.system.captcha.Captcha;
import sk.iway.iwcm.system.spring.SpringUrlMapping;
import sk.iway.iwcm.users.UsersDB;

/**
 *  praca z databazou otazok a odpovedi
 *
 *@Title        magma-web
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: 1.4 $
 *@created      Piatok, 2003, januďż˝r 17
 *@modified     $Date: 2004/02/25 22:09:55 $
 */
public class QADB
{
	public static final int ORDER_DATE = 1;
	public static final int ORDER_PRIORITY = 2;
<span class="fc" id="L59">	private static final Random rand = new Random();</span>

<span class="nc" id="L61">	protected QADB() {</span>
		//utility class
<span class="nc" id="L63">	}</span>

	public static List&lt;QABean&gt; getQAList(String groupName, boolean onlyForWeb, boolean ascending, HttpServletRequest request)
	{
<span class="nc" id="L67">		return(getQAList(groupName, onlyForWeb, ORDER_DATE, ascending, -1, -1, request));</span>
	}


	public static List&lt;QABean&gt; getQAList(String groupName, boolean onlyForWeb, int orderType, boolean ascending, int startPage, int pageSize, HttpServletRequest request)
	{
<span class="fc" id="L73">		return(getQAList(groupName, onlyForWeb, orderType, ascending, startPage, pageSize, request, null, null));</span>
	}

	public static List&lt;QABean&gt; getQAList(String groupName, boolean onlyForWeb, int orderType, boolean ascending, int startPage, int pageSize, HttpServletRequest request, String categoryName, String fullTextSearchString)
	{
<span class="fc" id="L78">		List&lt;QABean&gt; dataAll = getQAList(groupName, onlyForWeb, orderType, ascending, request, categoryName, fullTextSearchString);</span>
<span class="fc" id="L79">		List&lt;QABean&gt; data = new ArrayList&lt;&gt;();</span>

		//vyparsuj iba pozadovanu stranku
<span class="pc bpc" id="L82" title="2 of 4 branches missed.">		if (pageSize &gt; -1 &amp;&amp; pageSize &lt; 2)</span>
		{
<span class="nc" id="L84">			pageSize = 2;</span>
		}
<span class="fc" id="L86">		int start = (startPage - 1) * pageSize;</span>

<span class="fc" id="L88">		Iterator&lt;QABean&gt; iter = dataAll.iterator();</span>

<span class="pc bpc" id="L90" title="1 of 2 branches missed.">		if (start &gt; 0)</span>
		{
			int i;
<span class="nc bnc" id="L93" title="All 2 branches missed.">			for (i=0; i&lt;start; i++)</span>
			{
<span class="nc bnc" id="L95" title="All 2 branches missed.">				if (iter.hasNext()) iter.next();</span>
			}
		}

<span class="fc" id="L99">		int counter = 0;</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">		while (iter.hasNext())</span>
		{
<span class="fc" id="L102">			QABean o = iter.next();</span>
<span class="fc" id="L103">			counter++;</span>
<span class="pc bpc" id="L104" title="2 of 4 branches missed.">			if (pageSize &gt; 1 &amp;&amp; counter &gt; pageSize)</span>
			{
<span class="nc" id="L106">				break;</span>
			}
<span class="fc" id="L108">			data.add(o);</span>
<span class="fc" id="L109">		}</span>

<span class="fc" id="L111">		return data;</span>
	}

	public static List&lt;QABean&gt; getQAList(String groupName, boolean onlyForWeb, int orderType, boolean ascending, HttpServletRequest request)
	{
<span class="fc" id="L116">		return(getQAList(groupName, onlyForWeb, orderType, ascending, request, null, null));</span>
	}


	/**
	 * Vyfiltruje QA beany podla danych skupin, vrati tie tkore do danych skupin patria
	 * @param original
	 * @param groups
	 * @return
	 */
	public static List&lt;QABean&gt; filterQaByGroups(List&lt;QABean&gt; original, Collection&lt;LabelValueDetails&gt; groups){

<span class="nc" id="L128">		Set&lt;String&gt; groupsSet = new HashSet&lt;&gt;(groups.size());</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">		for(LabelValueDetails lvd : groups){</span>
<span class="nc" id="L130">			groupsSet.add(lvd.getLabel());</span>
<span class="nc" id="L131">		}</span>
<span class="nc" id="L132">		List&lt;QABean&gt; filtered = new ArrayList&lt;&gt;(original.size());</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">		for(QABean qabean : original){</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">			if(groupsSet.contains(qabean.getGroupName())){</span>
<span class="nc" id="L135">				filtered.add(qabean);</span>
			}
<span class="nc" id="L137">		}</span>
<span class="nc" id="L138">		return filtered;</span>
	}

	/**
	 * Vrati zoznam otazok a odpovedi v danej skupine
	 * @param groupName - nazov skupiny
	 * @param onlyForWeb - ak true, iba tie co su urcene na web
	 * @param orderType - sposob usporiadania
	 * @param ascending - ak true, tak usporiada ASC
	 * @param request
	 * @param categoryName - kategoria
	 * @param fullTextSearchString - tento text hlada v question a answer
	 * @return - zoznam otazok a odpovedi
	 */
	public static List&lt;QABean&gt; getQAList(final String groupName, boolean onlyForWeb, int orderType, boolean ascending, HttpServletRequest request, String categoryName, String fullTextSearchString)
	{
<span class="fc" id="L154">	    String groupNameFixed = Tools.replace(groupName, &quot;&amp;ndash;&quot;, &quot;\u2013&quot;);</span>

<span class="fc" id="L156">		List&lt;QABean&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L157">		String order = &quot;question_date&quot;;</span>

<span class="fc" id="L159">		Connection db_conn = null;</span>
<span class="fc" id="L160">		PreparedStatement ps = null;</span>
<span class="fc" id="L161">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L164">			db_conn = DBPool.getConnection(request);</span>

<span class="pc bpc" id="L166" title="2 of 3 branches missed.">			switch(orderType){</span>
<span class="fc" id="L167">				case 1 : {order = &quot;question_date&quot;;break;}</span>
<span class="nc" id="L168">				case 2 : {order = &quot;sort_priority&quot;;break;}</span>
<span class="nc" id="L169">				default : order = &quot;question_date&quot;;</span>
			}

<span class="pc bpc" id="L172" title="1 of 2 branches missed.">			if (ascending)</span>
			{
<span class="fc" id="L174">				order += &quot; ASC&quot;;</span>
			}
			else
			{
<span class="nc" id="L178">				order += &quot; DESC&quot;;</span>
			}

<span class="fc" id="L181">			StringBuilder sql = new StringBuilder(&quot;SELECT * FROM questions_answers WHERE &quot;+CloudToolsForCore.getDomainIdSqlWhere(false));</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(groupNameFixed))</span>
			{
<span class="fc" id="L184">				sql.append(&quot;AND group_name=?&quot;);</span>
			}
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">			if (onlyForWeb)</span>
			{
<span class="fc" id="L188">				sql.append(&quot; AND publish_on_web=? AND allow_publish_on_web=?&quot;);</span>
			}
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">			if(categoryName != null)</span>
			{
<span class="nc" id="L192">				sql.append(&quot; AND category_name LIKE ?&quot;);</span>
			}
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">			if(fullTextSearchString != null)</span>
			{
<span class="nc" id="L196">				sql.append(&quot; AND (question LIKE ? OR answer LIKE ?)&quot;);</span>
			}
<span class="fc" id="L198">			sql.append(&quot; ORDER BY &quot;).append(order);</span>

			/*if (pageSize &gt; -1 &amp;&amp; pageSize &lt; 2)
			{
				pageSize = 2;
			}
			int start = (startPage - 1) * pageSize;*/

<span class="fc" id="L206">			ps = db_conn.prepareStatement(sql.toString());</span>
<span class="fc" id="L207">			int j = 1;</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(groupNameFixed))</span>
			{
<span class="fc" id="L210">				ps.setString(j++, groupNameFixed);</span>
			}
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">			if (onlyForWeb)</span>
			{
<span class="fc" id="L214">				ps.setBoolean(j++, true);</span>
<span class="fc" id="L215">				ps.setBoolean(j++, true);</span>
			}
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">			if(categoryName != null)</span>
			{
<span class="nc" id="L219">				ps.setString(j++, &quot;%&quot;+categoryName+&quot;%&quot;);</span>
			}
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">			if(fullTextSearchString != null)</span>
			{
<span class="nc" id="L223">				ps.setString(j++, &quot;%&quot;+fullTextSearchString+&quot;%&quot;);</span>
<span class="nc" id="L224">				ps.setString(j++, &quot;%&quot;+fullTextSearchString+&quot;%&quot;);</span>
			}
<span class="fc" id="L226">			rs = ps.executeQuery();</span>
			/*if (start &gt; 0)
			{
				int i;
				for (i=0; i&lt;start; i++)
				{
					//jTDS nevie rs.absolute...
				   //rs.absolute(start);
					rs.next();
				}
			}*/
			QABean qa;
<span class="fc bfc" id="L238" title="All 2 branches covered.">			while (rs.next())</span>
			{
				/*if (pageSize &gt; 1 &amp;&amp; counter &gt; pageSize)
				{
					break;
				}*/

<span class="fc" id="L245">				qa = fillFromResultSet(rs, false);</span>

<span class="fc" id="L247">				qa.setAnswerWeb(Tools.replace(qa.getAnswerWeb(), &quot;\n&quot;, &quot;&lt;br&gt;&quot;));</span>

<span class="fc" id="L249">				qa.setSortPriority(Tools.getIntValue(rs.getInt(&quot;sort_priority&quot;), 0));</span>

<span class="fc" id="L251">				ret.add(qa);</span>
			}
<span class="fc" id="L253">			rs.close();</span>
<span class="fc" id="L254">			ps.close();</span>
<span class="fc" id="L255">			db_conn.close();</span>
<span class="fc" id="L256">			rs = null;</span>
<span class="fc" id="L257">			ps = null;</span>
<span class="fc" id="L258">			db_conn = null;</span>
		}
<span class="nc" id="L260">		catch (Exception ex)</span>
		{
<span class="nc" id="L262">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L269">					ps.close();</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L271">					db_conn.close();</span>
			}
<span class="nc" id="L273">			catch (Exception ex2)</span>
			{
<span class="fc" id="L275">			}</span>
		}

<span class="fc" id="L278">		return (ret);</span>
	}

	/**
	 * Vrati pocet otazok a odpovedi v danej skupine
	 * @param groupName - nazov skupiny
	 * @param onlyForWeb - ak true spocita len tie, ktore su urcene na web
	 * @param request
	 * @return
	 */
	public static int getQAListSize(String groupName, boolean onlyForWeb, HttpServletRequest request)
	{
<span class="nc" id="L290">		return(getQAListSize(groupName, onlyForWeb, request, null, null));</span>
	}

	/**
	 * Vrati pocet otazok a odpovedi v danej skupine
	 * @param groupName - nazov skupiny
	 * @param onlyForWeb - ak true spocita len tie, ktore su urcene na web
	 * @param request
	 * @param categoryName - kategoria
	 * @param fullTextSearchString - tento text hlada v question a answer
	 * @return
	 */
	public static int getQAListSize(String groupName, boolean onlyForWeb, HttpServletRequest request, String categoryName, String fullTextSearchString)
	{
<span class="nc" id="L304">		int size = 0;</span>

<span class="nc" id="L306">		Connection db_conn = null;</span>
<span class="nc" id="L307">		PreparedStatement ps = null;</span>
<span class="nc" id="L308">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L311">			db_conn = DBPool.getConnection(request);</span>
<span class="nc" id="L312">			StringBuilder sql = new StringBuilder(&quot;SELECT count(qa_id) as total_size FROM questions_answers WHERE group_name=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc bnc" id="L313" title="All 2 branches missed.">			if (onlyForWeb)</span>
			{
<span class="nc" id="L315">				sql.append(&quot; AND publish_on_web=?&quot;);</span>
			}
<span class="nc bnc" id="L317" title="All 2 branches missed.">			if(categoryName != null)</span>
			{
<span class="nc" id="L319">				sql.append(&quot; AND category_name LIKE ?&quot;);</span>
			}
<span class="nc bnc" id="L321" title="All 2 branches missed.">			if(fullTextSearchString != null)</span>
			{
<span class="nc" id="L323">				sql.append(&quot; AND (question LIKE ? OR answer LIKE ?)&quot;);</span>
			}
<span class="nc" id="L325">			ps = db_conn.prepareStatement(sql.toString());</span>

<span class="nc" id="L327">			int j = 1;</span>
<span class="nc" id="L328">			ps.setString(j++, groupName);</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">			if (onlyForWeb)</span>
			{
<span class="nc" id="L331">				ps.setBoolean(j++, true);</span>
			}
<span class="nc bnc" id="L333" title="All 2 branches missed.">			if(categoryName != null)</span>
			{
<span class="nc" id="L335">				ps.setString(j++, &quot;%&quot;+categoryName+&quot;%&quot;);</span>
			}
<span class="nc bnc" id="L337" title="All 2 branches missed.">			if(fullTextSearchString != null)</span>
			{
<span class="nc" id="L339">				ps.setString(j++, &quot;%&quot;+fullTextSearchString+&quot;%&quot;);</span>
<span class="nc" id="L340">				ps.setString(j++, &quot;%&quot;+fullTextSearchString+&quot;%&quot;);</span>
			}

<span class="nc" id="L343">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L346">				size = rs.getInt(&quot;total_size&quot;);</span>
			}
<span class="nc" id="L348">			rs.close();</span>
<span class="nc" id="L349">			ps.close();</span>
<span class="nc" id="L350">			db_conn.close();</span>
<span class="nc" id="L351">			rs = null;</span>
<span class="nc" id="L352">			ps = null;</span>
<span class="nc" id="L353">			db_conn = null;</span>

		}
<span class="nc" id="L356">		catch (Exception ex)</span>
		{
<span class="nc" id="L358">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L364" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L365">					rs.close();</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L367">					ps.close();</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L369">					db_conn.close();</span>
			}
<span class="nc" id="L371">			catch (Exception ex2)</span>
			{
<span class="nc" id="L373">			}</span>
		}

<span class="nc" id="L376">		return (size);</span>
	}

	public static List&lt;LabelValueDetails&gt; getQARoots(HttpServletRequest request)
	{
<span class="nc" id="L381">		List&lt;LabelValueDetails&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L383">		Connection db_conn = null;</span>
<span class="nc" id="L384">		PreparedStatement ps = null;</span>
<span class="nc" id="L385">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L388">			db_conn = DBPool.getConnection(request);</span>
<span class="nc" id="L389">			ps = db_conn.prepareStatement(&quot;SELECT count(qa_id) as qa_count, group_name FROM questions_answers WHERE &quot;+CloudToolsForCore.getDomainIdSqlWhere(false)+&quot; GROUP BY group_name&quot;);</span>
<span class="nc" id="L390">			rs = ps.executeQuery();</span>
			LabelValueDetails lvd;
<span class="nc bnc" id="L392" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L394">				lvd = new LabelValueDetails();</span>
<span class="nc" id="L395">				lvd.setLabel(ResponseUtils.filter(DB.getDbString(rs, &quot;group_name&quot;)));</span>
<span class="nc" id="L396">				lvd.setValue(Integer.toString(rs.getInt(&quot;qa_count&quot;)));</span>
<span class="nc" id="L397">				ret.add(lvd);</span>
			}
<span class="nc" id="L399">			rs.close();</span>
<span class="nc" id="L400">			ps.close();</span>
<span class="nc" id="L401">			db_conn.close();</span>
<span class="nc" id="L402">			rs = null;</span>
<span class="nc" id="L403">			ps = null;</span>
<span class="nc" id="L404">			db_conn = null;</span>
		}
<span class="nc" id="L406">		catch (Exception ex)</span>
		{
<span class="nc" id="L408">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L414" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L415">					rs.close();</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L417">					ps.close();</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L419">					db_conn.close();</span>
			}
<span class="nc" id="L421">			catch (Exception ex2)</span>
			{
<span class="nc" id="L423">			}</span>
		}

<span class="nc" id="L426">		return (ret);</span>
	}

	public static QABean getQAById(int questionId)
	{
<span class="nc" id="L431">		QABean qa = null;</span>

<span class="nc" id="L433">		Connection db_conn = null;</span>
<span class="nc" id="L434">		ResultSet rs = null;</span>
<span class="nc" id="L435">		PreparedStatement ps = null;</span>
		try
		{
<span class="nc" id="L438">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L439">			ps = db_conn.prepareStatement(&quot;SELECT * FROM questions_answers WHERE qa_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY qa_id ASC&quot;);</span>
<span class="nc" id="L440">			ps.setInt(1, questionId);</span>
<span class="nc" id="L441">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L444">				qa = fillFromResultSet(rs, true);</span>
			}
<span class="nc" id="L446">			rs.close();</span>
<span class="nc" id="L447">			ps.close();</span>
<span class="nc" id="L448">			db_conn.close();</span>
<span class="nc" id="L449">			rs = null;</span>
<span class="nc" id="L450">			ps = null;</span>
<span class="nc" id="L451">			db_conn = null;</span>
		}
<span class="nc" id="L453">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L456" title="All 2 branches missed.">			if (rs != null) rs.close();</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">			if (ps != null) ps.close();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">			if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L459">			}catch(SQLException e){}</span>
		}

<span class="nc" id="L462">		return (qa);</span>
	}

	/**
	 * Ziska QABean pre admin cast (zadanie odpovede)
	 * @param request
	 * @return
	 */
	public static QABean getQA(HttpServletRequest request)
	{
<span class="nc" id="L472">		QABean qa = null;</span>
<span class="nc" id="L473">		Connection db_conn = null;</span>
<span class="nc" id="L474">		PreparedStatement ps = null;</span>
<span class="nc" id="L475">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L478">			int qaId = Integer.parseInt(request.getParameter(&quot;id&quot;));</span>
<span class="nc" id="L479">			String hash = request.getParameter(&quot;hash&quot;);</span>

<span class="nc bnc" id="L481" title="All 6 branches missed.">			if (qaId &lt; 0 || hash==null || hash.length()&lt;5)</span>
			{
<span class="nc" id="L483">				return(null);</span>
			}

<span class="nc" id="L486">			db_conn = DBPool.getConnection(request);</span>
<span class="nc" id="L487">			ps = db_conn.prepareStatement(&quot;SELECT * FROM questions_answers WHERE qa_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY qa_id ASC&quot;);</span>
<span class="nc" id="L488">			ps.setInt(1, qaId);</span>
<span class="nc" id="L489">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L492">				qa = fillFromResultSet(rs, false);</span>

<span class="nc bnc" id="L494" title="All 2 branches missed.">				if (!qa.getHash().equals(hash))</span>
				{
<span class="nc" id="L496">					qa = null;</span>
				}

			}
<span class="nc" id="L500">			rs.close();</span>
<span class="nc" id="L501">			ps.close();</span>
<span class="nc" id="L502">			db_conn.close();</span>
<span class="nc" id="L503">			rs = null;</span>
<span class="nc" id="L504">			ps = null;</span>
<span class="nc" id="L505">			db_conn = null;</span>
		}
<span class="nc" id="L507">		catch (Exception ex)</span>
		{
<span class="nc" id="L509">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L515" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L516">					rs.close();</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L518">					ps.close();</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L520">					db_conn.close();</span>
			}
<span class="nc" id="L522">			catch (Exception ex2)</span>
			{
<span class="nc" id="L524">			}</span>
		}

<span class="nc" id="L527">		return (qa);</span>
	}


	private static QABean fillFromResultSet(ResultSet rs, boolean filter) throws SQLException {
		QABean qa;
<span class="fc" id="L533">		qa = new QABean();</span>
<span class="fc" id="L534">		qa.setRecode(false);</span>
<span class="fc" id="L535">		qa.setQaId(rs.getInt(&quot;qa_id&quot;));</span>
<span class="fc" id="L536">		qa.setGroupName(DB.getDbString(rs, &quot;group_name&quot;, filter));</span>
<span class="fc" id="L537">		qa.setCategoryName(DB.getDbString(rs, &quot;category_name&quot;, filter));</span>
<span class="fc" id="L538">		Timestamp t = rs.getTimestamp(&quot;question_date&quot;);</span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">		if (t!=null) qa.setQuestionDateLong(t.getTime());</span>
<span class="fc" id="L540">		t = rs.getTimestamp(&quot;answer_date&quot;);</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">		if (t!=null) qa.setAnswerDateLong(t.getTime());</span>
<span class="fc" id="L542">		qa.setQuestion(DB.getDbString(rs, &quot;question&quot;, filter));</span>
<span class="fc" id="L543">		qa.setAnswer(DB.getDbString(rs, &quot;answer&quot;, filter));</span>
<span class="fc" id="L544">		qa.setAnswerWeb(qa.getAnswer());</span>
<span class="fc" id="L545">		qa.setFromName(DB.getDbString(rs, &quot;from_name&quot;, filter));</span>
<span class="fc" id="L546">		qa.setFromEmail(DB.getDbString(rs, &quot;from_email&quot;, filter));</span>
<span class="fc" id="L547">		qa.setToName(DB.getDbString(rs, &quot;to_name&quot;, filter));</span>
<span class="fc" id="L548">		qa.setToEmail(DB.getDbString(rs, &quot;to_email&quot;, filter));</span>
<span class="fc" id="L549">		qa.setPublishOnWeb(rs.getBoolean(&quot;publish_on_web&quot;));</span>
<span class="fc" id="L550">		qa.setAllowPublishOnWeb(rs.getBoolean(&quot;allow_publish_on_web&quot;));</span>
<span class="fc" id="L551">		qa.setHash(DB.getDbString(rs, &quot;hash&quot;, filter));</span>
<span class="fc" id="L552">		qa.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>

<span class="fc" id="L554">		qa.setFromPhone(DB.getDbString(rs, &quot;from_phone&quot;));</span>
<span class="fc" id="L555">		qa.setFromCompany(DB.getDbString(rs, &quot;from_company&quot;));</span>
<span class="fc" id="L556">		qa.setFieldA(DB.getDbString(rs, &quot;field_a&quot;));</span>
<span class="fc" id="L557">		qa.setFieldB(DB.getDbString(rs, &quot;field_b&quot;));</span>
<span class="fc" id="L558">		qa.setFieldC(DB.getDbString(rs, &quot;field_c&quot;));</span>
<span class="fc" id="L559">		qa.setFieldD(DB.getDbString(rs, &quot;field_d&quot;));</span>

<span class="fc" id="L561">		qa.setRecode(true);</span>




<span class="fc" id="L566">		return qa;</span>
	}


	/**
	 *  Description of the Method
	 *
	 *@param  qa       Description of the Parameter
	 *@param  request  Description of the Parameter
	 *@return          Description of the Return Value
	 */
	public static boolean save(QABean qa, HttpServletRequest request)
	{
<span class="fc" id="L579">		Identity user = UsersDB.getCurrentUser(request);</span>
<span class="fc" id="L580">		boolean isAdmin = false;</span>
<span class="pc bpc" id="L581" title="2 of 4 branches missed.">		if (user != null &amp;&amp; user.isAdmin()) isAdmin = true;</span>

<span class="pc bpc" id="L583" title="1 of 2 branches missed.">		if (ShowDoc.getXssRedirectUrl(request)!=null) return false;</span>
<span class="pc bpc" id="L584" title="3 of 4 branches missed.">		if (isAdmin==false &amp;&amp; SpamProtection.canPost(&quot;qa&quot;, qa.getQuestion(), request)==false) return false;</span>
<span class="pc bpc" id="L585" title="3 of 4 branches missed.">		if	(isAdmin==false &amp;&amp; !Captcha.validateResponse(request, null, &quot;qa&quot;)) return false;</span>

<span class="pc bpc" id="L587" title="1 of 2 branches missed.">		if (Tools.isAnyEmpty(qa.getGroupName(), qa.getFromName(), qa.getFromEmail()))</span>
		{
<span class="nc" id="L589">			Logger.error(QADB.class, &quot;CHYBA: Jedno z povinnych poli groupName, fromName, fromEmail je prazdne&quot;);</span>
<span class="nc" id="L590">			return false; //pravdepodobne vyplnil bot a nezadal povinne udaje</span>
		}

<span class="fc" id="L593">		Connection db_conn = null;</span>
<span class="fc" id="L594">		PreparedStatement ps = null;</span>
<span class="fc" id="L595">		ResultSet rs = null;</span>
		try
		{
			//vygeneruj 4 miestny kod
<span class="fc" id="L599">			StringBuilder hash = new StringBuilder();</span>
			int i;
<span class="fc bfc" id="L601" title="All 2 branches covered.">			for (i=0; i&lt;16; i++)</span>
			{
<span class="fc" id="L603">				hash.append(rand.nextInt(9));</span>
			}
<span class="fc" id="L605">			qa.setHash(hash.toString());</span>


<span class="fc" id="L608">			boolean onWeb = false;</span>
<span class="pc bpc" id="L609" title="1 of 2 branches missed.">			if(qa.isPublishOnWeb()==true)</span>
<span class="nc" id="L610">				onWeb = true;</span>

<span class="fc" id="L612">			db_conn = DBPool.getConnection(request);</span>
<span class="fc" id="L613">			ps = db_conn.prepareStatement(&quot;INSERT INTO questions_answers (group_name, category_name, question_date, question, from_name, from_email, to_name, to_email, publish_on_web, hash, allow_publish_on_web, sort_priority, from_phone, from_company, field_a, field_b, field_c, field_d, domain_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;);</span>
<span class="fc" id="L614">			int index = 1;</span>
<span class="fc" id="L615">			ps.setString(index++, qa.getGroupName());</span>
<span class="fc" id="L616">			ps.setString(index++, qa.getCategoryName());</span>
<span class="fc" id="L617">			long now = (new java.util.Date()).getTime();</span>
<span class="fc" id="L618">			Timestamp ts = new Timestamp(now);</span>
<span class="fc" id="L619">			ps.setTimestamp(index++, ts);</span>
<span class="fc" id="L620">			DB.setClob(ps, index++, qa.getQuestion());</span>
<span class="fc" id="L621">			ps.setString(index++, qa.getFromName());</span>
<span class="fc" id="L622">			ps.setString(index++, qa.getFromEmail());</span>
<span class="fc" id="L623">			ps.setString(index++, qa.getToName());</span>
<span class="fc" id="L624">			ps.setString(index++, qa.getToEmail());</span>
<span class="fc" id="L625">			ps.setBoolean(index++, onWeb);</span>
<span class="fc" id="L626">			ps.setString(index++, hash.toString());</span>
<span class="fc" id="L627">			ps.setBoolean(index++, qa.isAllowPublishOnWeb());</span>
<span class="pc bpc" id="L628" title="1 of 2 branches missed.">			if (qa.getSortPriority()&lt;1) qa.setSortPriority(getNewPriority(qa.getGroupName()));</span>
<span class="fc" id="L629">			ps.setInt(index++, qa.getSortPriority());</span>

<span class="fc" id="L631">			ps.setString(index++, qa.getFromPhone());</span>
<span class="fc" id="L632">			ps.setString(index++, qa.getFromCompany());</span>
<span class="fc" id="L633">			ps.setString(index++, qa.getFieldA());</span>
<span class="fc" id="L634">			ps.setString(index++, qa.getFieldB());</span>
<span class="fc" id="L635">			ps.setString(index++, qa.getFieldC());</span>
<span class="fc" id="L636">			ps.setString(index++, qa.getFieldD());</span>
<span class="fc" id="L637">			ps.setInt(index++, CloudToolsForCore.getDomainId());</span>

<span class="fc" id="L639">			ps.execute();</span>
<span class="fc" id="L640">			ps.close();</span>

<span class="fc" id="L642">			ps = db_conn.prepareStatement(&quot;SELECT max(qa_id) as qa_id FROM questions_answers WHERE &quot;+CloudToolsForCore.getDomainIdSqlWhere(false));</span>
<span class="fc" id="L643">			rs = ps.executeQuery();</span>
<span class="pc bpc" id="L644" title="1 of 2 branches missed.">			if (rs.next())</span>
			{
<span class="fc" id="L646">				qa.setQaId(rs.getInt(&quot;qa_id&quot;));</span>
			}
<span class="fc" id="L648">			rs.close();</span>
<span class="fc" id="L649">			ps.close();</span>

<span class="fc" id="L651">			db_conn.close();</span>

<span class="fc" id="L653">			rs = null;</span>
<span class="fc" id="L654">			ps = null;</span>
<span class="fc" id="L655">			db_conn = null;</span>
		}
<span class="nc" id="L657">		catch (Exception ex)</span>
		{
<span class="nc" id="L659">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L660">			return (false);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L667">					rs.close();</span>
<span class="pc bpc" id="L668" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L669">					ps.close();</span>
<span class="pc bpc" id="L670" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L671">					db_conn.close();</span>
			}
<span class="nc" id="L673">			catch (Exception ex2)</span>
			{
<span class="fc" id="L675">			}</span>
		}

<span class="fc" id="L678">		Adminlog.add(Adminlog.TYPE_QA_CREATE, &quot;Vytvorena otazka: &quot;+qa.getQuestion(), qa.getQaId(), -1);</span>

<span class="fc" id="L680">		return (true);</span>
	}

	public static boolean answer(QABean qa, HttpServletRequest request)
	{
<span class="nc" id="L685">		QABean original = getQAById(qa.getQaId());</span>
<span class="nc" id="L686">		BeanDiffPrinter diff = new BeanDiffPrinter(new BeanDiff().setNew(qa).setOriginal(original));</span>
<span class="nc" id="L687">		Adminlog.add(Adminlog.TYPE_QA_UPDATE, &quot;Zmenena otazka: &quot;+diff, qa.getQaId(), -1);</span>

<span class="nc" id="L689">		Connection db_conn = null;</span>
<span class="nc" id="L690">		PreparedStatement ps = null;</span>
		try
		{
<span class="nc" id="L693">			db_conn = DBPool.getConnection(request);</span>
<span class="nc" id="L694">			ps = db_conn.prepareStatement(&quot;UPDATE questions_answers SET category_name=?, answer_date=?, question=?, from_name=?, from_email=?, to_name=?, to_email=?, publish_on_web=?, answer=?, group_name=?, sort_priority=?, from_phone=?, from_company=?, field_a=?, field_b=?, field_c=?, field_d=? WHERE qa_id=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L695">			int index = 1;</span>
<span class="nc" id="L696">			ps.setString(index++, qa.getCategoryName());</span>
<span class="nc" id="L697">			long now = (new java.util.Date()).getTime();</span>
<span class="nc" id="L698">			ps.setTimestamp(index++, new Timestamp(now));</span>
<span class="nc" id="L699">			DB.setClob(ps, index++, qa.getQuestion());</span>
<span class="nc" id="L700">			ps.setString(index++, qa.getFromName());</span>
<span class="nc" id="L701">			ps.setString(index++, qa.getFromEmail());</span>
<span class="nc" id="L702">			ps.setString(index++, qa.getToName());</span>
<span class="nc" id="L703">			ps.setString(index++, qa.getToEmail());</span>
<span class="nc" id="L704">			ps.setBoolean(index++, qa.isPublishOnWeb());</span>
<span class="nc" id="L705">			DB.setClob(ps, index++, qa.getAnswerWeb());</span>
<span class="nc" id="L706">			ps.setString(index++, qa.getGroupName());</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">			if (qa.getSortPriority()&lt;1) qa.setSortPriority(getNewPriority(qa.getGroupName()));</span>
<span class="nc" id="L708">			ps.setInt(index++, qa.getSortPriority());</span>

<span class="nc" id="L710">			ps.setString(index++, qa.getFromPhone());</span>
<span class="nc" id="L711">			ps.setString(index++, qa.getFromCompany());</span>
<span class="nc" id="L712">			ps.setString(index++, qa.getFieldA());</span>
<span class="nc" id="L713">			ps.setString(index++, qa.getFieldB());</span>
<span class="nc" id="L714">			ps.setString(index++, qa.getFieldC());</span>
<span class="nc" id="L715">			ps.setString(index++, qa.getFieldD());</span>

<span class="nc" id="L717">			ps.setInt(index++, qa.getQaId());</span>
<span class="nc" id="L718">			ps.executeUpdate();</span>
<span class="nc" id="L719">			ps.close();</span>
<span class="nc" id="L720">			db_conn.close();</span>
<span class="nc" id="L721">			ps = null;</span>
<span class="nc" id="L722">			db_conn = null;</span>
		}
<span class="nc" id="L724">		catch (Exception ex)</span>
		{
<span class="nc" id="L726">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L727">			return (false);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L733" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L734">					ps.close();</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L736">					db_conn.close();</span>
			}
<span class="nc" id="L738">			catch (Exception ex2)</span>
			{
<span class="nc" id="L740">			}</span>
		}
<span class="nc" id="L742">		return (true);</span>
	}

	public static boolean delete(QABean qa, HttpServletRequest request)
	{
<span class="nc" id="L747">		SimpleQuery query = new SimpleQuery(DBPool.getDBName(request));</span>
<span class="nc" id="L748">		String question = query.forString(&quot;SELECT question FROM questions_answers WHERE qa_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), qa.getQaId());</span>
		try
		{
<span class="nc" id="L751">			query.execute(&quot;DELETE FROM questions_answers WHERE qa_id=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), qa.getQaId());</span>
		}
<span class="nc" id="L753">		catch (Exception ex)</span>
		{
<span class="nc" id="L755">			return (false);</span>
<span class="nc" id="L756">		}</span>
<span class="nc" id="L757">		Adminlog.add(Adminlog.TYPE_QA_DELETE, &quot;Zmazana otazka: &quot;+question, qa.getQaId(), -1);</span>
<span class="nc" id="L758">		return (true);</span>
	}

	/**
	 * Vrati novu prioritu pre qa pre danu grupu, najde doteraz najvyssiu + 10
	 * @param groupName groupName
	 * @return
	 */
	protected static int getNewPriority(String groupName){
<span class="fc" id="L767">		return new SimpleQuery().forInt(&quot;select max(sort_priority) from questions_answers where group_name=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), groupName)+10;</span>
	}

	public static String addQuestion(QABean qa, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
		//ak ju chce vymazat, tak sa pozrieme, ci je to admin, a ak hej, tak ju vymazeme
<span class="fc" id="L772">		Identity user = UsersDB.getCurrentUser(request);</span>
<span class="pc bpc" id="L773" title="2 of 4 branches missed.">		boolean isAdmin = (user != null &amp;&amp; user.isAdmin());</span>
<span class="fc" id="L774">		final String delete = &quot;/components/qa/admin_list&quot;;</span>
<span class="fc" id="L775">		final String successAnswer = &quot;/components/qa/admin_answer_result&quot;;</span>

<span class="pc bpc" id="L777" title="1 of 2 branches missed.">		if (isAdmin){</span>
			try{
<span class="fc" id="L779">				String qaId = request.getParameter(&quot;qaId&quot;);</span>
<span class="fc" id="L780">				String action = request.getParameter(&quot;action&quot;);</span>
<span class="pc bpc" id="L781" title="3 of 4 branches missed.">				boolean isQuestionIdValid = ( qaId != null &amp;&amp; qaId.matches(&quot;^[0-9]+$&quot;) );</span>
<span class="fc" id="L782">				boolean isActionValid = &quot;delete&quot;.equalsIgnoreCase(action);</span>

<span class="pc bpc" id="L784" title="3 of 4 branches missed.">				if (isActionValid &amp;&amp; isQuestionIdValid){</span>
<span class="nc" id="L785">					QABean question = new QABean();</span>
<span class="nc" id="L786">					question.setQaId( Integer.parseInt(qaId) );</span>
<span class="nc" id="L787">					QADB.delete(question, request);</span>
<span class="nc" id="L788">					return SpringUrlMapping.redirect(delete);</span>
				}
			}
<span class="nc" id="L791">			catch (Exception e) {</span>
<span class="nc" id="L792">				return SpringUrlMapping.redirect(delete);</span>
<span class="fc" id="L793">			}</span>
		}
		//ochrana pred XSS utokom
<span class="fc" id="L796">		String forward = request.getParameter(&quot;forward&quot;);</span>
<span class="fc" id="L797">		String xssRedirectUrl = ShowDoc.getXssRedirectUrl(request);</span>
<span class="pc bpc" id="L798" title="1 of 2 branches missed.">		if (xssRedirectUrl != null) {</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">			if (forward.indexOf('?') == -1)</span>
<span class="nc" id="L800">				forward += &quot;?qasend=xss&quot;;</span>
			else
<span class="nc" id="L802">				forward += &quot;&amp;qasend=xss&quot;;</span>

<span class="nc" id="L804">			SpringUrlMapping.redirect(Tools.sanitizeHttpHeaderParam(forward));</span>
		}

		boolean ret;
<span class="fc" id="L808">		boolean performAnswer = false;</span>
<span class="pc bpc" id="L809" title="5 of 6 branches missed.">		if (qa.getQaId() &gt; 0 &amp;&amp; qa.getHash() != null &amp;&amp; qa.getHash().length() &gt; 5)</span>
<span class="nc" id="L810">			return(executeAnswer(qa, request, response));</span>

<span class="pc bpc" id="L812" title="5 of 6 branches missed.">		if(qa.getQaId() == -2 &amp;&amp; user != null &amp;&amp; user.isAdmin()) {</span>
<span class="nc" id="L813">			performAnswer = true;</span>
<span class="nc" id="L814">			ret = QADB.save(qa, request);</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">			if(ret) return(executeAnswer(qa, request, response));</span>
	   } else
<span class="fc" id="L817">			ret = QADB.save(qa, request);</span>

<span class="pc bpc" id="L819" title="1 of 2 branches missed.">		if (ret == true) {</span>
			//posli mu mail
<span class="fc" id="L821">			ret = sendAdminMail(qa, request);</span>
<span class="pc bpc" id="L822" title="3 of 6 branches missed.">			if (user != null &amp;&amp; user.isAdmin() &amp;&amp; performAnswer)</span>
<span class="nc" id="L823">				SpringUrlMapping.redirect(&quot;/components/qa/admin_roots&quot;);</span>
		}

<span class="pc bpc" id="L826" title="1 of 2 branches missed.">		if (ret == true)</span>
<span class="fc" id="L827">			request.setAttribute(&quot;ok&quot;, &quot;true&quot;);</span>

<span class="pc bpc" id="L829" title="2 of 4 branches missed.">		if (forward != null &amp;&amp; forward.trim().length() &gt; 2) {</span>
<span class="pc bpc" id="L830" title="1 of 2 branches missed.">			if (ret == true) {</span>
<span class="pc bpc" id="L831" title="1 of 2 branches missed.">				if (forward.indexOf('?') == -1)</span>
<span class="fc" id="L832">					forward += &quot;?qasend=ok&quot;;</span>
				else
<span class="nc" id="L834">					forward += &quot;&amp;qasend=ok&quot;;</span>
			} else {
<span class="nc bnc" id="L836" title="All 2 branches missed.">				if (forward.indexOf('?') == -1)</span>
<span class="nc" id="L837">					forward += &quot;?qasend=fail&quot;;</span>
				else
<span class="nc" id="L839">					forward += &quot;&amp;qasend=fail&quot;;</span>
			}
<span class="fc" id="L841">			return SpringUrlMapping.redirect(Tools.sanitizeHttpHeaderParam(forward));</span>
		}

		//Pôvodne tu bola &quot;success&quot; hodnota ale v struct-config.xml neexistuje takéto mapovanie
		//Preto sme to zmenili na existujúce mapovanie &quot;success_answer&quot;
<span class="nc" id="L846">		return SpringUrlMapping.redirect(successAnswer);</span>
	}

	public static String executeAnswer(QABean qa, HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
<span class="nc" id="L850">		final String reloadParentClose = &quot;/components/reloadParentClose&quot;;</span>
<span class="nc" id="L851">		final String successAnswer = &quot;/components/qa/admin_answer_result&quot;;</span>

<span class="nc bnc" id="L853" title="All 2 branches missed.">		if (Tools.isEmpty(qa.getQuestion())) {</span>
			//zmaz to z db
<span class="nc" id="L855">			QADB.delete(qa, request);</span>
<span class="nc" id="L856">			return SpringUrlMapping.redirect(reloadParentClose);</span>
		}

<span class="nc" id="L859">		boolean ret = QADB.answer(qa, request);</span>
<span class="nc" id="L860">		String lng =  (String)request.getSession().getAttribute(Prop.SESSION_I18N_PROP_LNG);</span>

<span class="nc bnc" id="L862" title="All 2 branches missed.">		if (lng == null)</span>
<span class="nc" id="L863">			lng = sk.iway.iwcm.Constants.getString(&quot;defaultLanguage&quot;);</span>

<span class="nc bnc" id="L865" title="All 2 branches missed.">		if (request.getParameter(&quot;lng&quot;) != null)</span>
<span class="nc" id="L866">			lng = request.getParameter(&quot;lng&quot;);</span>

<span class="nc" id="L868">		Prop prop = Prop.getInstance(Constants.getServletContext(), lng, false);</span>

<span class="nc bnc" id="L870" title="All 6 branches missed.">		if (ret == true &amp;&amp; qa.getAnswer() != null &amp;&amp; qa.getAnswer().length() &gt; 0) {</span>
			//posli mu mail
			try {
<span class="nc" id="L873">				String message = &quot;&lt;p&gt;&quot;+prop.getText(&quot;components.qa.add_action.answer_to_your_question&quot;) + &quot;:&lt;br/&gt;&lt;/p&gt;&quot;;</span>

<span class="nc" id="L875">				String question = qa.getQuestion().trim();</span>
<span class="nc" id="L876">				String answer = qa.getAnswer().trim();</span>
<span class="nc" id="L877">				String sender = qa.getToName().trim();</span>
<span class="nc" id="L878">				String recipient = qa.getFromName().trim();</span>

<span class="nc" id="L880">				message += &quot;&lt;p&gt;&quot; + prop.getText(&quot;components.qa.add_action.question&quot;) + &quot;:&lt;br/&gt;&lt;/p&gt;&lt;p&gt;&quot;+question+&quot;&lt;br/&gt;&lt;br/&gt;&lt;/p&gt;&quot;;</span>
<span class="nc" id="L881">				message += &quot;&lt;p&gt;&quot; + prop.getText(&quot;components.qa.add_action.answer&quot;) + &quot;:&lt;br/&gt;&lt;/p&gt;&lt;p&gt;&quot;+answer+&quot;&lt;br/&gt;&lt;br/&gt;&lt;/p&gt;&quot;;</span>

<span class="nc" id="L883">				message += &quot;&lt;p&gt;&lt;br/&gt;&lt;br/&gt;&quot; + prop.getText(&quot;components.qa.add_action.footer&quot;) +  &quot; &quot; + sender + &quot;&lt;/p&gt;&quot;;</span>

				//bacha, toto je odpoved, takze toName je vlastne sender
				//a fromName je recipient

<span class="nc" id="L888">				String toName = qa.getToName();</span>
<span class="nc bnc" id="L889" title="All 4 branches missed.">				if (toName == null || toName.length() &lt; 2)</span>
<span class="nc" id="L890">					toName = qa.getToEmail();</span>

<span class="nc" id="L892">				String subject = prop.getText(&quot;components.qa.add_action.answer_to_your_question&quot;);</span>

<span class="nc" id="L894">				SendMail.send(toName, qa.getToEmail(), qa.getFromEmail(), subject, message);</span>

				//daj do requestu answer
<span class="nc" id="L897">				String email = &quot;&lt;table border=0&gt;&lt;tr&gt;&lt;td&gt;&quot;+prop.getText(&quot;components.qa.add_action.sender&quot;)+&quot;: &lt;/td&gt;&lt;td&gt;&quot;+sender+&quot; &amp;lt;&quot;+qa.getToEmail()+&quot;&amp;gt;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<span class="nc" id="L898">				email += &quot;&lt;tr&gt;&lt;td&gt;&quot;+prop.getText(&quot;components.qa.add_action.recipient&quot;)+&quot;: &lt;/td&gt;&lt;td&gt;&quot;+recipient+&quot; &amp;lt;&quot;+qa.getFromEmail()+&quot;&amp;gt;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<span class="nc" id="L899">				email += &quot;&lt;tr&gt;&lt;td&gt;&quot;+prop.getText(&quot;components.qa.add_action.subject&quot;)+&quot;: &lt;/td&gt;&lt;td&gt;&quot;+subject+&quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<span class="nc" id="L900">				email += &quot;&lt;tr&gt;&lt;td&gt;&quot;+prop.getText(&quot;components.qa.add_action.email_body&quot;)+&quot;: &lt;/td&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<span class="nc" id="L901">				email += &quot;&lt;tr&gt;&lt;td colspan=2&gt;&quot;+Tools.replace(message, &quot;\n&quot;, &quot;&lt;br&gt;&quot;)+&quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<span class="nc" id="L902">				email += &quot;&lt;/table&gt;&quot;;</span>

<span class="nc" id="L904">				request.setAttribute(&quot;answer&quot;, email);</span>
<span class="nc" id="L905">			} catch (Exception ex) {</span>
<span class="nc" id="L906">				ret = false;</span>
<span class="nc" id="L907">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L908">			}</span>
		}

<span class="nc bnc" id="L911" title="All 4 branches missed.">		if (qa.getAnswer() == null || qa.getAnswer().length() &lt;= 2) {</span>
<span class="nc" id="L912">			String email = prop.getText(&quot;components.qa.add_action.email_text_not_entered_saved_to_db&quot;);</span>
<span class="nc" id="L913">			request.setAttribute(&quot;answer&quot;, email);</span>
		}

<span class="nc bnc" id="L916" title="All 2 branches missed.">		if (ret == false)</span>
<span class="nc" id="L917">			request.removeAttribute(&quot;answer&quot;);</span>

<span class="nc bnc" id="L919" title="All 2 branches missed.">		if (&quot;true&quot;.equals(request.getParameter(&quot;isFromEmail&quot;)))</span>
<span class="nc" id="L920">			return SpringUrlMapping.redirect(successAnswer);</span>

<span class="nc" id="L922">		return SpringUrlMapping.redirect(reloadParentClose);</span>
	}

	public static boolean sendAdminMail(QABean qa, HttpServletRequest request) {
<span class="fc" id="L926">		boolean ret = true;</span>

		try {
<span class="fc" id="L929">			String lng = PageLng.getUserLng(request);</span>
<span class="fc" id="L930">			Prop prop = Prop.getInstance(Constants.getServletContext(), lng, false);</span>

<span class="fc" id="L932">			String url = Tools.getBaseHref(request) + &quot;/components/qa/admin_answer.jsp&quot;;</span>
<span class="pc bpc" id="L933" title="1 of 2 branches missed.">			if(Tools.isNotEmpty(Constants.getString(&quot;sk.iway.iwcm.qa.AddAction.sendAdminMail.url&quot;)))</span>
<span class="fc" id="L934">				url = Constants.getString(&quot;sk.iway.iwcm.qa.AddAction.sendAdminMail.url&quot;);</span>

<span class="fc" id="L936">			StringBuilder message = new StringBuilder(prop.getText(&quot;components.qa.add_action.new_question&quot;)).append(&quot;: &lt;br&gt;\n&quot;);</span>

<span class="fc" id="L938">			message.append(&quot;&lt;a href='&quot;);</span>
<span class="fc" id="L939">			message.append(url+&quot;?id=&quot;).append(qa.getQaId()).append(&quot;&amp;hash=&quot;).append(qa.getHash());</span>
<span class="pc bpc" id="L940" title="1 of 2 branches missed.">			if (request.getParameter(&quot;lng&quot;)!=null)</span>
<span class="fc" id="L941">				message.append(&quot;&amp;lng=&quot;+ResponseUtils.filter(request.getParameter(&quot;lng&quot;)));</span>

<span class="fc" id="L943">			message.append(&quot;'&gt;&quot;);</span>
<span class="fc" id="L944">			message.append(prop.getText(&quot;components.qa.add_action.for_answer_click_here&quot;));</span>
<span class="fc" id="L945">			message.append(&quot;&lt;/a&gt;&quot;);</span>

<span class="fc" id="L947">			String subject = prop.getText(&quot;components.qa.add_action.question&quot;);</span>

<span class="fc" id="L949">			SendMail.send(qa.getFromName(), qa.getFromEmail(), qa.getToEmail(), subject, message.toString());</span>
<span class="nc" id="L950">		} catch (Exception ex) {</span>
<span class="nc" id="L951">			ret = false;</span>
<span class="nc" id="L952">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L953">		}</span>

<span class="fc" id="L955">		return ret;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>