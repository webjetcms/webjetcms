<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApproveService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.editor.service</a> &gt; <span class="el_source">ApproveService.java</span></div><h1>ApproveService.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.editor.service;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.context.annotation.RequestScope;

import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.SendMail;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.components.users.groups_approve.GroupsApproveEntity;
import sk.iway.iwcm.components.users.groups_approve.GroupsApproveRepository;
import sk.iway.iwcm.doc.DocBasic;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.DocDetailsRepository;
import sk.iway.iwcm.doc.DocHistory;
import sk.iway.iwcm.doc.DocHistoryRepository;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UsersDB;

/**
 * Sluzby spojene so schvalovanim web stranok
 */
@Service
@RequestScope
public class ApproveService {

    //repozitare
    private GroupsApproveRepository approveRepo;

    //autowired
    private HttpServletRequest request;

    //privatne objekty
    private DocDB docDB;
    private GroupsDB groupsDB;
    private Identity currentUser;
    private Prop prop;

	//Users that are approvers
    private Map&lt;Integer, UserDetails&gt; approveByTable;
	//approve table for level2
	private Map&lt;Integer, UserDetails&gt; approveByTableLevel2;
	//Users that we need notify
    private Map&lt;Integer, UserDetails&gt; notifyTable;

	//To check if page was self approved
<span class="fc" id="L60">	private boolean selfApproved = false;</span>
	public boolean isSelfApproved() {
<span class="fc" id="L62">		return this.selfApproved;</span>
	}

    @Autowired
<span class="fc" id="L66">    public ApproveService(GroupsApproveRepository approveRepo, DocHistoryRepository docHistoryRepo, HttpServletRequest request) {</span>
<span class="fc" id="L67">        this.approveRepo = approveRepo;</span>
<span class="fc" id="L68">        this.request = request;</span>
<span class="fc" id="L69">        this.prop = Prop.getInstance(request);</span>

<span class="fc" id="L71">        this.docDB = DocDB.getInstance();</span>
<span class="fc" id="L72">        this.groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L73">        this.currentUser = UsersDB.getCurrentUser(request);</span>

<span class="fc" id="L75">		this.approveByTable = new HashMap&lt;&gt;();</span>
<span class="fc" id="L76">        this.notifyTable = new HashMap&lt;&gt;();</span>
<span class="fc" id="L77">    }</span>

    /**
     * Initializes hash tables approveByTable and notifyTable (also set selfApproved)
     * @param editedDoc
    */
	public void loadApproveTables(int currentGroupId) {
<span class="fc" id="L84">        approveByTable = new HashMap&lt;&gt;();</span>
<span class="fc" id="L85">        notifyTable = new HashMap&lt;&gt;();</span>
<span class="fc" id="L86">		approveByTableLevel2 = new HashMap&lt;&gt;();</span>

<span class="fc" id="L88">		loadApproveTablesLogic(currentGroupId);</span>
<span class="fc" id="L89">	}</span>

	/**
	 * Initializes hash tables approveByTable and notifyTable (also set selfApproved), whole logic
	 *
	 * @param currentGroupId
	 */
	private void loadApproveTablesLogic(int currentGroupId) {

<span class="fc" id="L98">		boolean isLevel2Approver = false;</span>
<span class="fc" id="L99">		boolean isApprover = false;</span>

<span class="fc" id="L101">		int depth = 0;</span>
<span class="fc" id="L102">		int maxDepth = 30;</span>
		GroupDetails group;
		int mode;
<span class="fc" id="L105">		int failsafe = 0;</span>

<span class="pc bpc" id="L107" title="1 of 2 branches missed.">		while (failsafe++&lt;100) {</span>
<span class="fc" id="L108">			group = groupsDB.getGroup(currentGroupId);</span>
<span class="fc" id="L109">            depth++;</span>
<span class="pc bpc" id="L110" title="2 of 6 branches missed.">			if (group == null || depth &gt; maxDepth || currentGroupId == 0) {</span>
				//group doesn't exist
<span class="nc" id="L112">				break;</span>
			}

			//Inicialize support hashmaps
<span class="fc" id="L116">			HashMap&lt;Integer, UserDetails&gt; groupApprovers = new HashMap&lt;&gt;();</span>
<span class="fc" id="L117">			HashMap&lt;Integer, UserDetails&gt; level2GroupApprovers = new HashMap&lt;&gt;();</span>
<span class="fc" id="L118">			HashMap&lt;Integer, UserDetails&gt; notifyTableGroup = new HashMap&lt;&gt;();</span>

			// Iterate groupsApprove list and check if currentUser isAdmin and isAuthorized
			// If yes set variables and etc, or remove GroupsApproveEntity from List
<span class="fc bfc" id="L122" title="All 2 branches covered.">			for (GroupsApproveEntity entity : approveRepo.findByGroup(group)) {</span>

<span class="fc" id="L124">				UserDetails groupApprover = UsersDB.getUserCached(entity.getUserId().intValue());</span>

				//Must be authotized admin
<span class="pc bpc" id="L127" title="2 of 6 branches missed.">				if(groupApprover==null || !groupApprover.isAdmin() || !groupApprover.isAuthorized()) continue;</span>

                //Mode of approve
<span class="fc" id="L130">                mode = entity.getApproveMode();</span>

				//Is currentUser (current logged) also groupApprover ?
<span class="fc bfc" id="L133" title="All 2 branches covered.">				if(groupApprover.getUserId() == currentUser.getUserId()) {</span>
					//Yes, currentUser is group approver

<span class="pc bpc" id="L136" title="1 of 2 branches missed.">                    if(mode == UsersDB.APPROVE_LEVEL2) isLevel2Approver = true;</span>
					//
<span class="fc bfc" id="L138" title="All 2 branches covered.">					else if(mode == UsersDB.APPROVE_APPROVE) isApprover = true;</span>
					//
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">					else if(mode == UsersDB.APPROVE_NOTIFY) notifyTableGroup.put(Integer.valueOf(groupApprover.getUserId()), groupApprover);</span>

					//Can do anything on his own
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">					else if(mode == UsersDB.APPROVE_NONE) isLevel2Approver = true;</span>
				} else {
					///No, currentUser is not group approver

					//
<span class="fc bfc" id="L148" title="All 2 branches covered.">					if (mode == UsersDB.APPROVE_LEVEL2) level2GroupApprovers.put(Integer.valueOf(groupApprover.getUserId()), groupApprover);</span>
					//
<span class="fc bfc" id="L150" title="All 2 branches covered.">					else if (mode == UsersDB.APPROVE_APPROVE) groupApprovers.put(Integer.valueOf(groupApprover.getUserId()), groupApprover);</span>
					//
<span class="pc bpc" id="L152" title="1 of 4 branches missed.">					else if (mode == UsersDB.APPROVE_NOTIFY &amp;&amp; groupApprover.getUserId() != currentUser.getUserId()) notifyTableGroup.put(Integer.valueOf(groupApprover.getUserId()), groupApprover);</span>

					//if (mode == UsersDB.APPROVE_NONE) user can do what he want BUT he is NO approver and dont want to get any email -&gt; so not involved
				}
<span class="fc" id="L156">			}</span>

<span class="fc" id="L158">			currentGroupId = group.getParentGroupId();</span>

			//pouzivame system best match
<span class="fc bfc" id="L161" title="All 2 branches covered.">			if (approveByTable.isEmpty()) approveByTable.putAll(groupApprovers);</span>

			//pouzivame system best match
<span class="fc bfc" id="L164" title="All 2 branches covered.">			if (approveByTableLevel2.isEmpty()) approveByTableLevel2.putAll(level2GroupApprovers);</span>

			//notify davame vsetkym
<span class="fc" id="L167">			notifyTable.putAll(notifyTableGroup);</span>
<span class="fc" id="L168">		}</span>

<span class="pc bpc" id="L170" title="1 of 6 branches missed.">		if (isApprover == false &amp;&amp; approveByTable.isEmpty() &amp;&amp; approveByTableLevel2.isEmpty()==false) {</span>
			//we dont have first level approver but have second, so the second level will be first
<span class="nc" id="L172">			approveByTable.putAll(approveByTableLevel2);</span>
<span class="nc" id="L173">			approveByTableLevel2.clear();</span>
<span class="nc bnc" id="L174" title="All 2 branches missed.">			if (isLevel2Approver) {</span>
<span class="nc" id="L175">				isLevel2Approver = false;</span>
<span class="nc" id="L176">				isApprover = true;</span>
			}
		}

		//Check if currentUser is level2Approver, highest approve right
<span class="fc bfc" id="L181" title="All 2 branches covered.">		if(isLevel2Approver) {</span>
			//currentUser IS level2Approver

			//Clear approve table (dont need approve)
<span class="fc" id="L185">			approveByTable.clear();</span>
<span class="fc" id="L186">			approveByTableLevel2.clear();</span>
			//Mark as self approved
<span class="fc" id="L188">			selfApproved = true;</span>
		} else {
			//currentUser ISN'T level2Approver
<span class="fc bfc" id="L191" title="All 2 branches covered.">			if(isApprover) {</span>
				//currentUser IS approver

				//Clear approve table (dont need approve)
<span class="fc" id="L195">				approveByTable.clear();</span>
<span class="fc" id="L196">				selfApproved = true;</span>
				//Mark as self approved
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">				if (approveByTableLevel2.isEmpty()==false) {</span>
					//simulate level2 in approveByTable (it's the same process)
<span class="nc" id="L200">					approveByTable.putAll(approveByTableLevel2);</span>
<span class="nc" id="L201">					selfApproved = false;</span>
				}
			} else {
				/**
				 * Just to understand, currentUser ISNT'T level2Approver nor approver.
				 *
				 * If &quot;approveByTable.size() &gt; 0&quot;, then this must by approved (but not by currentUser).
				 *
				 * If &quot;! approveByTable.size() &gt; 0&quot;, then this dont need to be approved so anyone can do insert/edit.
				 */
			}
		}
<span class="fc" id="L213">	}</span>

	/**
	 * Approve action, in other word's approve/reject webpage change (aka waiting docHistory).
	 * !! request param &quot;zamietni&quot; indicates, if we approve action (webpage will be change like in docHistory) or reject action (no change to webpage)
	 * After approve/reject, the waiting docHistory will be removed from waiting list (awaitingApprove param is set as empty string).
	 * @param docHistoryRepo
	 * @param editorService
	 * @return return true if approve was success
	 */
	public boolean approveAction(DocHistoryRepository docHistoryRepo, EditorService editorService) {

		//Get and check historyId
<span class="nc" id="L226">		int historyId = Tools.getIntValue(request.getParameter(&quot;historyid&quot;), -1);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">		if(historyId == -1) {</span>
<span class="nc" id="L228">			request.setAttribute(&quot;message&quot;, &quot;History ID cant be empty&quot;);</span>
<span class="nc" id="L229">			return false;</span>
		}

<span class="nc" id="L232">		Optional&lt;DocHistory&gt; docHistoryOpt = docHistoryRepo.findById(Long.valueOf(historyId));</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">		if(!docHistoryOpt.isPresent()) {</span>
<span class="nc" id="L234">			request.setAttribute(&quot;message&quot;, &quot;History record by givven historyId not found&quot;);</span>
<span class="nc" id="L235">			return false;</span>
		}
<span class="nc" id="L237">		DocHistory docHistory = docHistoryOpt.get();</span>

		//Load approve tables, this step will show us if current user can approve/dis-approve docHistory uppon certain docDetails
<span class="nc" id="L240">		loadApproveTables(docHistory.getGroupId());</span>

<span class="nc bnc" id="L242" title="All 4 branches missed.">		if(needApprove()==false || selfApproved) {</span>
			//Doc, do not need approve OR
			//current user IS self approver, can approve or reject insert/update action

			//Approve - CREATE / UPDATE
<span class="nc bnc" id="L247" title="All 2 branches missed.">			if (request.getParameter(&quot;zamietni&quot;) == null) {</span>

				//Cancel waiting docHistory (aka waiting webpage update)
<span class="nc" id="L250">				editorService.approveDocHistory(docHistory);</span>

				//Send notification emails
<span class="nc" id="L253">				sendWebpageApproveNotification(true, docHistory);</span>

				//SET this as APPROVE indicator
<span class="nc" id="L256">				request.setAttribute(&quot;approved&quot;, &quot;true&quot;);</span>
			} else { //Reject - CREATE / UPDATE

				//Cancel waiting docHistory (aka waiting webpage update)
<span class="nc" id="L260">				docHistoryRepo.rejectDocHistory(&quot;&quot;, currentUser.getUserId(), historyId);</span>

				//Send notification emails
<span class="nc" id="L263">				sendWebpageApproveNotification(false, docHistory);</span>

				//SET this as REJECT indicator
<span class="nc" id="L266">				request.setAttribute(&quot;rejected&quot;, &quot;true&quot;);</span>
			}

<span class="nc" id="L269">			return true;</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">		} else if (approveByTableLevel2.isEmpty()==false) {</span>
			//if there are also level2 approvers update approvers ID and send notifications
<span class="nc" id="L272">			docHistory.setAwaitingApprove(&quot;,&quot; + getApproveUserIds() + &quot;,&quot;);</span>
<span class="nc" id="L273">			docHistoryRepo.save(docHistory);</span>

<span class="nc" id="L275">			Identity user = UsersDB.getCurrentUser(request);</span>

			//posli mail schvalovatelovi level2
<span class="nc" id="L278">			String notes = request.getParameter(&quot;notes&quot;);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">			if (Tools.isEmpty(notes)) notes = prop.getText(&quot;components.reservation.reservation_list.accept&quot;);</span>
<span class="nc" id="L280">			notes = prop.getText(&quot;approve.page.approvedToNextLevel.comment&quot;, user.getFullName(), notes);</span>

<span class="nc" id="L282">			String approverNames = getApproveUserNames();</span>

<span class="nc" id="L284">			sendWebpageApproveRequestEmail(docHistory, historyId, currentUser.getUserId(), notes);</span>
<span class="nc" id="L285">			request.setAttribute(&quot;approvedToNextLevel&quot;, prop.getText(&quot;approve.page.approvedToNextLevel&quot;, approverNames));</span>

			//posli info email autorovi
<span class="nc" id="L288">			String subject = prop.getText(&quot;approve.page.approvedToNextLevel.editorSubject&quot;, docHistory.getTitle());</span>

<span class="nc" id="L290">			String url = Tools.getBaseHref(request) + &quot;/showdoc.do?docid=&quot;+docHistory.getDocId()+&quot;&amp;historyid=&quot; + historyId;</span>

<span class="nc" id="L292">			StringBuilder message = new StringBuilder(prop.getText(&quot;approve.page.approvedToNextLevel.editorText&quot;, docHistory.getTitle(), approverNames)).append(&quot;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L293">			message.append(prop.getText(&quot;approve.dir&quot;)).append(&quot;: &quot;).append(groupsDB.getGroupNamePath(docHistory.getGroupId())).append(&quot;&lt;br&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L294">			message.append(prop.getText(&quot;approve.url&quot;)).append(&quot;:&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L295">			message.append(&quot;&lt;a href='&quot;).append(url).append(&quot;'&gt;&quot;).append(url).append(&quot;&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L296">			message.append(notes).append(&quot;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L297">			UserDetails author = UsersDB.getUserCached(docHistory.getAuthorId());</span>
<span class="nc bnc" id="L298" title="All 4 branches missed.">			if (author != null &amp;&amp; Tools.isEmail(author.getEmail())) {</span>
<span class="nc" id="L299">				SendMail.send(user.getFullName(), user.getEmail(), author.getEmail(), subject, message.toString(), request);</span>
			}

<span class="nc" id="L302">			return true;</span>
		} else {
			//Doc NEED's approve, BUT current user is NOT selfApprover, so he can't approve this shit

<span class="nc" id="L306">			request.setAttribute(&quot;message&quot;, prop.getText(&quot;approveAction.err.cantApprove&quot;));</span>
<span class="nc" id="L307">			return false;</span>
		}
	}

	/**
	 * Approve delete action of webpage, in other word's approve/reject delete change (aka waiting docHistory).
	 * !! request param &quot;zamietni&quot; indicates, if we approve action (webpage gonna be deleted) or reject action (no change to webpage)
	 * After approve/reject, the waiting docHistory will be removed from waiting list (awaitingApprove param is set as empty string).
	 * @param docHistoryRepo
	 * @param docDetailsRepo
	 * @param editorService
	 * @return retunr link to error or success page
	 */
	public boolean approveDelAction(DocHistoryRepository docHistoryRepo, DocDetailsRepository docDetailsRepo, EditorService editorService) {


		//Get and check historyId, MUST by set
<span class="nc" id="L324">		int historyId = Tools.getIntValue(request.getParameter(&quot;historyid&quot;), -1);</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">		if(historyId == -1) {</span>
<span class="nc" id="L326">			request.setAttribute(&quot;message&quot;, &quot;History ID cant be empty&quot;);</span>
<span class="nc" id="L327">			return false;</span>
		}

		//Check DocHistory for set historyId
<span class="nc" id="L331">		Optional&lt;DocHistory&gt; docHistoryOpt = docHistoryRepo.findById(Long.valueOf(historyId));</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">		if(!docHistoryOpt.isPresent()) {</span>
<span class="nc" id="L333">			request.setAttribute(&quot;message&quot;, &quot;History record by givven historyId not found&quot;);</span>
<span class="nc" id="L334">			return false;</span>
		}
<span class="nc" id="L336">		DocHistory docHistory = docHistoryOpt.get();</span>

		//Load approve tables, this step will show us if current user can approve/reject docHistory uppon certain docDetails
<span class="nc" id="L339">		loadApproveTables(docHistory.getGroupId());</span>

		//Reject DELETE action
<span class="nc bnc" id="L342" title="All 2 branches missed.">		if (request.getParameter(&quot;zamietni&quot;) != null) {</span>

<span class="nc bnc" id="L344" title="All 4 branches missed.">			if(!needApprove() || selfApproved) {</span>

				//Set page as available, only in case that the are NO other delete request's

<span class="nc" id="L348">				docDetailsRepo.updateAvailableStatus(true, docHistory.getDocId());</span>

				//vymaz z historie
<span class="nc" id="L351">				docHistoryRepo.deleteById(Long.valueOf(historyId));</span>

				//Send mails
<span class="nc" id="L354">				sendWebpageApproveDelNotification(false, docHistory);</span>

				//SET this as Reject SUCCESS indicator
<span class="nc" id="L357">				request.setAttribute(&quot;rejected&quot;, &quot;true&quot;);</span>

<span class="nc" id="L359">				return true;</span>
			} else {
				//DOC need's approve BUT current user is NOT selfApprover, so he can't approve this shit

<span class="nc" id="L363">				request.setAttribute(&quot;message&quot;, prop.getText(&quot;approveAction.err.cantApprove&quot;));</span>
<span class="nc" id="L364">				return false;</span>
			}
		} else {
			//Approve DELETE action

<span class="nc bnc" id="L369" title="All 2 branches missed.">			if (needApproveLevel2()) {</span>
<span class="nc" id="L370">				String level2approvers = &quot;,&quot; + getApproveUserIds() + &quot;,&quot;;</span>
				//if approvers are not level2 update hitory to level2 approvers and send notifications
<span class="nc bnc" id="L372" title="All 2 branches missed.">				if (level2approvers.equals(docHistory.getAwaitingApprove())==false) {</span>
					//aktualizuj ID schvalovatela
<span class="nc" id="L374">					docHistory.setAwaitingApprove(level2approvers);</span>
<span class="nc" id="L375">					docHistoryRepo.save(docHistory);</span>

<span class="nc" id="L377">					Identity user = UsersDB.getCurrentUser(request);</span>

					//posli mail schvalovatelovi level2
<span class="nc" id="L380">					String notes = request.getParameter(&quot;notes&quot;);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">					if (Tools.isEmpty(notes)) notes = prop.getText(&quot;components.reservation.reservation_list.accept&quot;);</span>
<span class="nc" id="L382">					notes = prop.getText(&quot;approve.page.approvedToNextLevel.comment&quot;, user.getFullName(), notes);</span>

<span class="nc" id="L384">					String approverNames = getApproveUserNames();</span>

<span class="nc" id="L386">					sendWebpageApproveDelRequestEmail(docHistory, historyId, historyId);</span>
<span class="nc" id="L387">					request.setAttribute(&quot;approvedToNextLevel&quot;, prop.getText(&quot;approve.page.approvedToNextLevel&quot;, approverNames));</span>

					//posli info email autorovi
<span class="nc" id="L390">					String subject = prop.getText(&quot;approve.delete.subject&quot;) + &quot; &quot; + docHistory.getTitle();</span>

<span class="nc" id="L392">					String url = Tools.getBaseHref(request) + &quot;/showdoc.do?docid=&quot;+docHistory.getDocId()+&quot;&amp;historyid=&quot; + historyId;</span>

<span class="nc" id="L394">					StringBuilder message = new StringBuilder(prop.getText(&quot;approve.page.approvedToNextLevel.editorText&quot;, docHistory.getTitle(), approverNames)).append(&quot;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L395">					message.append(prop.getText(&quot;approve.dir&quot;)).append(&quot;: &quot;).append(groupsDB.getGroupNamePath(docHistory.getGroupId())).append(&quot;&lt;br&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L396">					message.append(prop.getText(&quot;approve.url&quot;)).append(&quot;:&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L397">					message.append(&quot;&lt;a href='&quot;).append(url).append(&quot;'&gt;&quot;).append(url).append(&quot;&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L398">					message.append(notes).append(&quot;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L399">					UserDetails author = UsersDB.getUserCached(docHistory.getAuthorId());</span>
<span class="nc bnc" id="L400" title="All 4 branches missed.">					if (author != null &amp;&amp; Tools.isEmail(author.getEmail())) {</span>
<span class="nc" id="L401">						SendMail.send(user.getFullName(), user.getEmail(), author.getEmail(), subject, message.toString(), request);</span>
					}

<span class="nc" id="L404">					return true;</span>
				}
			}

			//Perrmisions and approves are tested inside customDeleteWebpage
<span class="nc" id="L409">			String result = editorService.deleteWebpageLogic(docHistory.getDocId(), this, true);</span>

<span class="nc bnc" id="L411" title="All 2 branches missed.">			if(&quot;success&quot;.equals(result)) {</span>
				//SET this as Approve SUCCESS indicator
<span class="nc" id="L413">				request.setAttribute(&quot;approved&quot;, &quot;approved&quot;);</span>

				//Send mails
<span class="nc" id="L416">				sendWebpageApproveDelNotification(true, docHistory);</span>
			} else
				//SET this as Approve FAIL indicator
<span class="nc" id="L419">				request.setAttribute(&quot;approveFail&quot;, &quot;approveFail&quot;);</span>

<span class="nc" id="L421">			return true;</span>
		}
	}

	/* SUPPORT METHODS */

	/**
	 * Return true, if webpage need's approve (approveByTable isn't empty).
	 * @return
	 */
    public boolean needApprove() {
<span class="pc bpc" id="L432" title="1 of 4 branches missed.">        return approveByTable != null &amp;&amp; approveByTable.isEmpty() == false;</span>
    }

	public boolean needApproveLevel2() {
<span class="nc bnc" id="L436" title="All 4 branches missed.">        return approveByTableLevel2 != null &amp;&amp; approveByTableLevel2.isEmpty() == false;</span>
    }

	/**
	 *
	 * @return
	 */
	public boolean needNotification() {
<span class="pc bpc" id="L444" title="2 of 4 branches missed.">		return notifyTable != null &amp;&amp; notifyTable.isEmpty() == false;</span>
	}

	/**
	 * If approving is needed, return list of approvers.
	 * !! If action is selfApproved, there are no set approvers.
	 * @return
	*/
	public List&lt;UserDetails&gt; getApprovers() {
<span class="fc" id="L453">		return new ArrayList&lt;&gt;(approveByTable.values());</span>
	}

	/**
	 * Vrati ciarkou oddeleny zoznam ID pouzivatelov, ktory schvaluju web stranku
	 * @return
	 */
    public String getApproveUserIds() {
<span class="fc" id="L461">        StringBuilder approveByUsersId = new StringBuilder(&quot;,&quot;);</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">        for (UserDetails approveUser : approveByTable.values())</span>
<span class="fc" id="L463">            approveByUsersId.append(approveUser.getUserId()).append(',');</span>

<span class="fc" id="L465">        return approveByUsersId.toString();</span>
    }

	/**
	 *
	 * @return
	 */
	private String getApproveUserEmails() {
<span class="fc" id="L473">		StringBuilder approveEmails = new StringBuilder();</span>
<span class="fc bfc" id="L474" title="All 2 branches covered.">		for (UserDetails approveUser : approveByTable.values()) {</span>
<span class="pc bpc" id="L475" title="1 of 2 branches missed.">			if(Tools.isEmail(approveUser.getEmail())) {</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">				if(approveEmails.length() &gt; 0) approveEmails.append(&quot;,&quot;);</span>
<span class="fc" id="L477">				approveEmails.append(approveUser.getEmail());</span>
			}
<span class="fc" id="L479">		}</span>

<span class="fc" id="L481">		return approveEmails.toString();</span>
	}

	public String getApproveUserNames() {
<span class="nc" id="L485">		StringBuilder approveEmails = new StringBuilder();</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">		for (UserDetails approveUser : approveByTable.values()) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">			if(approveEmails.length() &gt; 0) approveEmails.append(&quot;,&quot;);</span>
<span class="nc" id="L488">			approveEmails.append(approveUser.getFullName());</span>
<span class="nc" id="L489">		}</span>

<span class="nc" id="L491">		return approveEmails.toString();</span>
	}


	public String getEmailsToNotify(String authorEmail) {
<span class="fc" id="L496">		StringBuilder notifyEmails = new StringBuilder();</span>

<span class="fc bfc" id="L498" title="All 2 branches covered.">		for (UserDetails approveUser : notifyTable.values()) {</span>
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">			if(Tools.isEmail(approveUser.getEmail())) {</span>
				//There is no need send notify to approver, who approve action (hi did it)
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">				if(currentUser.getUserId() == approveUser.getUserId()) continue;</span>
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">				if(notifyEmails.length() &gt; 0) notifyEmails.append(&quot;,&quot;);</span>
<span class="fc" id="L503">				notifyEmails.append(approveUser.getEmail());</span>
			}
<span class="fc" id="L505">		}</span>

		//Add author email
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">		if (Tools.isEmail(authorEmail)) {</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">			if(notifyEmails.length() &gt; 0) notifyEmails.append(&quot;,&quot;);</span>
<span class="nc" id="L510">			notifyEmails.append(authorEmail);</span>
		}

<span class="fc" id="L513">		return notifyEmails.toString();</span>
	}

	/**
	 * Odoslanie emailov o schvalovani alebo notifikacii o zmene (ak je zoznam schvalovani prazdny)
	 * @param editedDoc
	 * @param historyId
	 */
    public void sendEmails(DocDetails editedDoc, int historyId) {
        //Posielanie ziadosti o schvaleni web stranky
<span class="pc bpc" id="L523" title="1 of 4 branches missed.">		if (approveByTable != null &amp;&amp; approveByTable.size() &gt; 0) {</span>
			//Posielanie ziadosti o schvaleni web stranky
<span class="fc" id="L525">			sendWebpageApproveRequestEmail(editedDoc, historyId, currentUser.getUserId(), null);</span>
<span class="pc bpc" id="L526" title="1 of 4 branches missed.">		} else if (notifyTable != null &amp;&amp; notifyTable.size() &gt; 0) {</span>
			//Posielanie notifikacii o zmene vo web stranke, neposiela sa, ak sa stranka musi schvalit, preto v else podmienke
<span class="fc" id="L528">			sendWebpageChangeNotification(editedDoc);</span>
		}
<span class="fc" id="L530">    }</span>

	/* Request email */

	/**
	 * Odosle email schvalovatelom web stranky s odkazom na schvalenie/zamietnutie stranky
	 * @param editedDoc
	 * @param historyId
	 * @param senderUserId
	 * @param comment
	 */
    public void sendWebpageApproveRequestEmail(DocBasic editedDoc, int historyId, int senderUserId, String comment) {

<span class="pc bpc" id="L543" title="2 of 4 branches missed.">        if (approveByTable == null || approveByTable.isEmpty()) return;</span>

<span class="fc" id="L545">		String title = null;</span>
<span class="fc" id="L546">		int docId = -1;</span>
<span class="fc" id="L547">		int groupId = -1;</span>

<span class="pc bpc" id="L549" title="1 of 2 branches missed.">		if(editedDoc != null) {</span>
<span class="fc" id="L550">			title = editedDoc.getTitle();</span>
<span class="fc" id="L551">			docId = editedDoc.getDocId();</span>
<span class="fc" id="L552">			groupId = editedDoc.getGroupId();</span>
		}

<span class="pc bpc" id="L555" title="3 of 6 branches missed.">		if (title == null || docId &lt; 0 || groupId &lt; 0) return;</span>

<span class="fc" id="L557">		UserDetails senderUser = UsersDB.getUser(senderUserId);</span>
<span class="pc bpc" id="L558" title="1 of 2 branches missed.">		if(senderUser == null) return;</span>

<span class="fc" id="L560">		String url = Tools.getBaseHref(request) + &quot;/admin/approve.jsp?docid=&quot;+docId+&quot;&amp;historyid=&quot; + historyId;</span>

<span class="fc" id="L562">		StringBuilder message = new StringBuilder(&quot;&lt;strong&gt;&quot;).append(prop.getText(&quot;approve.ask&quot;)).append(&quot;:&lt;/strong&gt;&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L563">		message.append(&quot;&lt;strong&gt;&quot;).append(title).append(&quot;&lt;/strong&gt;&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L564">		message.append(prop.getText(&quot;approve.dir&quot;)).append(&quot;:&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L565">		message.append(groupsDB.getPath(groupId)).append(&quot;&lt;br&gt;&lt;br&gt;\n\n&quot;);</span>
<span class="fc" id="L566">		message.append(prop.getText(&quot;approve.url&quot;)).append(&quot;:&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L567">		message.append(&quot;&lt;a href='&quot;).append(url).append(&quot;'&gt;&quot;).append(url).append(&quot;&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n\n&quot;);</span>

<span class="pc bpc" id="L569" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(comment)) { message.append(comment).append(&quot;&lt;br&gt;&lt;br&gt;\n\n&quot;); }</span>

<span class="fc" id="L571">		message.append(senderUser.getFullName()).append(&quot; &amp;lt;&quot;).append(senderUser.getEmail()).append(&quot;&amp;gt;&quot;);</span>

<span class="fc" id="L573">		String subject = prop.getText(&quot;approve.subject&quot;) + &quot;: &quot; + title;</span>
<span class="fc" id="L574">		SendMail.send(senderUser.getFullName(), senderUser.getEmail(), getApproveUserEmails(), subject, message.toString(), request);</span>

<span class="fc" id="L576">		auditApproveRequestEmail(editedDoc, historyId);</span>
<span class="fc" id="L577">	}</span>

	/**
	 * Zapise audit odoslaneho emailu pre ziadost o schvalenie
	 * @param editedHistory
	 * @param historyId
	 * @param approveByTable
	 */
	private void auditApproveRequestEmail(DocBasic editedDoc, int historyId) {
		//start- navrh na zmenu logovania v CMS (#19820)
<span class="fc" id="L587">		StringBuilder approveByUsersEmail = new StringBuilder();</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">		for (UserDetails u : approveByTable.values()) {</span>
<span class="pc bpc" id="L589" title="1 of 2 branches missed.">			if (Tools.isEmail(u.getEmail())) {</span>
<span class="fc bfc" id="L590" title="All 2 branches covered.">				if (approveByUsersEmail.length()&gt;0) approveByUsersEmail.append(&quot;,&quot;);</span>
<span class="fc" id="L591">				approveByUsersEmail.append(u.getEmail());</span>
			}
<span class="fc" id="L593">		}</span>

		//Popis pre adminLog prerobený cez StringBuilder kvôli lepšej prehľadnosti + ľahšia úprava
<span class="fc" id="L596">		StringBuilder adminLogSB = new StringBuilder();</span>
<span class="fc" id="L597">		adminLogSB.append(&quot;Poziadane o schvalenie stranky &quot;);</span>
<span class="fc" id="L598">		adminLogSB.append(editedDoc.getTitle() + &quot; / &quot; + editedDoc.getDocId() + &quot; / &quot; + historyId);</span>
<span class="fc" id="L599">		adminLogSB.append(&quot;, ziadost zaslana na emaili: &quot; + approveByUsersEmail.toString());</span>
<span class="fc" id="L600">		Adminlog.add(Adminlog.TYPE_SAVEDOC, adminLogSB.toString(), editedDoc.getDocId(), historyId);</span>
		//koniec- navrh na zmenu logovania v CMS (#19820)
<span class="fc" id="L602">	}</span>

	public void sendWebpageApproveDelRequestEmail(DocBasic editedDoc, int historyId, int actualPublishedHistoryId) {
<span class="fc" id="L605">		String title = editedDoc.getTitle();</span>
<span class="fc" id="L606">		title = Tools.replace(title, &quot;[DELETE] &quot;, &quot;&quot;);</span>
<span class="fc" id="L607">		String navbar = GroupsDB.getInstance().getNavbar(editedDoc.getGroupId());</span>
<span class="fc" id="L608">		int docId = editedDoc.getDocId();</span>

<span class="pc bpc" id="L610" title="1 of 2 branches missed.">		if (actualPublishedHistoryId == 0) actualPublishedHistoryId = historyId;</span>
<span class="fc" id="L611">		String url = Tools.getBaseHref(request) + &quot;/admin/approve_delete.jsp?historyid=&quot; + historyId + &quot;&amp;docid=&quot; + docId + &quot;&amp;lasthid=&quot; + actualPublishedHistoryId;</span>

<span class="fc" id="L613">        StringBuilder message = new StringBuilder(&quot;&lt;b&gt;&quot;).append(prop.getText(&quot;approve.delete.ask&quot;)).append(&quot;:&lt;/b&gt;&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L614">        message.append(title).append(&quot;&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L615">        message.append(prop.getText(&quot;approve.dir&quot;)).append(&quot;:&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L616">        message.append(navbar).append(&quot;&lt;br&gt;&lt;br&gt;\n\n&quot;);</span>
<span class="fc" id="L617">        message.append(prop.getText(&quot;approve.url&quot;)).append(&quot;:&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L618">        message.append(&quot;&lt;a href='&quot;).append(url).append(&quot;'&gt;&quot;).append(url).append(&quot;&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n\n&quot;);</span>
<span class="fc" id="L619">        message.append(currentUser.getFullName()).append(&quot; &amp;lt;&quot;).append(currentUser.getEmail()).append(&quot;&amp;gt;&quot;);</span>

<span class="fc" id="L621">        String subject = prop.getText(&quot;approve.delete.subject&quot;) + &quot;: &quot; + title;</span>

<span class="fc" id="L623">        SendMail.send(currentUser.getFullName(), currentUser.getEmail(), getApproveUserEmails(), subject, message.toString(), request);</span>
<span class="fc" id="L624">	}</span>

	/* Notification emails */

	/**
	 * Send email with notification about web page change to all notify users
	 * @param editedHistory
	 */
	private void sendWebpageChangeNotification(DocDetails editedHistory) {
		//If there is no one to notify, return
<span class="pc bpc" id="L634" title="1 of 2 branches missed.">		if(!needNotification()) return;</span>

<span class="fc" id="L636">		String url = docDB.getDocLink(editedHistory.getDocId(), null, true, request);</span>
<span class="fc" id="L637">		StringBuilder message = new StringBuilder(&quot;&lt;strong&gt;&quot;).append(prop.getText(&quot;doc.notify.intro&quot;)).append(&quot;:&lt;/strong&gt;&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L638">		message.append(&quot;&lt;strong&gt;&quot;).append( editedHistory.getTitle() ).append(&quot;&lt;/strong&gt;&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L639">		message.append(prop.getText(&quot;doc.notify.dir&quot;)).append(&quot;:&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L640">		message.append(groupsDB.getPath(editedHistory.getGroupId())).append(&quot;&lt;br&gt;&lt;br&gt;\n\n&quot;);</span>
<span class="fc" id="L641">		message.append(prop.getText(&quot;doc.notify.url&quot;)).append(&quot;:&lt;br&gt;\n&quot;);</span>
<span class="fc" id="L642">		message.append(&quot;&lt;a href='&quot;+url+&quot;'&gt;&quot;).append(url).append(&quot;&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n\n&quot;);</span>
<span class="fc" id="L643">		message.append(currentUser.getFullName()).append(&quot; &amp;lt;&quot;).append(currentUser.getEmail()).append(&quot;&amp;gt;&quot;);</span>
<span class="fc" id="L644">		String subject = prop.getText(&quot;doc.notify.subject&quot;) + &quot;: &quot; + editedHistory.getTitle();</span>
<span class="fc" id="L645">		SendMail.send(currentUser.getFullName(), currentUser.getEmail(), getEmailsToNotify(null), subject, message.toString(), request);</span>
<span class="fc" id="L646">	}</span>

	/**
	 * Send email with notification about status (Approved / Reject) of requestet web page change to all notify users + author of change
	 * @param isApproved - true change was Approved, else Rejected
	 * @param docHistory - change represented by docHistory entity that was approved/rejected
	 */
	private void sendWebpageApproveNotification(boolean isApproved, DocHistory docHistory) {
		//If there is no one to notify, return
<span class="nc bnc" id="L655" title="All 2 branches missed.">		if(!needNotification()) return;</span>

<span class="nc bnc" id="L657" title="All 2 branches missed.">		if(isApproved) {</span>
			//DocHistory Create/Edit action - APPROVED

<span class="nc" id="L660">			String url = Tools.getBaseHref(request) + &quot;/showdoc.do?docid=&quot; + docHistory.getDocId();</span>
<span class="nc" id="L661">			StringBuilder message = new StringBuilder(&quot;&lt;b&gt;&quot;).append(prop.getText(&quot;approve.ok.webPage&quot;)).append(&quot;:&lt;/b&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L662">			message.append( docHistory.getTitle() ).append( &quot;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L663">			message.append(prop.getText(&quot;approve.dir&quot;)).append(&quot;: &quot;).append( groupsDB.getGroupNamePath(docHistory.getGroupId()) ).append( &quot;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L664">			message.append(&quot;&lt;font color='green'&gt;&quot;).append(prop.getText(&quot;approve.ok&quot;)).append(&quot;&lt;/font&gt;&lt;br&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L665">			message.append(prop.getText(&quot;approve.url&quot;)).append( &quot;:&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L666">			message.append(&quot;&lt;a href='&quot;).append(url).append(&quot;'&gt;&quot;).append(url).append(&quot;&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n\n&quot;);</span>
<span class="nc" id="L667">			message.append(&quot;&lt;b&gt;&quot;).append(prop.getText(&quot;approve.reject.notes&quot;) ).append( &quot;:&lt;/b&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L668">			message.append( Tools.getStringValue(request.getParameter(&quot;notes&quot;), &quot;&quot;) );</span>
<span class="nc" id="L669">			String subject = prop.getText(&quot;approve.ok.subject&quot;) + &quot;: &quot; + docHistory.getTitle();</span>
<span class="nc" id="L670">			SendMail.send(currentUser.getFullName(), currentUser.getEmail(), getEmailsToNotify(docHistory.getUserDetails().getEmail()), subject, message.toString(), request);</span>
<span class="nc" id="L671">		} else {</span>
			//DocHistory Create/Edit action - REJECTED

<span class="nc" id="L674">			String url = Tools.getBaseHref(request) + &quot;/showdoc.do?docid=&quot; + docHistory.getDocId() + &quot;&amp;historyid=&quot; + docHistory.getHistoryId();</span>
<span class="nc" id="L675">			StringBuilder message = new StringBuilder(&quot;&lt;font color='red'&gt;&quot;).append(prop.getText(&quot;approve.reject&quot;)).append(&quot;:&lt;/font&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L676">			message.append( docHistory.getTitle() ).append( &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L677">			message.append(prop.getText(&quot;approve.dir&quot;)).append(&quot;: &quot; ).append( groupsDB.getGroupNamePath(docHistory.getGroupId()) ).append( &quot;&lt;br&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L678">			message.append(prop.getText(&quot;approve.url&quot;) ).append( &quot;:&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L679">			message.append(&quot;&lt;a href='&quot;).append(url).append(&quot;'&gt;&quot; ).append( url ).append( &quot;&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L680">			message.append(&quot;&lt;b&gt;&quot;).append(prop.getText(&quot;approve.reject.notes&quot;) ).append( &quot;:&lt;/b&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L681">			message.append( Tools.getStringValue(request.getParameter(&quot;notes&quot;), &quot;&quot;) );</span>
<span class="nc" id="L682">			String subject = prop.getText(&quot;approve.reject.subject&quot;) + &quot;: &quot; + docHistory.getTitle();</span>
<span class="nc" id="L683">			SendMail.send(currentUser.getFullName(), currentUser.getEmail(), getEmailsToNotify(docHistory.getUserDetails().getEmail()), subject, message.toString(), request);</span>
		}
<span class="nc" id="L685">	}</span>

	/**
	 * Send email with notification about status (Approved / Reject) of requested web page delete to all notify users + author of change
	 * @param isApproved
	 * @param docHistory
	 */
	private void sendWebpageApproveDelNotification(boolean isApproved, DocHistory docHistory) {
		//If there is no one to notify, return
<span class="nc bnc" id="L694" title="All 2 branches missed.">		if(!needNotification()) return;</span>

		StringBuilder message;
		String subject;
<span class="nc" id="L698">		String url = Tools.getBaseHref(request) + &quot;/showdoc.do?docid=&quot; + docHistory.getDocId();</span>

<span class="nc bnc" id="L700" title="All 2 branches missed.">		if(isApproved) {</span>
			//DocHistory Delete action - APPROVED
<span class="nc" id="L702">			message = new StringBuilder(&quot;&lt;font color='green'&gt;&quot;).append(prop.getText(&quot;approve.del.approved&quot;) ).append( &quot;:&lt;/font&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L703">			subject = prop.getText(&quot;approve.del.approve.subject&quot;) + &quot;: &quot; + docHistory.getTitle();</span>
		} else {
			//DocHistory Delete action - REJECT
<span class="nc" id="L706">			message = new StringBuilder(&quot;&lt;font color='red'&gt;&quot;).append(prop.getText(&quot;approve.del.reject&quot;) ).append( &quot;:&lt;/font&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L707">			subject = prop.getText(&quot;approve.del.reject.subject&quot;) + &quot;: &quot; + docHistory.getTitle();</span>
		}

<span class="nc" id="L710">		message.append( docHistory.getTitle() ).append( &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L711">		message.append(prop.getText(&quot;approve.dir&quot;)).append(&quot;: &quot; ).append( groupsDB.getGroupNamePath(docHistory.getGroupId()) ).append( &quot;&lt;br&gt;&lt;br&gt;\n&quot;);</span>

<span class="nc bnc" id="L713" title="All 2 branches missed.">		if(!isApproved) {</span>
<span class="nc" id="L714">			message.append(prop.getText(&quot;approve.url&quot;) ).append( &quot;:&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L715">			message.append(&quot;&lt;a href='&quot;).append(url).append(&quot;'&gt;&quot; ).append( url ).append( &quot;&lt;/a&gt;&lt;br&gt;&lt;br&gt;\n&quot;);</span>
		}

<span class="nc" id="L718">		message.append(&quot;&lt;b&gt;&quot;).append(prop.getText(&quot;approve.reject.notes&quot;) ).append( &quot;:&lt;/b&gt;&lt;br&gt;\n&quot;);</span>
<span class="nc" id="L719">		message.append( Tools.getStringValue(request.getParameter(&quot;notes&quot;), &quot;&quot;) );</span>
<span class="nc" id="L720">		SendMail.send(currentUser.getFullName(), currentUser.getEmail(), getEmailsToNotify(docHistory.getUserDetails().getEmail()), subject, message.toString(), request);</span>
<span class="nc" id="L721">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>