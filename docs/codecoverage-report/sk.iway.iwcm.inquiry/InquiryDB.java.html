<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InquiryDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.inquiry</a> &gt; <span class="el_source">InquiryDB.java</span></div><h1>InquiryDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.inquiry;

import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.sql.Types;
import java.text.DecimalFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.Random;
import java.util.StringTokenizer;

import javax.servlet.ServletException;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;

import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Cache;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.LabelValueDetails;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.SpamProtection;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.components.inquiry.jpa.InquiryUsersVoteEntity;
import sk.iway.iwcm.components.inquiry.rest.InquiryStatService;
import sk.iway.iwcm.database.ComplexQuery;
import sk.iway.iwcm.database.Mapper;
import sk.iway.iwcm.helpers.BeanDiff;
import sk.iway.iwcm.helpers.BeanDiffPrinter;
import sk.iway.iwcm.system.spring.SpringUrlMapping;
import sk.iway.iwcm.users.SettingsAdminDB;
import sk.iway.iwcm.users.UsersDB;

/**
 * InquiryDB.java - praca s anketami
 *
 *@Title        webjet
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2004
 *@author       $Author: bistak $
 *@version      $Revision: 1.2 $
 *@created      Date: 9.4.2003 10:35:10
 *@modified     $Date: 2004/08/09 08:42:03 $
 */
public class InquiryDB
{
	public static final String ORDER_BY_ANSWER_TEXT = &quot;ia.answer_text&quot;;
	public static final String ORDER_BY_ANSWER_CLICKS = &quot;ia.answer_clicks&quot;;
	public static final String ORDER_BY_ANSWER_ID = &quot;ia.answer_id&quot;;
<span class="fc" id="L62">	private static Random random = new Random();</span>

<span class="nc" id="L64">	protected InquiryDB() {</span>
		//utility class
<span class="nc" id="L66">	}</span>

	public static InquiryBean getLastInquiry(int imagesLength, String percentageFormat, HttpServletRequest request)
	{
<span class="nc" id="L70">		return (getInquiry(-1, imagesLength, percentageFormat, ORDER_BY_ANSWER_TEXT, true, request));</span>
	}

	public static InquiryBean getLastInquiry(HttpServletRequest request)
	{
<span class="nc" id="L75">		return (getInquiry(-1, 10, null, ORDER_BY_ANSWER_ID, true, request));</span>
	}

	/**
	 * Vrati zoznam ID ankiet zodpovedajucich danym skupinam.
	 *
	 * @param groupNames
	 * @param request
	 * @param all         true = vsetky ankety, false = iba najnovsia
	 * @return
	 */
	public static List&lt;Integer&gt; getInquiryIds(String groupNames, HttpServletRequest request, boolean all)
	{
<span class="fc" id="L88">		List&lt;String&gt; groups = Arrays.asList(DB.removeSlashes(groupNames).split(&quot;,\\|\\+&quot;));</span>
<span class="fc" id="L89">		List&lt;String&gt; groupsSQL = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">		for (String group : groups)</span>
		{
<span class="fc" id="L92">			groupsSQL.add(&quot;'&quot; + group + &quot;'&quot;);</span>
<span class="fc" id="L93">		}</span>

<span class="fc bfc" id="L95" title="All 2 branches covered.">		String sql = &quot;SELECT &quot; + (all ? &quot;question_id&quot; : &quot;max(question_id)&quot;) + &quot; AS id FROM inquiry &quot; +</span>
<span class="fc" id="L96">			&quot;WHERE question_group IN (&quot; + StringUtils.join(groupsSQL.toArray(), &quot;, &quot;) + &quot;) &quot; +</span>
<span class="fc" id="L97">			&quot;AND (date_from &lt; ? OR date_from IS NULL) AND (date_to &gt; ? OR date_to IS NULL) AND question_active = &quot;+DB.getBooleanSql(true)+&quot; &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="fc" id="L98">		List&lt;Integer&gt; ids = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L100">		Connection db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">		if (null == db_conn) return ids;</span>
		try
		{
			try
			{
<span class="fc" id="L106">				PreparedStatement ps = db_conn.prepareStatement(sql);</span>
				try
				{
<span class="fc" id="L109">					ps.setTimestamp(1, new Timestamp(Tools.getNow()));</span>
<span class="fc" id="L110">					ps.setTimestamp(2, new Timestamp(Tools.getNow()));</span>
<span class="fc" id="L111">					ResultSet rs = ps.executeQuery();</span>
					try
					{
<span class="fc bfc" id="L114" title="All 2 branches covered.">						while (rs.next())</span>
						{
<span class="fc" id="L116">							ids.add(Integer.valueOf(rs.getInt(&quot;id&quot;)));</span>
						}
<span class="fc" id="L118">						return ids;</span>
<span class="fc" id="L119">					} finally { rs.close(); }</span>
<span class="fc" id="L120">				} finally { ps.close(); }</span>
<span class="fc" id="L121">			} finally { db_conn.close(); }</span>
		}
<span class="nc" id="L123">		catch (SQLException ex)</span>
		{
<span class="nc" id="L125">			return ids;</span>
		}
	}

	/**
	 * vrati poslednu anketu zo zadanej skupiny
	 *
	 * @param groupName -
	 *           nazov skupiny ankiet
	 * @param imagesLength -
	 *           pocet generovanych obrazkov v stlpiku
	 * @param percentageFormat -
	 *           format vypisu percent
	 * @param orderBy -
	 *           SQL sposob usporiadania odpovedi
	 * @param ascending -
	 *           true ak je vzostupne usporiadanie
	 * @param request
	 * @param random - boolean hodnota, ci sa ma vybrat nahodna anketa alebo najnovsia
	 * @return
	 */
	public static InquiryBean getInquiry(String groupNames, int imagesLength, String percentageFormat, String orderBy,
				boolean ascending, HttpServletRequest request, boolean random)
	{
<span class="fc" id="L149">		List&lt;Integer&gt; questionIds = getInquiryIds(groupNames, request, random);</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">		if (questionIds.isEmpty()) return null;</span>
<span class="fc" id="L151">		int questionId = questionIds.get(InquiryDB.random.nextInt(questionIds.size())).intValue();</span>
<span class="fc" id="L152">		return (getInquiry(questionId, imagesLength, percentageFormat, orderBy, ascending, request));</span>
	}

	/**
	 * Vrati anketu so zadanym id, urcene do JSP stranok s designom
	 *
	 * @param questionId -
	 *           id anketu
	 * @param imagesLength -
	 *           pocet generovanych obrazkov v stlpiku
	 * @param percentageFormat -
	 *           format vypisu percent
	 * @param orderBy -
	 *           SQL sposob usporiadania odpovedi
	 * @param ascending -
	 *           true ak je vzostupne usporiadanie
	 * @param request
	 * @return
	 */
	public static InquiryBean getInquiry(int questionId, int imagesLength, String percentageFormat, String orderBy,
				boolean ascending, HttpServletRequest request)
	{
<span class="fc" id="L174">		InquiryBean inquiryBean = new InquiryBean();</span>
<span class="fc" id="L175">		String cookieName = &quot;inquiry-&quot; + questionId;</span>
<span class="fc" id="L176">		Cookie[] cookies = request.getCookies();</span>
<span class="fc" id="L177">		int len = 0;</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">		if (cookies != null) {</span>
<span class="fc" id="L179">			len = cookies.length;</span>
			int i;
			Cookie cookie;
<span class="fc bfc" id="L182" title="All 2 branches covered.">			for (i = 0; i &lt; len; i++)</span>
			{
<span class="fc" id="L184">				cookie = cookies[i];</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">				if (cookie.getName().compareTo(cookieName) == 0)</span>
				{
<span class="fc" id="L187">					inquiryBean.setCanAnswer(&quot;no&quot;);</span>
				}
			}
		}
<span class="fc" id="L191">		List&lt;AnswerForm&gt; answers = new ArrayList&lt;&gt;();</span>
		AnswerForm answerForm;

<span class="fc" id="L194">		Connection db_conn = null;</span>
<span class="fc" id="L195">		PreparedStatement ps = null;</span>
<span class="fc" id="L196">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L199">			String orderType = &quot;DESC&quot;;</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">			if (ascending)	orderType = &quot;ASC&quot;;</span>
			//keby nieco...
<span class="fc" id="L202">			orderBy = orderBy.replace('\'', ' ');</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">			if (orderBy.indexOf('.') == -1)</span>
			{
<span class="fc" id="L205">				orderBy = &quot;ia.&quot; + orderBy;</span>
			}
<span class="fc" id="L207">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">			if (questionId == -1)</span>
			{
<span class="nc" id="L210">				ps = db_conn.prepareStatement(&quot;SELECT i.*, ia.* FROM inquiry i, inquiry_answers ia WHERE i.question_id=ia.question_id  &quot;+CloudToolsForCore.getDomainIdSqlWhere(true, &quot;ia&quot;)+&quot; ORDER BY i.question_id DESC, &quot;</span>
										+ orderBy + &quot; &quot; + orderType);
			}
			else
			{
<span class="fc" id="L215">				ps = db_conn.prepareStatement(&quot;SELECT i.*, ia.* FROM inquiry i, inquiry_answers ia WHERE i.question_id=ia.question_id AND i.question_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true, &quot;ia&quot;)+&quot; ORDER BY &quot;</span>
										+ orderBy + &quot; &quot; + orderType);
<span class="fc" id="L217">				ps.setInt(1, questionId);</span>
			}
<span class="fc" id="L219">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L222">				answerForm = new AnswerForm();</span>
<span class="fc" id="L223">				answerForm.setQuestionID(rs.getInt(&quot;question_id&quot;));</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">				if (questionId == -1)</span>
				{
<span class="nc" id="L226">					questionId = answerForm.getQuestionID();</span>
				}
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">				if (questionId != answerForm.getQuestionID())</span>
				{
					//to je koli tomu zisteniu najnovsej ankety, selectnu sa vsetky
					//a ak sa zmenilo questionId voci poslednemu, je to uz ina
					//anketa
<span class="nc" id="L233">					break;</span>
				}
<span class="fc" id="L235">				answerForm.setQuestionString(DB.getDbString(rs, &quot;question_text&quot;));</span>
<span class="fc" id="L236">				answerForm.setAnswerString(DB.getDbString(rs, &quot;answer_text&quot;));</span>
<span class="fc" id="L237">				answerForm.setAnswerID(rs.getInt(&quot;answer_id&quot;));</span>
<span class="fc" id="L238">				answerForm.setAnswerClicks(rs.getInt(&quot;answer_clicks&quot;));</span>
<span class="fc" id="L239">				answerForm.setHours(rs.getInt(&quot;hours&quot;));</span>
<span class="fc" id="L240">				answerForm.setGroup(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="fc" id="L241">				answerForm.setAnswerTextOk(DB.getDbString(rs, &quot;answer_text_ok&quot;));</span>
<span class="fc" id="L242">				answerForm.setAnswerTextFail(DB.getDbString(rs, &quot;answer_text_fail&quot;));</span>
<span class="fc" id="L243">				answerForm.setDateFrom(Tools.formatDate(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="fc" id="L244">				answerForm.setDateFromTime(Tools.formatTime(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="fc" id="L245">				answerForm.setDateTo(Tools.formatDate(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="fc" id="L246">				answerForm.setDateToTime(Tools.formatTime(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="fc" id="L247">				answerForm.setActive(rs.getBoolean(&quot;question_active&quot;));</span>
<span class="fc" id="L248">				answerForm.setTotalClicks(rs.getInt(&quot;total_clicks&quot;));</span>
<span class="fc" id="L249">				answerForm.setImagePath(rs.getString(&quot;image_path&quot;));</span>
<span class="fc" id="L250">				answerForm.setUrl(rs.getString(&quot;url&quot;));</span>
<span class="fc" id="L251">				answers.add(answerForm);</span>
<span class="fc" id="L252">				inquiryBean.setMultiple(rs.getBoolean(&quot;multiple&quot;));</span>
<span class="fc" id="L253">				inquiryBean.setQuestion(answerForm.getQuestionString());</span>
<span class="fc" id="L254">				inquiryBean.setTotalClicksMultiple(rs.getInt(&quot;total_clicks&quot;));</span>
			}
<span class="fc" id="L256">			rs.close();</span>
<span class="fc" id="L257">			ps.close();</span>
<span class="fc" id="L258">			db_conn.close();</span>
<span class="fc" id="L259">			countPercentage(answers, percentageFormat);</span>
<span class="fc" id="L260">			countImages(answers, imagesLength);</span>
<span class="fc" id="L261">			inquiryBean.setAnswers(answers);</span>

<span class="fc" id="L263">			rs = null;</span>
<span class="fc" id="L264">			ps = null;</span>
<span class="fc" id="L265">			db_conn = null;</span>
		}
<span class="nc" id="L267">		catch (Exception ex)</span>
		{
<span class="nc" id="L269">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L276">					rs.close();</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L278">					ps.close();</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L280">					db_conn.close();</span>
			}
<span class="nc" id="L282">			catch (Exception ex2)</span>
			{
<span class="nc" id="L284">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L285">			}</span>
		}

<span class="fc" id="L288">		return (inquiryBean);</span>
	}

	public static List&lt;AnswerForm&gt; getAnswers(int questionID, HttpServletRequest request)
	{
<span class="nc" id="L293">		AnswerForm aForm = null;</span>
<span class="nc" id="L294">		List&lt;AnswerForm&gt; aList = null;</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">		if (questionID &gt; -1)</span>
		{
<span class="nc" id="L297">			aList = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L299">			Connection db_conn = null;</span>
<span class="nc" id="L300">			PreparedStatement ps = null;</span>
<span class="nc" id="L301">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L304">				db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L305">				ps = db_conn</span>
<span class="nc" id="L306">							.prepareStatement(&quot;SELECT i.*, ia.* FROM inquiry i, inquiry_answers ia WHERE i.question_id=ia.question_id AND i.question_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true, &quot;ia&quot;)+&quot; ORDER BY &quot;</span>
										+ ORDER_BY_ANSWER_ID + &quot; ASC&quot;);
<span class="nc" id="L308">				ps.setInt(1, questionID);</span>
<span class="nc" id="L309">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L312">					aForm = new AnswerForm();</span>
<span class="nc" id="L313">					aForm.setAnswerID(rs.getInt(&quot;answer_id&quot;));</span>
<span class="nc" id="L314">					aForm.setQuestionID(rs.getInt(&quot;question_id&quot;));</span>
<span class="nc" id="L315">					aForm.setAnswerString(DB.getDbString(rs, &quot;answer_text&quot;));</span>
<span class="nc" id="L316">					aForm.setQuestionString(DB.getDbString(rs, &quot;question_text&quot;));</span>
<span class="nc" id="L317">					aForm.setAnswerClicks(rs.getInt(&quot;answer_clicks&quot;));</span>
<span class="nc" id="L318">					aForm.setHours(rs.getInt(&quot;hours&quot;));</span>
<span class="nc" id="L319">					aForm.setGroup(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="nc" id="L320">					aForm.setAnswerTextOk(DB.getDbString(rs, &quot;answer_text_ok&quot;));</span>
<span class="nc" id="L321">					aForm.setAnswerTextFail(DB.getDbString(rs, &quot;answer_text_fail&quot;));</span>
<span class="nc" id="L322">					aForm.setDateFrom(Tools.formatDate(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L323">					aForm.setDateFromTime(Tools.formatTime(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L324">					aForm.setDateTo(Tools.formatDate(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L325">					aForm.setDateToTime(Tools.formatTime(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L326">					aForm.setActive(rs.getBoolean(&quot;question_active&quot;));</span>
<span class="nc" id="L327">					aForm.setMultiple(rs.getBoolean(&quot;multiple&quot;));</span>
<span class="nc" id="L328">					aForm.setTotalClicks(rs.getInt(&quot;total_clicks&quot;));</span>
<span class="nc" id="L329">					aForm.setImagePath(rs.getString(&quot;image_path&quot;));</span>
<span class="nc" id="L330">					aForm.setUrl(rs.getString(&quot;url&quot;));</span>
<span class="nc" id="L331">					aList.add(aForm);</span>
				}
<span class="nc" id="L333">				rs.close();</span>
<span class="nc" id="L334">				ps.close();</span>
<span class="nc" id="L335">				db_conn.close();</span>
<span class="nc" id="L336">				countPercentage(aList, null);</span>

<span class="nc" id="L338">				rs = null;</span>
<span class="nc" id="L339">				ps = null;</span>
<span class="nc" id="L340">				db_conn = null;</span>
			}
<span class="nc" id="L342">			catch (Exception ex)</span>
			{
<span class="nc" id="L344">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L350" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L351">						rs.close();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L353">						ps.close();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L355">						db_conn.close();</span>
				}
<span class="nc" id="L357">				catch (Exception ex2)</span>
				{
<span class="nc" id="L359">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L360">				}</span>
			}
		}
<span class="nc" id="L363">		return aList;</span>
	}

	/**
	 * nacita otazky a odpovede do List-u
	 * @param answerID
	 * @param request
	 * @return
	 */
	public static AnswerForm getAnswer(int answerID, HttpServletRequest request)
	{
<span class="nc" id="L374">		AnswerForm aForm = null;</span>

<span class="nc" id="L376">		Connection db_conn = null;</span>
<span class="nc" id="L377">		PreparedStatement ps = null;</span>
<span class="nc" id="L378">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L381">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L382">			ps = db_conn</span>
<span class="nc" id="L383">						.prepareStatement(&quot;SELECT i.*, ia.* FROM inquiry i, inquiry_answers ia WHERE i.question_id=ia.question_id AND ia.answer_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true, &quot;ia&quot;));</span>
<span class="nc" id="L384">			ps.setInt(1, answerID);</span>
<span class="nc" id="L385">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L388">				aForm = new AnswerForm();</span>
<span class="nc" id="L389">				aForm.setAnswerID(rs.getInt(&quot;answer_id&quot;));</span>
<span class="nc" id="L390">				aForm.setQuestionID(rs.getInt(&quot;question_id&quot;));</span>
<span class="nc" id="L391">				aForm.setAnswerString(DB.getDbString(rs, &quot;answer_text&quot;));</span>
<span class="nc" id="L392">				aForm.setQuestionString(DB.getDbString(rs, &quot;question_text&quot;));</span>
<span class="nc" id="L393">				aForm.setAnswerClicks(rs.getInt(&quot;answer_clicks&quot;));</span>
<span class="nc" id="L394">				aForm.setHours(rs.getInt(&quot;hours&quot;));</span>
<span class="nc" id="L395">				aForm.setGroup(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="nc" id="L396">				aForm.setAnswerTextOk(DB.getDbString(rs, &quot;answer_text_ok&quot;));</span>
<span class="nc" id="L397">				aForm.setAnswerTextFail(DB.getDbString(rs, &quot;answer_text_fail&quot;));</span>
<span class="nc" id="L398">				aForm.setDateFrom(Tools.formatDate(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L399">				aForm.setDateFromTime(Tools.formatTime(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L400">				aForm.setDateTo(Tools.formatDate(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L401">				aForm.setDateToTime(Tools.formatTime(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L402">				aForm.setActive(rs.getBoolean(&quot;question_active&quot;));</span>
<span class="nc" id="L403">				aForm.setMultiple(rs.getBoolean(&quot;multiple&quot;));</span>
<span class="nc" id="L404">				aForm.setTotalClicks(rs.getInt(&quot;total_clicks&quot;));</span>
<span class="nc" id="L405">				aForm.setImagePath(rs.getString(&quot;image_path&quot;));</span>
<span class="nc" id="L406">				aForm.setUrl(rs.getString(&quot;url&quot;));</span>

			}
<span class="nc" id="L409">			rs.close();</span>
<span class="nc" id="L410">			ps.close();</span>
<span class="nc" id="L411">			db_conn.close();</span>
<span class="nc" id="L412">			rs = null;</span>
<span class="nc" id="L413">			ps = null;</span>
<span class="nc" id="L414">			db_conn = null;</span>
		}
<span class="nc" id="L416">		catch (Exception ex)</span>
		{
<span class="nc" id="L418">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L424" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L425">					rs.close();</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L427">					ps.close();</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L429">					db_conn.close();</span>
			}
<span class="nc" id="L431">			catch (Exception ex2)</span>
			{
<span class="nc" id="L433">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L434">			}</span>
		}

<span class="nc" id="L437">		return (aForm);</span>
	}

	/**
	 * nacita skupiny ankiet do listu
	 *
	 * @return
	 */
	public static List&lt;LabelValueDetails&gt; getQuestionGroups(HttpServletRequest request)
	{
<span class="fc" id="L447">		List&lt;LabelValueDetails&gt; aList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L449">		Connection db_conn = null;</span>
<span class="fc" id="L450">		PreparedStatement ps = null;</span>
<span class="fc" id="L451">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L454">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="fc" id="L455">			ps = db_conn.prepareStatement(&quot;SELECT DISTINCT question_group FROM inquiry WHERE &quot;+CloudToolsForCore.getDomainIdSqlWhere(false)+&quot; ORDER BY question_group ASC&quot;);</span>
<span class="fc" id="L456">			rs = ps.executeQuery();</span>
			LabelValueDetails lvd;
<span class="fc bfc" id="L458" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L460">				lvd = new LabelValueDetails();</span>
<span class="fc" id="L461">				lvd.setLabel(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="fc" id="L462">				lvd.setValue(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="fc" id="L463">				aList.add(lvd);</span>
			}
<span class="fc" id="L465">			rs.close();</span>
<span class="fc" id="L466">			ps.close();</span>
<span class="fc" id="L467">			db_conn.close();</span>
<span class="fc" id="L468">			rs = null;</span>
<span class="fc" id="L469">			ps = null;</span>
<span class="fc" id="L470">			db_conn = null;</span>
		}
<span class="nc" id="L472">		catch (Exception ex)</span>
		{
<span class="nc" id="L474">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L481">					rs.close();</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L483">					ps.close();</span>
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L485">					db_conn.close();</span>
			}
<span class="nc" id="L487">			catch (Exception ex2)</span>
			{
<span class="nc" id="L489">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L490">			}</span>
		}

<span class="fc" id="L493">		return aList;</span>
	}

	/**
	 * nacita skupiny ankiet do listu a vyfiltruje podla povolenych kategorii pre usera
	 *
	 * @return
	 */
	public static List&lt;LabelValueDetails&gt; getQuestionGroupsByUser(HttpServletRequest request)
	{
<span class="fc" id="L503">		Identity user = (Identity) request.getSession().getAttribute(Constants.USER_KEY);</span>
<span class="fc" id="L504">		List&lt;LabelValueDetails&gt; distinctGroups = SettingsAdminDB.filterBeansByUserAllowedCategories(getQuestionGroups(request), &quot;label&quot;, user, &quot;menuInquiry&quot;) ;</span>
<span class="fc" id="L505">		return distinctGroups;</span>
	}


	/**
	 * vypocita percentualne hodnotu odpovede
	 * @param answers
	 * @param format
	 */
	private static void countPercentage(List&lt;AnswerForm&gt; answers, String format)
	{
<span class="fc" id="L516">		double suma = 0;</span>
		//vyrataj sumu
<span class="fc bfc" id="L518" title="All 2 branches covered.">		for (AnswerForm answer : answers)</span>
		{
<span class="fc" id="L520">			suma += answer.getAnswerClicks();</span>
<span class="fc" id="L521">		}</span>
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">		if (format == null)</span>
<span class="nc" id="L523">			format = &quot;0.##&quot;;</span>
<span class="fc" id="L524">		DecimalFormat formatter = new DecimalFormat(format);</span>
<span class="fc bfc" id="L525" title="All 2 branches covered.">		for (AnswerForm answer : answers)</span>
		{
<span class="pc bpc" id="L527" title="1 of 4 branches missed.">			if (answer.getAnswerClicks() &gt; 0 &amp;&amp; suma &gt; 0)</span>
			{
<span class="fc" id="L529">				answer.setPercentage((100D * answer.getAnswerClicks()) / suma);</span>
<span class="fc" id="L530">				answer.setPercentageString(formatter.format(answer.getPercentage()));</span>
			}
			else
			{
<span class="fc" id="L534">				answer.setPercentage(0);</span>
<span class="fc" id="L535">				answer.setPercentageString(formatter.format(answer.getPercentage()));</span>
			}
<span class="fc" id="L537">		}</span>
<span class="fc" id="L538">	}</span>

	/**
	 * nastavi pocty obrazkov pre vygenerovanie stlpceka MUSI sa volat az po
	 * countPercentage!
	 *
	 * @param answers
	 * @param imagesLength -
	 *           maximalny pocet obrazkov
	 */
	private static void countImages(List&lt;AnswerForm&gt; answers, int imagesLength)
	{
		//vyrataj sumu
<span class="fc bfc" id="L551" title="All 2 branches covered.">		for (AnswerForm answer : answers)</span>
		{
<span class="fc" id="L553">			answer.setImages((int) ((imagesLength / 100D) * answer.getPercentage()));</span>
<span class="fc" id="L554">		}</span>
<span class="fc" id="L555">	}</span>

	/**
	 * incrementuje hodnotu(t.j. result) v odpovedi urcenej pomocou qID
	 * (ktora otazka) a aID(ktora odpoved)
	 * @param qID
	 * @param aID
	 * @param request
	 */
	public static void updateAnswer(int qID, int aID, HttpServletRequest request)
	{
<span class="fc" id="L566">		String sql = &quot;UPDATE inquiry_answers SET answer_clicks=answer_clicks+1 WHERE question_id=? and answer_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>

<span class="pc bpc" id="L568" title="2 of 4 branches missed.">		if ((qID &gt; -1) &amp;&amp; (aID &gt; -1))</span>
		{
<span class="fc" id="L570">			Connection db_conn = null;</span>
<span class="fc" id="L571">			PreparedStatement ps = null;</span>
			try
			{
<span class="fc" id="L574">				db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="fc" id="L575">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L576">				ps.setInt(1, qID);</span>
<span class="fc" id="L577">				ps.setInt(2, aID);</span>
<span class="fc" id="L578">				ps.execute();</span>

<span class="fc" id="L580">				ps.close();</span>
<span class="fc" id="L581">				db_conn.close();</span>
<span class="fc" id="L582">				ps = null;</span>
<span class="fc" id="L583">				db_conn = null;</span>
			}
<span class="nc" id="L585">			catch (Exception ex)</span>
			{
<span class="nc" id="L587">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L593" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L594">						ps.close();</span>
<span class="pc bpc" id="L595" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L596">						db_conn.close();</span>
				}
<span class="nc" id="L598">				catch (Exception ex2)</span>
				{
<span class="fc" id="L600">				}</span>
			}
		}
<span class="fc" id="L603">	}</span>

	/**
	 * inkrementuje premennu totalClicks na zaklade qID, co definuje anketu
	 * @param qID - identifikator ankety
	 * @param request
	 */
	public static void updateTotalClicks(int qID, HttpServletRequest request)
	{
<span class="fc" id="L612">		String sqlTotalClicks = &quot;UPDATE inquiry SET total_clicks = total_clicks + 1 WHERE question_id = ? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">		if ((qID &gt; -1))</span>
		{
<span class="fc" id="L615">			Connection db_conn = null;</span>
<span class="fc" id="L616">			PreparedStatement ps = null;</span>
			try
			{
<span class="fc" id="L619">				db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>

<span class="fc" id="L621">				ps = db_conn.prepareStatement(sqlTotalClicks);</span>
<span class="fc" id="L622">				ps.setInt(1, qID);</span>
<span class="fc" id="L623">				ps.execute();</span>

<span class="fc" id="L625">				ps.close();</span>
<span class="fc" id="L626">				db_conn.close();</span>
<span class="fc" id="L627">				ps = null;</span>
<span class="fc" id="L628">				db_conn = null;</span>
			}
<span class="nc" id="L630">			catch (Exception ex)</span>
			{
<span class="nc" id="L632">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L638" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L639">						ps.close();</span>
<span class="pc bpc" id="L640" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L641">						db_conn.close();</span>
				}
<span class="nc" id="L643">				catch (Exception ex2)</span>
				{
<span class="nc" id="L645">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L646">				}</span>
			}
		}
<span class="fc" id="L649">	}</span>

	public static List&lt;AnswerForm&gt; getAllInquiry(HttpServletRequest request)
	{
<span class="nc" id="L653">		List&lt;AnswerForm&gt; al = new ArrayList&lt;&gt;();</span>
		AnswerForm icForm;
<span class="nc" id="L655">		String sql = &quot;SELECT * FROM inquiry WHERE &quot;+CloudToolsForCore.getDomainIdSqlWhere(false)+&quot; ORDER BY question_id DESC&quot;;</span>

<span class="nc" id="L657">		Connection db_conn = null;</span>
<span class="nc" id="L658">		PreparedStatement ps = null;</span>
<span class="nc" id="L659">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L662">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L663">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L664">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L667">				icForm = new AnswerForm();</span>
<span class="nc" id="L668">				icForm.setQuestionString(DB.getDbString(rs, &quot;question_text&quot;));</span>
<span class="nc" id="L669">				icForm.setQuestionID(rs.getInt(&quot;question_id&quot;));</span>
<span class="nc" id="L670">				icForm.setHours(rs.getInt(&quot;hours&quot;));</span>
<span class="nc" id="L671">				icForm.setGroup(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="nc" id="L672">				icForm.setAnswerTextOk(DB.getDbString(rs, &quot;answer_text_ok&quot;));</span>
<span class="nc" id="L673">				icForm.setAnswerTextFail(DB.getDbString(rs, &quot;answer_text_fail&quot;));</span>
<span class="nc" id="L674">				icForm.setDateFrom(Tools.formatDate(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L675">				icForm.setDateFromTime(Tools.formatTime(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L676">				icForm.setDateTo(Tools.formatDate(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L677">				icForm.setDateToTime(Tools.formatTime(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L678">				icForm.setActive(rs.getBoolean(&quot;question_active&quot;));</span>
<span class="nc" id="L679">				icForm.setMultiple(rs.getBoolean(&quot;multiple&quot;));</span>
<span class="nc" id="L680">				icForm.setTotalClicks(rs.getInt(&quot;total_clicks&quot;));</span>
<span class="nc" id="L681">				al.add(icForm);</span>
			}
<span class="nc" id="L683">			rs.close();</span>
<span class="nc" id="L684">			ps.close();</span>
<span class="nc" id="L685">			db_conn.close();</span>
<span class="nc" id="L686">			rs = null;</span>
<span class="nc" id="L687">			ps = null;</span>
<span class="nc" id="L688">			db_conn = null;</span>
		}
<span class="nc" id="L690">		catch (Exception ex)</span>
		{
<span class="nc" id="L692">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L698" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L699">					rs.close();</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L701">					ps.close();</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L703">					db_conn.close();</span>
			}
<span class="nc" id="L705">			catch (Exception ex2)</span>
			{
<span class="nc" id="L707">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L708">			}</span>
		}

<span class="nc" id="L711">		return al;</span>
	}

	/**
	 * Funkcia vrati zoznam objektov AnswerForm, ktore zodpovedaju vstupnym parametrom - otazka obsahuje text alebo/a patri do skupiny
	 *
	 * @param groups			nazvy skupin, do ktorych musi patrit anketa
	 * @param questionText	text, ktory sa vyhladava v otazke
	 *
	 * @return Vrat zoznam objektov AnswerForm, ak ziadna z ankiet nevyhovuje podmienke, vrati prazdny zoznam (nie NULL)
	 */
	public static List&lt;AnswerForm&gt; getInquiries(List&lt;String&gt; groups, String questionText)
   {
<span class="nc" id="L724">		List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L726">		StringBuilder sql = new StringBuilder();</span>
<span class="nc" id="L727">		sql.append(&quot;SELECT * FROM inquiry WHERE question_id &gt; 0 &quot;);</span>

<span class="nc" id="L729">		String groupsInSql = &quot;(&quot;;</span>
<span class="nc" id="L730">		StringBuilder buf = new StringBuilder(groupsInSql);</span>
<span class="nc bnc" id="L731" title="All 4 branches missed.">		if (groups != null &amp;&amp; groups.size() &gt; 0)</span>
		{
<span class="nc bnc" id="L733" title="All 2 branches missed.">			for (int i = 0; i &lt; groups.size(); i++) buf.append(&quot;?, &quot;);</span>

<span class="nc" id="L735">			groupsInSql = buf.toString();</span>
<span class="nc" id="L736">			groupsInSql = groupsInSql.substring(0, (groupsInSql.length()-2));</span>
<span class="nc" id="L737">			groupsInSql += &quot;)&quot;;</span>

			//skupina ankety
<span class="nc" id="L740">			sql.append(&quot; AND question_group IN &quot; + groupsInSql);</span>

<span class="nc bnc" id="L742" title="All 2 branches missed.">			for (int i = 0; i &lt; groups.size(); i++) params.add(groups.get(i));</span>
		}

		//text otazky
<span class="nc bnc" id="L746" title="All 2 branches missed.">		if (Tools.isNotEmpty(questionText))</span>
		{
<span class="nc" id="L748">			sql.append(&quot; AND question_text LIKE ?&quot;);</span>
<span class="nc" id="L749">			params.add(&quot;%&quot; + questionText + &quot;%&quot;);</span>
		}

<span class="nc" id="L752">		sql.append(CloudToolsForCore.getDomainIdSqlWhere(true));</span>

<span class="nc" id="L754">		sql.append(&quot; ORDER BY question_id DESC&quot;);</span>

<span class="nc" id="L756">      List&lt;AnswerForm&gt; inquiries = new ComplexQuery().setSql(sql.toString()).setParams(params.toArray()).list(new Mapper&lt;AnswerForm&gt;()</span>
<span class="nc" id="L757">      {</span>
      	@Override
         public AnswerForm map(ResultSet rs) throws SQLException
         {
<span class="nc" id="L761">         	AnswerForm icForm = new AnswerForm();</span>

<span class="nc" id="L763">				icForm.setQuestionString(DB.getDbString(rs, &quot;question_text&quot;));</span>
<span class="nc" id="L764">				icForm.setQuestionID(rs.getInt(&quot;question_id&quot;));</span>
<span class="nc" id="L765">				icForm.setHours(rs.getInt(&quot;hours&quot;));</span>
<span class="nc" id="L766">				icForm.setGroup(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="nc" id="L767">				icForm.setAnswerTextOk(DB.getDbString(rs, &quot;answer_text_ok&quot;));</span>
<span class="nc" id="L768">				icForm.setAnswerTextFail(DB.getDbString(rs, &quot;answer_text_fail&quot;));</span>
<span class="nc" id="L769">				icForm.setDateFrom(Tools.formatDate(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L770">				icForm.setDateFromTime(Tools.formatTime(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L771">				icForm.setDateTo(Tools.formatDate(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L772">				icForm.setDateToTime(Tools.formatTime(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L773">				icForm.setActive(rs.getBoolean(&quot;question_active&quot;));</span>
<span class="nc" id="L774">				icForm.setMultiple(rs.getBoolean(&quot;multiple&quot;));</span>
<span class="nc" id="L775">				icForm.setTotalClicks(rs.getInt(&quot;total_clicks&quot;));</span>

<span class="nc" id="L777">         	return icForm;</span>
         }
      });

<span class="nc" id="L781">		return inquiries;</span>
	}

	public static int getNewQuestionID(HttpServletRequest request)
	{
<span class="nc" id="L786">		int newqID = -1;</span>
<span class="nc" id="L787">		String sql = &quot;SELECT max(question_id) AS max FROM inquiry WHERE &quot;+CloudToolsForCore.getDomainIdSqlWhere(false);</span>

<span class="nc" id="L789">		Connection db_conn = null;</span>
<span class="nc" id="L790">		PreparedStatement ps = null;</span>
<span class="nc" id="L791">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L794">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L795">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L796">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L799">				newqID = rs.getInt(&quot;max&quot;);</span>
			}
<span class="nc" id="L801">			rs.close();</span>
<span class="nc" id="L802">			ps.close();</span>
<span class="nc" id="L803">			db_conn.close();</span>
<span class="nc" id="L804">			rs = null;</span>
<span class="nc" id="L805">			ps = null;</span>
<span class="nc" id="L806">			db_conn = null;</span>
		}
<span class="nc" id="L808">		catch (Exception ex)</span>
		{
<span class="nc" id="L810">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L816" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L817">					rs.close();</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L819">					ps.close();</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L821">					db_conn.close();</span>
			}
<span class="nc" id="L823">			catch (Exception ex2)</span>
			{
<span class="nc" id="L825">			}</span>
		}

<span class="nc" id="L828">		newqID++;</span>
<span class="nc" id="L829">		return newqID;</span>
	}

	public static void addNewAnswer(int qID, AnswerForm answer, HttpServletRequest request)

	{
<span class="nc" id="L835">		Connection db_conn = null;</span>
<span class="nc" id="L836">		PreparedStatement ps = null;</span>
		try
		{
<span class="nc" id="L839">			String sql_3_1 = &quot;INSERT INTO inquiry_answers(question_id, answer_text, image_path, url, answer_clicks, domain_id) VALUES(?,?,?,?,?,?)&quot;;</span>
<span class="nc bnc" id="L840" title="All 4 branches missed.">			if ((qID &gt; -1) &amp;&amp; (answer != null))</span>
			{
<span class="nc" id="L842">				db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L843">				ps = db_conn.prepareStatement(sql_3_1);</span>
<span class="nc" id="L844">				ps.setInt(1, qID);</span>
<span class="nc" id="L845">				ps.setString(2, answer.getAnswerString());</span>
<span class="nc" id="L846">				ps.setString(3, answer.getImagePath());</span>
<span class="nc" id="L847">				ps.setString(4, answer.getUrl());</span>
<span class="nc" id="L848">				ps.setInt(5, answer.getAnswerClicks());</span>
<span class="nc" id="L849">				ps.setInt(6, CloudToolsForCore.getDomainId());</span>
<span class="nc" id="L850">				ps.execute();</span>
<span class="nc" id="L851">				ps.close();</span>
<span class="nc" id="L852">				db_conn.close();</span>
			}

<span class="nc" id="L855">			ps = null;</span>
<span class="nc" id="L856">			AnswerForm question = getQuestion(qID, request);</span>
<span class="nc" id="L857">			Adminlog.add(Adminlog.TYPE_INQUIRY_CREATE, String.format(&quot;Pridana odpoved %s na otazku %s&quot;, answer, question.getQuestionString()), qID, -1);</span>
<span class="nc" id="L858">			db_conn = null;</span>
		}
<span class="nc" id="L860">		catch (Exception ex)</span>
		{
<span class="nc" id="L862">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L868" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L869">					ps.close();</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L871">					db_conn.close();</span>
			}
<span class="nc" id="L873">			catch (Exception ex2)</span>
			{
<span class="nc" id="L875">			}</span>
		}
<span class="nc" id="L877">	}</span>

	public static void createNewQuestion(AnswerForm form, HttpServletRequest request)
	{
<span class="nc" id="L881">		String sql = &quot;INSERT INTO inquiry (question_text, hours, question_group, answer_text_ok, answer_text_fail, &quot;+</span>
					 &quot;date_from, date_to, question_active, multiple, domain_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;;
<span class="nc" id="L883">		int max = -1;</span>


<span class="nc" id="L886">		Connection db_conn = null;</span>
<span class="nc" id="L887">		PreparedStatement ps = null;</span>
<span class="nc" id="L888">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L891">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L892">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L893">			ps.setString(1, form.getQuestionString());</span>
<span class="nc" id="L894">			ps.setInt(2, form.getHours());</span>
<span class="nc" id="L895">			ps.setString(3, form.getGroup());</span>
<span class="nc" id="L896">			ps.setString(4, form.getAnswerTextOk());</span>
<span class="nc" id="L897">			ps.setString(5, form.getAnswerTextFail());</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">			if (Tools.isNotEmpty(form.getDateFrom()))</span>
			{
<span class="nc" id="L900">				ps.setTimestamp(6, new Timestamp(DB.getTimestamp(form.getDateFrom(), form.getDateFromTime() )));</span>
			}
			else
			{
<span class="nc" id="L904">				ps.setNull(6, Types.TIMESTAMP);</span>
			}
<span class="nc bnc" id="L906" title="All 2 branches missed.">			if (Tools.isNotEmpty(form.getDateTo()))</span>
			{
<span class="nc" id="L908">				ps.setTimestamp(7, new Timestamp(DB.getTimestamp(form.getDateTo(), form.getDateToTime() )));</span>
			}
			else
			{
<span class="nc" id="L912">				ps.setNull(7, Types.TIMESTAMP);</span>
			}
<span class="nc" id="L914">			ps.setBoolean(8, form.isActive());</span>
<span class="nc" id="L915">			ps.setBoolean(9, form.isMultiple());</span>
<span class="nc" id="L916">			ps.setInt(10, CloudToolsForCore.getDomainId());</span>
<span class="nc" id="L917">			ps.execute();</span>
<span class="nc" id="L918">			ps.close();</span>
<span class="nc" id="L919">			ps = db_conn.prepareStatement(&quot;SELECT max(question_id) AS max FROM inquiry WHERE &quot;+CloudToolsForCore.getDomainIdSqlWhere(false));</span>
<span class="nc" id="L920">			rs = ps.executeQuery();</span>
<span class="nc" id="L921">			rs.next();</span>
<span class="nc" id="L922">			max = rs.getInt(&quot;max&quot;);</span>
<span class="nc" id="L923">			rs.close();</span>
<span class="nc" id="L924">			ps.close();</span>
<span class="nc" id="L925">			form.setQuestionID(max);</span>
<span class="nc" id="L926">			db_conn.close();</span>

<span class="nc" id="L928">			rs = null;</span>
<span class="nc" id="L929">			ps = null;</span>
<span class="nc" id="L930">			db_conn = null;</span>
		}
<span class="nc" id="L932">		catch (Exception ex)</span>
		{
<span class="nc" id="L934">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L940" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L941">					rs.close();</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L943">					ps.close();</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L945">					db_conn.close();</span>
			}
<span class="nc" id="L947">			catch (Exception ex2)</span>
			{
<span class="nc" id="L949">			}</span>
		}
<span class="nc" id="L951">		Adminlog.add(Adminlog.TYPE_INQUIRY_CREATE, &quot;Vytvorena nova anketa: &quot;+form.getQuestionString(), form.getQuestionID(), -1);</span>
<span class="nc" id="L952">	}</span>

	public static void alterQuestion(AnswerForm form, HttpServletRequest request)
	{
		//Logger.println(this,&quot;Alter Question: &quot; + form.getDateFrom() + &quot; to=&quot; + form.getDateTo());
<span class="nc" id="L957">		AnswerForm question = getQuestion(form.getQuestionID(), request);</span>
<span class="nc" id="L958">		BeanDiffPrinter diff = new BeanDiffPrinter(new BeanDiff().setOriginal(question).setNew(form));</span>
<span class="nc" id="L959">		Adminlog.add(Adminlog.TYPE_INQUIRY_UPDATE, &quot;Zmenena anketa &quot;+form.getQuestionString()+&quot; &quot;+diff, form.getQuestionID(), -1);</span>


<span class="nc" id="L962">		String sql = &quot;UPDATE inquiry SET question_text=?, hours=?, question_group=?, answer_text_ok=?, answer_text_fail=?, &quot;+</span>
<span class="nc" id="L963">					&quot;date_from=?, date_to=?, question_active=?, multiple= ?, total_clicks= ? WHERE question_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>

<span class="nc" id="L965">		Connection db_conn = null;</span>
<span class="nc" id="L966">		PreparedStatement ps = null;</span>
		try
		{

<span class="nc" id="L970">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L971">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L972">			ps.setString(1, form.getQuestionString());</span>
<span class="nc" id="L973">			ps.setInt(2, form.getHours());</span>
<span class="nc" id="L974">			ps.setString(3, form.getGroup());</span>
<span class="nc" id="L975">			ps.setString(4, form.getAnswerTextOk());</span>
<span class="nc" id="L976">			ps.setString(5, form.getAnswerTextFail());</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">			if (Tools.isNotEmpty(form.getDateFrom()))</span>
			{
<span class="nc" id="L979">				ps.setTimestamp(6, new Timestamp(DB.getTimestamp(form.getDateFrom(), form.getDateFromTime() )));</span>
			}
			else
			{
<span class="nc" id="L983">				ps.setNull(6, Types.TIMESTAMP);</span>
			}
<span class="nc bnc" id="L985" title="All 2 branches missed.">			if (Tools.isNotEmpty(form.getDateTo()))</span>
			{
<span class="nc" id="L987">				ps.setTimestamp(7, new Timestamp(DB.getTimestamp(form.getDateTo(), form.getDateToTime() )));</span>
			}
			else
			{
<span class="nc" id="L991">				ps.setNull(7, Types.TIMESTAMP);</span>
			}
<span class="nc" id="L993">			ps.setBoolean(8, form.isActive());</span>
<span class="nc" id="L994">			ps.setBoolean(9, form.isMultiple());</span>
<span class="nc" id="L995">			ps.setInt(10, form.getTotalClicks());</span>
<span class="nc" id="L996">			ps.setInt(11, form.getQuestionID());</span>
<span class="nc" id="L997">			ps.execute();</span>
<span class="nc" id="L998">			ps.close();</span>
<span class="nc" id="L999">			db_conn.close();</span>
<span class="nc" id="L1000">			ps = null;</span>
<span class="nc" id="L1001">			db_conn = null;</span>
		}
<span class="nc" id="L1003">		catch (Exception ex)</span>
		{
<span class="nc" id="L1005">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1011" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1012">					ps.close();</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1014">					db_conn.close();</span>
			}
<span class="nc" id="L1016">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1018">			}</span>
		}

<span class="nc" id="L1021">	}</span>

	public static void alterAnswerString(AnswerForm answer, HttpServletRequest request)
	{
<span class="nc" id="L1025">		Connection db_conn = null;</span>
<span class="nc" id="L1026">		PreparedStatement ps = null;</span>
<span class="nc" id="L1027">		AnswerForm answerOld = getAnswer(answer.getAnswerID(), request);</span>

<span class="nc" id="L1029">		Adminlog.add(Adminlog.TYPE_INQUIRY_UPDATE,</span>
<span class="nc" id="L1030">				String.format(&quot;Zmenena odpoved na anketu %s: %s =&gt; %s&quot;, answerOld.getQuestionString(), answerOld.getAnswerString(), answer.getAnswerString()),</span>
<span class="nc" id="L1031">				answer.getAnswerID(), -1);</span>

<span class="nc" id="L1033">		String sql = &quot;UPDATE  inquiry_answers SET answer_text=?, answer_clicks=?, image_path = ?, url= ? WHERE answer_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
		try
		{
<span class="nc" id="L1036">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L1037">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1038">			ps.setString(1, answer.getAnswerString());</span>
<span class="nc" id="L1039">			ps.setInt(2, answer.getAnswerClicks());</span>
<span class="nc" id="L1040">			ps.setString(3, answer.getImagePath());</span>
<span class="nc" id="L1041">			ps.setString(4, answer.getUrl());</span>
<span class="nc" id="L1042">			ps.setInt(5, answer.getAnswerID());</span>
<span class="nc" id="L1043">			ps.execute();</span>
<span class="nc" id="L1044">			ps.close();</span>
<span class="nc" id="L1045">			db_conn.close();</span>
<span class="nc" id="L1046">			ps = null;</span>
<span class="nc" id="L1047">			db_conn = null;</span>
		}
<span class="nc" id="L1049">		catch (Exception ex)</span>
		{
<span class="nc" id="L1051">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1057" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1058">					ps.close();</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1060">					db_conn.close();</span>
			}
<span class="nc" id="L1062">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1064">			}</span>
		}
<span class="nc" id="L1066">	}</span>

	public static void deleteAnswer(int aID, HttpServletRequest request)
	{
<span class="nc" id="L1070">		Connection db_conn = null;</span>
<span class="nc" id="L1071">		PreparedStatement ps = null;</span>
<span class="nc" id="L1072">		AnswerForm answer = getAnswer(aID, request);</span>
<span class="nc" id="L1073">		Adminlog.add(Adminlog.TYPE_INQUIRY_DELETE,</span>
<span class="nc" id="L1074">				String.format(&quot;Zmazana odpoved %s na anketu %s&quot;, answer.getAnswerString(), answer.getQuestionString()),</span>
				aID, -1);
<span class="nc" id="L1076">		String sql = &quot;DELETE FROM inquiry_answers WHERE answer_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
		try
		{
<span class="nc" id="L1079">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L1080">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1081">			ps.setInt(1, aID);</span>
<span class="nc" id="L1082">			ps.execute();</span>
<span class="nc" id="L1083">			ps.close();</span>
<span class="nc" id="L1084">			db_conn.close();</span>
<span class="nc" id="L1085">			ps = null;</span>
<span class="nc" id="L1086">			db_conn = null;</span>
		}
<span class="nc" id="L1088">		catch (Exception ex)</span>
		{
<span class="nc" id="L1090">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1096" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1097">					ps.close();</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1099">					db_conn.close();</span>
			}
<span class="nc" id="L1101">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1103">			}</span>
		}
<span class="nc" id="L1105">	}</span>

	/*
	 * Vymaze z DB anketu a odpovede pre danu anketu
	 */
	public static String deleteInquiry(int questionId, HttpServletRequest request)
	{
<span class="nc" id="L1112">		Adminlog.add(Adminlog.TYPE_INQUIRY_DELETE, &quot;Zmazana anketa s ID: &quot;+questionId, -1, -1);</span>
<span class="nc" id="L1113">		Connection db_conn = null;</span>
<span class="nc" id="L1114">		PreparedStatement ps = null;</span>
<span class="nc" id="L1115">		String sql_question = &quot;DELETE FROM inquiry WHERE question_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="nc" id="L1116">		String sql_answer = &quot;DELETE FROM inquiry_answers WHERE question_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
		try
		{
<span class="nc" id="L1119">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L1120">			ps = db_conn.prepareStatement(sql_question);</span>
<span class="nc" id="L1121">			ps.setInt(1, questionId);</span>
<span class="nc" id="L1122">			ps.execute();</span>
<span class="nc" id="L1123">			ps.close();</span>
<span class="nc" id="L1124">			db_conn.close();</span>
<span class="nc" id="L1125">			ps = null;</span>
<span class="nc" id="L1126">			db_conn = null;</span>
		}
<span class="nc" id="L1128">		catch (Exception ex)</span>
		{
<span class="nc" id="L1130">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1136" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1137">					ps.close();</span>
<span class="nc bnc" id="L1138" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1139">					db_conn.close();</span>
			}
<span class="nc" id="L1141">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1143">			}</span>
		}

		try
		{
<span class="nc" id="L1148">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L1149">			ps = db_conn.prepareStatement(sql_answer);</span>
<span class="nc" id="L1150">			ps.setInt(1, questionId);</span>
<span class="nc" id="L1151">			ps.execute();</span>
<span class="nc" id="L1152">			ps.close();</span>
<span class="nc" id="L1153">			db_conn.close();</span>
<span class="nc" id="L1154">			ps = null;</span>
<span class="nc" id="L1155">			db_conn = null;</span>
		}
<span class="nc" id="L1157">		catch (Exception ex)</span>
		{
<span class="nc" id="L1159">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1165" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1166">					ps.close();</span>
<span class="nc bnc" id="L1167" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1168">					db_conn.close();</span>
			}
<span class="nc" id="L1170">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1172">			}</span>
		}
<span class="nc" id="L1174">		return (&quot;success&quot;);</span>
	}

	public static AnswerForm getQuestion(int qID, HttpServletRequest request)
	{
<span class="fc" id="L1179">		Connection db_conn = null;</span>
<span class="fc" id="L1180">		PreparedStatement ps = null;</span>
<span class="fc" id="L1181">		ResultSet rs = null;</span>
<span class="fc" id="L1182">		AnswerForm aForm = new AnswerForm();</span>
<span class="fc" id="L1183">		String sql = &quot;SELECT * FROM inquiry WHERE question_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
		try
		{
<span class="pc bpc" id="L1186" title="1 of 2 branches missed.">			if (qID &gt; -1)</span>
			{
<span class="fc" id="L1188">				db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="fc" id="L1189">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L1190">				ps.setInt(1, qID);</span>
<span class="fc" id="L1191">				rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1192" title="1 of 2 branches missed.">				if (rs.next())</span>
				{
<span class="fc" id="L1194">					aForm.setQuestionID(qID);</span>
<span class="fc" id="L1195">					aForm.setQuestionString(DB.getDbString(rs, &quot;question_text&quot;));</span>
<span class="fc" id="L1196">					aForm.setHours(rs.getInt(&quot;hours&quot;));</span>
<span class="fc" id="L1197">					aForm.setGroup(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="fc" id="L1198">					aForm.setAnswerTextOk(DB.getDbString(rs, &quot;answer_text_ok&quot;));</span>
<span class="fc" id="L1199">					aForm.setAnswerTextFail(DB.getDbString(rs, &quot;answer_text_fail&quot;));</span>
<span class="fc" id="L1200">					aForm.setDateFrom(Tools.formatDate(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="fc" id="L1201">					aForm.setDateFromTime(Tools.formatTime(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="fc" id="L1202">					aForm.setDateTo(Tools.formatDate(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="fc" id="L1203">					aForm.setDateToTime(Tools.formatTime(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="fc" id="L1204">					aForm.setActive(rs.getBoolean(&quot;question_active&quot;));</span>
<span class="fc" id="L1205">					aForm.setMultiple(rs.getBoolean(&quot;multiple&quot;));</span>
<span class="fc" id="L1206">					aForm.setTotalClicks(rs.getInt(&quot;total_clicks&quot;));</span>
				}
<span class="fc" id="L1208">				rs.close();</span>
<span class="fc" id="L1209">				ps.close();</span>
<span class="fc" id="L1210">				db_conn.close();</span>
<span class="fc" id="L1211">				rs = null;</span>
<span class="fc" id="L1212">				ps = null;</span>
<span class="fc" id="L1213">				db_conn = null;</span>

<span class="fc" id="L1215">				Logger.println(InquiryDB.class,&quot;DateToTime: &quot; + aForm.getDateToTime());</span>
			}
		}
<span class="nc" id="L1218">		catch (Exception ex)</span>
		{
<span class="nc" id="L1220">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L1226" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1227">					rs.close();</span>
<span class="pc bpc" id="L1228" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1229">					ps.close();</span>
<span class="pc bpc" id="L1230" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1231">					db_conn.close();</span>
			}
<span class="nc" id="L1233">			catch (Exception ex2)</span>
			{
<span class="fc" id="L1235">			}</span>
		}
<span class="fc" id="L1237">		return aForm;</span>
	}

	public static int getHoursCount(int qID, HttpServletRequest request)
	{
<span class="fc" id="L1242">		Connection db_conn = null;</span>
<span class="fc" id="L1243">		PreparedStatement ps = null;</span>
<span class="fc" id="L1244">		ResultSet rs = null;</span>
<span class="fc" id="L1245">		String sql = &quot;SELECT hours FROM inquiry WHERE question_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="fc" id="L1246">		int result = 0;</span>
		try
		{
<span class="fc" id="L1249">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="fc" id="L1250">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L1251">			ps.setInt(1, qID);</span>
<span class="fc" id="L1252">			rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1253" title="1 of 2 branches missed.">			if (rs.next())</span>
			{
<span class="fc" id="L1255">				result = rs.getInt(&quot;hours&quot;);</span>
			}
<span class="fc" id="L1257">			rs.close();</span>
<span class="fc" id="L1258">			ps.close();</span>
<span class="fc" id="L1259">			db_conn.close();</span>
<span class="fc" id="L1260">			rs = null;</span>
<span class="fc" id="L1261">			ps = null;</span>
<span class="fc" id="L1262">			db_conn = null;</span>
		}
<span class="nc" id="L1264">		catch (Exception ex)</span>
		{
<span class="nc" id="L1266">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L1272" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1273">					rs.close();</span>
<span class="pc bpc" id="L1274" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1275">					ps.close();</span>
<span class="pc bpc" id="L1276" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1277">					db_conn.close();</span>
			}
<span class="nc" id="L1279">			catch (Exception ex2)</span>
			{
<span class="fc" id="L1281">			}</span>
		}
<span class="fc" id="L1283">		return result;</span>
	}

	/**
	 * Vrati zoznam starych ankiet usporiadanych podla datumu platnosti
	 * @param groupNames - nazvy skupin oddelene ciarkou
	 * @param orderAscending - ak je true je usporiadanie od najstarsich po najnovsie
	 * @return
	 */
	public static List&lt;AnswerForm&gt; getOldInquiry(String groupNames, boolean orderAscending)
	{
<span class="nc" id="L1294">		List&lt;AnswerForm&gt; inquirys = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1295">		Connection db_conn = null;</span>
<span class="nc" id="L1296">		PreparedStatement ps = null;</span>
<span class="nc" id="L1297">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L1300">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L1302">			String sOrder = &quot;DESC&quot;;</span>
<span class="nc bnc" id="L1303" title="All 2 branches missed.">			if (orderAscending) sOrder = &quot;ASC&quot;;</span>

<span class="nc" id="L1305">			StringBuilder sql = new StringBuilder(&quot;SELECT * FROM inquiry&quot;);</span>

<span class="nc bnc" id="L1307" title="All 2 branches missed.">			if (Tools.isNotEmpty(groupNames))</span>
			{
<span class="nc" id="L1309">				groupNames = DB.removeSlashes(groupNames);</span>
<span class="nc" id="L1310">				StringTokenizer st = new StringTokenizer(groupNames, &quot;,+&quot;);</span>
<span class="nc" id="L1311">				sql.append(&quot; WHERE question_group IN ( '&quot;).append(DB.removeSlashes(st.nextToken())).append('\'');</span>

<span class="nc bnc" id="L1313" title="All 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
<span class="nc" id="L1315">					sql.append(&quot;, '&quot;).append(st.nextToken()).append('\'');</span>
				}
<span class="nc" id="L1317">				sql.append(&quot;) &quot;);</span>

<span class="nc" id="L1319">				sql.append(CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1320">			}</span>
			else
			{
<span class="nc" id="L1323">				sql.append(&quot; WHERE &quot;).append(CloudToolsForCore.getDomainIdSqlWhere(false));</span>
			}

<span class="nc" id="L1326">			sql.append(&quot; ORDER BY date_from &quot;).append(sOrder).append(&quot;, question_id &quot;).append(sOrder);</span>

<span class="nc" id="L1328">			ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L1329">			rs = ps.executeQuery();</span>
			AnswerForm icForm;
<span class="nc bnc" id="L1331" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L1333">				icForm = new AnswerForm();</span>
<span class="nc" id="L1334">				icForm.setQuestionString(DB.getDbString(rs, &quot;question_text&quot;));</span>
<span class="nc" id="L1335">				icForm.setQuestionID(rs.getInt(&quot;question_id&quot;));</span>
<span class="nc" id="L1336">				icForm.setHours(rs.getInt(&quot;hours&quot;));</span>
<span class="nc" id="L1337">				icForm.setGroup(DB.getDbString(rs, &quot;question_group&quot;));</span>
<span class="nc" id="L1338">				icForm.setAnswerTextOk(DB.getDbString(rs, &quot;answer_text_ok&quot;));</span>
<span class="nc" id="L1339">				icForm.setAnswerTextFail(DB.getDbString(rs, &quot;answer_text_fail&quot;));</span>
<span class="nc" id="L1340">				icForm.setDateFrom(Tools.formatDate(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L1341">				icForm.setDateFromTime(Tools.formatTime(rs.getTimestamp(&quot;date_from&quot;)));</span>
<span class="nc" id="L1342">				icForm.setDateTo(Tools.formatDate(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L1343">				icForm.setDateToTime(Tools.formatTime(rs.getTimestamp(&quot;date_to&quot;)));</span>
<span class="nc" id="L1344">				icForm.setActive(rs.getBoolean(&quot;question_active&quot;));</span>
<span class="nc" id="L1345">				icForm.setMultiple(rs.getBoolean(&quot;multiple&quot;));</span>
<span class="nc" id="L1346">				icForm.setTotalClicks(rs.getInt(&quot;total_clicks&quot;));</span>
				//zadisablovane tam nedame, iba take co maju neplatne datumy
<span class="nc bnc" id="L1348" title="All 2 branches missed.">				if (icForm.isActive()==false) continue;</span>

				//dame tam len take kde nie je platny datum, alebo datum nie je zadany
<span class="nc bnc" id="L1351" title="All 6 branches missed.">				if (icForm.isDateValid()==false || (Tools.isEmpty(icForm.getDateFrom()) &amp;&amp; Tools.isEmpty(icForm.getDateTo())))</span>
				{
<span class="nc" id="L1353">					inquirys.add(icForm);</span>
				}
			}
<span class="nc" id="L1356">			rs.close();</span>
<span class="nc" id="L1357">			ps.close();</span>
<span class="nc" id="L1358">			db_conn.close();</span>
<span class="nc" id="L1359">			rs = null;</span>
<span class="nc" id="L1360">			ps = null;</span>
<span class="nc" id="L1361">			db_conn = null;</span>
		}
<span class="nc" id="L1363">		catch (Exception ex)</span>
		{
<span class="nc" id="L1365">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1371" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1372">					rs.close();</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1374">					ps.close();</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1376">					db_conn.close();</span>
			}
<span class="nc" id="L1378">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1380">			}</span>
		}
<span class="nc" id="L1382">		return(inquirys);</span>
	}

	/**
	 * Vrati najnovsi datum zahlasovania daneho pouzivatela pre danu anketu
	 * @param userId	ID pouzivatela
	 * @param questionId	ID ankety
	 * @return najnovsi datum zahlasovania pre daneho pouzivatela
	 */
	public static java.util.Date getLastVoteDate(int userId, int questionId){
<span class="fc" id="L1392">		Connection db_conn = null;</span>
<span class="fc" id="L1393">		PreparedStatement ps = null;</span>
<span class="fc" id="L1394">		ResultSet rs = null;</span>
<span class="fc" id="L1395">		java.util.Date createdDate = null;</span>
		try
		{
<span class="fc" id="L1398">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L1399">			ps = db_conn.prepareStatement(&quot;SELECT MAX(create_date) as max_value FROM inquiry_users WHERE user_id=? AND question_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1400">			ps.setInt(1, userId);</span>
<span class="fc" id="L1401">			ps.setInt(2, questionId);</span>
<span class="fc" id="L1402">			rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1403" title="1 of 2 branches missed.">			if (rs.next())</span>
			{
<span class="fc" id="L1405">				createdDate = rs.getTimestamp(&quot;max_value&quot;);</span>
			}
<span class="fc" id="L1407">			rs.close();</span>
<span class="fc" id="L1408">			ps.close();</span>
<span class="fc" id="L1409">			db_conn.close();</span>
<span class="fc" id="L1410">			rs = null;</span>
<span class="fc" id="L1411">			ps = null;</span>
<span class="fc" id="L1412">			db_conn = null;</span>
		}
<span class="nc" id="L1414">		catch (Exception ex)</span>
		{
<span class="nc" id="L1416">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L1422" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1423">					rs.close();</span>
<span class="pc bpc" id="L1424" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1425">					ps.close();</span>
<span class="pc bpc" id="L1426" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1427">					db_conn.close();</span>
			}
<span class="nc" id="L1429">			catch (Exception ex2)</span>
			{
<span class="fc" id="L1431">			}</span>
		}
<span class="fc" id="L1433">		return createdDate;</span>
	}

	/**
	 * Vrati zoznam ankiet ako List {@link AnswerForm} vyfiltrovanych podla povolenych kategorii pre usera
	 * @param request
	 * @return
	 */
	public static Object getAllInquiryByUser(HttpServletRequest request)
	{
<span class="nc" id="L1443">		List&lt;LabelValueDetails&gt; groupsByUser = getQuestionGroupsByUser(request);</span>
<span class="nc" id="L1444">		List&lt;String&gt; stringGroups = new ArrayList&lt;&gt;(groupsByUser.size());</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">		for(LabelValueDetails lvd : groupsByUser)</span>
<span class="nc" id="L1446">			stringGroups.add(lvd.getLabel());</span>
<span class="nc" id="L1447">		return getInquiries(stringGroups, &quot;&quot;);</span>
	}

	/**
	 * Save answer in selected inquiry. Hadle logic and return path to some jsp taht represent &quot;fail&quot; or &quot;ok&quot; (may contain params).
	 *
	 * @param request
	 * @param response
	 * @return
	 * @throws IOException
	 * @throws ServletException
	 */
	public static String saveAnswer(HttpServletRequest request, HttpServletResponse response) {

<span class="fc" id="L1461">		final String fail = &quot;/components/inquiry/fail&quot;;</span>
<span class="fc" id="L1462">		final String ok = &quot;/components/inquiry/ok&quot;;</span>

		int[] aID;
<span class="fc" id="L1465">		int questionID = Tools.getIntValue(request.getParameter(&quot;qID&quot;), -1);</span>
<span class="fc" id="L1466">		String resultUrl = Tools.sanitizeHttpHeaderParam(request.getParameter(&quot;resultUrl&quot;));	//Vysledok ankety na inej stranke</span>
<span class="fc" id="L1467">		Identity user = UsersDB.getCurrentUser(request);	//kvoli ukladaniu statistik hlasovania pre jednotliveho pouzivatela</span>

<span class="fc" id="L1469">		String la = request.getParameter(&quot;la&quot;);</span>
<span class="pc bpc" id="L1470" title="1 of 2 branches missed.">		if (&quot;multipleAnswer&quot;.equals(la)) { // Zahlasovanie za viac moznosti</span>
<span class="nc" id="L1471">			String[] mAnswersString = request.getParameterValues(&quot;selectedAnswers&quot;);</span>
<span class="nc" id="L1472">			aID = new int[mAnswersString.length];</span>

<span class="nc bnc" id="L1474" title="All 2 branches missed.">			for (int i = 0; i &lt; mAnswersString.length; i++) { //prekonvertovanie</span>
<span class="nc" id="L1475">				aID[i] = Tools.getIntValue(mAnswersString[i], -1);</span>
<span class="nc bnc" id="L1476" title="All 2 branches missed.">				if (aID[i] &lt; 0) {</span>
<span class="nc bnc" id="L1477" title="All 2 branches missed.">					if(Tools.isNotEmpty(resultUrl))</span>
<span class="nc" id="L1478">						return SpringUrlMapping.redirect(resultUrl + &quot;?fail=1&amp;qID=&quot; + questionID);</span>
					else
<span class="nc" id="L1480">						return fail;</span>
				}
			}
<span class="nc" id="L1483">		} else { // ak je null</span>
<span class="fc" id="L1484">			aID = new int[]{Tools.getIntValue(request.getParameter(&quot;aID&quot;), -1)};</span>
<span class="fc bfc" id="L1485" title="All 2 branches covered.">			if (aID[0] &lt; 0) {</span>
<span class="pc bpc" id="L1486" title="1 of 2 branches missed.">				if(Tools.isNotEmpty(resultUrl))</span>
<span class="fc" id="L1487">						return SpringUrlMapping.redirect(resultUrl + &quot;?fail=1&amp;qID=&quot; + questionID);</span>
				else
<span class="nc" id="L1489">					return fail;</span>
			}
		}

<span class="pc bpc" id="L1493" title="1 of 2 branches missed.">		if (questionID &lt; 0) {</span>
<span class="nc bnc" id="L1494" title="All 2 branches missed.">			if(Tools.isNotEmpty(resultUrl))</span>
<span class="nc" id="L1495">				return SpringUrlMapping.redirect(resultUrl + &quot;?fail=1&amp;qID=&quot; + questionID); //chyba</span>
			else
<span class="nc" id="L1497">				return fail;</span>
		}

<span class="fc" id="L1500">		String docId = request.getParameter(&quot;docId&quot;);</span>
<span class="fc" id="L1501">		String errorDocId = request.getParameter(&quot;errorDocId&quot;);</span>
<span class="fc" id="L1502">		String cookieName = &quot;inquiry-&quot; + questionID;</span>

		//zisti ci nema cookie, ktore by nedovolilo znova kliknut
<span class="fc" id="L1505">		Cookie[] cookies = request.getCookies();</span>
<span class="fc" id="L1506">		int len = 0;</span>
<span class="pc bpc" id="L1507" title="1 of 2 branches missed.">		if (cookies != null) {</span>
<span class="fc" id="L1508">			len = cookies.length;</span>
			Cookie cookie;
<span class="fc bfc" id="L1510" title="All 2 branches covered.">			for (int i = 0; i &lt; len; i++) {</span>
<span class="fc" id="L1511">				cookie = cookies[i];</span>
<span class="fc bfc" id="L1512" title="All 2 branches covered.">				if (cookie.getName().compareTo(cookieName) == 0) {</span>
<span class="pc bpc" id="L1513" title="1 of 2 branches missed.">					if (errorDocId!=null)</span>
<span class="nc" id="L1514">						return SpringUrlMapping.redirect(Tools.sanitizeHttpHeaderParam(&quot;/showdoc.do?docid=&quot; + errorDocId + &quot;&amp;qID=&quot; + questionID + &quot;&amp;aID=&quot; + aID[0]));</span>
					else {
<span class="fc" id="L1516">						request.setAttribute(&quot;answerForm&quot;, InquiryDB.getQuestion(questionID, request));</span>
<span class="pc bpc" id="L1517" title="1 of 2 branches missed.">						if(Tools.isNotEmpty(resultUrl))</span>
<span class="nc" id="L1518">							return SpringUrlMapping.redirect(resultUrl + &quot;?fail=1&amp;qID=&quot; + questionID);</span>
<span class="fc" id="L1519">						else return fail;</span>
					}
				}
			}
		}

<span class="fc" id="L1525">		Cookie cookie = new Cookie(cookieName, &quot;true&quot;);</span>
<span class="fc" id="L1526">		cookie.setMaxAge(3600 * InquiryDB.getHoursCount(questionID, request));</span>
<span class="fc" id="L1527">		cookie.setPath(&quot;/&quot;);</span>

<span class="pc bpc" id="L1529" title="1 of 2 branches missed.">		if (docId!=null) {</span>
<span class="nc" id="L1530">			Tools.addCookie(cookie, response, request);</span>
<span class="nc" id="L1531">			return SpringUrlMapping.redirect(Tools.sanitizeHttpHeaderParam(&quot;/showdoc.do?docid=&quot; + docId + &quot;&amp;qID=&quot; + questionID + &quot;&amp;aID=&quot; + aID[0]));</span>
		} else { //kontrola aj podla IP adresy
<span class="pc bpc" id="L1533" title="2 of 4 branches missed.">			if(user != null &amp;&amp; user.getUserId() &gt; -1) {</span>
				//ak je user prihlaseny
<span class="pc bpc" id="L1535" title="1 of 2 branches missed.">				if(!canVote(user.getUserId(), questionID, request)) {</span>
<span class="nc" id="L1536">					Tools.addCookie(cookie, response,request);</span>
					//overi, ci moze prihlaseny pouzivatel opat hlasovat
<span class="nc" id="L1538">					request.setAttribute(&quot;answerForm&quot;, InquiryDB.getQuestion(questionID, request));</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">					if(Tools.isNotEmpty(resultUrl))</span>
<span class="nc" id="L1540">						return SpringUrlMapping.redirect(resultUrl + &quot;?fail=1&amp;qID=&quot; + questionID); //nemoze zahlasovat</span>
<span class="nc" id="L1541">					else return fail;</span>
				}
			}

<span class="pc bpc" id="L1545" title="1 of 2 branches missed.">			if (!SpamProtection.canPost(&quot;inquiry&quot;, &quot;&quot;, request)) {</span>
<span class="nc" id="L1546">				request.setAttribute(&quot;spam&quot;, &quot;true&quot;);</span>
<span class="nc" id="L1547">				request.setAttribute(&quot;answerForm&quot;, InquiryDB.getQuestion(questionID, request));</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">				if(Tools.isNotEmpty(resultUrl))</span>
<span class="nc" id="L1549">					return SpringUrlMapping.redirect(resultUrl + &quot;?fail=1&amp;spam=1&amp;qID=&quot; + questionID); //nemoze zahlasovat</span>
<span class="nc" id="L1550">				else return fail;</span>
			} else
<span class="fc" id="L1552">				Tools.addCookie(cookie, response,request);</span>

<span class="fc" id="L1554">			java.util.Date date = new java.util.Date();</span>
<span class="fc" id="L1555">			Logger.debug(null, &quot;Pred pridanim&quot;);</span>
<span class="fc bfc" id="L1556" title="All 2 branches covered.">			for (int k = 0; k &lt; aID.length; k++) { //Hlasuje</span>
<span class="fc" id="L1557">				InquiryDB.updateAnswer(questionID, aID[k], request);</span>

<span class="fc" id="L1559">				Logger.debug(null, &quot;Pridavam InquiryUsersVoteEntity&quot;);</span>
<span class="fc" id="L1560">				InquiryUsersVoteEntity iuve = new InquiryUsersVoteEntity();</span>

<span class="pc bpc" id="L1562" title="1 of 2 branches missed.">				if(user == null)  iuve.setUserId(-1);</span>
<span class="fc" id="L1563">				else iuve.setUserId(user.getUserId());</span>

<span class="fc" id="L1565">				iuve.setQuestionId(questionID);</span>
<span class="fc" id="L1566">				iuve.setAnswerId(aID[k]);</span>
<span class="fc" id="L1567">				iuve.setDayDate(date);</span>
<span class="fc" id="L1568">				iuve.setIpAddress(request.getRemoteAddr());</span>
<span class="fc" id="L1569">				iuve.setDomainId(CloudToolsForCore.getDomainId());</span>

<span class="fc" id="L1571">				InquiryStatService.saveInquiryUserVote(iuve);</span>
			}
<span class="fc" id="L1573">			InquiryDB.updateTotalClicks(questionID, request);	//aktualizujem pocet kliknuti</span>

			//START - po zahlasovani vymazem z cache
<span class="fc" id="L1576">			AnswerForm inquiry = InquiryDB.getQuestion(questionID, request);</span>
<span class="fc" id="L1577">			String group = inquiry.getGroup();</span>
<span class="pc bpc" id="L1578" title="1 of 2 branches missed.">			if(Tools.isNotEmpty(group)) {</span>
<span class="fc" id="L1579">				Cache c = Cache.getInstance();</span>
<span class="fc" id="L1580">				String cacheKey = &quot;components.inquiry.group.&quot;+group;</span>
<span class="pc bpc" id="L1581" title="1 of 2 branches missed.">				if(c.getObject(cacheKey) != null)</span>
<span class="nc" id="L1582">					c.removeObject(cacheKey);</span>
			}
			//END

<span class="fc" id="L1586">			request.setAttribute(&quot;answerForm&quot;, inquiry);</span>
<span class="pc bpc" id="L1587" title="1 of 2 branches missed.">			if(Tools.isNotEmpty(resultUrl))</span>
<span class="nc" id="L1588">				return SpringUrlMapping.redirect(resultUrl + &quot;?qID=&quot; + questionID); //ok</span>
<span class="fc" id="L1589">			else return ok;</span>
		}
	}

	private static boolean canVote(int userId, int questionId, HttpServletRequest request) {
<span class="fc" id="L1594">		long wait = 3600L * 1000L * InquiryDB.getHoursCount(questionId, request); // limit v milisekundach - naastavuje</span>
																					// sa v ankete
<span class="fc" id="L1596">		Date createDate = InquiryDB.getLastVoteDate(userId, questionId);</span>
<span class="pc bpc" id="L1597" title="1 of 2 branches missed.">		if (createDate == null)</span>
<span class="nc" id="L1598">			return true; // pouzivatel este vobec nehlasoval v ankete</span>

<span class="fc" id="L1600">		Date nowDate = new Date();</span>
<span class="fc" id="L1601">		long delta = (nowDate.getTime() - createDate.getTime());</span>
<span class="pc bpc" id="L1602" title="1 of 2 branches missed.">		if (delta &lt; wait)</span>
<span class="nc" id="L1603">			return false;</span>
<span class="fc" id="L1604">		return true; // ak je rozdiel vacsi ako nastavena doba cakania</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>