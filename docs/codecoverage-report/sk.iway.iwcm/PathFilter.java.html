<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PathFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm</a> &gt; <span class="el_source">PathFilter.java</span></div><h1>PathFilter.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm;

import org.apache.commons.codec.binary.Base64;
import org.apache.struts.util.TokenProcessor;
import org.springframework.web.util.NestedServletException;
import sk.iway.iwcm.analytics.AnalyticsHelper;
import sk.iway.iwcm.common.*;
import sk.iway.iwcm.components.abtesting.ABTesting;
import sk.iway.iwcm.components.domainRedirects.DomainRedirectDB;
import sk.iway.iwcm.components.response_header.rest.ResponseHeaderService;
import sk.iway.iwcm.dmail.Sender;
import sk.iway.iwcm.doc.DebugTimer;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.ShowDoc;
import sk.iway.iwcm.doc.ninja.Ninja;
import sk.iway.iwcm.filebrowser.EditForm;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.*;
import sk.iway.iwcm.stat.BrowserDetector;
import sk.iway.iwcm.stat.SessionHolder;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.WJResponseWrapper;
import sk.iway.iwcm.system.context.ContextFilter;
import sk.iway.iwcm.system.ntlm.AuthenticationFilter;
import sk.iway.iwcm.system.stripes.CSRF;
import sk.iway.iwcm.users.UsersDB;

import javax.servlet.*;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.servlet.jsp.PageContext;
import java.io.File;
import java.io.IOException;
import java.io.OutputStream;
import java.net.SocketException;
import java.net.URL;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.*;

/**
 * Filter premapovava volania na virtualne adresare a stranky do volani na
 * spravne docid
 *
 * @Title WebJET
 * @Company Interway s.r.o. (www.interway.sk)
 * @Copyright Interway s.r.o. (c) 2001-2002
 * @author Craig McClanahan
 * @version $Revision: 1.4 $ $Date: 2004/03/01 17:03:45 $
 * @created Nede?e, 2002, okt?ber 27
 * @modified $Date: 2004/03/01 17:03:45 $
 */
@SuppressWarnings(&quot;java:S1075&quot;)
<span class="fc" id="L59">public class PathFilter implements Filter</span>
{
	private static final String CHECK_ADMIN_SESSION_KEY = &quot;pathFilter.checkAdmin&quot;;
	private static final String CHECK_WEB_ACCESS_SESSION_KEY = &quot;pathFilter.checkWebAccess&quot;;
	private static final String CHECK_DOMAIN_SESSION_KEY = &quot;pathFilter.checkDomain&quot;;
<span class="fc" id="L64">	private static String customPath = null;</span>
	private static Map&lt;String, EditForm&gt; passwordProtected;
	public static final String REQUEST_START_TIME = &quot;pathFilet.requestStartTime&quot;;

<span class="fc" id="L68">	private static String[] bypassPath = null;</span>
	//pocet sekund cache pre staticky obsah
<span class="fc" id="L70">	private static int cacheStaticContentSeconds = -1;</span>
<span class="fc" id="L71">	private static String[] cacheStaticContentSuffixes = null;</span>

	private static List&lt;ResponseHeaderBean&gt; responseHeaders;

	private static Map&lt;String, DynamicForward&gt; dynamicForwards;

	/**
	 * Inicializacia servletu
	 */
	@Override
	public void init(FilterConfig filterConfig) throws ServletException
	{
		//tu nemozeme pouzivat logger pretoze toto sa vola skor ako zbehne InitServlet
<span class="fc" id="L84">		Logger.info(PathFilter.class, &quot;PathFilter init&quot;);</span>
		try
		{
			//inicializuj password protected
			//robime az v doFilter reloadProtectedDirs();

<span class="fc" id="L90">			PathFilter.setCustomPath(filterConfig.getInitParameter(&quot;customPath&quot;));</span>
			//aby bolo mozne nastavit aj cez -Dwebjet.customPath=...
<span class="fc" id="L92">			String systemParam = System.getProperty(&quot;webjet.customPath&quot;);</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(systemParam)) PathFilter.setCustomPath(systemParam);</span>
<span class="fc" id="L94">			prepareTemplates();</span>
		}
<span class="nc" id="L96">		catch (Exception e)</span>
		{
<span class="nc" id="L98">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L99">		}</span>
<span class="fc" id="L100">	}</span>

	public static void registerDynamicForward(String name, DynamicForward dynamicForward)
	{
<span class="nc bnc" id="L104" title="All 2 branches missed.">		if (dynamicForwards==null) dynamicForwards = Collections.synchronizedMap(new HashMap&lt;String, DynamicForward&gt;());</span>
<span class="nc" id="L105">		dynamicForwards.put(name, dynamicForward);</span>
<span class="nc" id="L106">	}</span>

	public static void unregisterDynamicForward(String name)
	{
<span class="nc bnc" id="L110" title="All 2 branches missed.">		if (dynamicForwards==null) return;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">		if (dynamicForwards.containsKey(name)) dynamicForwards.remove(name);</span>
<span class="nc" id="L112">	}</span>

	public static void prepareTemplates()
	{
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(customPath))</span>
		{
			//tu nemozeme pouzivat logger pretoze toto sa vola skor ako zbehne InitServlet
<span class="nc" id="L119">			Logger.info(PathFilter.class, &quot;PathFilterInit - customPath: &quot; + customPath + File.separatorChar + Constants.getInstallName());</span>
			//skopiruj templates do custom adresara
<span class="nc" id="L121">			File templatesDir = new File(customPath + File.separatorChar + Constants.getInstallName() + File.separatorChar</span>
					+ &quot;/templates/&quot;);
<span class="nc bnc" id="L123" title="All 2 branches missed.">			if (templatesDir.exists())</span>
			{
				File f;
<span class="nc" id="L126">				f = new File(Tools.getRealPath(&quot;/templates/&quot; + Constants.getInstallName() + &quot;/&quot;));</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">				if (f.exists() == false)</span>
				{
					//vytvor adresar
<span class="nc bnc" id="L130" title="All 2 branches missed.">					if(f.mkdirs() == false) return;</span>
				}
<span class="nc" id="L132">				File[] listFiles = templatesDir.listFiles();</span>
<span class="nc" id="L133">				int size = listFiles.length;</span>
				int i;
				File outFile;
<span class="nc bnc" id="L136" title="All 2 branches missed.">				for (i = 0; i &lt; size; i++)</span>
				{
<span class="nc" id="L138">					f = listFiles[i];</span>
					//Logger.println(this,&quot;copy: &quot; + f.getName());
<span class="nc" id="L140">					outFile = new File(Tools.getRealPath(</span>
<span class="nc" id="L141">							&quot;/templates/&quot; + Constants.getInstallName() + &quot;/&quot; + f.getName()));</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">					if (outFile.exists() == false || outFile.lastModified() &lt; f.lastModified())</span>
					{
						//skopiruj subory
<span class="nc" id="L145">						FileTools.copyFile(f, outFile);</span>
					}
				}
			}
		}
<span class="fc" id="L150">	}</span>

	public static String getCustomPath()
	{
<span class="fc" id="L154">		return(customPath);</span>
	}

	/**
	 * Vrati REAL PATH pre zadane URL aj s detekciou Custom Path (pouzitelne len pre staticke subory)
	 * @param url
	 * @return
	 */
	public static String getCustomPathRealPath(String url)
	{
<span class="fc" id="L164">		String realPath = PathFilter.getRealPath(url);</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		if (PathFilter.getCustomPath() != null)</span>
		{
			//skontroluj, ci pozadovany subor nie je custom
<span class="nc" id="L168">			IwcmFile fCusom = new IwcmFile(PathFilter.getCustomPath() + File.separatorChar + Constants.getInstallName() + url.replace('/', File.separatorChar));</span>
<span class="nc bnc" id="L169" title="All 4 branches missed.">			if (fCusom.exists() &amp;&amp; fCusom.canRead()) realPath = fCusom.getAbsolutePath();</span>
		}
<span class="fc" id="L171">		return realPath;</span>
	}

	/**
	 * Take this filter out of service.
	 */
	@Override
	public void destroy()
	{
		//
<span class="fc" id="L181">	}</span>

	/**
	 * Select and set (if specified) the character encoding to be used to
	 * interpret request parameters for this request.
	 *
	 * @param chain
	 *           The filter chain we are processing
	 * @exception IOException
	 *               if an input/output error occurs
	 * @exception ServletException
	 *               if a servlet error occurs
	 */
	@Override
	public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain chain) throws IOException, ServletException
	{
<span class="fc" id="L197">		String path = null;</span>
<span class="fc" id="L198">		DebugTimer timer = null;</span>

<span class="fc" id="L200">		HttpServletRequest req = (HttpServletRequest) servletRequest;</span>
<span class="fc" id="L201">		HttpServletResponse res = (HttpServletResponse) servletResponse;</span>

		try
		{
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">			if (passwordProtected==null) reloadProtectedDirs();</span>

			//System.out.println(&quot;PathFilter.doFilter: &quot;+servletRequest.getClass());
			//System.out.println(&quot;PathFilter.doFilter: &quot;+(servletRequest instanceof HttpServletRequest));

			//req.setCharacterEncoding(&quot;windows-1250&quot;);
			//req.setAttribute(&quot;SetCharacterEncodingFilter.encoding&quot;, &quot;windows-1250&quot;);

<span class="fc" id="L213">			path = req.getRequestURI();</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(req.getContextPath()))</span>
			{
<span class="nc" id="L216">				path = path.substring(req.getContextPath().length());</span>
			}
<span class="fc bfc" id="L218" title="All 2 branches covered.">			if (path.contains(&quot;//&quot;))</span>
			{
<span class="fc" id="L220">				path = Tools.replace(path, &quot;/////&quot;, &quot;/&quot;);</span>
<span class="fc" id="L221">				path = Tools.replace(path, &quot;////&quot;, &quot;/&quot;);</span>
<span class="fc" id="L222">				path = Tools.replace(path, &quot;///&quot;, &quot;/&quot;);</span>
<span class="fc" id="L223">				path = Tools.replace(path, &quot;//&quot;, &quot;/&quot;);</span>
<span class="fc" id="L224">				res.setStatus(302);</span>

<span class="fc" id="L226">				StringBuilder redir = new StringBuilder();</span>
<span class="fc" id="L227">				redir.append(Tools.sanitizeHttpHeaderParam(path));</span>
<span class="fc" id="L228">				String qs = req.getQueryString();</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(qs)) redir.append('?').append(qs);</span>

<span class="fc" id="L231">				res.setHeader(&quot;Location&quot;, redir.toString());</span>
				//res.sendRedirect(path);
<span class="fc" id="L233">				return;</span>
			}

			//Logger.println(this,&quot;query string PATH FILTER=&quot; + req.getQueryString());
<span class="fc" id="L237">			String qs = req.getQueryString();</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">			boolean isFirstPathFilterCall = (req.getAttribute(&quot;path_filter_orig_path&quot;)==null);</span>
<span class="fc" id="L239">			req.setAttribute(&quot;path_filter_query_string&quot;, qs);</span>
<span class="fc" id="L240">			req.setAttribute(&quot;path_filter_orig_path&quot;, path);</span>

<span class="fc" id="L242">			setNginxProxyMode(req, res);</span>
<span class="fc" id="L243">			setXFrameOptions(res);</span>
<span class="fc" id="L244">			setAccessControlAllowOrigin(path, res);</span>
<span class="fc" id="L245">			setXXssProtection(res);</span>
<span class="fc" id="L246">			setFeaturePolicy(res);</span>
<span class="fc" id="L247">			setXRobotsTagValue(path, res);</span>
<span class="fc" id="L248">			setResponseHeaders(path, req, res);</span>

			//blokovanie akcie /showdoc.do
<span class="pc bpc" id="L251" title="1 of 4 branches missed.">			if(path.startsWith(&quot;/showdoc.do&quot;) &amp;&amp; !&quot;*&quot;.equals(Constants.getString(&quot;showDocActionAllowedDocids&quot;)))</span>
			{
<span class="nc" id="L253">				int docId = Tools.getIntValue(req.getParameter(&quot;docid&quot;), -1);</span>
<span class="nc" id="L254">				Identity user = (Identity)req.getSession().getAttribute(Constants.USER_KEY);</span>

<span class="nc bnc" id="L256" title="All 4 branches missed.">				if (Tools.isEmpty(Constants.getString(&quot;showDocActionAllowedDocids&quot;))</span>
<span class="nc bnc" id="L257" title="All 6 branches missed.">						|| ((user == null || !user.isAdmin()) &amp;&amp; path.startsWith(&quot;/showdoc.do&quot;) &amp;&amp; !isShowDocAllowDocId(docId, &quot;showDocActionAllowedDocids&quot;)))</span>
				{
<span class="nc" id="L259">					Adminlog.add(Adminlog.TYPE_CLIENT_SPECIFIC, &quot;Nepovolene pouzitie /showdoc.do docId:&quot;+docId+&quot; showDocActionAllowedDocids : &quot;+ Constants.getString(&quot;showDocActionAllowedDocids&quot;), -1, -1);</span>
<span class="nc" id="L260">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L261">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L262">					return;</span>
				}
			}

<span class="pc bpc" id="L266" title="2 of 6 branches missed.">			if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML &amp;&amp; path.startsWith(&quot;/showdoc.do&quot;) &amp;&amp; isFirstPathFilterCall &amp;&amp;</span>
<span class="pc bpc" id="L267" title="1 of 4 branches missed.">					req.getParameterMap().size()==1 &amp;&amp; req.getParameter(&quot;docid&quot;)!=null		)</span>
			{
				//presmeruj sa na stranku v HTML formate
<span class="fc" id="L270">				int docId = Tools.getIntValue(req.getParameter(&quot;docid&quot;), -1);</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">				if (docId &gt; 0)</span>
				{
<span class="fc" id="L273">					DocDB docDB = DocDB.getInstance();</span>
<span class="pc bpc" id="L274" title="3 of 6 branches missed.">					if (InitServlet.isTypeCloud() || (Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;) &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;)))</span>
					{
<span class="fc" id="L276">						DocDetails doc = DocDB.getInstance().getBasicDocDetails(docId, true);</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">						if (doc!=null)</span>
						{
<span class="fc" id="L279">							GroupDetails group = GroupDetails.getById(doc.getGroupId());</span>
							//MBO: Ak je zapnuty Cloud, otestuje, ci je dany DOC dostupny pre tuto domenu, ak nie, nevykona redirect ale hodi 404
<span class="pc bpc" id="L281" title="2 of 4 branches missed.">							if (group==null || !group.getDomainName().equals(CloudToolsForCore.getDomainName()))</span>
							{
<span class="nc" id="L283">								Logger.debug(PathFilter.class, &quot;DOC ID=&quot;+docId+&quot; is not allowed for domain &quot;+ CloudToolsForCore.getDomainName());</span>
<span class="nc" id="L284">								res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L285">								forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L286">								return;</span>
							}
						}
					}
<span class="fc" id="L290">					String redirPath = docDB.getDocLink(docId, req);</span>

<span class="pc bpc" id="L292" title="2 of 4 branches missed.">					if (redirPath.startsWith(&quot;/showdoc.do&quot;)==false &amp;&amp; Tools.isNotEmpty(redirPath))</span>
					{
<span class="fc" id="L294">						res.setStatus(301);</span>
						//zrusene, pridanie domeny je zbytocne a potom to zle presmerovava ak sme na inom ako 80 porte if (redirPath.toLowerCase().startsWith(&quot;http&quot;)==false) redirPath = Tools.getBaseHref(req)+redirPath;
<span class="fc" id="L296">						res.setHeader(&quot;Location&quot;, redirPath);</span>
						//res.sendRedirect(redirPath);
								/*if (timer != null)		//dead code
								{
									timer.diff(&quot;   Path filter - chain, path: &quot; + path);
									DBPool.getInstance().logConnections();
								}*/
<span class="fc" id="L303">						return;</span>
					}
				}
			}

<span class="pc bpc" id="L308" title="4 of 8 branches missed.">			if (path.indexOf('\'')!=-1 || path.indexOf('&quot;')!=-1 || path.indexOf('\r')!=-1 || path.indexOf('\n')!=-1 ||</span>
<span class="pc bpc" id="L309" title="4 of 8 branches missed.">				path.contains(&quot;%0D&quot;) || path.contains(&quot;%0A&quot;) || path.contains(&quot;%0d&quot;) || path.contains(&quot;%0a&quot;) || //crlf utok</span>
<span class="pc bpc" id="L310" title="3 of 6 branches missed.">				req.getRequestURI().indexOf(&quot;//&quot;)!=-1 || path.indexOf('\\')!=-1 || path.indexOf(&quot;/../&quot;)!=-1)</span>
			{
<span class="nc bnc" id="L312" title="All 2 branches missed.">				if (DocTools.isXssStrictUrlException(path, &quot;xssProtectionStrictGetUrlException&quot;)==false)</span>
				{
					//je to pokus o XSS: /404.html/'onmouseover=prompt(915761)
<span class="nc" id="L315">					Adminlog.add(Adminlog.TYPE_XSS, &quot;XSS path=&quot;+path, -1, -1);</span>
<span class="nc" id="L316">					res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L317">					forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="nc" id="L318">					return;</span>
				}
			}

<span class="fc bfc" id="L322" title="All 2 branches covered.">			if (Tools.replace(path.toLowerCase(), &quot;;jsessionid&quot;, &quot;jsessionid&quot;).contains(&quot;;&quot;))</span>
			{
				//utok typu /;/admin/help/search.jsp, povolene je len ;jsessionid
<span class="fc" id="L325">				res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="fc" id="L326">				forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="fc" id="L327">				return;</span>
			}

			//povolenie swagger-ui / defaultnej stranky Apache CXF (/ws)
<span class="pc bpc" id="L331" title="4 of 8 branches missed.">         if (path.contains(&quot;/swagger&quot;) || path.contains(&quot;/v2/api-docs&quot;) || path.equals(&quot;/ws&quot;) || path.equals(&quot;/ws/&quot;))</span>
         {
<span class="nc" id="L333">            boolean swaggerEnabled = Constants.getBoolean(&quot;swaggerEnabled&quot;);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            if (swaggerEnabled)</span>
            {
               //testni, ci je povoleny aj pre neadmina
<span class="nc bnc" id="L337" title="All 2 branches missed.">               if (Constants.getBoolean(&quot;swaggerRequireAdmin&quot;))</span>
               {
<span class="nc" id="L339">                  Identity user = UsersDB.getCurrentUser(req);</span>
<span class="nc bnc" id="L340" title="All 4 branches missed.">                  if (user==null || user.isAdmin()==false) swaggerEnabled = false;</span>
               }
            }

<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (swaggerEnabled==false)</span>
            {
<span class="nc" id="L346">               Adminlog.add(Adminlog.TYPE_XSS, &quot;Swagger path is not enabled (conf. swaggerEnabled=false), path=&quot;+path, -1, -1);</span>
<span class="nc" id="L347">               res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L348">               forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L349">					return;</span>
            }
         }

<span class="pc bpc" id="L353" title="3 of 6 branches missed.">			if (path.contains(&quot;.DS_Store&quot;) || path.contains(&quot;debug.&quot;) || path.contains(&quot;config.properties&quot;))</span>
			{
<span class="nc" id="L355">				res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L356">				forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L357">				return;</span>
			}

			//pred bypass NESMIE byt citany ziaden parameter!!!
<span class="pc bpc" id="L361" title="1 of 2 branches missed.">			if (&quot;true&quot;.equals(servletRequest.getAttribute(&quot;PathFilter.bypass&quot;)))</span>
			{
				//request ziadno nemodifikujeme
				try
				{
<span class="nc" id="L366">					chain.doFilter(servletRequest, servletResponse);</span>
				}
<span class="nc" id="L368">				catch (SocketException se)</span>
				{
					//toto neriesime
<span class="nc" id="L371">				}</span>
<span class="nc" id="L372">				return;</span>
			}

			//STRICT XSS FILTER (aplikuje sa na vsetky HTTP poziadavky)
<span class="fc" id="L376">			String strictXssRedirect = DocTools.getXssStrictUrlRedirect(req, path, qs);</span>
<span class="fc bfc" id="L377" title="All 2 branches covered.">			if (strictXssRedirect != null)</span>
			{
<span class="fc" id="L379">				res.sendRedirect(strictXssRedirect);</span>
<span class="fc" id="L380">				return;</span>
			}

<span class="fc" id="L383">			req.setAttribute(&quot;path_filter_orig_docid&quot;, req.getParameter(&quot;docid&quot;));</span>

<span class="fc bfc" id="L385" title="All 2 branches covered.">			if (&quot;true&quot;.equals(req.getHeader(&quot;userInServletContext&quot;)))</span>
			{
<span class="fc" id="L387">				Identity user2 = (Identity)Constants.getServletContext().getAttribute(Constants.USER_KEY);</span>
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">				if (user2 != null)</span>
				{
<span class="fc" id="L390">					LogonTools.setUserToSession(req.getSession(), user2);</span>
<span class="fc" id="L391">					req.setAttribute(&quot;NO WJTOOLBAR&quot;, &quot;true&quot;);</span>
				}
			}

			//kontrola IP adries pre web sidlo, ci sa moze zobrazit
<span class="fc bfc" id="L396" title="All 2 branches covered.">			if (!checkWebAccess(req, path))</span>
			{
<span class="fc" id="L398">				Logger.debug(PathFilter.class, &quot;checkWebAccess=false, forbidden access, path=&quot;+path+&quot; ip=&quot;+Tools.getRemoteIP(req));</span>
<span class="fc" id="L399">				res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="fc" id="L400">				forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="fc" id="L401">				return;</span>
			}

			//kontrola na domenove presmerovania
<span class="fc" id="L405">			String serverName = Tools.getServerName(req, false);</span>
<span class="fc" id="L406">			String redir = DomainRedirectDB.translate(serverName, path, req.getQueryString(), Tools.isSecure(req));</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">			if (redir != null)</span>
			{
<span class="nc" id="L409">				res.setStatus(301);</span>
<span class="nc" id="L410">				res.setHeader(&quot;Location&quot;, redir);</span>
<span class="nc" id="L411">				return;</span>
			}

			//System.out.println(&quot;PathFilter.doFilter path=&quot;+path);

<span class="fc" id="L416">			req.setAttribute(REQUEST_START_TIME, System.currentTimeMillis());</span>

<span class="fc" id="L418">			Identity user = (Identity)req.getSession().getAttribute(Constants.USER_KEY);</span>

<span class="pc bpc" id="L420" title="4 of 10 branches missed.">			if (path.startsWith(&quot;/private/rest/&quot;) || path.startsWith(&quot;/rest/private/&quot;) || path.startsWith(&quot;/rest/admin/&quot;) || path.startsWith(&quot;/websocket/private/&quot;) || path.startsWith(&quot;/websocket/admin/&quot;))</span>
			{
<span class="pc bpc" id="L422" title="4 of 6 branches missed.">				if (user == null || ( user.isAdmin()==false &amp;&amp; path.contains(&quot;/admin/&quot;) ))</span>
				{
<span class="nc" id="L424">					Logger.debug(PathFilter.class, &quot;Nepovoleny pristup k REST/WS&quot;);</span>
<span class="nc" id="L425">					res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L426">               return;</span>
				}
			}

            ///// SPRING INTEGRACIA
            // ak sa nezacina na /spring (aby sa to necyklilo) a ak je to url ktoru pozna spring, forwardne to na spring servlet
<span class="pc bpc" id="L432" title="3 of 4 branches missed.">            if (dynamicForwards!=null &amp;&amp; !dynamicForwards.isEmpty())</span>
            {
<span class="nc" id="L434">                boolean adminAccessAllowed = checkAccessToAdmin(path, req, res);</span>
<span class="nc" id="L435">                boolean privateAccessAllowed = true;</span>
<span class="nc bnc" id="L436" title="All 4 branches missed.">                if (path.startsWith(&quot;/private&quot;) &amp;&amp; UsersDB.getCurrentUser(req.getSession())==null) privateAccessAllowed = false;</span>

<span class="nc bnc" id="L438" title="All 2 branches missed.">                for (DynamicForward df : dynamicForwards.values())</span>
                {
<span class="nc bnc" id="L440" title="All 2 branches missed.">                    if (df.isValid(path))</span>
                    {
<span class="nc bnc" id="L442" title="All 4 branches missed.">                        if (adminAccessAllowed &amp;&amp; privateAccessAllowed)</span>
                        {
<span class="nc" id="L444">									boolean returnAfterForward = df.forward(path, req, res);</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">									if (returnAfterForward) return;</span>
<span class="nc" id="L446">                        }</span>
                        else
                        {
                        	//ak nie je user prihlaseny a zacina to na /components a neobsahuje rest, tak posli na 403.jsp kde ho moze redirectnut do admin casti (na logon)
<span class="nc bnc" id="L450" title="All 4 branches missed.">									if (path.startsWith(&quot;/components&quot;) &amp;&amp; path.contains(&quot;rest&quot;)==false)</span>
									{
<span class="nc" id="L452">										res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L453">										forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="nc" id="L454">										return;</span>
									}
<span class="nc" id="L456">                           res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L457">                           return;</span>
                        }
                    }
<span class="nc" id="L460">                }</span>
            }

            //toto musi byt az za Springom, aby pre Spring isli aj ostatne HTTP metody
<span class="pc bpc" id="L464" title="1 of 4 branches missed.">            if (Constants.getBoolean(&quot;enableUnsafeHttpMethods&quot;) == false &amp;&amp; path.contains(&quot;/rest&quot;)==false)</span>
            {
<span class="fc" id="L466">                String method = req.getMethod().toUpperCase();</span>
                //IE zial robi dotaz na SVG aj ako HEAD, takze to musime mat ako vynimku
<span class="pc bpc" id="L468" title="1 of 4 branches missed.">                if (path.endsWith(&quot;.svg&quot;) &amp;&amp; &quot;HEAD&quot;.equals(method)) method = &quot;allowedSVG&quot;;</span>

                //vynimka pre uptimerobot.com, pouzivaju to v statnej sprave
<span class="pc bpc" id="L471" title="3 of 6 branches missed.">                if (&quot;HEAD&quot;.equals(method) || &quot;TRACE&quot;.equals(method) || &quot;OPTIONS&quot;.equals(method))</span>
                {
<span class="nc" id="L473">                    String userAgent = req.getHeader(&quot;User-Agent&quot;);</span>
<span class="nc bnc" id="L474" title="All 4 branches missed.">                    if (Tools.isNotEmpty(userAgent) &amp;&amp; userAgent.contains(&quot;uptimerobot.com&quot;))</span>
                    {
<span class="nc" id="L476">                        method = &quot;allowedUptimerobot&quot;;</span>
                    }
                }

<span class="pc bpc" id="L480" title="3 of 6 branches missed.">                if (&quot;HEAD&quot;.equals(method) || &quot;TRACE&quot;.equals(method) || &quot;OPTIONS&quot;.equals(method))</span>
                {
                    //je to pokus o XSS: /404.html/'onmouseover=prompt(915761)
<span class="nc" id="L483">                    Adminlog.add(Adminlog.TYPE_XSS, &quot;HTTP method not allowed: &quot;+method, -1, -1);</span>
<span class="nc" id="L484">                    res.setStatus(HttpServletResponse.SC_METHOD_NOT_ALLOWED);</span>
<span class="nc" id="L485">                    forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="nc" id="L486">                    return;</span>
                }
            }

<span class="fc" id="L490">			String logLevel = req.getParameter(&quot;_logLevel&quot;);</span>
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">			if (logLevel != null) {</span>
<span class="nc" id="L492">				Logger.setWJLogLevel(logLevel);</span>
			}

<span class="pc bpc" id="L495" title="2 of 14 branches missed.">			if (Logger.isLevel(Logger.DEBUG) &amp;&amp; path.indexOf(&quot;refresher&quot;)==-1 &amp;&amp; (path.endsWith(&quot;.do&quot;) || path.endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;.html&quot;) || path.endsWith(&quot;.js&quot;) || path.endsWith(&quot;.htc&quot;)))</span>
			{
<span class="pc bpc" id="L497" title="2 of 4 branches missed.">				if (req.getParameter(&quot;showPathFilterTime&quot;)!=null || req.getSession().getAttribute(&quot;pathFilter.showPathFilterTime&quot;)!=null)</span>
				{
<span class="nc" id="L499">					req.getSession().setAttribute(&quot;pathFilter.showPathFilterTime&quot;, &quot;true&quot;);</span>
<span class="nc" id="L500">					timer = new DebugTimer(&quot;PathFilter&quot;);</span>
				}
<span class="fc" id="L502">				Logger.debug(PathFilter.class, path);</span>
			}

			//trackovanie videni emailu
<span class="fc" id="L506">			String trackGif = Constants.getString(&quot;dmailTrackopenGif&quot;);</span>
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">			if(Tools.isNotEmpty(trackGif))</span>
			{
<span class="pc bpc" id="L509" title="1 of 2 branches missed.">				if(path.contains(trackGif))</span>
				{
<span class="nc" id="L511">					int emailId = Tools.getIntValue(req.getParameter(&quot;emailId&quot;), -1);</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">					if (emailId &gt; 0)</span>
					{
<span class="nc" id="L514">						EmailToolsForCore.addStatOpen(emailId);</span>
					}
				}
			}

			// url tracking with GA or something else
<span class="fc" id="L520">			AnalyticsHelper.track(path, req);</span>

			//trackovanie kliknuti na linku v emaile
<span class="fc" id="L523">			String dmailStatParamValue = req.getParameter(Constants.getString(&quot;dmailStatParam&quot;));</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">			if (Tools.isNotEmpty(dmailStatParamValue))</span>
			{
<span class="fc" id="L526">				int emailId = Sender.getEmailIdFromClickHash(dmailStatParamValue);</span>
<span class="fc bfc" id="L527" title="All 2 branches covered.">				if (emailId &gt; 0)</span>
				{
<span class="fc" id="L529">					String extURL = req.getParameter(&quot;extURL&quot;);</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(extURL))</span>
					{
<span class="nc bnc" id="L532" title="All 2 branches missed.">						if (extURL.toLowerCase().trim().startsWith(&quot;http&quot;)==false)</span>
						{
							try
							{
<span class="nc" id="L536">								String extURL2 = Tools.replace(extURL, &quot;|&quot;, &quot;=&quot;);</span>
<span class="nc" id="L537">								Base64 b64 = new Base64();</span>
<span class="nc" id="L538">								extURL = new String(b64.decode(extURL2.getBytes()));</span>
							}
<span class="nc" id="L540">							catch (Exception e)</span>
							{
<span class="nc" id="L542">								sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L543">							}</span>
						}
<span class="nc" id="L545">						EmailToolsForCore.addStatClick(emailId, extURL, req.getQueryString(), req, res);</span>
<span class="nc" id="L546">						res.sendRedirect(extURL.replaceAll(&quot;[\r\n]&quot;, &quot;&quot;));</span>
<span class="nc" id="L547">						return;</span>
					}
					else
					{
<span class="fc" id="L551">						EmailToolsForCore.addStatClick(emailId, path, req.getQueryString(), req, res);</span>
					}
				}
			}

			//kontrola jsessionid v URL, vynimka pre .jsessionid. je pre grpd cookie modul kde sa edituje takyto kluc
<span class="pc bpc" id="L557" title="5 of 10 branches missed.">			if (path.toLowerCase().contains(&quot;jsessionid&quot;) || (req.getQueryString()!=null &amp;&amp; req.getQueryString().toLowerCase().contains(&quot;jsessionid&quot;) &amp;&amp; req.getQueryString().toLowerCase().contains(&quot;.jsessionid.&quot;)==false) || req.isRequestedSessionIdFromURL())</span>
			{
<span class="nc" id="L559">				String description = &quot;SESSION using jsessionid INVALIDATING, sessionId=&quot;+req.getSession().getId()+&quot; req IP=&quot;+Tools.getRemoteIP(req);</span>
<span class="nc" id="L560">				Logger.error(PathFilter.class, description);</span>

				//toto stale hlasi acunetix ovs ako neriesene, toto je pokus o riesenie
<span class="nc" id="L563">				req.getSession().invalidate();</span>
<span class="nc" id="L564">				req.getSession(true);</span>

<span class="nc" id="L566">				String pathFixed = path;</span>
<span class="nc" id="L567">				int i = pathFixed.toLowerCase().indexOf(&quot;;jsessionid&quot;);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">				if (i &gt; 0) pathFixed = pathFixed.substring(0, i);</span>

<span class="nc" id="L570">				i = pathFixed.toLowerCase().indexOf(&quot;jsessionid&quot;);</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">				if (i &gt; 0) pathFixed = pathFixed.substring(0, i);</span>

<span class="nc" id="L573">				res.sendRedirect(pathFixed);</span>
<span class="nc" id="L574">				return;</span>
			}

<span class="fc" id="L577">			SessionHolder holder = SessionHolder.getInstance();</span>
<span class="fc" id="L578">			if (</span>
<span class="fc bfc" id="L579" title="All 2 branches covered.">					&quot;get&quot;.equalsIgnoreCase(req.getMethod())==false ||</span>
				 	(
						//for admin apply to all methods
<span class="fc bfc" id="L582" title="All 4 branches covered.">						path.contains(&quot;/admin/&quot;) &amp;&amp; !path.contains(&quot;/scripts/&quot;) &amp;&amp;</span>
<span class="pc bpc" id="L583" title="2 of 12 branches missed.">						(path.contains(&quot;/rest/&quot;) || path.endsWith(&quot;.do&quot;) || path.endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;.html&quot;) || path.endsWith(&quot;/&quot;) || path.endsWith(&quot;.action&quot;))</span>
					) ||
					(
<span class="fc bfc" id="L586" title="All 2 branches covered.">						path.contains(&quot;/rest/&quot;)</span>
					)
				)
			{
				//	setni data pre SessionListener - admin cast (ostatne stranky su az dole)
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">				if (holder.set(req.getSession().getId(), path, req)==false)</span>
				{
					//nastalo session stealing, spravime redirect aby nenastavali exception v JSP

<span class="nc" id="L595">					StringBuilder redirPath = new StringBuilder(path);</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">					if (Tools.isNotEmpty(req.getQueryString())) redirPath.append('?').append(req.getQueryString());</span>

<span class="nc" id="L598">					res.sendRedirect(Tools.sanitizeHttpHeaderParam(redirPath.toString()));</span>
<span class="nc" id="L599">					return;</span>
				}
			}

<span class="fc bfc" id="L603" title="All 2 branches covered.">			if (path.startsWith(&quot;/admin&quot;))</span>
			{
<span class="fc" id="L605">				boolean ret = checkAdmin(req);</span>
<span class="pc bpc" id="L606" title="1 of 2 branches missed.">				if (!ret)</span>
				{
<span class="nc" id="L608">					Logger.debug(PathFilter.class, &quot;checkAdmin=&quot;+ret+&quot; forwarding to 404.jsp&quot;);</span>
					//not found posielame aby sa admin cast tvarila akoze vobec neexistuje
<span class="nc" id="L610">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L611">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L612">					return;</span>
				}
				else
				{
					// cesta /admin/statchart je tam kvoli generovaniu PDF aby ho bolo mozne unsecure embednut
<span class="pc bpc" id="L617" title="5 of 6 branches missed.">					if (Constants.getBoolean(&quot;adminRequireSSL&quot;) &amp;&amp; Tools.isSecure(req) == false &amp;&amp; path.indexOf(&quot;/admin/statchart&quot;)==-1)</span>
					{
<span class="nc" id="L619">						String httpsRedirectUrl = PathFilter.getHttpsRedirectUrl(req);</span>
<span class="nc" id="L620">						Logger.debug(PathFilter.class, &quot;Redirect (adminRequireSSL): &quot; + httpsRedirectUrl);</span>
<span class="nc" id="L621">						res.sendRedirect(httpsRedirectUrl);</span>
<span class="nc" id="L622">						return;</span>
					}
				}

				//#37426 CSRF ochrana Struts formularov
<span class="fc bfc" id="L627" title="All 2 branches covered.">				if (req.getSession().getAttribute(&quot;org.apache.struts.action.TOKEN&quot;)==null)</span>
				{
					//vygeneruj token, kedze struts u nas konci vygenerujem len jeden token do session
<span class="fc" id="L630">					TokenProcessor.getInstance().saveToken(req);</span>
				}
<span class="pc bpc" id="L632" title="5 of 8 branches missed.">				else if (path.endsWith(&quot;.do&quot;) &amp;&amp; &quot;post&quot;.equalsIgnoreCase(req.getMethod()) &amp;&amp; (req.getContentType()==null || req.getContentType().contains(&quot;multipart&quot;)==false))</span>
				{
<span class="nc bnc" id="L634" title="All 2 branches missed.">				   if (DocTools.isXssStrictUrlException(path, &quot;xssProtectionStrictPostUrlException&quot;)==false)</span>
					{
						//validuj token
<span class="nc" id="L637">						boolean isTokenValid = TokenProcessor.getInstance().isTokenValid(req, false);</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">						if (isTokenValid == false)</span>
						{
<span class="nc" id="L640">						   Logger.info(PathFilter.class, &quot;Struts token not valid, path=&quot;+path);</span>
<span class="nc" id="L641">							req.setAttribute(&quot;errorText&quot;, Prop.getInstance(req).getText(&quot;components.csrfError&quot;));</span>
<span class="nc" id="L642">							forwardSafely(&quot;/components/maybeError.jsp&quot;, req, res);</span>
<span class="nc" id="L643">							return;</span>
						}
					}
				}
			}

<span class="fc bfc" id="L649" title="All 2 branches covered.">			if (!checkCSRFToken(path, req)) {</span>
<span class="fc" id="L650">				Logger.debug(PathFilter.class, &quot;CSRF token missing - header param X-CSRF-Token&quot;);</span>
<span class="fc" id="L651">				res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="fc" id="L652">				forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
<span class="fc" id="L653">				return;</span>
			}

			//skus prihlasit usera (ak treba)
<span class="pc bpc" id="L657" title="2 of 6 branches missed.">			if (&quot;true&quot;.equals(req.getParameter(&quot;doFilterLogon&quot;)) || &quot;redir&quot;.equals(req.getParameter(&quot;doFilterLogon&quot;)) || Tools.isNotEmpty(req.getHeader(&quot;wjlogontoken&quot;)))</span>
			{
<span class="fc bfc" id="L659" title="All 2 branches covered.">				if (user == null)</span>
				{
<span class="fc" id="L661">					String username = req.getParameter(&quot;username&quot;);</span>
<span class="fc" id="L662">					String password = req.getParameter(&quot;password&quot;);</span>

<span class="fc" id="L664">					String token = req.getParameter(&quot;token&quot;);</span>
<span class="pc bpc" id="L665" title="1 of 2 branches missed.">					if (token == null) token = req.getHeader(&quot;wjlogontoken&quot;);</span>
<span class="pc bpc" id="L666" title="3 of 6 branches missed.">					if (Tools.isEmpty(username) &amp;&amp; Tools.isEmpty(password) &amp;&amp; Tools.isNotEmpty(token))</span>
					{
						try
						{
							//toto je len finta, token zacina na NAHODNY ZNAK aby to nebolo na prvy pohlad base64 automaticky dekodovatelne
<span class="fc" id="L671">							token = Tools.replace(token, &quot;|&quot;, &quot;=&quot;).substring(1);</span>
<span class="fc" id="L672">							Base64 b64 = new Base64();</span>
<span class="fc" id="L673">							token = new String(b64.decode(token.getBytes()));</span>
<span class="fc" id="L674">							int i = token.indexOf(&quot;:&quot;);</span>
<span class="pc bpc" id="L675" title="1 of 2 branches missed.">							if (i&gt;0)</span>
							{
<span class="fc" id="L677">								username = token.substring(0, i);</span>
<span class="fc" id="L678">								password = token.substring(i+1);</span>
							}
						}
<span class="pc" id="L681">						catch (Exception ex) {}</span>
					}

<span class="pc bpc" id="L684" title="2 of 4 branches missed.">					if (Tools.isNotEmpty(username) &amp;&amp; Tools.isNotEmpty(password))</span>
					{
<span class="fc" id="L686">						user = new Identity();</span>
<span class="fc" id="L687">						Map&lt;String, String&gt; errors = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L688">						sk.iway.iwcm.i18n.Prop prop = sk.iway.iwcm.i18n.Prop.getInstance(Constants.getServletContext(), req);</span>
<span class="fc" id="L689">						String forward = LogonTools.logon(username, password, user, errors, req, prop);</span>

<span class="pc bpc" id="L691" title="1 of 2 branches missed.">						if (req.getAttribute(&quot;logon.err.noadmin&quot;)!=null)</span>
						{
								//nie je to admin, prihlasme ho ako normalneho usera, ak to zbehne, bude user v session
<span class="nc" id="L694">								LogonTools.logonUser(req, username, password);</span>
						}
<span class="pc bpc" id="L696" title="2 of 6 branches missed.">						else if (forward.compareTo(&quot;logon_ok_admin&quot;) != 0 || user == null || user.isAdmin() == false)</span>
						{
<span class="fc" id="L698">							user = null;</span>
						}
						else
						{
<span class="fc" id="L702">							user.setLoginName(username);</span>
<span class="fc" id="L703">							user.setPassword(UserTools.PASS_UNCHANGED);</span>
<span class="fc" id="L704">							user.setValid(true);</span>
							//je korektne prihlaseny
<span class="fc" id="L706">							LogonTools.setUserToSession(req.getSession(), user);</span>
<span class="fc" id="L707">							req.setAttribute(&quot;NO WJTOOLBAR&quot;, &quot;true&quot;);</span>
						}

<span class="pc bpc" id="L710" title="1 of 2 branches missed.">						if (&quot;redir&quot;.equals(req.getParameter(&quot;doFilterLogon&quot;)))</span>
						{
<span class="nc" id="L712">							res.sendRedirect(path);</span>
<span class="nc" id="L713">							return;</span>
						}
					}
				}
			}

			/*
			  Kontrola pristupu do admin casti (#10398)
			 */
<span class="fc bfc" id="L722" title="All 2 branches covered.">			if (!checkAccessToAdmin(path, req, res))</span>
			{
<span class="pc bpc" id="L724" title="3 of 6 branches missed.">				if (path.equals(&quot;/admin/refresher.jsp&quot;) == false &amp;&amp; path.equals(&quot;/admin/rest/refresher&quot;) == false &amp;&amp; path.equals(&quot;/admin/rest/monitoring/actual&quot;) == false)</span>
				{
<span class="fc" id="L726">					Adminlog.add(Adminlog.TYPE_XSS, &quot;Pouzivatel nema pristup do admin casti, presmerovavam na prihlasenie&quot;, -1, -1);</span>
				}

				//ak je to nieco ako /admin.zip /admin~ /admin_backup tak nepresmeruj ale daj chybu
<span class="pc bpc" id="L730" title="1 of 6 branches missed.">				if (path.startsWith(&quot;/admin&quot;) &amp;&amp; path.indexOf(&quot;/&quot;, 4)==-1 &amp;&amp; path.length()&gt;6) {</span>
<span class="nc" id="L731">					Logger.debug(PathFilter.class, &quot;Is file like, forwarding to 404.jsp&quot;);</span>
					//not found posielame aby sa admin cast tvarila akoze vobec neexistuje
<span class="nc" id="L733">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L734">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L735">					return;</span>
				}

				//na public node rovno vyhlasme 404, tiez pre nepovolene IP adresy
<span class="pc bpc" id="L739" title="2 of 4 branches missed.">				if (&quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;)) || checkAdmin(req)==false)</span>
				{
<span class="nc" id="L741">					Logger.debug(PathFilter.class, &quot;Public node, forwarding to 404.jsp&quot;);</span>
					//not found posielame aby sa admin cast tvarila akoze vobec neexistuje
<span class="nc" id="L743">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L744">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L745">					return;</span>
				}

<span class="fc" id="L748">				Logger.println(PathFilter.class, &quot;Pouzivatel nema pristup do admin casti, presmerovavam na prihlasenie, path=&quot;+path + &quot; allowedUrls=&quot;+ Constants.getString(&quot;allowAdminUrls&quot;));</span>

<span class="fc" id="L750">            	LogonTools.saveAfterLogonRedirect(req);</span>

<span class="fc" id="L752">				String domainController = AuthenticationFilter.getDomainController();</span>
<span class="pc bpc" id="L753" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(domainController))</span>
				{
<span class="nc" id="L755">					res.sendRedirect(&quot;/ntlm/logon.do?admin=true&quot;);</span>
				}
<span class="pc bpc" id="L757" title="1 of 2 branches missed.">				else if (path.startsWith(&quot;/admin/m/&quot;))</span>
				{
<span class="nc" id="L759">					res.sendRedirect(&quot;/admin/m/logon.jsp&quot;);</span>
				}
				else
				{
<span class="fc" id="L763">					res.sendRedirect(ContextFilter.addContextPath(req.getContextPath(), &quot;/admin/logon/&quot;));</span>
				}
<span class="fc" id="L765">				return;</span>
			}

<span class="fc bfc" id="L768" title="All 4 branches covered.">			if (path.toLowerCase().endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;/&quot;))</span>
			{
<span class="pc bpc" id="L770" title="2 of 6 branches missed.">				if (path.startsWith(&quot;/images&quot;) || path.startsWith(&quot;/files&quot;) || path.startsWith(&quot;/shared&quot;))</span>
				{
<span class="fc" id="L772">					Logger.debug(PathFilter.class, &quot;Volane JSP z nepovoleneho adresara, path=&quot;+path);</span>
					//not found posielame aby sa admin cast tvarila akoze vobec neexistuje
<span class="fc" id="L774">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="fc" id="L775">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="fc" id="L776">					return;</span>
				}
			}

<span class="pc bpc" id="L780" title="1 of 2 branches missed.">			if (path.endsWith(&quot;.appcache&quot;))</span>
			{
				//handlovanie zapnutia online modu pre appcache
<span class="nc" id="L783">				String appcacheMode = Tools.getCookieValue(req.getCookies(), &quot;appcacheMode&quot;, null);</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">				if (&quot;online&quot;.equals(appcacheMode))</span>
				{
<span class="nc" id="L786">					Cookie c = new Cookie(&quot;appcacheMode&quot;, &quot;&quot;);</span>
<span class="nc" id="L787">					c.setPath(&quot;/&quot;);</span>
<span class="nc" id="L788">					c.setMaxAge(-1);</span>
<span class="nc" id="L789">					c.setHttpOnly(false);</span>
<span class="nc" id="L790">					Tools.addCookie(c, res, req);</span>

<span class="nc" id="L792">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L793">					return;</span>
				}
<span class="nc bnc" id="L795" title="All 2 branches missed.">				else if (req.getSession().getAttribute(Constants.USER_KEY)==null)</span>
				{
					//toto nastane, ked user nie je prihlaseny, nemozeme vtedy poslat obsah suboru, lebo sa nacachuje zoznam ako neprihlaseny user
<span class="nc" id="L798">					Logger.debug(PathFilter.class, &quot;User not logged &quot; + path);</span>
<span class="nc" id="L799">					res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
<span class="nc" id="L800">					return;</span>
				}
			}

			//skontroluj password protected
<span class="fc" id="L805">			EditForm ef = isPasswordProtected(path, req);</span>
<span class="fc bfc" id="L806" title="All 4 branches covered.">			if (ef != null &amp;&amp; ef.isAccessibleFor(user)==false)</span>
			{
<span class="pc bpc" id="L808" title="1 of 2 branches missed.">				if (doFileForbiddenRedirect(ef, user, path, req, res)) return;</span>
			}

<span class="pc bpc" id="L811" title="1 of 6 branches missed.">			if (path.contains(&quot;admin/&quot;) &amp;&amp; (path.endsWith(&quot;.js&quot;) || path.endsWith(&quot;.html&quot;)))</span>
			{
				//otestuj, ci existuje JSP nahrada
<span class="fc" id="L814">				File f = new File(Tools.getRealPath(path+&quot;.jsp&quot;));</span>
<span class="pc bpc" id="L815" title="3 of 4 branches missed.">				if (f.exists() &amp;&amp; f.canRead())</span>
				{
<span class="nc" id="L817">					f = null;</span>

<span class="nc" id="L819">					res.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="nc" id="L820">					res.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="nc" id="L821">					res.setHeader(&quot;Cache-Control&quot;,&quot;no-Cache&quot;);</span>

<span class="nc" id="L823">					Logger.debug(PathFilter.class, &quot;Forwarding: &quot;+path+&quot;.jsp&quot;);</span>

<span class="nc" id="L825">					forwardSafely(path+&quot;.jsp&quot;, req, res);</span>
<span class="nc" id="L826">					return;</span>
				}
			}
<span class="fc bfc" id="L829" title="All 2 branches covered.">			if (path.endsWith(&quot;.jsp&quot;))</span>
			{
<span class="fc" id="L831">				res.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="fc" id="L832">				res.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="fc" id="L833">				res.setHeader(&quot;Cache-Control&quot;,&quot;no-Cache&quot;);</span>
			}

			//nastav kodovanie JS suborom
<span class="fc bfc" id="L837" title="All 4 branches covered.">			if (path.indexOf(&quot;admin/&quot;)==-1 &amp;&amp; path.endsWith(&quot;.js&quot;))</span>
			{
<span class="fc" id="L839">				IwcmFile f = new IwcmFile(Tools.getRealPath(path));</span>

				//otestuj, ci existuje nahrada
<span class="fc" id="L842">				File fNahrada = new File(Tools.getRealPath(path+&quot;.jsp&quot;));</span>
<span class="pc bpc" id="L843" title="1 of 4 branches missed.">				if (fNahrada.exists() &amp;&amp; fNahrada.canRead())</span>
				{
					//jsp subor by mal nastavit kodovanie spravne
					//f = fNahrada;
					//tu nespravime nic, musi sa to sprocesovat ako JSP
				}
				else
				{
<span class="fc" id="L851">					IwcmFile fCusom = null;</span>
<span class="pc bpc" id="L852" title="1 of 2 branches missed.">					if (customPath != null)</span>
					{
						//skontroluj, ci pozadovany subor nie je custom
<span class="nc" id="L855">						fCusom = new IwcmFile(customPath + File.separatorChar + Constants.getInstallName() + path.replace('/', File.separatorChar));</span>
<span class="nc bnc" id="L856" title="All 4 branches missed.">						if (fCusom.exists() &amp;&amp; fCusom.canRead()) f = fCusom;</span>
					}
<span class="fc" id="L858">					String customUrl = WriteTagToolsForCore.getCustomPageNull(path, req);</span>
<span class="pc bpc" id="L859" title="1 of 2 branches missed.">					if (customUrl != null)</span>
					{
<span class="nc" id="L861">						fCusom = new IwcmFile(Tools.getRealPath(customUrl));</span>
<span class="nc bnc" id="L862" title="All 4 branches missed.">						if (fCusom.exists() &amp;&amp; fCusom.canRead()) f = fCusom;</span>
					}

<span class="pc bpc" id="L865" title="1 of 4 branches missed.">					if (f.exists() &amp;&amp; f.canRead())</span>
					{
<span class="fc" id="L867">						sk.iway.iwcm.Encoding.setResponseEnc(req, res, &quot;text/javascript&quot;);</span>
<span class="fc" id="L868">						boolean staticHeadersSet = setStaticContentHeaders(path, user, req, res);</span>
<span class="fc" id="L869">						setXRobotsTagValue(path, res);</span>

<span class="pc bpc" id="L871" title="2 of 6 branches missed.">						if (staticHeadersSet &amp;&amp; IwcmFsDB.useDBStorage()==false &amp;&amp; FileCache.useFileCache())</span>
						{
<span class="nc bnc" id="L873" title="All 2 branches missed.">							if (writeAndCacheFile(path, res)) return;</span>
						}
<span class="fc" id="L875">						FilePathTools.writeFileOut(f, req, res);</span>
<span class="pc bpc" id="L876" title="1 of 2 branches missed.">						if (timer != null)</span>
						{
<span class="nc" id="L878">							timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L879">							DBPool.getInstance().logConnections();</span>
						}

<span class="fc" id="L882">						return;</span>
					}
				}
			}

			//posielaj admin/v9/dist/ alebo /admin/elFinder adresar ako utf-8
<span class="fc bfc" id="L888" title="All 8 branches covered.">			if ((path.startsWith(&quot;/admin/v9/dist&quot;) || path.startsWith(&quot;/admin/elFinder&quot;)) &amp;&amp; (path.endsWith(&quot;.js&quot;) || path.endsWith(&quot;.css&quot;)))</span>
			{
<span class="fc" id="L890">				IwcmFile f = new IwcmFile(Tools.getRealPath(path));</span>
<span class="pc bpc" id="L891" title="2 of 4 branches missed.">				if (f.exists() &amp;&amp; f.canRead())</span>
				{
<span class="fc" id="L893">					String encoding = &quot;text/javascript&quot;;</span>
<span class="fc bfc" id="L894" title="All 2 branches covered.">					if (path.endsWith(&quot;.css&quot;)) encoding = &quot;text/css&quot;;</span>
<span class="fc" id="L895">					sk.iway.iwcm.Encoding.setResponseEnc(req, res, encoding);</span>
<span class="fc" id="L896">					setStaticContentHeaders(path, user, req, res);</span>
<span class="fc" id="L897">					setXRobotsTagValue(path, res);</span>

					//Logger.debug(PathFilter.class, &quot;Sending DIST file: &quot; + f.getAbsolutePath());
<span class="fc" id="L900">					FilePathTools.writeFileOut(f, req, res);</span>

<span class="fc" id="L902">					return;</span>
				}
			}

<span class="fc" id="L906">         	setDownloadHeaders(path, req, res);</span>
<span class="fc" id="L907">			boolean staticHeadersSet = setStaticContentHeaders(path, user, req, res);</span>
<span class="pc bpc" id="L908" title="2 of 6 branches missed.">			if (staticHeadersSet &amp;&amp; IwcmFsDB.useDBStorage()==false &amp;&amp; FileCache.useFileCache())</span>
			{
<span class="nc bnc" id="L910" title="All 2 branches missed.">				if (writeAndCacheFile(path, res)) return;</span>
			}

			//toto standardne Tomcat nepozna, pridame hlavicky podla specky
<span class="pc bpc" id="L914" title="1 of 4 branches missed.">			if (path.endsWith(&quot;.woff2&quot;) || path.endsWith(&quot;.woff&quot;))</span>
			{
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">				if (path.endsWith(&quot;.woff2&quot;)) res.setHeader(&quot;Content-Type&quot;, &quot;font/woff2&quot;);</span>
<span class="nc" id="L917">				else res.setHeader(&quot;Content-Type&quot;, &quot;font/woff&quot;);</span>
			}

			//disable direct call to abtesting variant URL eg. /investicie/abtestvariantb.html for NON admin users
<span class="fc bfc" id="L921" title="All 2 branches covered.">			if (path.contains(Constants.getString(&quot;ABTestingName&quot;)))</span>
			{
<span class="fc bfc" id="L923" title="All 2 branches covered.">				if (Constants.getBoolean(&quot;ABTestingAllowVariantUrl&quot;)==false) {</span>
<span class="pc bpc" id="L924" title="1 of 4 branches missed.">					if (user == null || user.isAdmin()==false) {</span>
<span class="fc" id="L925">						Logger.debug(PathFilter.class, &quot;ABTesting direct call, not allowed for non admin, forwarding to 404.jsp&quot;);</span>
<span class="fc" id="L926">						res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="fc" id="L927">						forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="fc" id="L928">						return;</span>
					}
				} else {
					//prefer URL variant instead of cookie value
<span class="fc" id="L932">					req.setAttribute(&quot;ABTestingPrefferVariantUrl&quot;, &quot;true&quot;);</span>
				}
			}

			//accessDocId je docId web stranky, ktoru sa zobrazuje, ku ktorej sa pristupuje z verejnej casti sidla, nie admin cast
<span class="fc" id="L937">			DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L938">			String domain = DocDB.getDomain(req);</span>
<span class="fc" id="L939">			int accessDocId = -1;</span>
			//files adresar musime nechat povoleny kvoli linkam z fulltext indexu (/files/subor.xls.html) a presmerovaniu na subor.xls
<span class="pc bpc" id="L941" title="1 of 8 branches missed.">			if (path.startsWith(&quot;/images&quot;)==false &amp;&amp; path.startsWith(&quot;/css&quot;)==false &amp;&amp; path.startsWith(&quot;/jscripts&quot;)==false &amp;&amp; path.startsWith(&quot;/templates&quot;)==false)</span>
			{
<span class="pc bpc" id="L943" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;ABTesting&quot;)==true)</span>
				{
<span class="fc" id="L945">					accessDocId = ABTesting.getVirtualPathDocId(path, domain, req, res);</span>
				}
				else
				{
					//upravene takto ak nie je vobec abtesting trieda dostupna (napr. v cloude)
<span class="nc" id="L950">					accessDocId = docDB.getVirtualPathDocId(path, domain);</span>
				}
			}

<span class="fc bfc" id="L954" title="All 2 branches covered.">			if (accessDocId &gt; 0)</span>
			{
				//kontrola spravnosti domeny
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">				if (!checkDomain(req))</span>
				{
<span class="nc" id="L959">					Logger.debug(PathFilter.class, &quot;checkDomain=false, forwarding to 404.jsp&quot;);</span>
<span class="nc" id="L960">					res.setStatus(HttpServletResponse.SC_NOT_FOUND);</span>
<span class="nc" id="L961">					forwardSafely(&quot;/404.jsp&quot;, req, res);</span>
<span class="nc" id="L962">					return;</span>
				}

				//porovnaj URL a pripadne sprav redirect
<span class="fc" id="L966">				String realUrl = docDB.getDocLink(accessDocId, req);</span>
<span class="pc bpc" id="L967" title="1 of 6 branches missed.">				if (realUrl!=null &amp;&amp; realUrl.equals(path)==false &amp;&amp; !realUrl.contains(Constants.getString(&quot;ABTestingName&quot;)))</span>
				{
					//URL so znakom * sa odstranuju, musime specialne skontrolovat
<span class="fc" id="L970">					String virtualPath = docDB.getBasicDocDetails(accessDocId, true).getVirtualPath();</span>
<span class="pc bpc" id="L971" title="1 of 4 branches missed.">					if (virtualPath == null || virtualPath.indexOf(&quot;*&quot;)==-1)</span>
					{
<span class="fc" id="L973">						Logger.debug(PathFilter.class, &quot;nesedi real URL, redirecting to: &quot;+realUrl);</span>
<span class="fc" id="L974">						res.setStatus(301);</span>
<span class="pc bpc" id="L975" title="1 of 2 branches missed.">						if (Tools.isNotEmpty(req.getQueryString())) realUrl += '?'+req.getQueryString();</span>
<span class="pc bpc" id="L976" title="1 of 2 branches missed.">						if (realUrl.toLowerCase().startsWith(&quot;http&quot;)==false) realUrl = Tools.getBaseHref(req)+realUrl;</span>
<span class="fc" id="L977">						res.setHeader(&quot;Location&quot;, Tools.sanitizeHttpHeaderParam(realUrl));</span>
<span class="fc" id="L978">						return;</span>
					}
				}

				//	setni data pre SessionListener - customer cast
<span class="fc" id="L983">				String lastURL = path;</span>
<span class="fc bfc" id="L984" title="All 2 branches covered.">				if (req.getQueryString()!=null)</span>
				{
<span class="fc" id="L986">					path = path + &quot;?&quot; + req.getQueryString();</span>
				}

<span class="pc bpc" id="L989" title="1 of 2 branches missed.">				if (holder.set(req.getSession().getId(), lastURL, req)==false)</span>
				{
					//nastalo session stealing, spravime redirect aby nenastavali exception v JSP

<span class="nc" id="L993">					StringBuilder redirPath = new StringBuilder(path);</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">					if (Tools.isNotEmpty(req.getQueryString())) redirPath.append('?').append(req.getQueryString());</span>

<span class="nc" id="L996">					res.sendRedirect(Tools.sanitizeHttpHeaderParam(redirPath.toString()));</span>
<span class="nc" id="L997">					return;</span>
				}

				//akoze skuska ochrany pred chybou Cannot create a session after the response has been committed
<span class="fc bfc" id="L1001" title="All 2 branches covered.">				if (req.getSession().getAttribute(&quot;preventCannotCreateSession&quot;)==null)</span>
				{
<span class="fc" id="L1003">					req.getSession().setAttribute(&quot;preventCannotCreateSession&quot;, &quot;1&quot;);</span>
				}

				//Logger.println(this,&quot;forwarding to docId: &quot; + docId);
<span class="fc" id="L1007">				StringBuilder url = new StringBuilder(&quot;/showdoc.do?docid=&quot;).append(accessDocId);</span>

<span class="fc bfc" id="L1009" title="All 2 branches covered.">				if (&quot;get&quot;.equalsIgnoreCase(req.getMethod()))</span>
				{
					String name;
					String[] values;
<span class="fc" id="L1013">					Enumeration&lt;String&gt; params = req.getParameterNames();</span>
<span class="fc bfc" id="L1014" title="All 2 branches covered.">					while (params.hasMoreElements())</span>
					{
<span class="fc" id="L1016">						name = params.nextElement();</span>
<span class="pc bpc" id="L1017" title="1 of 4 branches missed.">						if (name.equals(&quot;docid&quot;) || name.equals(&quot;password&quot;)) continue;</span>
<span class="fc" id="L1018">						values = req.getParameterValues(name);</span>
<span class="fc bfc" id="L1019" title="All 2 branches covered.">						for (int i = 0; i &lt; values.length; i++)</span>
						{
<span class="fc" id="L1021">							url.append(&quot;&amp;&quot;).append(Tools.sanitizeHttpHeaderParam(name)).append('=').append(Tools.sanitizeHttpHeaderParam(values[i]));</span>
						}
					}
				}

<span class="fc" id="L1026">				Logger.debug(PathFilter.class, &quot;PathFilter, url: &quot; + url + &quot; domain=&quot;+domain+&quot; origUrl=&quot;+path+&quot; qs=&quot;+req.getQueryString());</span>
<span class="pc bpc" id="L1027" title="9 of 10 branches missed.">				if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML || path.endsWith(&quot;.php&quot;) || path.endsWith(&quot;.asp&quot;) || path.endsWith(&quot;.aspx&quot;) || Constants.getBoolean(&quot;forwardVirtualPath&quot;))</span>
				{
<span class="fc" id="L1029">					req.setAttribute(&quot;docid&quot;, Integer.toString(accessDocId));</span>
<span class="fc" id="L1030">					Logger.debug(PathFilter.class, &quot;forwarding1: req=&quot; + req + &quot; resp=&quot;+res);</span>

<span class="fc" id="L1032">					String packagerMode = Constants.getString(&quot;packagerMode&quot;);</span>
<span class="fc" id="L1033">					String packagerModeParam = req.getParameter(&quot;_packagerMode&quot;);</span>
<span class="pc bpc" id="L1034" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(packagerModeParam)) packagerMode = packagerModeParam;</span>

<span class="pc bpc" id="L1036" title="3 of 4 branches missed.">					if (Tools.isEmpty(packagerMode) || &quot;none&quot;.endsWith(packagerMode))</span>
					{
<span class="fc" id="L1038">						req.getRequestDispatcher(&quot;/showdoc.do?docid=&quot; + accessDocId).forward(req, res);</span>
					}
					else
					{
<span class="nc" id="L1042">						long start = Tools.getNow();</span>

<span class="nc" id="L1044">						WJResponseWrapper respWrapper = new WJResponseWrapper(res, req);</span>
<span class="nc" id="L1045">						req.getRequestDispatcher(&quot;/showdoc.do?docid=&quot; + accessDocId).forward(req, respWrapper);</span>
<span class="nc" id="L1046">						StringBuilder htmlCode = new StringBuilder(respWrapper.strWriter.getBuffer().toString());</span>

<span class="nc" id="L1048">						String fixedHtml = htmlCode.toString();</span>

						//moznost prepnutia packagera (pre kazdy pripad)
<span class="nc" id="L1051">						String packagerModeAttr = (String)req.getAttribute(&quot;packagerMode&quot;);</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">						if (packagerModeAttr!=null) packagerMode = packagerModeAttr;</span>

						//ak je treba posli redirect
<span class="nc bnc" id="L1055" title="All 2 branches missed.">						if (Tools.isNotEmpty(respWrapper.getRedirectURL())) res.sendRedirect(respWrapper.getRedirectURL());</span>

<span class="nc" id="L1057">						long end = Tools.getNow();</span>
<span class="nc" id="L1058">						Logger.debug(PathFilter.class, &quot;Packager: HTML packaging tooks: &quot; + (end-start) + &quot;ms&quot;);</span>

						//zapis vystup
<span class="nc" id="L1061">						respWrapper.writeResponseToOriginalOutput(req, fixedHtml);</span>
					}
<span class="fc" id="L1063">				}</span>
				else
				{
<span class="nc" id="L1066">					Logger.debug(PathFilter.class, &quot;redirecting: req=&quot;+req+&quot; resp=&quot;+res);</span>
<span class="nc" id="L1067">					res.sendRedirect(req.getContextPath() + url.toString());</span>
				}
<span class="pc bpc" id="L1069" title="1 of 2 branches missed.">				if (timer != null)</span>
				{
<span class="nc" id="L1071">					timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1072">					DBPool.getInstance().logConnections();</span>
				}
<span class="fc" id="L1074">				return;</span>
			}
			else
			{
<span class="fc bfc" id="L1078" title="All 2 branches covered.">				if (&quot;/sitemap.xml&quot;.equals(path))</span>
				{
					//nie je definovana stranka s URL /sitemap.xml, priamo forwardnem
					//je to tu kvoli cloudu, pretoze do 404.jsp uz dorazi request a nema RequestBean (zjavne sa to vola az po skonceni filtrov)
<span class="fc" id="L1082">					res.setContentType(&quot;text/xml; charset=utf-8&quot;);</span>
<span class="fc" id="L1083">					res.setStatus(HttpServletResponse.SC_OK);</span>
<span class="fc" id="L1084">					String customPage = WriteTagToolsForCore.getCustomPage(&quot;/components/sitemap/google-sitemap.jsp&quot;, req);</span>
<span class="fc" id="L1085">					forwardSafely(customPage, req, res);</span>
<span class="fc" id="L1086">					return;</span>
				}
			}

<span class="pc bpc" id="L1090" title="1 of 8 branches missed.">			if ((path.startsWith(&quot;/components/&quot;) || path.startsWith(&quot;/templates/&quot;)) &amp;&amp; path.lastIndexOf('.') &gt; path.lastIndexOf('/') &amp;&amp; path.equals(&quot;/components/editoricon.gif&quot;)==false)</span>
			{
				try
				{
					//skus najst nahradu za pozadovanu stranku
<span class="fc" id="L1095">					String customPage = WriteTagToolsForCore.getCustomPage(path, req);</span>
<span class="pc bpc" id="L1096" title="1 of 2 branches missed.">					if (customPage.equals(path)==false)</span>
					{
<span class="nc" id="L1098">						forwardSafely(customPage, req, res);</span>
<span class="nc" id="L1099">						return;</span>
					}

<span class="fc bfc" id="L1102" title="All 2 branches covered.">					if (path.endsWith(&quot;editor_component.jsp&quot;))</span>
					{
						//over ci existuje, ak nie, pouzi defaultnu
<span class="fc bfc" id="L1105" title="All 2 branches covered.">						if (WriteTagToolsForCore.isFileExists(path)==false)</span>
						{
							try
							{
								//tu mame plne meno povodneho suboru v include
<span class="fc" id="L1110">								String jspFileName = req.getParameter(&quot;jspFileName&quot;);</span>
<span class="fc bfc" id="L1111" title="All 2 branches covered.">								if (jspFileName != null)</span>
								{
<span class="pc bpc" id="L1113" title="1 of 2 branches missed.">									if (jspFileName.startsWith(&quot;!INCLUDE(&quot;)) jspFileName = jspFileName.substring(9).trim();</span>

									//skus verziu s odstranenou druhou castou, /components/iway/news/editor_component.jsp -&gt; /components/news/editor_component.jsp
<span class="fc" id="L1116">									String pathBezDruhejCasti = &quot;/components&quot;+path.substring(path.indexOf(&quot;/&quot;, 13));</span>
<span class="pc bpc" id="L1117" title="1 of 2 branches missed.">									if (WriteTagToolsForCore.isFileExists(pathBezDruhejCasti))</span>
									{
										//mame custom subor, ak ale existuje nastaveny CONF kluc k danemu suboru nepouzijeme
<span class="nc" id="L1120">										String CONF_KEY = jspFileName.substring(0, jspFileName.lastIndexOf('.')).replace('/', '.').substring(1);</span>
<span class="nc" id="L1121">										Prop prop = Prop.getInstance(req);</span>
										//ak kluc neexistuje pouzijeme
<span class="nc bnc" id="L1123" title="All 4 branches missed.">										if (prop.getText(CONF_KEY+&quot;.conf.propSearchKey&quot;).equals(CONF_KEY+&quot;.conf.propSearchKey&quot;) &amp;&amp; prop.getText(CONF_KEY+&quot;.conf&quot;).equals(CONF_KEY+&quot;.conf&quot;))</span>
										{
<span class="nc" id="L1125">											Logger.debug(PathFilter.class, &quot;forwarding to:&quot;+pathBezDruhejCasti);</span>
<span class="nc" id="L1126">											req.getRequestDispatcher(WriteTagToolsForCore.getCustomPage(pathBezDruhejCasti, req)).forward(req, res);</span>
										}
									}
								}
							}
<span class="nc" id="L1131">							catch (Exception ex)</span>
							{
<span class="nc" id="L1133">								sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L1134">							}</span>

<span class="fc" id="L1136">							req.getRequestDispatcher(WriteTagToolsForCore.getCustomPage(&quot;/components/editor_component_universal.jsp&quot;, req)).forward(req, res);</span>
<span class="fc" id="L1137">							return;</span>
						}

					}
				}
<span class="nc" id="L1142">				catch (RuntimeException e)</span>
				{
<span class="nc" id="L1144">					sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L1145">				}</span>

			}
			//podpora custom pluginov v editore - NETREBA uz bereme z dist priecinka
			/*if (path.startsWith(&quot;/admin/skins/webjet8/ckeditor/dist/plugins/&quot;) || path.startsWith(&quot;/admin/skins/webjet8/ckeditor/plugins/&quot;))
			{
				path = Tools.replace(path, &quot;/admin/skins/webjet8/ckeditor/dist/plugins/&quot;, &quot;/admin/ckeditor/plugins/&quot;);
				path = Tools.replace(path, &quot;/admin/skins/webjet8/ckeditor/plugins/&quot;, &quot;/admin/ckeditor/plugins/&quot;);
				String customPage = WriteTagToolsForCore.getCustomPageAdmin(path, req);
				if (customPage != null)
				{
					req.getRequestDispatcher(customPage).forward(req, res);
					return;
				}
			}*/
<span class="pc bpc" id="L1160" title="2 of 4 branches missed.">			if (path.endsWith(&quot;.php&quot;) || path.endsWith(&quot;.asp&quot;))</span>
			{
				//skus najst JSP verziu stranky
<span class="nc" id="L1163">				String jspPath = path.substring(0, path.length() - 4) + &quot;.jsp&quot;;</span>
<span class="nc" id="L1164">				File jspFile = new File(Tools.getRealPath(jspPath));</span>
<span class="nc bnc" id="L1165" title="All 2 branches missed.">				if (jspFile.exists())</span>
				{
<span class="nc" id="L1167">					forwardSafely(jspPath, req, res);</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">					if (timer != null)</span>
					{
<span class="nc" id="L1170">						timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1171">						DBPool.getInstance().logConnections();</span>
					}
<span class="nc" id="L1173">					return;</span>
				}
			}
<span class="pc bpc" id="L1176" title="1 of 2 branches missed.">			if (customPath != null)</span>
			{
				//skontroluj, ci pozadovany subor nie je custom
<span class="nc" id="L1179">				IwcmFile f = new IwcmFile(customPath + File.separatorChar + Constants.getInstallName() + path.replace('/', File.separatorChar));</span>

<span class="nc bnc" id="L1181" title="All 2 branches missed.">				if (f.exists()==false)</span>
				{
<span class="nc" id="L1183">					f = new IwcmFile(Tools.getRealPath(&quot;/templates/&quot; + Constants.getInstallName() + &quot;/assets&quot; + path));</span>
				}

<span class="nc bnc" id="L1186" title="All 12 branches missed.">				if (f.exists()==false &amp;&amp; path.contains(&quot;/admin/docsify/&quot;) &amp;&amp; &quot;iwcm.interway.sk&quot;.equals(req.getServerName()) &amp;&amp; user != null &amp;&amp; user.isAdmin() &amp;&amp; path.contains(&quot;..&quot;)==false)</span>
                {
                    //je to docsify subor, ten mame inde, musime upravit
<span class="nc" id="L1189">                    f = new IwcmFile(Tools.getRealPath(&quot;/&quot;));</span>
<span class="nc" id="L1190">                    f = new IwcmFile(f.getParentFile(), path.substring(6).replace('/', File.separatorChar));</span>
                }

				//Logger.println(this,&quot;Checking CUSTOM: &quot;+f.getAbsolutePath());
<span class="nc bnc" id="L1194" title="All 4 branches missed.">				if (f.exists() &amp;&amp; f.isFile())</span>
				{
					//existuje custom subor, posli ho na vystup
<span class="nc bnc" id="L1197" title="All 4 branches missed.">					if (path.toLowerCase().endsWith(&quot;.jsp&quot;) || path.toLowerCase().endsWith(&quot;.class&quot;))</span>
					{
						//toto este nevieme, nerob nic
<span class="nc" id="L1200">						Logger.error(this,&quot;TOTO AKO CUSTOM NEVIEM: &quot; + path);</span>
					}
					else
					{
						//Logger.println(this,&quot;sending custom page:
						// &quot;+f.getAbsolutePath());
						//je to nejaky obrazok, alebo subor, posli na vystup
<span class="nc" id="L1207">						FilePathTools.writeFileOut(f, req, res);</span>
						//Logger.println(this,&quot;Zapisany subor: &quot; + path);
<span class="nc bnc" id="L1209" title="All 2 branches missed.">						if (timer != null)</span>
						{
<span class="nc" id="L1211">							timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1212">							DBPool.getInstance().logConnections();</span>
						}
<span class="nc" id="L1214">						return;</span>
					}
				}
			}

<span class="fc bfc" id="L1219" title="All 4 branches covered.">			if (FilePathTools.isExternalDir(path) &amp;&amp; path.startsWith(&quot;/files/protected/&quot;)==false)</span>
			{
				//externy adresar pre cloudStaticFilesDir folder
<span class="fc" id="L1222">				boolean fileWritten = FilePathTools.writeFileOut(path, req, res);</span>
<span class="pc bpc" id="L1223" title="1 of 2 branches missed.">				if (fileWritten)</span>
				{
<span class="nc bnc" id="L1225" title="All 2 branches missed.">					if (timer != null)</span>
					{
<span class="nc" id="L1227">						timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1228">						DBPool.getInstance().logConnections();</span>
					}
<span class="nc" id="L1230">					return;</span>
				}
			}

			//zaslanie fresh suboru pre elfinder (volane len s parametrom v=xxx) po zmene velkosti
			//tomcat 8 totiz nejako divne cachuje obrazky a aj ked ho zmenime tak to nepomoze a vrati povodny
<span class="fc bfc" id="L1236" title="All 6 branches covered.">			if (user != null &amp;&amp; user.isAdmin() &amp;&amp; req.getParameter(&quot;v&quot;)!=null)</span>
			{
<span class="fc" id="L1238">				String mimeType = Constants.getServletContext().getMimeType(path.toLowerCase());</span>
<span class="fc bfc" id="L1239" title="All 2 branches covered.">				if (Tools.isEmpty(mimeType)) mimeType = &quot;application/octet-stream&quot;;</span>
<span class="fc bfc" id="L1240" title="All 4 branches covered.">				if (mimeType.startsWith(&quot;image/&quot;) &amp;&amp; path.startsWith(&quot;/images&quot;))</span>
				{
<span class="fc" id="L1242">					IwcmFile f = new IwcmFile(Tools.getRealPath(path));</span>
<span class="pc bpc" id="L1243" title="1 of 4 branches missed.">					if (f.exists() &amp;&amp; f.canRead()) {</span>
<span class="fc" id="L1244">						FilePathTools.writeFileOut(f, req, res);</span>
						//Logger.println(this,&quot;Zapisany subor: &quot; + path);
<span class="pc bpc" id="L1246" title="1 of 2 branches missed.">						if (timer != null)</span>
						{
<span class="nc" id="L1248">							timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1249">							DBPool.getInstance().logConnections();</span>
						}
<span class="fc" id="L1251">						return;</span>
					}
				}
			}


			//preposlanie suboru z historie, tiket 13373, parameter pochadza z file_history.jsp
<span class="pc bpc" id="L1258" title="5 of 6 branches missed.">			if (req.getParameter(&quot;fHistoryId&quot;)!=null &amp;&amp; user != null &amp;&amp; user.isAdmin())</span>
			{
<span class="nc" id="L1260">				int fHistoryId = Tools.getIntValue(req.getParameter(&quot;fHistoryId&quot;), -1);</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">				if (fHistoryId &gt; 0)</span>
				{
<span class="nc" id="L1263">					boolean sendOK = FileHistoryDB.sendFileFromHistory(path, fHistoryId, res);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">					if (sendOK == false)</span>
					{
<span class="nc" id="L1266">						res.setStatus(404);</span>
					}
<span class="nc" id="L1268">					return;</span>
				}
			}



<span class="fc bfc" id="L1274" title="All 2 branches covered.">			if (path.startsWith(&quot;/templates/&quot;)) {</span>
<span class="fc" id="L1275">				Ninja.includeNinja(req);</span>
			}

			//forward(request, response);
			//return;
		}
<span class="nc" id="L1281">		catch (RuntimeException rex)</span>
		{
<span class="nc" id="L1283">			sk.iway.iwcm.Logger.error(rex);</span>
		}
<span class="nc" id="L1285">		catch (Exception ex)</span>
		{
<span class="nc bnc" id="L1287" title="All 2 branches missed.">			if (ex.getClass().getCanonicalName().startsWith(&quot;org.spring&quot;)) throw ex;</span>
			else
			{
<span class="nc" id="L1290">				sk.iway.iwcm.Logger.error(ex);</span>
			}
<span class="pc" id="L1292">		}</span>

<span class="pc bpc" id="L1294" title="1 of 2 branches missed.">		if (timer != null)</span>
		{
<span class="nc" id="L1296">			timer.diff(&quot;   Path filter - chain, path: &quot; + path);</span>
<span class="nc" id="L1297">			DBPool.getInstance().logConnections();</span>
		}

<span class="fc bfc" id="L1300" title="All 2 branches covered.">		if (handleStrutsRedirect(req, res)) return;</span>

		try
		{
			// Pass control on to the next filter
<span class="fc" id="L1305">			chain.doFilter(servletRequest, servletResponse);</span>
		}
<span class="fc" id="L1307">		catch (NestedServletException|org.springframework.security.access.AccessDeniedException e)</span>
		{
			//nastane napr. pri volani /admin/adminlog/logging ak user nema pravo na cmp_adminlog
			//rest sluzby si to handluju same, toto sa tyka webview
			//neda sa zachytit priamo AccessDeniedException preto chytame NestedServletException
<span class="pc bpc" id="L1312" title="1 of 2 branches missed.">			if (e.getCause().toString().contains(&quot;AccessDeniedException&quot;))</span>
			{
<span class="nc" id="L1314">				res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
				//ak to nie je rest posli ho aj na defaultnu 403 stranku
<span class="nc bnc" id="L1316" title="All 4 branches missed.">				if (path==null || path.contains(&quot;/rest&quot;)==false) forwardSafely(&quot;/403.jsp&quot;, req, res);</span>
			}
			else
			{
<span class="fc" id="L1320">				throw e;</span>
			}
<span class="fc" id="L1322">		}</span>
<span class="fc" id="L1323">	}</span>

	//these URL are nahdled by Servlet, so no need to forward it to Spring version
<span class="fc" id="L1326">	private static String[] strutsUrlServletExceptions = {</span>
		&quot;/showdoc.do&quot;,
		&quot;/admin/offline.do&quot;,
		&quot;/admin/docdel.do&quot;,
		&quot;/preview.do&quot;,
		&quot;/admin/multiplefileupload.do&quot;,
		&quot;/formmail.do&quot;,
		&quot;/logoff.do&quot;,
		&quot;/admin/logoff.do&quot;
	};

	/**
	 * Handle old struts *.do calls, it will be redirected to *.struts mappings which is handled by Spring MVC
	 * @param request
	 * @param response
	 * @throws ServletException
	 * @throws IOException
	 */
	private boolean handleStrutsRedirect(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException{
<span class="fc" id="L1345">		String path = PathFilter.getOrigPath(request);</span>
<span class="fc" id="L1346">		String doShowdocAction = request.getParameter(&quot;doShowdocAction&quot;);</span>
<span class="pc bpc" id="L1347" title="1 of 4 branches missed.">		if (Tools.isNotEmpty(doShowdocAction) &amp;&amp; ShowDoc.isDoShowdocActionAllowed(doShowdocAction)) path = doShowdocAction;</span>
<span class="pc bpc" id="L1348" title="1 of 2 branches missed.">		if (path==null) path = request.getRequestURI();</span>

<span class="fc bfc" id="L1350" title="All 2 branches covered.">		if (path.endsWith(&quot;.do&quot;)) {</span>

			//this is handled directly by servlet, no need to forward
<span class="fc bfc" id="L1353" title="All 2 branches covered.">			if (Tools.containsOneItem(strutsUrlServletExceptions, path)==false) {</span>
<span class="fc" id="L1354">				Logger.debug(PathFilter.class, &quot;Forwarding old struts path: &quot; + path);</span>
<span class="fc" id="L1355">				request.getRequestDispatcher(Tools.replace(path, &quot;.do&quot;, &quot;.struts&quot;)).forward(request, response);</span>
<span class="fc" id="L1356">				return true;</span>
			}
		}
<span class="fc" id="L1359">		return false;</span>
	}


	/**
	 * Skontroluje, ci je mozne pristupit k verejnej casti webu, nie admin casti
	 * @author kmarton
	 *
	 * @param request
	 * @return
	 */
	public static boolean checkWebAccess(HttpServletRequest request, String path)
	{
<span class="fc" id="L1372">        Identity user = UsersDB.getCurrentUser(request);</span>

        //kontrola referer hlavicky (CSRF), je povinna pre POST alebo ked je prihlaseny user
<span class="fc" id="L1375">        String pathLC = path.toLowerCase();</span>
<span class="pc bpc" id="L1376" title="1 of 8 branches missed.">        if (user != null || &quot;POST&quot;.equalsIgnoreCase(request.getMethod()) || pathLC.endsWith(&quot;.do&quot;) || pathLC.endsWith(&quot;.action&quot;))</span>
        {
<span class="fc" id="L1378">            boolean isUrlAccessible = true;</span>
<span class="fc" id="L1379">            boolean xsrfUrlException = DocTools.isXssStrictUrlException(path, &quot;xsrfUrlException&quot;);</span>
<span class="fc bfc" id="L1380" title="All 4 branches covered.">            if (xsrfUrlException==false &amp;&amp; isXsrfCheckRequired(request))</span>
            {
<span class="fc" id="L1382">                isUrlAccessible = checkXsrf(request);</span>
            }

            //nastal CSRF utok, referer nesedi
<span class="fc bfc" id="L1386" title="All 2 branches covered.">            if (isUrlAccessible==false) return false;</span>
        }

		//kontrola pristupu do /components/ adresara
<span class="fc bfc" id="L1390" title="All 4 branches covered.">		if ((path.startsWith(&quot;/components/&quot;) || path.startsWith(&quot;/apps/&quot;))</span>
<span class="pc bpc" id="L1391" title="1 of 6 branches missed.">			 &amp;&amp; (path.endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;.ftl&quot;) || path.endsWith(&quot;.html&quot;)))</span>
		{
<span class="fc bfc" id="L1393" title="All 4 branches covered.">			if (user == null || user.isAdmin()==false)</span>
			{
<span class="fc" id="L1395">				boolean canAccess = DocTools.isXssStrictUrlException(path, &quot;componentsDirectCallExceptions&quot;);</span>
<span class="fc bfc" id="L1396" title="All 2 branches covered.">				if (canAccess==false)</span>
				{
					//ak to zacina na /apps/ over este, ci to nie je platna URL adresa stranky
<span class="fc" id="L1399">					int docId = -1;</span>
<span class="fc bfc" id="L1400" title="All 2 branches covered.">					if (path.startsWith(&quot;/apps/&quot;)) docId = DocDB.getInstance().getDocIdFromURLImpl(path, DocDB.getDomain(request));</span>
<span class="fc bfc" id="L1401" title="All 2 branches covered.">					if (docId &lt; 1)</span>
					{
<span class="fc" id="L1403">						Adminlog.add(Adminlog.TYPE_XSS, &quot;Direct component call, path=&quot;+path, -1, -1);</span>
<span class="fc" id="L1404">						return false;</span>
					}
				}
				//duplicitna kontrola, v ziadnom pripade nema zmysel pristupovat na komponenty s URL obsahujucim admin a tiez do statistiky
<span class="pc bpc" id="L1408" title="1 of 4 branches missed.">				if (canAccess &amp;&amp; path.contains(&quot;admin_answer.jsp&quot;)) return canAccess;</span>
<span class="pc bpc" id="L1409" title="1 of 2 branches missed.">				if (path.contains(&quot;admin&quot;))</span>
				{
<span class="nc bnc" id="L1411" title="All 6 branches missed.">					if (user != null &amp;&amp; (path.contains(&quot;FCKeditor&quot;) || path.contains(&quot;/components/gallery/admin_gallery_popup.jsp&quot;) ||</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">							path.contains(&quot;/components/helpdesk/fotogaleria/admin_upload.jsp&quot;)))</span>
					{
						//specialna vynimka pre CK editor pre rozne projekty kde je user prihlaseny ale nie je admin
						//+ #17331 - pridana vynimka pre upload suboru vo fotogalerii v intre
					}
					else
					{
<span class="nc" id="L1419">						return false;</span>
					}
				}
<span class="pc bpc" id="L1422" title="3 of 4 branches missed.">				if (path.contains(&quot;/components/stat/&quot;) &amp;&amp; path.contains(&quot;stat_async_ajax.jsp&quot;) == false) return false;</span>
			}
		}

		//kontrola pristupu podla povolenych IP adries
<span class="fc" id="L1427">		HttpSession session = request.getSession();</span>
<span class="fc" id="L1428">		Boolean val = (Boolean) session.getAttribute(CHECK_WEB_ACCESS_SESSION_KEY);</span>
<span class="fc bfc" id="L1429" title="All 2 branches covered.">		if (val != null)</span>
		{
			//Logger.println(this,&quot;Checking to access web from session: &quot; + val.booleanValue());
<span class="fc" id="L1432">			return (val.booleanValue());</span>
		}

<span class="fc" id="L1435">		boolean ret = Tools.checkIpAccess(request, &quot;webEnableIPs&quot;);</span>
<span class="fc" id="L1436">		session.setAttribute(CHECK_WEB_ACCESS_SESSION_KEY, Boolean.valueOf(ret));</span>
<span class="fc" id="L1437">		return (ret);</span>
	}

	/**
	 * Skontroluje, ci je mozne pristupit k verejnej casti webu na zaklade domeny&lt;br /&gt;
	 *
	 * Castokrat web najskor bezi na domene nieco.t8.iway.sk a nasledne sa spusti na
	 *	domenie nieco.sk, filter umoznuje zadat domeny, pre ktore bude stranka
	 *	vracat obsah a pre ktore bude robit 404 / redirect na inu domenu.
	 *	@author kmarton
	 *
	 * @param request
	 * @return
	 */
	private boolean checkDomain(HttpServletRequest request)
	{
<span class="fc" id="L1453">		HttpSession session = request.getSession();</span>
<span class="fc" id="L1454">		Boolean val = (Boolean) session.getAttribute(CHECK_DOMAIN_SESSION_KEY);</span>
<span class="fc bfc" id="L1455" title="All 2 branches covered.">		if (val != null)</span>
		{
			//Logger.println(this,&quot;Checking DOMAIN to access web from session: &quot; + val.booleanValue());
<span class="fc" id="L1458">			return (val.booleanValue());</span>
		}
<span class="fc" id="L1460">		String webAllowedDomains = Constants.getString(&quot;webAllowedDomains&quot;);</span>
<span class="fc" id="L1461">		boolean ret = true;</span>
<span class="pc bpc" id="L1462" title="2 of 4 branches missed.">		if (webAllowedDomains != null &amp;&amp; webAllowedDomains.length() &gt; 1)</span>
		{
<span class="nc" id="L1464">			ret = false;</span>
<span class="nc" id="L1465">			StringTokenizer st = new StringTokenizer(webAllowedDomains, &quot;,&quot;);</span>
			String domain;
<span class="nc" id="L1467">			String myDomain = Tools.getServerName(request);</span>
<span class="nc" id="L1468">			Logger.println(this,&quot;Checking: &quot; + myDomain + &quot; vs &quot; + webAllowedDomains);</span>
<span class="nc bnc" id="L1469" title="All 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L1471">				domain = st.nextToken();</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">				if (myDomain.endsWith(domain))</span>
				{
<span class="nc" id="L1474">					ret = true;</span>
<span class="nc" id="L1475">					break;</span>
				}
			}
		}
<span class="fc" id="L1479">		session.setAttribute(CHECK_DOMAIN_SESSION_KEY, Boolean.valueOf(ret));</span>
<span class="fc" id="L1480">		return (ret);</span>
	}

	private boolean checkAccessToAdmin(String path, HttpServletRequest request, HttpServletResponse response)
	{
<span class="fc" id="L1485">		boolean isAdminUrlAccessible = true;</span>
<span class="fc" id="L1486">        Identity user = UsersDB.getCurrentUser(request.getSession());</span>

<span class="fc" id="L1488">        boolean xsrfUrlException = DocTools.isXssStrictUrlException(path, &quot;xsrfUrlException&quot;);</span>

<span class="fc bfc" id="L1490" title="All 2 branches covered.">		if(path.startsWith(&quot;/admin&quot;) ||</span>
<span class="fc bfc" id="L1491" title="All 4 branches covered.">			(path.startsWith(&quot;/components/&quot;) &amp;&amp; path.contains(&quot;/admin&quot;)) ||</span>
<span class="fc bfc" id="L1492" title="All 4 branches covered.">			(path.startsWith(&quot;/apps/&quot;) &amp;&amp; path.contains(&quot;/admin&quot;)))	//pristupuje do admin casti a admin komponent/app</span>
		{
<span class="pc bpc" id="L1494" title="1 of 4 branches missed.">			if(user == null || UsersDB.checkUserPerms(user, &quot;admin|editableGroupsNotEmpty&quot;)==false)	//A nie je prihlaseny, alebo nie je prihlaseny ako admin</span>
			{
<span class="fc" id="L1496">				isAdminUrlAccessible = false;</span>
<span class="fc" id="L1497">				String allowAdminUrls = Constants.getString(&quot;allowAdminUrls&quot;);</span>
				//ak v starom WJ mali customizovanu premennu a nemaju tam springove prihlasenie, pridajme
<span class="pc bpc" id="L1499" title="2 of 4 branches missed.">				if (allowAdminUrls.contains(&quot;/admin/logon.do&quot;) &amp;&amp; allowAdminUrls.contains(&quot;/admin/logon/&quot;)==false) allowAdminUrls += &quot;,^/admin/logon$,^/admin/logon/$,^/admin/logon/changePassword$&quot;;</span>

<span class="fc" id="L1501">				String[] adminUrls = Tools.getTokens(allowAdminUrls, &quot;,&quot;, true);</span>

<span class="fc bfc" id="L1503" title="All 2 branches covered.">				for(String url: adminUrls)</span>
				{
<span class="pc bpc" id="L1505" title="1 of 6 branches missed.">					if(path.startsWith(url) || (&quot;^&quot;+path+&quot;$&quot;).equals(url) || (path+&quot;$&quot;).endsWith(url))</span>
					{
<span class="fc" id="L1507">						isAdminUrlAccessible = true;</span>
<span class="fc" id="L1508">						break;</span>
					}
				}
			}
<span class="fc bfc" id="L1512" title="All 4 branches covered.">			if(isAdminUrlAccessible &amp;&amp; xsrfUrlException==false)</span>
			{
<span class="fc" id="L1514">				isAdminUrlAccessible = checkXsrf(request);</span>
			}

<span class="pc bpc" id="L1517" title="2 of 14 branches missed.">			if (path.endsWith(&quot;.html&quot;) || path.endsWith(&quot;.jsp&quot;) || path.endsWith(&quot;.action&quot;) || path.endsWith(&quot;.do&quot;) || path.endsWith(&quot;.js&quot;) || path.endsWith(&quot;/&quot;) || path.indexOf(&quot;ajax&quot;)!=-1)</span>
			{
<span class="fc" id="L1519">				setUaCompatibleAdmin(path, response);</span>
			}
		}

<span class="fc bfc" id="L1523" title="All 4 branches covered.">		if (user != null &amp;&amp; user.isAdmin())</span>
		{
<span class="fc bfc" id="L1525" title="All 2 branches covered.">            if (xsrfUrlException==false)</span>
            {
<span class="fc bfc" id="L1527" title="All 2 branches covered.">                if (isXsrfCheckRequired(request))</span>
                {
<span class="fc" id="L1529">                    isAdminUrlAccessible = checkXsrf(request);</span>
                }
            }
        }
<span class="fc" id="L1533">		return isAdminUrlAccessible;</span>
	}

    /**
     * Overi, ci je potrebna XSRF kontrola (kontrola referera)
     * ta sa robi pri POST alebo ked v URL su nejake parametre (okrem vynimiek definovanych v xsrfParamNameException ako docid, _logLevel, combineEnabled atd)
     * @param request
     * @return
     */
	private static boolean isXsrfCheckRequired(HttpServletRequest request)
    {
        //ak uz je user prihlaseny ako admin, kontrolujme CSRF vzdy (aby sa nedal spravit utok z inej stranky mazuci napr. data)
        //niektore URL musime whitelistovat, kedze mozu viest z mailu
<span class="fc" id="L1546">        boolean isXsrfCheckRequired = false;</span>
<span class="fc bfc" id="L1547" title="All 2 branches covered.">        if (&quot;GET&quot;.equalsIgnoreCase(request.getMethod()))</span>
        {
<span class="fc" id="L1549">            Enumeration&lt;String&gt; paramNames = request.getParameterNames();</span>
<span class="fc" id="L1550">            int failsafe = 0;</span>
<span class="fc" id="L1551">            int maxFailsafe = 10;</span>

<span class="fc" id="L1553">            String xsrfParamNames = Constants.getString(&quot;xsrfParamNameExceptionSystem&quot;);</span>
<span class="pc bpc" id="L1554" title="1 of 2 branches missed.">            if (Tools.isNotEmpty(Constants.getString(&quot;xsrfParamNameException&quot;))) xsrfParamNames += &quot;,&quot; + Constants.getString(&quot;xsrfParamNameException&quot;);</span>

<span class="fc" id="L1556">            String[] xsrfParamNameException = Tools.getTokens(xsrfParamNames.toLowerCase(), &quot;,&quot;, true);</span>
<span class="pc bpc" id="L1557" title="1 of 4 branches missed.">            while (paramNames.hasMoreElements() &amp;&amp; failsafe++ &lt;= maxFailsafe)</span>
            {
<span class="fc" id="L1559">                String name = paramNames.nextElement().toLowerCase();</span>
                //natvrdo kvoli performance
<span class="fc bfc" id="L1561" title="All 2 branches covered.">                if (&quot;docid&quot;.equals(name)) continue;</span>
                //displaytag povolime
<span class="fc bfc" id="L1563" title="All 2 branches covered.">                if (name.startsWith(&quot;d-&quot;)) continue;</span>
                //over voci zoznamu povolenych parametrov
<span class="fc bfc" id="L1565" title="All 2 branches covered.">                if (Tools.containsOneItem(xsrfParamNameException, name)) continue;</span>

<span class="fc" id="L1567">                isXsrfCheckRequired = true;</span>
<span class="fc" id="L1568">            }</span>
            //ak to ma vela parametrov tak to je rovno podozrive
<span class="fc bfc" id="L1570" title="All 2 branches covered.">            if (failsafe&gt;=maxFailsafe) isXsrfCheckRequired = true;</span>
<span class="fc" id="L1571">        }</span>
        else {
            //pre POST je check required
<span class="fc" id="L1574">            isXsrfCheckRequired = true;</span>
        }
<span class="fc" id="L1576">        return isXsrfCheckRequired;</span>
    }


	/**
	 * Method checks for XSRF attack, if referrer from request header is not current server
	 * or from list of trusted referrers (constant xsrfReferers, see {@link Constants} ) method denies
	 * access to url and logs attack. for more information see Ticket 11207
	 * @param request request
	 * @return true if xsrf is not detected, else false
	 */
	private static boolean checkXsrf(HttpServletRequest request)
	{
<span class="fc" id="L1589">		String trustedXsrfReferers = Constants.getString(&quot;xsrfReferers&quot;);</span>
		//ten length je tam aby v Oracle DB bolo mozne v konfiguracii nastavit znak -
<span class="pc bpc" id="L1591" title="2 of 4 branches missed.">		if(Tools.isEmpty(trustedXsrfReferers) || trustedXsrfReferers.length()&lt;2) return true;</span>

<span class="fc" id="L1593">		String remoteReferrer = request.getHeader(&quot;referer&quot;);</span>
<span class="fc bfc" id="L1594" title="All 2 branches covered.">		if(Tools.isEmpty(remoteReferrer))</span>
        {
            //vynimka pre elfinder download - /admin/elfinder-connector/?cmd=file&amp;target=iwcm_2_L2ZpbGVzL3pfb19wcmlzcF9uYV9wb2hyZWJfcGRmLnBkZg_E_E&amp;download=1&amp;volumes=files
            //nechcel som dat vynimku pre cely elfinder-connector, preto sa testuje parameter download
<span class="fc" id="L1598">            String path = PathFilter.getOrigPath(request);</span>
<span class="pc bpc" id="L1599" title="3 of 4 branches missed.">            if (&quot;/admin/elfinder-connector/&quot;.equals(path) &amp;&amp; &quot;1&quot;.equals(request.getParameter(&quot;download&quot;)))</span>
            {
<span class="nc" id="L1601">                return true;</span>
            }

            //do slaka, MSIE posiela empty referer ked otvara popup okno, takze zial MSIE nebude pre GET poziadavky chranene
<span class="fc" id="L1605">            String userAgent = request.getHeader(&quot;User-Agent&quot;);</span>
<span class="fc" id="L1606">            boolean isMsie = false;</span>
<span class="pc bpc" id="L1607" title="1 of 4 branches missed.">            if (userAgent!=null &amp;&amp; &quot;GET&quot;.equalsIgnoreCase(request.getMethod()))</span>
            {
                //vynimka len pre Trident/7.0 co je MSIE 11, starsi MSIE nebude podporovany (jedine ochranu uplne vypnut)
<span class="pc bpc" id="L1610" title="1 of 2 branches missed.">                if (userAgent.contains(&quot;Trident/7.0&quot;)) isMsie = true;</span>
            }

<span class="pc bpc" id="L1613" title="1 of 4 branches missed.">            if  (isMsie==false &amp;&amp; isXsrfCheckRequired(request))</span>
            {
<span class="fc" id="L1615">                Adminlog.add(Adminlog.TYPE_XSRF, &quot;Possible XSRF attack, referer is empty&quot;, -1, -1);</span>
<span class="fc" id="L1616">                return false;</span>
            }
<span class="fc" id="L1618">            return true;</span>
        }

<span class="fc" id="L1621">		String remoteReferrerServer = &quot;&quot;;</span>
		try
		{
<span class="fc" id="L1624">			URL remoteReferrerUrl = new URL(remoteReferrer);</span>
<span class="fc" id="L1625">			remoteReferrerServer = remoteReferrerUrl.getHost();</span>
		}
<span class="nc" id="L1627">		catch (Exception e)</span>
		{
<span class="nc" id="L1629">			Logger.debug(PathFilter.class,&quot;Failed to create URL from referrer: &quot; + remoteReferrer);</span>
<span class="fc" id="L1630">		}</span>
<span class="fc bfc" id="L1631" title="All 2 branches covered.">		for(String trustedReferrer : trustedXsrfReferers.split(&quot;,&quot;))</span>
		{
<span class="fc" id="L1633">			trustedReferrer = trustedReferrer.trim();</span>
<span class="fc bfc" id="L1634" title="All 2 branches covered.">			if(trustedReferrer.equalsIgnoreCase(Constants.SERVER_NAME_MACRO))</span>
			{
<span class="fc" id="L1636">				trustedReferrer = Tools.getServerName(request, false);</span>
			}
<span class="pc bpc" id="L1638" title="2 of 8 branches missed.">			if (trustedReferrer.startsWith(&quot;%&quot;) &amp;&amp; trustedReferrer.endsWith(&quot;%&quot;) &amp;&amp; trustedReferrer.length()&gt;4 &amp;&amp; remoteReferrerServer.contains(trustedReferrer.substring(1, trustedReferrer.length()-1)))</span>
			{
<span class="nc" id="L1640">					return true;</span>
			}
<span class="pc bpc" id="L1642" title="2 of 6 branches missed.">			if (trustedReferrer.startsWith(&quot;%&quot;) &amp;&amp; trustedReferrer.length()&gt;2 &amp;&amp; remoteReferrerServer.endsWith(trustedReferrer.substring(1)))</span>
			{
<span class="nc" id="L1644">				return true;</span>
			}
<span class="fc bfc" id="L1646" title="All 2 branches covered.">			if(remoteReferrerServer.equalsIgnoreCase(trustedReferrer))</span>
			{
<span class="fc" id="L1648">				return true;</span>
			}
		}
<span class="fc" id="L1651">		Adminlog.add(Adminlog.TYPE_XSRF, &quot;Possible XSRF attack from: &quot; + remoteReferrer, -1, -1);</span>

<span class="fc" id="L1653">		return false;</span>
	}

	/**
	 * Skontroluje, ci je mozne pristupit k admin casti
	 *
	 * @param request
	 * @return
	 */
	public static boolean checkAdmin(HttpServletRequest request)
	{
<span class="fc" id="L1664">		HttpSession session = request.getSession();</span>
<span class="fc" id="L1665">		Boolean val = (Boolean) session.getAttribute(CHECK_ADMIN_SESSION_KEY);</span>
<span class="fc bfc" id="L1666" title="All 2 branches covered.">		if (val != null)</span>
		{
<span class="fc" id="L1668">			return (val.booleanValue());</span>
		}

<span class="pc bpc" id="L1671" title="1 of 2 branches missed.">		if (&quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;))) return false;</span>

<span class="fc" id="L1673">		String adminEnableIPs = Constants.getString(&quot;adminEnableIPs&quot;);</span>
<span class="fc" id="L1674">		boolean ret = true;</span>
<span class="pc bpc" id="L1675" title="2 of 4 branches missed.">		if (adminEnableIPs != null &amp;&amp; adminEnableIPs.length() &gt; 1)</span>
		{
<span class="fc" id="L1677">			ret = false;</span>
<span class="fc" id="L1678">			StringTokenizer st = new StringTokenizer(adminEnableIPs, &quot;,&quot;);</span>
			String ip;
<span class="fc" id="L1680">			String myIP = Tools.getRemoteIP(request);</span>
<span class="fc" id="L1681">			Logger.println(PathFilter.class,&quot;Checking: &quot; + myIP + &quot; vs &quot; + adminEnableIPs);</span>
<span class="pc bpc" id="L1682" title="1 of 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="fc" id="L1684">				ip = st.nextToken().trim();</span>
<span class="pc bpc" id="L1685" title="1 of 2 branches missed.">				if (myIP.startsWith(ip))</span>
				{
<span class="fc" id="L1687">					ret = true;</span>
<span class="fc" id="L1688">					break;</span>
				}
			}
		}
<span class="fc" id="L1692">		session.setAttribute(CHECK_ADMIN_SESSION_KEY, Boolean.valueOf(ret));</span>
<span class="fc" id="L1693">		return (ret);</span>
	}

	/**
	 * Nacita z databazy zoznam adresarov, v ktorych su chranene subory
	 *
	 */
	public static synchronized void reloadProtectedDirs()
	{
<span class="fc" id="L1702">		Map&lt;String, EditForm&gt; protectedDirs = new HashMap&lt;&gt;();</span>

<span class="fc" id="L1704">		Connection db_conn = null;</span>
<span class="fc" id="L1705">		PreparedStatement ps = null;</span>
<span class="fc" id="L1706">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L1709">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L1710">			ps = db_conn.prepareStatement(&quot;SELECT * FROM dirprop&quot;); //NOSONAR</span>
<span class="fc" id="L1711">			rs = ps.executeQuery();</span>
			EditForm ef;
			String passProtected;
<span class="fc bfc" id="L1714" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L1716">				passProtected = DB.getDbString(rs, &quot;password_protected&quot;);</span>
<span class="fc bfc" id="L1717" title="All 2 branches covered.">				if (Tools.isEmpty(passProtected))</span>
				{
<span class="fc" id="L1719">					continue;</span>
				}

<span class="fc" id="L1722">				ef = new EditForm();</span>
<span class="fc" id="L1723">				ef.setPasswordProtectedString(passProtected);</span>
<span class="fc" id="L1724">				ef.setOrigDir(DB.getDbString(rs, &quot;dir_url&quot;));</span>
<span class="fc" id="L1725">				ef.setIndexFulltext(rs.getBoolean(&quot;index_fulltext&quot;));</span>
<span class="fc" id="L1726">				ef.setLogonDocId(rs.getInt(&quot;logon_doc_id&quot;));</span>

<span class="fc" id="L1728">				protectedDirs.put(ef.getOrigDir(), ef);</span>
			}
<span class="fc" id="L1730">			rs.close();</span>
<span class="fc" id="L1731">			ps.close();</span>
<span class="fc" id="L1732">			rs = null;</span>
<span class="fc" id="L1733">			ps = null;</span>
		}
<span class="nc" id="L1735">		catch (Exception sqlEx)</span>
		{
			//ak este nie je spraveny update toto hadze exception
<span class="nc bnc" id="L1738" title="All 2 branches missed.">			if (sqlEx.getMessage().indexOf(&quot;doesn't exist&quot;)!=-1)</span>
			{
<span class="nc" id="L1740">				sk.iway.iwcm.Logger.error(sqlEx);</span>
			}
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L1747" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="fc" id="L1748">					db_conn.close();</span>
<span class="pc bpc" id="L1749" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1750">					rs.close();</span>
<span class="pc bpc" id="L1751" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1752">					ps.close();</span>
			}
<span class="nc" id="L1754">			catch (Exception ex2)</span>
			{
<span class="fc" id="L1756">			}</span>
		}
<span class="fc" id="L1758">		passwordProtected = protectedDirs;</span>
<span class="fc" id="L1759">	}</span>

	/**
	 * Skontroluje, ci zadane URL je v protected zone
	 * @param url
	 * @return EditForm ak je chranene, alebo null
	 */
	public static EditForm isPasswordProtected(String url, HttpServletRequest request)
	{
<span class="pc bpc" id="L1768" title="1 of 2 branches missed.">		if (request == null) return isPasswordProtected(url, null, null);</span>
<span class="fc" id="L1769">		return isPasswordProtected(url, request, request.getSession());</span>
	}

	/**
	 * Skontroluje prava k danemu URL (suboru)
	 * @param url - url adresa suboru z adresara /files
	 * @param request - ak nie je null prida sa aj statistika videni (ak statistiku nechceme zaratat nastavime len session)
	 * @param session - session z ktorej sa ziska identita pouzivatela
	 * @return
	 */
	public static EditForm isPasswordProtected(String url, HttpServletRequest request, HttpSession session)
	{
<span class="fc" id="L1781">		boolean galleryCheckUserPerms = Constants.getBoolean(&quot;galleryCheckUserPerms&quot;);</span>
<span class="pc bpc" id="L1782" title="1 of 6 branches missed.">		if (url.startsWith(&quot;/files&quot;)==false &amp;&amp; (url.startsWith(&quot;/images/gallery/&quot;)==false || galleryCheckUserPerms == false))</span>
		{
<span class="fc" id="L1784">			return(null);</span>
		}

<span class="pc bpc" id="L1787" title="3 of 4 branches missed.">		if (session == null &amp;&amp; request != null) session = request.getSession();</span>

<span class="fc" id="L1789">		EditForm efBestMatch = null;</span>

<span class="pc bpc" id="L1791" title="2 of 4 branches missed.">		if(passwordProtected != null &amp;&amp; passwordProtected.size() &gt; 0)</span>
		{
<span class="fc" id="L1793">			String testPath = url;</span>
<span class="fc" id="L1794">			int start = 1; //nastavit musim na 1, aby v pripade prvej podmienky islo do while cyklu</span>
<span class="pc bpc" id="L1795" title="1 of 2 branches missed.">			if (testPath.endsWith(&quot;/&quot;)) testPath = testPath.substring(0, testPath.length()-1);</span>
<span class="fc bfc" id="L1796" title="All 2 branches covered.">			else if(testPath.contains(&quot;.&quot;)) //ak sa jedna o subor - vytiahnem adresar</span>
			{
<span class="fc" id="L1798">				start = testPath.lastIndexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L1799" title="1 of 2 branches missed.">				if(start != -1) testPath = testPath.substring(0, testPath.lastIndexOf(&quot;/&quot;));</span>
			}
<span class="fc" id="L1801">			EditForm ef = null;</span>
<span class="fc" id="L1802">			int failsafe = 0;</span>
<span class="fc" id="L1803">			String firstTestPath = &quot;&quot;;</span>
			//hladam najblizsi nadradeny adresar kotry je password protected
<span class="pc bpc" id="L1805" title="1 of 4 branches missed.">			while (start &gt; 0 &amp;&amp; failsafe++ &lt; 30)</span>
			{
<span class="fc bfc" id="L1807" title="All 2 branches covered.">				if(failsafe == 1) firstTestPath = testPath;</span>

<span class="fc" id="L1809">				ef = passwordProtected.get(testPath);</span>
<span class="fc bfc" id="L1810" title="All 2 branches covered.">				if(ef != null)</span>
				{
<span class="fc" id="L1812">					efBestMatch = ef;</span>
					//pokial som nenasiel v prvom pokuse, pridam do zoznamu, nech pri dalsom volani neiterujem zbytocne + ochrana proti DOC utokom
<span class="pc bpc" id="L1814" title="3 of 4 branches missed.">					if(failsafe &gt; 1 &amp;&amp; passwordProtected.size() &lt; 2000) passwordProtected.put(firstTestPath, ef);</span>
					break;
				}

<span class="fc" id="L1818">				start = testPath.lastIndexOf(&quot;/&quot;);</span>
<span class="fc bfc" id="L1819" title="All 2 branches covered.">				if (start &gt; 0) testPath = testPath.substring(0, start); //substring len v pripade ak lomitko nieje na zaciatku</span>
			}
		}

<span class="fc bfc" id="L1823" title="All 2 branches covered.">		if (url.startsWith(&quot;/files&quot;))</span>
		{
			//pre files skus skontrolovat ci nie je zaheslovany v sekcii /files/
<span class="fc" id="L1826">			DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L1827">			int docId = docDB.getDocIdFromURLImpl(url+&quot;.html&quot;, null);</span>
<span class="pc bpc" id="L1828" title="1 of 2 branches missed.">			if (docId &lt; 1) docId = docDB.getDocIdFromURLImpl(url+&quot;.html&quot;, DocDB.getDomain(request));</span>
<span class="fc bfc" id="L1829" title="All 2 branches covered.">			if (docId &lt; 1) docId = docDB.getDocIdFromURLImpl(Tools.replace(url, &quot;.&quot;, &quot;-&quot;)+&quot;.html&quot;, null);</span>
<span class="fc bfc" id="L1830" title="All 2 branches covered.">			if (docId &lt; 1) docId = docDB.getDocIdFromURLImpl(Tools.replace(url, &quot;.&quot;, &quot;-&quot;)+&quot;.html&quot;, DocDB.getDomain(request));</span>
<span class="fc bfc" id="L1831" title="All 2 branches covered.">			if (docId &gt; 0)</span>
			{
<span class="fc" id="L1833">				DocDetails fileDoc = docDB.getBasicDocDetails(docId, false);</span>
<span class="pc bpc" id="L1834" title="1 of 2 branches missed.">				if (fileDoc != null)</span>
				{
<span class="fc" id="L1836">					Identity user = null;</span>
<span class="pc bpc" id="L1837" title="1 of 2 branches missed.">					if (session != null) user = UsersDB.getCurrentUser(session);</span>
					else
					{
<span class="nc" id="L1840">						RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc bnc" id="L1841" title="All 4 branches missed.">						if (rb!=null &amp;&amp; rb.getUserId()&gt;0) user = new Identity(UsersDB.getUser(rb.getUserId()));</span>
					}
<span class="fc" id="L1843">					boolean canAccess = DocDB.canAccess(fileDoc, user, true);</span>
<span class="fc" id="L1844">					boolean isAvailable = fileDoc.isAvailable();</span>
<span class="pc bpc" id="L1845" title="7 of 8 branches missed.">					if (isAvailable == false &amp;&amp; user != null &amp;&amp; user.isAdmin() &amp;&amp; Constants.getBoolean(&quot;adminCheckUserGroups&quot;)==false)</span>
					{
						//ak je admin ignorujeme nastavenie available atributu stranky
<span class="nc" id="L1848">						isAvailable = true;</span>
					}

<span class="pc bpc" id="L1851" title="2 of 4 branches missed.">					if (!canAccess || !isAvailable)</span>
					{
<span class="nc" id="L1853">						efBestMatch = new EditForm();</span>
						//to cislo je bulharska konstanta len aby nam potom nezbehlo ef.isAccessibleFor, pretoze to neriesi podadresare dokumentu
<span class="nc" id="L1855">						efBestMatch.setPasswordProtectedString(&quot;999888777&quot;);</span>
					}
					else
					{
						try
						{
<span class="pc bpc" id="L1861" title="1 of 2 branches missed.">							if (request != null)</span>
							{
<span class="fc" id="L1863">								StatDB.add(request.getSession(), request, null, docId);</span>
							}
						}
<span class="nc" id="L1866">						catch (Exception e)</span>
						{
<span class="nc" id="L1868">							sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L1869">						}</span>
					}
				}
			}
		}

<span class="fc" id="L1875">		return(efBestMatch);</span>
	}

	/**
	 * Vykona redirect (ak treba) na zobrazenie logon stranky / zamietnutia pristupu k suboru (/files/*), vrati true, ak bol redirect vykonany
	 * @param ef
	 * @param user
	 * @param originalPath
	 * @param req
	 * @param res
	 * @return true ak je redirect vykonany, inak false
	 * @throws IOException
	 * @throws ServletException
	 */
	public static boolean doFileForbiddenRedirect(EditForm ef, Identity user, String originalPath, HttpServletRequest req, HttpServletResponse res) throws IOException, ServletException
	{
<span class="fc" id="L1891">		boolean isAccesible = false;</span>
<span class="pc bpc" id="L1892" title="3 of 4 branches missed.">		if (user != null &amp;&amp; ef!=null)</span>
		{
			//otestuj, ci je user v skupine pre tento adresar

			int i;
<span class="nc" id="L1897">			int size = ef.getPasswordProtected().length;</span>
<span class="nc bnc" id="L1898" title="All 2 branches missed.">			for (i=0; i&lt;size; i++)</span>
			{
<span class="nc bnc" id="L1900" title="All 2 branches missed.">				if (user.isInUserGroup(ef.getPasswordProtected()[i]))</span>
				{
<span class="nc" id="L1902">					isAccesible = true;</span>
<span class="nc" id="L1903">					break;</span>
				}
			}

		}

<span class="pc bpc" id="L1909" title="1 of 2 branches missed.">		if (isAccesible) return false;</span>

<span class="fc" id="L1911">		String pathQS = originalPath;</span>
<span class="fc bfc" id="L1912" title="All 2 branches covered.">		if (Tools.isNotEmpty(req.getQueryString())) pathQS = originalPath + &quot;?&quot; + req.getQueryString();</span>

<span class="fc" id="L1914">		Logger.debug(PathFilter.class, &quot;NOT ACCESSIBLE: path=&quot;+pathQS+&quot; user=&quot;+user);</span>
<span class="pc bpc" id="L1915" title="1 of 2 branches missed.">		if (user != null)</span>
		{
			//user nema pristup, daj mu forbidden
<span class="nc" id="L1918">			int fileAccessDeniedDocId = Constants.getInt(&quot;fileAccessDeniedDocId&quot;);</span>
<span class="nc" id="L1919">			Logger.debug(PathFilter.class, &quot;fileAccessDeniedDocId=&quot;+fileAccessDeniedDocId+&quot; ntlm=&quot;+AuthenticationFilter.getForbiddenURL());</span>
<span class="nc bnc" id="L1920" title="All 2 branches missed.">			if (fileAccessDeniedDocId &gt; 0)</span>
			{
<span class="nc" id="L1922">				res.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="nc" id="L1923">				res.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="nc" id="L1924">				res.setHeader(&quot;Cache-Control&quot;,&quot;no-Cache&quot;);</span>

<span class="nc" id="L1926">				req.setAttribute(&quot;logonFormSubmitURL&quot;, originalPath);</span>
<span class="nc" id="L1927">				req.getRequestDispatcher(&quot;/showdoc.do?docid=&quot;+fileAccessDeniedDocId+&quot;&amp;origUrl=&quot;+Tools.URLEncode(pathQS)).forward(req, res);</span>
			}
<span class="nc bnc" id="L1929" title="All 2 branches missed.">			else if (Tools.isNotEmpty(AuthenticationFilter.getForbiddenURL()))</span>
			{
<span class="nc" id="L1931">				res.sendRedirect(Tools.addParameterToUrlNoAmp(AuthenticationFilter.getForbiddenURL(), &quot;origUrl&quot;, pathQS));</span>
			}
			else
			{
<span class="nc" id="L1935">				res.setStatus(HttpServletResponse.SC_FORBIDDEN);</span>
			}
<span class="nc" id="L1937">		}</span>
		else
		{
			//forwardni sa na logon stranku
<span class="fc" id="L1941">			req.getSession().setAttribute(&quot;afterLogonRedirect&quot;, pathQS);</span>

<span class="fc" id="L1943">			res.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="fc" id="L1944">			res.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="fc" id="L1945">			res.setHeader(&quot;Cache-Control&quot;,&quot;no-Cache&quot;);</span>

<span class="fc bfc" id="L1947" title="All 4 branches covered.">			if (ef != null &amp;&amp; ef.getLogonDocId()&gt;0)</span>
			{
				//res.sendRedirect(&quot;/showdoc.do?docid=&quot;+ef.getLogonDocId());

				//request.setAttribute(&quot;docDetailsOriginal&quot;, doc);

				//pre subor sa musime submitnut priamo na usrlogon.do aby sa najskor spravilo prihlasenie az potom kontrola prav na subor
<span class="fc" id="L1954">				req.setAttribute(&quot;logonFormSubmitURL&quot;, &quot;/usrlogon.do&quot;);</span>
<span class="fc" id="L1955">				req.getRequestDispatcher(&quot;/showdoc.do?docid=&quot;+ef.getLogonDocId()+&quot;&amp;dontUpdateLastDocId=true&quot;).forward(req, res);</span>
			}
			else
			{
<span class="fc" id="L1959">				req.getRequestDispatcher(&quot;/components/user/logon.jsp?permsDenied=true&quot;).forward(req, res);</span>
			}
		}
<span class="fc" id="L1962">		return true;</span>
	}

	/**
	 * Vrati cestu k suboru na disku z daneho URL, berie do uvahy aj custom path
	 * @param url - url adresa suboru, napr. /css/page.css
	 * @return - vrati cestu na disku, napr. /var/webapps/webjet/css/page.css
	 */
	public static String getRealPath(String url)
	{
<span class="pc bpc" id="L1972" title="1 of 2 branches missed.">		if (customPath != null)</span>
		{
			//skontroluj, ci pozadovany subor nie je custom
<span class="nc bnc" id="L1975" title="All 2 branches missed.">			File f = new File(customPath + File.separatorChar + Constants.getInstallName() + (url.startsWith(&quot;/&quot;)?&quot;&quot;:File.separatorChar) + url.replace('/', File.separatorChar));</span>
			//Logger.println(this,&quot;Checking CUSTOM: &quot;+f.getAbsolutePath());
<span class="nc bnc" id="L1977" title="All 2 branches missed.">			if (f.exists())</span>
			{
<span class="nc" id="L1979">				return(f.getAbsolutePath());</span>
			}
		}
<span class="fc" id="L1982">		return(Tools.getRealPath(url));</span>
	}

	public static String getOrigPath(HttpServletRequest request)
	{
<span class="fc" id="L1987">		return((String)request.getAttribute(&quot;path_filter_orig_path&quot;));</span>
	}

	/**
	 * Vrati adresu povodnej stranky, v pripade DOCID liniek vratane parametra docid
	 * @param request
	 * @return
	 */
	public static String getOrigPathDocId(HttpServletRequest request)
	{
<span class="pc bpc" id="L1997" title="3 of 4 branches missed.">		if (Constants.getInt(&quot;linkType&quot;)==Constants.LINK_TYPE_DOCID &amp;&amp; request.getParameter(&quot;docid&quot;)!=null)</span>
		{
<span class="nc" id="L1999">			return &quot;/showdoc.do?docid=&quot;+Tools.getDocId(request);</span>
		}
<span class="fc" id="L2001">		String origPath = getOrigPath(request);</span>

<span class="pc bpc" id="L2003" title="1 of 2 branches missed.">		if (&quot;/showdoc.do&quot;.equals(origPath)) origPath = origPath + &quot;?docid=&quot; + Tools.getDocId(request);</span>

<span class="fc" id="L2005">		return origPath;</span>
	}

	/**
	 * Vrati adresu povodnej stranky, v pripade DOCID liniek vratane docid s pridanym
	 * parametrom pre uload suboru pre stripes (aby to Stripes spracoval)
	 * @param request
	 * @return
	 */
	public static String getOrigPathUpload(HttpServletRequest request)
	{
<span class="pc bpc" id="L2016" title="3 of 4 branches missed.">		if (Constants.getInt(&quot;linkType&quot;)==Constants.LINK_TYPE_DOCID &amp;&amp; request.getParameter(&quot;docid&quot;)!=null)</span>
		{
<span class="nc" id="L2018">			return &quot;/showdoc.do?docid=&quot;+Tools.getDocId(request) +&quot;&amp;__sfu=1&quot;;</span>
		}
<span class="fc" id="L2020">		return getOrigPath(request)+&quot;?__sfu=1&quot;;</span>
	}

	public static boolean bypassPath(String path, ServletRequest servletRequest)
	{
		//aby nam lokalne fungoval customPath
<span class="pc bpc" id="L2026" title="3 of 4 branches missed.">		if (Tools.isNotEmpty(PathFilter.getCustomPath()) &amp;&amp; &quot;iwcm.interway.sk&quot;.equals(servletRequest.getServerName())) return false;</span>

<span class="fc bfc" id="L2028" title="All 2 branches covered.">		if (bypassPath == null)</span>
		{
<span class="fc" id="L2030">			synchronized(PathFilter.class) //NOSONAR</span>
			{
<span class="pc bpc" id="L2032" title="1 of 2 branches missed.">				if (bypassPath == null)</span>
				{
<span class="fc" id="L2034">					String[] tokens = Tools.getTokens(Constants.getString(&quot;pathFilterBypassPath&quot;), &quot;,&quot;, true);</span>
<span class="pc bpc" id="L2035" title="1 of 2 branches missed.">					bypassPath = tokens == null ? new String[0] : tokens;</span>
				}
<span class="fc" id="L2037">			}</span>
		}

<span class="pc bpc" id="L2040" title="1 of 2 branches missed.">		if (bypassPath.length &gt; 0)</span>
		{
<span class="nc bnc" id="L2042" title="All 2 branches missed.">			for (int i=0; i&lt;bypassPath.length; i++)</span>
			{
<span class="nc bnc" id="L2044" title="All 2 branches missed.">				if (path.startsWith(bypassPath[i])) return(true);</span>
			}
		}

<span class="fc" id="L2048">		return(false);</span>
	}

    /**
     * Nastavi cache hlavicky podla konf. premennej cacheStaticContentSeconds a cacheStaticContentSuffixes
     * @param path
     * @param user
     * @param request
     * @param response
     * @return
     */
	public static boolean setStaticContentHeaders(String path, Identity user, HttpServletRequest request, HttpServletResponse response)
	{
<span class="fc bfc" id="L2061" title="All 4 branches covered.">		if (path.startsWith(&quot;/cache/&quot;)==false &amp;&amp; request.getParameter(&quot;v&quot;)!=null)</span>
		{
			//vygeneruj odkaz bez v parametra, negeneruje pre fiktivne /cache/nieco.css linky
<span class="fc" id="L2064">			String canonicalLink = Tools.getBaseHref(request) + path;</span>
<span class="fc" id="L2065">			response.setHeader(&quot;Link&quot;, &quot;&lt;&quot;+canonicalLink+&quot;&gt;; rel=\&quot;canonical\&quot;&quot;);</span>
		}

		//vypnutie cachovania pre obrazky z imageeditora
<span class="fc bfc" id="L2069" title="All 2 branches covered.">		if (path.contains(&quot;/_tmp_&quot;))</span>
		{
<span class="fc" id="L2071">			response.setDateHeader(&quot;Expires&quot;,0);</span>
<span class="fc" id="L2072">			response.setDateHeader(&quot;Last-Modified&quot;, Tools.getNow());</span>
<span class="fc" id="L2073">			response.setHeader(&quot;Cache-Control&quot;,&quot;no-store, no-cache, must-revalidate, max-age=0&quot;);</span>
			//response.setHeader(&quot;Cache-Control&quot;,&quot;post-check=0, pre-check=0&quot;);
<span class="fc" id="L2075">			response.setHeader(&quot;Pragma&quot;,&quot;No-Cache&quot;);</span>
<span class="fc" id="L2076">			response.setHeader(&quot;Etag&quot;, &quot;&quot;);</span>

<span class="fc" id="L2078">			return false;</span>
		}

<span class="fc bfc" id="L2081" title="All 2 branches covered.">		if (cacheStaticContentSeconds &lt; 0)</span>
		{
<span class="fc" id="L2083">			cacheStaticContentSeconds = Constants.getInt(&quot;cacheStaticContentSeconds&quot;);</span>
		}

<span class="fc bfc" id="L2086" title="All 2 branches covered.">		if (cacheStaticContentSuffixes == null)</span>
		{
<span class="fc" id="L2088">			synchronized(PathFilter.class) //NOSONAR</span>
			{
<span class="pc bpc" id="L2090" title="1 of 2 branches missed.">				if (cacheStaticContentSuffixes == null)</span>
				{
<span class="fc" id="L2092">					String[] tokens = Tools.getTokens(Constants.getString(&quot;cacheStaticContentSuffixes&quot;), &quot;,&quot;, true);</span>
<span class="pc bpc" id="L2093" title="1 of 2 branches missed.">					cacheStaticContentSuffixes = tokens == null ? new String[0] : tokens;</span>
				}
<span class="fc" id="L2095">			}</span>
		}

		//prefixom /cache mame oznacene veci, co sa musia cachovat kvoli rychlosti admin casti (/admin/scripts/common.jsp)
<span class="fc bfc" id="L2099" title="All 2 branches covered.">		if (path.startsWith(&quot;/cache/&quot;)==false)</span>
		{
<span class="pc bpc" id="L2101" title="3 of 6 branches missed.">			if (cacheStaticContentSeconds&lt;1 || cacheStaticContentSuffixes==null || cacheStaticContentSuffixes.length&lt;1) return false;</span>

			//administratorom cache nenastavujem (okrem admin casti, tam sa to casto nemeni)
<span class="pc bpc" id="L2104" title="1 of 10 branches missed.">			if (user!=null &amp;&amp; user.isAdmin() &amp;&amp; path.startsWith(&quot;/admin&quot;)==false &amp;&amp; path.startsWith(&quot;/components&quot;)==false &amp;&amp; Constants.getBoolean(&quot;cacheStaticContentForAdmin&quot;)==false) return false;</span>

			//pre IP pre ktore neevidujeme statistiku nenastavujem (pravdepodobne IWAY + admini)
<span class="pc bpc" id="L2107" title="2 of 4 branches missed.">			if (Constants.getBoolean(&quot;cacheStaticContentForAdmin&quot;)==false &amp;&amp; BrowserDetector.isStatIpAllowedFast(request)==false) return false;</span>
		}
		//String pathLC = path.toLowerCase();
		//v parametri v sa prenasa verzia suboru, v tom pripade cachujeme
		//uz cachujem aj admin cast if (pathLC.startsWith(&quot;/admin/&quot;) &amp;&amp; (request.getParameter(&quot;v&quot;)==null &amp;&amp; request.getParameter(&quot;t&quot;)==null)) return false;

<span class="fc" id="L2113">		int myCacheStaticContentSeconds = cacheStaticContentSeconds;</span>
<span class="pc bpc" id="L2114" title="3 of 4 branches missed.">		if (myCacheStaticContentSeconds &lt; 1 &amp;&amp; path.startsWith(&quot;/cache/&quot;)) myCacheStaticContentSeconds = 300;</span>
		//ak mame parameter v tak natvrdo nastavime cas na 7 dni
<span class="fc bfc" id="L2116" title="All 2 branches covered.">		if (request.getParameter(&quot;v&quot;)!=null) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2117" title="All 2 branches covered.">		if (path.contains(&quot;ckeditor&quot;)) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2118" title="All 2 branches covered.">		if (path.contains(&quot;assets&quot;)) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2119" title="All 2 branches covered.">		if (path.contains(&quot;_common&quot;)) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2120" title="All 2 branches covered.">		if (path.contains(&quot;/admin/images/&quot;)) myCacheStaticContentSeconds = 60 * 60 * 24 * 7;</span>
<span class="fc bfc" id="L2121" title="All 4 branches covered.">		if (path.contains(&quot;/admin/v9/dist/&quot;) &amp;&amp; myCacheStaticContentSeconds&lt;301) myCacheStaticContentSeconds = 60 * 30;</span>

<span class="pc bpc" id="L2123" title="1 of 2 branches missed.">		if (myCacheStaticContentSeconds &lt; cacheStaticContentSeconds) myCacheStaticContentSeconds = cacheStaticContentSeconds;</span>

<span class="fc bfc" id="L2125" title="All 2 branches covered.">		for (int i=0; i&lt;cacheStaticContentSuffixes.length; i++)</span>
		{
<span class="fc bfc" id="L2127" title="All 2 branches covered.">			if (path.endsWith(cacheStaticContentSuffixes[i]))</span>
			{
<span class="fc" id="L2129">				setCacheHeaders(myCacheStaticContentSeconds, response);</span>

<span class="fc" id="L2131">				return true;</span>
			}
		}

		//cachovanie json pre dashboard
<span class="pc bpc" id="L2136" title="1 of 2 branches missed.">		if (path.contains(&quot;/admin/v9/json/&quot;)) {</span>
<span class="nc" id="L2137">			setCacheHeaders(60 * 60 * 24, response);</span>
		}

<span class="fc" id="L2140">		return false;</span>
	}

    /**
     * Nastavi HTTP hlavicku Content-Disposition na hdonotu attachment;filename=abc pre subory v adresaroch /files a /images
     * ktore maju priponu definovanu v konf. premennej forceDownloadSuffixes
     *
     * Umozni to vyvolat download dialog napr. pre pdf subory namiesto ich zobrazenia v prehliadaci
     *
     * @param path
     * @param request
     * @param response
     */
	public static void setDownloadHeaders(String path, HttpServletRequest request, HttpServletResponse response)
    {
<span class="fc bfc" id="L2155" title="All 2 branches covered.">        if (path.endsWith(&quot;/&quot;)) return;</span>

<span class="fc bfc" id="L2157" title="All 4 branches covered.">        if (path.startsWith(&quot;/images&quot;) || path.startsWith(&quot;/files&quot;))</span>
        {
            try
            {
<span class="fc" id="L2161">                int lomka = path.lastIndexOf(&quot;/&quot;);</span>
<span class="fc" id="L2162">                int bodka = path.indexOf(&quot;.&quot;, lomka);</span>
<span class="pc bpc" id="L2163" title="1 of 4 branches missed.">                if (lomka &gt; 0 &amp;&amp; bodka &gt; lomka)</span>
                {
<span class="fc" id="L2165">                    String fileName = path.substring(lomka + 1);</span>

<span class="pc bpc" id="L2167" title="1 of 2 branches missed.">                    if (isForceDownload(fileName))</span>
                    {
<span class="nc" id="L2169">                        response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=&quot;+fileName);</span>
                    }
                }
            }
<span class="nc" id="L2173">            catch (Exception ex)</span>
            {
<span class="nc" id="L2175">                sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L2176">            }</span>
        }
<span class="fc" id="L2178">    }</span>

    public static boolean isForceDownload(String fileName) {
<span class="fc" id="L2181">		String forceDownloadSuffixes = Constants.getString(&quot;forceDownloadSuffixes&quot;);</span>
<span class="fc" id="L2182">		String ext = FileTools.getFileExtension(fileName);</span>

<span class="pc bpc" id="L2184" title="3 of 4 branches missed.">		return (Tools.isNotEmpty(forceDownloadSuffixes) &amp;&amp; forceDownloadSuffixes.contains(ext));</span>
	}

	/**
	 * Nastavi cache hlavicky na pozadovanu hodnotu v sekundach
	 * @param myCacheStaticContentSeconds
	 * @param response
	 */
	public static void setCacheHeaders(int myCacheStaticContentSeconds, HttpServletResponse response)
	{
<span class="fc" id="L2194">		response.setHeader(&quot;Cache-Control&quot;, &quot;max-age=&quot;+myCacheStaticContentSeconds);</span>
<span class="fc bfc" id="L2195" title="All 2 branches covered.">		if (response.containsHeader(&quot;Pragma&quot;))	response.setHeader(&quot;Pragma&quot;,&quot;&quot;);</span>
<span class="fc bfc" id="L2196" title="All 2 branches covered.">		if (response.containsHeader(&quot;Expires&quot;)) response.setDateHeader(&quot;Expires&quot;, Tools.getNow()+myCacheStaticContentSeconds*1000);</span>
<span class="fc" id="L2197">	}</span>

	/**
	 * Cache pre staticke subory, cachuju sa len subory pre ktore sa nastavuje setStaticContentHeaders
	 * @param url
	 * @return
	 */
	public static boolean writeAndCacheFile(String url, HttpServletResponse response)
	{
		//ak je cache vypnuta, neriesime
<span class="nc bnc" id="L2207" title="All 2 branches missed.">		if (FileCache.useFileCache() == false) return false;</span>
		//pre DB storage tu cache neriesime, to sa riesi priamo v IwcmFsFilter
<span class="nc bnc" id="L2209" title="All 2 branches missed.">		if (IwcmFsDB.useDBStorage()) return false;</span>

<span class="nc" id="L2211">		String mimeType = Constants.getServletContext().getMimeType(url.toLowerCase());</span>
<span class="nc bnc" id="L2212" title="All 2 branches missed.">		if (Tools.isEmpty(mimeType)) mimeType = &quot;application/octet-stream&quot;;</span>
<span class="nc" id="L2213">		response.setContentType(mimeType);</span>

<span class="nc" id="L2215">		byte[] data = FileCache.getObject(url);</span>
<span class="nc bnc" id="L2216" title="All 2 branches missed.">		if (data != null)</span>
		{
<span class="nc" id="L2218">			response.setContentLength(data.length);</span>

			try
			{
<span class="nc" id="L2222">				OutputStream out=response.getOutputStream();</span>
<span class="nc" id="L2223">				out.write(data);</span>
<span class="nc" id="L2224">				out.close();</span>
<span class="nc" id="L2225">				return true;</span>
			}
<span class="nc" id="L2227">			catch (Exception ex)</span>
			{
<span class="nc" id="L2229">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L2230">			}</span>
		}
		else
		{
<span class="nc" id="L2234">			IwcmFile f = new IwcmFile(Tools.getRealPath(url));</span>
<span class="nc bnc" id="L2235" title="All 2 branches missed.">			if (f.length() &gt; FileCache.getMaxFileSize()) return false;</span>

<span class="nc" id="L2237">			response.setContentLength((int)f.length());</span>

			//nacitaj data do pola
<span class="nc" id="L2240">			data = new byte[(int)f.length()];</span>
<span class="nc" id="L2241">			boolean dataCopied = false;</span>

<span class="nc" id="L2243">			IwcmInputStream in = null;</span>
			try
			{
<span class="nc" id="L2246">				OutputStream out=response.getOutputStream();</span>

<span class="nc" id="L2248">				in = new IwcmInputStream(f);</span>

<span class="nc" id="L2250">				byte[] buffer = new byte[64000];</span>
<span class="nc" id="L2251">				int bytesRead = 0;</span>
<span class="nc" id="L2252">				int bytesCopied = 0;</span>
<span class="nc bnc" id="L2253" title="All 2 branches missed.">				while ((bytesRead = in.read(buffer, 0, 64000)) != -1)</span>
				{
					//Logger.debug(IwcmFsDB.class, &quot;writing &quot;+bytesRead);
<span class="nc" id="L2256">					out.write(buffer, 0, bytesRead);</span>

<span class="nc" id="L2258">					System.arraycopy(buffer, 0, data, bytesCopied, bytesRead);</span>
<span class="nc" id="L2259">					bytesCopied+=bytesRead;</span>
				}
<span class="nc" id="L2261">				out.flush();</span>
<span class="nc" id="L2262">				out.close();</span>
<span class="nc" id="L2263">				in.close();</span>

<span class="nc" id="L2265">				dataCopied = true;</span>
			}
<span class="nc" id="L2267">			catch (Exception e)</span>
			{
<span class="nc" id="L2269">				sk.iway.iwcm.Logger.error(e);</span>
			}
			finally
			{
<span class="nc bnc" id="L2273" title="All 2 branches missed.">				if (in != null) try { in.close(); } catch (Exception e) {}</span>
			}

<span class="nc bnc" id="L2276" title="All 2 branches missed.">			if (dataCopied)</span>
			{
<span class="nc" id="L2278">				FileCache.setObject(url, data);</span>
<span class="nc" id="L2279">				return true;</span>
			}
		}

<span class="nc" id="L2283">		return false;</span>
	}

	/**
	 * Nastavenie hlavicky X-Robots-Tag, viz https://developers.google.com/webmasters/control-crawl-index/docs/robots_meta_tag
	 * @param url
	 * @param response
	 */
	public static void setXRobotsTagValue(String url, HttpServletResponse response)
	{
<span class="fc" id="L2293">		String xRobotsTagUrls = Constants.getString(&quot;xRobotsTagUrls&quot;);</span>
<span class="pc bpc" id="L2294" title="1 of 2 branches missed.">		if (Tools.isEmpty(xRobotsTagUrls)) return;</span>

<span class="fc bfc" id="L2296" title="All 2 branches covered.">		if (url.charAt(0)=='/') url = url.toLowerCase(); //aby sa nam NOT_SEARCHABLE_PAGE nezmenilo na male pismena</span>

<span class="fc" id="L2298">		String[] paths = Tools.getTokens(xRobotsTagUrls, &quot;,&quot;, true);</span>
<span class="fc bfc" id="L2299" title="All 2 branches covered.">		for (String path : paths)</span>
		{
<span class="fc bfc" id="L2301" title="All 2 branches covered.">			if (ResponseHeaderService.isPathCorrect(path, url))</span>
			{
<span class="fc" id="L2303">				String xRobotsTagValue = Constants.getStringExecuteMacro(&quot;xRobotsTagValue&quot;);</span>
<span class="pc bpc" id="L2304" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(xRobotsTagValue))</span>
				{
<span class="fc" id="L2306">					response.setHeader(&quot;X-Robots-Tag&quot;, xRobotsTagValue);</span>
<span class="fc" id="L2307">					return;</span>
				}
			}
		}
<span class="fc" id="L2311">	}</span>

	public static void setUaCompatibleAdmin(String path, HttpServletResponse response)
	{
<span class="fc" id="L2315">		String xUaCompatibleAdminValue = Constants.getString(&quot;xUaCompatibleAdminValue&quot;);</span>
<span class="pc bpc" id="L2316" title="1 of 2 branches missed.">		if (Tools.isEmpty(xUaCompatibleAdminValue)) return;</span>


<span class="fc" id="L2319">		response.setHeader(&quot;X-UA-Compatible&quot;, xUaCompatibleAdminValue);</span>
<span class="fc" id="L2320">	}</span>

	/**
	 * Nastavi hlavicku X-Frame-Options podla konfiguracnej premennej xFrameOptions
	 * @param response
	 */
	private static void setXFrameOptions(HttpServletResponse response)
	{
<span class="fc" id="L2328">		String xFrameOptions = Constants.getString(&quot;xFrameOptions&quot;);</span>
<span class="pc bpc" id="L2329" title="1 of 2 branches missed.">		if (Tools.isEmpty(xFrameOptions)) return;</span>


<span class="fc" id="L2332">		response.setHeader(&quot;X-Frame-Options&quot;, xFrameOptions);</span>
<span class="fc" id="L2333">	}</span>

	private static void setXXssProtection(HttpServletResponse response)
	{
<span class="fc" id="L2337">		String xXssProtection = Constants.getString(&quot;xXssProtection&quot;);</span>
<span class="pc bpc" id="L2338" title="1 of 2 branches missed.">		if (Tools.isEmpty(xXssProtection)) return;</span>

<span class="fc" id="L2340">		response.setHeader(&quot;X-XSS-Protection&quot;, xXssProtection);</span>
<span class="fc" id="L2341">	}</span>

	/**
	 * Nastavi hlavicku Feature-Policy podla konfiguracnej premennej featurePolicyHeader
	 * @param response
	 */
	public static void setFeaturePolicy(HttpServletResponse response)
	{
<span class="fc" id="L2349">		String featurePolicy = Constants.getString(&quot;featurePolicyHeader&quot;);</span>
<span class="pc bpc" id="L2350" title="1 of 2 branches missed.">		if (Tools.isEmpty(featurePolicy)) return;</span>

<span class="nc" id="L2352">		response.setHeader(&quot;Feature-Policy&quot;, featurePolicy);</span>
<span class="nc" id="L2353">		response.setHeader(&quot;Permissions-Policy&quot;, featurePolicy);</span>
<span class="nc" id="L2354">	}</span>

	/**
	 * Nastavenie hlavicky Access-Control-Allow-Origin
	 * @param url
	 * @param response
	 */
	public static void setAccessControlAllowOrigin(String url, HttpServletResponse response)
	{
<span class="fc" id="L2363">		String accessControlAllowOriginUrls = Constants.getString(&quot;accessControlAllowOriginUrls&quot;);</span>
<span class="pc bpc" id="L2364" title="1 of 2 branches missed.">		if (Tools.isEmpty(accessControlAllowOriginUrls)) return;</span>

<span class="fc" id="L2366">		String[] paths = Tools.getTokens(accessControlAllowOriginUrls, &quot;,&quot;, true);</span>
<span class="fc" id="L2367">		String accessControlAllowOriginValue = Constants.getStringExecuteMacro(&quot;accessControlAllowOriginValue&quot;);</span>
<span class="fc bfc" id="L2368" title="All 2 branches covered.">		for (String path : paths)</span>
		{
<span class="fc bfc" id="L2370" title="All 2 branches covered.">			if (ResponseHeaderService.isPathCorrect(path, url))</span>
			{
<span class="pc bpc" id="L2372" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(accessControlAllowOriginValue))</span>
				{
<span class="fc" id="L2374">					String accessControlAllowedOrigins = Constants.getString(&quot;accessControlAllowedOrigins&quot;);</span>
<span class="fc" id="L2375">					boolean canAccess = false;</span>
<span class="pc bpc" id="L2376" title="1 of 2 branches missed.">					if (Tools.isEmpty(accessControlAllowedOrigins))</span>
					{
<span class="fc" id="L2378">						canAccess = true;</span>
					}
					else
					{
<span class="nc" id="L2382">						accessControlAllowedOrigins = Tools.replace(accessControlAllowedOrigins, &quot;\n&quot;, &quot;,&quot;);</span>
<span class="nc" id="L2383">						accessControlAllowedOrigins = Tools.replace(accessControlAllowedOrigins, &quot;\r&quot;, &quot;,&quot;);</span>
<span class="nc" id="L2384">						RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc bnc" id="L2385" title="All 2 branches missed.">						if (rb != null) {</span>
<span class="nc" id="L2386">							String origin = rb.getHeaderOrigin();</span>
<span class="nc bnc" id="L2387" title="All 2 branches missed.">							if (Tools.isNotEmpty(origin))</span>
							{
<span class="nc bnc" id="L2389" title="All 2 branches missed.">								if ((&quot;,&quot;+accessControlAllowedOrigins+&quot;,&quot;).contains(&quot;,&quot;+origin+&quot;,&quot;)) canAccess = true;</span>
							}
						}
					}

<span class="pc bpc" id="L2394" title="1 of 2 branches missed.">					if (canAccess)</span>
					{
<span class="fc" id="L2396">						response.setHeader(&quot;Access-Control-Allow-Origin&quot;, accessControlAllowOriginValue);</span>
<span class="fc" id="L2397">						setHeader(response, &quot;Access-Control-Allow-Headers&quot;, &quot;accessControlAllowHeaders&quot;);</span>
<span class="fc" id="L2398">						setHeader(response, &quot;Access-Control-Allow-Methods&quot;, &quot;accessControlAllowMethods&quot;);</span>
<span class="fc" id="L2399">						setHeader(response, &quot;Access-Control-Max-Age&quot;, &quot;accessControlMaxAge&quot;);</span>
<span class="fc" id="L2400">						return;</span>
					}
				}
			}
		}
<span class="fc" id="L2405">	}</span>

	/**
	 * Nastavi HTTP hlavicku podla nazvu konfiguracnej premennej
	 * @param response
	 * @param headerName - meno HTTP hlavicky
	 * @param constantName - meno konfiguracnej premennej
	 */
	public static void setHeader(HttpServletResponse response, String headerName, String constantName)
	{
<span class="fc" id="L2415">		String value = Constants.getStringExecuteMacro(constantName);</span>
<span class="fc bfc" id="L2416" title="All 2 branches covered.">		if (Tools.isEmpty(value)) return;</span>

<span class="pc bpc" id="L2418" title="1 of 2 branches missed.">		if (&quot;&amp;nbsp;&quot;.equals(value)) value = &quot; &quot;;</span>

		//Logger.debug(SetCharacterEncodingFilter.class, &quot;Setting header &quot;+headerName+&quot;:&quot;+value);

<span class="fc" id="L2422">		response.setHeader(headerName, value);</span>
<span class="fc" id="L2423">	}</span>

	/**
	 * Nastavi hlavicky pre konkretne volania podla konfiguracnej premennej responseHeaders
	 * @param response
	 */
	private static void setResponseHeaders(String path, HttpServletRequest request, HttpServletResponse response) {

<span class="pc bpc" id="L2431" title="1 of 6 branches missed.">		if (path.startsWith(&quot;/files&quot;) || path.startsWith(&quot;/images&quot;) || path.startsWith(&quot;/shared&quot;)) {</span>
<span class="fc" id="L2432">			String lngCode = Constants.getString(&quot;defaultLanguage&quot;);</span>
			//set last known language for files and images folder
<span class="fc bfc" id="L2434" title="All 2 branches covered.">			if (path.contains(&quot;/en/&quot;)) lngCode = &quot;en&quot;;</span>
<span class="pc bpc" id="L2435" title="1 of 2 branches missed.">			else if (path.contains(&quot;/de/&quot;)) lngCode = &quot;de&quot;;</span>
<span class="fc bfc" id="L2436" title="All 2 branches covered.">			else if (path.contains(&quot;/cz/&quot;)) lngCode = &quot;cz&quot;;</span>
<span class="pc bpc" id="L2437" title="1 of 2 branches missed.">			else if (path.contains(&quot;/sk/&quot;)) lngCode = &quot;sk&quot;;</span>
<span class="fc" id="L2438">			else lngCode = PageLng.getUserLng(request);</span>

<span class="fc" id="L2440">			String isoCode = PageLng.getUserLngIso(lngCode);</span>
<span class="fc" id="L2441">			ResponseHeaderService.setContentLanguageHeader(isoCode, true, request, response);</span>
		}

		// parse and cache
<span class="fc bfc" id="L2445" title="All 2 branches covered.">		if(responseHeaders == null) {</span>
<span class="fc" id="L2446">			synchronized (PathFilter.class) {</span>

<span class="fc" id="L2448">				String[] headers = Tools.getTokens(Constants.getString(&quot;responseHeaders&quot;), &quot;\n&quot;);</span>
<span class="pc bpc" id="L2449" title="1 of 2 branches missed.">				if(headers.length &gt; 0) {</span>
<span class="fc" id="L2450">					responseHeaders = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L2451" title="All 2 branches covered.">					for(int i = 0; i &lt; headers.length; i++) {</span>
<span class="fc" id="L2452">						responseHeaders.add(new ResponseHeaderBean(headers[i]));</span>
					}
				}
<span class="fc" id="L2455">			}</span>
		}

		// set headers
<span class="pc bpc" id="L2459" title="1 of 2 branches missed.">		if(responseHeaders != null) {</span>
<span class="fc bfc" id="L2460" title="All 2 branches covered.">			for(ResponseHeaderBean header : responseHeaders) {</span>
<span class="fc bfc" id="L2461" title="All 2 branches covered.">				if(path.startsWith(header.getUrl())) {</span>
<span class="fc" id="L2462">					response.setHeader(header.getName(), Constants.executeMacro(header.getValue()));</span>
				}
<span class="fc" id="L2464">			}</span>
		}

<span class="fc" id="L2467">		ResponseHeaderService.setResponseHeaders(path, request, response);</span>
<span class="fc" id="L2468">	}</span>

	/**
	 * Ak existuje _mobile.jsp verzia zadaneho JSP vykona nan interny forward a vrati true pre ukoncenie povodneho JSP, nieco ako:
	 * if (PathFilter.forwardToMobileOrTablet(&quot;/components/magzilla/new_bug_popup.jsp&quot;, pageContext)) return;
	 * @param jspFileName
	 * @param context
	 * @return
	 */
	public static boolean forwardToMobileOrTablet(String jspFileName, PageContext context)
	{
<span class="nc bnc" id="L2479" title="All 2 branches missed.">		if (BrowserDetector.isSmartphoneOrTablet((HttpServletRequest)context.getRequest())==false) return false;</span>

<span class="nc" id="L2481">		String mobileJsp = Tools.replace(jspFileName, &quot;.jsp&quot;, &quot;_mobile.jsp&quot;);</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">		if (FileTools.isFile(mobileJsp)==false) return false;</span>

		try
		{
<span class="nc" id="L2486">			context.forward(mobileJsp);</span>
<span class="nc" id="L2487">			return true;</span>
		}
<span class="nc" id="L2489">		catch (Exception e)</span>
		{
<span class="nc" id="L2491">			sk.iway.iwcm.Logger.error(e);</span>
		}
<span class="nc" id="L2493">		return false;</span>
	}

	/**
	 * Pouziva sa v spojeni s nginx cache proxy serverom, nastavuje cookie s nazvom nc ktora nasledne v
	 * dalsich http requestoch od klienta zamedzi posielaniu cache vysledkov (ak je nastavena na hodnotu 1)
	 * @param request
	 * @param response
	 */
	public static void setNginxProxyMode(HttpServletRequest request, HttpServletResponse response)
	{
		try
		{
<span class="pc bpc" id="L2506" title="1 of 2 branches missed.">			if (Constants.getBoolean(&quot;nginxProxyMode&quot;)==false) return;</span>

<span class="nc" id="L2508">			String actualCookieValue = Tools.getCookieValue(request.getCookies(), &quot;nc&quot;, null);</span>
<span class="nc" id="L2509">			Cookie c = new Cookie(&quot;nc&quot;, &quot;1&quot;);</span>
<span class="nc" id="L2510">			c.setPath(&quot;/&quot;);</span>

			//ak potrebujeme nastavit nocache cookie
<span class="nc bnc" id="L2513" title="All 2 branches missed.">			if (isNoCacheCookieRequired(request))</span>
			{
				//ak uz je nastavena na 1 tak ju nemusime nastavovat
<span class="nc bnc" id="L2516" title="All 2 branches missed.">				if (&quot;1&quot;.equals(actualCookieValue)==false) {</span>
					//session cookie
<span class="nc" id="L2518">					c.setMaxAge(-1);</span>
					//toto nesmie ist cez Tools.addCookie pretoze sa ani v pripade EU smernice nemoze vypnut
<span class="nc" id="L2520">					response.addCookie(c);</span>
				}
			}
			else
			{
<span class="nc bnc" id="L2525" title="All 2 branches missed.">				if (&quot;1&quot;.equals(actualCookieValue)) {</span>
					//cookie nam prisla v http requeste ale uz ju nemam setovat, takze ju dam zmazat
<span class="nc" id="L2527">					c.setMaxAge(0);</span>
					//toto nesmie ist cez Tools.addCookie pretoze sa ani v pripade EU smernice nemoze vypnut
<span class="nc" id="L2529">					response.addCookie(c);</span>
				}
			}
		}
<span class="nc" id="L2533">		catch (Exception e)</span>
		{
<span class="nc" id="L2535">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L2536">		}</span>
<span class="nc" id="L2537">	}</span>

	/**
	 * Overi, ci je mozne pouzit nginx proxy rezim (konstanta nginxProxyMode), ak je povoleny, overuje este:
	 * prihlaseneho pouzivatela (rezim nedostupny)
	 * prepnutie verzie cez forceBrowserDetector (ak je ina verzia ako pc nedostupne)
	 * @param request
	 * @return
	 */
	public static boolean isNoCacheCookieRequired(HttpServletRequest request)
	{
<span class="nc bnc" id="L2548" title="All 2 branches missed.">		if (request.getSession()!=null)</span>
		{
<span class="nc bnc" id="L2550" title="All 2 branches missed.">			if (request.getSession().getAttribute(Constants.USER_KEY)!=null) return true;</span>
<span class="nc bnc" id="L2551" title="All 4 branches missed.">			else if (request.getParameter(&quot;forceBrowserDetector&quot;)!=null &amp;&amp; &quot;pc&quot;.equals(request.getParameter(&quot;forceBrowserDetector&quot;))==false) return true; //NOSONAR</span>
<span class="nc bnc" id="L2552" title="All 2 branches missed.">			else if (request.getSession().getAttribute(&quot;BrowserDetector.forceBrowserDetector&quot;)!=null) return true; //NOSONAR</span>
		}

<span class="nc" id="L2555">		return false;</span>
	}


	/**
	 * Vrati URL adresu pre httpS presmerovanie
	 * @param request
	 * @return
	 */
	public static String getHttpsRedirectUrl(HttpServletRequest request)
	{
<span class="nc" id="L2566">		String path = PathFilter.getOrigPath(request);</span>
<span class="nc" id="L2567">		String qs = request.getQueryString();</span>
<span class="nc" id="L2568">		StringBuilder url = new StringBuilder(&quot;https://&quot;).append(Tools.getServerName(request)).append(path);</span>
<span class="nc bnc" id="L2569" title="All 2 branches missed.">		if (Tools.isNotEmpty(qs)) url.append('?').append(qs);</span>
<span class="nc" id="L2570">		return Tools.sanitizeHttpHeaderParam(url.toString());</span>
	}

	/**
	 * Otestuje, ci je povolene showdoc volanie pre dane docId
	 * @param docId - id dokumentu
	 * @param constantName - meno konstanty
	 * @return
	 */
	private static boolean isShowDocAllowDocId(int docId, String constantName)
	{
<span class="nc" id="L2581">		String showDocAllowDocIds = Constants.getString(constantName);</span>
<span class="nc bnc" id="L2582" title="All 2 branches missed.">		if (Tools.isNotEmpty(showDocAllowDocIds))</span>
		{
<span class="nc" id="L2584">			StringTokenizer st = new StringTokenizer(showDocAllowDocIds, &quot;,+;&quot;);</span>
<span class="nc bnc" id="L2585" title="All 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L2587">				int token = Tools.getIntValue(st.nextToken().trim(), -1);</span>
<span class="nc bnc" id="L2588" title="All 2 branches missed.">				if(token == -1) continue;	//preskocim</span>
<span class="nc bnc" id="L2589" title="All 2 branches missed.">				if(docId == token)</span>
				{
<span class="nc" id="L2591">					return true;</span>
				}
<span class="nc" id="L2593">			}</span>
		}
<span class="nc" id="L2595">		return false;</span>
	}

	public static void resetResponseHeaders() {
<span class="nc" id="L2599">		responseHeaders = null;</span>
<span class="nc" id="L2600">	}</span>

	public static void resetCacheStaticContentSeconds()
	{
<span class="nc" id="L2604">		cacheStaticContentSeconds = -1;</span>
<span class="nc" id="L2605">		cacheStaticContentSuffixes = null;</span>
<span class="nc" id="L2606">	}</span>

	//pre WebJET 9 kontrolujeme pri REST volaniach CSRF token
	private boolean checkCSRFToken(String path, HttpServletRequest request) {

		//check URL against custom CSRF required URLs #57521
<span class="fc" id="L2612">		boolean isCsrfRequired = DocTools.isUrlAllowed(path, &quot;csrfRequiredUrls&quot;, false);</span>
<span class="fc bfc" id="L2613" title="All 2 branches covered.">		if (isCsrfRequired) {</span>
<span class="fc" id="L2614">			String token = request.getParameter(CSRF.getParameterName());</span>
<span class="fc bfc" id="L2615" title="All 2 branches covered.">            if (Tools.isEmpty(token)) token = request.getHeader(&quot;x-csrf-token&quot;);</span>

<span class="fc bfc" id="L2617" title="All 4 branches covered.">            if (Tools.isNotEmpty(token) &amp;&amp; CSRF.verifyTokenAjax(request.getSession(), token))</span>
            {
<span class="fc" id="L2619">                return true;</span>
            }

<span class="fc" id="L2622">			return false;</span>
		}

<span class="pc bpc" id="L2625" title="2 of 6 branches missed.">		if (path.startsWith(&quot;/admin/rest/&quot;)==false || path.startsWith(&quot;/admin/rest/document/&quot;) || path.startsWith(&quot;/admin/rest/datatables/&quot;) ) {</span>
			//taketo URL nekontrolujeme
<span class="fc" id="L2627">			return true;</span>
		}

		//ak path obsahuje vyraz html tak token nie je potrebny
<span class="pc bpc" id="L2631" title="1 of 4 branches missed.">		if (path.contains(&quot;/html&quot;) || path.contains(&quot;html/&quot;)) return true;</span>

		//pouziva sa pri prihlaseni tokenom, vtedy CSRF nie je posielane
<span class="fc bfc" id="L2634" title="All 2 branches covered.">		if (request.getAttribute(&quot;csrfDisabled&quot;)!=null) return true;</span>

<span class="fc" id="L2636">		String header = request.getHeader(&quot;X-CSRF-Token&quot;);</span>
<span class="fc bfc" id="L2637" title="All 2 branches covered.">		if (Tools.isEmpty(header)) {</span>
<span class="fc" id="L2638">			return false;</span>
		}

<span class="fc" id="L2641">		return CSRF.verifyTokenAjax(request.getSession(), header);</span>
	}

	private static void setCustomPath(String path) {
<span class="fc" id="L2645">		PathFilter.customPath = path;</span>
<span class="fc" id="L2646">	}</span>

	/**
	 * Safely forward request dispatcher, need to use this if next statement is return
	 * eg. after checkAdmin you must return from PathFilter even when /404.jsp has compilation errors
	 * @param request
	 * @param response
	 * @param path
	 */
	private static void forwardSafely(String path, HttpServletRequest request, HttpServletResponse response){
		try {
<span class="fc" id="L2657">		request.getRequestDispatcher(path).forward(request, response);</span>
<span class="nc" id="L2658">		} catch (Exception ex) {</span>
<span class="nc" id="L2659">			Logger.error(PathFilter.class, ex);</span>
<span class="fc" id="L2660">		}</span>
<span class="fc" id="L2661">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>