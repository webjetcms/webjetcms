<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SendMail.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm</a> &gt; <span class="el_source">SendMail.java</span></div><h1>SendMail.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm;

import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.helpers.MailHelper;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmFsDB;
import sk.iway.iwcm.system.context.ContextFilter;
import sk.iway.iwcm.system.multidomain.MultiDomainFilter;
import sk.iway.iwcm.utils.Pair;

import javax.activation.DataHandler;
import javax.activation.FileDataSource;
import javax.activation.URLDataSource;
import javax.mail.*;
import javax.mail.internet.*;
import javax.servlet.http.HttpServletRequest;
import javax.swing.text.Document;
import javax.swing.text.EditorKit;
import javax.swing.text.ElementIterator;
import javax.swing.text.html.HTML;
import javax.swing.text.html.HTMLEditorKit;
import java.io.*;
import java.net.URL;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.Timestamp;
import java.sql.Types;
import java.util.*;

//import sk.iway.intranet.dms.DmsNotify;

/**
 *  Odosielanie emailu, priklad telnet spojenia:

EHLO tau19.iway.sk
MAIL FROM:noreply@interway.sk
RCPT TO:veronika.husarova@employment.gov.sk
DATA
From:noreply@interway.sk
To:veronika.husarova@employment.gov.sk
Subject:test

Test
.
QUIT

 *
 *@Title        magma-web
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: 1.13 $
 *@created      Nedeďż˝e, 2003, februďż˝r 2
 *@modified     $Date: 2004/03/23 19:23:05 $
 */
<span class="nc" id="L57">public class SendMail</span>
{

	/**
     * Comment for &lt;code&gt;AUTOREPLY_DAEMON&lt;/code&gt;
     */
    	public static final String AUTOREPLY_SUBJECT = &quot;AUTOREPLY-&quot;;
	public static final String EMAIL_PROTECTION_SENDER_KEY = &quot;emailProtectionSenderEmail&quot;;
	public static final String EMAIL_PROTECTION_SENDER_NAME_KEY = &quot;emailProtectionSenderName&quot;;

	public static boolean send(String fromName, String fromEmail, String toEmail, String subject, String text)
	{
<span class="fc" id="L69">		return (send(fromName, fromEmail, toEmail, null, null, subject, text, null));</span>
	}

	public static boolean send(String fromName, String fromEmail, String toEmail, String subject, String text, HttpServletRequest request)
	{
<span class="fc" id="L74">		String baseHref = Tools.getBaseHref(request)+&quot;/&quot;;</span>
<span class="fc" id="L75">		return (send(fromName, fromEmail, toEmail, null, null, null, subject, text, baseHref, null));</span>
	}

	public static boolean send(String fromName, String fromEmail, String toEmail, String subject, String text, String attachments)
	{
<span class="nc" id="L80">		return (send(fromName, fromEmail, toEmail, null, null, subject, text, attachments));</span>
	}

	public static boolean send(String fromName, String fromEmail, String toEmail, String ccEmail, String bccEmail, String subject, String text, String attachments)
	{
<span class="fc" id="L85">		return(send(fromName, fromEmail, toEmail, null, ccEmail, bccEmail, subject, text, null, attachments));</span>
	}

	public static boolean send(String senderName, String senderEmail, String recipientEmail, String replyTo, String ccEmail, String bccEmail, String subject, String message, String baseHref, String attachmentsList)
	{
<span class="fc" id="L90">		return sendCapturingException(senderName, senderEmail, recipientEmail, replyTo, ccEmail, bccEmail, subject, message, baseHref, attachmentsList).first;</span>
	}

	 public static Pair&lt;Boolean, Exception&gt; sendCapturingException(String senderName, String senderEmail, String recipientEmail, String replyTo, String ccEmail, String bccEmail, String subject, String message, String baseHref, String attachmentsList)
	 {
<span class="fc" id="L95">		  return sendCapturingException(senderName, senderEmail, recipientEmail, replyTo, ccEmail, bccEmail, subject, message, baseHref, attachmentsList, true);</span>
	 }

	 public static Pair&lt;Boolean, Exception&gt; sendCapturingException(String senderName, String senderEmail, String recipientEmail, String replyTo, String ccEmail, String bccEmail, String subject, String message, String baseHref, String attachmentsList, boolean sendLaterWhenException)
	 {
<span class="fc" id="L100">		  return sendCapturingException(senderName, senderEmail, recipientEmail, replyTo, ccEmail, bccEmail, subject, message, baseHref, attachmentsList, sendLaterWhenException, true);</span>
	 }

	/**
	 * Odoslanie emailu
	 * @param senderName - meno odosielatela emailu
	 * @param senderEmail - email odosielatela emailu
	 * @param recipientEmail - email prijemcu
	 * @param replyTo - email pre pole replyTo, alebo null
	 * @param subject - predmet
	 * @param message - body emailu, moze byt v HTML formate, vratane odkazov na obrazky a linky
	 * @param baseHref - base HTTP adresa (aby bolo mozne nalinkovat obrazky a spravit relativne linky)
	 * @param attachmentsList - zoznam priloh vo formate url_adresa1;nazov_suboru_do_emailu1;url_adresa2;nazov_suboru_do_emailu2;
	 * @param sendLaterWhenException - ak je true, tak pri exception pri odosielani, ulozi e-mail pre neskorsie odoslanie
	 * @param writeToAuditLog - ak je false, tak sa posle len e-mail, ale nezapise sa nic do auditlogu
	 * @return true, ak sa email podarilo odoslat, inak false
	 * @throws Exception
	 */
	public static Pair&lt;Boolean, Exception&gt; sendCapturingException(String senderName, String senderEmail, String recipientEmail, String replyTo, String ccEmail, String bccEmail, String subject, String message, String baseHref, String attachmentsList, boolean sendLaterWhenException, boolean writeToAuditLog) {
<span class="fc" id="L119">		MailHelper mailHelper = new MailHelper()</span>
<span class="fc" id="L120">				.setFromName(senderName)</span>
<span class="fc" id="L121">				.setFromEmail(senderEmail)</span>
<span class="fc" id="L122">				.setToEmail(recipientEmail)</span>
<span class="fc" id="L123">				.setReplyTo(replyTo)</span>
<span class="fc" id="L124">				.setCcEmail(ccEmail)</span>
<span class="fc" id="L125">				.setBccEmail(bccEmail)</span>
<span class="fc" id="L126">				.setSubject(subject)</span>
<span class="fc" id="L127">				.setMessage(message)</span>
<span class="fc" id="L128">				.setBaseHref(baseHref)</span>
<span class="fc" id="L129">				.setAttachments(attachmentsList)</span>
<span class="fc" id="L130">				.setSendLaterWhenException(sendLaterWhenException)</span>
<span class="fc" id="L131">				.setWriteToAuditLog(writeToAuditLog);</span>

<span class="fc" id="L133">		return sendCapturingException(mailHelper);</span>
	}

	public static Pair&lt;Boolean, Exception&gt; sendCapturingException(MailHelper mailHelper)
	{
<span class="fc" id="L138">		String senderName = mailHelper.getFromName();</span>
<span class="fc" id="L139">		String senderEmail = mailHelper.getFromEmail();</span>
<span class="fc" id="L140">		String recipientEmail = mailHelper.getToEmail();</span>
<span class="fc" id="L141">		String replyTo = mailHelper.getReplyTo();</span>
<span class="fc" id="L142">		String ccEmail = mailHelper.getCcEmail();</span>
<span class="fc" id="L143">		String bccEmail = mailHelper.getBccEmail();</span>
<span class="fc" id="L144">		String subject = mailHelper.getSubject();</span>
<span class="fc" id="L145">		String message = mailHelper.getMessage();</span>
<span class="fc" id="L146">		String baseHref = mailHelper.getBaseHref();</span>
<span class="fc" id="L147">		String attachmentsList = mailHelper.getAttachments();</span>
<span class="fc" id="L148">		boolean sendLaterWhenException = mailHelper.isSendLaterWhenException();</span>
<span class="fc" id="L149">		boolean writeToAuditLog = mailHelper.isWriteToAuditLog();</span>
<span class="fc" id="L150">		List&lt; Pair&lt;String, String&gt; &gt; headers = mailHelper.getHeaders();</span>

<span class="pc bpc" id="L152" title="3 of 4 branches missed.">		if (&quot;false&quot;.equals(Constants.getString(&quot;useSMTPServer&quot;)) &amp;&amp; writeToAuditLog) // mail neodosleme ale ulozime do db pre \odoslanie na inom node, okrem pripadu, ze potrebujeme odoslat chybu sposobenu pri dosiahnuti maximalenho poctu DB spojeni</span>
		{
<span class="nc" id="L154">			Logger.debug(SendMail.class, &quot;useSMTPServer=false -&gt; sending later. &quot; );</span>
<span class="nc" id="L155">			boolean result = sendLater(senderName, senderEmail, recipientEmail, replyTo, ccEmail, bccEmail, subject, message, baseHref, null, null, attachmentsList);</span>
<span class="nc" id="L156">			return Pair.of(result, null);</span>
		}

		//debugMail
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(Constants.getString(&quot;debugEmail&quot;)))</span>
		{
<span class="nc" id="L162">			Logger.debug(SendMail.class, &quot;debugEmail=&quot;+Constants.getString(&quot;debugEmail&quot;));</span>
<span class="nc" id="L163">			recipientEmail = Constants.getString(&quot;debugEmail&quot;);</span>
		}
		//pridanie ContextPath pre admin cast (ak je nastavene)
<span class="pc bpc" id="L166" title="3 of 4 branches missed.">		if (Tools.isNotEmpty(Constants.getString(&quot;contextPathAdmin&quot;)) &amp;&amp; message.indexOf(&quot;://cms&quot;)!=-1)</span>
		{
<span class="nc" id="L168">			message = ContextFilter.addContextPath(Constants.getString(&quot;contextPathAdmin&quot;), message);</span>
<span class="nc" id="L169">			subject = ContextFilter.addContextPath(Constants.getString(&quot;contextPathAdmin&quot;), subject);</span>
		}

<span class="fc" id="L172">		Prop prop = Prop.getInstance(Constants.getString(&quot;defaultLanguage&quot;));</span>

		//vynimka helpdesk@websupport.sk je kvoli Cloudu a notifikaciam na WebSupport kedy nam odmietaju emaili z noreply@webjet.eu spracovat
<span class="pc bpc" id="L175" title="3 of 4 branches missed.">		if (Tools.isEmail(Constants.getString(EMAIL_PROTECTION_SENDER_KEY)) &amp;&amp; &quot;helpdesk@websupport.sk&quot;.equals(recipientEmail)==false)</span>
		{
<span class="nc" id="L177">			String from = Constants.getString(EMAIL_PROTECTION_SENDER_KEY);</span>
<span class="nc" id="L178">			String oldSender = senderEmail;</span>
<span class="nc" id="L179">			senderEmail = from;</span>

<span class="nc" id="L181">			String defaultName = Constants.getString(EMAIL_PROTECTION_SENDER_NAME_KEY);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">			if (Tools.isNotEmpty(defaultName)) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">				if (defaultName.equalsIgnoreCase(&quot;same-as-email&quot;)) {</span>
<span class="nc" id="L184">					senderName = from;</span>
				}
				else {
<span class="nc" id="L187">					senderName = defaultName;</span>
				}
			}

<span class="nc bnc" id="L191" title="All 2 branches missed.">			if (!from.equals(oldSender))</span>
			{
<span class="nc bnc" id="L193" title="All 2 branches missed.">				if (Tools.isEmpty(replyTo))</span>
<span class="nc" id="L194">					replyTo = oldSender;</span>
				//else - replyTo nemoze obsahovat viacero email adries!
				//	replyTo += &quot;,&quot;+oldSender;
			}
		}

<span class="fc" id="L200">		RequestBean requestBean = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">		if (requestBean != null)</span>
		{
<span class="fc bfc" id="L203" title="All 2 branches covered.">			if (Tools.isEmpty(baseHref)) baseHref = requestBean.getBaseHref();</span>
		}
<span class="pc bfc" id="L205" title="All 2 branches covered.">		if (Tools.isEmpty(baseHref)) try { baseHref = Tools.getBaseHref(null); } catch (Exception ex) {}</span>

		//ak je &lt;img src='xxxx' tak sa to nezobrazi v mozille
		try
		{
<span class="fc" id="L210">			int start = message.indexOf(&quot;src='&quot;);</span>
			int end;
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">			while (start != -1)</span>
			{
<span class="nc" id="L214">				end = message.indexOf(&quot;'&quot;, start+6);</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">				if (end &gt; start)</span>
				{
<span class="nc" id="L217">					message = message.substring(0, start) + &quot;src=\&quot;&quot; + message.substring(start+5, end) + &quot;\&quot;&quot; + message.substring(end+1);</span>
					//Logger.println(this,message);
				}
				else
				{
					//ukonci cyklus
					break;
				}
			}
		}
<span class="nc" id="L227">		catch (Exception e)</span>
		{
<span class="nc" id="L229">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L230">		}</span>

<span class="pc bpc" id="L232" title="1 of 4 branches missed.">		if (baseHref!=null &amp;&amp; baseHref.length()&gt;8)</span>
		{
			//uprav to z adresy http://www.interway.sk/nieco/stranka.html na http://www.interway.sk
<span class="fc" id="L235">			int i = baseHref.indexOf('/', 9);</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">			if (i!=-1)</span>
			{
<span class="fc" id="L238">				baseHref = baseHref.substring(0, i);</span>
<span class="fc" id="L239">				Logger.println(SendMail.class,&quot;baseHref: &quot; + baseHref);</span>
			}
		}

		//oprav linky
<span class="fc" id="L244">		message = SendMail.createAbsolutePath(message, baseHref);</span>

<span class="fc" id="L246">		Properties props = System.getProperties();</span>
<span class="fc" id="L247">		props.put(&quot;mail.smtp.host&quot;, Constants.getString(&quot;smtpServer&quot;));</span>
<span class="fc" id="L248">        props.put(&quot;mail.mime.charset&quot;, SetCharacterEncodingFilter.getEncoding());</span>

<span class="fc" id="L250">		Session ms = getSession(props);</span>


		try
		{
			//ak nie je zadany odosielatel, domyslime si ho
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">			if (Tools.isEmpty(senderEmail))</span>
			{
<span class="nc" id="L258">				senderEmail = recipientEmail;</span>
			}

			//uprav email formatu lubos@balat.sk,pokus@interway.sk pretoze
			//niekedy je sender rovnaky ako prijemca
<span class="fc" id="L263">			senderEmail = getFirstEmailAddress(senderEmail);</span>
		}
<span class="nc" id="L265">		catch (Exception e)</span>
		{
<span class="nc" id="L267">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L268">		}</span>

<span class="fc bfc" id="L270" title="All 2 branches covered.">		if (subject.indexOf(&quot;WebJET restart&quot;)==-1)</span>
		{

			//Logger.println(this,&quot;SendMailMultipart from:&quot;+senderName+&quot; &lt;&quot;+senderEmail+&quot;&gt; to:&quot;+recipientEmail);
<span class="fc" id="L274">			Logger.debug(SendMail.class,&quot;SendMail[&quot;+Constants.getInstallName()+&quot;]: sending email from: &quot; + senderEmail + &quot; to: &quot; + recipientEmail+&quot; subject: &quot;+subject+&quot;|&quot;);</span>

<span class="pc bpc" id="L276" title="1 of 2 branches missed.">			if (&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
			{
<span class="nc" id="L278">				Logger.debug(SendMail.class, &quot;email from:&quot; + senderEmail + &quot; to:&quot; + recipientEmail+&quot; subject:&quot;+subject + &quot; body:&quot;+message);</span>
			}

<span class="pc bpc" id="L281" title="1 of 2 branches missed.">			if(writeToAuditLog)</span>
			{
<span class="pc bpc" id="L283" title="5 of 6 branches missed.">				 if (&quot;cloud&quot;.equals(Constants.getInstallName()) &amp;&amp; message.indexOf(&quot;Heslo:&quot;)==-1 &amp;&amp; message.indexOf(&quot;Password:&quot;)==-1)</span>
				 {
					  //pre cloud (mimo dmailu) logujeme aj telo emailu
<span class="nc" id="L286">					  Adminlog.add(Adminlog.TYPE_SENDMAIL, &quot;email from:&quot; + senderEmail + &quot; to:&quot; + recipientEmail+&quot; subject:&quot;+subject + &quot; body:&quot;+message, -1, -1);</span>
				 }
				 else
				 {
<span class="fc" id="L290">					  Adminlog.add(Adminlog.TYPE_SENDMAIL, &quot;email from:&quot; + senderEmail + &quot; to:&quot; + recipientEmail+&quot; subject:&quot;+subject, -1, -1);</span>
				 }
			}
		}

		try
		{
<span class="fc" id="L297">			Message mes = new MimeMessage(ms);</span>


<span class="pc bpc" id="L300" title="1 of 2 branches missed.">			if (subject.startsWith(AUTOREPLY_SUBJECT))</span>
			{
<span class="nc" id="L302">			    mes.setHeader(&quot;X-Autoreply&quot;,AUTOREPLY_SUBJECT);</span>
			}

<span class="pc bpc" id="L305" title="3 of 4 branches missed.">			if (headers != null &amp;&amp; headers.size() &gt; 0)</span>
			{
<span class="nc bnc" id="L307" title="All 2 branches missed.">				for (Pair&lt;String, String&gt; header : headers)</span>
				{
<span class="nc" id="L309">					mes.setHeader(header.getFirst(), header.getSecond());</span>
<span class="nc" id="L310">				}</span>
			}

<span class="pc bpc" id="L313" title="1 of 2 branches missed.">			if (senderEmail.length() &gt; 0)</span>
			{
<span class="fc" id="L315">				mes.setFrom(new InternetAddress(senderEmail, senderName));</span>
			}
			else
			{
<span class="nc" id="L319">				mes.setFrom(new InternetAddress(&quot;bez.emailu@interway.sk&quot;));</span>
			}

			//mes.setFrom(new InternetAddress(senderEmail, DB.internationalToEnglish(senderName)));
<span class="fc" id="L323">			mes.setRecipients(Message.RecipientType.TO, InternetAddress.parse(recipientEmail, false));</span>
			try
			{
<span class="pc bpc" id="L326" title="3 of 4 branches missed.">				if (replyTo != null &amp;&amp; replyTo.indexOf('@') != -1)</span>
				{
<span class="nc" id="L328">					InternetAddress[] rt = new InternetAddress[1];</span>
<span class="nc" id="L329">					replyTo = getFirstEmailAddress(replyTo);</span>
<span class="nc" id="L330">					rt[0] = new InternetAddress(DB.internationalToEnglish(replyTo));</span>
<span class="nc" id="L331">					mes.setReplyTo(rt);</span>
				}
<span class="pc bpc" id="L333" title="3 of 4 branches missed.">				if (ccEmail != null &amp;&amp; ccEmail.indexOf('@')!=-1)</span>
				{
<span class="nc" id="L335">					InternetAddress[] ccAddrs = InternetAddress.parse(ccEmail, false);</span>
<span class="nc" id="L336">					mes.setRecipients(Message.RecipientType.CC, ccAddrs);</span>
				}
<span class="pc bpc" id="L338" title="3 of 4 branches missed.">				if (bccEmail != null &amp;&amp; bccEmail.indexOf('@')!=-1)</span>
				{
<span class="nc" id="L340">					InternetAddress[] bccAddrs = InternetAddress.parse(bccEmail, false);</span>
<span class="nc" id="L341">					mes.setRecipients(Message.RecipientType.BCC, bccAddrs);</span>
				}
			}
<span class="nc" id="L344">			catch (Exception ex)</span>
			{
<span class="nc" id="L346">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L347">			}</span>

<span class="fc" id="L349">			String emailEncoding = Constants.getString(&quot;emailEncoding&quot;);</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">			if (Tools.isEmpty(emailEncoding))</span>
			{
<span class="fc" id="L352">				emailEncoding = SetCharacterEncodingFilter.getEncoding();</span>
			}

<span class="fc" id="L355">			mes.setSubject(MimeUtility.encodeText(subject, emailEncoding, null));</span>
<span class="fc" id="L356">			mes.setSentDate(new java.util.Date());</span>


<span class="pc bpc" id="L359" title="1 of 4 branches missed.">			if (isHtmlContent(message) || Tools.isNotEmpty(attachmentsList))</span>
			{
<span class="fc" id="L361">				Multipart mpart = new MimeMultipart(&quot;mixed&quot;);</span>
<span class="fc" id="L362">				Multipart attachments = new MimeMultipart();</span>
<span class="fc" id="L363">				Multipart related = new MimeMultipart();</span>
<span class="fc" id="L364">				message = putInlineAttachments(attachments, related, message, baseHref);</span>

<span class="fc" id="L366">				boolean attachFiles = true;</span>
				String serverPath;
				String fileName;
<span class="fc" id="L369">				StringTokenizer st = null;</span>
<span class="fc" id="L370">				long size = 0;</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(attachmentsList))   //skontroluj normalne attachmenty</span>
				{
<span class="nc" id="L373">					st = new StringTokenizer(attachmentsList, &quot;;&quot;);</span>

<span class="nc" id="L375">					IwcmFile file = null;</span>
<span class="nc bnc" id="L376" title="All 4 branches missed.">					while (st.hasMoreTokens() &amp;&amp; attachFiles)   //zisti velkosti priloh</span>
					{
<span class="nc" id="L378">						serverPath = st.nextToken();</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">						if (st.hasMoreTokens())</span>
						{
<span class="nc" id="L381">							file = IwcmFile.fromVirtualPath(serverPath);</span>
							//try absolute path otherwise
<span class="nc bnc" id="L383" title="All 2 branches missed.">							if (!file.exists()) file = new IwcmFile(serverPath);</span>

<span class="nc" id="L385">							size += file.length();</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">							if (size &gt; Constants.getLong(&quot;maxSizeOfAttachments&quot;))</span>
							{
<span class="nc" id="L388">								attachFiles = false;   //ak je velkost prilohy vacsia ako stanovena hranica, prilohy k mailu nepripojim</span>
							}
						}

					}
				}
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">				if (!attachFiles)</span>
				{
<span class="nc" id="L396">					message += prop.getText(&quot;email.too_large_attachments&quot;);</span>
				}

				// create wrap if we have related attachments - images in html
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">				if (related.getCount() &gt; 0)</span>
				{
<span class="nc" id="L402">					Logger.println(SendMail.class, &quot;mam nejake related, posielam&quot;);</span>
<span class="nc" id="L403">					putMessagePart(mpart, message, related);</span>
				} else
				{
<span class="fc" id="L406">					putMessagePart(mpart, message, null);</span>
				}
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">				for (int i = 0; i &lt; attachments.getCount(); i++)</span>
				{
<span class="nc" id="L410">					mpart.addBodyPart(attachments.getBodyPart(i));</span>
				}
				//nahod normalne attachmenty
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(attachmentsList))</span>
				{
<span class="nc bnc" id="L415" title="All 2 branches missed.">					if (attachFiles)</span>
					{
<span class="nc" id="L417">						st = new StringTokenizer(attachmentsList, &quot;;&quot;);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">						while (st.hasMoreTokens())</span>
						{
<span class="nc" id="L420">							serverPath = st.nextToken();</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">							if (st.hasMoreTokens())</span>
							{
<span class="nc" id="L423">								fileName = st.nextToken();</span>
<span class="nc" id="L424">								SendMail.attFile(serverPath, fileName, mpart);</span>
							}
						}
					}
				}

<span class="fc" id="L430">				mes.setContent(mpart);</span>
<span class="fc" id="L431">			}</span>
			else
			{
				//je to plain text email
<span class="fc" id="L435">				mes.setContent(message, &quot;text/plain; charset=&quot;+emailEncoding);</span>
			}

			try
			{
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;sendMailSaveEmail&quot;)) {</span>
<span class="nc" id="L441">					saveEmailToFile(mes);</span>
				}
				else
				{
<span class="fc" id="L445">					Transport.send(mes);</span>
				}
<span class="fc" id="L447">				Logger.debug(SendMail.class,&quot;email odoslany&quot;);</span>
<span class="fc" id="L448">				return Pair.of(true, null);</span>
			}
<span class="nc" id="L450">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L452" title="All 2 branches missed.">				if (subject.indexOf(&quot;WebJET restart&quot;)==-1)</span>
				{
<span class="nc" id="L454">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L455">					Adminlog.add(Adminlog.TYPE_SENDMAIL, &quot;ERROR sending email (from: &quot;+senderEmail+&quot;, to: &quot;+recipientEmail+&quot;, cc: &quot;+ccEmail+&quot;, bcc: &quot;+bccEmail+&quot;, subject: &quot;+subject+&quot;) ex:&quot;+ex.getMessage()+&quot;\n\n&quot;+Logger.getStackTrace(ex), -1, -1);</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">					if (sendLaterWhenException) //mail ulozim pre neskorsie poslanie</span>
					{
<span class="nc" id="L458">						Logger.debug(SendMail.class, &quot;sendLaterWhenException=true -&gt; sending later.&quot; );</span>
<span class="nc" id="L459">						sendLater(senderName, senderEmail, recipientEmail, replyTo, ccEmail, bccEmail, subject, message, baseHref, null, null, attachmentsList);</span>
					}
				}
<span class="nc" id="L462">				return Pair.of(false, ex);</span>
			}
		}
<span class="nc" id="L465">		catch (Exception e)</span>
		{
<span class="nc bnc" id="L467" title="All 2 branches missed.">			if (subject.indexOf(&quot;WebJET restart&quot;)==-1)</span>
			{
<span class="nc" id="L469">				sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L470">                Adminlog.add(Adminlog.TYPE_SENDMAIL, &quot;ERROR sending email (from: &quot;+senderEmail+&quot;, to: &quot;+recipientEmail+&quot;, cc: &quot;+ccEmail+&quot;, bcc: &quot;+bccEmail+&quot;, subject: &quot;+subject+&quot;) ex:&quot;+e.getMessage()+&quot;\n\n&quot;+Logger.getStackTrace(e), -1, -1);</span>
			}
<span class="nc" id="L472">			return Pair.of(false, e);</span>
		}
	}

	private static void saveEmailToFile(Message mes) {
<span class="nc" id="L477">		String sendMailSaveEmailPath = Constants.getString(&quot;sendMailSaveEmailPath&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">		if (Tools.isEmpty(sendMailSaveEmailPath)) {</span>
<span class="nc" id="L479">			Logger.debug(SendMail.class, &quot;sendMailSaveEmailPath is not configured&quot;);</span>
<span class="nc" id="L480">			return;</span>
		}

<span class="nc" id="L483">		Logger.debug(SendMail.class, String.format(&quot;Email neodosielam, zapisujem do: %s&quot;, sendMailSaveEmailPath));</span>
<span class="nc" id="L484">		String realPath = Tools.getRealPath(sendMailSaveEmailPath);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">		if (!realPath.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L486">			realPath += &quot;/&quot;;</span>
		}

<span class="nc" id="L489">		File file = new File(realPath + new Date().getTime() + &quot;.eml&quot;);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">		if (!file.getParentFile().exists()) {</span>
<span class="nc" id="L491">			file.getParentFile().mkdirs();</span>
		}
		try {
<span class="nc" id="L494">			FileOutputStream fileOutputStream = new FileOutputStream(file);</span>
<span class="nc" id="L495">			mes.writeTo(fileOutputStream);</span>
<span class="nc" id="L496">			fileOutputStream.close();</span>

<span class="nc" id="L498">			Logger.debug(SendMail.class, &quot;Email zapisany&quot;);</span>
<span class="nc" id="L499">		} catch (IOException | MessagingException e) {</span>
<span class="nc" id="L500">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L501">		}</span>
<span class="nc" id="L502">	}</span>

	public static boolean sendLater(String senderName, String senderEmail, String recipientEmail, String replyTo, String ccEmail, String bccEmail, String subject, String message, String baseHref, String date, String time)
	{
<span class="nc" id="L506">		return sendLater(senderName, senderEmail, recipientEmail, replyTo, ccEmail, bccEmail, subject, message, baseHref, date, time,null);</span>
	}

	/**
	 * Oneskorene odoslanie emailu
	 * @param senderName
	 * @param senderEmail
	 * @param recipientEmail
	 * @param replyTo
	 * @param subject
	 * @param message
	 * @param baseHref
	 * @param date
	 * @param time
	 * @return
	 */
	public static boolean sendLater(String senderName, String senderEmail, String recipientEmail, String replyTo, String ccEmail, String bccEmail, String subject, String message, String baseHref, String date, String time,String attachments)
	{
		//pridanie ContextPath pre admin cast (ak je nastavene)
<span class="nc bnc" id="L525" title="All 4 branches missed.">		if (Tools.isNotEmpty(Constants.getString(&quot;contextPathAdmin&quot;)) &amp;&amp; message.indexOf(&quot;://cms&quot;)!=-1)</span>
		{
<span class="nc" id="L527">			message = ContextFilter.addContextPath(Constants.getString(&quot;contextPathAdmin&quot;), message);</span>
<span class="nc" id="L528">			subject = ContextFilter.addContextPath(Constants.getString(&quot;contextPathAdmin&quot;), subject);</span>
		}

		//uloz si parametre do DB a posli to v stanovenom case
		try
		{
<span class="nc" id="L534">			Connection db_conn = DBPool.getConnection();</span>
			try
			{
<span class="nc" id="L537">				PreparedStatement ps = db_conn.prepareStatement(&quot;INSERT INTO emails (recipient_email, recipient_name, sender_name, sender_email, subject, url, attachments, retry, sent_date, created_by_user_id, create_date, send_at, message, reply_to, cc_email, bcc_email) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;);</span>
				try
				{
<span class="nc" id="L540">					int counter = 1;</span>
<span class="nc" id="L541">					ps.setString(counter++, recipientEmail);</span>
<span class="nc" id="L542">					ps.setString(counter++, recipientEmail);</span>
<span class="nc" id="L543">					ps.setString(counter++, senderName);</span>
<span class="nc" id="L544">					ps.setString(counter++, senderEmail);</span>
<span class="nc" id="L545">					ps.setString(counter++, subject);</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">					ps.setString(counter++, (baseHref == null) ? &quot;&quot; : baseHref);</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">					if (Tools.isEmpty(attachments))</span>
					{
<span class="nc" id="L549">						ps.setString(counter++, null);</span>
					}
					else
					{
<span class="nc" id="L553">						ps.setString(counter++, attachments);</span>
					}
<span class="nc" id="L555">					ps.setInt(counter++, 0);</span>
<span class="nc" id="L556">					ps.setNull(counter++, Types.TIMESTAMP);</span>
<span class="nc" id="L557">					ps.setInt(counter++, -1);</span>
<span class="nc" id="L558">					ps.setTimestamp(counter++, new Timestamp(Tools.getNow()));</span>
<span class="nc bnc" id="L559" title="All 4 branches missed.">					if (Tools.isNotEmpty(date) &amp;&amp; Tools.isNotEmpty(time))</span>
					{
<span class="nc" id="L561">						ps.setTimestamp(counter++, new Timestamp(DB.getTimestamp(date, time)));</span>
					}
					else
					{
<span class="nc" id="L565">						ps.setNull(counter++, Types.TIMESTAMP);</span>
					}
<span class="nc" id="L567">					DB.setClob(ps, counter++, message);</span>
<span class="nc" id="L568">					ps.setString(counter++, replyTo);</span>
<span class="nc" id="L569">					ps.setString(counter++, ccEmail);</span>
<span class="nc" id="L570">					ps.setString(counter++, bccEmail);</span>
<span class="nc" id="L571">					ps.execute();</span>
				}
<span class="nc" id="L573">				finally { ps.close(); }</span>
			}
<span class="nc" id="L575">			finally { db_conn.close(); }</span>
		}
<span class="nc" id="L577">		catch (Exception ex)</span>
		{
<span class="nc" id="L579">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L580">			Adminlog.add(Adminlog.TYPE_SENDMAIL, &quot;ERROR sending email later ex:&quot;+ex.getMessage(), -1, -1);</span>
<span class="nc" id="L581">		}</span>

<span class="nc" id="L583">		return(true);</span>
	}

	/**
	 * Ziska zoznam inline priloh (obrazkov)
	 * @param htmlCode
	 * @return
	 */
	public static List&lt;String&gt; getInlineAttachments(String htmlCode)
	{
		//Logger.println(this,&quot;Getting INLINE attachments from mail&quot;);
<span class="fc" id="L594">		EditorKit kit = new HTMLEditorKit();</span>
<span class="fc" id="L595">		Document doc = kit.createDefaultDocument();</span>
		// The Document class does not yet
		// handle charset's properly.
<span class="fc" id="L598">		doc.putProperty(&quot;IgnoreCharsetDirective&quot;, Boolean.TRUE);</span>

<span class="fc" id="L600">		List&lt;String&gt; att = new ArrayList&lt;&gt;();</span>
		try
		{
			// Create a reader on the HTML content.
<span class="fc" id="L604">			Reader rd = new StringReader(htmlCode);</span>
			// Parse the HTML.
<span class="fc" id="L606">			kit.read(rd, doc, 0);</span>
			// Iterate through the elements
			// of the HTML document.
<span class="fc" id="L609">			ElementIterator it = new ElementIterator(doc);</span>
			javax.swing.text.Element elem;
<span class="fc bfc" id="L611" title="All 2 branches covered.">			while ((elem = it.next()) != null)</span>
			{
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">				if (elem.getName().equals(&quot;img&quot;))</span>
				{
<span class="nc" id="L615">					String src = (String) elem.getAttributes().getAttribute(HTML.Attribute.SRC);</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">					if (Tools.isEmpty(src))</span>
					{
<span class="nc" id="L618">						continue;</span>
					}
					//Logger.println(this,src);
<span class="nc" id="L621">					att.add(src);</span>
				}
				//jeeff: test na atribut background
<span class="pc bpc" id="L624" title="1 of 2 branches missed.">				if (elem.getAttributes().getAttribute(HTML.Attribute.BACKGROUND) != null)</span>
				{
<span class="nc" id="L626">					String src = (String) elem.getAttributes().getAttribute(HTML.Attribute.BACKGROUND);</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">					if (Tools.isEmpty(src))</span>
					{
<span class="nc" id="L629">						continue;</span>
					}
					//Logger.println(this,src);
<span class="nc" id="L632">					att.add(src);</span>
<span class="nc" id="L633">				}</span>
			}
		}
<span class="nc" id="L636">		catch (Exception e)</span>
		{
<span class="nc" id="L638">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L639">		}</span>
<span class="fc" id="L640">		return(att);</span>
	}

	/**
	 * Prida do emailu Inline obrazky
	 * @param atts
	 * @param related
	 * @param message
	 * @param baseHref
	 * @return
	 * @throws Exception
	 */
	private static String putInlineAttachments(Multipart atts, Multipart related, String message, String baseHref) throws Exception
	{
<span class="fc" id="L654">		String rt = message;</span>
		try
		{
<span class="fc" id="L657">			List&lt;String&gt; att = getInlineAttachments(message);</span>

<span class="fc" id="L659">			Iterator&lt;String&gt; iter = att.iterator();</span>
			String url;
			IwcmFile f;
			FileDataSource fds;
			URL u;
			URLDataSource uds;
			MimeBodyPart at;
<span class="pc bpc" id="L666" title="1 of 2 branches missed.">			while (iter.hasNext())</span>
			{
<span class="nc" id="L668">				url = iter.next();</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">				if (url.startsWith(&quot;http&quot;))</span>
				{
					//url = sk.iway.URLPathEncoder.encode(url);
<span class="nc" id="L672">					url = Tools.replace(url, &quot; &quot;, &quot;%20&quot;);</span>

					//inline attachment
<span class="nc" id="L675">					String downloadUrl = url;</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">					if (url.indexOf(&quot;http&quot;)==-1)</span>
					{
<span class="nc" id="L678">						downloadUrl = baseHref + url;</span>
					}
<span class="nc" id="L680">					downloadUrl = Tools.natUrl(downloadUrl);</span>
<span class="nc" id="L681">					u = new URL(downloadUrl);</span>

<span class="nc" id="L683">					Logger.println(SendMail.class,&quot;ATT url: &quot; + downloadUrl);</span>
<span class="nc" id="L684">					uds = new URLDataSource(u);</span>
<span class="nc" id="L685">					at = new MimeBodyPart();</span>
<span class="nc" id="L686">					at.setDataHandler(new DataHandler(uds));</span>
<span class="nc" id="L687">				}</span>
				else
				{
<span class="nc bnc" id="L690" title="All 2 branches missed.">					if (url.charAt(0)!='/')</span>
					{
<span class="nc" id="L692">						url = &quot;/&quot; + url; //NOSONAR</span>
					}

					//ak mame multidomain fixni cesty
<span class="nc" id="L696">					String localUrl = url;</span>
					//tento try neodstranujte, moze nastat indexOufOfBounds v casti baseHref.indexOf
					try
					{
<span class="nc bnc" id="L700" title="All 2 branches missed.">						if (Tools.isNotEmpty(baseHref))</span>
						{
<span class="nc" id="L702">							String domain = baseHref.substring(baseHref.indexOf(&quot;://&quot;));</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">							if (domain.indexOf(':')!=-1) domain = domain.substring(0, domain.indexOf(':'));</span>
<span class="nc" id="L704">							localUrl = MultiDomainFilter.rewriteUrlToLocal(url, MultiDomainFilter.getDomainAlias(domain));</span>
<span class="nc" id="L705">							Logger.debug(SendMail.class, &quot;Trying to fix multidomain: url=&quot;+url+&quot; local=&quot;+localUrl+&quot; domain=&quot;+domain+&quot; basehref=&quot;+baseHref);</span>
						}
					}
<span class="nc" id="L708">					catch (Exception ex)</span>
					{
<span class="nc" id="L710">						sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L711">					}</span>

<span class="nc" id="L713">					f = new IwcmFile((Tools.getRealPath(localUrl)));</span>

<span class="nc bnc" id="L715" title="All 4 branches missed.">					if (IwcmFsDB.useDBStorage(localUrl) &amp;&amp; f.exists())</span>
					{
<span class="nc" id="L717">						File tempFile = new File(IwcmFsDB.getTempFilePath(f.getPath()));</span>
<span class="nc bnc" id="L718" title="All 4 branches missed.">						if (tempFile.exists()==false || tempFile.lastModified() &gt; f.lastModified())</span>
						{
<span class="nc" id="L720">							IwcmFsDB.writeFileToDisk(new File(f.getPath()), tempFile);</span>
						}
					}

<span class="nc bnc" id="L724" title="All 6 branches missed.">					if (f.exists() &amp;&amp; f.canRead() &amp;&amp; f.isFile())</span>
					{
<span class="nc" id="L726">						Logger.println(SendMail.class,&quot;ATT file: &quot; + url + &quot; path=&quot;+f.getAbsolutePath());</span>
<span class="nc bnc" id="L727" title="All 2 branches missed.">						if (IwcmFsDB.useDBStorage(url))</span>
						{
<span class="nc" id="L729">						fds = new FileDataSource(new File(IwcmFsDB.getTempFilePath(f.getPath())));</span>
						}
						else
						{
<span class="nc" id="L733">							fds = new FileDataSource(new File(f.getAbsolutePath()));</span>
						}

<span class="nc" id="L736">						at = new MimeBodyPart();</span>
<span class="nc" id="L737">						at.setDataHandler(new DataHandler(fds));</span>
					}
					else
					{
						//je to nejaky virtualny obrazok, je mozne ho asi len stiahnut
<span class="nc" id="L742">						url = Tools.replace(url, &quot; &quot;, &quot;%20&quot;);</span>

						//inline attachment
<span class="nc" id="L745">						String downloadUrl = url;</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">						if (url.indexOf(&quot;http&quot;)==-1)</span>
						{
<span class="nc" id="L748">							downloadUrl = baseHref + url;</span>
						}

<span class="nc" id="L751">						Logger.debug(SendMail.class,&quot;ATT url: &quot; + downloadUrl);</span>

<span class="nc" id="L753">						downloadUrl = Tools.natUrl(downloadUrl);</span>
<span class="nc" id="L754">						u = new URL(downloadUrl);</span>

<span class="nc" id="L756">						uds = new URLDataSource(u);</span>
<span class="nc" id="L757">						at = new MimeBodyPart();</span>
<span class="nc" id="L758">						at.setDataHandler(new DataHandler(uds));</span>
					}
				}

				//ponechame povodne URL obrazku
<span class="nc" id="L763">				boolean dmailDisableInlineImages = Constants.getBoolean(&quot;dmailDisableInlineImages&quot;);</span>
<span class="nc" id="L764">				String trackGif = Constants.getString(&quot;dmailTrackopenGif&quot;);</span>

<span class="nc" id="L766">				boolean whitelisted = false;</span>
<span class="nc" id="L767">				String dmailWhitelistImageDomains = Constants.getString(&quot;dmailWhitelistImageDomains&quot;);</span>
<span class="nc bnc" id="L768" title="All 4 branches missed.">				if (Tools.isNotEmpty(dmailWhitelistImageDomains) &amp;&amp; url.startsWith(&quot;http&quot;))</span>
				{
					try
					{
<span class="nc" id="L772">						String domain = url.substring(url.indexOf(&quot;:&quot;)+3, url.indexOf(&quot;/&quot;, 8));</span>
<span class="nc" id="L773">						Logger.debug(SendMail.class, &quot;Testing whitelist domain:&quot;+domain);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">						if (dmailWhitelistImageDomains.indexOf(domain)!=-1) whitelisted = true;</span>
					}
<span class="nc" id="L776">					catch (Exception e)</span>
					{
<span class="nc" id="L778">						sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L779">					}</span>
				}

<span class="nc bnc" id="L782" title="All 8 branches missed.">				if(dmailDisableInlineImages || (Tools.isNotEmpty(trackGif) &amp;&amp; url.indexOf(trackGif)!=-1) || whitelisted)</span>
				{
<span class="nc bnc" id="L784" title="All 2 branches missed.">					if (url.indexOf(&quot;http&quot;)==-1)</span>
					{
<span class="nc" id="L786">						url = Tools.replace(url, &quot;%20&quot;, &quot; &quot;);</span>
<span class="nc" id="L787">						String newUrl = baseHref + url;</span>
<span class="nc" id="L788">						rt = Tools.replace(rt, url, newUrl);</span>
<span class="nc" id="L789">					}</span>
				}
				else
				{
<span class="nc" id="L793">					String hash = putAsInline(rt, url);</span>
<span class="nc" id="L794">					Logger.println(SendMail.class,&quot;hash: &quot; + hash);</span>
<span class="nc bnc" id="L795" title="All 4 branches missed.">					if (hash != null &amp;&amp; at != null)</span>
					{
<span class="nc" id="L797">						rt = Tools.replace(rt, url, &quot;cid:WebJET.&quot; + hash);</span>

<span class="nc" id="L799">						String onlyFile = onlyFile(url);</span>
<span class="nc bnc" id="L800" title="All 4 branches missed.">						if (onlyFile!=null &amp;&amp; onlyFile.toLowerCase().endsWith(&quot;.png&quot;))</span>
						{
							//toto linux server niekedy nepozna
<span class="nc" id="L803">							at.setHeader(&quot;Content-Type&quot;, &quot;image/png; name=&quot;+onlyFile);</span>
						}

<span class="nc" id="L806">						at.setHeader(&quot;Content-ID&quot;, &quot;&lt;WebJET.&quot; + hash + &quot;&gt;&quot;);</span>
<span class="nc" id="L807">						at.setHeader(&quot;Content-Disposition&quot;, &quot;inline;\n filename=\&quot;&quot;+onlyFile+&quot;\&quot;&quot;);</span>
<span class="nc" id="L808">						related.addBodyPart(at);</span>
<span class="nc" id="L809">						Logger.println(SendMail.class,&quot;pridane&quot;);</span>
					}
				}
<span class="nc" id="L812">			}</span>
		}
<span class="nc" id="L814">		catch (Exception ex)</span>
		{
<span class="nc" id="L816">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
<span class="nc" id="L819">		{</span>

<span class="pc" id="L821">		}</span>
<span class="fc" id="L822">		return rt;</span>
	}

	/**
	 * Prida do emailu message part
	 * @param mp
	 * @param message
	 * @param related
	 * @throws MessagingException
	 */
	private static void putMessagePart(Multipart mp, String message, Multipart related) throws MessagingException
	{
<span class="fc" id="L834">		MimeMultipart content = new MimeMultipart(&quot;alternative&quot;);</span>
<span class="pc bpc" id="L835" title="1 of 2 branches missed.">		String txtVersion = isHtmlContent(message) ? sk.iway.Html2Text.html2text(message) : message;</span>

<span class="fc" id="L837">		String emailEncoding = Constants.getString(&quot;emailEncoding&quot;);</span>
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">		if (Tools.isEmpty(emailEncoding))</span>
		{
<span class="fc" id="L840">			emailEncoding = SetCharacterEncodingFilter.getEncoding();</span>
		}

<span class="pc bpc" id="L843" title="2 of 4 branches missed.">		if (txtVersion != null &amp;&amp; txtVersion.length() &gt; 3)</span>
		{
<span class="fc" id="L845">			MimeBodyPart text = new MimeBodyPart();</span>

<span class="fc" id="L847">			txtVersion = Tools.replace(txtVersion, &quot;&amp;lt;&quot;, &quot;&lt;&quot;);</span>
<span class="fc" id="L848">			txtVersion = Tools.replace(txtVersion, &quot;&amp;gt;&quot;, &quot;&gt;&quot;);</span>

			//outlook maze nove riadky, fixuje sa to pridanim 2 medzier na kazdy novy riadok
			//http://www.masternewmedia.org/newsletter_publishing/newsletter_formatting/remove_line_breaks_issue_Microsoft_Outlook_2003_when_publishing_text_newsletters_20051217.htm
<span class="fc" id="L852">			txtVersion = Tools.replace(txtVersion, &quot;\r&quot;, &quot;&quot;);</span>
<span class="fc" id="L853">			txtVersion = Tools.replace(txtVersion, &quot;\n&quot;, &quot;\n  &quot;);</span>
<span class="pc bpc" id="L854" title="1 of 2 branches missed.">			if (txtVersion.startsWith(&quot;  &quot;)==false) txtVersion = &quot;  &quot;+txtVersion;</span>

<span class="fc" id="L856">			text.setText(txtVersion, emailEncoding);</span>
<span class="fc" id="L857">			text.setHeader(&quot;MIME-Version&quot;, &quot;1.0&quot;);</span>
<span class="fc" id="L858">			text.setHeader(&quot;Content-Type&quot;, &quot;text/plain; charset=&quot;+emailEncoding);</span>
			//text.setContent(message, &quot;text/plain; charset=windows-1250&quot;);
			//mp.addBodyPart(text);
<span class="fc" id="L861">			content.addBodyPart(text);</span>
		}
<span class="pc bpc" id="L863" title="1 of 2 branches missed.">		if (message != null) {</span>
<span class="fc" id="L864">			String det = message.toLowerCase();</span>
<span class="pc bpc" id="L865" title="1 of 2 branches missed.">			if (isHtmlContent(det))</span>
			{
<span class="fc bfc" id="L867" title="All 2 branches covered.">				if (det.indexOf(&quot;&lt;html&quot;)==-1)</span>
				{
<span class="fc" id="L869">					message = &quot;&lt;html&gt;&lt;body&gt;&quot; + message + &quot;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
				}

<span class="pc bpc" id="L872" title="3 of 4 branches missed.">				if (related != null &amp;&amp; related.getCount() &gt; 0)</span>
				{
<span class="nc" id="L874">					Multipart rela = new MimeMultipart(&quot;related&quot;);</span>
<span class="nc" id="L875">					MimeBodyPart html = new MimeBodyPart();</span>
<span class="nc" id="L876">					html.setContent(message, &quot;text/html; charset=&quot;+emailEncoding);</span>
<span class="nc" id="L877">					html.setHeader(&quot;MIME-Version&quot;, &quot;1.0&quot;);</span>
<span class="nc" id="L878">					html.setHeader(&quot;Content-Type&quot;, &quot;text/html; charset=&quot;+emailEncoding);</span>
<span class="nc" id="L879">					rela.addBodyPart(html);</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">					for (int i = 0; i &lt; related.getCount(); i++)</span>
					{
<span class="nc" id="L882">						rela.addBodyPart(related.getBodyPart(i));</span>
					}
<span class="nc" id="L884">					MimeBodyPart wrap = new MimeBodyPart();</span>
<span class="nc" id="L885">					wrap.setContent(rela);</span>
<span class="nc" id="L886">					content.addBodyPart(wrap);</span>
<span class="nc" id="L887">				}</span>
				else
				{
<span class="fc" id="L890">					MimeBodyPart html = new MimeBodyPart();</span>
<span class="fc" id="L891">					html.setContent(message, &quot;text/html; charset=&quot;+emailEncoding);</span>
<span class="fc" id="L892">					html.setHeader(&quot;MIME-Version&quot;, &quot;1.0&quot;);</span>
<span class="fc" id="L893">					html.setHeader(&quot;Content-Type&quot;, &quot;text/html; charset=&quot;+emailEncoding);</span>
					//mp.addBodyPart(html);
<span class="fc" id="L895">					content.addBodyPart(html);</span>
				}
			}
		}
		//mp.setContent(content);
		//mp.addBodyPart(content);
<span class="fc" id="L901">		MimeBodyPart wrap = new MimeBodyPart();</span>
<span class="fc" id="L902">		wrap.setContent(content);</span>
		// HERE'S THE KEY
<span class="fc" id="L904">		mp.addBodyPart(wrap);</span>
<span class="fc" id="L905">	}</span>

	/**
	 * Otestuje, ci zadany test je HTML kod
	 * @param html
	 * @return
	 */
	public static boolean isHtmlContent(String html)
	{
<span class="pc bpc" id="L914" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(html)) {</span>
<span class="fc" id="L915">			String htmlLC = html.toLowerCase();</span>
<span class="fc bfc" id="L916" title="All 2 branches covered.">			if (htmlLC.indexOf(&quot;&lt;br&quot;)!=-1) return true;</span>
<span class="pc bpc" id="L917" title="1 of 2 branches missed.">			if (htmlLC.indexOf(&quot;&lt;div&gt;&quot;)!=-1) return true;</span>
<span class="fc bfc" id="L918" title="All 2 branches covered.">			if (htmlLC.indexOf(&quot;&lt;/p&gt;&quot;)!=-1) return true;</span>
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">			if (htmlLC.indexOf(&quot;&lt;/h&quot;)!=-1) return true;</span>
<span class="fc bfc" id="L920" title="All 2 branches covered.">			if (htmlLC.indexOf(&quot;&lt;/a&gt;&quot;)!=-1) return true;</span>
<span class="pc bpc" id="L921" title="1 of 2 branches missed.">			if (htmlLC.indexOf(&quot;&lt;img &quot;)!=-1) return true;</span>
<span class="pc bpc" id="L922" title="1 of 2 branches missed.">			if (htmlLC.indexOf(&quot;&lt;/b&gt;&quot;)!=-1) return true;</span>
<span class="pc bpc" id="L923" title="1 of 2 branches missed.">			if (htmlLC.indexOf(&quot;&lt;/strong&gt;&quot;)!=-1) return true;</span>
<span class="pc bpc" id="L924" title="1 of 2 branches missed.">			if (htmlLC.indexOf(&quot;&lt;/ul&gt;&quot;)!=-1) return true;</span>
<span class="pc bpc" id="L925" title="1 of 2 branches missed.">			if (htmlLC.indexOf(&quot;&lt;/ol&gt;&quot;)!=-1) return true;</span>
<span class="pc bpc" id="L926" title="1 of 2 branches missed.">			if (htmlLC.indexOf(&quot;&lt;/td&gt;&quot;)!=-1) return true;</span>
		}

<span class="fc" id="L929">		return false;</span>
	}

	/**
	 * Vypocita HASH hodnotu pre inline prilohu
	 * @param message
	 * @param iurl
	 * @return
	 */
	private static String putAsInline(String message, String iurl)
	{
<span class="nc" id="L940">		String rt = null;</span>
<span class="nc bnc" id="L941" title="All 2 branches missed.">		if (message.indexOf(iurl) != -1)</span>
		{
<span class="nc" id="L943">			rt = String.valueOf(iurl.hashCode());</span>
			// nemozeme pouzit replace all pretoze &quot;regular expression&quot; je aktivne
			// aj
			// na X? a to moze byt sucast URL
			// message = replaceAll(message,iurl,&quot;cid:&quot;+rt);
		}
<span class="nc" id="L949">		return rt;</span>
	}


	/**
	 * Vrati nazov suboru z cesty
	 * @param f
	 * @return
	 */
	private static String onlyFile(String f)
	{
		try
		{
			//odstran image?v=aaaa z URL
<span class="nc" id="L963">			int questionMark = f.indexOf(&quot;?&quot;);</span>
<span class="nc bnc" id="L964" title="All 2 branches missed.">			if (questionMark &gt; 0)</span>
			{
<span class="nc" id="L966">				f = f.substring(0, questionMark);</span>
			}

<span class="nc" id="L969">			f = java.net.URLDecoder.decode(f, SetCharacterEncodingFilter.getEncoding());</span>
		}
<span class="nc" id="L971">		catch (Exception ex)</span>
		{
<span class="nc" id="L973">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L974">		}</span>
<span class="nc" id="L975">		f = f.replace('\\', '/');</span>
<span class="nc" id="L976">		int pos = f.lastIndexOf('/');</span>
<span class="nc bnc" id="L977" title="All 2 branches missed.">		if (pos == -1)</span>
		{
<span class="nc" id="L979">			return(DocTools.removeChars(f));</span>
		}
<span class="nc" id="L981">		return(DocTools.removeChars(f.substring(pos + 1)));</span>
	}


	/**
	 *  Description of the Method
	 *
	 *@param  serverPath            Description of the Parameter
	 *@param  fileName              Description of the Parameter
	 *@param  mp  Description of the Parameter
	 */
	public static void attFile(String serverPath, String fileName, Multipart mp)
	{
<span class="nc bnc" id="L994" title="All 2 branches missed.">		if (serverPath.contains(&quot;dms&quot;)){</span>
            //toto nemoze byt povolene, pretoze to nepojde na WJ kde nie su DMS triedy, treba prerobit na reflectin DmsNotify.attDmsFile(fileName,mp);
		}
		else
		{
<span class="nc" id="L999">			Logger.println(SendMail.class,&quot;attaching: &quot;+serverPath+&quot; fileName=&quot;+fileName);</span>
			try
			{
<span class="nc" id="L1002">				IwcmFile file = IwcmFile.fromVirtualPath(serverPath);</span>
				//try absolute path otherwise
<span class="nc bnc" id="L1004" title="All 2 branches missed.">				if (!file.exists()) file = new IwcmFile(serverPath);</span>

<span class="nc bnc" id="L1006" title="All 2 branches missed.">				if (file.exists())</span>
				{
<span class="nc" id="L1008">					MimeBodyPart mbp2 = new MimeBodyPart();</span>

<span class="nc" id="L1010">					FileDataSource fds = null;</span>

<span class="nc bnc" id="L1012" title="All 2 branches missed.">					if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(file.getAbsolutePath())))</span>
					{
<span class="nc" id="L1014">						IwcmFsDB.writeFileToDisk(new File(file.getAbsolutePath()),new File(IwcmFsDB.getTempFilePath(file.getAbsolutePath())));</span>
<span class="nc" id="L1015">						fds=new FileDataSource(IwcmFsDB.getTempFilePath(file.getAbsolutePath()));</span>
					}
					else
					{
<span class="nc" id="L1019">						fds=new FileDataSource(file.getAbsolutePath());</span>
					}

<span class="nc" id="L1022">					String mimeType = Constants.getServletContext().getMimeType(file.getName().toLowerCase());</span>
<span class="nc bnc" id="L1023" title="All 2 branches missed.">					if (Tools.isEmpty(mimeType)) mimeType = &quot;application/octet-stream&quot;;</span>

<span class="nc" id="L1025">					mbp2.setDataHandler(new DataHandler(fds));</span>
<span class="nc" id="L1026">					mbp2.setHeader(&quot;Content-Type&quot;, mimeType);</span>
<span class="nc" id="L1027">					String emailEncoding = Constants.getString(&quot;emailEncoding&quot;);</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">					if (Tools.isEmpty(emailEncoding))</span>
<span class="nc" id="L1029">						emailEncoding = SetCharacterEncodingFilter.getEncoding();</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">					mbp2.setFileName(MimeUtility.encodeText(Tools.isNotEmpty(fileName) ? fileName : file.getName(), emailEncoding, null));</span>

<span class="nc" id="L1032">					mp.addBodyPart(mbp2);</span>

<span class="nc" id="L1034">					Logger.println(SendMail.class,&quot;done&quot;);</span>
				}
			}
<span class="nc" id="L1037">			catch (Exception ex)</span>
			{
<span class="nc" id="L1039">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1040">			}</span>
		}

<span class="nc" id="L1043">	}</span>

	/**
	 * Vrati kodovanie pre email podla nastavenia servera, alebo ak nie je prazdne podla konfiguracnej premennej emailEncoding
	 * @return
	 */
	public String getEncoding()
	{
<span class="nc" id="L1051">		String emailEncoding = Constants.getString(&quot;emailEncoding&quot;);</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">		if (Tools.isEmpty(emailEncoding))</span>
		{
<span class="nc" id="L1054">			emailEncoding = SetCharacterEncodingFilter.getEncoding();</span>
		}
<span class="nc" id="L1056">		return emailEncoding;</span>
	}

	/**
	 * Vytvori absolutne cesty v zadanom HTML kode
	 * @param htmlCode - HTML kod
	 * @param basePath - absolutna adresa, bez koncoveho /, napr. http://www.iway.sk
	 * @return
	 */
	public static String createAbsolutePath(String htmlCode, String basePath)
	{
<span class="pc bpc" id="L1067" title="1 of 2 branches missed.">		if (basePath == null)</span>
		{
<span class="nc" id="L1069">			return(htmlCode);</span>
		}

		//Logger.println(this,&quot;replace: &quot; + htmlCode);

		//ak je tam uz base path, tak ju zrus, inak tam bude 2x
		//htmlCode = Tools.replace(htmlCode, basePath, &quot;&quot;);
		//htmlCode = Tools.replace(htmlCode, &quot;url(images/&quot;, &quot;url(&quot;+basePath+&quot;/images/&quot;);
		//htmlCode = Tools.replace(htmlCode, &quot;url(/images/&quot;, &quot;url(&quot;+basePath+&quot;/images/&quot;);
		//htmlCode = Tools.replace(htmlCode, &quot;\&quot;/images/&quot;, &quot;\&quot;&quot;+basePath+&quot;/images/&quot;);
		//htmlCode = Tools.replace(htmlCode, &quot;\&quot;/files/&quot;, &quot;\&quot;&quot;+basePath+&quot;/files/&quot;);
		//htmlCode = Tools.replace(htmlCode, &quot;\&quot;/css/&quot;, &quot;\&quot;&quot;+basePath+&quot;/css/&quot;);
		//htmlCode = Tools.replace(htmlCode, &quot;/showdoc.do&quot;, &quot;\&quot;&quot;+basePath+&quot;/showdoc.do&quot;);
<span class="fc" id="L1082">		htmlCode = Tools.replace(htmlCode, &quot;href=\&quot;/&quot;, &quot;href=\&quot;&quot; + basePath + &quot;/&quot;);</span>
<span class="fc" id="L1083">		htmlCode = Tools.replace(htmlCode, &quot;href='/&quot;, &quot;href='&quot; + basePath + &quot;/&quot;);</span>
<span class="fc" id="L1084">		htmlCode = Tools.replace(htmlCode, &quot;action=\&quot;/&quot;, &quot;action=\&quot;&quot; + basePath + &quot;/&quot;);</span>
<span class="fc" id="L1085">		htmlCode = Tools.replace(htmlCode, &quot;action='/&quot;, &quot;action='&quot; + basePath + &quot;/&quot;);</span>

		//replace URL v texte
<span class="fc" id="L1088">		htmlCode = Tools.replace(htmlCode, &quot;target=\&quot;_blank\&quot;&gt;/&quot;, &quot;target=\&quot;_blank\&quot;&gt;&quot;+basePath+&quot;/&quot;);</span>

		//Logger.println(this,&quot;-------replaced: &quot; + htmlCode);

<span class="fc" id="L1092">		return(htmlCode);</span>
	}

	public static String createAbsolutePath(String htmlCode, HttpServletRequest request)
	{
<span class="fc" id="L1097">		String basePath = Tools.getBaseHref(request);</span>
<span class="fc" id="L1098">		return(createAbsolutePath(htmlCode, basePath));</span>
	}

	/**
	 * @param props
	 * @return
	 */
	public static Session getSession(Properties props)
	{
<span class="pc bpc" id="L1107" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;useAmazonSES&quot;)==false) {</span>
<span class="fc" id="L1108">			String port = &quot;25&quot;;</span>
<span class="pc bpc" id="L1109" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(Constants.getString(&quot;smtpPort&quot;)))</span>
			{
<span class="nc" id="L1111">				props.setProperty(&quot;mail.smtp.port&quot;, Constants.getString(&quot;smtpPort&quot;));</span>
<span class="nc" id="L1112">				port=Constants.getString(&quot;smtpPort&quot;);</span>
			}
			else
			{
<span class="fc" id="L1116">				props.setProperty(&quot;mail.smtp.port&quot;, port);</span>
			}

<span class="fc" id="L1119">			int smtpConnectionTimeoutMillis = Constants.getInt(&quot;smtpConnectionTimeoutMillis&quot;);</span>
<span class="pc bpc" id="L1120" title="1 of 2 branches missed.">			if(smtpConnectionTimeoutMillis &gt; 0)</span>
			{
<span class="fc" id="L1122">				props.put(&quot;mail.smtp.connectiontimeout&quot;, smtpConnectionTimeoutMillis);</span>
			}

<span class="pc bpc" id="L1125" title="1 of 2 branches missed.">			if (Constants.getBoolean(&quot;smtpUseSSL&quot;))</span>
			{
<span class="nc" id="L1127">				props.put(&quot;mail.smtp.socketFactory.port&quot;, port);</span>
<span class="nc" id="L1128">				props.put(&quot;mail.smtp.socketFactory.class&quot;, &quot;javax.net.ssl.SSLSocketFactory&quot;);</span>
<span class="nc" id="L1129">				props.put(&quot;mail.smtp.ssl.checkserveridentity&quot;, true);</span>
<span class="nc" id="L1130">				props.put(&quot;mail.smtp.socketFactory.fallback&quot;, &quot;false&quot;);</span>
			}
			// office365 (ak je port 587, smtpUseTLS musi byt true)
<span class="pc bpc" id="L1133" title="1 of 2 branches missed.">			else if(Constants.getBoolean(&quot;smtpUseTLS&quot;))</span>
			{
<span class="nc" id="L1135">				props.put(&quot;mail.smtp.starttls.enable&quot;, &quot;true&quot;);</span>
<span class="nc" id="L1136">				String smtpTLSVersion = Constants.getString(&quot;smtpTLSVersion&quot;);</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">				if (Tools.isNotEmpty(smtpTLSVersion)) props.put(&quot;mail.smtp.ssl.protocols&quot;, smtpTLSVersion);</span>
			}
		}

		Session ms;
<span class="pc bpc" id="L1142" title="3 of 4 branches missed.">		if (Tools.isNotEmpty(Constants.getString(&quot;smtpUser&quot;)) &amp;&amp;  Tools.isNotEmpty(Constants.getString(&quot;smtpPassword&quot;)))</span>
		{
			final class WJAuthenticator extends javax.mail.Authenticator
			{
				private final PasswordAuthentication authentication;

				public WJAuthenticator()
<span class="nc" id="L1149">				{</span>

<span class="nc" id="L1151">					String username = Constants.getString(&quot;smtpUser&quot;);</span>
<span class="nc" id="L1152">					String password = Constants.getString(&quot;smtpPassword&quot;);</span>
<span class="nc" id="L1153">					authentication = new PasswordAuthentication(username, password);</span>
<span class="nc" id="L1154">				}</span>

				@Override
				protected PasswordAuthentication getPasswordAuthentication()
				{
<span class="nc" id="L1159">					return authentication;</span>
				}
			}
<span class="nc" id="L1162">			props.setProperty(&quot;mail.smtp.auth&quot;, &quot;true&quot;);</span>

			//ziskanie getDefaultInstance nam na Exchange vracalo chybu INFO: java.lang.SecurityException: Access to default session denied
<span class="nc" id="L1165">			ms = Session.getInstance(props, new WJAuthenticator());</span>
		}
<span class="pc bpc" id="L1167" title="1 of 2 branches missed.">		else if (Constants.getBoolean(&quot;useAmazonSES&quot;)</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">					&amp;&amp;  Tools.isNotEmpty(Constants.getString(&quot;amazonAccessKey&quot;))</span>
<span class="nc bnc" id="L1169" title="All 2 branches missed.">					&amp;&amp;  Tools.isNotEmpty(Constants.getString(&quot;amazonSecretKey&quot;))) {</span>
<span class="nc" id="L1170">					props.put(&quot;mail.aws.user&quot;, Constants.getString(&quot;amazonAccessKey&quot;));</span>
<span class="nc" id="L1171">					props.put(&quot;mail.aws.password&quot;, Constants.getString(&quot;amazonSecretKey&quot;));</span>

<span class="nc bnc" id="L1173" title="All 2 branches missed.">					if(Tools.isNotEmpty(Constants.getString(&quot;amazonEmailServiceHost&quot;))) props.put(&quot;mail.aws.host&quot;, Constants.getString(&quot;amazonEmailServiceHost&quot;));</span>

<span class="nc" id="L1175">					ms = Session.getDefaultInstance(props,null);</span>
		} else {
<span class="fc" id="L1177">			ms = Session.getDefaultInstance(props,null);</span>
		}
<span class="fc" id="L1179">		return ms;</span>
	}

	/**
	 * Ziska prvu email adresu zo stringu typu meno@domena.sk,ine@domena.sk (pre polia, ktore mozu mat len jeden email ako from a replyTo)
	 * @param email
	 * @return
	 */
	public static String getFirstEmailAddress(String email) {
<span class="fc" id="L1188">		int i = email.indexOf(',');</span>
<span class="pc bpc" id="L1189" title="1 of 2 branches missed.">		if (i!=-1)</span>
		{
<span class="nc" id="L1191">			email = email.substring(0, i);</span>
		}
<span class="fc" id="L1193">		return email;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>