<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm</a> &gt; <span class="el_source">DB.java</span></div><h1>DB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm;

import java.io.Writer;
import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.StringTokenizer;

import org.apache.commons.beanutils.DynaBean;
import org.apache.commons.beanutils.RowSetDynaClass;
import org.apache.struts.util.ResponseUtils;

import oracle.jdbc.driver.OracleConnection;
import oracle.sql.CLOB;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;

/**
 *  nadtrieda DB tried, ma zakladne uzitocne funkcie
 *
 *@Title        Interway Content Management
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: 1.14 $
 *@created      $Date: 2004/03/23 20:50:49 $
 *@modified     $Date: 2004/03/23 20:50:49 $
 */
@SuppressWarnings({&quot;deprecation&quot;, &quot;java:S1118&quot;})
<span class="fc" id="L43">public class DB</span>
{
	//zoznam stlpcov ktore mozu obsahovat HTML kod
<span class="fc" id="L46">	private static Set&lt;String&gt; htmlAllowedFields = null;</span>

	/**
	 * Overi, ci je mozne v danom DB stlpci pouzit HTML kod, ak nie, tak sa pri citani rovno escapnu specialne znaky
	 * ako &lt; alebo &gt; aby nebolo mozne vykonat XSS utok
	 * https://thoughts-on-java.org/jpa-21-how-to-implement-type-converter/
	 * @param fieldName
	 * @return
	 */
	public static boolean isHtmlAllowed(String fieldName)
	{
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">		if (fieldName==null) return false;</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">		if (fieldName.contains(&quot;html&quot;)) return true;</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">		if (fieldName.contains(&quot;data&quot;)) return true;</span>
		//fotogaleria
<span class="fc bfc" id="L61" title="All 2 branches covered.">		if (fieldName.contains(&quot;_description_&quot;)) return true;</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">		if (fieldName.startsWith(&quot;field_&quot;)) return true;</span>

<span class="fc bfc" id="L64" title="All 2 branches covered.">		if (htmlAllowedFields == null)</span>
		{
			//systemove stlpce
<span class="fc" id="L67">			String[] fields = Tools.getTokens(Constants.getString(&quot;xssHtmlAllowedFieldsSystem&quot;), &quot;,&quot;, true);</span>
<span class="fc" id="L68">			Set&lt;String&gt; fieldsSet = new HashSet&lt;&gt;(Arrays.asList(fields));</span>
			//zakaznicke stlpce
<span class="fc" id="L70">			fields = Tools.getTokens(Constants.getString(&quot;xssHtmlAllowedFields&quot;), &quot;,&quot;, true);</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">			for (String field : fields) {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">				if (fieldsSet.contains(field)) continue;</span>
<span class="nc" id="L73">				fieldsSet.add(field);</span>
			}
<span class="fc" id="L75">			htmlAllowedFields = fieldsSet;</span>
		}

<span class="fc bfc" id="L78" title="All 2 branches covered.">		if (htmlAllowedFields.contains(fieldName)) return true;</span>

<span class="fc" id="L80">		return false;</span>
	}

	public static void resetHtmlAllowedFields()
	{
<span class="fc" id="L85">		htmlAllowedFields = null;</span>
<span class="fc" id="L86">	}</span>


	/**
	 * vrati prekodovany a trimnuty string z result setu (povodne sa pouzivalo kvoli Oracle), ak je filter true vykona aj ResponseUtils.filter
	 * @param db_result
	 * @param fieldName
	 * @param filter
	 * @return
	 * @throws SQLException
	 */
	public static String getDbString(java.sql.ResultSet db_result, String fieldName, boolean filter) throws SQLException
	{
<span class="fc" id="L99">		String ret = getDbStringImpl(db_result, fieldName);</span>

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">		if (filter) return filterHtml(ret);</span>

<span class="fc" id="L103">		return ret;</span>
	}

	/**
	 *  vrati prekodovany a trimnuty string z result setu (povodne sa pouzivalo kvoli Oracle)
	 *
	 *@param  db_result      result set
	 *@param  fieldName      meno fieldu v databaze
	 *@return                prekodovany a trimnuty string
	 *@exception  Exception  Description of the Exception
	 */
	public static String getDbString(java.sql.ResultSet db_result, String fieldName) throws SQLException
	{
<span class="fc" id="L116">		String data = null;</span>

<span class="fc" id="L118">		data = getDbStringImpl(db_result, fieldName);</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">		if (isHtmlAllowed(fieldName)==false)</span>
		{
<span class="pc bpc" id="L122" title="1 of 4 branches missed.">			if (data.contains(&quot;&lt;&quot;) || data.contains(&quot;&gt;&quot;))</span>
			{
<span class="fc" id="L124">				data = filterHtml(data);</span>
			}
		}

		//ak su sifrovane skus desifrovat
<span class="fc" id="L129">		data = CryptoFactory.decrypt(data);</span>
<span class="fc" id="L130">		return (data);</span>
	}

	/**
	 * Nahradi nebezpecne HTML znaky za entity
	 * @param data
	 * @return
	 */
	public static String filterHtml(String data)
	{
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">		if (data == null) return null;</span>

<span class="fc bfc" id="L142" title="All 4 branches covered.">		if (data.contains(&quot;&lt;&quot;) || data.contains(&quot;&gt;&quot;))</span>
		{
<span class="fc" id="L144">			return ResponseUtils.filter(data);</span>
		}
<span class="fc" id="L146">		return data;</span>
	}

	private static String getDbStringImpl(java.sql.ResultSet db_result, String fieldName) throws SQLException
	{
<span class="fc" id="L151">		String data = null;</span>

<span class="fc" id="L153">		data = db_result.getString(fieldName);</span>

<span class="fc bfc" id="L155" title="All 4 branches covered.">		if (data != null &amp;&amp; data.length()&gt;0)</span>
		{
			//ochrana pred vykonanim prikazu v Exceli
<span class="fc bfc" id="L158" title="All 2 branches covered.">			if (data.length()&gt;5)</span>
			{
<span class="fc" id="L160">				String retLC = data.substring(0, 4).toLowerCase();</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">				if (retLC.toLowerCase().startsWith(&quot;=cmd&quot;)) data = &quot;-&quot; + data.substring(1);</span>
			}

<span class="fc" id="L164">			return (data.trim());</span>
		}
		else
		{
<span class="fc" id="L168">			return (&quot;&quot;);</span>
		}
	}

	/**
	 * Vrati long hodnotu Timestampu (ak nie je null), inak vrati 0
	 * @param rs
	 * @param fieldName
	 * @return
	 * @throws Exception
	 */
	public static long getDbTimestamp(java.sql.ResultSet rs, String fieldName)
	{
		try
		{
<span class="fc" id="L183">			java.sql.Timestamp data = rs.getTimestamp(fieldName);</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">			if (data != null)</span>
			{
<span class="fc" id="L186">				return (data.getTime());</span>
			}
		}
<span class="nc" id="L189">		catch (SQLException ex)</span>
		{

<span class="fc" id="L192">		}</span>
<span class="fc" id="L193">		return (0);</span>
	}

	public static Timestamp getDbTimestamp(long time)
	{
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">		if (time == 0)</span>
		{
<span class="nc" id="L200">			return(null);</span>
		}
<span class="fc" id="L202">		return(new Timestamp(time));</span>
	}

	/**
	 *  vrati naformatovany datum z databazy
	 *
	 *@param  db_result      result set
	 *@param  fieldName      meno fieldu v databaze
	 *@return                naformatovany datum z databazy
	 *@exception  Exception  Description of the Exception
	 */
	public static String getDbDate(java.sql.ResultSet db_result, String fieldName) throws SQLException
	{
		try
		{
<span class="fc bfc" id="L217" title="All 2 branches covered.">			if (db_result.getDate(fieldName) != null)</span>
			{
<span class="fc" id="L219">				java.sql.Date dbDate = db_result.getDate(fieldName);</span>
<span class="fc" id="L220">				java.text.SimpleDateFormat formatter = new java.text.SimpleDateFormat(Constants.getString(&quot;dateFormat&quot;));</span>
<span class="fc" id="L221">				return (formatter.format(dbDate));</span>
			}
		}
<span class="nc" id="L224">		catch (Exception ex)</span>
		{
<span class="nc" id="L226">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L227">		}</span>
<span class="fc" id="L228">		return(&quot;&quot;);</span>
	}

	public static Date getDate(java.sql.ResultSet db_result, String fieldName) throws SQLException
	{
		try
		{
<span class="fc bfc" id="L235" title="All 2 branches covered.">			if (db_result.getDate(fieldName) != null)</span>
			{
<span class="fc" id="L237">				return new Date(db_result.getTimestamp(fieldName).getTime());</span>
			}
		}
<span class="nc" id="L240">		catch (Exception ex)</span>
		{
<span class="nc" id="L242">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L243">		}</span>
<span class="fc" id="L244">		return null;</span>
	}

	/**
	 *  vrati naformatovany cas z databazy
	 *
	 *@param  db_result      result set
	 *@param  fieldName      meno fieldu v databaze
	 *@return                naformatovany cas z databazy
	 *@exception  Exception  Description of the Exception
	 */
	public static String getDbTime(java.sql.ResultSet db_result, String fieldName) throws Exception
	{
<span class="nc bnc" id="L257" title="All 2 branches missed.">		if (db_result.getDate(fieldName) != null)</span>
		{
<span class="nc" id="L259">			java.sql.Timestamp dbDate = db_result.getTimestamp(fieldName);</span>
<span class="nc" id="L260">			java.text.SimpleDateFormat formatter = new java.text.SimpleDateFormat(Constants.getString(&quot;timeFormat&quot;));</span>
<span class="nc" id="L261">			return (formatter.format(dbDate));</span>
		}
		else
		{
<span class="nc" id="L265">			return (&quot;&quot;);</span>
		}
	}

	/**
	 *  Gets the dbDateTime attribute of the DB class
	 *
	 *@param  db_result      Description of the Parameter
	 *@param  fieldName      Description of the Parameter
	 *@return                The dbDateTime value
	 *@exception  Exception  Description of the Exception
	 */
	public static String getDbDateTime(java.sql.ResultSet db_result, String fieldName) throws SQLException
	{
<span class="fc" id="L279">		return (getDbDateTime(db_result, fieldName, &quot;iwcm&quot;));</span>
	}

	/**
	 *  Gets the dbDateTime attribute of the DB class
	 *
	 *@param  db_result      Description of the Parameter
	 *@param  fieldName      Description of the Parameter
	 *@param  serverName     Description of the Parameter
	 *@return                The dbDateTime value
	 *@exception  Exception  Description of the Exception
	 */
	public static String getDbDateTime(java.sql.ResultSet db_result, String fieldName, String serverName) throws SQLException
	{
<span class="fc" id="L293">		String ret = &quot;&quot;;</span>

		try
		{
<span class="fc bfc" id="L297" title="All 2 branches covered.">			if (db_result.getTimestamp(fieldName) != null)</span>
			{
<span class="fc" id="L299">				java.sql.Timestamp dbDate = db_result.getTimestamp(fieldName);</span>
<span class="fc" id="L300">				java.text.SimpleDateFormat formatter = new java.text.SimpleDateFormat(Constants.getString(&quot;dateTimeFormat&quot;));</span>
<span class="fc" id="L301">				ret =  formatter.format(dbDate);</span>
			}
		}
<span class="nc" id="L304">		catch (SQLException ex)</span>
		{
<span class="nc" id="L306">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L307">		}</span>
<span class="fc" id="L308">		return (ret);</span>
	}


	public static long getTimestamp(String date, String time, String serverName)
	{
<span class="nc" id="L314">		return(getTimestamp(date, time));</span>
	}

	public static long getTimestamp(String dateTime)
	{
<span class="fc" id="L319">		long timestamp = 0;</span>
		try
		{
<span class="fc bfc" id="L322" title="All 2 branches covered.">			if (Tools.isNotEmpty(dateTime))</span>
			{
				//ak je datum vo formate 1. 5. 2005 14:30
<span class="fc" id="L325">				dateTime = Tools.replace(dateTime, &quot;. &quot;, &quot;.&quot;);</span>

				//ak je to zadane ako 26112009 uprav na lepsi format
<span class="pc bpc" id="L328" title="1 of 4 branches missed.">				if (dateTime.length()==8 &amp;&amp; dateTime.indexOf('.')==-1)</span>
				{
<span class="nc" id="L330">					dateTime = dateTime.substring(0, 2)+&quot;.&quot;+dateTime.substring(2,4)+&quot;.&quot;+dateTime.substring(4);</span>
				}

<span class="fc" id="L333">				StringTokenizer st = new StringTokenizer(dateTime);</span>
<span class="pc bpc" id="L334" title="2 of 4 branches missed.">				if(st.hasMoreTokens() &amp;&amp; st.countTokens() == 4)</span>
				{
<span class="nc" id="L336">					timestamp = DB.getTimestamp(st.nextToken()+&quot;.&quot;+st.nextToken()+&quot;.&quot;+st.nextToken(), st.nextToken());</span>
				}
<span class="pc bpc" id="L338" title="2 of 4 branches missed.">				else if(st.hasMoreTokens() &amp;&amp; st.countTokens() == 3)</span>
				{
<span class="nc" id="L340">					timestamp = DB.getTimestamp(st.nextToken()+&quot;.&quot;+st.nextToken()+&quot;.&quot;+st.nextToken(), &quot;0:00&quot;);</span>
				}
<span class="pc bpc" id="L342" title="1 of 4 branches missed.">				else if(st.hasMoreTokens() &amp;&amp; st.countTokens() == 2)</span>
				{
<span class="fc" id="L344">					timestamp = DB.getTimestamp(st.nextToken(), st.nextToken());</span>
				}
<span class="pc bpc" id="L346" title="2 of 4 branches missed.">				else if (st.hasMoreTokens() &amp;&amp; st.countTokens() == 1)</span>
				{
<span class="fc" id="L348">					timestamp = DB.getTimestamp(st.nextToken(), &quot;0:00&quot;);</span>
				}


				//Calendar cal = Calendar.getInstance();
				//cal.setTimeInMillis(timestamp);
				//Logger.println(this,&quot;Timestamp: &quot; +cal.getTime());
			}
		}
<span class="nc" id="L357">		catch (Exception ex)</span>
		{
<span class="nc" id="L359">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L360">		}</span>
<span class="fc" id="L361">		return timestamp;</span>
	}


	/**
	 *  return sql timestamp from given date and time
	 *
	 *@param  date        datum
	 *@param  time        cas
	 *@return             The timestamp value
	 */
	public static long getTimestamp(String date, String time)
	{
<span class="fc bfc" id="L374" title="All 2 branches covered.">		if (Tools.isEmpty(date))</span>
		{
<span class="fc" id="L376">			return (0);</span>
		}

<span class="fc bfc" id="L379" title="All 2 branches covered.">		if (Tools.isEmpty(time))</span>
		{
<span class="fc" id="L381">			time = &quot;00:00:00&quot;;</span>
		}

<span class="fc" id="L384">		Calendar tmpCalendar = Calendar.getInstance();</span>
<span class="fc" id="L385">		tmpCalendar.clear();</span>
		int day;
		int month;
		int year;
		int hour;
		int minute;
		int second;

		//try to parse date
<span class="fc" id="L394">		date = date.trim();</span>
<span class="fc" id="L395">		date = date.replace('/', '.');</span>
<span class="fc" id="L396">		date = date.replace(' ', '.');</span>
<span class="fc" id="L397">		date = date.replace('-', '.');</span>
<span class="fc" id="L398">		date = date.replace(',', '.');</span>

		//ak je to zadane ako 26112009 uprav na lepsi format
<span class="pc bpc" id="L401" title="1 of 4 branches missed.">		if (date.length()==8 &amp;&amp; date.indexOf('.')==-1)</span>
		{
<span class="nc" id="L403">			date = date.substring(0, 2)+&quot;.&quot;+date.substring(2,4)+&quot;.&quot;+date.substring(4);</span>
		}

<span class="fc" id="L406">		boolean usFormat = false;</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">		if (Constants.getString(&quot;dateFormat&quot;).equalsIgnoreCase(&quot;mm-dd-yyyy&quot;))</span>
		{
<span class="nc" id="L409">			usFormat = true;</span>
		}

<span class="fc" id="L412">		StringTokenizer st = new StringTokenizer(date, &quot;.&quot;);</span>
<span class="pc bpc" id="L413" title="1 of 2 branches missed.">		if (st.hasMoreTokens())</span>
		{
			try
			{
<span class="fc" id="L417">				day = Integer.parseInt(st.nextToken());</span>
<span class="pc bpc" id="L418" title="1 of 2 branches missed.">				if (usFormat)</span>
				{
<span class="nc" id="L420">					tmpCalendar.set(Calendar.MONTH, day - 1);</span>
				}
				else
				{
<span class="fc" id="L424">					tmpCalendar.set(Calendar.DAY_OF_MONTH, day);</span>
				}
			}
<span class="fc" id="L427">			catch (Exception ex)</span>
			{
<span class="fc" id="L429">			}</span>
		}
<span class="fc bfc" id="L431" title="All 2 branches covered.">		if (st.hasMoreTokens())</span>
		{
			try
			{
<span class="fc" id="L435">				month = Integer.parseInt(st.nextToken());</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">				if (usFormat)</span>
				{
<span class="nc" id="L438">					tmpCalendar.set(Calendar.DAY_OF_MONTH, month);</span>
				}
				else
				{
					//if you dont know why, RTFM
<span class="fc" id="L443">					month = month - 1;</span>
<span class="fc" id="L444">					tmpCalendar.set(Calendar.MONTH, month);</span>
				}
			}
<span class="nc" id="L447">			catch (Exception ex)</span>
			{
<span class="fc" id="L449">			}</span>
		}
<span class="fc bfc" id="L451" title="All 2 branches covered.">		if (st.hasMoreTokens())</span>
		{
			try
			{
<span class="fc" id="L455">				year = Integer.parseInt(st.nextToken());</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">				if (year &lt; 20)</span>
				{
<span class="nc" id="L458">					year = 2000 + year;</span>
				}
<span class="fc" id="L460">				tmpCalendar.set(Calendar.YEAR, year);</span>
			}
<span class="nc" id="L462">			catch (Exception ex)</span>
			{
<span class="fc" id="L464">			}</span>
		}

<span class="fc" id="L467">		time = time.trim();</span>
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">		if (time.length() &lt; 3)</span>
		{
<span class="nc" id="L470">			time = &quot;00:00:00&quot;;</span>
		}
<span class="fc" id="L472">		time = time.replace('.', ':');</span>
<span class="fc" id="L473">		time = time.replace(',', ':');</span>
<span class="fc" id="L474">		time = time.replace(' ', ':');</span>
<span class="fc" id="L475">		time = time.replace('-', ':');</span>

<span class="fc" id="L477">		st = new StringTokenizer(time, &quot;:&quot;);</span>
<span class="pc bpc" id="L478" title="1 of 2 branches missed.">		if (st.hasMoreTokens())</span>
		{
			try
			{
<span class="fc" id="L482">				hour = Integer.parseInt(st.nextToken());</span>
<span class="fc" id="L483">				tmpCalendar.set(Calendar.HOUR_OF_DAY, hour);</span>
			}
<span class="nc" id="L485">			catch (Exception ex)</span>
			{
<span class="fc" id="L487">			}</span>
		}
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">		if (st.hasMoreTokens())</span>
		{
			try
			{
<span class="fc" id="L493">				minute = Integer.parseInt(st.nextToken());</span>
<span class="fc" id="L494">				tmpCalendar.set(Calendar.MINUTE, minute);</span>
<span class="fc bfc" id="L495" title="All 2 branches covered.">				if (minute &gt; 30)</span>
				{
<span class="fc" id="L497">					tmpCalendar.set(Calendar.SECOND, 59);</span>
<span class="fc" id="L498">					tmpCalendar.set(Calendar.MILLISECOND, 999);</span>
				}
				else
				{
<span class="fc" id="L502">					tmpCalendar.set(Calendar.SECOND, 0);</span>
<span class="fc" id="L503">					tmpCalendar.set(Calendar.MILLISECOND, 0);</span>
				}
			}
<span class="nc" id="L506">			catch (Exception ex)</span>
			{
<span class="fc" id="L508">			}</span>
		}
<span class="fc bfc" id="L510" title="All 2 branches covered.">		if (st.hasMoreTokens())</span>
		{
			try
			{
<span class="fc" id="L514">				second = Integer.parseInt(st.nextToken());</span>
<span class="fc" id="L515">				tmpCalendar.set(Calendar.SECOND, second);</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">				if (second &gt; 30)</span>
				{
<span class="fc" id="L518">					tmpCalendar.set(Calendar.MILLISECOND, 999);</span>
				}
				else
				{
<span class="fc" id="L522">					tmpCalendar.set(Calendar.MILLISECOND, 0);</span>
				}
			}
<span class="nc" id="L525">			catch (Exception ex)</span>
			{
<span class="pc" id="L527">			}</span>
		}
		else
		{
<span class="fc" id="L531">			tmpCalendar.set(Calendar.SECOND, 0);</span>
		}
<span class="fc" id="L533">		tmpCalendar.set(Calendar.MILLISECOND, 0);</span>
<span class="fc" id="L534">		return (tmpCalendar.getTime().getTime());</span>
	}

	private static final String TAB00C0 =
			&quot;AAAAAAACEEEEIIII&quot; +
					&quot;DNOOOOO\u00d7\u00d8UUUUYI\u00df&quot; +
					&quot;aaaaaaaceeeeiiii&quot; +
					&quot;\u00f0nooooo\u00f7\u00f8uuuuy\u00fey&quot; +
					&quot;AaAaAaCcCcCcCcDd&quot; +
					&quot;DdEeEeEeEeEeGgGg&quot; +
					&quot;GgGgHhHhIiIiIiIi&quot; +
					&quot;IiJjJjKkkLlLlLlL&quot; +
					&quot;lLlNnNnNnnNnOoOo&quot; +
					&quot;OoOoRrRrRrSsSsSs&quot; +
					&quot;SsTtTtTtUuUuUuUu&quot; +
					&quot;UuUuWwYyYZzZzZzF&quot;;
<span class="fc" id="L550">	private static final String[] TAB00C1 = &quot;A,B,V,G,D,E,Zh,Z,I,J,K,L,M,N,O,P,R,S,T,U,F,H,C,Ch,Sh,Shh,\&quot;\&quot;,Y,'',Je,Ju,Ja,a,b,v,g,d,e,zh,z,i,j,k,l,m,n,o,p,r,s,t,u,f,h,c,ch,sh,shh,\&quot;,y,',je,ju,ja,eh,jo&quot;.split(&quot;,&quot;);</span>

	/**
	 *  prekoduje diakritiku a azbuku do cisteho ascii
	 *
	 *@param  source  Description of the Parameter
	 *@return         Description of the Return Value
	 */
	public static String internationalToEnglish(String source)
	{
<span class="pc bpc" id="L560" title="1 of 2 branches missed.">		if (source == null)</span>
		{
			//pozor, toto sa casto pouziva, nesmie to vratit null
<span class="nc" id="L563">			return (&quot;&quot;);</span>
		}

<span class="fc" id="L566">		char[] vysl = new char[source.length()*2];</span>
		char one;
<span class="fc" id="L568">		int k = 0;</span>
<span class="fc bfc" id="L569" title="All 2 branches covered.">		for (int i = 0; i &lt; source.length(); i++)</span>
		{
<span class="fc" id="L571">			one = source.charAt(i);</span>
<span class="fc bfc" id="L572" title="All 6 branches covered.">			if (one &gt;= '\u00c0' &amp; one &lt;= '\u017f') //NOSONAR</span>
			{
<span class="fc" id="L574">				one = TAB00C0.charAt(one - '\u00c0');</span>
			}
<span class="pc bpc" id="L576" title="1 of 6 branches missed.">			if(one &gt;= '\u0410' &amp; one &lt;= '\u0451') //NOSONAR azbuka</span>
			{
<span class="nc" id="L578">				String tmp = TAB00C1[(one - '\u0410')];</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">				for (int j = 0; j &lt; tmp.length(); j++)</span>
				{
<span class="nc" id="L581">					vysl[k++] = tmp.charAt(j);</span>
				}
<span class="nc" id="L583">				continue;</span>
			}
<span class="fc" id="L585">			vysl[k++] = one;</span>
		}
<span class="fc" id="L587">		return new String(vysl).trim();</span>
	}

	/**
	 * Replace stringu na string
	 *
	 * @param src    zdrojovy string
	 * @param oldStr co sa ma nahradit
	 * @param newStr za co sa ma nahradit
	 * @return string src v ktorom je nahradene oldStr za newStr
	 * @deprecated replaced by {@link Tools#replace(String, String, String)}
	 */
	@Deprecated
	public static String replace(String src, String oldStr, String newStr)
	{
<span class="fc" id="L602">		return(Tools.replace(src, oldStr, newStr));</span>
	}

	/**
	 *  nastavi pole text, alebo clob v preparedStatemente
	 *
	 *@param  ps             The new clob value
	 *@param  pos            The new clob value
	 *@param  data           The new clob value
	 *@exception  Exception  Description of the Exception
	 */
	public static void setClob(java.sql.PreparedStatement ps, int pos, String data) throws Exception
	{
<span class="pc bpc" id="L615" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
		{
			//ps.setString(pos, &quot;&amp;nbsp;&quot;);
<span class="nc bnc" id="L618" title="All 2 branches missed.">			if(data!=null)</span>
			{

				try
				{
<span class="nc" id="L623">					Connection db_conn = ps.getConnection();</span>

<span class="nc" id="L625">					Connection nativeConn = null;</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">					if (db_conn instanceof OracleConnection)</span>
					{
<span class="nc" id="L628">						nativeConn = db_conn;</span>
					}
					//toto treba pre JBoss odkomentovat, ja v libkach nemam WrappedConnection
				   /*
				   else if (db_conn instanceof WrappedConnection)
				   {
					nativeConn = ((WrappedConnection)db_conn).getUnderlyingConnection();
				   }
				   */
<span class="nc bnc" id="L637" title="All 2 branches missed.">					if (nativeConn != null)</span>
					{
<span class="nc" id="L639">						CLOB tempClob = CLOB.createTemporary(nativeConn, true, CLOB.DURATION_SESSION);</span>
						// Open the temporary CLOB in readwrite mode to enable writing
<span class="nc" id="L641">						tempClob.open(CLOB.MODE_READWRITE);</span>
						// Get the output stream to write
<span class="nc" id="L643">						Writer tempClobWriter = tempClob.getCharacterOutputStream();</span>
						// Write the data into the temporary CLOB
<span class="nc" id="L645">						tempClobWriter.write(data);</span>
						// Flush and close the stream
<span class="nc" id="L647">						tempClobWriter.flush();</span>
<span class="nc" id="L648">						tempClobWriter.close();</span>
						// Close the temporary CLOB
<span class="nc" id="L650">						tempClob.close();</span>
<span class="nc" id="L651">						ps.setObject(pos, tempClob);</span>
<span class="nc" id="L652">					}</span>
					else
					{
<span class="nc" id="L655">						ps.setString(pos, data);</span>
					}
				}
<span class="nc" id="L658">				catch (Exception e)</span>
				{
<span class="nc" id="L660">					sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L661">				}</span>

				//StringReader reader = new StringReader(data);
				//ps.setCharacterStream(pos, reader, data.length());
			}
			else
			{
<span class="nc" id="L668">				ps.setNull(pos, java.sql.Types.CLOB);</span>
			}

		}
		else
		{
<span class="fc" id="L674">			ps.setString(pos, data);</span>
		}
<span class="fc" id="L676">	}</span>

	/**
	 *  Nastavi hodnotu do Clobu (pre Oracle)
	 *
	 *@param  data           Description of the Parameter
	 *@param  rs             Description of the Parameter
	 *@param  index          Description of the Parameter
	 *@exception  Exception  Description of the Exception
	 */
	/*public static void fillClob(java.sql.ResultSet rs, int index, String data)
			 throws Exception
	{
		Logger.println(this,&quot;fill clob - rs: &quot; + rs);
		CLOB clob = ((oracle.jdbc.OracleResultSet) rs).getCLOB(index);
		Writer outstream = clob.getCharacterOutputStream();
		outstream.write(data);
		outstream.close();
	}*/

	/**
	 *  odstrani apostrofy zo stringu, treba volat vzdy, ked sa nejaky parameter dava priamo do SQL prikazu
	 *
	 *@param  sqlParam
	 *@return
	 */
	public static String removeSlashes(String sqlParam)
	{
<span class="pc bpc" id="L704" title="1 of 2 branches missed.">		if (sqlParam == null) return(sqlParam);</span>

<span class="fc" id="L706">		sqlParam = sqlParam.replace('\'', ' ');</span>
<span class="fc" id="L707">		return (sqlParam);</span>
	}

	/**
	 *  Produces a string representation of a complete result set
	 *
	 *@param  rs             The ResultSet to be displayed
	 *@return                The string representation
	 *@throws  SQLException  to indicate a problem with the ResultSet
	 */
	public static String dumpResultSet(ResultSet rs) throws SQLException
	{
<span class="nc" id="L719">		StringBuilder buf = new StringBuilder();</span>
<span class="nc bnc" id="L720" title="All 2 branches missed.">		if (rs != null)</span>
		{
<span class="nc" id="L722">			ResultSetMetaData rsmd = rs.getMetaData();</span>
<span class="nc" id="L723">			int columnCount = rsmd.getColumnCount() + 1;</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">			for (int i = 1; i &lt; columnCount; i++)</span>
			{
<span class="nc" id="L726">				buf.append(rsmd.getColumnLabel(i));</span>
<span class="nc" id="L727">				buf.append(&quot;  &quot;);</span>
			}
<span class="nc" id="L729">			buf.append(&quot;\n===========================================\n&quot;);</span>

<span class="nc bnc" id="L731" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc bnc" id="L733" title="All 2 branches missed.">				for (int i = 1; i &lt; columnCount; i++)</span>
				{
<span class="nc" id="L735">					buf.append(rs.getObject(i));</span>
<span class="nc" id="L736">					buf.append(&quot;  &quot;);</span>
				}
<span class="nc" id="L738">				buf.append('\n');</span>
			}
		}
<span class="nc" id="L741">		return buf.toString();</span>
	}

	public static String getFullName(ResultSet rs) throws Exception
	{
<span class="fc" id="L746">		return(DB.getFullName(rs, &quot;u_title&quot;));</span>
	}

	/**
	 *  Gets the fullName attribute of the DB object
	 *
	 *@param  rs  Description of the Parameter
	 *@return     The fullName value
	 */
	public static String getFullName(ResultSet rs, String titleName) throws Exception
	{
<span class="fc" id="L757">		StringBuilder ret = new StringBuilder();</span>
<span class="fc" id="L758">		String title = getDbString(rs, titleName);</span>
<span class="fc" id="L759">		String firstName = getDbString(rs, &quot;first_name&quot;);</span>
<span class="fc" id="L760">		String lastName = getDbString(rs, &quot;last_name&quot;);</span>

<span class="pc bpc" id="L762" title="2 of 4 branches missed.">		if (title != null &amp;&amp; title.length()&gt;0)</span>
		{
<span class="nc" id="L764">			ret.append(title).append(' ');</span>
		}
<span class="pc bpc" id="L766" title="2 of 4 branches missed.">		if (firstName != null &amp;&amp; firstName.length()&gt;0)</span>
		{
<span class="fc" id="L768">			ret.append(firstName).append(' ');</span>
		}
<span class="pc bpc" id="L770" title="2 of 4 branches missed.">		if (lastName != null &amp;&amp; lastName.length()&gt;0)</span>
		{
<span class="fc" id="L772">			ret.append(lastName).append(' ');</span>
		}

<span class="fc" id="L775">		return(ret.toString().trim());</span>
	}

	/**
	 * Oreze s tak, aby nebol dlhsi ako maxLen
	 * @param s
	 * @param maxLen
	 * @return
	 */
	public static String prepareString(String s, int maxLen)
	{
<span class="fc bfc" id="L786" title="All 2 branches covered.">		if (s==null)</span>
		{
<span class="fc" id="L788">			return(s);</span>
		}

<span class="fc bfc" id="L791" title="All 2 branches covered.">		if (s.length() &gt; maxLen)</span>
		{
<span class="fc" id="L793">			s = s.substring(0, maxLen-1);</span>
		}

<span class="fc" id="L796">		return(s);</span>
	}

	/**
	 * Vrati List DynaBeanov pre zadane SQL
	 * @param sql - SQL prikaz
	 * @return
	 */
	public static List&lt;DynaBean&gt; getDynaList(String sql)
	{
<span class="nc" id="L806">		return(getDynaList(sql, null, null));</span>
	}

	public static List&lt;DynaBean&gt; getDynaList(String sql, List&lt;?&gt; params)
	{
<span class="nc" id="L811">		return getDynaList(sql, params, null);</span>
	}

	public static List&lt;DynaBean&gt; getDynaList(String sql, List&lt;?&gt; params, String dbName)
	{
		try
		{
<span class="nc" id="L818">			Logger.debug(DB.class, &quot;getting dynaList, query: &quot; + sql);</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">			Connection db_conn = Tools.isNotEmpty(dbName) ? DBPool.getConnection(dbName) : DBPool.getConnection();</span>
<span class="nc bnc" id="L820" title="All 2 branches missed.">			if (db_conn != null)</span>
				try
				{
<span class="nc" id="L823">					PreparedStatement ps = db_conn.prepareStatement(sql);</span>
					try
					{
<span class="nc bnc" id="L826" title="All 4 branches missed.">						if (params != null &amp;&amp; params.size()&gt;0)</span>
						{
<span class="nc" id="L828">							int size = params.size();</span>
							int i;
							Object o;
<span class="nc bnc" id="L831" title="All 2 branches missed.">							for (i=1; i&lt;=size; i++)</span>
							{
<span class="nc" id="L833">								o = params.get(i-1);</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">								if (o instanceof String)</span>
								{
<span class="nc" id="L836">									ps.setString(i, (String)o);</span>
								}
<span class="nc bnc" id="L838" title="All 2 branches missed.">								else if (o instanceof Integer)</span>
								{
<span class="nc" id="L840">									ps.setInt(i, ((Integer)o).intValue());</span>
								}
<span class="nc bnc" id="L842" title="All 2 branches missed.">								else if (o instanceof Double)</span>
								{
<span class="nc" id="L844">									ps.setDouble(i, ((Double)o).doubleValue());</span>
								}
<span class="nc bnc" id="L846" title="All 2 branches missed.">								else if (o instanceof Float)</span>
								{
<span class="nc" id="L848">									ps.setFloat(i, ((Float)o).floatValue());</span>
								}
<span class="nc bnc" id="L850" title="All 2 branches missed.">								else if (o instanceof Long)</span>
								{
<span class="nc" id="L852">									ps.setLong(i, ((Long)o).longValue());</span>
								}
<span class="nc bnc" id="L854" title="All 2 branches missed.">								else if (o instanceof Boolean)</span>
								{
<span class="nc" id="L856">									ps.setBoolean(i, ((Boolean)o).booleanValue());</span>
								}
<span class="nc bnc" id="L858" title="All 2 branches missed.">								else if (o instanceof Timestamp)</span>
								{
<span class="nc" id="L860">									ps.setTimestamp(i, (Timestamp)o);</span>
								}
<span class="nc bnc" id="L862" title="All 2 branches missed.">								else if (o instanceof java.sql.Date)</span>
								{
<span class="nc" id="L864">									ps.setDate(i, (java.sql.Date)o);</span>
								}
								else
								{
<span class="nc" id="L868">									ps.setObject(i, o);</span>
								}
							}
						}
<span class="nc" id="L872">						ResultSet rs = ps.executeQuery();</span>
						try
						{
<span class="nc" id="L875">							RowSetDynaClass rsdc = null;</span>
<span class="nc" id="L876">							rsdc=new IwcmRowSetDynaClass(rs);</span>
<span class="nc" id="L877">							Logger.debug(DB.class, &quot;dynaBenas found: &quot; + rsdc.getRows().size());</span>
<span class="nc" id="L878">							return rsdc.getRows();</span>
						}
<span class="nc" id="L880">						finally { rs.close(); }</span>
					}
<span class="nc" id="L882">					finally { ps.close(); }</span>
				}
<span class="nc" id="L884">				finally { db_conn.close(); }</span>
		}
<span class="nc" id="L886">		catch (Exception ex)</span>
		{
<span class="nc" id="L888">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L889">		}</span>
<span class="nc" id="L890">		return(new ArrayList&lt;DynaBean&gt;());</span>
	}

	public static int getIntValue(Object o, int defaultValue)
	{
<span class="nc" id="L895">		int ret = defaultValue;</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">		if (o instanceof Integer)</span>
		{
<span class="nc" id="L898">			ret = ((Integer)o).intValue();</span>
		}
<span class="nc bnc" id="L900" title="All 2 branches missed.">		else if (o instanceof Long)</span>
		{
<span class="nc" id="L902">			ret = (int)((Long)o).longValue();</span>
		}

<span class="nc" id="L905">		return(ret);</span>
	}

	public static long getLongValue(Object o, long defaultValue)
	{
<span class="nc" id="L910">		long ret = defaultValue;</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">		if (o instanceof Integer)</span>
		{
<span class="nc" id="L913">			ret = ((Integer)o).intValue();</span>
		}
<span class="nc bnc" id="L915" title="All 2 branches missed.">		else if (o instanceof Long)</span>
		{
<span class="nc" id="L917">			ret = ((Long)o).longValue();</span>
		}

<span class="nc" id="L920">		return(ret);</span>
	}


	public static void execute(String sql, Object... arguments)
	{
<span class="fc" id="L926">		new SimpleQuery().execute(sql, arguments);</span>
<span class="fc" id="L927">	}</span>

	public static int queryForInt(String sql, Object... parameters)
	{
<span class="fc" id="L931">		return new SimpleQuery().forInt(sql, parameters);</span>
	}

	public static long queryForLong(String sql, Object... parameters)
	{
<span class="nc" id="L936">		return new SimpleQuery().forLong(sql, parameters);</span>
	}

	public static String queryForString(String sql, Object... parameters)
	{
<span class="nc" id="L941">		return new SimpleQuery().forString(sql, parameters);</span>
	}

	public static double queryForDouble(String sql, Object... parameters)
	{
<span class="nc" id="L946">		return new SimpleQuery().forDouble(sql, parameters);</span>
	}

	public static BigDecimal queryForBigDecimal(String sql, Object...parameters)
	{
<span class="nc" id="L951">		return new SimpleQuery().forBigDecimal(sql, parameters);</span>
	}

	@SuppressWarnings(&quot;rawtypes&quot;)
	public static List queryForList(String sql, Object... parameters)
	{
<span class="fc" id="L957">		return new SimpleQuery().forList(sql, parameters);</span>
	}

	/**
	 * Vrati a skontroluje IN zoznam pre SQL tak, aby obsahoval len cisla, cize z &quot;1,xxx,2,3&quot; spravi &quot;1,2,3&quot;
	 * @param ids
	 * @return
	 */
	public static String getOnlyNumbersIn(String ids)
	{
<span class="fc" id="L967">		return getOnlyNumbersIn(ids,false);</span>
	}

	/**
	 * Vrati a skontroluje IN zoznam pre SQL tak, aby obsahoval len cisla, cize z &quot;1,xxx,2,3&quot; spravi &quot;1,2,3&quot;
	 * ak sa jedna o id-cka {@link GroupDetails} tak v pripade ze je zapnuty cloud sa kontroluje aj ich dostupnost pre aktualnu domenu
	 * @param ids
	 * @param checkGroups indikuje ci sa jedna o id-cka GroupDetails
	 * @return
	 */
	public static String getOnlyNumbersIn(String ids, boolean checkGroups)
	{
<span class="fc" id="L979">		StringTokenizer st = new StringTokenizer (ids, &quot;,&quot;);</span>
<span class="fc" id="L980">		StringBuilder ret = new StringBuilder();</span>
<span class="fc" id="L981">		GroupDetails group = null;</span>
<span class="fc" id="L982">		String domain = CloudToolsForCore.getDomainName();</span>
<span class="fc bfc" id="L983" title="All 2 branches covered.">		while (st.hasMoreTokens())</span>
		{
			try
			{
<span class="fc" id="L987">				String sid = st.nextToken();</span>
<span class="fc" id="L988">				sid = sid.replace('(', ' ');</span>
<span class="fc" id="L989">				sid = sid.replace(')', ')');</span>
<span class="fc" id="L990">				sid = sid.trim();</span>
<span class="fc" id="L991">				int id = Integer.parseInt(sid);</span>
<span class="pc bpc" id="L992" title="1 of 4 branches missed.">				if(checkGroups &amp;&amp; InitServlet.isTypeCloud())</span>
				{
<span class="nc" id="L994">					group = GroupsDB.getInstance().getGroup(id);</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">					if(group != null)</span>
					{
<span class="nc bnc" id="L997" title="All 2 branches missed.">						if(group.getDomainName().equalsIgnoreCase(domain))</span>
						{
<span class="nc bnc" id="L999" title="All 2 branches missed.">							if (ret.length()==0) ret = new StringBuilder(String.valueOf(id));</span>
<span class="nc" id="L1000">							else ret.append(',').append(id);</span>
						}
					}
				}
				else
				{
<span class="fc bfc" id="L1006" title="All 2 branches covered.">					if (ret.length()==0) ret = new StringBuilder(String.valueOf(id));</span>
<span class="fc" id="L1007">					else ret.append(',').append(id);</span>
				}


			}
<span class="nc" id="L1012">			catch (Exception ex)</span>
			{

<span class="pc" id="L1015">			}</span>
		}

<span class="fc" id="L1018">		return ret.toString();</span>
	}


	/**
	 * Upravi hodnotu timestampu tak, aby nebola pred zadanym rokom (kedze DB to tak nevedia mat)
	 * @param timestamp
	 * @param year
	 * @return
	 */
	public static long getTimestampNotBeforeYear(long timestamp, int year)
	{
<span class="nc" id="L1030">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1031">		cal.setTimeInMillis(timestamp);</span>

<span class="nc bnc" id="L1033" title="All 2 branches missed.">		if (cal.get(Calendar.YEAR)&lt;year)</span>
		{
<span class="nc" id="L1035">			cal.set(Calendar.YEAR, year);</span>
		}

<span class="nc" id="L1038">		return cal.getTimeInMillis();</span>
	}

	/**
	 * Upravi hodnotu timestampu tak, aby nebola za zadanym rokom (kedze DB to tak nevedia mat)
	 * @param timestamp
	 * @param year
	 * @return
	 */
	public static long getTimestampNotAfterYear(long timestamp, int year)
	{
<span class="nc" id="L1049">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1050">		cal.setTimeInMillis(timestamp);</span>

<span class="nc bnc" id="L1052" title="All 2 branches missed.">		if (cal.get(Calendar.YEAR)&gt;year)</span>
		{
<span class="nc" id="L1054">			cal.set(Calendar.YEAR, year);</span>
		}

<span class="nc" id="L1057">		return cal.getTimeInMillis();</span>
	}

	/**
	 * Upravi hodnotu timestampu tak, aby nebola pred a za zadanym rokom (kedze DB to tak nevedia mat)
	 * @param timestamp
	 * @param yearFrom
	 * @param yearTo
	 * @return
	 */
	public static long getTimestampNotBeforeAfterYear(long timestamp, int yearFrom, int yearTo)
	{
<span class="nc" id="L1069">		timestamp = getTimestampNotBeforeYear(timestamp, yearFrom);</span>
<span class="nc" id="L1070">		return getTimestampNotAfterYear(timestamp, yearTo);</span>
	}

	/**
	 * osetri HTML znacky v retazci - DEPRECATED, pouzi filterHtml
	 *
	 * @param escapedString
	 * @return*
	 * @deprecated - use filterHtml
	 */
	@Deprecated
	public static String filterEscaped(String escapedString)
	{
<span class="nc" id="L1083">		return filterHtml(escapedString);</span>
	}


	/**
	 * Vrati Integer hodnotu z databazy, pricom korektne vrati aj NULL
	 * @param rs
	 * @param colName
	 * @return
	 * @throws SQLException
	 */
	public static Integer getInteger(ResultSet rs, String colName) throws SQLException {
<span class="fc" id="L1095">		int nValue = rs.getInt(colName);</span>
<span class="fc bfc" id="L1096" title="All 2 branches covered.">		return rs.wasNull() ? null : nValue;</span>
  	}

	/**
	 * Vrati Boolean hodnotu z databazy, pricom korektne vrati aj NULL
	 * @param rs
	 * @param colName
	 * @return
	 * @throws SQLException
	 */
	public static Boolean getBoolean(ResultSet rs, String colName) throws SQLException {
<span class="fc" id="L1107">		boolean nValue = rs.getBoolean(colName);</span>
<span class="fc bfc" id="L1108" title="All 2 branches covered.">		return rs.wasNull() ? null : nValue;</span>
	}

	/**
	 * Returns 1/0 or true/false dependind on DB type
	 * @param b
	 * @return
	 */
	public static String getBooleanSql(boolean b) {
<span class="pc bpc" id="L1117" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_PGSQL) {</span>
<span class="nc bnc" id="L1118" title="All 2 branches missed.">			return b ? &quot;true&quot; : &quot;false&quot;;</span>
		}
<span class="fc bfc" id="L1120" title="All 2 branches covered.">		return b ? &quot;1&quot; : &quot;0&quot;;</span>
	}

	/**
	 * Add lower/unaccent(column) for case insensitive search in Oracle/PostgreSQL
	 * @param column
	 * @return
	 */
	public static String fixAiCiCol(String column) {
<span class="pc bpc" id="L1129" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_ORACLE) {</span>
<span class="nc" id="L1130">			return &quot;lower(&quot; + column + &quot;)&quot;;</span>
		}
<span class="pc bpc" id="L1132" title="1 of 2 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_PGSQL) {</span>
<span class="nc" id="L1133">			return &quot;lower(unaccent(&quot; + column + &quot;))&quot;;</span>
		}
<span class="fc" id="L1135">		return column;</span>
	}

	/**
	 * Fix value for case insensitive search in Oracle/PostgreSQL
	 * @param value
	 * @return
	 */
	public static String fixAiCiValue(String value) {
<span class="pc bpc" id="L1144" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_ORACLE) {</span>
<span class="nc" id="L1145">			return value.toLowerCase();</span>
		}
<span class="pc bpc" id="L1147" title="1 of 2 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_PGSQL) {</span>
<span class="nc" id="L1148">			return DB.internationalToEnglish(value).toLowerCase();</span>
		}
<span class="fc" id="L1150">		return value;</span>
	}

	/*
	 * prepare SQL query for datatable search, usage:
	 *
	 * List&lt;Object&gt; params = new ArrayList&lt;&gt;();
	 * sql += DB.getSqlQueryDatatable(&quot;url&quot;, url, true, params);
	 * sql += DB.getSqlQueryDatatable(&quot;query_string&quot;, errorText, true, params);
	 * sql += DB.getSqlQueryDatatable(&quot;count&quot;, countRange, true, params);
	 * int psCounter = 1;
	 * psCounter = DB.getSqlParamsDatatable(params, ps, psCounter);
	 *
	 * @param fieldName - name of database column
	 * @param searchText - searched text from request
	 * @param addAnd - true to add AND before condition
	 * @param params - list of parameters for PreparedStatement
	 * @return - SQL WHERE query part
	 */
	public static String getSqlQueryDatatable(String fieldName, String searchText, boolean addAnd, List&lt;Object&gt; params) {

<span class="fc bfc" id="L1171" title="All 2 branches covered.">		if (Tools.isEmpty(searchText)) return &quot;&quot;;</span>

<span class="fc" id="L1173">		StringBuilder sb = new StringBuilder();</span>
<span class="pc bpc" id="L1174" title="1 of 2 branches missed.">		if (addAnd) sb.append(&quot; AND &quot;);</span>
<span class="fc" id="L1175">		sb.append(fieldName).append(&quot; &quot;);</span>

<span class="pc bpc" id="L1177" title="1 of 4 branches missed.">		if (searchText.startsWith(&quot;range:&quot;) || searchText.startsWith(&quot;daterange:&quot;)) {</span>

<span class="fc" id="L1179">			boolean isDateRange = searchText.startsWith(&quot;daterange:&quot;);</span>
<span class="fc" id="L1180">			String value = searchText.substring(searchText.indexOf(&quot;:&quot;) + 1);</span>

<span class="pc bpc" id="L1182" title="1 of 2 branches missed.">			if (value.startsWith(&quot;-&quot;)) {</span>
<span class="nc" id="L1183">				sb.append(&quot; &lt;= ? &quot;);</span>

<span class="nc bnc" id="L1185" title="All 2 branches missed.">				if (isDateRange) params.add(new Timestamp(Tools.getLongValue(value.substring(1), 0)));</span>
<span class="nc" id="L1186">				else params.add(Tools.getIntValue(value.substring(1), 0));</span>
<span class="fc bfc" id="L1187" title="All 2 branches covered.">			} else if (value.contains(&quot;-&quot;)) {</span>
<span class="fc" id="L1188">				sb.append(&quot; BETWEEN ? AND ? &quot;);</span>

<span class="fc" id="L1190">				String[] values = Tools.getTokens(value, &quot;-&quot;);</span>
<span class="pc bpc" id="L1191" title="1 of 2 branches missed.">				if (isDateRange) {</span>
<span class="nc" id="L1192">					params.add(new Timestamp(Tools.getLongValue(values[0], 0)));</span>
<span class="nc" id="L1193">					params.add(new Timestamp(Tools.getLongValue(values[1], 0)));</span>
				} else {
<span class="fc" id="L1195">					params.add(Tools.getIntValue(values[0], 0));</span>
<span class="fc" id="L1196">					params.add(Tools.getIntValue(values[1], 0));</span>
				}
<span class="fc" id="L1198">			} else {</span>
<span class="fc" id="L1199">				sb.append(&quot; &gt;= ? &quot;);</span>

<span class="pc bpc" id="L1201" title="1 of 2 branches missed.">				if (isDateRange) params.add(new Timestamp(Tools.getLongValue(value, 0)));</span>
<span class="fc" id="L1202">				else params.add(Tools.getIntValue(value, 0));</span>
			}
<span class="fc" id="L1204">		} else {</span>
<span class="fc" id="L1205">			String operator = &quot;LIKE&quot;;</span>
<span class="pc bpc" id="L1206" title="3 of 4 branches missed.">			if (searchText.startsWith(&quot;^&quot;) &amp;&amp; searchText.endsWith(&quot;$&quot;)) operator = &quot;&quot;;</span>

<span class="fc" id="L1208">			sb.append(operator).append(&quot; ? &quot;);</span>

<span class="pc bpc" id="L1210" title="3 of 4 branches missed.">			if (searchText.startsWith(&quot;^&quot;) &amp;&amp; searchText.endsWith(&quot;$&quot;)) params.add(searchText);</span>
<span class="pc bpc" id="L1211" title="1 of 2 branches missed.">			else if (searchText.startsWith(&quot;^&quot;)) params.add(searchText.substring(1) + &quot;%&quot;);</span>
<span class="pc bpc" id="L1212" title="1 of 2 branches missed.">			else if (searchText.endsWith(&quot;$&quot;)) params.add(&quot;%&quot; + searchText.substring(0, searchText.length() - 1));</span>
<span class="fc" id="L1213">			else params.add(&quot;%&quot; + searchText.substring(1, searchText.length() - 1) + &quot;%&quot;);</span>
		}

<span class="fc" id="L1216">		return sb.toString();</span>
	}

	/**
	 * Fill PreparedStatement with parameters
	 * @param params - list of Parameters
	 * @param ps - prepared statement
	 * @param psCounter - counter of parameters, starts with 1 for first parameter
	 * @return - new counter of parameters
	 * @throws SQLException
	 */
	public static int getSqlParamsDatatable(List&lt;Object&gt; params, PreparedStatement ps, int psCounter) throws SQLException {

		//set list of params to PreparedStatemend based of instanceof
<span class="fc bfc" id="L1230" title="All 2 branches covered.">		for (Object param : params) {</span>
<span class="pc bpc" id="L1231" title="1 of 2 branches missed.">			if (param instanceof Timestamp) {</span>
<span class="nc" id="L1232">				ps.setTimestamp(psCounter++, (Timestamp) param);</span>
<span class="pc bpc" id="L1233" title="1 of 2 branches missed.">			} else if (param instanceof Long) {</span>
<span class="nc" id="L1234">				ps.setLong(psCounter++, (Long) param);</span>
<span class="fc bfc" id="L1235" title="All 2 branches covered.">			} else if (param instanceof Integer) {</span>
<span class="fc" id="L1236">				ps.setInt(psCounter++, (Integer) param);</span>
<span class="pc bpc" id="L1237" title="1 of 2 branches missed.">			} else if (param instanceof String) {</span>
<span class="fc" id="L1238">				ps.setString(psCounter++, (String) param);</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">			} else if (param instanceof Boolean) {</span>
<span class="nc" id="L1240">				ps.setBoolean(psCounter++, (Boolean) param);</span>
			}
<span class="fc" id="L1242">		}</span>

<span class="fc" id="L1244">		return psCounter;</span>
	}


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>