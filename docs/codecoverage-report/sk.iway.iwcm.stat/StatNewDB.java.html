<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatNewDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.stat</a> &gt; <span class="el_source">StatNewDB.java</span></div><h1>StatNewDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.stat;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.StringTokenizer;
import java.util.TreeMap;

import javax.servlet.http.HttpServletRequest;

import org.apache.struts.util.ResponseUtils;

import sk.iway.iwcm.Cache;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DebugTimer;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.system.ConfDB;

/**
 *  StatNewDB.java
 *
 *@Title        WebJET
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2005
 *@author       $Author: jeeff $
 *@version      $Revision: 1.40 $
 *@created      Date: 10.1.2005 15:13:34
 *@modified     $Date: 2010/01/20 10:13:22 $
 */
@SuppressWarnings({&quot;java:S2479&quot;, &quot;java:S1643&quot;})
public class StatNewDB
{

	private static Map&lt;String, String&gt; dateFunc;

<span class="nc" id="L58">	protected StatNewDB() {</span>
		//utility class
<span class="nc" id="L60">	}</span>

	static
	{
<span class="fc" id="L64">		dateFunc = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L65">		dateFunc.put(&quot;mysql_hour&quot;, &quot;HOUR(field)&quot;);</span>
<span class="fc" id="L66">		dateFunc.put(&quot;mssql_hour&quot;, &quot;DATEPART(hour, field)&quot;);</span>
<span class="fc" id="L67">		dateFunc.put(&quot;ora_hour&quot;,   &quot;TO_CHAR(field, 'HH24')&quot;);</span>
<span class="fc" id="L68">		dateFunc.put(&quot;pgsql_hour&quot;,   &quot;TO_CHAR(field, 'HH24')&quot;);</span>
<span class="fc" id="L69">	}</span>

	/**
	 * Vytvori pole suffixov tabuliek v rozsahu zadanych datumov
	 * @param dateFrom
	 * @param dateTo
	 * @return
	 */
	public static String[] getTableSuffix(long dateFrom, long dateTo)
	{
<span class="fc" id="L79">		return getTableSuffix(null, dateFrom, dateTo);</span>
	}

	private static boolean isPartitioningAllowedFor(String tableName)
	{
<span class="pc bpc" id="L84" title="3 of 4 branches missed.">		return Constants.getBoolean(&quot;statEnableTablePartitioning&quot;) || &quot;stat_clicks&quot;.equals(tableName);</span>
	}

	/**
	 * Vytvori pole suffixov tabuliek v rozsahu zadanych datumov pre zadanu tabulku
	 * @param tableName
	 * @param dateFrom
	 * @param dateTo
	 * @return
	 */
	public static String[] getTableSuffix(String tableName, long dateFrom, long dateTo)
	{
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">		if (isPartitioningAllowedFor(tableName)==false)</span>
		{
<span class="nc" id="L98">			String[] suffix = new String[1];</span>
<span class="nc" id="L99">			suffix[0] = &quot;&quot;;</span>
<span class="nc" id="L100">			return suffix;</span>
		}
<span class="fc" id="L102">		Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L103">		cal.setTimeInMillis(dateFrom);</span>
<span class="fc" id="L104">		cal.set(Calendar.DATE, 1);</span>

<span class="fc" id="L106">		List&lt;String&gt; suffixList = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L108" title="All 6 branches covered.">		if (tableName != null &amp;&amp; !&quot;stat_clicks&quot;.equals(tableName) &amp;&amp; !&quot;stat_views&quot;.equals(tableName))</span>
		{
<span class="fc" id="L110">			String convertDate = Constants.getString(&quot;statTablePartitioningDate-&quot;+tableName);</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(convertDate))</span>
			{
<span class="fc" id="L113">				long date = DB.getTimestamp(convertDate);</span>
<span class="pc bpc" id="L114" title="2 of 4 branches missed.">				if (date &gt; 100000 &amp;&amp; date &gt; dateFrom)</span>
				{
<span class="nc" id="L116">					cal.setTimeInMillis(date);</span>
					//v liste musime ponechat aj povodnu tabulku stat_from
<span class="nc" id="L118">					suffixList.add(&quot;&quot;);</span>
				}
<span class="fc" id="L120">			}</span>
			else
			{
				//na tabulke este nie je vytvorena particia
<span class="nc" id="L124">				String[] suffix = new String[1];</span>
<span class="nc" id="L125">				suffix[0] = &quot;&quot;;</span>
<span class="nc" id="L126">				return suffix;</span>
			}
		}

<span class="fc bfc" id="L130" title="All 2 branches covered.">		while (cal.getTimeInMillis() &lt;= dateTo)</span>
		{
<span class="fc" id="L132">			String suffix = &quot;_&quot;+cal.get(Calendar.YEAR)+&quot;_&quot;+(cal.get(Calendar.MONTH)+1);</span>
<span class="fc" id="L133">			suffixList.add(suffix);</span>
<span class="fc" id="L134">			cal.set(Calendar.DATE, 1);</span>
<span class="fc" id="L135">			cal.add(Calendar.MONTH, 1);</span>
<span class="fc" id="L136">		}</span>

		//skonvertuj na pole
<span class="fc" id="L139">		String[] suffixArray = new String[suffixList.size()];</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">		for (int i=0; i&lt;suffixArray.length; i++)</span>
		{
<span class="fc" id="L142">			suffixArray[i] = suffixList.get(i);</span>
			//Logger.debug(StatNewDB.class, &quot;Suffix (&quot;+tableName+&quot;): &quot;+suffixArray[i]);
		}

<span class="fc" id="L146">		return suffixArray;</span>
	}


	public static String getTableSuffix(String tableName)
	{
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">		if (isPartitioningAllowedFor(tableName)==false) return &quot;&quot;;</span>

<span class="fc" id="L154">		String convertDate = Constants.getString(&quot;statTablePartitioningDate-&quot;+tableName);</span>

<span class="pc bpc" id="L156" title="1 of 2 branches missed.">		if (Tools.isEmpty(convertDate))</span>
		{
			//prave sme to vytvorili
<span class="nc" id="L159">			String actualDateTime = Tools.formatDateTime(Tools.getNow());</span>
<span class="nc" id="L160">			Constants.setString(&quot;statTablePartitioningDate-&quot;+tableName, actualDateTime);</span>
<span class="nc" id="L161">			ConfDB.setName(&quot;statTablePartitioningDate-&quot;+tableName, actualDateTime);</span>
		}

<span class="fc" id="L164">		Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L165">		return &quot;_&quot;+cal.get(Calendar.YEAR)+&quot;_&quot;+(cal.get(Calendar.MONTH)+1);</span>
	}

	/**
	 * Skontroluje v popise chyby ci nastala chyba, ze neexistuje partitioning tabulka
	 * ak ano vytvori ju a vrati true, inak vrati false. Takato chyba nastava v statistike
	 * ked je nastavene obdobie, pre ktore este neexistuje vytvorena tabulka.
	 * @param errorMessage
	 * @param suffix
	 * @return
	 */
	public static boolean createStatTablesFromError(String errorMessage, String suffix)
	{
<span class="nc" id="L178">		return createStatTablesFromError(errorMessage, suffix, &quot;stat_views&quot;);</span>
	}

	public static boolean createStatTablesFromError(String errorMessage, String suffix, String tableName)
	{
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">		if (Tools.isEmpty(errorMessage)) return false;</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">		if (isPartitioningAllowedFor(tableName))</span>
		{
			//ORA-00942 je chybovy kod chybajucej tabulky v Oracle - samotna hlaska moze byt internacionalizovana
<span class="pc bpc" id="L187" title="6 of 8 branches missed.">			if (errorMessage.contains(&quot;Invalid object name&quot;) || errorMessage.contains(&quot;doesn't exist&quot;) || errorMessage.contains(&quot;not exist&quot;) || errorMessage.contains(&quot;ORA-00942&quot;))</span>
			{
<span class="fc" id="L189">				createStatTable(tableName, suffix);</span>
<span class="fc" id="L190">				return true;</span>
			}
		}
<span class="nc" id="L193">		return false;</span>
	}

	/**
	 * Vytvori a nastavi default parametre pre PS - cursor a fetch size (setri pamat)
	 * @param dbConn
	 * @param sql
	 * @return
	 * @throws SQLException
	 */
	public static PreparedStatement prepareStatement(Connection dbConn, String sql) throws SQLException
	{
<span class="fc" id="L205">		DBPool.setTransactionIsolationReadUNCommited(dbConn);</span>
<span class="fc" id="L206">		PreparedStatement ps = dbConn.prepareStatement(sql, ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY);</span>

<span class="fc" id="L208">		ps.setFetchSize(1);</span>

<span class="fc" id="L210">		return ps;</span>
	}

	/**
	 * Vrati SQL prikaz pre vytvorenie danej tabulky
	 * @param tableName
	 * @param suffix
	 * @return
	 */
	private static String getCreateStatTableSqlCommand(String tableName, String suffix, int DB_TYPE)
	{
<span class="fc" id="L221">		String procedureName = Constants.getString(&quot;statTableCreateProcedureName&quot;);</span>
<span class="pc bpc" id="L222" title="3 of 4 branches missed.">		if (Tools.isNotEmpty(procedureName) &amp;&amp; procedureName.length()&gt;2)</span>
		{
<span class="nc" id="L224">			procedureName = Tools.replace(procedureName, &quot;{1}&quot;, tableName);</span>
<span class="nc" id="L225">			procedureName = Tools.replace(procedureName, &quot;{2}&quot;, suffix);</span>
<span class="nc" id="L226">			return procedureName;</span>
		}

<span class="fc" id="L229">		String sql = null;</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">		if (&quot;stat_error&quot;.equals(tableName))</span>
		{
<span class="nc bnc" id="L232" title="All 2 branches missed.">			if (DB_TYPE == Constants.DB_MYSQL)</span>
			{
<span class="nc" id="L234">				sql = &quot;CREATE TABLE stat_error&quot;+suffix+&quot; (&quot;+</span>
				&quot;year int unsigned NOT NULL,&quot;+
				&quot;week int unsigned NOT NULL,&quot;+
				&quot;url varchar(255),&quot;+
				&quot;query_string varchar(255),&quot;+
				&quot;count int unsigned DEFAULT 0,&quot;+
				&quot;domain_id int unsigned DEFAULT 0,&quot;+
				&quot;KEY i_stat_error&quot;+suffix+&quot; (year, week)&quot;+
<span class="nc" id="L242">				&quot;) ENGINE=&quot;+Constants.getString(&quot;mariaDbDefaultEngine&quot;);</span>
			}
<span class="nc bnc" id="L244" title="All 4 branches missed.">			else if (DB_TYPE == Constants.DB_MSSQL || DB_TYPE == Constants.DB_PGSQL)</span>
			{
<span class="nc" id="L246">				sql = &quot;CREATE TABLE stat_error&quot;+suffix+&quot; (&quot;+</span>
				&quot;year int NOT NULL,&quot;+
				&quot;week int NOT NULL,&quot;+
				&quot;url nvarchar(255),&quot;+
				&quot;query_string nvarchar(255),&quot;+
				&quot;count int DEFAULT 0,&quot;+
				&quot;domain_id int DEFAULT 0&quot;+
				&quot;);&quot;+
				&quot;CREATE INDEX IX_yw&quot;+suffix+&quot; ON stat_error&quot;+suffix+&quot; (year, week);&quot;;
			}
<span class="nc bnc" id="L256" title="All 2 branches missed.">			else if (DB_TYPE == Constants.DB_ORACLE)</span>
			{
<span class="nc" id="L258">				sql = &quot;CREATE TABLE stat_error&quot;+suffix+&quot; (&quot;+</span>
				&quot;year INTEGER NOT NULL,&quot;+
				&quot;week INTEGER NOT NULL,&quot;+
				&quot;url nvarchar2(255),&quot;+
				&quot;query_string nvarchar2(255),&quot;+
				&quot;count INTEGER DEFAULT 0,&quot;+
				&quot;domain_id INTEGER DEFAULT 0&quot;+
				&quot;);&quot;+
				&quot;CREATE INDEX IX_ywse&quot;+suffix+&quot; ON stat_error&quot;+suffix+&quot; (year, week);&quot;;
			}
		}
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">		else if (&quot;stat_from&quot;.equals(tableName))</span>
		{
<span class="nc bnc" id="L271" title="All 2 branches missed.">			if (DB_TYPE == Constants.DB_MYSQL)</span>
			{
<span class="nc" id="L273">				sql = &quot;CREATE TABLE stat_from&quot;+suffix+&quot; (&quot;+</span>
				&quot;from_id int unsigned NOT NULL AUTO_INCREMENT,&quot;+
				&quot;browser_id bigint unsigned,&quot;+
				&quot;session_id bigint unsigned,&quot;+
				&quot;referer_server_name varchar(255),&quot;+
				&quot;referer_url varchar(255),&quot;+
				&quot;from_time datetime,&quot;+
				&quot;doc_id int,&quot;+
				&quot;group_id int unsigned NOT NULL DEFAULT 0,&quot;+
				&quot;PRIMARY KEY (from_id)&quot;+
<span class="nc" id="L283">				&quot;) ENGINE=&quot;+Constants.getString(&quot;mariaDbDefaultEngine&quot;);</span>
			}
<span class="nc bnc" id="L285" title="All 4 branches missed.">			else if (DB_TYPE == Constants.DB_MSSQL || DB_TYPE == Constants.DB_PGSQL)</span>
			{
<span class="nc" id="L287">				sql = &quot;CREATE TABLE stat_from&quot;+suffix+&quot; (&quot;+</span>
				&quot;from_id int NOT NULL identity(1,1),&quot;+
				&quot;browser_id bigint,&quot;+
				&quot;session_id  bigint,&quot;+
				&quot;referer_server_name nvarchar(255),&quot;+
				&quot;referer_url nvarchar(255),&quot;+
				&quot;from_time datetime,&quot;+
				&quot;doc_id int,&quot;+
				&quot;group_id int NOT NULL DEFAULT 0,&quot;+
				&quot;PRIMARY KEY (from_id))&quot;;
			}
<span class="nc bnc" id="L298" title="All 2 branches missed.">			else if (DB_TYPE == Constants.DB_ORACLE)</span>
			{
<span class="nc" id="L300">				sql = &quot;CREATE TABLE stat_from&quot;+suffix+&quot; (&quot;+</span>
				&quot;from_id INTEGER NOT NULL,&quot;+
				&quot;browser_id INTEGER,&quot;+
				&quot;session_id  INTEGER,&quot;+
				&quot;referer_server_name nvarchar2(255),&quot;+
				&quot;referer_url nvarchar2(255),&quot;+
				&quot;from_time DATE,&quot;+
				&quot;doc_id INTEGER,&quot;+
				&quot;group_id INTEGER NOT NULL&quot;+
				&quot;);&quot;+
				&quot;ALTER TABLE stat_from&quot;+suffix+&quot; add CONSTRAINT pk_stat_from&quot;+suffix+&quot; PRIMARY KEY (from_id);&quot;+
				&quot;CREATE SEQUENCE S_stat_from&quot;+suffix+&quot; START WITH 1;&quot;+
				&quot;CREATE TRIGGER T_stat_from&quot;+suffix+&quot; BEFORE INSERT ON stat_from&quot;+suffix+&quot; &quot;+
				&quot;FOR EACH ROW \n&quot;+
				&quot;	DECLARE \n&quot;+
				&quot;		val INTEGER|\n&quot;+
				&quot;	BEGIN\n&quot;+
				&quot;		IF :new.from_id IS NULL THEN\n&quot;+
				&quot;			SELECT S_stat_from&quot;+suffix+&quot;.nextval into val FROM dual|\n&quot;+
				&quot;			:new.from_id:= val|\n&quot;+
				&quot;		END IF|\n&quot;+
				&quot;	END|\n&quot;+
				&quot;;&quot;;
			}
		}
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">		else if (&quot;stat_searchengine&quot;.equals(tableName))</span>
		{
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">			if (DB_TYPE == Constants.DB_MYSQL)</span>
			{
<span class="fc" id="L329">				sql = &quot;CREATE TABLE stat_searchengine&quot;+suffix+&quot; (&quot;+</span>
				&quot;search_date datetime NOT NULL, &quot;+
				&quot;server varchar(16) NOT NULL,&quot;+
				&quot;query varchar(64) NOT NULL,&quot;+
				&quot;doc_id int NOT NULL,&quot;+
				&quot;remote_host varchar(255),&quot;+
				&quot;group_id int(10) unsigned NOT NULL&quot;+
<span class="fc" id="L336">				&quot;) ENGINE=&quot;+Constants.getString(&quot;mariaDbDefaultEngine&quot;);</span>
			}
<span class="nc bnc" id="L338" title="All 4 branches missed.">			else if (DB_TYPE == Constants.DB_MSSQL || DB_TYPE == Constants.DB_PGSQL)</span>
			{
<span class="nc" id="L340">				sql = &quot;CREATE TABLE stat_searchengine&quot;+suffix+&quot; (&quot;+</span>
				&quot;search_date datetime NOT NULL, &quot;+
				&quot;server nvarchar(16) NOT NULL,&quot;+
				&quot;query nvarchar(64) NOT NULL,&quot;+
				&quot;doc_id int NOT NULL,&quot;+
				&quot;remote_host nvarchar(255),&quot;+
				&quot;group_id int NOT NULL&quot;+
				&quot;)&quot;;
			}
<span class="nc bnc" id="L349" title="All 2 branches missed.">			else if (DB_TYPE == Constants.DB_ORACLE)</span>
			{
<span class="nc" id="L351">				sql = &quot;CREATE TABLE stat_searchengine&quot;+suffix+&quot; (&quot;+</span>
				&quot;search_date date NOT NULL, &quot;+
				&quot;server nvarchar2(16) NOT NULL,&quot;+
				&quot;query nvarchar2(64) NOT NULL,&quot;+
				&quot;doc_id integer NOT NULL,&quot;+
				&quot;remote_host nvarchar2(255),&quot;+
				&quot;group_id integer NOT NULL&quot;+
				&quot;)&quot;;
			}
		}
<span class="nc bnc" id="L361" title="All 2 branches missed.">		else if (&quot;stat_views&quot;.equals(tableName))</span>
		{
<span class="nc bnc" id="L363" title="All 2 branches missed.">			if (DB_TYPE == Constants.DB_MYSQL)</span>
			{
<span class="nc" id="L365">				sql = &quot;CREATE TABLE stat_views&quot;+suffix+&quot; (&quot; +</span>
				&quot;view_id int unsigned NOT NULL auto_increment,&quot; +
				&quot;browser_id bigint unsigned,&quot; +
				&quot;session_id bigint unsigned,&quot; +
				&quot;doc_id int,&quot; +
				&quot;last_doc_id int,&quot; +
				&quot;view_time datetime,&quot; +
				&quot;group_id int unsigned,&quot; +
				&quot;last_group_id int unsigned,&quot; +
				&quot;browser_ua_id int, &quot;+
				&quot;platform_id int, &quot;+
				&quot;subplatform_id int,&quot;+
				&quot;country varchar(4), &quot;+
				&quot;PRIMARY KEY  (view_id)&quot; +
				//&quot;,KEY i_group_id (group_id),&quot; +
				//&quot;KEY i_doc_id (doc_id)&quot; +
<span class="nc" id="L381">				&quot;) ENGINE=&quot;+Constants.getString(&quot;mariaDbDefaultEngine&quot;);</span>
			}
<span class="nc bnc" id="L383" title="All 4 branches missed.">			else if (DB_TYPE == Constants.DB_MSSQL || DB_TYPE == Constants.DB_PGSQL)</span>
			{
<span class="nc" id="L385">				sql = &quot;CREATE TABLE stat_views&quot;+suffix+&quot; (&quot;+</span>
					&quot;view_id int NOT NULL identity(1,1), &quot;+
					&quot;browser_id bigint, &quot;+
					&quot;session_id bigint, &quot;+
					&quot;doc_id int, &quot;+
					&quot;last_doc_id int, &quot;+
					&quot;view_time datetime NULL, &quot;+
					&quot;group_id int,&quot; +
					&quot;last_group_id int,&quot; +
					&quot;browser_ua_id int, &quot;+
					&quot;platform_id int, &quot;+
					&quot;subplatform_id int,&quot;+
					&quot;country varchar(4), &quot;+
					&quot;PRIMARY KEY (view_id))&quot;;
			}
<span class="nc bnc" id="L400" title="All 2 branches missed.">			else if (DB_TYPE == Constants.DB_ORACLE)</span>
			{
<span class="nc" id="L402">				sql = &quot;CREATE TABLE stat_views&quot;+suffix+&quot; (&quot; +</span>
						&quot;view_id INTEGER NOT NULL, &quot; +
						&quot;browser_id INTEGER, &quot; +
						&quot;session_id INTEGER, &quot; +
						&quot;doc_id INTEGER, &quot; +
						&quot;last_doc_id INTEGER, &quot; +
						&quot;view_time DATE NULL,&quot; +
						&quot;group_id INTEGER, &quot; +
						&quot;last_group_id INTEGER, &quot; +
						&quot;browser_ua_id INTEGER, &quot;+
						&quot;platform_id INTEGER, &quot;+
						&quot;subplatform_id INTEGER,&quot;+
						&quot;country VARCHAR(4), &quot;+
						&quot;PRIMARY KEY (view_id));&quot; +
						&quot;CREATE SEQUENCE S_stat_views&quot;+suffix+&quot; START WITH 1;&quot; +
						&quot;CREATE TRIGGER T_stat_views&quot;+suffix+&quot; BEFORE INSERT ON stat_views&quot;+suffix+&quot; &quot; +
						&quot;FOR EACH ROW \n&quot; +
						&quot;	DECLARE \n&quot; +
						&quot;	    val INTEGER|\n&quot; +
						&quot;	BEGIN\n&quot; +
						&quot;		IF :new.view_id IS NULL THEN\n&quot; +
						&quot;			SELECT S_stat_views&quot;+suffix+&quot;.nextval into val FROM dual| \n&quot; +
						&quot;			:new.view_id:= val|\n&quot; +
						&quot;		END IF|\n&quot; +
						&quot;	END|\n&quot; +
						&quot;;&quot;;
			}
		}
<span class="nc bnc" id="L430" title="All 2 branches missed.">		else if (&quot;stat_clicks&quot;.equals(tableName))</span>
		{
<span class="nc bnc" id="L432" title="All 2 branches missed.">			if (DB_TYPE == Constants.DB_MYSQL)</span>
			{
<span class="nc" id="L434">				sql = &quot;CREATE TABLE stat_clicks&quot;+suffix+&quot; (&quot;+</span>
						&quot;stat_click_id INT NOT NULL PRIMARY KEY AUTO_INCREMENT,&quot;+
						&quot;document_id INT,&quot;+
						&quot;x INT,&quot;+
						&quot;y INT,&quot;+
<span class="nc" id="L439">						&quot;day_of_month INT) ENGINE=&quot;+Constants.getString(&quot;mariaDbDefaultEngine&quot;);</span>
			}
<span class="nc bnc" id="L441" title="All 4 branches missed.">			else if (DB_TYPE == Constants.DB_MSSQL || DB_TYPE == Constants.DB_PGSQL)</span>
			{
<span class="nc" id="L443">				sql = &quot;CREATE TABLE stat_clicks&quot;+suffix+&quot; (&quot;+</span>
						&quot;stat_click_id INT identity(1,1) NOT NULL,&quot;+
						&quot;document_id INT,&quot;+
						&quot;x INT,&quot;+
						&quot;y INT,&quot;+
						&quot;day_of_month INT);&quot;;
			}
<span class="nc bnc" id="L450" title="All 2 branches missed.">			else if (DB_TYPE == Constants.DB_ORACLE)</span>
			{
<span class="nc" id="L452">				sql = &quot;CREATE TABLE stat_clicks&quot;+suffix+&quot; (&quot;+</span>
							&quot;stat_click_id INT NOT NULL,&quot;+
							&quot;document_id INTEGER,&quot;+
							&quot;x INTEGER,&quot;+
							&quot;y INTEGER,&quot;+
							&quot;day_of_month INTEGER);&quot;+

						&quot;CREATE SEQUENCE S_stat_clicks&quot;+suffix+&quot; START WITH 1;&quot;+
						&quot;	CREATE TRIGGER T_stat_clicks&quot;+suffix+&quot; BEFORE INSERT ON stat_clicks&quot;+suffix+
						&quot;		FOR EACH ROW  &quot;+
						&quot;			DECLARE&quot;+
						&quot; 				val INTEGER|&quot;+
						&quot;			BEGIN&quot;+
						&quot;				IF :new.stat_click_id IS NULL THEN&quot;+
						&quot;				SELECT S_stat_clicks&quot;+suffix+&quot;.nextval into val FROM dual|&quot;+
						&quot;					:new.stat_click_id:= val|&quot;+
						&quot;				END IF|&quot;+
						&quot;			END|;&quot;;
			}
<span class="nc" id="L471">			sql += &quot;CREATE INDEX to_document_&quot;+suffix+&quot; ON stat_clicks&quot;+suffix+&quot;(document_id);&quot;;</span>
		}
<span class="pc bpc" id="L473" title="3 of 4 branches missed.">		if (DB_TYPE == Constants.DB_PGSQL &amp;&amp; sql != null) {</span>
<span class="nc" id="L474">			int i = sql.indexOf(&quot;ENGINE=&quot;);</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">			if (i &gt; 0) sql = sql.substring(0, i);</span>

			//remove unsigned
<span class="nc" id="L478">			sql = Tools.replace(sql, &quot;unsigned&quot;, &quot;&quot;);</span>
			//replace nvarchar
<span class="nc" id="L480">			sql = Tools.replace(sql, &quot;nvarchar&quot;, &quot;varchar&quot;);</span>
			//update MS SQL identity
<span class="nc" id="L482">			sql = Tools.replace(sql, &quot;identity(1,1)&quot;, &quot;GENERATED BY DEFAULT AS IDENTITY&quot;);</span>
			//update datetime
<span class="nc" id="L484">			sql = Tools.replace(sql, &quot;datetime&quot;, &quot;timestamp&quot;);</span>
		}
<span class="fc" id="L486">		return sql;</span>
	}

	/**
	 * Vytvori tabulku stat_views_X_Y (ak treba)
	 * @param db_conn
	 * @param suffix - suffix tabulky, alebo null (vytvori sa suffix pre aktualny mesiac)
	 */
	public static void createStatTable(String tableName, String suffix)
	{
<span class="pc bpc" id="L496" title="3 of 4 branches missed.">		if (isPartitioningAllowedFor(tableName)==false &amp;&amp; suffix == null)</span>
		{
			//podmienka na suffix==null je tu kvoli admin_db_convert.jsp kedy to este nie je nastavene
			//ale suffix sa posiela
<span class="nc" id="L500">			return;</span>
		}

<span class="pc bpc" id="L503" title="1 of 2 branches missed.">		if (suffix == null)</span>
		{
<span class="fc" id="L505">			Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L506">			suffix = &quot;_&quot;+cal.get(Calendar.YEAR)+&quot;_&quot;+(cal.get(Calendar.MONTH)+1);</span>
		}

<span class="fc" id="L509">		Logger.debug(StatNewDB.class, &quot;Creating table: &quot;+tableName+suffix);</span>

<span class="fc" id="L511">		String sql = null;</span>
<span class="fc" id="L512">		Connection db_conn = null;</span>
<span class="fc" id="L513">		Statement ps = null;</span>
		try
		{
<span class="fc" id="L516">			db_conn = DBPool.getConnection();</span>

<span class="fc" id="L518">			sql = getCreateStatTableSqlCommand(tableName, suffix, Constants.DB_TYPE);</span>

<span class="pc bpc" id="L520" title="1 of 2 branches missed.">			if (Tools.isEmpty(sql)) return;</span>

<span class="fc" id="L522">			StringTokenizer st = new StringTokenizer(sql, &quot;;&quot;);</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">			while (st.hasMoreTokens())</span>
			{
<span class="fc" id="L525">				sql = st.nextToken().trim();</span>
<span class="pc bpc" id="L526" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(sql))</span>
				{
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">					if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
					{
<span class="nc" id="L530">						sql = Tools.replace(sql, &quot;|&quot;, &quot;;&quot;);</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">					   if (sql.indexOf(&quot;TRIGGER&quot;)!=-1)</span>
					   {
					   	//sql = sql.replace('\n', ' ');
					   	//sql = sql.replace('\r', ' ');
<span class="nc" id="L535">					   	sql = sql.replace('\t', ' ');</span>
					   }
					}
					try
					{
<span class="fc" id="L540">						Logger.debug(StatNewDB.class, &quot;createStatTable: &quot;+sql);</span>

<span class="fc" id="L542">						ps = db_conn.createStatement();</span>
<span class="fc" id="L543">						ps.execute(sql);</span>
<span class="fc" id="L544">						ps.close();</span>
					}
<span class="nc" id="L546">					catch (SQLException e)</span>
					{
<span class="nc" id="L548">						String message = e.getMessage().toLowerCase();</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">						if (message != null &amp;&amp;</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">								(message.indexOf(&quot;already&quot;)!=-1 ||</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">								 message.indexOf(&quot;duplicate column name&quot;)!=-1 ||</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">								 message.indexOf(&quot;is specified more than once&quot;)!=-1 ||</span>
<span class="nc bnc" id="L553" title="All 2 branches missed.">								 message.indexOf(&quot;duplicate entry&quot;)!=-1 ||</span>
<span class="nc bnc" id="L554" title="All 2 branches missed.">								 message.indexOf(&quot;already an object&quot;)!=-1 ||</span>
<span class="nc bnc" id="L555" title="All 2 branches missed.">								 message.indexOf(&quot;tabuľke existuje&quot;)!=-1 ||</span>
<span class="nc bnc" id="L556" title="All 2 branches missed.">								 message.indexOf(&quot;duplicate key&quot;)!=-1 ||</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">								 message.indexOf(&quot;názov už používa existujúci objekt&quot;)!=-1 ||</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">								 message.indexOf(&quot;už existuje&quot;)!=-1 ||</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">								 message.indexOf(&quot;existujúci objekt&quot;)!=-1))</span>
						{
							//uz existuje, je to OK
						}
						else
						{
<span class="nc" id="L565">							Logger.println(StatNewDB.class, &quot;SQL: &quot;+sql);</span>
<span class="nc" id="L566">							sk.iway.iwcm.Logger.error(e);</span>
						}
					}
					finally
					{
					   try
					   {
<span class="pc bpc" id="L573" title="1 of 2 branches missed.">					      if (ps!=null) ps.close();</span>
					   }
<span class="nc" id="L575">					   catch (Exception ex2)</span>
					   {

<span class="fc" id="L578">					   }</span>
<span class="fc" id="L579">					}</span>
				}
			}

<span class="pc bpc" id="L583" title="1 of 2 branches missed.">		   if (ps != null) ps.close();</span>
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">		   if (db_conn != null) db_conn.close();</span>

<span class="fc" id="L586">		   ps = null;</span>
<span class="fc" id="L587">		   db_conn = null;</span>
		}
<span class="nc" id="L589">		catch (SQLException e)</span>
		{
<span class="nc" id="L591">			String message = e.getMessage().toLowerCase();</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">			if (message != null &amp;&amp;</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">					(message.indexOf(&quot;already&quot;)!=-1 ||</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">					 message.indexOf(&quot;duplicate column name&quot;)!=-1 ||</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">					 message.indexOf(&quot;is specified more than once&quot;)!=-1 ||</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">					 message.indexOf(&quot;duplicate entry&quot;)!=-1 ||</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">					 message.indexOf(&quot;already an object&quot;)!=-1 ||</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">					 message.indexOf(&quot;tabuľke existuje&quot;)!=-1 ||</span>
<span class="nc bnc" id="L599" title="All 2 branches missed.">					 message.indexOf(&quot;duplicate key&quot;)!=-1 ||</span>
<span class="nc bnc" id="L600" title="All 2 branches missed.">					 message.indexOf(&quot;názov už používa existujúci objekt&quot;)!=-1 ||</span>
<span class="nc bnc" id="L601" title="All 2 branches missed.">					 message.indexOf(&quot;už existuje&quot;)!=-1))</span>
			{
				//uz existuje, je to OK
			}
			else
			{
<span class="nc" id="L607">				Logger.println(StatNewDB.class, &quot;SQL: &quot;+sql);</span>
<span class="nc" id="L608">				sk.iway.iwcm.Logger.error(e);</span>
			}
		}
<span class="nc" id="L611">		catch (Exception ex)</span>
		{
<span class="nc" id="L613">		   sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
		   try
		   {
<span class="pc bpc" id="L619" title="1 of 2 branches missed.">		      if (ps!=null) ps.close();</span>
<span class="pc bpc" id="L620" title="1 of 2 branches missed.">		      if (db_conn!=null) db_conn.close();</span>
		   }
<span class="nc" id="L622">		   catch (Exception ex2)</span>
		   {

<span class="fc" id="L625">		   }</span>
		}
<span class="fc" id="L627">	}</span>

	/**
	 * Vrati SQL volanie pre vypis vt_day, vt_month a vt_year pre jednotlive DB
	 * @param fieldName
	 * @return
	 */
	public static String getDMYSelect(String fieldName)
	{
<span class="fc" id="L636">		String sql = &quot;DAYOFMONTH(&quot;+fieldName+&quot;) AS vt_day, MONTH(&quot;+fieldName+&quot;) AS vt_month, YEAR(&quot;+fieldName+&quot;) AS vt_year&quot;;</span>

<span class="pc bpc" id="L638" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
		{
<span class="nc" id="L640">			sql = &quot;DAY(&quot;+fieldName+&quot;) AS vt_day, MONTH(&quot;+fieldName+&quot;) AS vt_month, YEAR(&quot;+fieldName+&quot;) AS vt_year&quot;;</span>
		}
<span class="pc bpc" id="L642" title="2 of 4 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_ORACLE || Constants.DB_TYPE == Constants.DB_PGSQL)</span>
		{
<span class="nc" id="L644">			sql = &quot;TO_CHAR(&quot;+fieldName+&quot;, 'DD') AS vt_day, TO_CHAR(&quot;+fieldName+&quot;, 'MM') AS vt_month, TO_CHAR(&quot;+fieldName+&quot;, 'YYYY') AS vt_year&quot;;</span>
		}

<span class="fc" id="L647">		return(sql);</span>
	}

	/**
	 * Vrati SQL volanie do SELECTU pre vypis vt_year a vt_week
	 * @param fieldName
	 * @return
	 */
	public static String getYWSelect(String fieldName)
	{
<span class="fc" id="L657">		String sql = &quot;YEAR(&quot;+fieldName+&quot;) AS vt_year, WEEKOFYEAR(&quot;+fieldName+&quot;) AS vt_week&quot;;</span>

<span class="pc bpc" id="L659" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
		{
<span class="nc" id="L661">			sql = &quot;YEAR(&quot;+fieldName+&quot;) AS vt_year, DATEPART(week, &quot;+fieldName+&quot;) AS vt_week&quot;;</span>
		}
<span class="pc bpc" id="L663" title="2 of 4 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_ORACLE || Constants.DB_TYPE == Constants.DB_PGSQL)</span>
		{
<span class="nc" id="L665">			sql = &quot;TO_CHAR(&quot;+fieldName+&quot;, 'YYYY') AS vt_year, TO_CHAR(&quot;+fieldName+&quot;, 'IW') AS vt_week&quot;;</span>
		}

<span class="fc" id="L668">		return(sql);</span>
	}

	public static String getYMSelect(String fieldName)
	{
<span class="fc" id="L673">		String sql = &quot;YEAR(&quot;+fieldName+&quot;) AS vt_year, MONTH(&quot;+fieldName+&quot;) AS vt_month&quot;;</span>

<span class="pc bpc" id="L675" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
		{
<span class="nc" id="L677">			sql = &quot;YEAR(&quot;+fieldName+&quot;) AS vt_year, MONTH(&quot;+fieldName+&quot;) AS vt_month&quot;;</span>
		}
<span class="pc bpc" id="L679" title="2 of 4 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_ORACLE || Constants.DB_TYPE == Constants.DB_PGSQL)</span>
		{
<span class="nc" id="L681">			sql = &quot;TO_CHAR(&quot;+fieldName+&quot;, 'YYYY') AS vt_year, TO_CHAR(&quot;+fieldName+&quot;, 'MM') AS vt_month&quot;;</span>
		}

<span class="fc" id="L684">		return(sql);</span>
	}

	/**
	 * Vrati SQL pre datum pre rozne DB
	 * @param type
	 * @param fieldName
	 * @param as
	 * @return
	 */
	public static String getDateSelect(String type, String fieldName, String as)
	{
<span class="fc" id="L696">		String db=&quot;mysql&quot;;</span>
<span class="pc bpc" id="L697" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_MSSQL) db = &quot;mssql&quot;;</span>
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_ORACLE) db = &quot;ora&quot;;</span>
<span class="pc bpc" id="L699" title="1 of 2 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_PGSQL) db = &quot;pgsql&quot;;</span>

<span class="fc" id="L701">		String sql = dateFunc.get(db+&quot;_&quot;+type);</span>
<span class="fc" id="L702">		sql = Tools.replace(sql, &quot;field&quot;, fieldName);</span>
<span class="pc bpc" id="L703" title="1 of 2 branches missed.">		if (as != null) sql = sql + &quot; AS &quot; + as;</span>
<span class="fc" id="L704">		return(sql);</span>
	}

	public static String getDateGroupBy(String type, String fieldName, String as)
	{
<span class="fc" id="L709">		String db = null;</span>
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_MSSQL) db = &quot;mssql&quot;;</span>
<span class="pc bpc" id="L711" title="1 of 2 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_ORACLE) db = &quot;ora&quot;;</span>
<span class="pc bpc" id="L712" title="1 of 2 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_PGSQL) db = &quot;pgsql&quot;;</span>
		else
		{
			//mysql
<span class="fc" id="L716">			return(as);</span>
		}

<span class="nc" id="L719">		String sql = dateFunc.get(db+&quot;_&quot;+type);</span>
<span class="nc" id="L720">		sql = Tools.replace(sql, &quot;field&quot;, fieldName);</span>
<span class="nc" id="L721">		return(sql);</span>
	}

	public static String getDMYGroupBy(String fieldName)
	{
<span class="fc" id="L726">		String sql = &quot;vt_day, vt_month, vt_year&quot;;</span>

<span class="pc bpc" id="L728" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
		{
<span class="nc" id="L730">			sql = &quot;DAY(&quot;+fieldName+&quot;), MONTH(&quot;+fieldName+&quot;), YEAR(&quot;+fieldName+&quot;)&quot;;</span>
		}
<span class="pc bpc" id="L732" title="2 of 4 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_ORACLE || Constants.DB_TYPE == Constants.DB_PGSQL)</span>
		{
<span class="nc" id="L734">			sql = &quot;TO_CHAR(&quot;+fieldName+&quot;, 'DD'), TO_CHAR(&quot;+fieldName+&quot;, 'MM'), TO_CHAR(&quot;+fieldName+&quot;, 'YYYY')&quot;;</span>
		}

<span class="fc" id="L737">		return(sql);</span>
	}

	public static String getYWGroupBy(String fieldName)
	{
<span class="fc" id="L742">		String sql = &quot;vt_year, vt_week&quot;;</span>

<span class="pc bpc" id="L744" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
		{
<span class="nc" id="L746">			sql = &quot;YEAR(&quot;+fieldName+&quot;), DATEPART(week, &quot;+fieldName+&quot;)&quot;;</span>
		}
<span class="pc bpc" id="L748" title="2 of 4 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_ORACLE || Constants.DB_TYPE == Constants.DB_PGSQL)</span>
		{
<span class="nc" id="L750">			sql = &quot;TO_CHAR(&quot;+fieldName+&quot;, 'YYYY'), TO_CHAR(&quot;+fieldName+&quot;, 'IW')&quot;;</span>
		}

<span class="fc" id="L753">		return(sql);</span>
	}

	public static String getYMGroupBy(String fieldName)
	{
<span class="fc" id="L758">		String sql = &quot;vt_year, vt_month&quot;;</span>

<span class="pc bpc" id="L760" title="1 of 2 branches missed.">		if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
		{
<span class="nc" id="L762">			sql = &quot;YEAR(&quot;+fieldName+&quot;), MONTH(&quot;+fieldName+&quot;)&quot;;</span>
		}
<span class="pc bpc" id="L764" title="2 of 4 branches missed.">		else if (Constants.DB_TYPE == Constants.DB_ORACLE || Constants.DB_TYPE == Constants.DB_PGSQL)</span>
		{
<span class="nc" id="L766">			sql = &quot;TO_CHAR(&quot;+fieldName+&quot;, 'YYYY'), TO_CHAR(&quot;+fieldName+&quot;, 'MM')&quot;;</span>
		}

<span class="fc" id="L769">		return(sql);</span>
	}


	public static List&lt;Column&gt; getTopPages(int max_size, java.util.Date from, java.util.Date to, int rootGroupId, String skipDocIds)
	{
<span class="nc" id="L775">		return getTopPages(max_size, from, to, rootGroupId, skipDocIds, false);</span>
	}

	/**
	 * Vygeneruje tabulku videni, sedeni, roznych userov pre top stranky za zvolene obdobie
	 *
	 * @param max_size
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @param skipDocIds
	 * @return
	 */
	public static List&lt;Column&gt; getTopPages(int max_size, java.util.Date from, java.util.Date to, int rootGroupId, String skipDocIds, boolean withoutBots)
	{
		//pri rozdeleni statistik nemusi byt presne z dovodu max_size citaneho podla prveho obdobia

<span class="fc" id="L792">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L794">		DebugTimer timer = new DebugTimer(&quot;StatNewDB.getTopPages&quot;);</span>

		Column col;
<span class="fc" id="L797">		int count = 0;</span>
<span class="fc" id="L798">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
		int docId;
<span class="fc" id="L800">		DocDB docDB = DocDB.getInstance();</span>
		DocDetails bdd;

<span class="fc" id="L803">		Map&lt;Integer, Column&gt; colTable = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L805">		String whitelistedQuery = &quot;&quot;;</span>
<span class="pc bpc" id="L806" title="1 of 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L807">			whitelistedQuery = getWhiteListedUAQuery();</span>

<span class="fc" id="L809">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L810" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L812">			count = 0;</span>

<span class="fc" id="L814">			Connection db_conn = null;</span>
<span class="fc" id="L815">			PreparedStatement ps = null;</span>
<span class="fc" id="L816">			ResultSet rs = null;</span>

			try
			{
<span class="fc" id="L820">				db_conn = DBPool.getConnectionReadUncommited();</span>

				//pocet sedeni
				//sql = &quot;SELECT DISTINCT doc_id, COUNT(DISTINCT session_id) AS pocet_sedeni FROM stat_ views GROUP BY doc_id ORDER BY pocet_sedeni DESC&quot;;

				//pocet videni
				//sql = &quot;SELECT s.doc_id, d.title, d.group_id, count(view_time) as pocet_videni FROM stat_ views s, documents d WHERE s.doc_id=d.doc_id GROUP BY s.doc_id ORDER BY pocet_videni DESC&quot;;

				//spolocny vypis

				//SQL robime na 2x - najskor zoznam a az potom join na documents, inak to v MySQL pri velkom pocte zaznamov trvalo strasne dlho
<span class="fc" id="L831">				String sql = &quot;SELECT s.doc_id, COUNT(s.doc_id) as views, COUNT(DISTINCT s.session_id) AS sessions,&quot; +</span>
						&quot; COUNT(DISTINCT s.browser_id) AS unique_users&quot; +
						&quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +
						&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=?&quot;;

				/*sql = &quot;SELECT s.doc_id, s.group_id, COUNT(s.doc_id) as views, COUNT(s.session_id) AS sessions,&quot; +
				&quot; COUNT(s.browser_id) AS unique_users&quot; +
				&quot; FROM stat_ views s&quot; +
				&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=?&quot;;*/

<span class="pc bpc" id="L841" title="3 of 4 branches missed.">				if (skipDocIds != null &amp;&amp; skipDocIds.length() &gt; 0)</span>
				{
<span class="nc" id="L843">					sql += &quot; AND s.doc_id NOT IN (&quot;+skipDocIds+&quot;) &quot;;</span>
				}
<span class="fc" id="L845">				sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, rootGroupId);</span>
<span class="fc" id="L846">				sql += whitelistedQuery;</span>
<span class="fc" id="L847">				sql += &quot; GROUP BY s.doc_id&quot;;</span>
<span class="fc" id="L848">				sql += &quot; ORDER BY views DESC&quot;;</span>

<span class="fc" id="L850">				Logger.debug(StatNewDB.class,&quot;GetTopPages: &quot;+sql);</span>

<span class="fc" id="L852">				ps = prepareStatement(db_conn, sql);</span>
<span class="fc" id="L853">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L854">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="fc" id="L856">				timer.diff(&quot;before RS&quot;);</span>
<span class="fc" id="L857">				rs = ps.executeQuery();</span>
<span class="fc" id="L858">				timer.diff(&quot;after RS&quot;);</span>

				//iteruj cez riadky
<span class="pc bpc" id="L861" title="1 of 4 branches missed.">				while (rs.next() &amp;&amp; count &lt; max_size)</span>
				{
<span class="fc" id="L863">					docId = rs.getInt(&quot;doc_id&quot;);</span>
<span class="fc" id="L864">					col = colTable.get(docId);</span>
<span class="pc bpc" id="L865" title="1 of 2 branches missed.">					if (col == null)</span>
					{
<span class="fc" id="L867">						col = new Column();</span>
<span class="fc" id="L868">						col.setColumn1(Integer.toString(docId));</span>
<span class="fc" id="L869">						bdd = docDB.getBasicDocDetails(docId, true);</span>
<span class="fc" id="L870">						col.setColumn2(bdd.getTitle());</span>
<span class="fc" id="L871">						col.setIntColumn3(rs.getInt(&quot;views&quot;));</span>
<span class="fc" id="L872">						col.setIntColumn4(rs.getInt(&quot;sessions&quot;));</span>
<span class="fc" id="L873">						col.setIntColumn5(rs.getInt(&quot;unique_users&quot;));</span>
<span class="fc" id="L874">						col.setColumn6(groupsDB.getPath(bdd.getGroupId())+&quot;/&quot;+col.getColumn2());</span>
<span class="fc" id="L875">						col.setColumn7(&quot;/apps/stat/admin/top-details/?docId=&quot;+docId+&quot;&amp;title=&quot;+Tools.URLEncode(col.getColumn6()));//link</span>
<span class="fc" id="L876">						ret.add(col);</span>
<span class="fc" id="L877">						colTable.put(docId, col);</span>
					}
					else
					{
						//zvys hodnoty
<span class="nc" id="L882">						col.setIntColumn3(col.getIntColumn3()+rs.getInt(&quot;views&quot;));</span>
<span class="nc" id="L883">						col.setIntColumn4(col.getIntColumn4()+rs.getInt(&quot;sessions&quot;));</span>
<span class="nc" id="L884">						col.setIntColumn5(col.getIntColumn5()+rs.getInt(&quot;unique_users&quot;));</span>
					}
<span class="fc" id="L886">					count++;</span>
				}

<span class="fc" id="L889">				rs.close();</span>
<span class="fc" id="L890">				ps.close();</span>
<span class="fc" id="L891">				db_conn.close();</span>
<span class="fc" id="L892">				rs = null;</span>
<span class="fc" id="L893">				ps = null;</span>
<span class="fc" id="L894">				db_conn = null;</span>
			}
<span class="nc" id="L896">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L898" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L904" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L905">						rs.close();</span>
<span class="pc bpc" id="L906" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L907">						ps.close();</span>
<span class="pc bpc" id="L908" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L909">						db_conn.close();</span>
				}
<span class="nc" id="L911">				catch (Exception ex2)</span>
				{
<span class="nc" id="L913">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L914">				}</span>
			}
		}

		//usporiadaj podla poctu videni
<span class="fc" id="L919">		Collections.sort(ret, new Comparator&lt;Column&gt;() {</span>
			@Override
			public int compare(Column c1, Column c2)
			{
<span class="fc" id="L923">				return (c2.getIntColumn3() - c1.getIntColumn3());</span>
			}

		});

<span class="fc" id="L928">		timer.diff(&quot;done&quot;);</span>

		//orez to na max pocet zaznamov
<span class="fc" id="L931">		List&lt;Column&gt; ret2 = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L932">		count = 0;</span>
<span class="fc" id="L933">		Iterator&lt;Column&gt; iter = ret.iterator();</span>
<span class="pc bpc" id="L934" title="1 of 4 branches missed.">		while (iter.hasNext() &amp;&amp; count++&lt;max_size)</span>
		{
<span class="fc" id="L936">			ret2.add(iter.next());</span>
		}

<span class="fc" id="L939">		return (ret2);</span>
	}

	public static List&lt;Column&gt; getTopPagesIn(int max_size, java.util.Date from, java.util.Date to, int rootGroupId, String skipDocIds)
	{
<span class="nc" id="L944">		return getTopPagesIn(max_size, from, to, rootGroupId, skipDocIds, false);</span>
	}

	/**
	 * Vrati zoznam nanavstevovanejsich vstupnych stranok
	 * @param max_size
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @param skipDocIds
	 * @return
	 */
	public static List&lt;Column&gt; getTopPagesIn(int max_size, java.util.Date from, java.util.Date to, int rootGroupId, String skipDocIds, boolean withoutBots)
	{
		//pri rozdeleni statistik nemusi byt presne z dovodu max_size citaneho podla prveho obdobia

<span class="nc" id="L960">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L962">		DebugTimer timer = new DebugTimer(&quot;StatNewDB.getTopPagesIn&quot;);</span>

		Column col;
<span class="nc" id="L965">		int count = 0;</span>
<span class="nc" id="L966">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
		int docId;
<span class="nc" id="L968">		DocDB docDB = DocDB.getInstance();</span>
		DocDetails bdd;

<span class="nc" id="L971">		Map&lt;Integer, Column&gt; colTable = new Hashtable&lt;&gt;();</span>

<span class="nc" id="L973">		String whitelistedQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L975">			whitelistedQuery = getWhiteListedUAQuery();</span>

<span class="nc" id="L977">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L980">			count = 0;</span>

<span class="nc" id="L982">			Connection db_conn = null;</span>
<span class="nc" id="L983">			PreparedStatement ps = null;</span>
<span class="nc" id="L984">			ResultSet rs = null;</span>

			try
			{
<span class="nc" id="L988">				db_conn = DBPool.getConnectionReadUncommited();</span>

				//pocet sedeni
				//sql = &quot;SELECT DISTINCT doc_id, COUNT(DISTINCT session_id) AS pocet_sedeni FROM stat_ views GROUP BY doc_id ORDER BY pocet_sedeni DESC&quot;;

				//pocet videni
				//sql = &quot;SELECT s.doc_id, d.title, d.group_id, count(view_time) as pocet_videni FROM stat_ views s, documents d WHERE s.doc_id=d.doc_id GROUP BY s.doc_id ORDER BY pocet_videni DESC&quot;;

				//spolocny vypis

				//SQL robime na 2x - najskor zoznam a az potom join na documents, inak to v MySQL pri velkom pocte zaznamov trvalo strasne dlho
<span class="nc" id="L999">				String sql = &quot;SELECT s.doc_id, COUNT(s.doc_id) as views, COUNT(DISTINCT s.session_id) AS sessions,&quot; +</span>
						&quot; COUNT(DISTINCT s.browser_id) AS unique_users&quot; +
						&quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +
						&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=? AND last_doc_id=-1&quot;;

				/*sql = &quot;SELECT s.doc_id, s.group_id, COUNT(s.doc_id) as views, COUNT(s.session_id) AS sessions,&quot; +
				&quot; COUNT(s.browser_id) AS unique_users&quot; +
				&quot; FROM stat_ views s&quot; +
				&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=?&quot;;*/

<span class="nc bnc" id="L1009" title="All 4 branches missed.">				if (skipDocIds != null &amp;&amp; skipDocIds.length() &gt; 0)</span>
				{
<span class="nc" id="L1011">					sql += &quot; AND s.doc_id NOT IN (&quot;+skipDocIds+&quot;) &quot;;</span>
				}
<span class="nc" id="L1013">				sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, rootGroupId);</span>
<span class="nc" id="L1014">				sql += whitelistedQuery;</span>
<span class="nc" id="L1015">				sql += &quot; GROUP BY s.doc_id&quot;;</span>
<span class="nc" id="L1016">				sql += &quot; ORDER BY views DESC&quot;;</span>

<span class="nc" id="L1018">				Logger.debug(StatNewDB.class,&quot;GetTopPages: &quot;+sql);</span>

<span class="nc" id="L1020">				ps = prepareStatement(db_conn, sql);</span>
<span class="nc" id="L1021">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="nc" id="L1022">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="nc" id="L1024">				timer.diff(&quot;before RS&quot;);</span>
<span class="nc" id="L1025">				rs = ps.executeQuery();</span>
<span class="nc" id="L1026">				timer.diff(&quot;after RS&quot;);</span>

				//iteruj cez riadky
<span class="nc bnc" id="L1029" title="All 4 branches missed.">				while (rs.next() &amp;&amp; count &lt; max_size)</span>
				{
<span class="nc" id="L1031">					docId = rs.getInt(&quot;doc_id&quot;);</span>
<span class="nc" id="L1032">					col = colTable.get(docId);</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">					if (col == null)</span>
					{
<span class="nc" id="L1035">						col = new Column();</span>
<span class="nc" id="L1036">						col.setColumn1(Integer.toString(docId));</span>
<span class="nc" id="L1037">						bdd = docDB.getBasicDocDetails(docId, true);</span>
<span class="nc" id="L1038">						col.setColumn2(bdd.getTitle());</span>
<span class="nc" id="L1039">						col.setIntColumn3(rs.getInt(&quot;views&quot;));</span>
<span class="nc" id="L1040">						col.setIntColumn4(rs.getInt(&quot;sessions&quot;));</span>
<span class="nc" id="L1041">						col.setIntColumn5(rs.getInt(&quot;unique_users&quot;));</span>
<span class="nc" id="L1042">						col.setColumn6(groupsDB.getPath(bdd.getGroupId())+&quot;/&quot;+col.getColumn2());</span>
<span class="nc" id="L1043">						col.setColumn7(&quot;/apps/stat/admin/top-details/?docId=&quot;+docId+&quot;&amp;title=&quot;+Tools.URLEncode(col.getColumn6()));//link</span>
<span class="nc" id="L1044">						ret.add(col);</span>
<span class="nc" id="L1045">						colTable.put(docId, col);</span>
					}
					else
					{
						//zvys hodnoty
<span class="nc" id="L1050">						col.setIntColumn3(col.getIntColumn3()+rs.getInt(&quot;views&quot;));</span>
<span class="nc" id="L1051">						col.setIntColumn4(col.getIntColumn4()+rs.getInt(&quot;sessions&quot;));</span>
<span class="nc" id="L1052">						col.setIntColumn5(col.getIntColumn5()+rs.getInt(&quot;unique_users&quot;));</span>
					}
<span class="nc" id="L1054">					count++;</span>
				}

<span class="nc" id="L1057">				rs.close();</span>
<span class="nc" id="L1058">				ps.close();</span>
<span class="nc" id="L1059">				db_conn.close();</span>
<span class="nc" id="L1060">				rs = null;</span>
<span class="nc" id="L1061">				ps = null;</span>
<span class="nc" id="L1062">				db_conn = null;</span>
			}
<span class="nc" id="L1064">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1066" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L1072" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L1073">						rs.close();</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L1075">						ps.close();</span>
<span class="nc bnc" id="L1076" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L1077">						db_conn.close();</span>
				}
<span class="nc" id="L1079">				catch (Exception ex2)</span>
				{
<span class="nc" id="L1081">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L1082">				}</span>
			}
		}

		//usporiadaj podla poctu videni
<span class="nc" id="L1087">		Collections.sort(ret, new Comparator&lt;Column&gt;() {</span>
			@Override
			public int compare(Column c1, Column c2)
			{
<span class="nc" id="L1091">				return (c2.getIntColumn3() - c1.getIntColumn3());</span>
			}

		});

<span class="nc" id="L1096">		timer.diff(&quot;done&quot;);</span>

		//orez to na max pocet zaznamov
<span class="nc" id="L1099">		List&lt;Column&gt; ret2 = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1100">		count = 0;</span>
<span class="nc" id="L1101">		Iterator&lt;Column&gt; iter = ret.iterator();</span>
<span class="nc bnc" id="L1102" title="All 4 branches missed.">		while (iter.hasNext() &amp;&amp; count++&lt;max_size)</span>
		{
<span class="nc" id="L1104">			ret2.add(iter.next());</span>
		}

<span class="nc" id="L1107">		return (ret2);</span>
	}

	public static List&lt;Column&gt; getTopPagesOut(int max_size, java.util.Date from, java.util.Date to, int rootGroupId, String skipDocIds)
	{
<span class="nc" id="L1112">		return getTopPagesOut(max_size, from, to, rootGroupId, skipDocIds, false);</span>
	}

	/**
	 * Ziska z databazy zoznam stranok, ktore boli posledne vramci session
	 * @param max_size
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @param skipDocIds
	 * @return
	 */
	public static List&lt;Column&gt; getTopPagesOut(int max_size, java.util.Date from, java.util.Date to, int rootGroupId, String skipDocIds, boolean withoutBots)
	{
<span class="nc" id="L1126">		DebugTimer timer = new DebugTimer(&quot;StatNewDB.getTopPagesOut&quot;);</span>

<span class="nc" id="L1128">		Map&lt;Long, Integer&gt; sessionsTable = new Hashtable&lt;&gt;();</span>

<span class="nc" id="L1130">		String whitelistedQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L1131" title="All 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L1132">			whitelistedQuery = getWhiteListedUAQuery();</span>

<span class="nc" id="L1134">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L1137">			Connection db_conn = null;</span>
<span class="nc" id="L1138">			PreparedStatement ps = null;</span>
<span class="nc" id="L1139">			ResultSet rs = null;</span>

			try
			{
<span class="nc" id="L1143">				db_conn = DBPool.getConnectionReadUncommited();</span>

<span class="nc" id="L1145">				String sql = &quot;SELECT session_id, doc_id&quot; +</span>
						&quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +
						&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=? AND last_doc_id=-1&quot;;

<span class="nc bnc" id="L1149" title="All 4 branches missed.">				if (skipDocIds != null &amp;&amp; skipDocIds.length() &gt; 0)</span>
				{
<span class="nc" id="L1151">					sql += &quot; AND s.doc_id NOT IN (&quot;+skipDocIds+&quot;) &quot;;</span>
				}
<span class="nc" id="L1153">				sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, rootGroupId);</span>
<span class="nc" id="L1154">				sql += whitelistedQuery;</span>
<span class="nc" id="L1155">				sql += &quot; ORDER BY view_id ASC&quot;;</span>

<span class="nc" id="L1157">				Logger.debug(StatNewDB.class,&quot;GetTopPagesOut: &quot;+sql);</span>

<span class="nc" id="L1159">				ps = prepareStatement(db_conn, sql);</span>
<span class="nc" id="L1160">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="nc" id="L1161">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="nc" id="L1163">				timer.diff(&quot;before RS&quot;);</span>
<span class="nc" id="L1164">				rs = ps.executeQuery();</span>
<span class="nc" id="L1165">				timer.diff(&quot;after RS&quot;);</span>

				//iteruj cez riadky
<span class="nc bnc" id="L1168" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L1170">					Long sessionId = rs.getLong(&quot;session_id&quot;);</span>
<span class="nc" id="L1171">					int docId = rs.getInt(&quot;doc_id&quot;);</span>

<span class="nc" id="L1173">					sessionsTable.put(sessionId, docId);</span>
<span class="nc" id="L1174">				}</span>

<span class="nc" id="L1176">				rs.close();</span>
<span class="nc" id="L1177">				ps.close();</span>
<span class="nc" id="L1178">				db_conn.close();</span>
<span class="nc" id="L1179">				rs = null;</span>
<span class="nc" id="L1180">				ps = null;</span>
<span class="nc" id="L1181">				db_conn = null;</span>
			}
<span class="nc" id="L1183">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1185" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L1191" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L1192">						rs.close();</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L1194">						ps.close();</span>
<span class="nc bnc" id="L1195" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L1196">						db_conn.close();</span>
				}
<span class="nc" id="L1198">				catch (Exception ex2)</span>
				{
<span class="nc" id="L1200">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L1201">				}</span>
			}
		}

<span class="nc" id="L1205">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L1206">		DocDB docDB = DocDB.getInstance();</span>
		DocDetails bdd;

		//v hashtable mame zoznam vsetkych objektov, treba spocitat podla poctu jednotlivych kusov
<span class="nc" id="L1210">		Map&lt;Integer, Column&gt; colTable = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L1211">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
		Column col;
<span class="nc bnc" id="L1213" title="All 2 branches missed.">		for (Map.Entry&lt;Long, Integer&gt; entry : sessionsTable.entrySet())</span>
		{
<span class="nc" id="L1215">			Integer docId = entry.getValue();</span>

<span class="nc" id="L1217">			col = colTable.get(docId);</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">			if (col == null)</span>
			{
<span class="nc" id="L1220">				col = new Column();</span>
<span class="nc" id="L1221">				col.setColumn1(Integer.toString(docId));</span>
<span class="nc" id="L1222">				bdd = docDB.getBasicDocDetails(docId, true);</span>
<span class="nc" id="L1223">				col.setColumn2(bdd.getTitle());</span>
<span class="nc" id="L1224">				col.setIntColumn5(1);</span>
<span class="nc" id="L1225">				col.setColumn6(groupsDB.getPath(bdd.getGroupId())+&quot;/&quot;+col.getColumn2());</span>
<span class="nc" id="L1226">				col.setColumn7(&quot;/apps/stat/admin/top-details/?docId=&quot;+docId+&quot;&amp;title=&quot;+Tools.URLEncode(col.getColumn6()));//link</span>
<span class="nc" id="L1227">				ret.add(col);</span>
<span class="nc" id="L1228">				colTable.put(docId, col);</span>
			}
			else
			{
				//zvys hodnoty
<span class="nc" id="L1233">				col.setIntColumn5(col.getIntColumn5()+1);</span>
			}
<span class="nc" id="L1235">		}</span>

		//usporiadaj podla poctu videni
<span class="nc" id="L1238">		Collections.sort(ret, new Comparator&lt;Column&gt;() {</span>
			@Override
			public int compare(Column c1, Column c2)
			{
<span class="nc" id="L1242">				return (c2.getIntColumn5() - c1.getIntColumn5());</span>
			}

		});

<span class="nc" id="L1247">		timer.diff(&quot;done&quot;);</span>

		//orez to na max pocet zaznamov
<span class="nc" id="L1250">		List&lt;Column&gt; ret2 = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1251">		int count = 0;</span>
<span class="nc" id="L1252">		Iterator&lt;Column&gt; iter = ret.iterator();</span>
<span class="nc bnc" id="L1253" title="All 4 branches missed.">		while (iter.hasNext() &amp;&amp; count++&lt;max_size)</span>
		{
<span class="nc" id="L1255">			ret2.add(iter.next());</span>
		}

<span class="nc" id="L1258">		return (ret2);</span>
	}

	/**
	 * Vygeneruje pre zvolene docID tabulku videni, sedeni, roznych userov za zvolene obdobie
	 * podla DNI
	 *
	 * @param docId
	 * @param from
	 * @param to
	 * @return
	 */
	public static List&lt;Column&gt; getPageViews(int docId, java.util.Date from, java.util.Date to)
	{
<span class="fc" id="L1272">		return getPageViews(docId, from, to, -1);</span>
	}

	/**
	 * Vygeneruje pre zvolene docID tabulku videni, sedeni, roznych userov za zvolene obdobie
	 * podla DNI a podla referera
	 *
	 * @param docId
	 * @param from
	 * @param to
	 * @param lastDocId - referer, ak je nastavene na -1, neberie sa do uvahy
	 * @return
	 */
	public static List&lt;Column&gt; getPageViews(int docId, java.util.Date from, java.util.Date to, int lastDocId)
	{
<span class="fc" id="L1287">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L1288" title="1 of 2 branches missed.">		if (docId &lt; 1) return ret;</span>

<span class="fc" id="L1290">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L1291" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L1293">			Connection db_conn = null;</span>
<span class="fc" id="L1294">			PreparedStatement ps = null;</span>
<span class="fc" id="L1295">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L1298">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L1299">				String sql = &quot;SELECT s.doc_id, &quot;+StatNewDB.getDMYSelect(&quot;view_time&quot;)+&quot;, COUNT(s.doc_id) AS views, COUNT(DISTINCT s.session_id) AS sessions, COUNT(DISTINCT s.browser_id) AS unique_users&quot;;</span>
<span class="fc" id="L1300">				sql +=&quot; FROM stat_views&quot;+suffixes[s]+&quot; s WHERE s.doc_id=? AND s.view_time&gt;=? AND s.view_time&lt;=?&quot;;</span>
<span class="pc bpc" id="L1301" title="1 of 2 branches missed.">				if(lastDocId != -1)</span>
				{
<span class="nc" id="L1303">					sql += &quot; AND s.last_doc_id=?&quot;;</span>
				}
<span class="fc" id="L1305">				sql+=	&quot; GROUP BY s.doc_id, &quot;+StatNewDB.getDMYGroupBy(&quot;view_time&quot;)+&quot; ORDER BY vt_year, vt_month, vt_day&quot;;</span>

<span class="fc" id="L1307">				Logger.debug(StatNewDB.class, &quot;getPageViews: &quot;+sql);</span>

<span class="fc" id="L1309">				ps = prepareStatement(db_conn, sql);</span>
<span class="fc" id="L1310">				ps.setInt(1,docId);</span>
<span class="fc" id="L1311">				ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="fc" id="L1312">				ps.setTimestamp(3, new Timestamp(to.getTime()));</span>
<span class="pc bpc" id="L1313" title="1 of 2 branches missed.">				if(lastDocId != -1)</span>
				{
<span class="nc" id="L1315">					ps.setInt(4,lastDocId);</span>
				}
<span class="fc" id="L1317">				rs = ps.executeQuery();</span>

				//iteruj cez riadky
				Column col;
<span class="fc bfc" id="L1321" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L1323">					col = new Column();</span>
<span class="fc" id="L1324">					col.setIntColumn1(rs.getInt(&quot;vt_year&quot;));</span>
<span class="fc" id="L1325">					col.setIntColumn2(rs.getInt(&quot;vt_month&quot;));</span>
<span class="fc" id="L1326">					col.setIntColumn3(rs.getInt(&quot;vt_day&quot;));</span>
<span class="fc" id="L1327">					col.setIntColumn4(rs.getInt(&quot;views&quot;));</span>
<span class="fc" id="L1328">					col.setIntColumn5(rs.getInt(&quot;sessions&quot;));</span>
<span class="fc" id="L1329">					col.setIntColumn6(rs.getInt(&quot;unique_users&quot;));</span>
<span class="fc" id="L1330">					ret.add(col);</span>
				}
<span class="fc" id="L1332">				rs.close();</span>
<span class="fc" id="L1333">				ps.close();</span>
<span class="fc" id="L1334">				db_conn.close();</span>
<span class="fc" id="L1335">				rs = null;</span>
<span class="fc" id="L1336">				ps = null;</span>
<span class="fc" id="L1337">				db_conn = null;</span>
			}
<span class="nc" id="L1339">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1341" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L1347" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L1348">						rs.close();</span>
<span class="pc bpc" id="L1349" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L1350">						ps.close();</span>
<span class="pc bpc" id="L1351" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L1352">						db_conn.close();</span>
				}
<span class="nc" id="L1354">				catch (Exception ex2)</span>
				{
<span class="nc" id="L1356">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L1357">				}</span>
			}
		}
<span class="fc" id="L1360">		return (ret);</span>
	}

	/**
	 * Vrati statistiku podla tyzdnov za dane obdobie a adresar
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @return
	 */
	public static List&lt;Column&gt; getWeekViews(java.util.Date from, java.util.Date to, int rootGroupId)
	{
<span class="nc" id="L1372">		return getWeekViews(from, to, String.valueOf(rootGroupId), false);</span>
	}

	public static List&lt;Column&gt; getWeekViews(java.util.Date from, java.util.Date to, int rootGroupId, boolean withoutBots)
	{
<span class="fc" id="L1377">		return getWeekViews(from, to, String.valueOf(rootGroupId), withoutBots);</span>
	}

	public static List&lt;Column&gt; getWeekViews(java.util.Date from, java.util.Date to, String groupIds)
	{
<span class="nc" id="L1382">		return getWeekViews(from, to, groupIds, false);</span>
	}

	/**
	 * Vrati statistiku podla tyzdnov za dane obdobie a adresar
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @param groupIds
	 * @return
	 */
	public static List&lt;Column&gt; getWeekViews(java.util.Date from, java.util.Date to, String groupIds, boolean withoutBots)
	{
<span class="fc" id="L1395">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1396">		Map&lt;String, Column&gt; colTable = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L1398">		String whitelistedQuery = &quot;&quot;;</span>
<span class="pc bpc" id="L1399" title="1 of 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L1400">			whitelistedQuery = getWhiteListedUAQuery();</span>

<span class="fc" id="L1402">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L1403" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L1405">			Connection db_conn = null;</span>
<span class="fc" id="L1406">			PreparedStatement ps = null;</span>
<span class="fc" id="L1407">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L1410">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L1412">				String sql = &quot;SELECT &quot; + getYWSelect(&quot;s.view_time&quot;)+&quot;, &quot;;</span>

<span class="fc" id="L1414">				sql += &quot; COUNT(s.doc_id) AS views, COUNT(DISTINCT s.session_id) AS sessions, COUNT(DISTINCT s.browser_id) AS unique_users&quot; +</span>
			 			&quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +
						&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=?&quot;;

<span class="fc" id="L1418">				sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, groupIds);</span>
<span class="fc" id="L1419">				sql += whitelistedQuery;</span>

<span class="fc" id="L1421">				sql += &quot; GROUP BY &quot;+getYWGroupBy(&quot;s.view_time&quot;);</span>

				//sql += &quot; ORDER BY  vt_year ASC, vt_week ASC&quot;;

<span class="fc" id="L1425">				Logger.debug(StatNewDB.class,&quot;getViews: &quot;+sql);</span>

<span class="fc" id="L1427">				ps = prepareStatement(db_conn, sql);</span>
<span class="fc" id="L1428">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L1429">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="fc" id="L1431">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
				Column col;

<span class="fc bfc" id="L1435" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L1437">					int year = rs.getInt(&quot;vt_year&quot;);</span>
<span class="fc" id="L1438">					int week = rs.getInt(&quot;vt_week&quot;);</span>
<span class="fc" id="L1439">					String key = year+&quot;-&quot;+week;</span>
<span class="fc" id="L1440">					col = colTable.get(key);</span>
<span class="fc bfc" id="L1441" title="All 2 branches covered.">					if (col == null)</span>
					{
<span class="fc" id="L1443">						col = new Column();</span>
<span class="fc" id="L1444">						col.setIntColumn1(year);</span>
<span class="fc" id="L1445">						col.setIntColumn2(week);</span>
<span class="fc" id="L1446">						col.setIntColumn3(rs.getInt(&quot;views&quot;));</span>
<span class="fc" id="L1447">						col.setIntColumn4(rs.getInt(&quot;sessions&quot;));</span>
<span class="fc" id="L1448">						col.setIntColumn5(rs.getInt(&quot;unique_users&quot;));</span>

						//spatna kompatibilita
<span class="fc" id="L1451">						col.setColumn1(Integer.toString(col.getIntColumn1()));</span>
<span class="fc" id="L1452">						col.setColumn2(Integer.toString(col.getIntColumn2()));</span>
<span class="fc" id="L1453">						col.setColumn3(Integer.toString(col.getIntColumn3()));</span>
<span class="fc" id="L1454">						col.setColumn4(Integer.toString(col.getIntColumn4()));</span>
<span class="fc" id="L1455">						col.setColumn5(Integer.toString(col.getIntColumn5()));</span>
<span class="fc" id="L1456">						ret.add(col);</span>
<span class="fc" id="L1457">						colTable.put(key, col);</span>
					}
					else
					{
<span class="fc" id="L1461">						col.setIntColumn3(col.getIntColumn3()+rs.getInt(&quot;views&quot;));</span>
<span class="fc" id="L1462">						col.setIntColumn4(col.getIntColumn4()+rs.getInt(&quot;sessions&quot;));</span>
<span class="fc" id="L1463">						col.setIntColumn5(col.getIntColumn5()+rs.getInt(&quot;unique_users&quot;));</span>

<span class="fc" id="L1465">						col.setColumn3(Integer.toString(col.getIntColumn3()));</span>
<span class="fc" id="L1466">						col.setColumn4(Integer.toString(col.getIntColumn4()));</span>
<span class="fc" id="L1467">						col.setColumn5(Integer.toString(col.getIntColumn5()));</span>
					}
<span class="fc" id="L1469">				}</span>
<span class="fc" id="L1470">				rs.close();</span>
<span class="fc" id="L1471">				ps.close();</span>
<span class="fc" id="L1472">				db_conn.close();</span>
<span class="fc" id="L1473">				rs = null;</span>
<span class="fc" id="L1474">				ps = null;</span>
<span class="fc" id="L1475">				db_conn = null;</span>
			}
<span class="nc" id="L1477">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1479" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L1485" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L1486">						rs.close();</span>
<span class="pc bpc" id="L1487" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L1488">						ps.close();</span>
<span class="pc bpc" id="L1489" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L1490">						db_conn.close();</span>
				}
<span class="nc" id="L1492">				catch (Exception ex2)</span>
				{
<span class="nc" id="L1494">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L1495">				}</span>
			}
		}
<span class="fc" id="L1498">		return (ret);</span>
	}

	/**
	 * Vrati statistiku podla dni za dane obdobie
	 *
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @return
	 */
	public static List&lt;Column&gt; getDayViews(java.util.Date from, java.util.Date to, int rootGroupId)
	{
<span class="nc" id="L1511">		return getDayViews(from, to, String.valueOf(rootGroupId));</span>
	}

	public static List&lt;Column&gt; getDayViews(java.util.Date from, java.util.Date to, int rootGroupId, boolean filterBotsOut)
	{
<span class="fc" id="L1516">		return getDayViews(from, to, String.valueOf(rootGroupId), filterBotsOut);</span>
	}

	public static List&lt;Column&gt; getDayViews(java.util.Date from, java.util.Date to, String groupIds)
	{
<span class="nc" id="L1521">		return getDayViews(from, to, groupIds, false);</span>
	}

	/**
	 * Vrati statistiku podla dni za dane obdobie
	 *
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @param groupIds
	 * @return
	 */
	public static List&lt;Column&gt; getDayViews(java.util.Date from, java.util.Date to, String groupIds, boolean withoutBots)
	{
<span class="fc" id="L1535">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
		Integer[] data;
<span class="fc" id="L1537">		Map&lt;String, Integer[]&gt; dates = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L1539">		Calendar cal = Calendar.getInstance();</span>
		Column col;

<span class="fc" id="L1542">		String whitelistedQuery = &quot;&quot;;</span>
<span class="fc bfc" id="L1543" title="All 2 branches covered.">		if(withoutBots)</span>
<span class="fc" id="L1544">			whitelistedQuery = getWhiteListedUAQuery();</span>

<span class="fc" id="L1546">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L1547" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L1549">			Connection db_conn = null;</span>
<span class="fc" id="L1550">			PreparedStatement ps = null;</span>
<span class="fc" id="L1551">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L1554">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L1556">				String sql = &quot;SELECT &quot;+getDMYSelect(&quot;s.view_time&quot;)+&quot;, COUNT(s.doc_id) AS views, COUNT(DISTINCT s.session_id) AS sessions, COUNT(DISTINCT s.browser_id) AS unique_users&quot;;</span>

<span class="fc" id="L1558">				sql += &quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +</span>
						&quot; WHERE s.view_time &gt;= ? AND s.view_time &lt;= ? &quot;;

<span class="fc" id="L1561">				sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, groupIds);</span>
<span class="fc" id="L1562">				sql += whitelistedQuery;</span>

<span class="fc" id="L1564">				sql += &quot; GROUP BY &quot;+getDMYGroupBy(&quot;s.view_time&quot;);</span>
				//sql += &quot; ORDER BY vt_year, vt_month, vt_day&quot;; - nepotrebujeme

<span class="fc" id="L1567">				Logger.debug(StatNewDB.class,&quot;getDayViews: &quot;+sql);</span>

<span class="fc" id="L1569">				ps = prepareStatement(db_conn, sql);</span>
<span class="fc" id="L1570">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L1571">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="fc" id="L1573">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L1575" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L1577">					cal.clear();</span>
<span class="fc" id="L1578">					cal.setFirstDayOfWeek(Calendar.MONDAY);</span>
<span class="fc" id="L1579">					cal.set(Calendar.YEAR, rs.getInt(&quot;vt_year&quot;));</span>
<span class="fc" id="L1580">					cal.set(Calendar.MONTH, rs.getInt(&quot;vt_month&quot;)-1);</span>
<span class="fc" id="L1581">					cal.set(Calendar.DAY_OF_MONTH, rs.getInt(&quot;vt_day&quot;));</span>

<span class="fc" id="L1583">					data = new Integer[3];</span>
<span class="fc" id="L1584">					data[0] = Integer.valueOf(rs.getInt(&quot;views&quot;));</span>
<span class="fc" id="L1585">					data[1] = Integer.valueOf(rs.getInt(&quot;sessions&quot;));</span>
<span class="fc" id="L1586">					data[2] = Integer.valueOf(rs.getInt(&quot;unique_users&quot;));</span>
					//Logger.debug(StatNewDB.class, &quot;Nastavujem: &quot; + Tools.formatDate(cal.getTime()));
<span class="fc" id="L1588">					dates.put(Tools.formatDate(cal.getTime()), data);</span>
					//Logger.debug(this,&quot;Data: &quot;+data[0]+&quot; &quot;+data[1]+&quot; &quot;+data[2]);
				}
<span class="fc" id="L1591">				rs.close();</span>
<span class="fc" id="L1592">				ps.close();</span>
<span class="fc" id="L1593">				db_conn.close();</span>
<span class="fc" id="L1594">				rs = null;</span>
<span class="fc" id="L1595">				ps = null;</span>
<span class="fc" id="L1596">				db_conn = null;</span>
			}
<span class="nc" id="L1598">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1600" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L1606" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L1607">						rs.close();</span>
<span class="pc bpc" id="L1608" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L1609">						ps.close();</span>
<span class="pc bpc" id="L1610" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L1611">						db_conn.close();</span>
				}
<span class="nc" id="L1613">				catch (Exception ex2)</span>
				{
<span class="nc" id="L1615">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L1616">				}</span>
			}
		}

		try
		{
			//Logger.debug(this,&quot;Hashtable: &quot;+dates.size()+ &quot;   Count: &quot;+count);

<span class="fc" id="L1624">			Calendar calTo = Calendar.getInstance();</span>
<span class="fc" id="L1625">			calTo.setFirstDayOfWeek(Calendar.MONDAY);</span>
<span class="fc" id="L1626">			calTo.setTime(to);</span>

<span class="fc" id="L1628">			cal.clear();</span>
<span class="fc" id="L1629">			cal.setFirstDayOfWeek(Calendar.MONDAY);</span>
<span class="fc" id="L1630">			cal.setTimeInMillis(from.getTime());</span>

			//Logger.debug(this,&quot;Date: &quot;+cal.getTime());

<span class="fc bfc" id="L1634" title="All 2 branches covered.">			while (cal.getTimeInMillis() &lt;= calTo.getTimeInMillis())</span>
			{
				//Logger.debug(StatNewDB.class, &quot;Ziskavam: &quot; + Tools.formatDate(cal.getTime()));
<span class="fc" id="L1637">				data = dates.get(Tools.formatDate(cal.getTime()));</span>
				//Logger.debug(this,&quot;Datum: &quot;+cal.getTime()+&quot;  Data: &quot;+dates.get(cal.getTime()));
<span class="fc bfc" id="L1639" title="All 2 branches covered.">				if (data != null)</span>
				{
<span class="fc" id="L1641">					col = new Column();</span>
<span class="fc" id="L1642">					col.setDateColumn1(cal.getTime());</span>
<span class="fc" id="L1643">					col.setIntColumn2(data[0].intValue());</span>
<span class="fc" id="L1644">					col.setIntColumn3(data[1].intValue());</span>
<span class="fc" id="L1645">					col.setIntColumn4(data[2].intValue());</span>
<span class="fc" id="L1646">					ret.add(col);</span>
				}
				else
				{
<span class="fc" id="L1650">					col = new Column();</span>
<span class="fc" id="L1651">					col.setDateColumn1(cal.getTime());</span>
<span class="fc" id="L1652">					col.setIntColumn2(0);</span>
<span class="fc" id="L1653">					col.setIntColumn3(0);</span>
<span class="fc" id="L1654">					col.setIntColumn4(0);</span>
<span class="fc" id="L1655">					ret.add(col);</span>
				}

<span class="fc" id="L1658">				cal.add(Calendar.DAY_OF_YEAR, 1);</span>
			}
		}
<span class="nc" id="L1661">		catch (Exception ex)</span>
		{
<span class="nc" id="L1663">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L1664">		}</span>

<span class="fc" id="L1666">		return (ret);</span>
	}

	/**
	 * Vrati statistiku podla hodin za dane obdobie
	 *
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @return
	 */
	public static List&lt;Column&gt; getHours(java.util.Date from, java.util.Date to, int rootGroupId)
	{
<span class="nc" id="L1679">		return getHours(from, to, String.valueOf(rootGroupId), false);</span>
	}

	public static List&lt;Column&gt; getHours(java.util.Date from, java.util.Date to, int rootGroupId, boolean withoutBots)
	{
<span class="fc" id="L1684">		return getHours(from, to, String.valueOf(rootGroupId), withoutBots);</span>
	}

	public static List&lt;Column&gt; getHours(java.util.Date from, java.util.Date to, String groupIds)
	{
<span class="nc" id="L1689">		return getHours(from, to, groupIds, false);</span>
	}

	/**
	 * Vrati statistiku podla hodin za dane obdobie
	 *
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @param groupIds
	 * @return
	 */
	public static List&lt;Column&gt; getHours(java.util.Date from, java.util.Date to, String groupIds, boolean withoutBots)
	{
<span class="fc" id="L1703">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1704">		int[][] data = new int[24][3];</span>
		int i;
		int j;

<span class="fc bfc" id="L1708" title="All 2 branches covered.">		for (i = 0; i &lt; 24; i++)</span>
		{
<span class="fc bfc" id="L1710" title="All 2 branches covered.">			for (j = 0; j &lt; 3; j++)</span>
			{
<span class="fc" id="L1712">				data[i][j] = 0;</span>
			}
		}

		Column col;

<span class="fc" id="L1718">		String whitelistedQuery = &quot;&quot;;</span>
<span class="pc bpc" id="L1719" title="1 of 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L1720">			whitelistedQuery = getWhiteListedUAQuery();</span>

<span class="fc" id="L1722">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L1723" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L1725">			Connection db_conn = null;</span>
<span class="fc" id="L1726">			PreparedStatement ps = null;</span>
<span class="fc" id="L1727">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L1730">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L1732">				String sql = &quot;SELECT &quot;+getDateSelect(&quot;hour&quot;, &quot;s.view_time&quot;, &quot;vt_hour&quot;)+&quot;, COUNT(s.doc_id) AS views, COUNT(DISTINCT s.session_id) AS sessions, COUNT(DISTINCT s.browser_id) AS unique_users&quot;;</span>

<span class="fc" id="L1734">				sql+=	&quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +</span>
						&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=?&quot;;

<span class="fc" id="L1737">				sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, groupIds);</span>
<span class="fc" id="L1738">				sql += whitelistedQuery;</span>

<span class="fc" id="L1740">				sql += &quot; GROUP BY &quot;+getDateGroupBy(&quot;hour&quot;, &quot;s.view_time&quot;, &quot;vt_hour&quot;);</span>
				//sql += &quot; ORDER BY  vt_hour&quot;;

				//Logger.debug(this,&quot;GetTopPages: &quot;+sql);
<span class="fc" id="L1744">				Logger.debug(StatNewDB.class, &quot;getHours sql: &quot;+sql);</span>

<span class="fc" id="L1746">				ps = prepareStatement(db_conn, sql);</span>
<span class="fc" id="L1747">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L1748">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="fc" id="L1750">				rs = ps.executeQuery();</span>
				//iteruj cez riadky

<span class="fc bfc" id="L1753" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L1755">					int vtHour = rs.getInt(&quot;vt_hour&quot;);</span>
<span class="pc bpc" id="L1756" title="2 of 4 branches missed.">					if (vtHour &gt;= 0 &amp;&amp; vtHour &lt; 24)</span>
					{
<span class="fc" id="L1758">						data[vtHour][0] = data[vtHour][0] + rs.getInt(&quot;views&quot;);</span>
<span class="fc" id="L1759">						data[vtHour][1] = data[vtHour][1] + rs.getInt(&quot;sessions&quot;);</span>
<span class="fc" id="L1760">						data[vtHour][2] = data[vtHour][2] + rs.getInt(&quot;unique_users&quot;);</span>
					}
<span class="fc" id="L1762">				}</span>
<span class="fc" id="L1763">				rs.close();</span>
<span class="fc" id="L1764">				ps.close();</span>
<span class="fc" id="L1765">				db_conn.close();</span>
<span class="fc" id="L1766">				rs = null;</span>
<span class="fc" id="L1767">				ps = null;</span>
<span class="fc" id="L1768">				db_conn = null;</span>
			}
<span class="nc" id="L1770">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1772" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L1778" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L1779">						rs.close();</span>
<span class="pc bpc" id="L1780" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L1781">						ps.close();</span>
<span class="pc bpc" id="L1782" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L1783">						db_conn.close();</span>
				}
<span class="nc" id="L1785">				catch (Exception ex2)</span>
				{
<span class="nc" id="L1787">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L1788">				}</span>
			}
		}

		try
		{
<span class="fc bfc" id="L1794" title="All 2 branches covered.">			for (i = 0; i &lt; 24; i++)</span>
			{
<span class="fc" id="L1796">				col = new Column();</span>
<span class="fc" id="L1797">				col.setIntColumn1(i);</span>
<span class="fc" id="L1798">				col.setIntColumn2(data[i][0]);</span>
<span class="fc" id="L1799">				col.setIntColumn3(data[i][1]);</span>
<span class="fc" id="L1800">				col.setIntColumn4(data[i][2]);</span>
<span class="fc" id="L1801">				ret.add(col);</span>
			}

		}
<span class="nc" id="L1805">		catch (Exception ex)</span>
		{
<span class="nc" id="L1807">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L1808">		}</span>

<span class="fc" id="L1810">		return (ret);</span>
	}

	/**
	 * Vrati statistiku podla dni za dane obdobie
	 *
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @return
	 */
	public static List&lt;Column&gt; getMonthViews(java.util.Date from, java.util.Date to, int rootGroupId)
	{
<span class="nc" id="L1823">		return getMonthViews(from, to, String.valueOf(rootGroupId), false);</span>
	}

	public static List&lt;Column&gt; getMonthViews(java.util.Date from, java.util.Date to, int rootGroupId, boolean withoutBots)
	{
<span class="fc" id="L1828">		return getMonthViews(from, to, String.valueOf(rootGroupId), withoutBots);</span>
	}

	public static List&lt;Column&gt; getMonthViews(java.util.Date from, java.util.Date to, String groupIds)
	{
<span class="nc" id="L1833">		return getMonthViews(from, to, groupIds, false);</span>
	}

	/**
	 * Vrati statistiku podla dni za dane obdobie
	 *
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @param groupIds - id adresarov oddelenych ciarkou
	 * @return
	 */
	public static List&lt;Column&gt; getMonthViews(java.util.Date from, java.util.Date to, String groupIds, boolean withoutBots)
	{
<span class="fc" id="L1847">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1848">		Map&lt;String, Integer[]&gt; dates = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L1850">		Calendar cal = Calendar.getInstance();</span>
		Column col;

<span class="fc" id="L1853">		String whitelistedQuery = &quot;&quot;;</span>
<span class="pc bpc" id="L1854" title="1 of 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L1855">			whitelistedQuery = getWhiteListedUAQuery();</span>

<span class="fc" id="L1857">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L1858" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L1860">			Connection db_conn = null;</span>
<span class="fc" id="L1861">			PreparedStatement ps = null;</span>
<span class="fc" id="L1862">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L1865">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L1867">				String sql = &quot;SELECT &quot;+getYMSelect(&quot;s.view_time&quot;)+&quot;, COUNT(s.doc_id) AS views, COUNT(DISTINCT s.session_id) AS sessions, COUNT(DISTINCT s.browser_id) AS unique_users&quot;;</span>

<span class="fc" id="L1869">				sql += &quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +</span>
						&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=? &quot;;

<span class="fc" id="L1872">				sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, groupIds);</span>
<span class="fc" id="L1873">				sql += whitelistedQuery;</span>

<span class="fc" id="L1875">				sql += &quot; GROUP BY &quot;+getYMGroupBy(&quot;s.view_time&quot;);</span>
				//sql += &quot; ORDER BY vt_year, vt_month&quot;;

<span class="fc" id="L1878">				Logger.debug(StatNewDB.class,&quot;getDayViews: &quot;+sql);</span>
<span class="fc" id="L1879">				cal.setTimeInMillis(from.getTime());</span>
<span class="fc" id="L1880">				cal.set(Calendar.DATE, 1);</span>

<span class="fc" id="L1882">				ps = prepareStatement(db_conn, sql);</span>
<span class="fc" id="L1883">				ps.setTimestamp(1, new Timestamp(cal.getTimeInMillis()));</span>

<span class="fc" id="L1885">				cal.setTimeInMillis(to.getTime());</span>
<span class="fc" id="L1886">				cal.set(Calendar.DATE, 1);</span>
<span class="fc" id="L1887">				cal.add(Calendar.MONTH, 1);</span>
<span class="fc" id="L1888">				cal.add(Calendar.DATE, -1);</span>

<span class="fc" id="L1890">				ps.setTimestamp(2, new Timestamp(cal.getTimeInMillis()));</span>

<span class="fc" id="L1892">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L1894" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L1896">					cal.clear();</span>
<span class="fc" id="L1897">					cal.setFirstDayOfWeek(Calendar.MONDAY);</span>
<span class="fc" id="L1898">					cal.set(Calendar.YEAR, rs.getInt(&quot;vt_year&quot;));</span>
<span class="fc" id="L1899">					cal.set(Calendar.MONTH, rs.getInt(&quot;vt_month&quot;)-1);</span>
<span class="fc" id="L1900">					cal.set(Calendar.DAY_OF_MONTH, 1);</span>

<span class="fc" id="L1902">					Integer[] data = new Integer[3];</span>
<span class="fc" id="L1903">					data[0] = Integer.valueOf(rs.getInt(&quot;views&quot;));</span>
<span class="fc" id="L1904">					data[1] = Integer.valueOf(rs.getInt(&quot;sessions&quot;));</span>
<span class="fc" id="L1905">					data[2] = Integer.valueOf(rs.getInt(&quot;unique_users&quot;));</span>
					//Logger.debug(StatNewDB.class, &quot;Nastavujem: &quot; + Tools.formatDate(cal.getTime()));

<span class="fc" id="L1908">					dates.put(cal.get(Calendar.MONTH)+&quot;.&quot;+cal.get(Calendar.YEAR) , data);</span>
					//Logger.debug(this,&quot;Data: &quot;+data[0]+&quot; &quot;+data[1]+&quot; &quot;+data[2]);
<span class="fc" id="L1910">				}</span>
<span class="fc" id="L1911">				rs.close();</span>
<span class="fc" id="L1912">				ps.close();</span>
<span class="fc" id="L1913">				db_conn.close();</span>
<span class="fc" id="L1914">				rs = null;</span>
<span class="fc" id="L1915">				ps = null;</span>
<span class="fc" id="L1916">				db_conn = null;</span>
			}
<span class="nc" id="L1918">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1920" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L1926" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L1927">						rs.close();</span>
<span class="pc bpc" id="L1928" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L1929">						ps.close();</span>
<span class="pc bpc" id="L1930" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L1931">						db_conn.close();</span>
				}
<span class="nc" id="L1933">				catch (Exception ex2)</span>
				{
<span class="nc" id="L1935">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L1936">				}</span>
			}
		}

		try
		{
			//Logger.debug(this,&quot;Hashtable: &quot;+dates.size()+ &quot;   Count: &quot;+count);

<span class="fc" id="L1944">			Calendar calTo = Calendar.getInstance();</span>
<span class="fc" id="L1945">			calTo.setFirstDayOfWeek(Calendar.MONDAY);</span>
<span class="fc" id="L1946">			calTo.setTime(to);</span>

<span class="fc" id="L1948">			cal.clear();</span>
<span class="fc" id="L1949">			cal.setFirstDayOfWeek(Calendar.MONDAY);</span>
<span class="fc" id="L1950">			cal.setTimeInMillis(from.getTime());</span>

			//Logger.debug(this,&quot;Date: &quot;+cal.getTime());

<span class="fc bfc" id="L1954" title="All 2 branches covered.">			while (cal.getTimeInMillis() &lt;= calTo.getTimeInMillis())</span>
			{
				//Logger.debug(StatNewDB.class, &quot;Ziskavam: &quot; + Tools.formatDate(cal.getTime()));
<span class="fc" id="L1957">				Integer[] data = dates.get(cal.get(Calendar.MONTH)+&quot;.&quot;+cal.get(Calendar.YEAR));</span>
				//Logger.debug(this,&quot;Datum: &quot;+cal.getTime()+&quot;  Data: &quot;+dates.get(cal.getTime()));
<span class="pc bpc" id="L1959" title="1 of 2 branches missed.">				if (data != null)</span>
				{
<span class="fc" id="L1961">					col = new Column();</span>
<span class="fc" id="L1962">					col.setDateColumn1(cal.getTime());</span>
<span class="fc" id="L1963">					col.setIntColumn1(cal.get(Calendar.YEAR));</span>
<span class="fc" id="L1964">					col.setIntColumn2(cal.get(Calendar.MONTH)+1);</span>
<span class="fc" id="L1965">					col.setIntColumn3(data[0].intValue());</span>
<span class="fc" id="L1966">					col.setIntColumn4(data[1].intValue());</span>
<span class="fc" id="L1967">					col.setIntColumn5(data[2].intValue());</span>
<span class="fc" id="L1968">					ret.add(col);</span>
				}
				else
				{
<span class="nc" id="L1972">					col = new Column();</span>
<span class="nc" id="L1973">					col.setDateColumn1(cal.getTime());</span>
<span class="nc" id="L1974">					col.setIntColumn1(cal.get(Calendar.YEAR));</span>
<span class="nc" id="L1975">					col.setIntColumn2(cal.get(Calendar.MONTH)+1);</span>
<span class="nc" id="L1976">					col.setIntColumn3(0);</span>
<span class="nc" id="L1977">					col.setIntColumn4(0);</span>
<span class="nc" id="L1978">					col.setIntColumn5(0);</span>
<span class="nc" id="L1979">					ret.add(col);</span>
				}

<span class="fc" id="L1982">				cal.add(Calendar.MONTH, 1);</span>
<span class="fc" id="L1983">			}</span>
		}
<span class="nc" id="L1985">		catch (Exception ex)</span>
		{
<span class="nc" id="L1987">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L1988">		}</span>

<span class="fc" id="L1990">		return (ret);</span>
	}


	/**
	 *
	 * @param from
	 * @param to
	 * @param maxResults
	 * @return
	 */
	public static List&lt;Column&gt; getStatReferer(java.util.Date from, java.util.Date to, int maxRows, String groupIdsQuery)
	{
<span class="pc bpc" id="L2003" title="1 of 2 branches missed.">		if (groupIdsQuery==null) groupIdsQuery = &quot;&quot;;</span>

<span class="fc" id="L2005">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

<span class="fc" id="L2007">		String[] suffixes = StatNewDB.getTableSuffix(&quot;stat_from&quot;, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L2008" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L2010">			Connection db_conn = null;</span>
<span class="fc" id="L2011">			PreparedStatement ps = null;</span>
<span class="fc" id="L2012">			ResultSet rs = null;</span>
			try
			{
				String sql;
<span class="fc" id="L2016">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L2018">				sql = &quot;SELECT referer_server_name, COUNT(referer_server_name) AS ref_views&quot; +</span>
			 			&quot; FROM stat_from&quot;+suffixes[s] +
						&quot; WHERE from_time&gt;=? AND from_time&lt;=? &quot; + groupIdsQuery +
						&quot; GROUP BY referer_server_name&quot; +
						&quot; ORDER BY ref_views DESC&quot;;

<span class="fc" id="L2024">				Logger.debug(StatNewDB.class,&quot;getStatReferer: &quot;+sql+&quot; start=&quot;+Tools.formatDateTime(from)+&quot; end=&quot;+Tools.formatDateTime(to));</span>

<span class="fc" id="L2026">				ps = prepareStatement(db_conn, sql);</span>
<span class="fc" id="L2027">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L2028">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="fc" id="L2030">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L2032" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L2034">					String key = ResponseUtils.filter(DB.getDbString(rs, &quot;referer_server_name&quot;));</span>
<span class="fc" id="L2035">					Number currentValue = map.get(key);</span>

<span class="pc bpc" id="L2037" title="1 of 2 branches missed.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;ref_views&quot;)));</span>
<span class="nc" id="L2038">					else map.put(key, Integer.valueOf(rs.getInt(&quot;ref_views&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L2039">				}</span>
<span class="fc" id="L2040">				rs.close();</span>
<span class="fc" id="L2041">				ps.close();</span>
<span class="fc" id="L2042">				db_conn.close();</span>
<span class="fc" id="L2043">				db_conn = null;</span>
<span class="fc" id="L2044">				rs = null;</span>
<span class="fc" id="L2045">				ps = null;</span>
			}
<span class="nc" id="L2047">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="pc bpc" id="L2050" title="1 of 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2051" title="1 of 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2052" title="1 of 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2053">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}

<span class="fc" id="L2057">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

		//je mozne, ze tam mame viac ako max zaznamov, upracme a povazujme to za &quot;ostatne&quot;
<span class="fc" id="L2060">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L2062">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L2064">		int i = 0;</span>
<span class="pc bpc" id="L2065" title="1 of 4 branches missed.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L2067">			me = iter.next();</span>
<span class="fc" id="L2068">			String key = me.getKey();</span>
<span class="fc" id="L2069">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getStatReferer: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L2073">			Column col = new Column();</span>
<span class="fc" id="L2074">			col.setColumn1(key);</span>
<span class="fc" id="L2075">			col.setColumn2(col.getColumn1());</span>
<span class="fc" id="L2076">			col.setIntColumn2(value.intValue());</span>

<span class="fc" id="L2078">			ret.add(col);</span>
<span class="fc" id="L2079">		}</span>

<span class="fc" id="L2081">		return (ret);</span>
	}

	/**
	 * Vrati pocet unikatnych pouzivatelov za stanovene obdobie z tab. stat_ views
	 *
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @return
	 */
	public static int getUniqueUsersFromStatViews(java.util.Date from, java.util.Date to, int rootGroupId)
	{
<span class="nc" id="L2094">		return getUniqueUsersFromStatViews(from, to, String.valueOf(rootGroupId), false);</span>
	}

	public static int getUniqueUsersFromStatViews(java.util.Date from, java.util.Date to, int rootGroupId, boolean withoutBots)
	{
<span class="nc" id="L2099">		return getUniqueUsersFromStatViews(from, to, String.valueOf(rootGroupId), withoutBots);</span>
	}

	public static int getUniqueUsersFromStatViews(java.util.Date from, java.util.Date to, String groupIds)
	{
<span class="nc" id="L2104">		return getUniqueUsersFromStatViews(from, to, groupIds, false);</span>
	}

	/**
	 * Vrati pocet unikatnych pouzivatelov za stanovene obdobie z tab. stat_ views
	 *
	 * @param from
	 * @param to
	 * @param rootGroupId
	 * @param groupIds
	 * @return
	 */
	public static int getUniqueUsersFromStatViews(java.util.Date from, java.util.Date to, String groupIds, boolean withoutBots)
	{
<span class="nc" id="L2118">		int ret = 0;</span>
<span class="nc" id="L2119">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L2120" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L2122">			Connection db_conn = null;</span>
<span class="nc" id="L2123">			PreparedStatement ps = null;</span>
<span class="nc" id="L2124">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L2127">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L2129">				String whitelistedQuery = &quot;&quot;;</span>
<span class="nc bnc" id="L2130" title="All 2 branches missed.">				if(withoutBots)</span>
<span class="nc" id="L2131">					whitelistedQuery = getWhiteListedUAQuery();</span>

<span class="nc" id="L2133">				String sql = &quot;SELECT COUNT(DISTINCT s.browser_id) AS unique_users&quot; +</span>
	 			&quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +
				&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=?&quot;;

<span class="nc" id="L2137">				sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, groupIds);</span>
<span class="nc" id="L2138">				sql += whitelistedQuery;</span>

<span class="nc" id="L2140">				Logger.debug(StatNewDB.class, &quot;getUniqueUsersFromStatViews sql:&quot;+sql);</span>

<span class="nc" id="L2142">				ps = prepareStatement(db_conn, sql);</span>
<span class="nc" id="L2143">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="nc" id="L2144">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
<span class="nc" id="L2145">				rs = ps.executeQuery();</span>

<span class="nc bnc" id="L2147" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L2149">					int uniq = rs.getInt(&quot;unique_users&quot;);</span>
<span class="nc" id="L2150">					ret += uniq;</span>
					//Logger.debug(StatNewDB.class, &quot;uniq=&quot;+uniq+&quot; ret=&quot;+ret);
<span class="nc" id="L2152">				}</span>
<span class="nc" id="L2153">				rs.close();</span>
<span class="nc" id="L2154">				ps.close();</span>
<span class="nc" id="L2155">				db_conn.close();</span>
<span class="nc" id="L2156">				rs = null;</span>
<span class="nc" id="L2157">				ps = null;</span>
<span class="nc" id="L2158">				db_conn = null;</span>
			}
<span class="nc" id="L2160">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L2162" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L2168" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L2169">						rs.close();</span>
<span class="nc bnc" id="L2170" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L2171">						ps.close();</span>
<span class="nc bnc" id="L2172" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L2173">						db_conn.close();</span>
				}
<span class="nc" id="L2175">				catch (Exception ex2)</span>
				{
<span class="nc" id="L2177">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L2178">				}</span>
			}
		}
<span class="nc" id="L2181">		return (ret);</span>
	}

	/**
	 * Vygeneruje pre zvolene docID tabulku videni, sedeni, roznych userov za zvolene obdobie
	 * podla TYZDNOV
	 *
	 * @param from
	 * @param to
	 * @param docId
	 * @return
	 */
	public static List&lt;Column&gt; getViewsForDoc(java.util.Date from, java.util.Date to, int docId)
	{
<span class="nc" id="L2195">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L2197" title="All 2 branches missed.">		if (docId &lt; 1) return ret;</span>

<span class="nc" id="L2199">		Map&lt;String, Column&gt; colTable = new Hashtable&lt;&gt;();</span>

<span class="nc" id="L2201">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L2202" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L2204">			Connection db_conn = null;</span>
<span class="nc" id="L2205">			PreparedStatement ps = null;</span>
<span class="nc" id="L2206">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L2209">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L2211">				String sql = &quot;SELECT &quot;+getYWSelect(&quot;s.view_time&quot;)+&quot;,COUNT(s.doc_id) AS views, COUNT(DISTINCT s.session_id) AS sessions, COUNT(DISTINCT s.browser_id) AS unique_users&quot;;</span>
<span class="nc" id="L2212">				sql +=&quot; FROM stat_views&quot;+suffixes[s]+&quot; s WHERE s.view_time&gt;=? AND s.view_time&lt;=? AND s.doc_id=?&quot;;</span>
<span class="nc" id="L2213">				sql += &quot; GROUP BY &quot;+getYWGroupBy(&quot;s.view_time&quot;)+&quot; ORDER BY  vt_year ASC, vt_week ASC&quot;;</span>

<span class="nc" id="L2215">				Logger.debug(StatNewDB.class, &quot;getViewsForDoc sql:&quot;+sql);</span>

<span class="nc" id="L2217">				ps = prepareStatement(db_conn, sql);</span>
<span class="nc" id="L2218">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="nc" id="L2219">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
<span class="nc" id="L2220">				ps.setInt(3, docId);</span>

<span class="nc" id="L2222">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
				Column col;

<span class="nc bnc" id="L2226" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L2228">					int year = rs.getInt(&quot;vt_year&quot;);</span>
<span class="nc" id="L2229">					int week = rs.getInt(&quot;vt_week&quot;);</span>

<span class="nc" id="L2231">					String key = year+&quot;-&quot;+week;</span>

<span class="nc" id="L2233">					col = colTable.get(key);</span>
<span class="nc bnc" id="L2234" title="All 2 branches missed.">					if (col == null)</span>
					{
<span class="nc" id="L2236">						col = new Column();</span>
<span class="nc" id="L2237">						col.setIntColumn1(year);</span>
<span class="nc" id="L2238">						col.setIntColumn2(week);</span>
<span class="nc" id="L2239">						col.setIntColumn3(rs.getInt(&quot;views&quot;));</span>
<span class="nc" id="L2240">						col.setIntColumn4(rs.getInt(&quot;sessions&quot;));</span>
<span class="nc" id="L2241">						col.setIntColumn5(rs.getInt(&quot;unique_users&quot;));</span>
<span class="nc" id="L2242">						ret.add(col);</span>
<span class="nc" id="L2243">						colTable.put(key, col);</span>
					}
					else
					{
<span class="nc" id="L2247">						col.setIntColumn3(col.getIntColumn3()+rs.getInt(&quot;views&quot;));</span>
<span class="nc" id="L2248">						col.setIntColumn4(col.getIntColumn4()+rs.getInt(&quot;sessions&quot;));</span>
<span class="nc" id="L2249">						col.setIntColumn5(col.getIntColumn5()+rs.getInt(&quot;unique_users&quot;));</span>
					}
<span class="nc" id="L2251">				}</span>
<span class="nc" id="L2252">				rs.close();</span>
<span class="nc" id="L2253">				ps.close();</span>
<span class="nc" id="L2254">				db_conn.close();</span>
<span class="nc" id="L2255">				rs = null;</span>
<span class="nc" id="L2256">				ps = null;</span>
<span class="nc" id="L2257">				db_conn = null;</span>
			}
<span class="nc" id="L2259">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L2261" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L2267" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L2268">						rs.close();</span>
<span class="nc bnc" id="L2269" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L2270">						ps.close();</span>
<span class="nc bnc" id="L2271" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L2272">						db_conn.close();</span>
				}
<span class="nc" id="L2274">				catch (Exception ex2)</span>
				{
<span class="nc" id="L2276">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L2277">				}</span>
			}
		}
<span class="nc" id="L2280">		return (ret);</span>
	}


	/**
	 * Vygeneruje pre zvolenu rootGroupID tabulku videni, sedeni, roznych userov za zvolene obdobie
	 *
	 * @param backInterval - pocet mesiacov spat, za ktore sa ma vygenerovat statistika
	 * @param rootGroupId
	 * @return
	 */
	public static List&lt;Column&gt; getMonthViewsForDoc(int backInterval, int docId)
	{
<span class="nc" id="L2293">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L2295">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L2296">		long to = cal.getTimeInMillis();</span>
<span class="nc" id="L2297">		cal.set(Calendar.DATE, 1);</span>
<span class="nc" id="L2298">		cal.set(Calendar.HOUR, 0);</span>
<span class="nc" id="L2299">		cal.set(Calendar.MINUTE, 0);</span>
<span class="nc" id="L2300">		cal.set(Calendar.SECOND, 0);</span>

<span class="nc" id="L2302">		cal.add(Calendar.MONTH, -backInterval);</span>
<span class="nc" id="L2303">		long from = cal.getTimeInMillis();</span>

		Column col;
<span class="nc" id="L2306">		Map&lt;String, Column&gt; colTable = new Hashtable&lt;&gt;();</span>

<span class="nc" id="L2308">		String[] suffixes = getTableSuffix(from, to);</span>
<span class="nc bnc" id="L2309" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L2311">			Connection db_conn = null;</span>
<span class="nc" id="L2312">			PreparedStatement ps = null;</span>
<span class="nc" id="L2313">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L2316">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L2318">				String sql = &quot;SELECT &quot;+getYMSelect(&quot;s.view_time&quot;)+&quot;, COUNT(s.doc_id) AS views, COUNT(DISTINCT s.session_id) AS sessions, COUNT(DISTINCT s.browser_id) AS unique_users&quot; +</span>
	 			&quot; FROM stat_views&quot;+suffixes[s]+&quot; s&quot; +
				&quot; WHERE s.view_time&gt;=? AND s.view_time&lt;=? AND s.doc_id=?&quot;;

<span class="nc" id="L2322">				sql += &quot; GROUP BY &quot;+getYMGroupBy(&quot;s.view_time&quot;)+&quot; ORDER BY  vt_year DESC, vt_month DESC&quot;;</span>

<span class="nc" id="L2324">				Logger.debug(StatNewDB.class, &quot;getMonthViewsForDoc sql:&quot;+sql);</span>

<span class="nc" id="L2326">				ps = prepareStatement(db_conn, sql);</span>
<span class="nc" id="L2327">				ps.setTimestamp(1, new Timestamp(cal.getTimeInMillis()));</span>
<span class="nc" id="L2328">				ps.setTimestamp(2, new Timestamp(Tools.getNow()));</span>
<span class="nc" id="L2329">				ps.setInt(3, docId);</span>

<span class="nc" id="L2331">				rs = ps.executeQuery();</span>
				//iteruj cez riadky

<span class="nc bnc" id="L2334" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L2336">					int month = rs.getInt(&quot;vt_month&quot;);</span>
<span class="nc" id="L2337">					int year = rs.getInt(&quot;vt_year&quot;);</span>
<span class="nc" id="L2338">					String key = year+&quot;-&quot;+month;</span>

<span class="nc" id="L2340">					col = new Column();</span>
<span class="nc" id="L2341">					col.setIntColumn1(year);</span>
<span class="nc" id="L2342">					col.setIntColumn2(month);</span>
<span class="nc" id="L2343">					col.setIntColumn3(rs.getInt(&quot;views&quot;));</span>
<span class="nc" id="L2344">					col.setIntColumn4(rs.getInt(&quot;sessions&quot;));</span>
<span class="nc" id="L2345">					col.setIntColumn5(rs.getInt(&quot;unique_users&quot;));</span>

<span class="nc" id="L2347">					colTable.put(key, col);</span>
<span class="nc" id="L2348">				}</span>
<span class="nc" id="L2349">				rs.close();</span>
<span class="nc" id="L2350">				ps.close();</span>
<span class="nc" id="L2351">				db_conn.close();</span>
<span class="nc" id="L2352">				rs = null;</span>
<span class="nc" id="L2353">				ps = null;</span>
<span class="nc" id="L2354">				db_conn = null;</span>
			}
<span class="nc" id="L2356">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L2358" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L2364" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L2365">						rs.close();</span>
<span class="nc bnc" id="L2366" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L2367">						ps.close();</span>
<span class="nc bnc" id="L2368" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L2369">						db_conn.close();</span>
				}
<span class="nc" id="L2371">				catch (Exception ex2)</span>
				{
<span class="nc" id="L2373">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L2374">				}</span>
			}
		}

		//vytvorime list a doplnime chybajuce (ak nejake su) mesiace
		try
		{
<span class="nc bnc" id="L2381" title="All 2 branches missed.">			while (cal.getTimeInMillis() &lt; to)</span>
			{
<span class="nc" id="L2383">				String key = cal.get(Calendar.YEAR)+&quot;-&quot;+(cal.get(Calendar.MONTH)+1);</span>
<span class="nc" id="L2384">				col = colTable.get(key);</span>

<span class="nc bnc" id="L2386" title="All 2 branches missed.">				if (col == null)</span>
				{
<span class="nc" id="L2388">					col = new Column();</span>
<span class="nc" id="L2389">					col.setIntColumn1(cal.get(Calendar.YEAR));</span>
<span class="nc" id="L2390">					col.setIntColumn2(cal.get(Calendar.MONTH)+1);</span>
<span class="nc" id="L2391">					col.setIntColumn3(0);</span>
<span class="nc" id="L2392">					col.setIntColumn4(0);</span>
<span class="nc" id="L2393">					col.setIntColumn5(0);</span>
				}

<span class="nc" id="L2396">				ret.add(col);</span>
<span class="nc" id="L2397">				cal.add(Calendar.MONTH, 1);</span>
<span class="nc" id="L2398">			}</span>
		}
<span class="nc" id="L2400">		catch (Exception ex)</span>
		{
<span class="nc" id="L2402">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L2403">		}</span>

<span class="nc" id="L2405">		return (ret);</span>
	}
	/**
	 * Vygeneruje pre zvolene docID tabulku kolko na dane docId prislo navstev z ktoreho docId
	 *
	 * @param docId
	 * @param from
	 * @param to
	 * @return
	 */
	public static List&lt;Column&gt; getIncomingStats(int docId, java.util.Date from, java.util.Date to, String groupIdsQuery, HttpServletRequest request)
	{
<span class="nc bnc" id="L2417" title="All 2 branches missed.">		if (groupIdsQuery==null) groupIdsQuery = &quot;&quot;;</span>

<span class="nc" id="L2419">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2420">		Map&lt;Integer, Column&gt; colTable = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L2421">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L2422">		DocDB docDB = DocDB.getInstance();</span>
<span class="nc" id="L2423">		Prop prop = Prop.getInstance(sk.iway.iwcm.Constants.getServletContext(), request);</span>

		DocDetails bdd;
<span class="nc" id="L2426">		int pocetPriamychPristupov = 0;</span>


		//najskor nacitaj priame pristupy
		if (true)
		{
			//v ife to mame, aby neboli problemy s nazvami premennych

<span class="nc" id="L2434">			Connection db_conn = null;</span>
<span class="nc" id="L2435">			PreparedStatement ps = null;</span>
<span class="nc" id="L2436">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L2439">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L2441">				String sql=&quot;SELECT count(doc_id) AS pocet, referer_server_name, referer_url FROM stat_from &quot;+</span>
				&quot;WHERE doc_id=? AND from_time &gt;= ? AND from_time &lt;= ? &quot; + groupIdsQuery +
				&quot;GROUP BY referer_server_name, referer_url &quot;+
				&quot;ORDER BY pocet desc&quot;;

<span class="nc" id="L2446">				Logger.debug(StatNewDB.class, &quot;getIncomingStats sql: &quot;+sql);</span>

<span class="nc" id="L2448">				ps = prepareStatement(db_conn, sql);</span>
<span class="nc" id="L2449">				ps.setInt(1,docId);</span>
<span class="nc" id="L2450">				ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="nc" id="L2451">				ps.setTimestamp(3, new Timestamp(to.getTime()));</span>
<span class="nc" id="L2452">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L2453" title="All 2 branches missed.">				while(rs.next())</span>
				{
<span class="nc" id="L2455">					Column col = new Column();</span>
<span class="nc" id="L2456">					col.setIntColumn2(rs.getInt(&quot;pocet&quot;));</span>
<span class="nc" id="L2457">					pocetPriamychPristupov+=col.getIntColumn2();</span>
<span class="nc" id="L2458">					col.setColumn1(rs.getString(&quot;referer_server_name&quot;)+rs.getString(&quot;referer_url&quot;));</span>
<span class="nc" id="L2459">					col.setColumn2(&quot;http://&quot;+col.getColumn1());</span>
<span class="nc" id="L2460">					ret.add(col);</span>
<span class="nc" id="L2461">				}</span>
<span class="nc" id="L2462">				rs.close();</span>
<span class="nc" id="L2463">				ps.close();</span>
<span class="nc" id="L2464">				db_conn.close();</span>
<span class="nc" id="L2465">				rs = null;</span>
<span class="nc" id="L2466">				ps = null;</span>
<span class="nc" id="L2467">				db_conn = null;</span>
			}
<span class="nc" id="L2469">			catch (Exception ex)</span>
			{
<span class="nc" id="L2471">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L2477" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L2478">						rs.close();</span>
<span class="nc bnc" id="L2479" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L2480">						ps.close();</span>
<span class="nc bnc" id="L2481" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L2482">						db_conn.close();</span>
				}
<span class="nc" id="L2484">				catch (Exception ex2)</span>
				{
<span class="nc" id="L2486">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L2487">				}</span>
			}
		}

		//nacitaj udaje statistiky
<span class="nc" id="L2492">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L2493" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L2495">			Connection db_conn = null;</span>
<span class="nc" id="L2496">			PreparedStatement ps = null;</span>
<span class="nc" id="L2497">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L2500">				db_conn = DBPool.getConnectionReadUncommited();</span>

<span class="nc" id="L2502">				String sql=&quot;SELECT count(doc_id) AS pocet, last_doc_id &quot;+</span>
				&quot;FROM stat_views&quot;+suffixes[s]+&quot; &quot;+
				&quot;WHERE doc_id=? AND view_time &gt;= ? AND view_time &lt;= ? &quot;+
				&quot;GROUP BY last_doc_id &quot;+
				&quot;ORDER BY pocet desc&quot;;

<span class="nc" id="L2508">				Logger.debug(StatNewDB.class, &quot;getIncomingStats sql: &quot;+sql);</span>

<span class="nc" id="L2510">				ps = prepareStatement(db_conn, sql);</span>
<span class="nc" id="L2511">				ps.setInt(1,docId);</span>
<span class="nc" id="L2512">				ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="nc" id="L2513">				ps.setTimestamp(3, new Timestamp(to.getTime()));</span>
<span class="nc" id="L2514">				rs = ps.executeQuery();</span>

<span class="nc bnc" id="L2516" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L2518">					int lastDocId=rs.getInt(&quot;last_doc_id&quot;);</span>
<span class="nc" id="L2519">					int pocet=rs.getInt(&quot;pocet&quot;);</span>

<span class="nc bnc" id="L2521" title="All 2 branches missed.">					if(lastDocId==-1)</span>
					{
<span class="nc" id="L2523">						pocet = pocet - pocetPriamychPristupov;</span>
					}

<span class="nc" id="L2526">					Column col = colTable.get(lastDocId);</span>
<span class="nc bnc" id="L2527" title="All 2 branches missed.">					if (col == null)</span>
					{
<span class="nc" id="L2529">						col = new Column();</span>
<span class="nc" id="L2530">						col.setIntColumn2(pocet);</span>

<span class="nc" id="L2532">						bdd = docDB.getBasicDocDetails(lastDocId, true);</span>
<span class="nc" id="L2533">						String title=groupsDB.getPath(bdd.getGroupId())+&quot;/&quot;+bdd.getTitle();</span>
<span class="nc" id="L2534">						col.setColumn1(title);</span>
<span class="nc bnc" id="L2535" title="All 2 branches missed.">						if(lastDocId==-1)</span>
						{
<span class="nc" id="L2537">							col.setColumn1(prop.getText(&quot;stat_doc.directAccess&quot;));</span>
						}
<span class="nc" id="L2539">						col.setColumn2(&quot;/apps/stat/admin/top-details/?docId=&quot;+lastDocId+&quot;&amp;title=&quot;+Tools.URLEncode(title));</span>
<span class="nc" id="L2540">						ret.add(col);</span>
<span class="nc" id="L2541">						colTable.put(lastDocId, col);</span>
<span class="nc" id="L2542">					}</span>
					else
					{
<span class="nc" id="L2545">						col.setIntColumn2(col.getIntColumn2()+pocet);</span>
					}
<span class="nc" id="L2547">				}</span>
<span class="nc" id="L2548">				rs.close();</span>
<span class="nc" id="L2549">				ps.close();</span>
<span class="nc" id="L2550">				db_conn.close();</span>
<span class="nc" id="L2551">				rs = null;</span>
<span class="nc" id="L2552">				ps = null;</span>
<span class="nc" id="L2553">				db_conn = null;</span>
			}
<span class="nc" id="L2555">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L2557" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L2563" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L2564">						rs.close();</span>
<span class="nc bnc" id="L2565" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L2566">						ps.close();</span>
<span class="nc bnc" id="L2567" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L2568">						db_conn.close();</span>
				}
<span class="nc" id="L2570">				catch (Exception ex2)</span>
				{
<span class="nc" id="L2572">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L2573">				}</span>
			}
		}

		//usporiadaj
<span class="nc" id="L2578">		Collections.sort(ret, new Comparator&lt;Column&gt;()</span>
<span class="nc" id="L2579">		{</span>
			@Override
			public int compare(Column c1, Column c2)
			{
<span class="nc" id="L2583">				return (c2.getIntColumn2() - c1.getIntColumn2());</span>
			}
		});

		//ak je tam nieco zaporne (vyradenie priamych pristupov) vyhod
<span class="nc" id="L2588">		List&lt;Column&gt; ret2 = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2589" title="All 2 branches missed.">		for (Column col : ret)</span>
		{
<span class="nc bnc" id="L2591" title="All 2 branches missed.">			if (col.getIntColumn2()&gt;0) ret2.add(col);</span>
<span class="nc" id="L2592">		}</span>

<span class="nc" id="L2594">		return (ret2);</span>
	}
	/**
	 * Vygeneruje pre zvolene docID tabulku kolko z docId navstev islo na ktore docId
	 *
	 * @param docId
	 * @param from
	 * @param to
	 * @return
	 */
	public static List&lt;Column&gt; getOutgoingStats(int docId, java.util.Date from, java.util.Date to)
	{
<span class="nc" id="L2606">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2607">		Map&lt;Integer, Column&gt; colTable = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L2608">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="nc" id="L2609">		DocDB docDB = DocDB.getInstance();</span>
		DocDetails bdd;
		Column col;

<span class="nc" id="L2613">		String[] suffixes = getTableSuffix(from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L2614" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L2616">			Connection db_conn = null;</span>
<span class="nc" id="L2617">			PreparedStatement ps = null;</span>
<span class="nc" id="L2618">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L2621">				db_conn = DBPool.getConnectionReadUncommited();</span>
<span class="nc" id="L2622">				String sql=&quot;SELECT count(last_doc_id) AS pocet, doc_id &quot;+</span>
				&quot;FROM stat_views&quot;+suffixes[s]+&quot; &quot;+
				&quot;WHERE last_doc_id= ? AND view_time &gt;= ? AND view_time &lt;= ? &quot;+
				&quot;GROUP BY doc_id &quot;+
				&quot;ORDER BY pocet desc&quot;;

<span class="nc" id="L2628">				Logger.debug(StatNewDB.class, &quot;getOutgoingStats sql: &quot;+sql);</span>

<span class="nc" id="L2630">				ps = prepareStatement(db_conn, sql);</span>
<span class="nc" id="L2631">				ps.setInt(1,docId);</span>
<span class="nc" id="L2632">				ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="nc" id="L2633">				ps.setTimestamp(3, new Timestamp(to.getTime()));</span>
<span class="nc" id="L2634">				rs = ps.executeQuery();</span>

<span class="nc bnc" id="L2636" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L2638">					int docId2 = rs.getInt(&quot;doc_id&quot;);</span>
<span class="nc" id="L2639">					col = colTable.get(docId2);</span>
<span class="nc bnc" id="L2640" title="All 2 branches missed.">					if (col == null)</span>
					{
<span class="nc" id="L2642">						col = new Column();</span>
<span class="nc" id="L2643">						col.setIntColumn2(rs.getInt(&quot;pocet&quot;));</span>
<span class="nc" id="L2644">						bdd = docDB.getBasicDocDetails(docId2, true);</span>
<span class="nc" id="L2645">						String title=groupsDB.getPath(bdd.getGroupId())+&quot;/&quot;+bdd.getTitle();</span>
<span class="nc" id="L2646">						col.setColumn1(title);</span>
<span class="nc" id="L2647">						col.setColumn2(&quot;/apps/stat/admin/top-details/?docId=&quot;+rs.getInt(&quot;doc_id&quot;)+&quot;&amp;title=&quot;+Tools.URLEncode(title));</span>
<span class="nc" id="L2648">						ret.add(col);</span>
<span class="nc" id="L2649">						colTable.put(docId2, col);</span>
<span class="nc" id="L2650">					}</span>
					else
					{
<span class="nc" id="L2653">						col.setIntColumn2(col.getIntColumn2()+rs.getInt(&quot;pocet&quot;));</span>
					}
<span class="nc" id="L2655">				}</span>
<span class="nc" id="L2656">				rs.close();</span>
<span class="nc" id="L2657">				ps.close();</span>
<span class="nc" id="L2658">				db_conn.close();</span>
<span class="nc" id="L2659">				rs = null;</span>
<span class="nc" id="L2660">				ps = null;</span>
<span class="nc" id="L2661">				db_conn = null;</span>
			}
<span class="nc" id="L2663">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L2665" title="All 2 branches missed.">				if (!createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L2671" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L2672">						rs.close();</span>
<span class="nc bnc" id="L2673" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L2674">						ps.close();</span>
<span class="nc bnc" id="L2675" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L2676">						db_conn.close();</span>
				}
<span class="nc" id="L2678">				catch (Exception ex2)</span>
				{
<span class="nc" id="L2680">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L2681">				}</span>
			}
		}

		//usporiadaj
<span class="nc" id="L2686">		Collections.sort(ret, new Comparator&lt;Column&gt;()</span>
<span class="nc" id="L2687">		{</span>
			@Override
			public int compare(Column c1, Column c2)
			{
<span class="nc" id="L2691">				return (c2.getIntColumn2() - c1.getIntColumn2());</span>
			}
		});

<span class="nc" id="L2695">		return (ret);</span>
	}

	/**
	 * Funkcia, ktora vrati zoznam vsetkych pristupov daneho registrovaneho pouzivatela zoradenych od najnovsieho po najstarsi.
	 * &lt;br /&gt; Zoznam obshauje identifikacne cislo prihlasenia (intColumn1), prehliadany dokument (column1), posledne prehliadany dokument (last_doc),
	 * nazov skupiny, do ktorej patri prehliadana stranka (column3) a cas pristupu (dateColumn1)
	 *
	 * @param from datetime, od ktoreho chceme vyhladavat zobrazenia stranok
	 * @param to datetime, do ktoreho chceme vyhladavat zobrazenia stranok
	 * @param rootGroupId identifikator skupiny, ktoru chceme filtrovat. Ak sa rovna -1, tak to znamena, ze chceme vyhladavat vo vsetkych skupinach
	 * @return List naplneny jednotlivymi zobrazeniami stranok pre urceneho registrovaneho pouzivatela s roznymi vlastnostami
	 */
	public static List&lt;Column&gt; getUserStatViews(int userId, java.util.Date from, java.util.Date to, int rootGroupId)
	{
<span class="nc" id="L2710">		Connection db_conn = null;</span>
<span class="nc" id="L2711">		PreparedStatement ps = null;</span>
<span class="nc" id="L2712">		ResultSet rs = null;</span>
		Column col;
<span class="nc" id="L2714">		List&lt;Column&gt; userStatViews = new ArrayList&lt;&gt;();</span>
		String sql;

<span class="nc" id="L2717">		String[] suffixes = StatNewDB.getTableSuffix(from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L2718" title="All 2 branches missed.">		for (int s = (suffixes.length-1); s &gt;= 0; s = s - 1)	// potrebujem opacne zoradene pole</span>
		{
<span class="nc" id="L2720">			sql = &quot;SELECT s.session_id AS session, documents.title AS doc, docs.title AS last_doc, groups.group_name, s.view_time &quot;;</span>
<span class="nc" id="L2721">			sql += &quot;FROM stat_views&quot; + suffixes[s] + &quot; s&quot;;</span>
<span class="nc" id="L2722">			sql += &quot; LEFT JOIN documents ON s.doc_id = documents.doc_id LEFT JOIN documents docs ON s.last_doc_id = docs.doc_id LEFT JOIN groups ON s.group_id = groups.group_id &quot;;</span>
<span class="nc" id="L2723">			sql += &quot;WHERE s.browser_id = ? AND s.view_time &gt;= ? AND s.view_time &lt;= ? &quot;;</span>
<span class="nc" id="L2724">			sql += StatDB.getRootGroupWhere(&quot;s.group_id&quot;, rootGroupId);</span>
<span class="nc" id="L2725">			sql += &quot; ORDER BY s.view_time DESC&quot;;</span>

<span class="nc" id="L2727">			Logger.debug(StatNewDB.class,&quot;getUserStatViews: &quot;+sql);</span>

			try
			{
<span class="nc" id="L2731">				db_conn = DBPool.getConnection();</span>
<span class="nc" id="L2732">				ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L2733">				ps.setInt(1, userId);</span>
<span class="nc" id="L2734">				ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="nc" id="L2735">				ps.setTimestamp(3, new Timestamp(to.getTime()));</span>

<span class="nc" id="L2737">				rs = ps.executeQuery();</span>
				//iteruj cez riadky

<span class="nc bnc" id="L2740" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L2742">					col = new Column();</span>

<span class="nc" id="L2744">					col.setColumn4(String.valueOf(rs.getLong(&quot;session&quot;)));</span>
<span class="nc" id="L2745">					col.setColumn1(rs.getString(&quot;doc&quot;));</span>
<span class="nc" id="L2746">					col.setColumn2(rs.getString(&quot;last_doc&quot;));</span>
<span class="nc" id="L2747">					col.setColumn3(rs.getString(&quot;group_name&quot;));</span>
<span class="nc" id="L2748">					col.setDateColumn1(rs.getTimestamp(&quot;view_time&quot;));</span>

<span class="nc" id="L2750">					userStatViews.add(col);</span>
				}
<span class="nc" id="L2752">				rs.close();</span>
<span class="nc" id="L2753">				ps.close();</span>
<span class="nc" id="L2754">				db_conn.close();</span>
<span class="nc" id="L2755">				rs = null;</span>
<span class="nc" id="L2756">				ps = null;</span>
<span class="nc" id="L2757">				db_conn = null;</span>
			}

<span class="nc" id="L2760">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L2762" title="All 2 branches missed.">				if (!StatNewDB.createStatTablesFromError(ex.getMessage(), suffixes[s])) sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L2768" title="All 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L2769">						rs.close();</span>
<span class="nc bnc" id="L2770" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L2771">						ps.close();</span>
<span class="nc bnc" id="L2772" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L2773">						db_conn.close();</span>
				}
<span class="nc" id="L2775">				catch (Exception ex2)</span>
				{
<span class="nc" id="L2777">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L2778">				}</span>
			}
		}

<span class="nc" id="L2782">		return (userStatViews);</span>
	}

	/**
	 * Grants SELECT, UPDATE, INSERT, DELETE on specified table to supplied username
	 * @param tableName name of table (ie stat_error)
	 * @param suffix suffix for partitioning (ie _2012_10) _YYYY_MM
	 * @param publicWebDbUserName name of user to whom will be granted priviledges
	 *
	 * @return true if grant was successful, otherwise false
	 *
	 * @throws IllegalArgumentException if suffix, tableName od udername is null
	 * @throws IllegalStateException if there is exception while granting permissions
	 *
	 */
	public static boolean grantRightsToUser(String tableName, String suffix, String publicWebDbUserName)
	{
<span class="nc bnc" id="L2799" title="All 2 branches missed.">		if (suffix == null)</span>
		{
<span class="nc" id="L2801">			throw new IllegalArgumentException(&quot;Suffix can't be null&quot;);</span>
		}
<span class="nc bnc" id="L2803" title="All 2 branches missed.">		if (tableName == null)</span>
		{
<span class="nc" id="L2805">			throw new IllegalArgumentException(&quot;tableName can't be null&quot;);</span>
		}
<span class="nc bnc" id="L2807" title="All 2 branches missed.">		if (publicWebDbUserName == null)</span>
		{
<span class="nc" id="L2809">			throw new IllegalArgumentException(&quot;publicWebDbUserName can't be null&quot;);</span>
		}
<span class="nc" id="L2811">		boolean ret = false;</span>
<span class="nc" id="L2812">		Logger.debug(StatNewDB.class, &quot;Granting rights on &quot; + tableName+suffix + &quot; to: &quot; + publicWebDbUserName);</span>
		try
		{
<span class="nc" id="L2815">			new SimpleQuery().execute(&quot;GRANT SELECT, UPDATE, INSERT, DELETE ON ? TO ?&quot; , tableName+suffix,publicWebDbUserName);</span>
<span class="nc" id="L2816">			Logger.debug(StatNewDB.class, &quot;Grant sucessfull&quot;);</span>
<span class="nc" id="L2817">			ret = true;</span>
		}
<span class="nc" id="L2819">		catch(IllegalStateException e)</span>
		{
<span class="nc" id="L2821">			Logger.debug(StatNewDB.class, &quot;Failed to grant permissions. Cause: &quot;+e.getMessage() );</span>
<span class="nc" id="L2822">		}</span>
<span class="nc" id="L2823">		return ret;</span>
	}

	/**
	 * Checks if there exists table with spacified name in DB
	 * method ignores case
	 * @param tablename name of the table
	 * @return true if table with specified name exists in DB
	 *
	 * @throws IllegalArgumentException if tablename is null or empty
	 */
	public static boolean tableExists(String tablename)
	{
<span class="pc bpc" id="L2836" title="1 of 2 branches missed.">		if(Tools.isEmpty(tablename))</span>
		{
<span class="nc" id="L2838">			throw new IllegalArgumentException(&quot;Parameter tablename can't be empty!&quot;);</span>
		}

<span class="fc" id="L2841">		Connection con = null;</span>
<span class="fc" id="L2842">		ResultSet res = null;</span>
<span class="fc" id="L2843">		boolean found = false;</span>
		try
		{
<span class="fc" id="L2846">			con = DBPool.getConnection();</span>
<span class="fc" id="L2847">			java.sql.DatabaseMetaData meta = con.getMetaData();</span>
<span class="fc" id="L2848">	      res = meta.getTables(null, null, null, new String[] {&quot;TABLE&quot;});</span>

<span class="pc bpc" id="L2850" title="1 of 2 branches missed.">	      while (res.next()) {</span>

<span class="fc bfc" id="L2852" title="All 2 branches covered.">	      	if(res.getString(&quot;TABLE_NAME&quot;).equalsIgnoreCase(tablename))</span>
	      	{
<span class="fc" id="L2854">	      		found = true;</span>
<span class="fc" id="L2855">	      		return found;</span>
	      	}
	      }
<span class="nc" id="L2858">	      res.close();</span>
<span class="nc" id="L2859">	      res=null;</span>
<span class="nc" id="L2860">			con.close();</span>
<span class="nc" id="L2861">			con = null;</span>
		}
<span class="nc" id="L2863">		catch (Exception ex)</span>
		{
<span class="nc" id="L2865">			IllegalStateException exception = new IllegalStateException(ex.getMessage());</span>
<span class="nc" id="L2866">			exception.initCause(ex);</span>
<span class="nc" id="L2867">			throw exception;</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L2873" title="1 of 2 branches missed.">				if (res != null)</span>
<span class="fc" id="L2874">					res.close();</span>
<span class="pc bpc" id="L2875" title="1 of 2 branches missed.">				if (con != null)</span>
<span class="fc" id="L2876">					con.close();</span>
			}
<span class="nc" id="L2878">			catch (Exception ex2)</span>
			{
<span class="fc" id="L2880">			}</span>
		}
<span class="nc" id="L2882">		return found;</span>
	}

	public static String amChartsData(Map&lt;String, Map&lt;Date, Number&gt;&gt; data)
	{
<span class="nc" id="L2887">		return amChartsData(data, false);</span>
	}

	public static String amChartsData(Map&lt;String, Map&lt;Date, Number&gt;&gt; data, boolean monitoring)
	{
<span class="nc" id="L2892">		String chartData = &quot;[]&quot;;</span>
<span class="nc bnc" id="L2893" title="All 4 branches missed.">		if(data!=null &amp;&amp; data.size()&gt;0)</span>
		{
<span class="nc" id="L2895">			Map&lt;Date, Number[]&gt; graph = new TreeMap&lt;&gt;();</span>

<span class="nc" id="L2897">			int i = 0;</span>
<span class="nc bnc" id="L2898" title="All 2 branches missed.">			for(Map.Entry&lt;String, Map&lt;Date, Number&gt;&gt; e : data.entrySet())</span>
			{
<span class="nc bnc" id="L2900" title="All 2 branches missed.">				for(Map.Entry&lt;Date, Number&gt; n : e.getValue().entrySet())</span>
				{
<span class="nc" id="L2902">					Date day = n.getKey();</span>

<span class="nc" id="L2904">					Number[] storedValues = graph.get(day);</span>
<span class="nc bnc" id="L2905" title="All 2 branches missed.">					if(storedValues == null)</span>
					{
<span class="nc" id="L2907">						Number[] newValues = new Number[data.size()];</span>
<span class="nc" id="L2908">						newValues[i] = n.getValue();</span>
<span class="nc" id="L2909">						graph.put(day, newValues);</span>
<span class="nc" id="L2910">					}</span>
					else
					{
<span class="nc" id="L2913">						storedValues[i] = n.getValue();</span>
<span class="nc" id="L2914">						graph.put(day, storedValues);</span>
					}
<span class="nc" id="L2916">				}</span>
<span class="nc" id="L2917">				i++;</span>
<span class="nc" id="L2918">			}</span>

<span class="nc" id="L2920">			chartData = &quot;[&quot;;</span>
<span class="nc bnc" id="L2921" title="All 2 branches missed.">			for(Map.Entry&lt;Date, Number[]&gt; e : graph.entrySet())</span>
			{
<span class="nc" id="L2923">				chartData += &quot;{\&quot;date\&quot;: \&quot;&quot;;</span>
<span class="nc bnc" id="L2924" title="All 2 branches missed.">				if(monitoring)</span>
<span class="nc" id="L2925">					chartData += Tools.formatDateTime(e.getKey());</span>
				else
<span class="nc" id="L2927">					chartData += Tools.formatDate(e.getKey());</span>
<span class="nc" id="L2928">				chartData += &quot;\&quot;&quot;;</span>

<span class="nc bnc" id="L2930" title="All 2 branches missed.">				for(int k=0; k&lt;e.getValue().length; k++)</span>
				{
<span class="nc bnc" id="L2932" title="All 2 branches missed.">					if(e.getValue()[k] != null)</span>
					{
<span class="nc" id="L2934">						chartData += &quot;,\&quot;value&quot; + k + &quot;\&quot;: &quot;;</span>
<span class="nc bnc" id="L2935" title="All 2 branches missed.">						if(monitoring)</span>
<span class="nc" id="L2936">							chartData += e.getValue()[k].intValue();</span>
						else
<span class="nc" id="L2938">							chartData += e.getValue()[k];</span>
					}
				}

<span class="nc" id="L2942">				chartData += &quot;},&quot;;</span>
<span class="nc" id="L2943">			}</span>
<span class="nc bnc" id="L2944" title="All 2 branches missed.">			if (chartData.endsWith(&quot;,&quot;)) chartData = chartData.substring(0, chartData.length()-1);</span>
<span class="nc" id="L2945">			chartData += &quot;]&quot;;</span>
		}

<span class="nc" id="L2948">		return chartData;</span>
	}

	/**
	 * vrati &quot; AND browser_ua_id IN [povolene prehliadace]&quot;, alebo prazdny string
	 *
	 * @return
	 */
	public static String getWhiteListedUAQuery()
	{
<span class="fc" id="L2958">		String cacheKey = &quot;statistika-getWhiteListedUAQuery&quot;;</span>
<span class="fc" id="L2959">		Object o = Cache.getInstance().getObject(cacheKey);</span>
<span class="fc bfc" id="L2960" title="All 2 branches covered.">		if(o != null)</span>
<span class="fc" id="L2961">			return (String) o;</span>

<span class="fc" id="L2963">		String result = &quot;&quot;;</span>
<span class="fc" id="L2964">		String whitelistQuery = &quot;&quot;;</span>

<span class="fc" id="L2966">		List&lt;String&gt; items = Arrays.asList(Constants.getString(&quot;whiteListedUA&quot;).split(&quot;\\s*,\\s*&quot;));</span>
		//List&lt;String&gt; items = Arrays.asList(&quot;chrome, firefox&quot;.split(&quot;\\s*,\\s*&quot;));
<span class="fc bfc" id="L2968" title="All 2 branches covered.">		for(int i=0; i&lt;items.size(); i++)</span>
		{
<span class="fc bfc" id="L2970" title="All 2 branches covered.">			if(i!=items.size()-1)</span>
<span class="fc" id="L2971">				whitelistQuery += &quot; &quot;+DB.fixAiCiCol(&quot;value&quot;)+&quot; LIKE ? OR &quot;;</span>
			else
<span class="fc" id="L2973">				whitelistQuery += &quot; &quot;+DB.fixAiCiCol(&quot;value&quot;)+&quot; LIKE ? &quot;;</span>
		}

<span class="fc" id="L2976">		Connection db_conn = null;</span>
<span class="fc" id="L2977">		PreparedStatement ps = null;</span>
<span class="fc" id="L2978">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L2981">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2982">			ps = db_conn.prepareStatement(&quot;SELECT stat_keys_id FROM stat_keys WHERE &quot; + whitelistQuery);</span>

<span class="fc bfc" id="L2984" title="All 2 branches covered.">			for(int i=0; i&lt;items.size(); i++)</span>
			{
<span class="fc" id="L2986">				ps.setString(i+1, &quot;%&quot;+DB.fixAiCiValue(items.get(i))+&quot;%&quot;);</span>
			}

<span class="fc" id="L2989">			rs = ps.executeQuery();</span>
<span class="fc" id="L2990">			result += &quot;( &quot;;</span>
<span class="fc" id="L2991">			boolean empty = true;</span>
<span class="fc bfc" id="L2992" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L2994">				empty = false;</span>
<span class="fc" id="L2995">				result += rs.getInt(&quot;stat_keys_id&quot;) + &quot;, &quot;;</span>
			}
<span class="pc bpc" id="L2997" title="1 of 2 branches missed.">			if(empty)</span>
<span class="nc" id="L2998">				result = &quot;&quot;;</span>
			else
			{
<span class="fc" id="L3001">				result = result.substring(0, result.length()-2);</span>
<span class="fc" id="L3002">				result += &quot; )&quot;;</span>
			}
<span class="fc" id="L3004">			rs.close();</span>
<span class="fc" id="L3005">			ps.close();</span>
<span class="fc" id="L3006">			db_conn.close();</span>
<span class="fc" id="L3007">			rs = null;</span>
<span class="fc" id="L3008">			ps = null;</span>
<span class="fc" id="L3009">			db_conn = null;</span>
		}
<span class="nc" id="L3011">		catch (Exception ex)</span>
		{
<span class="nc" id="L3013">			result = &quot;&quot;;</span>
<span class="nc" id="L3014">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L3020" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L3021">					rs.close();</span>
<span class="pc bpc" id="L3022" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L3023">					ps.close();</span>
<span class="pc bpc" id="L3024" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L3025">					db_conn.close();</span>
			}
<span class="nc" id="L3027">			catch (Exception ex2)</span>
			{
<span class="fc" id="L3029">			}</span>
		}

<span class="pc bpc" id="L3032" title="1 of 2 branches missed.">		if(Tools.isNotEmpty(result))</span>
<span class="fc" id="L3033">			result = &quot; AND browser_ua_id IN &quot; + result;</span>

<span class="fc" id="L3035">		Cache.getInstance().setObject(cacheKey, result, 1440);</span>
<span class="fc" id="L3036">		return result;</span>
	}
}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>