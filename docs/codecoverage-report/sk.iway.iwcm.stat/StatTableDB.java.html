<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StatTableDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.stat</a> &gt; <span class="el_source">StatTableDB.java</span></div><h1>StatTableDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.stat;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;

import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.InitServlet;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.i18n.Prop;

/**
 *
 *  StatTableDB.java
 *
 *@Title        WebJET
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2005
 *@author       $Author: jeeff $
 *@version      $Revision: 1.29 $
 *@created      Date: 10.12.2005 14:34:04
 */
public class StatTableDB {

<span class="nc" id="L40">	protected StatTableDB() {</span>
		//utility class
<span class="nc" id="L42">	}</span>

	public static List&lt;Column&gt; getCountry(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="nc" id="L46">		return getCountry( maxRows, from, to, groupIdsQuery, false);</span>
	}

	/**
	 *  statistika pristupov podla krajin usporiadana podla views
	 *
	 *@param  max_size  Description of the Parameter
	 *@param  from      Description of the Parameter
	 *@param  to        Description of the Parameter
	 *@return           The country value
	 */
	public static List&lt;Column&gt; getCountry(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery, boolean withoutBots)
	{
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">		if (groupIdsQuery == null)</span>
		{
<span class="nc" id="L61">			groupIdsQuery = &quot;&quot;;</span>
		}

<span class="fc" id="L64">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

<span class="fc" id="L66">		String whitelistedQuery = &quot;&quot;;</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L68">			whitelistedQuery = StatNewDB.getWhiteListedUAQuery();</span>

<span class="fc" id="L70">		String[] suffixes = StatNewDB.getTableSuffix(null, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L73">			Connection db_conn = null;</span>
<span class="fc" id="L74">			PreparedStatement ps = null;</span>
<span class="fc" id="L75">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L78">				String sql = &quot;SELECT DISTINCT country, count(country) as views FROM stat_views&quot;+suffixes[s]+&quot; WHERE view_time&gt;=? AND view_time&lt;? &quot; + groupIdsQuery + whitelistedQuery + &quot; GROUP BY country&quot;;</span>
<span class="fc" id="L79">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L80">				ps = StatNewDB.prepareStatement(db_conn, sql);</span>
<span class="fc" id="L81">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L82">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
<span class="fc" id="L83">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L85" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L87">					String key = rs.getString(&quot;country&quot;);</span>

<span class="pc bpc" id="L89" title="2 of 4 branches missed.">					if (key==null || &quot;unk&quot;.equals(key)) key = &quot;unkn&quot;;</span>

<span class="fc" id="L91">					Number currentValue = map.get(key);</span>

<span class="pc bpc" id="L93" title="1 of 2 branches missed.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;views&quot;)));</span>
<span class="nc" id="L94">					else map.put(key, Integer.valueOf(rs.getInt(&quot;views&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L95">				}</span>
<span class="fc" id="L96">				rs.close();</span>
<span class="fc" id="L97">				ps.close();</span>
<span class="fc" id="L98">				db_conn.close();</span>
<span class="fc" id="L99">				rs = null;</span>
<span class="fc" id="L100">				ps = null;</span>
<span class="fc" id="L101">				db_conn = null;</span>
			}
<span class="nc" id="L103">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L105" title="All 2 branches missed.">				if (ex.getMessage().indexOf(&quot;Invalid&quot;)==-1)</span>
				{
<span class="nc" id="L107">					sk.iway.iwcm.Logger.error(ex);</span>
				}
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L115">						rs.close();</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L117">						ps.close();</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L119">						db_conn.close();</span>
				}
<span class="nc" id="L121">				catch (Exception ex2)</span>
				{
<span class="nc" id="L123">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L124">				}</span>
			}
		}

<span class="fc" id="L128">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L130">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L132">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L134">		int i = 0;</span>
<span class="pc bpc" id="L135" title="1 of 4 branches missed.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L137">			me = iter.next();</span>
<span class="fc" id="L138">			String key = me.getKey();</span>
<span class="fc" id="L139">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getCountry: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L143">			Column col = new Column();</span>
<span class="fc" id="L144">			col.setColumn1(key);</span>
<span class="fc" id="L145">			col.setIntColumn2(value.intValue());</span>
<span class="fc" id="L146">			ret.add(col);</span>
<span class="fc" id="L147">		}</span>

<span class="fc" id="L149">		return (ret);</span>
	}

	public static List&lt;Column&gt; getNamedCountries(int max_size, java.util.Date from, java.util.Date to, String groupIdsQuery, String language)
	{
<span class="nc" id="L154">		return getNamedCountries(max_size, from, to, groupIdsQuery, language, false);</span>
	}

	/**
	 * The same as getCountry, except in country name terms.
	 * The countries are not returned as a top level domain codes, but rather as
	 * a localized country name. In case such a TLD is not recognized, or in case
	 * it is a generic TLD( .com, .net, .org, .info,...) the TLD is returned.
	 *
	 */

	public static List&lt;Column&gt; getNamedCountries(int max_size, java.util.Date from, java.util.Date to, String groupIdsQuery, String language, boolean withoutBots)
	{
<span class="fc" id="L167">		List&lt;Column&gt; ret = getCountry(max_size, from, to, groupIdsQuery, withoutBots);</span>
		//skus najst mapovanie TLD na nazov krajiny...ak sa nepodari, ponechaj povodnu
<span class="fc bfc" id="L169" title="All 2 branches covered.">		for (Column countryStatRow : ret)</span>
		{
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">			if (!(&quot;stat.countries.tld.&quot;+(countryStatRow).getColumn1()).     equals(Prop.getInstance(language).getText( &quot;stat.countries.tld.&quot;+(countryStatRow).getColumn1()) ))</span>
<span class="fc" id="L172">				(countryStatRow).setColumn1( Prop.getInstance(language).getText(&quot;stat.countries.tld.&quot;+(countryStatRow).getColumn1()) );</span>
<span class="fc" id="L173">		}</span>

<span class="fc" id="L175">		return ret;</span>
	}

	public static List&lt;Column&gt; getBrowser(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="nc" id="L180">		return getBrowser( maxRows, from, to, groupIdsQuery, false);</span>
	}

	/**
	 * Vrati zoznam prehliadacov a platforiem usporiadany podla poctu videni
	 * @param maxRows
	 * @param from
	 * @param to
	 * @param groupIdsQuery
	 * @return
	 */
	public static List&lt;Column&gt; getBrowser(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery, boolean withoutBots)
	{
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">		if (groupIdsQuery == null)</span>
		{
<span class="nc" id="L195">			groupIdsQuery = &quot;&quot;;</span>
		}

<span class="fc" id="L198">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

<span class="fc" id="L200">		String whitelistedQuery = &quot;&quot;;</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">		if(withoutBots)</span>
<span class="nc" id="L202">			whitelistedQuery = StatNewDB.getWhiteListedUAQuery();</span>

<span class="fc" id="L204">		String[] suffixes = StatNewDB.getTableSuffix(null, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L207">			Connection db_conn = null;</span>
<span class="fc" id="L208">			PreparedStatement ps = null;</span>
<span class="fc" id="L209">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L212">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L213">				String sql = &quot;SELECT DISTINCT browser_ua_id, platform_id, count(browser_ua_id) as views FROM stat_views&quot;+suffixes[s]+&quot; WHERE view_time&gt;=? AND view_time&lt;? &quot; + groupIdsQuery + whitelistedQuery + &quot; GROUP BY browser_ua_id, platform_id&quot;;</span>
<span class="fc" id="L214">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L215">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L216">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
<span class="fc" id="L217">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L219" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L221">					String key = rs.getInt(&quot;browser_ua_id&quot;)+&quot;;&quot;+rs.getInt(&quot;platform_id&quot;);</span>
<span class="fc" id="L222">					Number currentValue = map.get(key);</span>

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;views&quot;)));</span>
<span class="nc" id="L225">					else map.put(key, Integer.valueOf(rs.getInt(&quot;views&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L226">				}</span>
<span class="fc" id="L227">				rs.close();</span>
<span class="fc" id="L228">				ps.close();</span>
<span class="fc" id="L229">				db_conn.close();</span>
<span class="fc" id="L230">				db_conn = null;</span>
<span class="fc" id="L231">				rs = null;</span>
<span class="fc" id="L232">				ps = null;</span>
			}
<span class="nc" id="L234">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L240">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}

<span class="fc" id="L244">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L246">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L248">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L250">		int i = 0;</span>
<span class="pc bpc" id="L251" title="1 of 4 branches missed.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L253">			me = iter.next();</span>
<span class="fc" id="L254">			String key = me.getKey();</span>
<span class="fc" id="L255">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getBrowser: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L259">			Column col = new Column();</span>
<span class="fc" id="L260">			String[] values = key.split(&quot;;&quot;);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">			if (values.length==2)</span>
			{
<span class="fc" id="L263">				col.setIntColumn1(Tools.getIntValue(values[0], -1));</span>
<span class="fc" id="L264">				col.setColumn1(StatDB.getStatKeyValue(col.getIntColumn1()));</span>

<span class="fc" id="L266">				col.setIntColumn2(Tools.getIntValue(values[1], -1));</span>
<span class="fc" id="L267">				col.setColumn2(StatDB.getStatKeyValue(col.getIntColumn2()));</span>

<span class="fc" id="L269">				col.setIntColumn3(value.intValue());</span>
<span class="fc" id="L270">				ret.add(col);</span>
			}
<span class="fc" id="L272">		}</span>

<span class="fc" id="L274">		return (ret);</span>
	}


	/**
	 * Zoznam prihlaseni jednotlivych pouzivatelov zgrupenych podla pouzivatela.
	 * Dalej obsahuje zosumovane minuty jeho prihlasenia, scitane pocty prihlaseni a datum posledneho loginu.
	 *
	 * @param max_size	Maximalny pocet zaznamov, ktore sa vratia
	 * @param from			Datum, od ktoreho sa filtruju prihlasenia
	 * @param to			Datum, do ktoreho sa filtruju prihlasenia
	 *
	 * @return				Zoznam jednotlivych prihlaseni zgrupenych podla pouzivatela, ak sa citanie z databazy podari. Inak vrati prazdny zoznam.
	 */

	public static List&lt;Column&gt; getUsrlogon(int max_size, java.util.Date from, java.util.Date to)
	{
<span class="fc" id="L291">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L293">		Connection db_conn = null;</span>
<span class="fc" id="L294">		PreparedStatement ps = null;</span>
<span class="fc" id="L295">		ResultSet rs = null;</span>


<span class="fc" id="L298">		String sql = &quot;SELECT DISTINCT u.user_id, u.title as u_title, u.first_name, u.last_name, u.company, u.city, u.last_logon, u.is_admin, &quot; +</span>
		 				 &quot;sum(s.views) as views, sum(s.view_minutes) as view_minutes, count(s.views) as views_count &quot; +
		 				 &quot;FROM stat_userlogon s,  users u &quot; +
		 				 &quot;WHERE s.user_id = u.user_id AND s.logon_time &gt;= ? AND s.logon_time &lt;= ? &quot;;

<span class="pc bpc" id="L303" title="1 of 2 branches missed.">		if (InitServlet.isTypeCloud())</span>
		{
<span class="nc" id="L305">			sql += CloudToolsForCore.getDomainIdSqlWhere(true, &quot;u&quot;);</span>
		}

<span class="fc" id="L308">		sql += &quot;GROUP BY u.user_id, u.is_admin, u.title, u.first_name, u.last_name, u.company, u.city, u.last_logon &quot;;</span>
<span class="fc" id="L309">		sql+= &quot;ORDER BY u.is_admin DESC, view_minutes DESC&quot;;</span>

		try
		{
<span class="fc" id="L313">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L314">			ps = db_conn.prepareStatement(sql);</span>

<span class="fc" id="L316">			ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L317">			ps.setTimestamp(2, new Timestamp(to.getTime()));</span>

<span class="fc" id="L319">			rs = ps.executeQuery();</span>

			Column col;
<span class="fc" id="L322">			int count = 0;</span>
<span class="pc bpc" id="L323" title="1 of 4 branches missed.">			while (rs.next() &amp;&amp; count &lt; max_size)</span>
			{
<span class="fc" id="L325">				col = new Column();</span>

<span class="fc" id="L327">				col.setColumn1(Integer.toString(rs.getInt(&quot;user_id&quot;)));</span>
<span class="fc" id="L328">				col.setColumn2(DB.getFullName(rs));</span>
<span class="fc" id="L329">				col.setColumn3(DB.getDbString(rs, &quot;company&quot;));</span>
<span class="fc" id="L330">				col.setColumn4(DB.getDbString(rs, &quot;city&quot;));</span>
<span class="fc" id="L331">				col.setIntColumn5(rs.getInt(&quot;views_count&quot;));			// pocet novych prihlaseni. To su take, pri ktorych sa vytvorila nova session</span>
<span class="fc" id="L332">				col.setIntColumn6(rs.getInt(&quot;view_minutes&quot;));		// pocet minut, ktore bol pouzivatel prihlaseny</span>
<span class="fc" id="L333">				col.setIntColumn7(rs.getInt(&quot;views&quot;));					// pocet vsetkych prihlaseni, nielen tych pri ktorych sa vytvorila nova session</span>
<span class="fc" id="L334">				col.setDateColumn1(rs.getTimestamp(&quot;last_logon&quot;));</span>
<span class="fc" id="L335">				col.setColumn8(Integer.toString(rs.getInt(&quot;views&quot;)));</span>
<span class="fc" id="L336">				col.setBooleanColumn1(rs.getBoolean(&quot;is_admin&quot;));</span>

<span class="fc" id="L338">				ret.add(col);</span>
<span class="fc" id="L339">				count++;</span>
			}

<span class="fc" id="L342">			rs.close();</span>
<span class="fc" id="L343">			ps.close();</span>
<span class="fc" id="L344">			db_conn.close();</span>

<span class="fc" id="L346">			rs = null;</span>
<span class="fc" id="L347">			ps = null;</span>
<span class="fc" id="L348">			db_conn = null;</span>
		}
<span class="nc" id="L350">		catch (Exception ex)</span>
		{
<span class="nc" id="L352">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L359">					rs.close();</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L361">					ps.close();</span>
<span class="pc bpc" id="L362" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L363">					db_conn.close();</span>
			}
<span class="nc" id="L365">			catch (Exception ex2)</span>
			{
<span class="nc" id="L367">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L368">			}</span>
		}

<span class="fc" id="L371">		return (ret);</span>
	}

	/**
	 * Vrati zoznam prihlaseni pre daneho pouzivatela a pre dane casove obdobie
	 *
	 * @param max_size	Maximalny pocet zaznamov, ktore sa vratia. Aj ked select z tabulky ich vrati viac, system nacita iba maximalne max_size.
	 * @param userId		Identifikator pouzivatela, ktoreho zaznamy prihlaseni chceme ziskat.
	 * @param from			Zaciatok casoveho useku, od ktoreho chceme zaznamy prihlaseni.
	 * @param to			Koniec casoveho useku, do ktoreho chceme zaznamy prihlaseni.
	 *
	 * @return				Zoznam prihlaseni daneho pouzivatela s polozkami - cas prihlasenia(DateColumn1), pocet minut(IntColumn2) a meno pocitaca, z ktoreho sa prihlasil(hostname)
	 */
	public static List&lt;Column&gt; getUsrlogonDetails(int max_size, int userId, java.util.Date from, java.util.Date to)
	{
<span class="fc" id="L386">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L388">		Connection db_conn = null;</span>
<span class="fc" id="L389">		PreparedStatement ps = null;</span>
<span class="fc" id="L390">		ResultSet rs = null;</span>

<span class="fc" id="L392">		String sql = &quot;SELECT * FROM stat_userlogon WHERE user_id=? AND logon_time &gt;= ? AND logon_time &lt;= ? ORDER BY logon_time DESC&quot;;</span>

		try
		{
<span class="fc" id="L396">			db_conn = DBPool.getConnection();</span>

<span class="fc" id="L398">			ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L399">			ps.setInt(1, userId);</span>
<span class="fc" id="L400">			ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="fc" id="L401">			ps.setTimestamp(3, new Timestamp(to.getTime()));</span>

<span class="fc" id="L403">			rs = ps.executeQuery();</span>

			Column col;
<span class="fc" id="L406">			int count = 0;</span>
<span class="pc bpc" id="L407" title="1 of 4 branches missed.">			while (rs.next() &amp;&amp; count &lt; max_size)</span>
			{
<span class="fc" id="L409">				col = new Column();</span>
<span class="fc" id="L410">				col.setDateColumn1(rs.getTimestamp(&quot;logon_time&quot;));</span>
<span class="fc" id="L411">				col.setIntColumn2(rs.getInt(&quot;view_minutes&quot;));</span>
<span class="fc" id="L412">				col.setColumn3(DB.getDbString(rs, &quot;hostname&quot;));</span>

<span class="fc" id="L414">				ret.add(col);</span>
<span class="fc" id="L415">				count++;</span>
			}

<span class="fc" id="L418">			rs.close();</span>
<span class="fc" id="L419">			ps.close();</span>
<span class="fc" id="L420">			db_conn.close();</span>

<span class="fc" id="L422">			rs = null;</span>
<span class="fc" id="L423">			ps = null;</span>
<span class="fc" id="L424">			db_conn = null;</span>
		}
<span class="nc" id="L426">		catch (Exception ex)</span>
		{
<span class="nc" id="L428">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L435">					rs.close();</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L437">					ps.close();</span>
<span class="pc bpc" id="L438" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L439">					db_conn.close();</span>
			}
<span class="nc" id="L441">			catch (Exception ex2)</span>
			{
<span class="nc" id="L443">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L444">			}</span>
		}

<span class="fc" id="L447">		return (ret);</span>
	}

	/**
	 * Funkcia, ktora vrati chybne stranky ulozene v tabulke stat_error podla zadanych kriterii a parametrov
	 *
	 * @param max_size	maximalny pocet riadkov, ktore sa maju vratit
	 * @param from			datum, od ktoreho sa maju stranky filtrovat
	 * @param to			datum, do ktoreho sa maju stranky filtrovat
	 * @param url			cast Url, ktore obsahuje atribut url. Ak pouzivatel zada tento udaj, vyfiltruju sa vsetky stranky, ktore obsahuju zadanu url
	 *
	 * @return				Vrati sa zoznam stranok, ktore zodpovedaju filtrovacim parametrom, ak citanie z databazy prebehne v poriadku. Inak sa vrati prazdny zoznam.
	 */
	public static List&lt;Column&gt; getErrorPages(int max_size, java.util.Date from, java.util.Date to, String url) {
<span class="fc" id="L461">		return getErrorPages(max_size, from, to, url, null, null);</span>
	}

	public static List&lt;Column&gt; getErrorPages(int max_size, java.util.Date from, java.util.Date to, String url, String errorText, String countRange)
	{
<span class="fc" id="L466">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L468">		String[] suffixes = StatNewDB.getTableSuffix(&quot;stat_error&quot;, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L469" title="All 2 branches covered.">		for (int s=(suffixes.length-1); s&gt;=0; s--)</span>
		{

<span class="fc" id="L472">			Connection db_conn = null;</span>
<span class="fc" id="L473">			PreparedStatement ps = null;</span>
<span class="fc" id="L474">			ResultSet rs = null;</span>

<span class="fc" id="L476">			String sql = &quot;SELECT DISTINCT year, week, url, query_string, sum(count) as count FROM stat_error&quot;+suffixes[s]+&quot; &quot;;</span>
<span class="fc" id="L477">			sql += StatDB.getYearTimeSQL(from, to, true);</span>

<span class="fc" id="L479">			List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L480">			sql += DB.getSqlQueryDatatable(&quot;url&quot;, url, true, params);</span>
<span class="fc" id="L481">			sql += DB.getSqlQueryDatatable(&quot;query_string&quot;, errorText, true, params);</span>
<span class="fc" id="L482">			sql += DB.getSqlQueryDatatable(&quot;count&quot;, countRange, true, params);</span>

<span class="pc bpc" id="L484" title="2 of 4 branches missed.">			if (InitServlet.isTypeCloud() || Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;)==true)</span>
			{
<span class="fc" id="L486">				sql += &quot; AND (domain_id=0 OR domain_id=&quot;+CloudToolsForCore.getDomainId()+&quot;) &quot;;</span>
			}

<span class="fc" id="L489">			sql += &quot; GROUP BY url, year, week, query_string ORDER BY year DESC, week DESC, count DESC, url DESC, query_string DESC&quot;;</span>

<span class="fc" id="L491">			Logger.debug(StatTableDB.class, &quot;getErrorPages sql:&quot;+sql);</span>

			try
			{
<span class="fc" id="L495">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L496">				ps = db_conn.prepareStatement(sql);</span>

<span class="fc" id="L498">				int psCounter = 1;</span>
<span class="fc" id="L499">				psCounter = DB.getSqlParamsDatatable(params, ps, psCounter);</span>

<span class="fc" id="L501">				rs = ps.executeQuery();</span>

				Column col;
<span class="fc" id="L504">				int count = 0;</span>

<span class="pc bpc" id="L506" title="1 of 4 branches missed.">				while (rs.next() &amp;&amp; count &lt; max_size)</span>
				{
<span class="fc" id="L508">					col = new Column();</span>
<span class="fc" id="L509">					col.setIntColumn1(rs.getInt(&quot;year&quot;));</span>
<span class="fc" id="L510">					col.setIntColumn2(rs.getInt(&quot;week&quot;));</span>
<span class="fc" id="L511">					col.setColumn3(DB.getDbString(rs, &quot;url&quot;));</span>
<span class="fc" id="L512">					col.setColumn4(DB.getDbString(rs, &quot;query_string&quot;));</span>
<span class="fc" id="L513">					col.setIntColumn5(rs.getInt(&quot;count&quot;));</span>
<span class="fc" id="L514">					ret.add(col);</span>
<span class="fc" id="L515">					count++;</span>
				}

<span class="fc" id="L518">				rs.close();</span>
<span class="fc" id="L519">				ps.close();</span>
<span class="fc" id="L520">				db_conn.close();</span>

<span class="fc" id="L522">				rs = null;</span>
<span class="fc" id="L523">				ps = null;</span>
<span class="fc" id="L524">				db_conn = null;</span>
			}
<span class="nc" id="L526">			catch (Exception ex)</span>
			{
<span class="nc" id="L528">				logError(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L535">						rs.close();</span>
<span class="pc bpc" id="L536" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L537">						ps.close();</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L539">						db_conn.close();</span>
				}
<span class="nc" id="L541">				catch (Exception ex2)</span>
				{
<span class="nc" id="L543">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L544">				}</span>
			}
		}

<span class="fc" id="L548">		return (ret);</span>
	}

	public static List&lt;Column&gt; getSearchEnginesQuery(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="pc bpc" id="L553" title="1 of 2 branches missed.">		if (groupIdsQuery == null)</span>
<span class="nc" id="L554">			groupIdsQuery = &quot;&quot;;</span>

<span class="fc" id="L556">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

		String[] suffixes;
<span class="pc bpc" id="L559" title="2 of 4 branches missed.">		if (from != null &amp;&amp; to != null) suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="nc" id="L560">		else suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, 0, Tools.getNow());</span>

<span class="fc bfc" id="L562" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{

<span class="fc" id="L565">			Connection db_conn = null;</span>
<span class="fc" id="L566">			PreparedStatement ps = null;</span>
<span class="fc" id="L567">			ResultSet rs = null;</span>

			try
			{
<span class="fc" id="L571">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L572">				String sql = &quot;SELECT s.query, COUNT(s.query) AS total FROM stat_searchengine&quot;+suffixes[s]+&quot; s WHERE s.doc_id&gt;=0 &quot;;</span>
<span class="pc bpc" id="L573" title="2 of 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="fc" id="L575">				   sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>
				}
<span class="fc" id="L577">				sql += groupIdsQuery;</span>

<span class="pc bpc" id="L579" title="1 of 2 branches missed.">				if (sql.toLowerCase().indexOf(&quot;group by&quot;)==-1) sql += &quot;GROUP BY s.query&quot;;</span>

<span class="fc" id="L581">				ps = db_conn.prepareStatement(sql);</span>
<span class="pc bpc" id="L582" title="2 of 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="fc" id="L584">					ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="fc" id="L585">					ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
				}
<span class="fc" id="L587">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L589" title="All 2 branches covered.">				while (rs.next() )</span>
				{
<span class="fc" id="L591">					String key = DB.getDbString(rs, &quot;query&quot;);</span>
<span class="fc" id="L592">					Number currentValue = map.get(key);</span>

<span class="pc bpc" id="L594" title="1 of 2 branches missed.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;total&quot;)));</span>
<span class="nc" id="L595">					else map.put(key, Integer.valueOf(rs.getInt(&quot;total&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L596">				}</span>
<span class="fc" id="L597">				rs.close();</span>
<span class="fc" id="L598">				ps.close();</span>
<span class="fc" id="L599">				db_conn.close();</span>
<span class="fc" id="L600">				rs = null;</span>
<span class="fc" id="L601">				ps = null;</span>
<span class="fc" id="L602">				db_conn = null;</span>
			}
<span class="nc" id="L604">			catch (Exception ex)</span>
			{
<span class="nc" id="L606">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L613">						rs.close();</span>
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L615">						ps.close();</span>
<span class="pc bpc" id="L616" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L617">						db_conn.close();</span>
				}
<span class="nc" id="L619">				catch (Exception ex2)</span>
				{
<span class="nc" id="L621">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L622">				}</span>
			}
		}

<span class="fc" id="L626">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

		//je mozne, ze tam mame viac ako max zaznamov, upracme a povazujme to za &quot;ostatne&quot;
<span class="fc" id="L629">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L631">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L633">		int i = 0;</span>
<span class="fc bfc" id="L634" title="All 4 branches covered.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L636">			me = iter.next();</span>
<span class="fc" id="L637">			String key = me.getKey();</span>
<span class="fc" id="L638">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getSearchEnginesQuery: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L642">			Column col = new Column();</span>
<span class="fc" id="L643">			col.setColumn3(key);</span>
<span class="fc" id="L644">			col.setColumn2(col.getColumn3());</span>
<span class="fc" id="L645">			col.setIntColumn1(value.intValue());</span>

<span class="fc" id="L647">			ret.add(col);</span>
<span class="fc" id="L648">		}</span>

<span class="fc" id="L650">		return (ret);</span>

	}

	/**
	 *  statistika pristupov podla nazvu servera
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getSearchEnginesCount(int max_size, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="fc" id="L661">		return (StatTableDB.getSearchEnginesCount(max_size, from, to, groupIdsQuery, &quot;&quot;));</span>
	}

	/**
	 *  statistika pristupov podla nazvu servera
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getSearchEnginesCount(int maxRows, java.util.Date from, java.util.Date to, String groupIdsQuery, String seoKeyword)
	{
<span class="fc" id="L671">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

		String[] suffixes;
<span class="pc bpc" id="L674" title="2 of 4 branches missed.">		if (from != null &amp;&amp; to != null) suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="nc" id="L675">		else suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, 0, Tools.getNow());</span>
<span class="fc bfc" id="L676" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L678">			Connection db_conn = null;</span>
<span class="fc" id="L679">			PreparedStatement ps = null;</span>
<span class="fc" id="L680">			ResultSet rs = null;</span>

			try
			{
<span class="pc bpc" id="L684" title="1 of 2 branches missed.">				if (groupIdsQuery == null)</span>
<span class="nc" id="L685">					groupIdsQuery = &quot;&quot;;</span>

<span class="fc" id="L687">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L689">				String sql = &quot;SELECT server, COUNT(server) AS total FROM stat_searchengine&quot;+suffixes[s]+&quot; WHERE doc_id &gt;= 0 &quot; + groupIdsQuery;</span>

<span class="pc bpc" id="L691" title="2 of 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
<span class="fc" id="L692">				   sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>

<span class="pc bpc" id="L694" title="2 of 4 branches missed.">				if (seoKeyword != null &amp;&amp; Tools.isNotEmpty(seoKeyword))</span>
<span class="nc" id="L695">					sql += &quot; AND query = ? &quot;;</span>

<span class="fc" id="L697">				sql += &quot; GROUP BY server&quot;;</span>
<span class="fc" id="L698">				sql += &quot; ORDER BY total DESC&quot;;</span>

<span class="fc" id="L700">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L701">				int psCount = 1;</span>
<span class="pc bpc" id="L702" title="2 of 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="fc" id="L704">					ps.setTimestamp(psCount++, new Timestamp(from.getTime()));</span>
<span class="fc" id="L705">					ps.setTimestamp(psCount++, new Timestamp(to.getTime()));</span>
				}
<span class="pc bpc" id="L707" title="2 of 4 branches missed.">				if (seoKeyword != null &amp;&amp; Tools.isNotEmpty(seoKeyword))</span>
<span class="nc" id="L708">					ps.setString(psCount++, seoKeyword);</span>

<span class="fc" id="L710">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="fc bfc" id="L712" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L714">					String key = DB.prepareString(DB.getDbString(rs, &quot;server&quot;), 25);</span>
<span class="fc" id="L715">					Number currentValue = map.get(key);</span>

<span class="fc bfc" id="L717" title="All 2 branches covered.">					if (currentValue == null) map.put(key, Integer.valueOf(rs.getInt(&quot;total&quot;)));</span>
<span class="fc" id="L718">					else map.put(key, Integer.valueOf(rs.getInt(&quot;total&quot;)+currentValue.intValue()));</span>
<span class="fc" id="L719">				}</span>
<span class="fc" id="L720">				rs.close();</span>
<span class="fc" id="L721">				ps.close();</span>
<span class="fc" id="L722">				db_conn.close();</span>

<span class="fc" id="L724">				rs = null;</span>
<span class="fc" id="L725">				ps = null;</span>
<span class="fc" id="L726">				db_conn = null;</span>
			}
<span class="nc" id="L728">			catch (Exception ex)</span>
			{
<span class="nc" id="L730">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L736" title="1 of 2 branches missed.">					if (rs != null)</span>
<span class="nc" id="L737">						rs.close();</span>
<span class="pc bpc" id="L738" title="1 of 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L739">						ps.close();</span>
<span class="pc bpc" id="L740" title="1 of 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L741">						db_conn.close();</span>
				}
<span class="nc" id="L743">				catch (Exception ex2)</span>
				{
<span class="nc" id="L745">					sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L746">				}</span>
			}
		}

<span class="fc" id="L750">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L752">		map = StatDB.sortByValue(map);</span>

<span class="fc" id="L754">		Iterator&lt;Map.Entry&lt;String, Number&gt;&gt; iter = map.entrySet().iterator();</span>
		Map.Entry&lt;String, Number&gt; me;
<span class="fc" id="L756">		int i = 0;</span>
<span class="pc bpc" id="L757" title="1 of 4 branches missed.">		while (iter.hasNext() &amp;&amp; i++&lt;maxRows)</span>
		{
<span class="fc" id="L759">			me = iter.next();</span>
<span class="fc" id="L760">			String key = me.getKey();</span>
<span class="fc" id="L761">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getSearchEnginesCount: key=&quot;+key+&quot; value=&quot;+value);

<span class="fc" id="L765">			Column col = new Column();</span>
<span class="fc" id="L766">			col.setColumn1(key);</span>
<span class="fc" id="L767">			col.setColumn2(col.getColumn1());</span>
<span class="fc" id="L768">			col.setIntColumn2(value.intValue());</span>
<span class="fc" id="L769">			ret.add(col);</span>
<span class="fc" id="L770">		}</span>

<span class="fc" id="L772">		return (ret);</span>
	}

	/**
	 *	Vrati list, v ktorom budu ulozene bean s hodnotou datetime vyhladavania a pozicie
	 *
	 *	@param 	maxSize			maximalne kolko poslednych vyhladavani sa pouzije
	 *	@param	from				od ktoreho datumu vyberame zaznamy
	 *	@param	to					do ktoreho datumu vyberame zaznamy
	 *	@param	seoKeywordId	identifikator klucoveho slova, pre ktore chceme vyfiltrovat zaznamy
	 *
	 *	@return  List s beanmi, ktore obsahuju datetime vyhladavania a poziciu pre poslednych maxSize vyhladavani
	 */
	public static List&lt;Column&gt; getGooglePositionsList(int maxSize, java.util.Date from, java.util.Date to, int seoKeywordId)
	{
<span class="nc" id="L787">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L789">		Connection db_conn = null;</span>
<span class="nc" id="L790">		PreparedStatement ps = null;</span>
<span class="nc" id="L791">		ResultSet rs = null;</span>

		try
		{
<span class="nc" id="L795">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L797">			String sql = &quot;SELECT position, search_datetime FROM seo_google_position WHERE seo_google_position_id &gt;= 0 &quot;;</span>

<span class="nc bnc" id="L799" title="All 4 branches missed.">			if (from != null &amp;&amp; to != null)</span>
<span class="nc" id="L800">			   sql += &quot; AND search_datetime &gt;= ? AND search_datetime &lt;= ? &quot;;</span>

<span class="nc bnc" id="L802" title="All 2 branches missed.">			if (seoKeywordId != 0)</span>
<span class="nc" id="L803">				sql += &quot; AND keyword_id = ? &quot;;</span>

<span class="nc" id="L805">			sql += &quot; ORDER BY search_datetime DESC&quot;;</span>

<span class="nc" id="L807">			ps = db_conn.prepareStatement(sql);</span>

<span class="nc" id="L809">			int psCount = 1;</span>
<span class="nc bnc" id="L810" title="All 4 branches missed.">			if (from != null &amp;&amp; to != null)</span>
			{
<span class="nc" id="L812">				ps.setTimestamp(psCount++, new Timestamp(from.getTime()));</span>
<span class="nc" id="L813">				ps.setTimestamp(psCount++, new Timestamp(to.getTime()));</span>
			}
<span class="nc bnc" id="L815" title="All 2 branches missed.">			if (seoKeywordId != 0)</span>
<span class="nc" id="L816">				ps.setInt(psCount++, seoKeywordId);</span>

<span class="nc" id="L818">			rs = ps.executeQuery();</span>
			//iteruj cez riadky
			Column col;
<span class="nc" id="L821">			int count = 0;</span>
<span class="nc bnc" id="L822" title="All 4 branches missed.">			while (rs.next() &amp;&amp; count &lt; maxSize)</span>
			{
<span class="nc" id="L824">				col = new Column();</span>
<span class="nc" id="L825">				col.setDateColumn1(rs.getDate(&quot;search_datetime&quot;));</span>
<span class="nc" id="L826">				col.setIntColumn1(rs.getInt(&quot;position&quot;));</span>
<span class="nc" id="L827">				ret.add(col);</span>
<span class="nc" id="L828">				count++;</span>
			}

<span class="nc" id="L831">			rs.close();</span>
<span class="nc" id="L832">			ps.close();</span>
<span class="nc" id="L833">			db_conn.close();</span>

<span class="nc" id="L835">			rs = null;</span>
<span class="nc" id="L836">			ps = null;</span>
<span class="nc" id="L837">			db_conn = null;</span>
		}
<span class="nc" id="L839">		catch (Exception ex)</span>
		{
<span class="nc" id="L841">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L847" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L848">					rs.close();</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L850">					ps.close();</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L852">					db_conn.close();</span>
			}
<span class="nc" id="L854">			catch (Exception ex2)</span>
			{
<span class="nc" id="L856">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L857">			}</span>
		}

<span class="nc" id="L860">		return (ret);</span>
	}

	/**
	 *  zoznam vsetkych serverov pre docId
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getSearchEnginesNames(int docId, java.util.Date from, java.util.Date to, String groupIdsQuery)
	{
<span class="nc" id="L870">		List&lt;String&gt; map = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L872">		String[] suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="nc bnc" id="L873" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="nc" id="L875">			Connection db_conn = null;</span>
<span class="nc" id="L876">			PreparedStatement ps = null;</span>
<span class="nc" id="L877">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L880">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L882">				String sql = &quot;SELECT DISTINCT server FROM stat_searchengine&quot;+suffixes[s]+&quot; WHERE doc_id &gt;= 0 &quot; + groupIdsQuery;</span>

<span class="nc" id="L884">			   sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>

<span class="nc bnc" id="L886" title="All 2 branches missed.">				if(docId!=-1)</span>
<span class="nc" id="L887">					sql += &quot;AND doc_id = &quot;+docId;</span>

<span class="nc" id="L889">				sql += &quot; ORDER BY server&quot;;</span>

<span class="nc" id="L891">				ps = db_conn.prepareStatement(sql);</span>


<span class="nc" id="L894">				ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="nc" id="L895">				ps.setTimestamp(2, new Timestamp(to.getTime()));</span>


<span class="nc" id="L898">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L901">					String server = DB.getDbString(rs, &quot;server&quot;);</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">					if (map.contains(server)==false) map.add(server);</span>
<span class="nc" id="L903">				}</span>
<span class="nc" id="L904">				rs.close();</span>
<span class="nc" id="L905">				ps.close();</span>
<span class="nc" id="L906">				db_conn.close();</span>
<span class="nc" id="L907">				db_conn = null;</span>
<span class="nc" id="L908">				rs = null;</span>
<span class="nc" id="L909">				ps = null;</span>
			}
<span class="nc" id="L911">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="nc bnc" id="L914" title="All 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L917">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}

<span class="nc" id="L921">		Collections.sort(map);</span>

<span class="nc" id="L923">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">		for (String server : map)</span>
		{
<span class="nc" id="L926">			Column col = new Column();</span>
<span class="nc" id="L927">			col.setColumn1(server);</span>
<span class="nc" id="L928">			ret.add(col);</span>
<span class="nc" id="L929">		}</span>

<span class="nc" id="L931">		return (ret);</span>
	}
	/**
	 *  zoznam vsetkych docId a title k nim
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getSearchDocId(java.util.Date from, java.util.Date to, String server, String groupIdsQuery)
	{
<span class="nc" id="L940">		groupIdsQuery = Tools.replace(groupIdsQuery, &quot;group_id&quot;, &quot;s.group_id&quot;);</span>

<span class="nc" id="L942">		Map&lt;String, Number&gt; map = new HashMap&lt;&gt;();</span>

		String[] suffixes;
<span class="nc bnc" id="L945" title="All 4 branches missed.">		if (from != null &amp;&amp; to != null) suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="nc" id="L946">		else suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, 0, Tools.getNow());</span>

<span class="nc bnc" id="L948" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{

<span class="nc" id="L951">			Connection db_conn = null;</span>
<span class="nc" id="L952">			PreparedStatement ps = null;</span>
<span class="nc" id="L953">			ResultSet rs = null;</span>
			try
			{
<span class="nc" id="L956">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L958">				String sql = &quot;SELECT DISTINCT s.doc_id, d.title FROM stat_searchengine&quot;+suffixes[s]+&quot; s, documents d WHERE s.doc_id = d.doc_id &quot; + groupIdsQuery;</span>

<span class="nc bnc" id="L960" title="All 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="nc" id="L962">				   sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>
				}
<span class="nc bnc" id="L964" title="All 4 branches missed.">				if(server!=null&amp;&amp;!server.equals(&quot;&quot;))</span>
<span class="nc" id="L965">					sql += &quot;AND s.server = ? &quot;;</span>

<span class="nc" id="L967">				sql += &quot; ORDER BY d.title&quot;;</span>

<span class="nc" id="L969">				ps = db_conn.prepareStatement(sql);</span>

<span class="nc bnc" id="L971" title="All 4 branches missed.">				if (from != null &amp;&amp; to != null)</span>
				{
<span class="nc" id="L973">					ps.setTimestamp(1, new Timestamp(from.getTime()));</span>
<span class="nc" id="L974">					ps.setTimestamp(2, new Timestamp(to.getTime()));</span>
				}
<span class="nc bnc" id="L976" title="All 4 branches missed.">				if(server!=null&amp;&amp;!server.equals(&quot;&quot;))</span>
<span class="nc" id="L977">					ps.setString(3, server);</span>

<span class="nc" id="L979">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
<span class="nc bnc" id="L981" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L983">					String key = DB.getDbString(rs, &quot;title&quot;);</span>
<span class="nc" id="L984">					Number value = rs.getInt(&quot;doc_id&quot;);</span>

<span class="nc bnc" id="L986" title="All 2 branches missed.">					if (map.containsValue(value)==false) map.put(key, value);</span>
<span class="nc" id="L987">				}</span>
<span class="nc" id="L988">				rs.close();</span>
<span class="nc" id="L989">				ps.close();</span>
<span class="nc" id="L990">				db_conn.close();</span>
<span class="nc" id="L991">				db_conn = null;</span>
<span class="nc" id="L992">				rs = null;</span>
<span class="nc" id="L993">				ps = null;</span>
			}
<span class="nc" id="L995">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="nc bnc" id="L998" title="All 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="nc bnc" id="L999" title="All 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1000" title="All 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1001">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}

<span class="nc" id="L1005">		map = StatDB.sortByKey(map);</span>

<span class="nc" id="L1007">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1009">		Set&lt;Map.Entry&lt;String, Number&gt;&gt; set = map.entrySet();</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">		for (Map.Entry&lt;String, Number&gt; me : set){</span>
<span class="nc" id="L1011">			String key = me.getKey();</span>
<span class="nc" id="L1012">			Number value = me.getValue();</span>

			//Logger.debug(StatDB.class, &quot;getSearchDocId: key=&quot;+key+&quot; value=&quot;+value);

<span class="nc" id="L1016">			Column col = new Column();</span>
<span class="nc" id="L1017">			col.setColumn2(key);</span>
<span class="nc" id="L1018">			col.setColumn1(value.toString());</span>
<span class="nc" id="L1019">			col.setIntColumn1(value.intValue());</span>
<span class="nc" id="L1020">			ret.add(col);</span>
<span class="nc" id="L1021">		}</span>

<span class="nc" id="L1023">		return (ret);</span>
	}

	/**
	 * Funkcia, ktora vrati zoznam vsetkych existujucich docId a title k nim
	 *
	 *	@return   List s docId a title
	 */
	public static List&lt;Column&gt; getDocTitleId(String groupIdsQuery)
	{
<span class="nc" id="L1033">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1034">		Connection db_conn = null;</span>
<span class="nc" id="L1035">		PreparedStatement ps = null;</span>
<span class="nc" id="L1036">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L1039">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L1041">			String sql = &quot;SELECT doc_id, title FROM documents WHERE doc_id &gt; 0&quot; + groupIdsQuery;</span>

<span class="nc" id="L1043">			sql += &quot; ORDER BY title&quot;;</span>

<span class="nc" id="L1045">			ps = db_conn.prepareStatement(sql);</span>

<span class="nc" id="L1047">			rs = ps.executeQuery();</span>
			//iteruj cez riadky
			Column col;
<span class="nc bnc" id="L1050" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L1052">				col = new Column();</span>
<span class="nc" id="L1053">				col.setColumn2(DB.getDbString(rs, &quot;title&quot;));</span>
<span class="nc" id="L1054">				col.setColumn1(DB.getDbString(rs, &quot;doc_id&quot;));</span>
<span class="nc" id="L1055">				ret.add(col);</span>
			}
<span class="nc" id="L1057">			rs.close();</span>
<span class="nc" id="L1058">			ps.close();</span>
<span class="nc" id="L1059">			db_conn.close();</span>
<span class="nc" id="L1060">			db_conn = null;</span>
<span class="nc" id="L1061">			rs = null;</span>
<span class="nc" id="L1062">			ps = null;</span>
		}
<span class="nc" id="L1064">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1067" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1069" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1070">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1072">		return (ret);</span>
	}

	/**
	 *  zoznam vyhladavani pre danne query
	 *
	 *@return   List s nazvom servera a poctom pristupov
	 */
	public static List&lt;Column&gt; getQueries(java.util.Date from, java.util.Date to, String query)
	{
<span class="fc" id="L1082">		List&lt;Column&gt; ret = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L1084">		String[] suffixes = StatNewDB.getTableSuffix(&quot;stat_searchengine&quot;, from.getTime(), to.getTime());</span>
<span class="fc bfc" id="L1085" title="All 2 branches covered.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
<span class="fc" id="L1087">			Connection db_conn = null;</span>
<span class="fc" id="L1088">			PreparedStatement ps = null;</span>
<span class="fc" id="L1089">			ResultSet rs = null;</span>
			try
			{
<span class="fc" id="L1092">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L1094">				String sql = &quot;SELECT * FROM stat_searchengine&quot;+suffixes[s]+&quot; s WHERE &quot;+DB.fixAiCiCol(&quot;s.query&quot;)+&quot; = ?&quot;;</span>


<span class="fc" id="L1097">				sql += &quot; AND search_date &gt;= ? AND search_date &lt;= ? &quot;;</span>


<span class="fc" id="L1100">				sql += &quot;ORDER BY search_date ASC&quot;;</span>

<span class="fc" id="L1102">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L1103">				ps.setString(1, DB.fixAiCiValue(query));</span>

<span class="fc" id="L1105">				ps.setTimestamp(2, new Timestamp(from.getTime()));</span>
<span class="fc" id="L1106">				ps.setTimestamp(3, new Timestamp(to.getTime()));</span>


<span class="fc" id="L1109">				rs = ps.executeQuery();</span>
				//iteruj cez riadky
				Column col;
<span class="fc" id="L1112">				GroupsDB groupsDB = GroupsDB.getInstance();</span>
				int docId;
<span class="fc" id="L1114">				DocDB docDB = DocDB.getInstance();</span>
				DocDetails bdd;
<span class="fc bfc" id="L1116" title="All 2 branches covered.">				while (rs.next())</span>
				{
<span class="fc" id="L1118">					col = new Column();</span>

<span class="fc" id="L1120">					docId = rs.getInt(&quot;doc_id&quot;);</span>
<span class="fc" id="L1121">					bdd = docDB.getBasicDocDetails(docId, true);</span>
<span class="fc" id="L1122">					col.setDateColumn1(rs.getTimestamp(&quot;search_date&quot;));</span>
<span class="fc" id="L1123">					col.setColumn1(rs.getString(&quot;server&quot;));</span>
<span class="fc" id="L1124">					col.setColumn2(groupsDB.getPath(bdd.getGroupId())+&quot;/&quot;+bdd.getTitle());</span>
<span class="fc" id="L1125">					col.setColumn3(rs.getString(&quot;remote_host&quot;));</span>

<span class="fc" id="L1127">					ret.add(col);</span>

				}
<span class="fc" id="L1130">				rs.close();</span>
<span class="fc" id="L1131">				ps.close();</span>
<span class="fc" id="L1132">				db_conn.close();</span>
<span class="fc" id="L1133">				db_conn = null;</span>
<span class="fc" id="L1134">				rs = null;</span>
<span class="fc" id="L1135">				ps = null;</span>
			}
<span class="nc" id="L1137">			catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
			finally{
				try{
<span class="pc bpc" id="L1140" title="1 of 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="pc bpc" id="L1141" title="1 of 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="pc bpc" id="L1142" title="1 of 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L1143">				}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
			}
		}
<span class="fc" id="L1146">		return (ret);</span>
	}

	private static void logError(Exception ex) {
<span class="nc" id="L1150">		String message = ex.getMessage();</span>
<span class="nc bnc" id="L1151" title="All 6 branches missed.">		if (message.contains(&quot;Invalid object name&quot;) || message.contains(&quot;Invalid column name&quot;) || message.contains(&quot;ORA-00942&quot;) ||</span>
<span class="nc bnc" id="L1152" title="All 6 branches missed.">			message.contains(&quot;Unknown column&quot;) || message.contains(&quot;doesn't exist&quot;) || ex.getLocalizedMessage().contains(&quot;doesn't exist&quot;))</span>
		{
			//table doesn't exists, do not log error
		} else {
<span class="nc" id="L1156">			Logger.error(StatTableDB.class, ex);</span>
		}
<span class="nc" id="L1158">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>