<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShowDoc.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.doc</a> &gt; <span class="el_source">ShowDoc.java</span></div><h1>ShowDoc.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.doc;

import static sk.iway.iwcm.common.DocTools.testXss;

import java.io.File;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.Enumeration;
import java.util.List;
import java.util.StringTokenizer;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.commons.lang.StringUtils;

import net.sourceforge.stripes.controller.StripesConstants;
import net.sourceforge.stripes.util.CryptoUtil;
import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.InitServlet;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PageLng;
import sk.iway.iwcm.PathFilter;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.BlogTools;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.common.FileBrowserTools;
import sk.iway.iwcm.common.LogonTools;
import sk.iway.iwcm.components.response_header.rest.ResponseHeaderService;
import sk.iway.iwcm.doc.ninja.Amp;
import sk.iway.iwcm.doc.ninja.Ninja;
import sk.iway.iwcm.editor.service.WebpagesService;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.stat.BrowserDetector;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.ntlm.AuthenticationFilter;
import sk.iway.iwcm.system.spring.WebjetComponentParserInterface;
import sk.iway.iwcm.system.spring.events.WebjetEvent;
import sk.iway.iwcm.system.spring.events.WebjetEventType;
import sk.iway.iwcm.tags.CombineTag;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UserGroupsDB;
import sk.iway.iwcm.users.UsersDB;

@WebServlet(name = &quot;ShowDoc2&quot;,
            urlPatterns = {&quot;/showdoc.do&quot;}
            )
<span class="fc" id="L62">public class ShowDoc extends HttpServlet {</span>

    private static final long serialVersionUID = 1L;

    public static final String REMAP_STRING_START = &quot;!REMAP_PAGE(&quot;;
    public static final String REMAP_STRING_END = &quot;)!&quot;;

    /**
     * sem sa uklada hash o aktualnom userovi, kontroluje to ShowDocAction
     * (ak sa v url nachadza id pouzivatela pre jeho prihlasenie)
     */
<span class="fc" id="L73">    public static String ACTUAL_USER_HASH = null;</span>

    /**
     * Skontroluje, ci parametre neobsahuju naznaky XSS, ak ano,
     * vrati redirect na URL bez skodlivych parametrov
     * inak vrati null
     * @param request HttpServletRequest
     * @return String
     */
    public static String getXssRedirectUrl(HttpServletRequest request)
    {
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (!Constants.getBoolean(&quot;xssProtection&quot;)) {</span>
<span class="nc" id="L85">            return null;</span>
        }

        //umozni vypnut ochranu ak sa ide cez PreviewAction
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (&quot;true&quot;.equals(request.getAttribute(&quot;xssTestDisabled&quot;))) return null;</span>

        //skontroluj vynimky
<span class="fc" id="L92">        String constantName = &quot;xssProtectionStrictGetUrlException&quot;;</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (&quot;post&quot;.equalsIgnoreCase(request.getMethod())) constantName = &quot;xssProtectionStrictPostUrlException&quot;;</span>
<span class="fc" id="L94">        String path = PathFilter.getOrigPath(request);</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">        if (DocTools.isXssStrictUrlException(path, constantName)) return null;</span>

<span class="fc" id="L97">        boolean hasXss = false;</span>
<span class="fc" id="L98">        StringBuilder redirectUrl = new StringBuilder();</span>

<span class="fc" id="L100">        Enumeration&lt;String&gt; parameters = request.getParameterNames();</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">        while (parameters.hasMoreElements())</span>
        {
<span class="fc" id="L103">           String name = parameters.nextElement();</span>
<span class="pc bpc" id="L104" title="3 of 6 branches missed.">           if (testXss(name) || name.indexOf('&quot;')!=-1 || name.indexOf('\'')!=-1)</span>
           {
<span class="nc" id="L106">               hasXss = true;</span>
<span class="nc" id="L107">               continue;</span>
           }
<span class="fc" id="L109">           String[] values = request.getParameterValues(name);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">            for (String s : values) {</span>
<span class="fc" id="L111">                String value = s;</span>

                //robime este tu, aby sa nedalo nastavit do docid, ktore preskakujem
<span class="fc" id="L114">                boolean valueHasXss = testXss(value);</span>
                //podvrhnuty parameter _sourcePage=http://www.google.sk
<span class="pc bpc" id="L116" title="4 of 10 branches missed.">                if (!valueHasXss &amp;&amp; StripesConstants.URL_KEY_SOURCE_PAGE.equals(name) &amp;&amp; (Tools.isNotEmpty(value) &amp;&amp; CryptoUtil.decrypt(value) != null &amp;&amp; !CryptoUtil.decrypt(value).startsWith(&quot;/components/maybe&quot;)))</span>
<span class="nc" id="L117">                    valueHasXss = true;</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">                if (valueHasXss) hasXss = true;</span>

                //docid nam do URL netreba
<span class="pc bpc" id="L121" title="1 of 4 branches missed.">                if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML &amp;&amp; &quot;docid&quot;.equals(name)) continue;</span>

                //pridaj parameter do URL
<span class="fc bfc" id="L124" title="All 2 branches covered.">                if (redirectUrl.length() != 0) redirectUrl.append('&amp;');</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">                if (valueHasXss) {</span>
                    //hodnotu parametra vyhodime
<span class="nc" id="L127">                    redirectUrl.append(name).append('=');</span>
                } else {
                    //vyhadzujeme niektore value, napr. password a podobne, musi to byt contains, lebo v regforme to moze byt usr.password a podobne
                    //nechceme, aby to bolo potom vidno v access logoch a podobne
<span class="fc bfc" id="L131" title="All 8 branches covered.">                    if (name.contains(&quot;password&quot;) || name.contains(&quot;email&quot;) || name.contains(&quot;phone&quot;) || name.contains(&quot;login&quot;)) {</span>
<span class="fc" id="L132">                        value = &quot;&quot;;</span>
                    }

                    //pridame celu hodnotu parametra
<span class="fc" id="L136">                    redirectUrl.append(name).append('=').append(Tools.URLEncode(value));</span>
                }
            }
<span class="fc" id="L139">        }</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (hasXss)</span>
        {
<span class="nc" id="L142">            String redirUrl = PathFilter.getOrigPath(request) +&quot;?&quot;+ redirectUrl;</span>
<span class="nc" id="L143">            return Tools.sanitizeHttpHeaderParam(redirUrl);</span>
        }

<span class="fc" id="L146">        return null;</span>
    }

    /**
     *  aktualizuje kody v texte
     *
     *@param  user - identita pouzivatela
     *@param  text - text
     *@param  currentDocId - aktualne doc id
     *@param  request - aktualny request
     *@param  servletContext - ServletContext
     *@return String
     */
    public static String updateCodes(Identity user, String text, int currentDocId, HttpServletRequest request, ServletContext servletContext)
    {
<span class="fc" id="L161">        StringBuilder sb = new StringBuilder(text);</span>
<span class="fc" id="L162">        return DocTools.updateCodes(user, sb, currentDocId, request, servletContext).toString();</span>
    }

    /**
     * Nastavi do requestu rozne hodnoty z docDetails objektu (okrem data)
     * @param doc DocDetails
     * @param group GroupDetails
     * @param docDB DocDB
     * @param groupsDB GroupsDB
     * @param request HttpServletRequest
     */
    public static void setRequestData(DocDetails doc, GroupDetails group, DocDB docDB, GroupsDB groupsDB, HttpServletRequest request)
    {
<span class="fc" id="L175">        request.setAttribute(&quot;docDetails&quot;, doc);</span>

<span class="fc" id="L177">        RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">        if(rb != null) {</span>
<span class="fc" id="L179">            rb.setDocId(doc.getDocId());</span>
<span class="fc" id="L180">            rb.setGroupId(doc.getGroupId());</span>
        }

<span class="fc" id="L183">        request.setAttribute(&quot;group_id&quot;, Integer.toString(doc.getGroupId()));</span>

<span class="fc" id="L185">        request.setAttribute(&quot;author_id&quot;, Integer.toString(doc.getAuthorId()));</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        if (!Constants.getBoolean(&quot;docAuthorLazyLoad&quot;))</span>
        {
<span class="fc" id="L188">            request.setAttribute(&quot;author_name&quot;, doc.getAuthorName());</span>
<span class="fc" id="L189">            request.setAttribute(&quot;author_email&quot;, doc.getAuthorEmail());</span>
<span class="fc" id="L190">            request.setAttribute(&quot;doc_author_name&quot;, doc.getAuthorName());</span>
        }

<span class="fc" id="L193">        request.setAttribute(&quot;doc_id&quot;, doc.getDocId());</span>
<span class="fc" id="L194">        request.setAttribute(&quot;doc_title&quot;, doc.getTitle());</span>
<span class="fc" id="L195">        request.setAttribute(&quot;doc_title_original&quot;, doc.getTitle());</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;docTitleIncludePath&quot;))</span>
        {
<span class="nc" id="L198">            request.setAttribute(&quot;doc_title&quot;, DocDB.getTitleWithPath(doc));</span>
        }
<span class="fc" id="L200">        request.setAttribute(&quot;doc_navbar&quot;, doc.getNavbar());</span>
<span class="fc" id="L201">        request.setAttribute(&quot;html_head&quot;, doc.getHtmlHead());</span>
<span class="fc" id="L202">        request.setAttribute(&quot;html_data&quot;, doc.getHtmlData());</span>
<span class="fc" id="L203">        request.setAttribute(&quot;perex_data&quot;, doc.getPerex());</span>
<span class="fc" id="L204">        request.setAttribute(&quot;perex_pre&quot;, doc.getPerexPre());</span>
<span class="fc" id="L205">        request.setAttribute(&quot;perex_place&quot;, doc.getPerexPlace());</span>
<span class="fc" id="L206">        request.setAttribute(&quot;perex_image&quot;, doc.getPerexImage());</span>

<span class="pc bpc" id="L208" title="1 of 4 branches missed.">        if (doc.getPublishStartString() != null &amp;&amp; doc.getPublishStartString().length() &gt; 1)</span>
        {
<span class="fc" id="L210">            request.setAttribute(&quot;doc_publish_start&quot;, doc.getPublishStartString());</span>
        }
<span class="pc bpc" id="L212" title="1 of 4 branches missed.">        if (doc.getPublishStartTimeString() != null &amp;&amp; doc.getPublishStartTimeString().length() &gt; 1)</span>
        {
<span class="fc" id="L214">            request.setAttribute(&quot;doc_publish_start_time&quot;, doc.getPublishStartTimeString());</span>
        }
<span class="pc bpc" id="L216" title="1 of 4 branches missed.">        if (doc.getPublishEndString() != null &amp;&amp; doc.getPublishEndString().length() &gt; 1)</span>
        {
<span class="fc" id="L218">            request.setAttribute(&quot;doc_publish_end&quot;, doc.getPublishEndString());</span>
        }
<span class="pc bpc" id="L220" title="1 of 4 branches missed.">        if (doc.getPublishEndTimeString() != null &amp;&amp; doc.getPublishEndTimeString().length() &gt; 1)</span>
        {
<span class="fc" id="L222">            request.setAttribute(&quot;doc_publish_end_time&quot;, doc.getPublishEndTimeString());</span>
        }
<span class="pc bpc" id="L224" title="1 of 4 branches missed.">        if (doc.getDateCreatedString() != null &amp;&amp; doc.getDateCreatedString().length() &gt; 1)</span>
        {
<span class="fc" id="L226">            request.setAttribute(&quot;doc_date_created&quot;, doc.getDateCreatedString());</span>
        }
<span class="pc bpc" id="L228" title="1 of 4 branches missed.">        if (doc.getTimeCreatedString() != null &amp;&amp; doc.getTimeCreatedString().length() &gt; 1)</span>
        {
<span class="fc" id="L230">            request.setAttribute(&quot;doc_time_created&quot;, doc.getTimeCreatedString());</span>
        }
<span class="pc bpc" id="L232" title="1 of 4 branches missed.">        if (doc.getEventDateString() != null &amp;&amp; doc.getEventDateString().length() &gt; 1)</span>
        {
<span class="fc" id="L234">            request.setAttribute(&quot;doc_event_date&quot;, doc.getEventDateString());</span>
        }
<span class="pc bpc" id="L236" title="1 of 4 branches missed.">        if (doc.getEventTimeString() != null &amp;&amp; doc.getEventTimeString().length() &gt; 1)</span>
        {
<span class="fc" id="L238">            request.setAttribute(&quot;doc_event_time&quot;, doc.getEventTimeString());</span>
        }

<span class="fc" id="L241">        request.setAttribute(&quot;doc_temp_id&quot;, doc.getTempId());</span>

<span class="fc" id="L243">        request.setAttribute(&quot;field_a&quot;, doc.getFieldA());</span>
<span class="fc" id="L244">        request.setAttribute(&quot;field_b&quot;, doc.getFieldB());</span>
<span class="fc" id="L245">        request.setAttribute(&quot;field_c&quot;, doc.getFieldC());</span>
<span class="fc" id="L246">        request.setAttribute(&quot;field_d&quot;, doc.getFieldD());</span>
<span class="fc" id="L247">        request.setAttribute(&quot;field_e&quot;, doc.getFieldE());</span>
<span class="fc" id="L248">        request.setAttribute(&quot;field_f&quot;, doc.getFieldF());</span>
<span class="fc" id="L249">        request.setAttribute(&quot;field_g&quot;, doc.getFieldG());</span>
<span class="fc" id="L250">        request.setAttribute(&quot;field_h&quot;, doc.getFieldH());</span>
<span class="fc" id="L251">        request.setAttribute(&quot;field_i&quot;, doc.getFieldI());</span>
<span class="fc" id="L252">        request.setAttribute(&quot;field_j&quot;, doc.getFieldJ());</span>
<span class="fc" id="L253">        request.setAttribute(&quot;field_k&quot;, doc.getFieldK());</span>
<span class="fc" id="L254">        request.setAttribute(&quot;field_l&quot;, doc.getFieldL());</span>
<span class="fc" id="L255">        request.setAttribute(&quot;forum_count&quot;, doc.getForumCount());</span>

<span class="fc" id="L257">        request.setAttribute(&quot;field_m&quot;, doc.getFieldM());</span>
<span class="fc" id="L258">        request.setAttribute(&quot;field_n&quot;, doc.getFieldN());</span>
<span class="fc" id="L259">        request.setAttribute(&quot;field_o&quot;, doc.getFieldO());</span>
<span class="fc" id="L260">        request.setAttribute(&quot;field_p&quot;, doc.getFieldP());</span>
<span class="fc" id="L261">        request.setAttribute(&quot;field_q&quot;, doc.getFieldQ());</span>
<span class="fc" id="L262">        request.setAttribute(&quot;field_r&quot;, doc.getFieldR());</span>
<span class="fc" id="L263">        request.setAttribute(&quot;field_s&quot;, doc.getFieldS());</span>
<span class="fc" id="L264">        request.setAttribute(&quot;field_t&quot;, doc.getFieldT());</span>

        //set navbar
<span class="fc" id="L267">        String navbar = doc.getNavbar();</span>
        String navbar2;
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (&quot;rdf&quot;.equalsIgnoreCase(Constants.getString(&quot;navbarDefaultType&quot;)))</span>
        {
<span class="nc" id="L271">            navbar2 = groupsDB.getNavbarRDF(doc.getGroupId(), doc.getDocId(), request.getSession());</span>
        }
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">        else if (&quot;schema.org&quot;.equalsIgnoreCase(Constants.getString(&quot;navbarDefaultType&quot;)))</span>
        {
<span class="nc" id="L275">            navbar2 = groupsDB.getNavbarSchema(doc.getGroupId(), doc.getDocId(), request.getSession());</span>
        }
        else
        {
<span class="fc" id="L279">            navbar2 = groupsDB.getNavbar(doc.getGroupId(), doc.getDocId(), request.getSession());</span>
        }
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (navbar2.length() &gt; 2)</span>
        {
<span class="fc" id="L283">            navbar = navbar2;</span>
            //ak to nie je default doc pre grupu tak sprav linku
<span class="fc bfc" id="L285" title="All 2 branches covered.">            if (doc.getDocId() != group.getDefaultDocId())</span>
            {
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">                if (doc.getNavbar().length() &gt; 2)</span>
                {
<span class="pc bpc" id="L289" title="3 of 4 branches missed.">                    if (&quot;rdf&quot;.equalsIgnoreCase(Constants.getString(&quot;navbarDefaultType&quot;)) &amp;&amp; navbar.contains(&quot;&lt;/div&gt;&quot;))</span>
                    {
<span class="nc" id="L291">                        navbar = navbar.substring(0, navbar.length()-6) + &quot; &quot; + Constants.getString(&quot;navbarSeparator&quot;)+&quot; &lt;span&gt;&quot;+doc.getNavbar()+&quot;&lt;/span&gt;&lt;/div&gt;&quot;;</span>
                    }
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">                    else if (&quot;schema.org&quot;.equalsIgnoreCase(Constants.getString(&quot;navbarDefaultType&quot;)))</span>
                    {
<span class="nc" id="L295">                        int counter = StringUtils.countMatches(navbar, &quot;&lt;li&quot;) + 1;</span>
<span class="nc" id="L296">                        String link = docDB.getDocLink(doc.getDocId(), doc.getExternalLink(), request);</span>
<span class="nc" id="L297">                        navbar = navbar.substring(0, navbar.length() - 5);</span>
<span class="nc" id="L298">                        navbar = navbar + &quot; &lt;li class=\&quot;is-item\&quot; itemprop=\&quot;itemListElement\&quot; itemscope=\&quot;\&quot; itemtype=\&quot;http://schema.org/ListItem\&quot;&gt;&lt;a href=\&quot;&quot; + link + &quot;\&quot; class=\&quot;navbar\&quot; itemprop=\&quot;item\&quot;&gt;&lt;span itemprop=\&quot;name\&quot;&gt;&quot; + Tools.convertToHtmlTags(doc.getNavbar()) + &quot;&lt;/span&gt;&lt;/a&gt;&lt;meta itemprop=\&quot;position\&quot; content=\&quot;&quot; + counter + &quot;\&quot;&gt;&lt;/li&gt;&quot;;</span>
<span class="nc" id="L299">                        navbar += &quot;\n&lt;/ol&gt;&quot;;</span>
<span class="nc" id="L300">                    }</span>
                    else
                    {
<span class="fc" id="L303">                        navbar = navbar + &quot; &quot; + Constants.getString(&quot;navbarSeparator&quot;) + &quot; &quot; + Tools.convertToHtmlTags(doc.getNavbar());</span>
                    }
                }
            }
        }
<span class="fc" id="L308">        request.setAttribute(&quot;navbar&quot;, navbar);</span>
<span class="fc" id="L309">    }</span>

    public static void setRequestData(GroupDetails group, GroupsDB groupsDB, HttpServletRequest request)
    {
<span class="fc" id="L313">        request.setAttribute(&quot;pageGroupDetails&quot;, group);</span>

<span class="fc" id="L315">        request.setAttribute(&quot;group_name&quot;, group.getGroupName());</span>
<span class="fc" id="L316">        request.setAttribute(&quot;group_navbar&quot;, group.getNavbar());</span>
<span class="fc" id="L317">        request.setAttribute(&quot;group_htmlhead&quot;, group.getHtmlHead());</span>
<span class="fc" id="L318">        request.setAttribute(&quot;group_htmlhead_recursive&quot;, groupsDB.getHtmlHeadRecursive(group.getGroupId()));</span>
<span class="fc" id="L319">        request.setAttribute(&quot;group_field_a&quot;, group.getFieldA());</span>
<span class="fc" id="L320">        request.setAttribute(&quot;group_field_b&quot;, group.getFieldB());</span>
<span class="fc" id="L321">        request.setAttribute(&quot;group_field_c&quot;, group.getFieldC());</span>
<span class="fc" id="L322">        request.setAttribute(&quot;group_field_d&quot;, group.getFieldD());</span>
<span class="fc" id="L323">        request.setAttribute(&quot;group_lng&quot;, group.getLng());</span>
<span class="fc" id="L324">    }</span>

    /**
* Ak zadane CSS obsahuje novy riadok alebo ciarku spravi z neho automaticky Combine
* @param cssStyle String
* @return String
*/
private static String combineCss(String cssStyle)
{
<span class="fc" id="L333">       cssStyle = Tools.replace(cssStyle, &quot;\n&quot;, &quot;,&quot;);</span>
<span class="fc" id="L334">        cssStyle = Tools.replace(cssStyle, &quot;\r&quot;, &quot;&quot;);</span>

<span class="pc bpc" id="L336" title="1 of 2 branches missed.">        if (cssStyle.contains(&quot;,&quot;))</span>
        {
<span class="nc" id="L338">            return &quot;/components/_common/combine.jsp?t=css&amp;f=&quot;+cssStyle+&quot;&amp;v=&quot;+CombineTag.getVersion();</span>
        }

<span class="fc" id="L341">        return cssStyle;</span>
}

    public static void setRequestData(TemplateDetails temp, HttpServletRequest request)
	{
<span class="fc" id="L346">		request.setAttribute(&quot;templateDetails&quot;, temp);</span>

<span class="fc" id="L348">		long tempGroupId = temp.getTemplatesGroupId();</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">		if (tempGroupId &gt; 0)</span>
        {
<span class="fc" id="L351">            TemplatesGroupBean tgb = TemplatesGroupDB.getInstance().getById(temp.getTemplatesGroupId());</span>
<span class="pc bpc" id="L352" title="1 of 2 branches missed.">            if (tgb != null)</span>
            {
<span class="fc" id="L354">                request.setAttribute(&quot;templatesGroupDetails&quot;, tgb);</span>

<span class="pc bpc" id="L356" title="1 of 2 branches missed.">                if (Tools.isNotEmpty(tgb.getKeyPrefix()))</span>
                {
<span class="fc" id="L358">                    RequestBean.addTextKeyPrefix(tgb.getKeyPrefix(), false);</span>
                }
            }
<span class="fc" id="L361">            request.setAttribute(&quot;templates_group_id&quot;, tempGroupId);</span>
        }

<span class="fc" id="L364">        RequestBean.addTextKeyPrefix(&quot;temp-&quot;+temp.getTempId(), false);</span>

<span class="fc" id="L366">		request.setAttribute(&quot;doc_temp_name&quot;, temp.getTempName());</span>
<span class="fc" id="L367">		request.setAttribute(&quot;template_id&quot;, Integer.toString(temp.getTempId()));</span>
<span class="fc" id="L368">		request.setAttribute(&quot;template_name&quot;, temp.getTempName());</span>
<span class="fc" id="L369">		request.setAttribute(&quot;after_body&quot;, temp.getAfterBodyData());</span>
<span class="fc" id="L370">		request.setAttribute(&quot;base_css_link&quot;, combineCss(temp.getBaseCssPath()));</span>
<span class="fc" id="L371">        request.setAttribute(&quot;base_css_link_nocombine&quot;, temp.getBaseCssPath());</span>
<span class="fc" id="L372">		request.setAttribute(&quot;base_css_link_noext&quot;, Tools.replace(temp.getBaseCssPath(), &quot;.css&quot;, &quot;&quot;));</span>
<span class="pc bpc" id="L373" title="2 of 4 branches missed.">		if (temp.getCss() != null &amp;&amp; temp.getCss().length() &gt; 1)</span>
		{
<span class="nc" id="L375">			request.setAttribute(&quot;css_link&quot;, combineCss(temp.getCss()));</span>
<span class="nc" id="L376">            request.setAttribute(&quot;css_link_nocombine&quot;, temp.getCss());</span>
<span class="nc" id="L377">			request.setAttribute(&quot;css_link_noext&quot;, Tools.replace(temp.getCss(), &quot;.css&quot;, &quot;&quot;));</span>
		}

<span class="fc" id="L380">        Ninja.includeNinja(request);</span>
<span class="fc" id="L381">	}</span>

    /**
     *  Aktualizuje kody pouzivatela !LOGGED_USER_XXX! v texte
     *
     *@param  user  Description of the Parameter
     *@param  text  Description of the Parameter
     *@return       Description of the Return Value
     */
    public static String updateUserCodes(Identity user, String text)
    {
<span class="nc" id="L392">        StringBuilder sb = new StringBuilder(text);</span>
<span class="nc" id="L393">        return DocTools.updateUserCodes(user, sb).toString();</span>
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
<span class="fc" id="L399">        Logger.debug(ShowDoc.class,&quot;ShowDoc SERVLET CALLED - GET&quot;);</span>
<span class="fc" id="L400">        execute(request,response);</span>
<span class="fc" id="L401">    }</span>

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
<span class="fc" id="L406">        Logger.debug(ShowDoc.class,&quot;ShowDoc SERVLET CALLED - POST&quot;);</span>
<span class="fc" id="L407">        execute(request,response);</span>
<span class="fc" id="L408">    }</span>


    /**
     *  Description of the Method
     *
     * @param  request               Description of the Parameter
     * @param  response              Description of the Parameter
     * @exception  IOException       Description of the Exception
     * @exception ServletException   Description of the Exception
     */

    private void execute(
                                 HttpServletRequest request,
                                 HttpServletResponse response)
            throws IOException, ServletException
    {
<span class="fc" id="L425">        int doc_id = 1;</span>
<span class="fc" id="L426">        Prop prop = Prop.getInstance(Constants.getString(&quot;defaultLanguage&quot;));</span>


        //update stranok podla casov

        //get session
<span class="fc" id="L432">        HttpSession session = request.getSession();</span>
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">        if (session == null)</span>
        {
<span class="nc" id="L435">            request.getRequestDispatcher(&quot;index&quot;).forward(request,response);</span>
<span class="nc" id="L436">            return;</span>
        }

        //over licenciu
<span class="fc bfc" id="L440" title="All 2 branches covered.">        if (session.getAttribute(&quot;license_checked&quot;) == null)</span>
        {
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">            if (!InitServlet.verify(request))</span>
            {
<span class="nc" id="L444">                response.sendRedirect(&quot;https://www.interway.sk&quot;);</span>
<span class="nc" id="L445">                return;</span>
            }
        }
<span class="fc" id="L448">        session.setAttribute(&quot;license_checked&quot;, &quot;true&quot;);</span>

<span class="fc" id="L450">        Identity user = (Identity) session.getAttribute(Constants.USER_KEY);</span>
<span class="fc bfc" id="L451" title="All 2 branches covered.">        if (user == null)</span>
        {
<span class="fc" id="L453">            user = new Identity();</span>
        }

        try
        {
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">            if (session.getAttribute(&quot;setCookie&quot;) != null)</span>
            {
<span class="nc" id="L460">                Cookie myCookie = (Cookie) session.getAttribute(&quot;setCookie&quot;);</span>
<span class="nc" id="L461">                Logger.println(this,&quot;setting cookie: &quot; + myCookie.getName());</span>
<span class="nc" id="L462">                Tools.addCookie(myCookie, response,request);</span>

<span class="nc" id="L464">                session.removeAttribute(&quot;setCookie&quot;);</span>
            }
        }
<span class="nc" id="L467">        catch (Exception ex)</span>
        {
<span class="nc" id="L469">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L470">        }</span>

<span class="fc" id="L472">        String doShowdocAction = request.getParameter(&quot;doShowdocAction&quot;);</span>
<span class="fc bfc" id="L473" title="All 2 branches covered.">        if (isDoShowdocActionAllowed(doShowdocAction))</span>
        {
            //submitujeme sa akoze na /showdoc.do, ale chceme vykonat nejaku akciu
<span class="fc" id="L476">            Logger.println(this,&quot;doShowdocAction: &quot; + doShowdocAction);</span>

<span class="fc" id="L478">            String doShowdocActionCycle = (String)request.getAttribute(&quot;doShowdocActionCycle&quot;);</span>
<span class="fc bfc" id="L479" title="All 2 branches covered.">            if (doShowdocAction.equals(doShowdocActionCycle))</span>
            {
<span class="fc" id="L481">                Logger.println(this,&quot;doShowdocActionCycle - rekurzia, preskakujem!!!!!&quot;);</span>
            }
            else
            {
                //aby sme sa nezacyklili
<span class="fc" id="L486">                request.setAttribute(&quot;doShowdocActionCycle&quot;, doShowdocAction);</span>

<span class="fc" id="L488">                request.getRequestDispatcher(doShowdocAction).forward(request, response);</span>
<span class="fc" id="L489">                return;</span>
            }
        }

<span class="fc" id="L493">        String dmail = request.getHeader(&quot;dmail&quot;);</span>

<span class="fc bfc" id="L495" title="All 4 branches covered.">        if (dmail != null || request.getParameter(&quot;isDmail&quot;)!=null)</span>
        {
            //vypis vsetky headre
<span class="fc" id="L498">            Enumeration&lt;String&gt; e2 = request.getHeaderNames();</span>
<span class="fc bfc" id="L499" title="All 2 branches covered.">            while (e2.hasMoreElements())</span>
            {
<span class="fc" id="L501">                String name = e2.nextElement();</span>
<span class="fc" id="L502">                String value = request.getHeader(name);</span>
<span class="fc" id="L503">                Logger.debug(ShowDoc.class, &quot;headers: &quot;+name+&quot;=&quot;+value);</span>
<span class="fc" id="L504">            }</span>
            //porovnaj to s ulozenou hodnotou
<span class="pc bpc" id="L506" title="3 of 6 branches missed.">            if (dmail!=null &amp;&amp; dmail.equals(ACTUAL_USER_HASH) &amp;&amp; request.getParameter(&quot;userid&quot;)!=null)</span>
            {
<span class="nc" id="L508">                request.setAttribute(&quot;NO WJTOOLBAR&quot;, &quot;true&quot;);</span>
<span class="nc" id="L509">                Connection db_conn = null;</span>
<span class="nc" id="L510">                PreparedStatement ps = null;</span>
<span class="nc" id="L511">                ResultSet db_result = null;</span>
                try
                {
<span class="nc" id="L514">                    int userId = Integer.parseInt(request.getParameter(&quot;userid&quot;));</span>

                    //ziskaj usera z DB
<span class="nc" id="L517">                    db_conn = DBPool.getConnection(request);</span>
<span class="nc" id="L518">                    ps = db_conn.prepareStatement(&quot;SELECT * FROM  users WHERE user_id=?&quot;);</span>
<span class="nc" id="L519">                    ps.setInt(1, userId);</span>
<span class="nc" id="L520">                    db_result = ps.executeQuery();</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">                    if (db_result.next())</span>
                    {
<span class="nc" id="L523">                        UsersDB.fillUserDetails(user, db_result);</span>
<span class="nc" id="L524">                        LogonTools.setUserToSession(session, user);</span>
<span class="nc" id="L525">                        session.setMaxInactiveInterval(30);</span>
                    }
                    else
                    {
<span class="nc" id="L529">                        Logger.error(this,&quot;user neexistuje&quot;);</span>
                    }

<span class="nc" id="L532">                    db_result.close();</span>
<span class="nc" id="L533">                    ps.close();</span>
<span class="nc" id="L534">                    db_conn.close();</span>
<span class="nc" id="L535">                    db_result = null;</span>
<span class="nc" id="L536">                    ps = null;</span>
<span class="nc" id="L537">                    db_conn = null;</span>
                }
<span class="nc" id="L539">                catch (Exception ex)</span>
                {
<span class="nc" id="L541">                    Logger.error(ShowDoc.class, ex);</span>
                }
                finally
                {
                    try
                    {
<span class="nc bnc" id="L547" title="All 2 branches missed.">                        if (db_result != null)</span>
<span class="nc" id="L548">                            db_result.close();</span>
<span class="nc bnc" id="L549" title="All 2 branches missed.">                        if (ps != null)</span>
<span class="nc" id="L550">                            ps.close();</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">                        if (db_conn != null)</span>
<span class="nc" id="L552">                            db_conn.close();</span>
                    }
<span class="nc" id="L554">                    catch (Exception ignored)</span>
                    {
                        //
<span class="nc" id="L557">                    }</span>
                }
            }
        }

        //ochrana pred XSS utokom
<span class="fc" id="L563">        String xssRedirectUrl = getXssRedirectUrl(request);</span>
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">        if (xssRedirectUrl != null)</span>
        {
<span class="nc" id="L566">            response.sendRedirect(xssRedirectUrl);</span>
<span class="nc" id="L567">            return;</span>
        }

<span class="fc" id="L570">        GroupsDB groupsDB = GroupsDB.getInstance();</span>

<span class="fc" id="L572">        int historyId = -1;</span>
        try
        {
            //origdocid vyluka je kvoli zobrazeniu logon formu
<span class="pc bpc" id="L576" title="1 of 4 branches missed.">            if (request.getParameter(&quot;historyid&quot;) != null &amp;&amp; request.getParameter(&quot;origDocId&quot;)==null)</span>
            {
<span class="fc" id="L578">                historyId = Integer.parseInt(request.getParameter(&quot;historyid&quot;));</span>
<span class="pc bpc" id="L579" title="3 of 4 branches missed.">                if (!user.isAdmin() &amp;&amp; Constants.getBoolean(&quot;docBlockPublicHistory&quot;))</span>
                {
                    //vynimka pre umoznenia preview. Je potrebne mat ale zadefinovane conf. premenne showDocExceptionIPs a showDocExceptionUserId
<span class="nc" id="L582">                    String allowIps = Constants.getString(&quot;showDocExceptionIPs&quot;); //povoleny pristup z konkretnych IP, zaciatkoch IP oddelenych ciarkami</span>
<span class="nc" id="L583">                    int showDocUserId = Tools.getIntValue(Constants.getString(&quot;showDocExceptionUserId&quot;),-1); //pouzivatel, ktoreho mam prihlasit pre preview</span>
<span class="nc" id="L584">                    boolean haveToLogon = true;</span>
<span class="nc bnc" id="L585" title="All 4 branches missed.">                    if(Tools.isNotEmpty(allowIps) &amp;&amp; showDocUserId &gt; 0)</span>
                    {
<span class="nc" id="L587">                        boolean ret = true;</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">                        if (allowIps.length() &gt; 1)</span>
                        {
<span class="nc" id="L590">                            ret = false;</span>
<span class="nc" id="L591">                            StringTokenizer st = new StringTokenizer(allowIps, &quot;,&quot;);</span>
                            String ip;
<span class="nc" id="L593">                            String myIP = Tools.getRemoteIP(request);</span>
<span class="nc" id="L594">                            Logger.debug(ShowDoc.class,&quot;ShowDoc: Checking: &quot; + myIP + &quot; vs &quot; + allowIps);</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                            while (st.hasMoreTokens())</span>
                            {
<span class="nc" id="L597">                                ip = st.nextToken();</span>
<span class="nc bnc" id="L598" title="All 2 branches missed.">                                if (myIP.startsWith(ip.trim()))</span>
                                {
<span class="nc" id="L600">                                    ret = true;</span>
<span class="nc" id="L601">                                    break;</span>
                                }
                            }
                        }
<span class="nc bnc" id="L605" title="All 2 branches missed.">                        if(ret)</span>
                        {
<span class="nc" id="L607">                            UserDetails ud = UsersDB.getUser(showDocUserId);</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">                            if(ud.getUserId() &gt; 0)</span>
                            {
<span class="nc" id="L610">                                user = new Identity(ud);</span>
<span class="nc" id="L611">                                haveToLogon = false;</span>
                            }
                        }

                    }
                    //dovolime to aj inym ludom, aby sa na to mohol pozriet aj klient alebo niekto
<span class="nc bnc" id="L617" title="All 2 branches missed.">                    if(haveToLogon) request.getRequestDispatcher(&quot;logon_admin&quot;).forward(request,response);</span>
<span class="nc" id="L618">                    return;</span>
                }
            }
        }
<span class="nc" id="L622">        catch (Exception ignored)</span>
        {
            //
<span class="fc" id="L625">        }</span>

        try
        {
<span class="fc bfc" id="L629" title="All 2 branches covered.">            if (historyId &lt; 0)</span>
            {
                //skus ziskat default doc_id ku grupe
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">                if (request.getParameter(&quot;groupid&quot;) != null)</span>
                {
                    try
                    {
<span class="nc" id="L636">                        int group_id = Integer.parseInt(request.getParameter(&quot;groupid&quot;));</span>
<span class="nc" id="L637">                        GroupDetails group = groupsDB.getGroup(group_id);</span>
<span class="nc" id="L638">                        doc_id = group.getDefaultDocId();</span>
                    }
<span class="nc" id="L640">                    catch (Exception ignored)</span>
                    {
                        //
<span class="nc" id="L643">                    }</span>
                }
                //ak stale nemam doc_id ziskaj ho
                //0 je vtedy ked v DB v tabulke groups je default doc null
<span class="pc bpc" id="L647" title="3 of 4 branches missed.">                if (doc_id == 1 || doc_id == 0)</span>
                {
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">                    if (request.getParameter(&quot;docid&quot;) != null)</span>
                    {
<span class="fc" id="L651">                        String docidParam = request.getParameter(&quot;docid&quot;);</span>
<span class="fc" id="L652">                        int indexOfSharp = docidParam.indexOf('#');</span>
<span class="pc bpc" id="L653" title="1 of 2 branches missed.">                        if (indexOfSharp!=-1)</span>
                        {
<span class="nc" id="L655">                            docidParam = docidParam.substring(0, indexOfSharp);</span>
                        }
<span class="fc" id="L657">                        doc_id = Integer.parseInt(docidParam);</span>
<span class="fc" id="L658">                    }</span>
                    else
                    {
<span class="nc" id="L661">                        doc_id = Integer.parseInt((String) request.getAttribute(&quot;docid&quot;));</span>
                    }
                }
            }
        }
<span class="nc" id="L666">        catch (Exception ex)</span>
        {
<span class="nc" id="L668">            StatDB.addError(request.getRequestURI()+&quot;?&quot;+request.getQueryString(), prop.getText(&quot;admin.showdoc_error_message&quot;)+&quot; 1&quot;);</span>
<span class="nc" id="L669">            request.setAttribute(&quot;err_msg&quot;, prop.getText(&quot;admin.showdoc_default_error_message&quot;));</span>
<span class="nc" id="L670">            request.getRequestDispatcher(&quot;error&quot;).forward(request,response);</span>
<span class="nc" id="L671">            return;</span>
<span class="fc" id="L672">        }</span>

        //TODO: check rights?

<span class="fc" id="L676">        DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L677">        TemplatesDB tempDB = TemplatesDB.getInstance();</span>
        TemplateDetails temp;

<span class="fc" id="L680">        DocDetails doc = null;</span>
<span class="pc bpc" id="L681" title="1 of 6 branches missed.">        boolean inlineEditorAdmin = user != null &amp;&amp; user.isAdmin() &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;inlineEditorAdmin&quot;));</span>

<span class="fc" id="L683">        int group_id = -1;</span>
        try
        {
<span class="fc bfc" id="L686" title="All 2 branches covered.">            if (session.getAttribute(Constants.SESSION_GROUP_ID) != null)</span>
            {
<span class="fc" id="L688">                group_id = Integer.parseInt((String) session.getAttribute(Constants.SESSION_GROUP_ID));</span>
            }
        }
<span class="nc" id="L691">        catch (Exception ex)</span>
        {
<span class="nc bnc" id="L693" title="All 2 branches missed.">            if (doc_id == -1)</span>
            {
<span class="nc" id="L695">                doc_id = -2;</span>
            }
<span class="fc" id="L697">        }</span>

<span class="fc" id="L699">        ShowDocBean showDocBean = new ShowDocBean();</span>
<span class="fc" id="L700">        showDocBean.setRequest(request);</span>
<span class="fc" id="L701">        showDocBean.setResponse(response);</span>
<span class="fc" id="L702">        showDocBean.setDoc(null);</span>
<span class="fc" id="L703">        showDocBean.setDocId(doc_id);</span>
<span class="fc" id="L704">        showDocBean.setHistoryId(historyId);</span>
<span class="fc" id="L705">        WebjetEvent&lt;ShowDocBean&gt; showdocEvent = new WebjetEvent&lt;&gt;(showDocBean, WebjetEventType.ON_START);</span>
<span class="fc" id="L706">		showdocEvent.publishEvent();</span>

<span class="fc bfc" id="L708" title="All 2 branches covered.">        if (request.getAttribute(&quot;ShowdocAction.showDocData&quot;)!=null)</span>
        {
<span class="fc" id="L710">            doc = (DocDetails)request.getAttribute(&quot;ShowdocAction.showDocData&quot;);</span>
<span class="pc bpc" id="L711" title="1 of 2 branches missed.">            if (doc != null) Logger.println(this,&quot;----&gt; IDEM Z PREVIEW, docid=&quot;+doc.getDocId()+&quot; path=&quot;+doc.getVirtualPath());</span>
        }
<span class="pc bpc" id="L713" title="1 of 2 branches missed.">        else if (showDocBean.getForceShowDoc()!=null)</span>
        {
            //vystupny doc objekt z eventu, ak sa nastavi, pouzije sa ako doc objekt pre zobrazenie web stranky cez /showdoc.do
<span class="nc" id="L716">            doc = showDocBean.getForceShowDoc();</span>
        }
        else
        {
<span class="pc bpc" id="L720" title="1 of 2 branches missed.">            if (doc_id &lt; 0)</span>
            {
                //ak je to admin
<span class="nc bnc" id="L723" title="All 4 branches missed.">                if (user.isAdmin() &amp;&amp; doc_id &lt; -1)</span>
                {
                    try
                    {
<span class="nc" id="L727">                        doc = docDB.getDoc(-doc_id);</span>
<span class="nc" id="L728">                        doc_id = -1;</span>
                    }
<span class="nc" id="L730">                    catch (Exception ignored)</span>
                    {
                        //ignore
<span class="nc" id="L733">                    }</span>
                }

<span class="nc bnc" id="L736" title="All 2 branches missed.">                if (doc == null)</span>
                {
<span class="nc" id="L738">                    doc = new DocDetails();</span>
<span class="nc" id="L739">                    doc.setDocId(-1);</span>
<span class="nc" id="L740">                    doc.setGroupId(group_id);</span>
<span class="nc" id="L741">                    doc.setData(&quot;&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L742">                    doc.setTitle(&quot;novy dokument&quot;);</span>

<span class="nc" id="L744">                    doc.setNavbar(&quot;&quot;);</span>
                }
            }
            else
            {
<span class="fc bfc" id="L749" title="All 2 branches covered.">                if (historyId &gt; 0)</span>
                {
<span class="fc" id="L751">                    doc = docDB.getDoc(-1, historyId);</span>
                }
                else
                {
                    try
                    {
<span class="fc" id="L757">                        boolean useCache = true;</span>
<span class="fc bfc" id="L758" title="All 2 branches covered.">                        if (inlineEditorAdmin) useCache = false;</span>
<span class="fc" id="L759">                        doc = docDB.getDoc(doc_id, -1, useCache);</span>
                    }
<span class="nc" id="L761">                    catch (NullPointerException npe)</span>
                    {
                        //nastala chyba pripojenia do DB - vypisme chybu
<span class="nc" id="L764">                        SetCharacterEncodingFilter.printDbErrorMessage(PathFilter.getOrigPath(request), request, response);</span>

<span class="nc" id="L766">                        return;</span>
<span class="fc" id="L767">                    }</span>
                }
            }
        }

<span class="pc bpc" id="L772" title="1 of 2 branches missed.">        if (doc == null)</span>
        {
<span class="nc" id="L774">            Logger.debug(ShowDoc.class, &quot;404 (doc is null)&quot;);</span>
<span class="nc" id="L775">            request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L776">            return;</span>
        }

        //	premapovanie web stranky na iny dokument
<span class="fc" id="L780">        int remapStart = doc.getData().indexOf(REMAP_STRING_START);</span>
<span class="pc bpc" id="L781" title="1 of 2 branches missed.">        if (remapStart!=-1)</span>
        {
            try
            {
<span class="nc" id="L785">                int remapEnd = doc.getData().indexOf(REMAP_STRING_END);</span>
<span class="nc" id="L786">                remapStart += REMAP_STRING_START.length();</span>
<span class="nc" id="L787">                int remapDocId = Tools.getIntValue(doc.getData().substring(remapStart, remapEnd), -1);</span>
<span class="nc" id="L788">                Logger.println(ShowDoc.class, &quot;remap doc id=&quot;+remapDocId);</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">                if (remapDocId &gt; 0)</span>
                {
<span class="nc" id="L791">                    DocDetails remapDoc = docDB.getDoc(remapDocId);</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">                    if (remapDoc != null)</span>
                    {
<span class="nc" id="L794">                        Logger.println(ShowDoc.class, &quot;RempaDocTitle: &quot; + remapDoc.getTitle());</span>

<span class="nc" id="L796">                        request.setAttribute(&quot;remapDocOriginal&quot;, doc);</span>

<span class="nc" id="L798">                        remapDoc.setTitle(doc.getTitle());</span>
<span class="nc" id="L799">                        remapDoc.setNavbar(doc.getNavbar());</span>
<span class="nc" id="L800">                        remapDoc.setGroupId(doc.getGroupId());</span>
<span class="nc" id="L801">                        remapDoc.setTempId(doc.getTempId());</span>

<span class="nc" id="L803">                        doc = remapDoc;</span>
                    }
                    else
                    {
<span class="nc" id="L807">                        Logger.debug(ShowDoc.class, &quot;404 (remapdoc is null)&quot;);</span>
<span class="nc" id="L808">                        request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L809">                        return;</span>
                    }
                }
            }
<span class="nc" id="L813">            catch (Exception ex)</span>
            {
<span class="nc" id="L815">                Logger.error(ShowDoc.class, ex);</span>
<span class="nc" id="L816">            }</span>
        }

<span class="pc bpc" id="L819" title="2 of 8 branches missed.">        if (!user.isAdmin() &amp;&amp; !doc.isAvailable() &amp;&amp; historyId &lt; 0 &amp;&amp; !BlogTools.isEditable(doc.getGroupId(), user))</span>
        {
<span class="fc" id="L821">            Logger.debug(ShowDoc.class, &quot;404 (doc is not available)&quot;);</span>
<span class="fc" id="L822">            request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="fc" id="L823">            return;</span>
        }

        //ak nie je pouzivatel admin a showOnlyActualPublishedDoc=true, tak zobrazi len aktualne platny clanok vid. docDB.canBeShown(doc)
<span class="pc bpc" id="L827" title="3 of 6 branches missed.">        if (!user.isAdmin() &amp;&amp; Constants.getBoolean(&quot;showOnlyActualPublishedDoc&quot;) &amp;&amp; !docDB.canBeShown(doc))</span>
        {
<span class="nc" id="L829">            String canBeShownForUserAgent = Constants.getString(&quot;canBeShownForUserAgent&quot;);</span>
<span class="nc" id="L830">            boolean found = false;</span>
<span class="nc" id="L831">            String ua = request.getHeader(&quot;User-Agent&quot;);</span>
<span class="nc bnc" id="L832" title="All 4 branches missed.">            if (Tools.isNotEmpty(canBeShownForUserAgent) &amp;&amp; ua != null)</span>
            {
<span class="nc" id="L834">                String[] canBeShownForUserAgentTokens = Tools.getTokens(canBeShownForUserAgent, &quot;,|&quot;, true);</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">                for(String t : canBeShownForUserAgentTokens)</span>
                {
<span class="nc bnc" id="L837" title="All 2 branches missed.">                    if(ua.contains(t))</span>
                    {
<span class="nc" id="L839">                        found = true;</span>
<span class="nc" id="L840">                        break;</span>
                    }
                }
            }

<span class="nc bnc" id="L845" title="All 2 branches missed.">            if(!found)</span>
            {
<span class="nc" id="L847">                Logger.debug(ShowDoc.class, &quot;404 (doc is not available)&quot;);</span>
<span class="nc" id="L848">                request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L849">                return;</span>
            }
        }

        //httpS presmerovanie
<span class="pc bpc" id="L854" title="1 of 4 branches missed.">        if (Constants.getBoolean(&quot;httpsAvailable&quot;) &amp;&amp; &quot;GET&quot;.equalsIgnoreCase(request.getMethod()))</span>
        {
<span class="pc bpc" id="L856" title="3 of 4 branches missed.">            if (doc.isRequireSsl() &amp;&amp; !Tools.isSecure(request))</span>
            {
                //presmerovanie NON SSL na SSL
<span class="nc" id="L859">                String baseHref = Tools.getBaseHref(request);</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">                if (baseHref.startsWith(&quot;http:&quot;)) baseHref = &quot;https:&quot;+baseHref.substring(5);</span>

<span class="nc" id="L862">                StringBuilder sb = new StringBuilder(baseHref);</span>
<span class="nc" id="L863">                sb.append(PathFilter.getOrigPath(request));</span>
<span class="nc" id="L864">                String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">                if (Tools.isNotEmpty(qs))</span>
                {
<span class="nc" id="L867">                    sb.append('?').append(qs);</span>
                }

<span class="nc" id="L870">                Logger.debug(ShowDoc.class, &quot;Redirecting to SSL:&quot;+ sb);</span>

<span class="nc" id="L872">                response.sendRedirect(sb.toString());</span>
<span class="nc" id="L873">                return;</span>
            }
<span class="pc bpc" id="L875" title="8 of 10 branches missed.">            if (!doc.isRequireSsl() &amp;&amp; Tools.isSecure(request) &amp;&amp; Tools.isNotEmpty(Constants.getString(&quot;httpsRedirectToNonSSLNodeNames&quot;)) &amp;&amp; (&quot;*&quot;.equals(Constants.getString(&quot;httpsRedirectToNonSSLNodeNames&quot;)) || Constants.getString(&quot;httpsRedirectToNonSSLNodeNames&quot;).contains(Constants.getString(&quot;clusterMyNodeName&quot;))))</span>
            {
                //presmerovanie SSL na NON SSL
<span class="nc" id="L878">                String baseHref = Tools.getBaseHref(request);</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">                if (baseHref.startsWith(&quot;https:&quot;)) baseHref = &quot;http:&quot;+baseHref.substring(6);</span>

<span class="nc" id="L881">                StringBuilder sb = new StringBuilder(baseHref);</span>
<span class="nc" id="L882">                sb.append(PathFilter.getOrigPath(request));</span>
<span class="nc" id="L883">                String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">                if (Tools.isNotEmpty(qs))</span>
                {
<span class="nc" id="L886">                    sb.append('?').append(qs);</span>
                }

<span class="nc" id="L889">                Logger.debug(ShowDoc.class, &quot;Redirecting to NON SSL:&quot;+ sb);</span>

<span class="nc" id="L891">                response.sendRedirect(sb.toString());</span>
<span class="nc" id="L892">                return;</span>
            }
        }

        //kontrola pristupovych prav

        //najskor zisti ako je na tom adresar
<span class="fc" id="L899">        GroupDetails group = groupsDB.getGroup(doc.getGroupId());</span>
        //akoze posledna zachrana
<span class="pc bpc" id="L901" title="1 of 2 branches missed.">        if (group == null) group = new GroupDetails();</span>

<span class="pc bpc" id="L903" title="2 of 6 branches missed.">        if (!Constants.getBoolean(&quot;webpagesAvailableInInternalFolders&quot;) &amp;&amp; !user.isAdmin() &amp;&amp; group.isInternal())</span>
        {
            //ak je stranka v internom adresari nezobraz ju
<span class="nc" id="L906">            Logger.println(ShowDoc.class, &quot;404 (doc is not available) - is in internal folder&quot;);</span>
<span class="nc" id="L907">            Adminlog.add(Adminlog.TYPE_XSS, &quot;Page is in internal folder, is not available for public: &quot;+doc.getDocId(), doc.getDocId(), doc.getTempId());</span>
<span class="nc" id="L908">            request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L909">            return;</span>
        }

<span class="fc" id="L912">        setRequestData(group, groupsDB, request);</span>

<span class="fc bfc" id="L914" title="All 4 branches covered.">        if (Tools.isNotEmpty(group.getPasswordProtected()) &amp;&amp; Tools.isEmpty(doc.getPasswordProtected()))</span>
        {
<span class="fc" id="L916">            doc.setPasswordProtected(group.getPasswordProtected());</span>
        }

        //zaheslovanie vsetkeho (bez potreby nastavovania v admin casti)
<span class="fc" id="L920">        String passwordProtectedAutoId = Constants.getString(&quot;passwordProtectedAutoId&quot;);</span>
<span class="pc bpc" id="L921" title="1 of 2 branches missed.">        if (Tools.isNotEmpty(passwordProtectedAutoId))</span>
        {
<span class="nc bnc" id="L923" title="All 2 branches missed.">            if (Tools.isEmpty(doc.getPasswordProtected()))</span>
            {
<span class="nc" id="L925">                doc.setPasswordProtected(passwordProtectedAutoId);</span>
            }
            // else odstraneny
            //tie co su zaheslovane nenastavujeme, inak sa tam vzdy dostane (lebo staci jedna vyhovujuca skupina)!!!
            //doc.setPasswordProtected(passwordProtectedAutoId+&quot;,&quot;+doc.getPasswordProtected());
        }

<span class="fc" id="L932">        request.setAttribute(&quot;groupParentIds&quot;, &quot;,&quot; + groupsDB.getParents(group.getGroupId()));</span>

<span class="pc bpc" id="L934" title="1 of 2 branches missed.">        if (doc.getPasswordProtected() != null)</span>
        {
            //zisti ci dany user ma pravo na skupinu pre web stranku
<span class="fc" id="L937">            boolean canAccess = DocDB.canAccess(doc, user);</span>

            //	rekurzivne dozadu najdi LogonPageDocId
<span class="fc" id="L940">            int logonPageDocId = groupsDB.getRecursiveLogonPageDocId(group.getGroupId());</span>
<span class="pc bpc" id="L941" title="1 of 4 branches missed.">            if (logonPageDocId &gt; 0 &amp;&amp; doc.getLogonPageDocId() &lt; 1)</span>
            {
<span class="fc" id="L943">                doc.setLogonPageDocId(logonPageDocId);</span>
            }

<span class="fc bfc" id="L946" title="All 4 branches covered.">            if (doc.getLogonPageDocId() &gt; 0 &amp;&amp; doc.getLogonPageDocId() == doc_id)</span>
            {
<span class="fc" id="L948">                Logger.debug(ShowDoc.class, &quot;som logon stranka, zobrazujem&quot;);</span>
                //je to rekurzia, stranka pre prihlasenie je tiez zaheslovana,
                //takze ju musime zobrazit !!!!
<span class="fc" id="L951">                canAccess = true;</span>
            }

<span class="pc bpc" id="L954" title="1 of 4 branches missed.">            if (!canAccess &amp;&amp; Tools.isNotEmpty(AuthenticationFilter.getForbiddenURL()))</span>
            {
<span class="nc" id="L956">                StringBuilder fullPath = new StringBuilder((String)request.getAttribute(&quot;path_filter_orig_path&quot;));</span>
<span class="nc" id="L957">                String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">                if (Tools.isNotEmpty(qs)) fullPath.append('?').append(qs);</span>


<span class="nc" id="L961">                Logger.debug(ShowDoc.class, &quot;testujem forbidden URL: &quot;+ AuthenticationFilter.getForbiddenURL()+&quot; fullPath=&quot;+fullPath);</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">                if (AuthenticationFilter.getForbiddenURL().equals(fullPath.toString()))</span>
                {
<span class="nc" id="L964">                    canAccess = true;</span>
                }
            }

<span class="fc bfc" id="L968" title="All 2 branches covered.">            if (!canAccess)</span>
            {
<span class="fc" id="L970">                Logger.debug(ShowDoc.class, &quot;canAccess == false logonDocid=&quot;+doc.getLogonPageDocId()+&quot; docId=&quot;+doc.getDocId());</span>
<span class="fc" id="L971">                UserGroupsDB userGroupsDB = UserGroupsDB.getInstance();</span>
<span class="fc" id="L972">                request.setAttribute(&quot;password_protected&quot;, userGroupsDB.convertIdsToNames(doc.getPasswordProtected()));</span>
<span class="fc" id="L973">                request.setAttribute(&quot;password_protected_ids&quot;, doc.getPasswordProtected());</span>

<span class="fc" id="L975">                String domainController = Constants.getString(&quot;NTLMDomainController&quot;);</span>
<span class="pc bpc" id="L976" title="1 of 2 branches missed.">                if (Tools.isNotEmpty(domainController))</span>
                {
<span class="nc bnc" id="L978" title="All 2 branches missed.">                    if (Tools.isNotEmpty(AuthenticationFilter.getForbiddenURL()))</span>
                    {
                        //uz je prihlaseny, dame forbidden
<span class="nc" id="L981">                        StringBuilder fullPath = new StringBuilder((String)request.getAttribute(&quot;path_filter_orig_path&quot;));</span>
<span class="nc" id="L982">                        String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">                        if (Tools.isNotEmpty(qs)) fullPath.append('?').append(qs);</span>

<span class="nc" id="L985">                        response.sendRedirect(Tools.addParameterToUrlNoAmp(AuthenticationFilter.getForbiddenURL(), &quot;origUrl&quot;, fullPath.toString()));</span>
<span class="nc" id="L986">                        return;</span>
                    }
<span class="nc" id="L988">                    Logger.debug(ShowDoc.class, &quot;spustam NTLM LOGON ACTION&quot;);</span>
<span class="nc" id="L989">                    response.sendRedirect(&quot;/ntlm/logon.do?origDocId=&quot;+doc_id);</span>
<span class="nc" id="L990">                    return;</span>
                }

<span class="pc bpc" id="L993" title="1 of 2 branches missed.">                if (doc.getLogonPageDocId() &gt; 0)</span>
                {
                    //forwardni sa na stranku s prihlasovacim dialogom
<span class="fc" id="L996">                    request.setAttribute(&quot;docDetailsOriginal&quot;, doc);</span>
<span class="fc" id="L997">                    request.removeAttribute(&quot;docid&quot;);</span>
<span class="fc" id="L998">                    request.getRequestDispatcher(&quot;/showdoc.do?docid=&quot;+doc.getLogonPageDocId()+&quot;&amp;origDocId=&quot;+doc.getDocId()).forward(request, response);</span>
<span class="fc" id="L999">                    return;</span>
                }
                else
                {
                    //	toto vytvori pseudo prihlasovaciu stranku
<span class="nc" id="L1004">                    request.setAttribute(&quot;docDetailsOriginal&quot;, doc);</span>
<span class="nc" id="L1005">                    DocDetails origDoc = doc;</span>
<span class="nc" id="L1006">                    doc = new DocDetails();</span>

                    //kopirovanie properties - je to tu rucne aby sa neskopirovalo nieco co sa nema (inak by sa dalo pouzit BeanUtils)
<span class="nc" id="L1009">                    doc.setAvailable(origDoc.isAvailable());</span>
<span class="nc" id="L1010">                    doc.setTitle(origDoc.getTitle());</span>
<span class="nc" id="L1011">                    doc.setNavbar(origDoc.getNavbar());</span>

<span class="nc" id="L1013">                    doc.setTempId(origDoc.getTempId());</span>
<span class="nc" id="L1014">                    doc.setHeaderDocId(origDoc.getHeaderDocId());</span>
<span class="nc" id="L1015">                    doc.setFooterDocId(origDoc.getFooterDocId());</span>
<span class="nc" id="L1016">                    doc.setMenuDocId(origDoc.getMenuDocId());</span>
<span class="nc" id="L1017">                    doc.setRightMenuDocId(origDoc.getRightMenuDocId());</span>

<span class="nc" id="L1019">                    doc.setData(&quot;!INCLUDE(/components/user/logon.jsp)!&quot;);</span>
                }
            }
            //ak sme az tu, dokument je pre usera pristupny
        }

        //tento parameter tam nastavuje login dialog pre priame stiahnutie suboru
        //vtedy neupdatujem last_doc_id, pretoze sa prepise na hodnotu login dialogu
        //pozri PathFilter.java
<span class="fc bfc" id="L1028" title="All 2 branches covered.">        if (request.getParameter(&quot;dontUpdateLastDocId&quot;)==null)</span>
        {
<span class="fc" id="L1030">            session.setAttribute(&quot;last_doc_id&quot;, doc_id);</span>
        }

        //NOVA STATISTIKA
        try
        {
<span class="pc bpc" id="L1036" title="1 of 2 branches missed.">            if (!Constants.getBoolean(&quot;nginxProxyMode&quot;))</span>
            {
                //statistika to potrebuje
<span class="fc" id="L1039">                request.setAttribute(&quot;group_id&quot;, Integer.toString(doc.getGroupId()));</span>
<span class="fc" id="L1040">                StatDB.add(session, request, response, doc_id);</span>
            }
        }
<span class="nc" id="L1043">        catch (Exception ex)</span>
        {
<span class="nc" id="L1045">            Logger.error(ShowDoc.class, ex);</span>
<span class="fc" id="L1046">        }</span>

<span class="pc bpc" id="L1048" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;nginxProxyMode&quot;))</span>
        {
            //setujeme iba ked sa negeneruje nocache cookie
<span class="nc bnc" id="L1051" title="All 2 branches missed.">            if (!PathFilter.isNoCacheCookieRequired(request)) {</span>
                //v rezime nginx proxy vygenerujeme cache hlavicku
<span class="nc" id="L1053">                int cacheTime = Constants.getInt(&quot;nginxProxyModePageCacheTime&quot;);</span>
<span class="nc bnc" id="L1054" title="All 6 branches missed.">                if (cacheTime&gt;0 &amp;&amp; &quot;GET&quot;.equalsIgnoreCase(request.getMethod()) &amp;&amp; request.getAttribute(&quot;is404&quot;)==null)</span>
                {
<span class="nc" id="L1056">                    PathFilter.setCacheHeaders(cacheTime, response);</span>
                }
            }
        }

<span class="fc" id="L1061">        boolean skipExternalLink = false;</span>
<span class="fc bfc" id="L1062" title="All 2 branches covered.">        if (inlineEditorAdmin) {</span>
            //ak editujeme stranku v inline nevykonaj presmerovanie
<span class="fc" id="L1064">            skipExternalLink = true;</span>
        }

        //ak to nie je urcene pre editor a mame nastavene presmerovanie na externu linku
<span class="pc bpc" id="L1068" title="2 of 8 branches missed.">        if (skipExternalLink==false &amp;&amp; request.getParameter(&quot;approveNoRedirect&quot;)==null &amp;&amp; request.getParameter(&quot;notemp&quot;) == null &amp;&amp; Tools.isNotEmpty(doc.getExternalLink()))</span>
        {
<span class="fc" id="L1070">            String externalLink = doc.getExternalLink();</span>
<span class="fc" id="L1071">            String qs = (String)request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="pc bpc" id="L1072" title="5 of 6 branches missed.">            if (Tools.isNotEmpty(qs) &amp;&amp; externalLink.indexOf('?')==-1 &amp;&amp; !qs.contains(&quot;docid&quot;)) externalLink += &quot;?&quot;+qs;</span>

<span class="pc bpc" id="L1074" title="2 of 4 branches missed.">            if (externalLink.startsWith(&quot;http://&quot;) || externalLink.startsWith(&quot;https://&quot;))</span>
            {
<span class="nc" id="L1076">                response.sendRedirect(externalLink);</span>
<span class="nc" id="L1077">                return ;</span>
            }
            else
            {
<span class="fc" id="L1081">                response.setStatus(301);</span>
<span class="fc" id="L1082">                externalLink = Tools.getBaseHref(request)+externalLink;</span>
<span class="fc" id="L1083">                response.setHeader(&quot;Location&quot;, externalLink);</span>
<span class="fc" id="L1084">                return ;</span>
            }
        }

        //ak mame nejake proxy data a stranka je prazdna, tak nastavme tie proxy data
<span class="fc" id="L1089">        String proxyOutputData = (String)request.getAttribute(&quot;proxyOutputData&quot;);</span>
<span class="pc bpc" id="L1090" title="5 of 6 branches missed.">        if (proxyOutputData!=null &amp;&amp; (Tools.isEmpty(doc.getData()) || doc.getData().length()&lt;20))</span>
        {
<span class="nc" id="L1092">            doc.setData(proxyOutputData);</span>
        }

<span class="pc bpc" id="L1095" title="3 of 4 branches missed.">        if (&quot;open&quot;.equals(request.getParameter(&quot;forum&quot;)) &amp;&amp; request.getAttribute(&quot;docDetailsOriginal&quot;)==null)</span>
        {
<span class="nc" id="L1097">            String type = request.getParameter(&quot;type&quot;);</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">            if (&quot;iframe&quot;.equals(type))</span>
            {
                //request.setAttribute(&quot;doc_data&quot;, doc.getData());
<span class="nc" id="L1101">                StringBuilder iframe = new StringBuilder(&quot;&lt;iframe class='forumIframe' width='100%' height='190' &quot;);</span>
<span class="nc" id="L1102">                iframe.append(&quot;src='/showdoc.do?forumiframe=yes&amp;docid=&quot;).append(doc.getDocId()).append(&quot;'&gt;&lt;/iframe&gt;&quot;);</span>

                try
                {
<span class="nc" id="L1106">                    int start = doc.getData().indexOf(&quot;!INCLUDE(/components/forum/forum.jsp&quot;);</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">                    if (start != -1)</span>
                    {
<span class="nc" id="L1109">                        int end = doc.getData().indexOf(&quot;)!&quot;, start);</span>
<span class="nc bnc" id="L1110" title="All 2 branches missed.">                        if (end &gt; start)</span>
                        {
<span class="nc" id="L1112">                            iframe.append(doc.getData(), start, end+2);</span>
                        }
                    }
                }
<span class="nc" id="L1116">                catch (Exception ex)</span>
                {
<span class="nc" id="L1118">                    Logger.error(ShowDoc.class, ex);</span>
<span class="nc" id="L1119">                }</span>


<span class="nc" id="L1122">                request.setAttribute(&quot;doc_data&quot;, iframe.toString());</span>
<span class="nc" id="L1123">            }</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">            else if (&quot;perex&quot;.equals(type))</span>
            {

<span class="nc" id="L1127">                String perex = doc.getPerex();</span>
<span class="nc" id="L1128">                removeForumFromPerex(request, doc, perex);</span>
<span class="nc" id="L1129">            }</span>
<span class="nc bnc" id="L1130" title="All 2 branches missed.">            else if (&quot;none&quot;.equals(type))</span>
            {
<span class="nc" id="L1132">                String data = &quot;&quot;;</span>
<span class="nc" id="L1133">                removeForumFromPerex(request, doc, data);</span>
<span class="nc" id="L1134">            }</span>
            else
            {
<span class="nc" id="L1137">                request.setAttribute(&quot;doc_data&quot;, doc.getData());</span>
            }
<span class="nc" id="L1139">        }</span>
        else
        {
<span class="fc" id="L1142">            request.setAttribute(&quot;doc_data&quot;, doc.getData());</span>
        }

<span class="pc bpc" id="L1145" title="3 of 4 branches missed.">        if (&quot;1&quot;.equals(request.getParameter(&quot;blogEdit&quot;)) &amp;&amp; user.getUserId() &gt; 0)</span>
        {
<span class="nc" id="L1147">            boolean canEdit = BlogTools.isEditable(group.getGroupId(), user);</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">            if (canEdit)</span>
            {
                //request.setAttribute(&quot;doc_data&quot;, &quot;!INCLUDE(/components/blog/blog_user_toolbar.jsp)!&quot;);
<span class="nc" id="L1151">                request.setAttribute(&quot;doc_data_blog&quot;, doc.getData());</span>
            }
        }

<span class="fc" id="L1155">        setRequestData(doc, group, docDB, groupsDB, request);</span>

<span class="fc bfc" id="L1157" title="All 4 branches covered.">        if (Tools.isNotEmpty(doc.getVirtualPath()) &amp;&amp; doc.getVirtualPath().contains(&quot;404.html&quot;))</span>
        {
<span class="fc" id="L1159">            request.setAttribute(&quot;404.allready.generated&quot;, &quot;true&quot;);</span>
<span class="fc" id="L1160">            response.setStatus(404);</span>
        }

<span class="pc bpc" id="L1163" title="1 of 6 branches missed.">        if (group.isForceTheUseOfGroupTemplate() || (inlineEditorAdmin &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;inlineEditingNewPage&quot;)))) {</span>
<span class="fc" id="L1164">            doc.setTempId(group.getTempId());</span>
        }
<span class="fc" id="L1166">        temp = tempDB.getTemplate(doc.getTempId());</span>

<span class="pc bpc" id="L1168" title="1 of 2 branches missed.">        if (temp == null)</span>
        {
<span class="nc" id="L1170">            StatDB.addError(request.getRequestURI()+&quot;?&quot;+request.getQueryString(), prop.getText(&quot;admin.showdoc_error_message.template_error&quot;));</span>
<span class="nc" id="L1171">            request.setAttribute(&quot;err_msg&quot;, prop.getText(&quot;admin.showdoc_default_error_message&quot;));</span>
            //request.setAttribute(&quot;err_msg&quot;, &quot;Poadovan dokument neexistuje - template error&quot;);
<span class="nc" id="L1173">            Adminlog.add(Adminlog.TYPE_RUNTIME_ERROR, &quot;Missing template for page: &quot;+doc.getDocId()+&quot;, required template id: &quot;+doc.getTempId(), doc.getDocId(), doc.getTempId());</span>
<span class="nc" id="L1174">            request.getRequestDispatcher(&quot;/404.jsp&quot;).forward(request, response);</span>
<span class="nc" id="L1175">            return;</span>
        }

        TemplateDetails tempBrowserDetector;
<span class="fc" id="L1179">        BrowserDetector bd = BrowserDetector.getInstance(request);</span>
        //skus najst sablonu podla BrowserDetector
<span class="fc" id="L1181">        tempBrowserDetector = tempDB.getTemplate(temp, bd);</span>
<span class="fc bfc" id="L1182" title="All 2 branches covered.">        if (tempBrowserDetector!=null)</span>
        {
            //ak existuje sablona napr. Homepage-phone, pouzi ju
<span class="fc" id="L1185">            temp = tempBrowserDetector;</span>
        }

<span class="fc" id="L1188">        doc.setTempName(temp.getTempName());</span>

        //nastavujem ContentLanguage podla sablony stranky
<span class="fc bfc" id="L1191" title="All 2 branches covered.">        String lng = Tools.isNotEmpty(group.getLng()) ? group.getLng() : temp.getLng();</span>
<span class="fc" id="L1192">        String lngParam = Tools.getParameter(request, &quot;language&quot;);</span>
<span class="pc bpc" id="L1193" title="1 of 2 branches missed.">        if (lngParam != null)</span>
        {
<span class="nc bnc" id="L1195" title="All 4 branches missed.">            if (lngParam.length()==2 || lngParam.length()==3) lng = lngParam;</span>
        }

<span class="fc" id="L1198">        PageLng.setUserLng(request, response, lng);</span>
        //force:false to allow owerwrite content-language by ResponseHeaders app
<span class="fc" id="L1200">        ResponseHeaderService.setContentLanguageHeader(PageLng.getUserLngIso(lng), false, request, response);</span>

<span class="fc" id="L1202">        setRequestData(temp, request);</span>

<span class="fc" id="L1204">        Logger.debug(this,&quot;normal temp=&quot;+temp.getTempId()+&quot; &quot;+temp.getTempName());</span>

<span class="pc bpc" id="L1206" title="1 of 2 branches missed.">        if (temp.getTempName().startsWith(&quot;nochange&quot;))</span>
        {
            try
            {
<span class="nc" id="L1210">                Integer iTempId = (Integer)session.getAttribute(&quot;last_temp_id&quot;);</span>
<span class="nc bnc" id="L1211" title="All 2 branches missed.">                if (iTempId!=null)</span>
                {
<span class="nc" id="L1213">                    TemplateDetails temp2 = tempDB.getTemplate(iTempId);</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">                    if (temp2!=null)</span>
                    {
<span class="nc" id="L1216">                        temp = temp2;</span>

<span class="nc bnc" id="L1218" title="All 2 branches missed.">                        if (temp.getTempName().startsWith(&quot;mainpage&quot;))</span>
                        {
<span class="nc" id="L1220">                            String name = temp.getTempName().substring(temp.getTempName().indexOf(' '));</span>
<span class="nc" id="L1221">                            temp2 = tempDB.getTemplate(name);</span>
<span class="nc" id="L1222">                            temp = temp2;</span>
                        }

                    }
                }
            }
<span class="nc" id="L1228">            catch (Exception ignored)</span>
            {
                //
<span class="nc" id="L1231">            }</span>
        }
        else
        {
            //popup okno si nepamatame...
<span class="pc bpc" id="L1236" title="1 of 2 branches missed.">            if (!temp.getTempName().startsWith(&quot;popup&quot;))</span>
            {
<span class="fc" id="L1238">                session.setAttribute(&quot;last_temp_id&quot;, temp.getTempId());</span>
            }
        }

        //Logger.println(this,&quot;session temp=&quot;+temp.getTempId()+&quot; &quot;+temp.getTempName());
<span class="fc" id="L1243">        List&lt;DocDetails&gt; localDocsInGroup = null;</span>

<span class="pc bpc" id="L1245" title="3 of 4 branches missed.">        if(Constants.getBoolean(&quot;templatesUseRecursiveSystemFolder&quot;) &amp;&amp; Constants.getBoolean(&quot;templatesUseDomainLocalSystemFolder&quot;))</span>
<span class="nc" id="L1246">            Logger.println(this,&quot;POZOR: templatesUseDomainLocalSystemFolder=true je ignorovane, vypni templatesUseDomainLocalSystemFolder&quot;);</span>

<span class="pc bpc" id="L1248" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;templatesUseDomainLocalSystemFolder&quot;))</span>
        {
<span class="fc" id="L1250">            GroupDetails localSystemGroup = GroupsDB.getInstance().getLocalSystemGroup();</span>
<span class="pc bpc" id="L1251" title="1 of 2 branches missed.">            if (localSystemGroup != null)</span>
            {
                //najdi rovnaky v aktualnom local priecinku
<span class="fc" id="L1254">                localDocsInGroup = WebpagesService.getBasicDocDetailsByGroupRecursive(localSystemGroup.getGroupId(), false);</span>
            }
<span class="fc" id="L1256">        }</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">        else if(Constants.getBoolean(&quot;templatesUseRecursiveSystemFolder&quot;))</span>
        {
<span class="nc" id="L1259">            GroupDetails systemFolder = GroupsDB.getInstance().getSystemGroupRecursive(doc.getGroupId());</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">            Logger.debug(ShowDoc.class, &quot;recursiveSystemFolder=&quot;+(systemFolder != null ? systemFolder.getGroupId() : &quot;null&quot;));</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">            if (systemFolder != null)</span>
            {
<span class="nc" id="L1263">                localDocsInGroup = WebpagesService.getBasicDocDetailsByGroupRecursive(systemFolder.getGroupId(), false);</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">                Logger.debug(ShowDoc.class, &quot;localDocsInGroup=&quot;+(localDocsInGroup != null ? localDocsInGroup.size() : &quot;null&quot;));</span>
            }
        }

<span class="pc bpc" id="L1268" title="3 of 4 branches missed.">        if (localDocsInGroup == null &amp;&amp; Tools.isNotEmpty(group.getLng())) {</span>
            //aj pre nelokalny system skus nacitat zoznam stranok v system/header a system/footer
<span class="nc" id="L1270">            localDocsInGroup = WebpagesService.getBasicDocDetailsByGroupRecursive(Constants.getInt(&quot;headerFooterGroupId&quot;), false);</span>
<span class="nc" id="L1271">            localDocsInGroup.addAll(WebpagesService.getBasicDocDetailsByGroupRecursive(Constants.getInt(&quot;menuGroupId&quot;), false));</span>
        }

<span class="fc" id="L1274">        setRequestDocData(&quot;doc_header&quot;, temp.getHeaderDocId(), temp.getHeaderDocData(), localDocsInGroup, request);</span>

<span class="fc" id="L1276">        setRequestDocData(&quot;doc_footer&quot;, temp.getFooterDocId(), temp.getFooterDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1277">        setRequestDocData(&quot;doc_menu&quot;, temp.getMenuDocId(), temp.getMenuDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1278">        setRequestDocData(&quot;doc_right_menu&quot;, temp.getRightMenuDocId(), temp.getRightMenuDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1279">        setRequestDocData(&quot;template_object_a&quot;, temp.getObjectADocId(), temp.getObjectADocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1280">        setRequestDocData(&quot;template_object_b&quot;, temp.getObjectBDocId(), temp.getObjectBDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1281">        setRequestDocData(&quot;template_object_c&quot;, temp.getObjectCDocId(), temp.getObjectCDocData(), localDocsInGroup, request);</span>
<span class="fc" id="L1282">        setRequestDocData(&quot;template_object_d&quot;, temp.getObjectDDocId(), temp.getObjectDDocData(), localDocsInGroup, request);</span>


<span class="fc bfc" id="L1285" title="All 2 branches covered.">        if (doc.getHeaderDocId() &gt; 0)</span>
        {
<span class="fc" id="L1287">            DocDetails dd_header = docDB.getDoc(doc.getHeaderDocId());</span>
<span class="pc bpc" id="L1288" title="1 of 2 branches missed.">            if (dd_header != null)</span>
            {
<span class="fc" id="L1290">                request.setAttribute(&quot;doc_header&quot;, dd_header.getData());</span>
            }
<span class="fc bfc" id="L1292" title="All 2 branches covered.">        } else if (doc.getHeaderDocId()==-2) {</span>
<span class="fc" id="L1293">            request.setAttribute(&quot;doc_header&quot;, &quot;&quot;);</span>
        }

<span class="pc bpc" id="L1296" title="1 of 2 branches missed.">        if (doc.getFooterDocId() &gt; 0)</span>
        {
<span class="nc" id="L1298">            DocDetails dd_footer = docDB.getDoc(doc.getFooterDocId());</span>
<span class="nc bnc" id="L1299" title="All 2 branches missed.">            if (dd_footer != null)</span>
            {
<span class="nc" id="L1301">                request.setAttribute(&quot;doc_footer&quot;, dd_footer.getData());</span>
            }
<span class="pc bfc" id="L1303" title="All 2 branches covered.">        } else if (doc.getFooterDocId()==-2) {</span>
<span class="fc" id="L1304">            request.setAttribute(&quot;doc_footer&quot;, &quot;&quot;);</span>
        }

<span class="fc bfc" id="L1307" title="All 2 branches covered.">        if (doc.getMenuDocId() &gt; 0)</span>
        {
<span class="fc" id="L1309">            DocDetails dd_menu = docDB.getDoc(doc.getMenuDocId());</span>
<span class="pc bpc" id="L1310" title="1 of 2 branches missed.">            if (dd_menu != null)</span>
            {
<span class="fc" id="L1312">                request.setAttribute(&quot;doc_menu&quot;, dd_menu.getData());</span>
            }
<span class="fc bfc" id="L1314" title="All 2 branches covered.">        } else if (doc.getMenuDocId()==-2) {</span>
<span class="fc" id="L1315">            request.setAttribute(&quot;doc_menu&quot;, &quot;&quot;);</span>
        }

<span class="fc bfc" id="L1318" title="All 2 branches covered.">        if (doc.getRightMenuDocId() &gt; 0)</span>
        {
<span class="fc" id="L1320">            DocDetails dd_menu = docDB.getDoc(doc.getRightMenuDocId());</span>
<span class="pc bpc" id="L1321" title="1 of 2 branches missed.">            if (dd_menu != null)</span>
            {
<span class="fc" id="L1323">                request.setAttribute(&quot;doc_right_menu&quot;, dd_menu.getData());</span>
            }
<span class="fc bfc" id="L1325" title="All 2 branches covered.">        } else if (doc.getRightMenuDocId()==-2) {</span>
<span class="fc" id="L1326">            request.setAttribute(&quot;doc_right_menu&quot;, &quot;&quot;);</span>
        }

        //firni event
<span class="fc" id="L1330">        showDocBean.setDoc(doc);</span>
<span class="fc" id="L1331">        showdocEvent = new WebjetEvent&lt;&gt;(showDocBean, WebjetEventType.ON_END);</span>
<span class="fc" id="L1332">		showdocEvent.publishEvent();</span>

        //uprav headre a footre
<span class="pc bpc" id="L1335" title="1 of 2 branches missed.">        if (request.getParameter(&quot;notemp&quot;) == null)</span>
        {
<span class="fc" id="L1337">            updateCodes(request, null, doc_id);</span>
        }

<span class="fc bfc" id="L1340" title="All 2 branches covered.">        if (!doc.isSearchable())</span>
        {
<span class="fc" id="L1342">            PathFilter.setXRobotsTagValue(&quot;NOT_SEARCHABLE_PAGE&quot;, response);</span>
        }

<span class="fc" id="L1345">        String forward = temp.getForward();</span>
<span class="fc" id="L1346">        boolean allowAdminForward = false;</span>

<span class="pc bpc" id="L1348" title="1 of 2 branches missed.">        if (request.getParameter(&quot;forumiframe&quot;) != null)</span>
        {
<span class="nc" id="L1350">            forward = &quot;/components/forum/iframe.jsp&quot;;</span>
<span class="nc" id="L1351">            allowAdminForward = true;</span>
        }
<span class="pc bpc" id="L1353" title="1 of 2 branches missed.">        if (request.getParameter(&quot;forwarddoccompare&quot;) != null)</span>
        {
<span class="nc" id="L1355">            forward = &quot;/admin/tmp_compare_blank.jsp&quot;;</span>
<span class="nc" id="L1356">            allowAdminForward = true;</span>
        }

<span class="pc bpc" id="L1359" title="1 of 4 branches missed.">        if (request.getParameter(&quot;forward&quot;) != null &amp;&amp; request.getParameter(&quot;forward&quot;).endsWith(&quot;.jsp&quot;))</span>
        {
<span class="nc" id="L1361">            forward = request.getParameter(&quot;forward&quot;);</span>
        }

<span class="pc bpc" id="L1364" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;springEnableShowdoc&quot;))</span>
        {
<span class="fc" id="L1366">            RequestBean requestBean = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L1367" title="1 of 2 branches missed.">            if (requestBean != null) {</span>
<span class="fc" id="L1368">                WebjetComponentParserInterface webjetComponentParser = requestBean.getSpringBean(&quot;webjetComponentParser&quot;, WebjetComponentParserInterface.class);</span>
<span class="pc bpc" id="L1369" title="1 of 2 branches missed.">                if (webjetComponentParser != null) {</span>
<span class="fc" id="L1370">                    webjetComponentParser.run(request, response);</span>
<span class="pc bpc" id="L1371" title="1 of 2 branches missed.">                    if (webjetComponentParser.isRedirected(response)) {</span>
<span class="nc" id="L1372">                        return;</span>
                    }
                }
            }
        }

<span class="fc" id="L1378">        BrowserDetector browser = BrowserDetector.getInstance(request);</span>
<span class="pc bpc" id="L1379" title="1 of 2 branches missed.">        if (browser.isAmp()) {</span>
<span class="nc" id="L1380">            Amp amp = new Amp(request);</span>
<span class="nc" id="L1381">            amp.replaceInRequest();</span>
        }

<span class="fc bfc" id="L1384" title="All 2 branches covered.">        if (inlineEditorAdmin) fixDataForInlineEditingAdmin(request, prop);</span>

        //forward na JSP s designom
<span class="pc bpc" id="L1387" title="1 of 4 branches missed.">        if (forward.toLowerCase().endsWith(&quot;.jsp&quot;) || forward.toLowerCase().endsWith(&quot;.html&quot;))</span>
        {
<span class="pc bpc" id="L1389" title="1 of 2 branches missed.">            if (allowAdminForward == false) {</span>
                //otestuj na nepovolene znaky
<span class="pc bpc" id="L1391" title="1 of 2 branches missed.">                if (FileBrowserTools.hasForbiddenSymbol(forward) )</span>
                {
<span class="nc" id="L1393">                    forward = &quot;tmp_generic.jsp&quot;;</span>
                }

<span class="fc" id="L1396">                request.setAttribute(&quot;template_forward&quot;, forward);</span>
<span class="pc bpc" id="L1397" title="1 of 2 branches missed.">                if (!temp.getForward().startsWith(&quot;/&quot;))</span>
                {
                    //skontroluj, ci sablona skutocne existuje

<span class="fc" id="L1401">                    forward = getForward(request, prop, tempBrowserDetector, bd, forward);</span>
<span class="pc bpc" id="L1402" title="1 of 2 branches missed.">                    if (forward == null) return;</span>

<span class="fc" id="L1404">                    Logger.debug(this,&quot;forward=&quot;+forward);</span>
                }

<span class="fc bfc" id="L1407" title="All 2 branches covered.">                if (forward.startsWith(&quot;/templates&quot;)==false) {</span>
<span class="fc" id="L1408">                    forward = &quot;/templates/&quot;+forward;</span>
                }
            }

<span class="fc" id="L1412">            IwcmFile forwardFile = getTemplateFile(forward);</span>
<span class="fc bfc" id="L1413" title="All 2 branches covered.">            if (!forwardFile.isFile())</span>
            {
<span class="fc" id="L1415">                Adminlog.add(Adminlog.TYPE_RUNTIME_ERROR, &quot;Missing template for page: &quot;+doc.getDocId()+&quot;, required template file: &quot;+forward, doc.getDocId(), doc.getTempId());</span>
<span class="fc" id="L1416">                forward = &quot;/404.jsp&quot;;</span>
            }

<span class="fc bfc" id="L1419" title="All 2 branches covered.">            if (forward.toLowerCase().endsWith(&quot;.html&quot;)) {</span>
<span class="fc" id="L1420">                request.setAttribute(&quot;thymeleafTemplateFile&quot;, forwardFile.getVirtualPath());</span>
<span class="fc" id="L1421">                forward = &quot;/thymeleaf/showdoc&quot;;</span>
            }

<span class="fc" id="L1424">            request.getRequestDispatcher(forward).forward(request, response);</span>
        }
<span class="fc" id="L1426">    }</span>

    /**
     * Modifikuje existujuce request objekty pre inline editaciu v administracii
     * @param request
     */
    private void fixDataForInlineEditingAdmin(HttpServletRequest request, Prop prop) {
<span class="fc bfc" id="L1433" title="All 2 branches covered.">        if (&quot;true&quot;.equals(request.getParameter(&quot;inlineEditingNewPage&quot;))) {</span>
            //jedna sa o novu stranku, ale fejkujeme to hlavnou strankou adresara
            //zmazeme povodne doc_data
<span class="fc" id="L1436">            request.setAttribute(&quot;doc_data&quot;, &quot;&quot;);</span>
<span class="fc" id="L1437">            request.setAttribute(&quot;title&quot;, prop.getText(&quot;editor.newDocumentName&quot;));</span>
        }
        //toto nepotrebujeme posielat, injectuje sa to v inline_page_toolbar.jsp
<span class="fc" id="L1440">        request.setAttribute(&quot;doc_data&quot;, &quot;&quot;);</span>
<span class="fc" id="L1441">        request.setAttribute(&quot;doc_header&quot;, &quot;&quot;);</span>
<span class="fc" id="L1442">        request.setAttribute(&quot;doc_footer&quot;, &quot;&quot;);</span>
<span class="fc" id="L1443">        request.setAttribute(&quot;doc_menu&quot;, &quot;&quot;);</span>
<span class="fc" id="L1444">        request.setAttribute(&quot;doc_right_menu&quot;, &quot;&quot;);</span>
<span class="fc" id="L1445">        request.setAttribute(&quot;template_object_a&quot;, &quot;&quot;);</span>
<span class="fc" id="L1446">        request.setAttribute(&quot;template_object_b&quot;, &quot;&quot;);</span>
<span class="fc" id="L1447">        request.setAttribute(&quot;template_object_c&quot;, &quot;&quot;);</span>
<span class="fc" id="L1448">        request.setAttribute(&quot;template_object_d&quot;, &quot;&quot;);</span>
<span class="fc" id="L1449">        request.setAttribute(&quot;perex_data&quot;, &quot;&quot;);</span>
<span class="fc" id="L1450">    }</span>

    private void removeForumFromPerex(HttpServletRequest request, DocDetails doc, String perex) {
        try
        {
<span class="nc" id="L1455">            int start = doc.getData().indexOf(&quot;!INCLUDE(/components/forum/forum.jsp&quot;);</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">            if (start != -1)</span>
            {
<span class="nc" id="L1458">                int end = doc.getData().indexOf(&quot;)!&quot;, start);</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">                if (end &gt; start)</span>
                {
<span class="nc" id="L1461">                    perex += doc.getData().substring(start, end+2);</span>
                }
            }
        }
<span class="nc" id="L1465">        catch (Exception ex)</span>
        {
<span class="nc" id="L1467">            Logger.error(ShowDoc.class, ex);</span>
<span class="nc" id="L1468">        }</span>

<span class="nc" id="L1470">        request.setAttribute(&quot;doc_data&quot;, perex);</span>
<span class="nc" id="L1471">    }</span>

    private String getForward(HttpServletRequest request, Prop prop, TemplateDetails tempBrowserDetector, BrowserDetector bd, String forward) {
        try {
            //ak mame sablonu pre browserDevice, uz nehladame iny JSP subor pre forward
<span class="pc bpc" id="L1476" title="1 of 4 branches missed.">            if (tempBrowserDetector != null &amp;&amp; tempBrowserDetector.getTempId() &gt; 0) bd = null;</span>

<span class="pc bpc" id="L1478" title="1 of 2 branches missed.">            if (Tools.isNotEmpty(Constants.getLogInstallName()))</span>
            {
<span class="nc" id="L1480">                File f = TemplatesDB.getDeviceTemplateFile(new File(Tools.getRealPath(&quot;/templates/&quot; + Constants.getLogInstallName())), forward, bd);</span>
<span class="nc bnc" id="L1481" title="All 2 branches missed.">                if (f.exists()) {</span>
<span class="nc" id="L1482">                    Logger.debug(ShowDoc.class, &quot;___FORWARDFILE (logInstallName)=&quot;+ f.getAbsolutePath());</span>
<span class="nc" id="L1483">                    return &quot;/templates/&quot; + Constants.getLogInstallName() + &quot;/&quot; + forward;</span>
                }
            }

<span class="fc" id="L1487">            File f = TemplatesDB.getDeviceTemplateFile(new File(Tools.getRealPath(&quot;/templates/&quot; + Constants.getInstallName())), forward, bd);</span>
<span class="fc bfc" id="L1488" title="All 2 branches covered.">            if (f.exists()) {</span>
<span class="fc" id="L1489">                Logger.debug(ShowDoc.class, &quot;___FORWARDFILE (installName)=&quot;+ f.getAbsolutePath());</span>
<span class="fc" id="L1490">                return &quot;/templates/&quot; + Constants.getInstallName() + &quot;/&quot; + forward;</span>
            }

<span class="fc" id="L1493">            f = TemplatesDB.getDeviceTemplateFile(new File(Tools.getRealPath(&quot;/templates/&quot;)), forward, bd);</span>
<span class="pc bpc" id="L1494" title="1 of 2 branches missed.">            if (!f.exists()) {</span>
<span class="fc" id="L1495">                StatDB.addError(request.getRequestURI() + &quot;?&quot; + request.getQueryString(), prop.getText(&quot;admin.showdoc_error_message.template&quot;) + &quot; &quot; + forward + &quot; &quot; + prop.getText(&quot;admin.showdoc_error_message.not_exists&quot;) + &quot;!&quot;);</span>
<span class="fc" id="L1496">                Logger.error(this, prop.getText(&quot;admin.showdoc_error_message.template&quot;) + &quot; /templates/&quot; + forward + &quot; &quot; + prop.getText(&quot;admin.showdoc_error_message.not_exists=&quot;) + &quot;!&quot;);</span>
                //sablona neexistuje, asi som na testovacom serveri u jeeffa...

<span class="fc" id="L1499">                forward = &quot;tmp_generic.jsp&quot;;</span>
            }
            // else zrusene, aby islo zadat forward aj s adresarom forward = f.getName();
<span class="nc" id="L1502">        } catch (Exception e) {</span>
<span class="nc" id="L1503">            Logger.error(ShowDoc.class, e);</span>
<span class="fc" id="L1504">        }</span>
<span class="fc" id="L1505">        return forward;</span>
    }


    /**
     * Vrati lokalne doc_data pre zadane doc_id (hlada napr. hlavicku v lokalnom System adresari pre danu domenu)
     */
    private static void setRequestDocData(String name, int defaultDocId, String defaultData, List&lt;DocDetails&gt; localDocsInGroup, HttpServletRequest request)
    {
<span class="fc" id="L1514">        DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L1515">        DocDetails originalDoc = docDB.getBasicDocDetails(defaultDocId, false);</span>

<span class="pc bpc" id="L1517" title="1 of 4 branches missed.">        if (originalDoc != null &amp;&amp; localDocsInGroup != null)</span>
        {
<span class="fc" id="L1519">            String groupLng = (String)request.getAttribute(&quot;group_lng&quot;);</span>

<span class="fc" id="L1521">            DocDetails foundDoc = null;</span>
<span class="fc bfc" id="L1522" title="All 2 branches covered.">            if (Tools.isNotEmpty(groupLng))</span>
            {
                //ak je nastaveny jazyk adresara, tak najprv kontrolujem jazykovu zhodu bud ako prefix jazyk + medzera napr. &quot;EN header&quot;, alebo ako suffix pomlcka+jazyk napr. &quot;header-DE&quot;
<span class="fc bfc" id="L1525" title="All 2 branches covered.">                for (DocDetails localDoc : localDocsInGroup)</span>
                {
<span class="pc bpc" id="L1527" title="1 of 2 branches missed.">                    if (localDoc.getTitle().equalsIgnoreCase(groupLng+&quot; &quot;+originalDoc.getTitle()) ||</span>
<span class="pc bpc" id="L1528" title="1 of 2 branches missed.">                            localDoc.getTitle().equalsIgnoreCase(groupLng+&quot;-&quot;+originalDoc.getTitle()) ||</span>
<span class="pc bpc" id="L1529" title="1 of 2 branches missed.">                            localDoc.getTitle().equalsIgnoreCase(originalDoc.getTitle()+&quot;-&quot;+groupLng))</span>
                    {
<span class="nc" id="L1531">                        foundDoc = localDoc;</span>
<span class="nc" id="L1532">                        break;</span>
                    }
                    //ak mame nastavenu SK-Default hlavicka, skus odstranit SK- a porovnat ako EN-Default hlavicka
<span class="fc" id="L1535">                    String originalTitle = originalDoc.getTitle();</span>
<span class="pc bpc" id="L1536" title="4 of 6 branches missed.">                    if (originalTitle.length()&gt;4 &amp;&amp; originalTitle.charAt(2)=='-' &amp;&amp; localDoc.getTitle().equalsIgnoreCase(groupLng+&quot;-&quot;+originalTitle.substring(3))) {</span>
<span class="nc" id="L1537">                        foundDoc = localDoc;</span>
<span class="nc" id="L1538">                        break;</span>
                    }
<span class="fc" id="L1540">                }</span>
            }

            //ak nie je nastaveny jazyk, postupujem ako predtym a hladam na zaklade zhody titulov stranok
<span class="pc bpc" id="L1544" title="1 of 2 branches missed.">            if(foundDoc == null)</span>
            {
<span class="fc bfc" id="L1546" title="All 2 branches covered.">                for (DocDetails localDoc : localDocsInGroup)</span>
                {
<span class="pc bpc" id="L1548" title="1 of 4 branches missed.">                    if(localDoc.getDocId()!=defaultDocId &amp;&amp; localDoc.getTitle().equalsIgnoreCase(originalDoc.getTitle()))</span>
                    {
<span class="nc" id="L1550">                        foundDoc = localDoc;</span>
<span class="nc" id="L1551">                        break;</span>
                    }
<span class="fc" id="L1553">                }</span>
            }

<span class="pc bpc" id="L1556" title="1 of 2 branches missed.">            if(foundDoc != null)</span>
            {
<span class="nc" id="L1558">                String docData = foundDoc.getData();</span>
<span class="nc bnc" id="L1559" title="All 2 branches missed.">                if (Tools.isEmpty(docData))</span>
                {
<span class="nc" id="L1561">                    foundDoc = docDB.getDocAndAddToCacheIfNot(foundDoc.getDocId());</span>
<span class="nc" id="L1562">                    docData = foundDoc.getData();</span>
                }
<span class="nc bnc" id="L1564" title="All 4 branches missed.">                if (Tools.isNotEmpty(docData) || &quot;cloud&quot;.equals(Constants.getInstallName()))</span>
                {
                    //v cloude chceme zobrazit userovu paticku aj ked v nej zmazal text (chce ju mat prazdnu)
<span class="nc" id="L1567">                    defaultData = docData;</span>
<span class="nc" id="L1568">                    defaultDocId = foundDoc.getDocId();</span>
<span class="nc" id="L1569">                    request.setAttribute(name+&quot;-docDetails&quot;, foundDoc);</span>
                }
            }
        }

<span class="fc bfc" id="L1574" title="All 2 branches covered.">        if (request.getSession().getAttribute(Constants.USER_KEY)!=null)</span>
        {
            //ak je prihlaseny user setni objekt aby isla inline editacia inych objektov ako doc_data
<span class="fc" id="L1577">            request.setAttribute(name+&quot;-docDetails&quot;, originalDoc);</span>
        }

        //nastav aj hodnotu docId pre inline editaciu
<span class="fc" id="L1581">        request.setAttribute(name, defaultData);</span>
<span class="fc" id="L1582">        request.setAttribute(name+&quot;-docId=&quot;, defaultDocId);</span>
<span class="fc" id="L1583">    }</span>


    /**
     *  Aktualizuje kody v request (doc_header, doc_footer, doc_menu, doc_data)
     *
     *@param  request HttpServletRequest
     *@param  servletContext ServletContext
     *@param  docId int
     */
    public static void updateCodes(HttpServletRequest request, ServletContext servletContext, int docId)
    {
        try
        {
<span class="fc" id="L1597">            HttpSession session = request.getSession();</span>
<span class="fc" id="L1598">            Identity user = null;</span>
            try
            {
                //ziskaj meno lognuteho usera
<span class="fc bfc" id="L1602" title="All 2 branches covered.">                if (session.getAttribute(Constants.USER_KEY) != null)</span>
                {
<span class="fc" id="L1604">                    user = (Identity) session.getAttribute(Constants.USER_KEY);</span>
                }
            }
<span class="nc" id="L1607">            catch (Exception ex)</span>
            {
<span class="nc" id="L1609">                Logger.error(ShowDoc.class, ex);</span>
<span class="fc" id="L1610">            }</span>

            // ------------ HEADER
<span class="fc" id="L1613">            String text = (String) request.getAttribute(&quot;doc_header&quot;);</span>
<span class="pc bpc" id="L1614" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1616">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }

<span class="fc" id="L1619">            request.setAttribute(&quot;doc_header&quot;, text);</span>

            // ------------------ FOOTER
<span class="fc" id="L1622">            text = (String) request.getAttribute(&quot;doc_footer&quot;);</span>
<span class="pc bpc" id="L1623" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1625">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }
<span class="fc" id="L1627">            request.setAttribute(&quot;doc_footer&quot;, text);</span>

            // ------------------ MENU
<span class="fc" id="L1630">            text = (String) request.getAttribute(&quot;doc_menu&quot;);</span>
<span class="pc bpc" id="L1631" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1633">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }
<span class="fc" id="L1635">            request.setAttribute(&quot;doc_menu&quot;, text);</span>

            // ------------------ MENU RIGHT
<span class="fc" id="L1638">            text = (String) request.getAttribute(&quot;doc_right_menu&quot;);</span>
<span class="pc bpc" id="L1639" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1641">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }
<span class="fc" id="L1643">            request.setAttribute(&quot;doc_right_menu&quot;, text);</span>

            // ------------------ html_data
<span class="fc" id="L1646">            text = (String) request.getAttribute(&quot;html_data&quot;);</span>
<span class="pc bpc" id="L1647" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1649">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }
<span class="fc" id="L1651">            request.setAttribute(&quot;html_data&quot;, text);</span>

            // ------------------ DOC
<span class="fc" id="L1654">            text = (String) request.getAttribute(&quot;doc_data&quot;);</span>
<span class="pc bpc" id="L1655" title="1 of 2 branches missed.">            if (text != null)</span>
            {
<span class="fc" id="L1657">                text = ShowDoc.updateCodes(user, text, docId, request, servletContext);</span>
            }

<span class="fc" id="L1660">            request.setAttribute(&quot;doc_data&quot;, text);</span>
        }
<span class="nc" id="L1662">        catch (Exception ignored)</span>
        {
            //
<span class="fc" id="L1665">        }</span>
<span class="fc" id="L1666">    }</span>




    private IwcmFile getTemplateFile(String template)
    {
<span class="fc" id="L1673">        return new IwcmFile(Tools.getRealPath(template));</span>
    }

    public static void setActualUserHash(String hash) {
<span class="nc" id="L1677">        ShowDoc.ACTUAL_USER_HASH = hash;</span>
<span class="nc" id="L1678">    }</span>

    /**
     * Test if doShowdocAction request parameter is allowed/valid
     * @param doShowdocAction
     * @return
     */
    public static boolean isDoShowdocActionAllowed(String doShowdocAction) {
<span class="pc bpc" id="L1686" title="4 of 10 branches missed.">        if (doShowdocAction != null &amp;&amp; doShowdocAction.length()&gt;3 &amp;&amp; !doShowdocAction.contains(&quot;WEB-INF&quot;) &amp;&amp; doShowdocAction.endsWith(&quot;.do&quot;) &amp;&amp; !doShowdocAction.contains(&quot;/admin/&quot;)) {</span>
<span class="fc" id="L1687">         return true;</span>
        }
<span class="fc" id="L1689">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>