<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GalleryDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.gallery</a> &gt; <span class="el_source">GalleryDB.java</span></div><h1>GalleryDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.gallery;

import static sk.iway.iwcm.Tools.isEmpty;

import java.awt.Dimension;
import java.awt.Graphics2D;
import java.awt.Image;
import java.awt.image.BufferedImage;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.Enumeration;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Random;
import java.util.StringTokenizer;

import javax.imageio.IIOImage;
import javax.imageio.ImageIO;
import javax.imageio.ImageWriteParam;
import javax.imageio.ImageWriter;
import javax.imageio.plugins.jpeg.JPEGImageWriteParam;
import javax.imageio.stream.ImageOutputStream;
import javax.servlet.ServletContext;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import com.drew.imaging.ImageMetadataReader;
import com.drew.metadata.Directory;
import com.drew.metadata.Metadata;
import com.drew.metadata.Tag;

import org.apache.commons.io.FileUtils;
import org.apache.commons.lang.StringUtils;
import org.apache.struts.util.ResponseUtils;

import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Cache;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.FileTools;
import sk.iway.iwcm.InitServlet;
import sk.iway.iwcm.LabelValueDetails;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PkeyGenerator;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.GalleryDBTools;
import sk.iway.iwcm.common.GalleryToolsForCore;
import sk.iway.iwcm.components.gallery.GalleryService;
import sk.iway.iwcm.database.ComplexQuery;
import sk.iway.iwcm.database.Mapper;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DebugTimer;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.filebrowser.FileDirBean;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmFileFilter;
import sk.iway.iwcm.io.IwcmFsDB;
import sk.iway.iwcm.io.IwcmInputStream;
import sk.iway.iwcm.io.IwcmOutputStream;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.metadata.MetadataCleaner;
import sk.iway.spirit.MediaDB;

/**
 * Praca s FotoGaleriou
 *
 *@Title WebJET
 *@Company Interway s.r.o. (www.interway.sk)
 *@Copyright Interway s.r.o. (c) 2001-2002
 *@author unascribed
 *@version 1.0
 *@created Nedeďż˝e, 2003, mďż˝j 18
 *@modified $Date: 2004/03/12 10:16:32 $
 */
public class GalleryDB
{

<span class="fc" id="L104">	public static final List&lt;String&gt; LANGUAGES = Arrays.asList(&quot;sk&quot;, &quot;cz&quot;, &quot;de&quot;, &quot;en&quot;, &quot;pl&quot;, &quot;ru&quot;, &quot;cho&quot;, &quot;esp&quot;, &quot;hu&quot;); //NOSONAR</span>
	public static final String DATE_FROM_SESSION_FILTER = &quot;date_from_filter&quot;;
	public static final String DATE_TO_SESSION_FILTER = &quot;date_to_filter&quot;;

<span class="fc" id="L108">	private static final Random rand = new Random();</span>

<span class="nc" id="L110">	protected GalleryDB() {</span>
		//utility class
<span class="nc" id="L112">	}</span>

<span class="fc" id="L114">	private static final Mapper&lt;GalleryDimension&gt; dimensionMapper = new Mapper&lt;GalleryDimension&gt;()</span>
<span class="fc" id="L115">	{</span>
		@Override
		public GalleryDimension map(ResultSet rs) throws SQLException
		{
<span class="fc" id="L119">			GalleryDimension gallery = new GalleryDimension();</span>

<span class="fc" id="L121">			gallery.setGalleryId(rs.getInt(&quot;dimension_id&quot;));</span>
<span class="fc" id="L122">			gallery.setGalleryPath(rs.getString(&quot;image_path&quot;));</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">			gallery.setGalleryName((rs.getString(&quot;gallery_name&quot;) != null) ? (rs.getString(&quot;gallery_name&quot;)) : &quot;&quot;);</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">			gallery.setGalleryPerex((rs.getString(&quot;gallery_perex&quot;) != null) ? (rs.getString(&quot;gallery_perex&quot;)) : &quot;&quot;);</span>
<span class="fc" id="L125">			gallery.setGalleryDate(rs.getTimestamp(&quot;create_date&quot;));</span>
<span class="fc" id="L126">			gallery.setGalleryViews(rs.getInt(&quot;views&quot;));</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">			gallery.setAuthor((rs.getString(&quot;author&quot;) != null) ? (rs.getString(&quot;author&quot;)) : &quot;&quot;);</span>
<span class="fc" id="L128">			gallery.setWatermark(rs.getString(&quot;watermark&quot;));</span>
<span class="fc" id="L129">			gallery.setWatermarkPlacement(rs.getString(&quot;watermark_placement&quot;));</span>
<span class="fc" id="L130">			gallery.setWatermarkSaturation(rs.getInt(&quot;watermark_saturation&quot;));</span>
<span class="fc" id="L131">			return gallery;</span>
		}
	};

	/**
	 * ziska z jazyka priponu pre nacitanie z databazy
	 *
	 * @param lng
	 * @param request
	 * @return
	 */
	public static String getLngAdd(String lng, HttpServletRequest request)
	{
<span class="fc" id="L144">		String lngAdd = &quot;_sk&quot;;</span>
<span class="pc bpc" id="L145" title="5 of 8 branches missed.">		if (lng == null || (lng.length() != 2 &amp;&amp; !&quot;esp&quot;.equals(lng) &amp;&amp; !&quot;cho&quot;.equals(lng)) )</span>
		{
<span class="fc" id="L147">			lng = Constants.getString(&quot;defaultLanguage&quot;);</span>
		}
<span class="fc" id="L149">		lng = lng.replace('\'', ' ');</span>
<span class="fc" id="L150">		lng = lng.replace(';', ' ');</span>
		// podpora je iba pre tieto jazyky
<span class="fc bfc" id="L152" title="All 2 branches covered.">		if (!LANGUAGES.contains(lng) )</span>
		{
<span class="fc" id="L154">			lng = &quot;sk&quot;;</span>
		}
<span class="pc bpc" id="L156" title="3 of 4 branches missed.">		if (lng.length() == 2 || lng.length() == 3)</span>
		{
<span class="fc" id="L158">			lngAdd = &quot;_&quot; + lng.toLowerCase();</span>
		}
<span class="fc" id="L160">		return (lngAdd);</span>
	}

	public static Collection&lt;IwcmFile&gt; getImagesFromDir(String basePath, boolean alsoSubfolders){
<span class="nc" id="L164">			return getFilesFromDir(basePath, alsoSubfolders, listFiles(basePath));</span>
	}

	/**
	 * Pripravi zoznam suborov v adresari, aby sa to dalo opakovane pouzit
	 * @param basePath
	 * @return
	 */
	private static IwcmFile[] listFiles(String basePath)
	{
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">		if (basePath.endsWith(&quot;/&quot;))</span>
		{
<span class="nc" id="L176">			basePath = basePath.substring(0, basePath.length() - 1);</span>
		}

<span class="fc" id="L179">		String realPath = Tools.getRealPath(basePath);</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">		if (realPath != null)</span>
		{
<span class="fc" id="L182">			IwcmFile file = new IwcmFile(realPath);</span>
			try
			{
<span class="fc bfc" id="L185" title="All 2 branches covered.">				if (isDirectoryFast(file))</span>
				{
<span class="fc" id="L187">					IwcmFile[] files = file.listFiles(new IwcmFileFilter()</span>
<span class="fc" id="L188">					{</span>
						@Override
						public boolean accept(IwcmFile file)
						{
<span class="pc bpc" id="L192" title="1 of 4 branches missed.">							return (isImageFast(file) || isDirectoryFast(file));</span>
						}
					});
<span class="fc" id="L195">					return files;</span>
				}
			}
<span class="nc" id="L198">			catch (Exception e)</span>
			{
<span class="nc" id="L200">				sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L201">			}</span>
		}

<span class="fc" id="L204">		return new IwcmFile[0];</span>
	}

	/**
	 * Rekurzivne prehlada adresare a naplni Map s File objektami
	 *
	 *@param mainDir - adresar, ktory chceme rekurzivne prehladat
	 *@param hTable - Map, do ktorej budu pridane vsetky subory obrazkov z podadresarov
	 *@return
	 */
	private static List&lt;IwcmFile&gt; getFilesFromDir(String basePath, boolean alsoSubfolders, IwcmFile[] files)
	{
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">		if (basePath.endsWith(&quot;/&quot;))</span>
		{
<span class="nc" id="L218">			basePath = basePath.substring(0, basePath.length() - 1);</span>
		}

<span class="fc" id="L221">		boolean noMiniatures = false;</span>
<span class="fc" id="L222">		String resizeMode = getResizeMode(basePath, true);</span>
<span class="pc bpc" id="L223" title="2 of 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
<span class="nc" id="L224">			noMiniatures = true;</span>

<span class="fc" id="L226">		List&lt;IwcmFile&gt; fileList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L227">		HashSet&lt;String&gt; origFileNames = new HashSet&lt;&gt;();</span>
<span class="fc" id="L228">		int size = files.length;</span>

		//ak sa nemaju nachadzat zmenseniny, nepotrebujeme kontrolovat origName
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">		if(!noMiniatures)</span>
		{
<span class="fc bfc" id="L233" title="All 2 branches covered.">			for (int i = 0; i &lt; size; i++)</span>
			{
<span class="fc" id="L235">				IwcmFile file = files[i];</span>
<span class="fc bfc" id="L236" title="All 4 branches covered.">				if (isDirectoryFast(file)==false &amp;&amp; file.getName().startsWith(&quot;o_&quot;))</span>
				{
<span class="fc" id="L238">					origFileNames.add(file.getName());</span>
				}
			}
		}

<span class="fc bfc" id="L243" title="All 2 branches covered.">		for (int i = 0; i &lt; size; i++)</span>
		{
<span class="fc" id="L245">			IwcmFile file = files[i];</span>
<span class="pc bpc" id="L246" title="3 of 4 branches missed.">			if (alsoSubfolders &amp;&amp; isDirectoryFast(file))</span>
			{
<span class="nc" id="L248">				String subDir = basePath + &quot;/&quot; + file.getName();</span>
<span class="nc" id="L249">				fileList.addAll(getFilesFromDir(subDir, alsoSubfolders, listFiles(subDir)));</span>
<span class="nc" id="L250">			}</span>
			else
			{
				//ak vyberame o_image.jpg namiesto image.jpg
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">				if(noMiniatures)</span>
				{
<span class="nc bnc" id="L256" title="All 2 branches missed.">					if (isImageFast(file))</span>
					{
<span class="nc" id="L258">						fileList.add(file);</span>
					}
				}
<span class="pc bpc" id="L261" title="1 of 6 branches missed.">				else if (file.getName().startsWith(&quot;s_&quot;)==false &amp;&amp; file.getName().startsWith(&quot;o_&quot;)==false &amp;&amp; file.getName().startsWith(&quot;_tmp_o_&quot;)==false)</span>
				{
					//pridame iba obrazky ktore maju o_ verziu
<span class="pc bpc" id="L264" title="3 of 6 branches missed.">					if (isImageFast(file) &amp;&amp; (origFileNames.contains(&quot;o_&quot;+file.getName()) || Constants.getBoolean(&quot;imageAlwaysCreateGalleryBean&quot;) ))</span>
					{
<span class="fc" id="L266">						fileList.add(file);</span>
					}
				}
			}
		}

<span class="fc" id="L272">		return fileList;</span>
	}

	/**
	 * Vrati HashTabluku so zaznamami z databazy pre zadany adresar a jeho podadresare
	 * @param dir
	 * @return
	 */
	public static Map&lt;String, GalleryBean&gt; getGalleryBeanTable(String dir, String lng, boolean alsoSubfolders)
	{
<span class="pc bpc" id="L282" title="2 of 4 branches missed.">		if (dir.length()&gt;2 &amp;&amp; dir.endsWith(&quot;/&quot;))</span>
		{
			//odstran koncove lomitko
<span class="nc" id="L285">			dir = dir.substring(0, dir.length()-1);</span>
		}

<span class="fc" id="L288">		Map&lt;String, GalleryBean&gt; gBeanTable = new Hashtable&lt;&gt;();</span>
		GalleryBean gBean;
<span class="fc" id="L290">		Connection db_conn = null;</span>
<span class="fc" id="L291">		PreparedStatement ps = null;</span>
<span class="fc" id="L292">		ResultSet rs = null;</span>
		try
		{
<span class="fc" id="L295">			db_conn = DBPool.getConnection();</span>

<span class="fc bfc" id="L297" title="All 2 branches covered.">			if (alsoSubfolders)</span>
			{
<span class="fc" id="L299">				ps = db_conn.prepareStatement(&quot;SELECT * FROM gallery WHERE image_path LIKE ? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L300">				ps.setString(1, dir + &quot;%&quot;);</span>
			}
			else
			{
<span class="fc" id="L304">				ps = db_conn.prepareStatement(&quot;SELECT * FROM gallery WHERE image_path=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L305">				ps.setString(1, dir);</span>
			}
<span class="fc" id="L307">			rs = ps.executeQuery();</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">			while (rs.next())</span>
			{
<span class="fc" id="L310">				gBean = new GalleryBean();</span>
<span class="fc" id="L311">				gBean.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="fc" id="L312">				gBean.setImageName(DB.getDbString(rs, &quot;image_name&quot;));</span>
<span class="fc" id="L313">				gBean.setImagePath(DB.getDbString(rs, &quot;image_path&quot;));</span>
<span class="fc" id="L314">				gBean.setLongDescription(DB.getDbString(rs, &quot;l_description&quot; + lng));</span>
<span class="fc" id="L315">				gBean.setShortDescription(DB.getDbString(rs, &quot;s_description&quot; + lng));</span>
<span class="fc" id="L316">				gBean.setAuthor(rs.getString(&quot;author&quot;));</span>
<span class="fc" id="L317">				gBean.setSendCount(rs.getInt(&quot;send_count&quot;));</span>
<span class="fc" id="L318">				gBean.setAllowedDomains(rs.getString(&quot;allowed_domains&quot;));</span>
<span class="fc" id="L319">				gBean.setPerexGroup(convertPerexGroupString(rs.getString(&quot;perex_group&quot;)));</span>
<span class="fc" id="L320">				gBean.setUploadDate(DB.getDate(rs, &quot;upload_datetime&quot;));</span>
<span class="fc" id="L321">				gBean.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>
<span class="fc" id="L322">				gBeanTable.put(gBean.getImageUrl(), gBean);</span>
			}

<span class="fc" id="L325">			rs.close();</span>
<span class="fc" id="L326">			ps.close();</span>
<span class="fc" id="L327">			db_conn.close();</span>
<span class="fc" id="L328">			rs = null;</span>
<span class="fc" id="L329">			ps = null;</span>
<span class="fc" id="L330">			db_conn = null;</span>
		}
<span class="nc" id="L332">		catch (Exception ex)</span>
		{
<span class="nc" id="L334">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L341">					rs.close();</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L343">					ps.close();</span>
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L345">					db_conn.close();</span>
			}
<span class="nc" id="L347">			catch (Exception ex2)</span>
			{
<span class="nc" id="L349">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="fc" id="L350">			}</span>
		}

<span class="fc" id="L353">		return gBeanTable;</span>
	}

	/**
	 * Skonvertuje list suborov na list GalleryBeanov, ak pre zadanu cestu nenajde GalleryBean z databazy spravi prazdny
	 * @param fileList
	 * @param gBeanTable
	 * @return
	 */
	private static List&lt;GalleryBean&gt; convertFilesToGbean(List&lt;IwcmFile&gt; fileList, Map&lt;String, GalleryBean&gt; gBeanTable)
	{
<span class="fc" id="L364">		List&lt;GalleryBean&gt; gBeanList = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L366" title="All 2 branches covered.">		for (IwcmFile file : fileList)</span>
		{
<span class="fc" id="L368">			String virtualPath = file.getVirtualPath();</span>
<span class="fc" id="L369">			String fileName = file.getName();</span>
<span class="pc bpc" id="L370" title="3 of 4 branches missed.">			if(fileName.startsWith(&quot;o_&quot;) &amp;&amp; fileName.length()&gt;2)</span>
			{
<span class="nc" id="L372">				int index = virtualPath.lastIndexOf(fileName);</span>
<span class="nc" id="L373">				virtualPath = new StringBuilder(virtualPath).replace(index, index+fileName.length()+1,fileName.substring(2)).toString();</span>
			}
<span class="fc" id="L375">			GalleryBean gb = gBeanTable.get(virtualPath);</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">			if (gb == null)</span>
			{
<span class="fc" id="L378">				gb = new GalleryBean();</span>
<span class="fc" id="L379">				gb.setImageId(-1);</span>
<span class="fc" id="L380">				gb.setAuthor(&quot;&quot;);</span>
<span class="fc" id="L381">				gb.setImageName(file.getName());</span>
<span class="fc" id="L382">				gb.setImagePath(file.getVirtualParent());</span>
<span class="fc" id="L383">				gb.setLongDescription(&quot;&quot;);</span>
<span class="fc" id="L384">				gb.setShortDescription(&quot;&quot;);</span>
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)==false) gb.setUploadDate(new Date(file.lastModified()));</span>
			}
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">			else if (file.getName().startsWith(&quot;o_&quot;))</span>
			{
<span class="nc" id="L389">				gb.setImageName(file.getName());</span>
			}
<span class="fc" id="L391">			gBeanList.add(gb);</span>
<span class="fc" id="L392">		}</span>

<span class="fc" id="L394">		return gBeanList;</span>
	}

	private static List&lt;GalleryBean&gt; filterByPerexGroups(List&lt;GalleryBean&gt; gBeanList, String perexGroupIds)
	{
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">		if (Tools.isEmpty(perexGroupIds)) return gBeanList;</span>

<span class="nc" id="L401">		List&lt;GalleryBean&gt; filtered = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L403">		String[] pgids = convertPerexGroupString(perexGroupIds);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">		for (GalleryBean gb : gBeanList)</span>
		{
<span class="nc bnc" id="L406" title="All 4 branches missed.">			if (gb.getPerexGroup()==null || gb.getPerexGroup().length==0) continue;</span>

<span class="nc bnc" id="L408" title="All 2 branches missed.">			if (Tools.containsOneItem(pgids, gb.getPerexGroup()))</span>
			{
<span class="nc" id="L410">				filtered.add(gb);</span>
			}
<span class="nc" id="L412">		}</span>

<span class="nc" id="L414">		return filtered;</span>
	}

	/**
	 * @deprecated pouzite getImages
	 * @param dir
	 * @param servletContext
	 * @param request
	 * @param lng
	 * @return
	 */
	@Deprecated
	public static List&lt;GalleryBean&gt; getImagesFromDir(String dir, ServletContext servletContext, HttpServletRequest request, String lng)
	{
<span class="nc" id="L428">		return getImages(dir, false, lng, null, &quot;title&quot;, &quot;asc&quot;, request);</span>
	}


	/**
	 * Nacita obrazky zo zadaneho adresara a spravi filtraciu a sortovanie na zaklade zadanych parametrov
	 * @param dir
	 * @param alsoSubfolders
	 * @param lng
	 * @param perexGroupIds
	 * @param orderBy
	 * @param orderDirection
	 * @param request
	 * @return
	 */
	public static List&lt;GalleryBean&gt; getImages(String dir, boolean alsoSubfolders, String lng, String perexGroupIds, String orderBy, String orderDirection, HttpServletRequest request)
	{
<span class="fc" id="L445">		return getImages(dir, alsoSubfolders, lng, perexGroupIds, orderBy, orderDirection, null, request);</span>
	}

	/**
	 * Nacita obrazky zo zadaneho adresara a spravi filtraciu a sortovanie na zaklade zadanych parametrov
	 * @param dir
	 * @param alsoSubfolders
	 * @param lng
	 * @param perexGroupIds
	 * @param orderBy
	 * @param orderDirection
	 * @param saveDirsRequestName - meno request premennej do ktorej vlozi zoznam pod adresarov (pouziva sa pre admin cast)
	 * @param request
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static List&lt;GalleryBean&gt; getImages(String dir, boolean alsoSubfolders, String lng, String perexGroupIds, String orderBy, String orderDirection, String saveDirsRequestName, HttpServletRequest request)
	{
<span class="fc" id="L463">		int galleryCacheResultMinutes = Constants.getInt(&quot;galleryCacheResultMinutes&quot;);</span>
<span class="fc" id="L464">		Cache c = Cache.getInstance();</span>
		List&lt;GalleryBean&gt; galleryList;
<span class="fc" id="L466">		String CACHE_KEY = null;</span>
<span class="fc" id="L467">		String CACHE_KEY_DIRLIST = null;</span>

<span class="pc bpc" id="L469" title="5 of 6 branches missed.">		if (galleryCacheResultMinutes &gt; 0 &amp;&amp; alsoSubfolders==false &amp;&amp; Tools.isEmpty(perexGroupIds))</span>
		{
			//cachovanie zoznamu fotiek na zaklade lastmodified adresara
<span class="nc" id="L472">			IwcmFile galleryDir = new IwcmFile(Tools.getRealPath(dir));</span>
<span class="nc" id="L473">			CACHE_KEY =         &quot;GalleryDB.getImages-&quot;    +dir+&quot;-&quot;+lng+&quot;-&quot;+orderBy+&quot;-&quot;+orderDirection+&quot;-&quot;+galleryDir.lastModified();</span>
<span class="nc" id="L474">			CACHE_KEY_DIRLIST = &quot;GalleryDB.getImagesDirs-&quot;+dir+&quot;-&quot;+lng+&quot;-&quot;+orderBy+&quot;-&quot;+orderDirection+&quot;-&quot;+galleryDir.lastModified();</span>

<span class="nc" id="L476">			galleryList = (List&lt;GalleryBean&gt;) c.getObject(CACHE_KEY);</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">			if (galleryList != null)</span>
			{
<span class="nc bnc" id="L479" title="All 2 branches missed.">				if (Tools.isNotEmpty(saveDirsRequestName))</span>
				{
<span class="nc" id="L481">					List&lt;FileDirBean&gt; dirList = (List&lt;FileDirBean&gt;)c.getObject(CACHE_KEY_DIRLIST);</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">					if (dirList != null)</span>
					{
<span class="nc" id="L484">						request.setAttribute(saveDirsRequestName, dirList);</span>
					}
					else
					{
						//nemozeme vratit cachovany zoznam, pretoze nemame dirList
<span class="nc" id="L489">						galleryList = null;</span>
					}
				}

<span class="nc bnc" id="L493" title="All 2 branches missed.">				if (galleryList != null)</span>
				{
<span class="nc" id="L495">					Logger.debug(GalleryDB.class, &quot;Vraciam cachovany vystup galerie, key=&quot;+CACHE_KEY+&quot; velkost=&quot;+galleryList.size());</span>
<span class="nc" id="L496">					return galleryList;</span>
				}
			}
		}

<span class="fc" id="L501">		galleryList = getImagesImpl(dir, alsoSubfolders, lng, perexGroupIds, orderBy, orderDirection, saveDirsRequestName, request);</span>

<span class="pc bpc" id="L503" title="3 of 4 branches missed.">		if (galleryCacheResultMinutes &gt; 0 &amp;&amp; CACHE_KEY != null)</span>
		{
			//uloz vystup do cache
<span class="nc" id="L506">			c.setObjectSeconds(CACHE_KEY, galleryList, galleryCacheResultMinutes*60, true);</span>

<span class="nc bnc" id="L508" title="All 2 branches missed.">			if (Tools.isNotEmpty(saveDirsRequestName))</span>
			{
<span class="nc" id="L510">				List&lt;FileDirBean&gt; dirList = (List&lt;FileDirBean&gt;)request.getAttribute(saveDirsRequestName);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">				if (dirList != null)</span>
				{
<span class="nc" id="L513">					c.setObjectSeconds(CACHE_KEY_DIRLIST, dirList, galleryCacheResultMinutes*60, true);</span>
				}
			}
		}

<span class="fc" id="L518">		return galleryList;</span>
	}

	/**
	 * Nacita obrazky zo zadaneho adresara a spravi filtraciu a sortovanie na zaklade zadanych parametrov
	 * @param dir
	 * @param alsoSubfolders
	 * @param lng
	 * @param perexGroupIds
	 * @param orderBy
	 * @param orderDirection
	 * @param saveDirsRequestName - meno request premennej do ktorej vlozi zoznam pod adresarov (pouziva sa pre admin cast)
	 * @param request
	 * @return
	 */
	private static List&lt;GalleryBean&gt; getImagesImpl(String dir, boolean alsoSubfolders, String lng, String perexGroupIds, String orderBy, String orderDirection, String saveDirsRequestName, HttpServletRequest request)
	{
<span class="fc" id="L535">		DebugTimer dt = new DebugTimer(&quot;GalleryDB.getImages, dir=&quot;+dir);</span>

<span class="fc" id="L537">		HttpSession session = request.getSession();</span>

<span class="fc" id="L539">		String lngAdd = getLngAdd(lng, request);</span>

		//ziskaj beany
<span class="fc" id="L542">		Map&lt;String, GalleryBean&gt; gBeanTable = getGalleryBeanTable(dir, lngAdd, alsoSubfolders);</span>

<span class="fc" id="L544">		dt.diff(&quot;After gBeanTable&quot;);</span>

		//ziskaj subory

<span class="fc" id="L548">		IwcmFile[] filesInDir = listFiles(dir);</span>
<span class="fc" id="L549">		dt.diff(&quot;After fileList&quot;);</span>

<span class="pc bpc" id="L551" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(saveDirsRequestName))</span>
		{
<span class="nc" id="L553">			request.setAttribute(saveDirsRequestName, GalleryDB.getDirs(dir, filesInDir));</span>
<span class="nc" id="L554">			dt.diff(&quot;After get dirs&quot;);</span>
		}

<span class="fc" id="L557">		List&lt;IwcmFile&gt; fileList = getFilesFromDir(dir, alsoSubfolders, filesInDir);</span>
<span class="fc" id="L558">		dt.diff(&quot;After getFilesFromDir&quot;);</span>

		//skonvertuj na pole gbeanov
<span class="fc" id="L561">		List&lt;GalleryBean&gt; gBeanList = convertFilesToGbean(fileList, gBeanTable);</span>

<span class="fc" id="L563">		dt.diff(&quot;After convert&quot;);</span>

		//skontroluj perex skupiny
<span class="fc" id="L566">		gBeanList = filterByPerexGroups(gBeanList, perexGroupIds);</span>

<span class="fc" id="L568">		dt.diff(&quot;After filter perex group&quot;);</span>

		//filtrovanie na zaklade datumu
<span class="pc bpc" id="L571" title="2 of 4 branches missed.">		String filterDateFrom = session != null &amp;&amp; session.getAttribute(DATE_FROM_SESSION_FILTER) != null ? (String)session.getAttribute(DATE_FROM_SESSION_FILTER) : null;</span>
<span class="pc bpc" id="L572" title="2 of 4 branches missed.">		String filterDateTo = session != null &amp;&amp; session.getAttribute(DATE_TO_SESSION_FILTER) != null ? (String)session.getAttribute(DATE_TO_SESSION_FILTER) : null;</span>

<span class="pc bpc" id="L574" title="2 of 4 branches missed.">		if(Tools.isNotEmpty(filterDateFrom) || Tools.isNotEmpty(filterDateTo))</span>
		{
<span class="nc" id="L576">			Calendar dateFrom = null;</span>
<span class="nc bnc" id="L577" title="All 2 branches missed.">			if(Tools.isNotEmpty(filterDateFrom))</span>
			{
<span class="nc" id="L579">				dateFrom = Calendar.getInstance();</span>
<span class="nc" id="L580">				dateFrom.setTimeInMillis(DB.getTimestamp(filterDateFrom, &quot;00:00:00&quot;));</span>
			}
<span class="nc" id="L582">			Calendar dateTo = null;</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">			if(Tools.isNotEmpty(filterDateTo))</span>
			{
<span class="nc" id="L585">				dateTo = Calendar.getInstance();</span>
<span class="nc" id="L586">				dateTo.setTimeInMillis(DB.getTimestamp(filterDateTo, &quot;23:59:59&quot;));</span>
			}
<span class="nc" id="L588">			List&lt;GalleryBean&gt; filtered = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L590" title="All 4 branches missed.">			if(gBeanList != null &amp;&amp; gBeanList.size() &gt; 0)</span>
			{
<span class="nc bnc" id="L592" title="All 2 branches missed.">				for (GalleryBean gb : gBeanList)</span>
				{
<span class="nc bnc" id="L594" title="All 2 branches missed.">					if(gb.getUploadDate() != null)</span>
					{
<span class="nc bnc" id="L596" title="All 4 branches missed.">						if(dateFrom != null &amp;&amp; dateTo == null)</span>
						{
<span class="nc bnc" id="L598" title="All 2 branches missed.">							if(gb.getUploadDate().getTime() &gt;= dateFrom.getTimeInMillis())</span>
<span class="nc" id="L599">								filtered.add(gb);</span>
						}
<span class="nc bnc" id="L601" title="All 4 branches missed.">						else if(dateTo != null &amp;&amp; dateFrom == null)</span>
						{
<span class="nc bnc" id="L603" title="All 2 branches missed.">							if(gb.getUploadDate().getTime() &lt;= dateTo.getTimeInMillis())</span>
<span class="nc" id="L604">								filtered.add(gb);</span>
						}
<span class="nc bnc" id="L606" title="All 4 branches missed.">						else if (dateFrom != null &amp;&amp; dateTo != null)</span>
						{
<span class="nc bnc" id="L608" title="All 4 branches missed.">							if(gb.getUploadDate().getTime() &gt;= dateFrom.getTimeInMillis() &amp;&amp; gb.getUploadDate().getTime() &lt;= dateTo.getTimeInMillis())</span>
<span class="nc" id="L609">								filtered.add(gb);</span>
						}
					}
<span class="nc" id="L612">				}</span>
			}
<span class="nc" id="L614">			gBeanList = filtered;</span>
		}
		//END filtrovanie na zaklade datumu

<span class="fc" id="L618">		dt.diff(&quot;After filter datum&quot;);</span>

		//usortuj
<span class="fc" id="L621">		sort(gBeanList, orderBy, orderDirection);</span>

<span class="fc" id="L623">		dt.diff(&quot;After sort&quot;);</span>

<span class="fc" id="L625">		List&lt;GalleryBean&gt; returnList = new ArrayList&lt;&gt;();</span>
		try
		{
<span class="fc" id="L628">			int page = 1;</span>
<span class="fc" id="L629">			int pSize = -1;</span>
<span class="pc bpc" id="L630" title="1 of 2 branches missed.">			if (request.getAttribute(&quot;disablegPage&quot;) == null)</span>
			{
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">				if (request.getParameter(&quot;gpage&quot;) != null) page = Tools.getIntValue(request.getParameter(&quot;gpage&quot;), -1);</span>
<span class="pc bpc" id="L633" title="1 of 2 branches missed.">				else if (request.getAttribute(&quot;gpage&quot;) != null) page = Tools.getIntValue((String) request.getAttribute(&quot;gpage&quot;), -1);</span>
			}
<span class="fc" id="L635">			request.removeAttribute(&quot;disablegPage&quot;);</span>
<span class="pc bpc" id="L636" title="1 of 2 branches missed.">			if (session!=null) session.setAttribute(&quot;galleryActualPage&quot;, Integer.toString(page));</span>
<span class="pc bpc" id="L637" title="2 of 4 branches missed.">			if (request.getAttribute(&quot;disablegPage&quot;) == null &amp;&amp; request.getParameter(&quot;gpsize&quot;) != null) pSize = Tools.getIntValue(request.getParameter(&quot;gpsize&quot;), -1);</span>
<span class="pc bpc" id="L638" title="1 of 2 branches missed.">			else if (request.getAttribute(&quot;gpsize&quot;) != null) pSize = Tools.getIntValue((String) request.getAttribute(&quot;gpsize&quot;), -1);</span>

<span class="fc" id="L640">			int start = 0;</span>
<span class="fc" id="L641">			int end = gBeanList.size();</span>
<span class="fc" id="L642">			request.setAttribute(&quot;gTotalImages&quot;, Integer.toString(end));</span>

<span class="pc bpc" id="L644" title="1 of 2 branches missed.">			if (pSize &gt; 0)</span>
			{
				// vytvor strankovanie
<span class="nc" id="L647">				List&lt;LabelValueDetails&gt; pages = new ArrayList&lt;&gt;();</span>
				try
				{
<span class="nc" id="L650">					StringBuilder params = new StringBuilder(&quot;gpsize=&quot; + pSize);</span>
<span class="nc" id="L651">					Enumeration&lt;String&gt; paramsEnum = request.getParameterNames();</span>
<span class="nc bnc" id="L652" title="All 2 branches missed.">					while (paramsEnum.hasMoreElements())</span>
					{
<span class="nc" id="L654">						String param = paramsEnum.nextElement();</span>
					   // tieto ignorujem, nastavim neskor
<span class="nc bnc" id="L656" title="All 4 branches missed.">						if (param.equals(&quot;gpage&quot;) || param.equals(&quot;gpsize&quot;)) continue;</span>
<span class="nc bnc" id="L657" title="All 4 branches missed.">						if (Constants.getInt(&quot;linkType&quot;) == Constants.LINK_TYPE_HTML &amp;&amp; param.equals(&quot;docid&quot;)) continue;</span>

<span class="nc" id="L659">						params.append(&quot;&amp;amp;&quot;).append(ResponseUtils.filter(param)).append('=').append(ResponseUtils.filter(request.getParameter(param)));</span>
<span class="nc" id="L660">					}</span>
<span class="nc" id="L661">					int counter = 1;</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">					while (start &lt; end)</span>
					{
<span class="nc" id="L664">						LabelValueDetails lvd = new LabelValueDetails(Integer.toString(counter), &quot;&quot;);</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">						if (counter != page)	lvd.setValue(params.toString() + &quot;&amp;amp;gpage=&quot; + counter);</span>
<span class="nc" id="L666">						pages.add(lvd);</span>
<span class="nc" id="L667">						counter++;</span>
<span class="nc" id="L668">						start += pSize;</span>
<span class="nc" id="L669">					}</span>
				}
<span class="nc" id="L671">				catch (Exception ex)</span>
				{
<span class="nc" id="L673">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L674">				}</span>

<span class="nc bnc" id="L676" title="All 2 branches missed.">				if (pages.size() &gt; 1)</span>
				{
<span class="nc" id="L678">					request.setAttribute(&quot;gPages&quot;, pages);</span>
				}

<span class="nc" id="L681">				start = (page - 1) * pSize;</span>
<span class="nc" id="L682">				end = start + pSize;</span>
			}
<span class="pc bpc" id="L684" title="1 of 2 branches missed.">			if (start &lt; 0) start = 0;</span>
<span class="pc bpc" id="L685" title="2 of 4 branches missed.">			if (end &gt; gBeanList.size() || Boolean.TRUE.equals(request.getAttribute(&quot;returnAllPages&quot;)))</span>
			{
<span class="nc" id="L687">				end = gBeanList.size();</span>
			}

			//cache nastaveni adresara galerie (pre FSDB nezistujem rozmery obrazka presne, ale pouzijem nastavenie galerie)
<span class="fc" id="L691">			Map&lt;String, Dimension[]&gt; dimensionDirTable = new Hashtable&lt;&gt;();</span>
<span class="fc bfc" id="L692" title="All 2 branches covered.">			for (int i = start; i &lt; end; i++)</span>
			{
<span class="fc" id="L694">				GalleryBean gBean = gBeanList.get(i);</span>

<span class="pc bpc" id="L696" title="1 of 2 branches missed.">				if (gBeanList.size()&gt;1)</span>
				{
					try
					{
<span class="fc bfc" id="L700" title="All 2 branches covered.">						if (i &gt; 0) gBean.setPrevImage(gBeanList.get(i-1).getImageUrl());</span>
<span class="fc" id="L701">						else gBean.setPrevImage(gBeanList.get(gBeanList.size()-1).getImageUrl());</span>

<span class="fc bfc" id="L703" title="All 2 branches covered.">						if (i &lt; (gBeanList.size()-1))	gBean.setNextImage(gBeanList.get(i+1).getImageUrl());</span>
<span class="fc" id="L704">						else gBean.setNextImage(gBeanList.get(0).getImageUrl());</span>
					}
<span class="nc" id="L706">					catch (Exception e)</span>
					{
<span class="nc" id="L708">						sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L709">					}</span>
				}

				try
				{
					// testni ci existuje originalImage
<span class="fc" id="L715">					String originalImage = Tools.getRealPath(gBean.getImagePath() + File.separatorChar + &quot;o_&quot; + gBean.getImageName());</span>
<span class="fc" id="L716">					IwcmFile file = new IwcmFile(originalImage);</span>
<span class="pc bpc" id="L717" title="1 of 2 branches missed.">					if (isImageFast(file))</span>
					{
<span class="fc" id="L719">						gBean.setOriginalImage(file.getVirtualPath());</span>
					}
				}
<span class="nc" id="L722">				catch (Exception ex)</span>
				{
<span class="nc" id="L724">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L725">				}</span>

				// ziskaj velky obrazok a ziskaj jeho rozmer a velkost
				try
				{
<span class="fc" id="L730">					IwcmFile bigImageFile = new IwcmFile(Tools.getRealPath(gBean.getImageUrl()));</span>
<span class="pc bpc" id="L731" title="2 of 4 branches missed.">					if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;) || bigImageFile.exists())</span>
					{
<span class="pc bpc" id="L733" title="1 of 2 branches missed.">						if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)==false) gBean.setBigLength(FileTools.getFormatFileSize(bigImageFile.length(), false));</span>
<span class="pc bpc" id="L734" title="1 of 2 branches missed.">						if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;))</span>
						{
<span class="nc" id="L736">							Dimension[] dims = dimensionDirTable.get(gBean.getImagePath());</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">							if (dims == null)</span>
							{
<span class="nc" id="L739">								Logger.debug(GalleryDB.class, &quot;getting dims for: &quot;+gBean.getImagePath());</span>
<span class="nc" id="L740">								dims = getDimension(gBean.getImagePath());</span>
<span class="nc" id="L741">								dimensionDirTable.put(gBean.getImagePath(), dims);</span>
							}
<span class="nc bnc" id="L743" title="All 4 branches missed.">							if (dims != null &amp;&amp; dims.length&gt;1)</span>
							{
<span class="nc" id="L745">								gBean.setBigDimension(dims[1].width+&quot;x&quot;+dims[1].height);</span>
							}
<span class="nc" id="L747">						}</span>
						else
						{
<span class="fc" id="L750">							int[] dims = GalleryDBTools.getImageSize(bigImageFile);</span>
<span class="fc" id="L751">							gBean.setBigDimension(dims[0]+&quot;x&quot;+dims[1]);</span>
						}
					}
					// timer.diff(&quot;mam: &quot; + fName);
				}
<span class="nc" id="L756">				catch (Exception ex)</span>
				{
<span class="nc" id="L758">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L759">				}</span>
<span class="fc" id="L760">				returnList.add(gBean);</span>
			}
		}
<span class="nc" id="L763">		catch (Exception ex)</span>
		{
<span class="nc" id="L765">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L766">		}</span>

<span class="fc" id="L768">		dt.diff(&quot;Returning&quot;);</span>

<span class="fc" id="L770">		return returnList;</span>
	}

	private static void sort(List&lt;GalleryBean&gt; list, String orderBy, String orderDirection)
	{
<span class="pc bpc" id="L775" title="1 of 2 branches missed.">		if(&quot;asc&quot;.equals(orderDirection))</span>
		{

<span class="pc bpc" id="L778" title="1 of 2 branches missed.">			if(orderBy.equalsIgnoreCase(&quot;priority&quot;))</span>
<span class="nc" id="L779">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="nc bnc" id="L782" title="All 2 branches missed.">				        return (gb1.getSortPriority() - gb2.getSortPriority()) == 0?gb1.getImageName().compareTo(gb2.getImageName()):(gb1.getSortPriority() - gb2.getSortPriority());</span>
				    }
				});
			else
<span class="pc bpc" id="L786" title="1 of 2 branches missed.">			if(orderBy.equalsIgnoreCase(&quot;date&quot;))</span>
<span class="nc" id="L787">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="nc" id="L790">				        int dateCmp = gb1.getUploadDate().compareTo(gb2.getUploadDate());</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">				        if (dateCmp != 0)</span>
<span class="nc" id="L792">				            return dateCmp;</span>
<span class="nc" id="L793">				        return gb1.getImageName().compareTo(gb2.getImageName());</span>
				    }
				});
			else
<span class="fc" id="L797">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="fc" id="L800">				       int stringCmp = gb1.getImageName().compareTo(gb2.getImageName());</span>
<span class="pc bpc" id="L801" title="1 of 2 branches missed.">				       if (stringCmp != 0)</span>
<span class="fc" id="L802">				            return stringCmp;</span>
<span class="nc" id="L803">				       return gb1.getUploadDate().compareTo(gb2.getUploadDate());</span>
				    }
				});
		}
		else
		{
<span class="nc bnc" id="L809" title="All 2 branches missed.">			if(orderBy.equalsIgnoreCase(&quot;priority&quot;))</span>
<span class="nc" id="L810">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="nc bnc" id="L813" title="All 2 branches missed.">				   	 return (gb2.getSortPriority() - gb1.getSortPriority()) == 0?gb2.getImageName().compareTo(gb1.getImageName()):(gb2.getSortPriority() - gb1.getSortPriority());</span>
				    }
				});
			else
<span class="nc bnc" id="L817" title="All 2 branches missed.">			if(orderBy.equalsIgnoreCase(&quot;date&quot;))</span>
<span class="nc" id="L818">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2)
				    {
<span class="nc" id="L822">				        int dateCmp = gb2.getUploadDate().compareTo(gb1.getUploadDate());</span>
<span class="nc" id="L823">				        Logger.debug(GalleryDB.class, &quot;Comparing: &quot;+gb1.getImageName()+&quot; (&quot;+Tools.formatDate(gb1.getUploadDate())+&quot;) vs &quot;+gb2.getImageName()+&quot; (&quot;+Tools.formatDate(gb2.getUploadDate())+&quot;) ret=&quot;+dateCmp);</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">				        if (dateCmp != 0)</span>
<span class="nc" id="L825">				            return dateCmp;</span>
<span class="nc" id="L826">				        return gb2.getImageName().compareTo(gb1.getImageName());</span>
				    }
				});
			else
<span class="nc" id="L830">				Collections.sort(list, new Comparator&lt;GalleryBean&gt;() {</span>
				    @Override
					public int compare(GalleryBean gb1, GalleryBean gb2) {
<span class="nc" id="L833">				       int stringCmp = gb2.getImageName().compareTo(gb1.getImageName());</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">				       if (stringCmp != 0)</span>
<span class="nc" id="L835">				            return stringCmp;</span>
<span class="nc" id="L836">				       return gb2.getUploadDate().compareTo(gb1.getUploadDate());</span>
				    }
				});
		}
<span class="fc" id="L840">	}</span>

	/**
	 * Vrati nahodny obrazok z galerie, pricom si ho pamata zadany pocet minut
	 *
	 *@param dir
	 *@param rememberMinutes
	 *           - pocet minut, pocas ktorych si zapamata obrazok a negeneruje ho
	 *           znova
	 *@param servletContext
	 *@param request
	 *@return
	 */
	public static GalleryBean getRandomImageFromDir(String dir, int rememberMinutes, ServletContext servletContext,
				HttpServletRequest request)
	{
<span class="nc" id="L856">		String scImage = &quot;GALLERY_RANDOM_IMAGE&quot;;</span>
<span class="nc" id="L857">		String scImageTime = &quot;GALLERY_RANDOM_IMAGE_TIME&quot;;</span>
<span class="nc" id="L858">		GalleryBean randomImage = null;</span>
<span class="nc" id="L859">		long now = (new java.util.Date()).getTime();</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">		if (rememberMinutes &gt; 0)</span>
		{
			// najskor zisti, ci uz obrazok nemame a ci nie je platny
<span class="nc" id="L863">			randomImage = (GalleryBean) servletContext.getAttribute(scImage);</span>
<span class="nc" id="L864">			Long imageTime = (Long) servletContext.getAttribute(scImageTime);</span>
<span class="nc" id="L865">			now = now - (rememberMinutes * 60L * 1000);</span>
<span class="nc bnc" id="L866" title="All 6 branches missed.">			if (randomImage != null &amp;&amp; imageTime != null &amp;&amp; imageTime.longValue() &gt; now)</span>
			{
<span class="nc" id="L868">				return (randomImage);</span>
			}
		}
		// obrazok neexistuje, alebo je stary, ziskaj zoznam a nahodne vyber
<span class="nc" id="L872">		request.setAttribute(&quot;disablegPage&quot;, &quot;true&quot;);</span>
<span class="nc" id="L873">		List&lt;GalleryBean&gt; images = getImages(dir, false, null, null, &quot;title&quot;, &quot;asc&quot;, request);</span>
<span class="nc" id="L874">		request.removeAttribute(&quot;disablegPage&quot;);</span>
<span class="nc" id="L875">		int maxSize = images.size();</span>
<span class="nc bnc" id="L876" title="All 2 branches missed.">		if (maxSize &lt; 1)</span>
		{
<span class="nc" id="L878">			return (new GalleryBean());</span>
		}
		// posledne vygenerovany obrazok
<span class="nc" id="L881">		String lastImageName = null;</span>
<span class="nc bnc" id="L882" title="All 2 branches missed.">		if (randomImage != null)</span>
		{
<span class="nc" id="L884">			lastImageName = randomImage.getImageName();</span>
		}
		// vygeneruj nahodne cislo
		int index;
<span class="nc" id="L888">		int counter = 0;</span>
<span class="nc" id="L889">		GalleryBean newImage = null;</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">		while (counter &lt; 10)</span>
		{
			try
			{
<span class="nc" id="L894">				index = rand.nextInt(maxSize);</span>
<span class="nc" id="L895">				newImage = images.get(index);</span>
<span class="nc bnc" id="L896" title="All 4 branches missed.">				if (lastImageName == null || newImage.getImageName().compareTo(lastImageName) != 0)</span>
				{
<span class="nc" id="L898">					break;</span>
				}
			}
<span class="nc" id="L901">			catch (Exception ex)</span>
			{
<span class="nc" id="L903">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L904">			}</span>
<span class="nc" id="L905">			counter++;</span>
		}
		// ok, mali by sme mat obrazok
<span class="nc bnc" id="L908" title="All 2 branches missed.">		if (newImage != null)</span>
		{
			// uloz to do servlet contextu
<span class="nc" id="L911">			servletContext.setAttribute(scImage, newImage);</span>
<span class="nc" id="L912">			now = (new java.util.Date()).getTime();</span>
<span class="nc" id="L913">			servletContext.setAttribute(scImageTime, Long.valueOf(now));</span>
<span class="nc" id="L914">			return (newImage);</span>
		}
<span class="nc" id="L916">		return (new GalleryBean());</span>
	}

	/**
	 * Vrati celkovy pocet obrazkov v zadanom adresari, berie do uvahy len
	 *  small verzie obrazkov (pocita len obrazky s predponou &quot;s_&quot;)
	 *
	 *@param dir
	 *           - adresar s obrazkami
	 *@return
	 */
	public static int getTotalImagesInDir(String dir)
	{
<span class="fc" id="L929">		int ret = 0;</span>
		try
		{
<span class="fc" id="L932">			String realPath = Tools.getRealPath(dir);</span>
<span class="fc" id="L933">			IwcmFile file = new IwcmFile(realPath);</span>
<span class="fc" id="L934">			IwcmFile[] fileList = file.listFiles(new IwcmFileFilter()</span>
<span class="fc" id="L935">			{</span>
				@Override
				public boolean accept(IwcmFile pathname)
				{
<span class="pc bpc" id="L939" title="1 of 2 branches missed.">					return (isImageFast(pathname))</span>
<span class="pc bpc" id="L940" title="1 of 4 branches missed.">								&amp;&amp; (pathname.getName().startsWith(&quot;o_&quot;)==false &amp;&amp; pathname.getName().startsWith(&quot;s_&quot;)==false);</span>
				}
			});
<span class="fc" id="L943">			ret = fileList.length;</span>
		}
<span class="nc" id="L945">		catch (Exception ex)</span>
		{
<span class="nc" id="L947">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L948">		}</span>
<span class="fc" id="L949">		return (ret);</span>
	}

	/**
	 * Gets the imageByID attribute of the GalleryDB class
	 *
	 *@param iIDString
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@return The imageByID value
	 */
	public static GalleryBean getImageByID(String iIDString, HttpServletRequest request, String lng)
	{
<span class="nc" id="L963">		return getImageByID(Integer.parseInt(iIDString), request, lng);</span>
	}

	/**
	 * Gets the imageByID attribute of the GalleryDB class
	 *
	 *@param iID
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@return The imageByID value
	 */
	public static GalleryBean getImageByID(int iID, HttpServletRequest request, String lng)
	{
<span class="nc" id="L977">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L978">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L979">		java.sql.ResultSet rs = null;</span>
<span class="nc" id="L980">		GalleryBean gBean = null;</span>
<span class="nc" id="L981">		String sql = &quot;SELECT * FROM gallery WHERE image_id=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="nc" id="L982">		String lngAdd = getLngAdd(lng, request);</span>
		try
		{
<span class="nc" id="L985">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L986">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L987">			ps.setInt(1, iID);</span>
<span class="nc" id="L988">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L991">				gBean = new GalleryBean();</span>
<span class="nc" id="L992">				gBean.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="nc" id="L993">				gBean.setImageName(DB.getDbString(rs, &quot;image_name&quot;));</span>
<span class="nc" id="L994">				gBean.setImagePath(DB.getDbString(rs, &quot;image_path&quot;));</span>
<span class="nc" id="L995">				gBean.setLongDescription(DB.getDbString(rs, &quot;l_description&quot; + lngAdd));</span>
<span class="nc" id="L996">				gBean.setShortDescription(DB.getDbString(rs, &quot;s_description&quot; + lngAdd));</span>
<span class="nc" id="L997">				gBean.setPerexGroup(convertPerexGroupString(DB.getDbString(rs, &quot;perex_group&quot;)));</span>
			}
<span class="nc" id="L999">			rs.close();</span>
<span class="nc" id="L1000">			ps.close();</span>
<span class="nc" id="L1001">			db_conn.close();</span>
<span class="nc" id="L1002">			db_conn = null;</span>
<span class="nc" id="L1003">			rs = null;</span>
<span class="nc" id="L1004">			ps = null;</span>
		}
<span class="nc" id="L1006">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1009" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1012">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1014">		return gBean;</span>
	}

	/**
	 * Ulozi informacie o obrazku do DB, vrati id obrazku
	 *
	 *@param gBean
	 *           The feature to be added to the Image attribute
	 *@param request
	 *           The feature to be added to the Image attribute
	 */
	public static int setImage(HttpServletRequest request)
	{
<span class="nc" id="L1027">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L1028">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L1029">		ResultSet rs = null;</span>

<span class="nc" id="L1031">		int iID = -1;</span>

		try
		{
<span class="nc" id="L1035">			String dir = request.getParameter(&quot;dir&quot;);</span>
<span class="nc" id="L1036">			String name = request.getParameter(&quot;name&quot;);</span>

<span class="nc" id="L1038">			GalleryBean gBean = GalleryDB.getGalleryBean(dir, name, request, &quot;sk&quot;);</span>

<span class="nc bnc" id="L1040" title="All 2 branches missed.">			if (gBean != null) iID = gBean.getImageId();</span>

<span class="nc" id="L1042">			Logger.debug(GalleryDB.class, &quot;setImage iID=&quot;+iID+&quot; dir=&quot;+dir+&quot; name=&quot;+name);</span>

<span class="nc" id="L1044">			String sql = &quot;INSERT INTO gallery (image_path,image_name,s_description_sk,l_description_sk,s_description_en,l_description_en,s_description_cz,l_description_cz,s_description_de,l_description_de,&quot;+</span>
				&quot;s_description_pl,l_description_pl,s_description_hu,l_description_hu,s_description_ru,l_description_ru,s_description_esp,l_description_esp,s_description_cho,l_description_cho,author,allowed_domains, perex_group, upload_datetime,sort_priority, domain_id)&quot;+
				&quot; VALUES(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)&quot;;

<span class="nc bnc" id="L1048" title="All 2 branches missed.">			if (iID &gt; 0)</span>
			{
<span class="nc" id="L1050">				Logger.debug(GalleryDB.class, &quot;UPDATE&quot;);</span>
<span class="nc" id="L1051">				sql = &quot;UPDATE gallery SET image_path=?,image_name=?,s_description_sk=?,l_description_sk=?,s_description_en=?,l_description_en=?,s_description_cz=?,l_description_cz=?,s_description_de=?,l_description_de=?,&quot;</span>
<span class="nc" id="L1052">					+&quot;s_description_pl=?,l_description_pl=?,s_description_hu=?,l_description_hu=?,s_description_ru=?,l_description_ru=?,s_description_esp=?,l_description_esp=?,s_description_cho=?,l_description_cho=?,author=?,allowed_domains=?,perex_group=?, upload_datetime = ?, sort_priority=?, domain_id=? WHERE image_id=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
			}

<span class="nc" id="L1055">			db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="nc" id="L1056">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1057">			int parameterIndex = 1;</span>
<span class="nc" id="L1058">			ps.setString(parameterIndex++, dir);</span>
<span class="nc" id="L1059">			ps.setString(parameterIndex++, name);</span>
<span class="nc" id="L1060">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_sk&quot;)));</span>
<span class="nc" id="L1061">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_sk&quot;)));</span>
<span class="nc" id="L1062">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_en&quot;)));</span>
<span class="nc" id="L1063">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_en&quot;)));</span>
<span class="nc" id="L1064">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_cz&quot;)));</span>
<span class="nc" id="L1065">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_cz&quot;)));</span>
<span class="nc" id="L1066">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_de&quot;)));</span>
<span class="nc" id="L1067">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_de&quot;)));</span>
<span class="nc" id="L1068">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_pl&quot;)));</span>
<span class="nc" id="L1069">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_pl&quot;)));</span>
<span class="nc" id="L1070">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_hu&quot;)));</span>
<span class="nc" id="L1071">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_hu&quot;)));</span>
<span class="nc" id="L1072">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_ru&quot;)));</span>
<span class="nc" id="L1073">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_ru&quot;)));</span>
<span class="nc" id="L1074">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_esp&quot;)));</span>
<span class="nc" id="L1075">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_esp&quot;)));</span>
<span class="nc" id="L1076">			ps.setString(parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;s_description_cho&quot;)));</span>
<span class="nc" id="L1077">			DB.setClob(ps, parameterIndex++, EditorDB.escapeInvalidCharacters(request.getParameter(&quot;l_description_cho&quot;)));</span>
<span class="nc" id="L1078">			ps.setString(parameterIndex++, request.getParameter(&quot;author&quot;));</span>
<span class="nc" id="L1079">			ps.setString(parameterIndex++, request.getParameter(&quot;allowed_domains&quot;));</span>
<span class="nc" id="L1080">			ps.setString(parameterIndex++, convertPerexGroupString(request.getParameterValues(&quot;perexGroup&quot;)));</span>

			// formatovanie datumov do stringu kvoli rozdeleniu casu a datumu na dve polozky
<span class="nc" id="L1083">	      String requestDate = Tools.getStringValue(request.getParameter(&quot;uploadDate&quot;), &quot;01.01.2000&quot;);</span>
<span class="nc" id="L1084">	      String requestTime = Tools.getStringValue(request.getParameter(&quot;uploadTime&quot;), &quot;00:00:00&quot;);</span>

<span class="nc" id="L1086">			ps.setTimestamp(parameterIndex++, new Timestamp(DB.getTimestamp(requestDate, requestTime)));</span>

<span class="nc" id="L1088">			int priority = 0;</span>
<span class="nc bnc" id="L1089" title="All 2 branches missed.">			if(Tools.getIntValue(request.getParameter(&quot;sort_priority&quot;), 0) == 0)</span>
<span class="nc" id="L1090">				priority = getNewPriority(dir);</span>
			else
<span class="nc" id="L1092">				priority = Tools.getIntValue(request.getParameter(&quot;sort_priority&quot;),Integer.MAX_VALUE);</span>
<span class="nc" id="L1093">			ps.setInt(parameterIndex++,priority);</span>

<span class="nc" id="L1095">			ps.setInt(parameterIndex++, CloudToolsForCore.getDomainId());</span>

<span class="nc bnc" id="L1097" title="All 2 branches missed.">			if (iID &gt; 0)</span>
<span class="nc" id="L1098">				ps.setInt(parameterIndex++, iID);</span>

<span class="nc" id="L1100">			ps.execute();</span>
<span class="nc" id="L1101">			ps.close();</span>
<span class="nc bnc" id="L1102" title="All 2 branches missed.">			if (iID &lt;= 0)</span>
			{
				//update pkey generator
<span class="nc" id="L1105">				PkeyGenerator.getNextValue(&quot;gallery&quot;);</span>

				// ziskaj ID z databazy
<span class="nc" id="L1108">				ps = db_conn.prepareStatement(&quot;SELECT image_id FROM gallery WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1109">				ps.setString(1, dir);</span>
<span class="nc" id="L1110">				ps.setString(2, name);</span>
<span class="nc" id="L1111">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1112" title="All 2 branches missed.">				if (rs.next())</span>
				{
<span class="nc" id="L1114">					iID = rs.getInt(&quot;image_id&quot;);</span>
				}
<span class="nc" id="L1116">				rs.close();</span>
<span class="nc" id="L1117">				ps.close();</span>
			}

			//kvoli bugu s oblastou zaujmu nam vznikali duplicity, zmaz
<span class="nc" id="L1121">			ps = db_conn.prepareStatement(&quot;DELETE FROM gallery WHERE image_path = ? AND image_name = ? AND image_id != ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1122">			ps.setString(1, dir);</span>
<span class="nc" id="L1123">			ps.setString(2, name);</span>
<span class="nc" id="L1124">			ps.setInt(3, iID);</span>
<span class="nc" id="L1125">			ps.execute();</span>
<span class="nc" id="L1126">			ps.close();</span>
<span class="nc" id="L1127">			db_conn.close();</span>
<span class="nc" id="L1128">			db_conn = null;</span>
<span class="nc" id="L1129">			rs = null;</span>
<span class="nc" id="L1130">			ps = null;</span>
		}
<span class="nc" id="L1132">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1135" title="All 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1138">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1140">		return iID;</span>
	}


	/**
	 * Metoda vypocita prioritu zobrazenia obrazku pre dany adresar.
	 * @param dir
	 * @return
	 */
	public static int getNewPriority(String dir)
	{
<span class="fc" id="L1151">		return getTotalImagesInDir(dir) * 10 +10;</span>
	}

	/**
	 * Metoda vypocita pre obrazok tak ze najde
	 * najvyssiu hodnotu pola sortPriority  v danom adresari
	 * a pripocita 10
	 * @param dir
	 * @return
	 */
	public static int getUpdatePriority(String dir)
	{
<span class="nc" id="L1163">		return getMaxPriority(dir) +10;</span>
	}

	/**
	 * Vrati najvyssiu hodnotu priority pre dany directory
	 * @param dir
	 * @return
	 */
	private static int getMaxPriority(String dir)
	{
<span class="nc" id="L1173">		int result = DB.queryForInt(&quot;Select max(sort_priority) from gallery where image_path = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir);</span>
<span class="nc" id="L1174">		return result;</span>
	}

	/**
	 * Uvodne ulozenie obrazku do tabulky gallery, vytvori sa novy zaznam pre obrazok s aktualnym datumom uploadu. &lt;br /&gt;
	 * Ak uz taky obrazok existuje, ale nema nastaveny datum uploadu, tak sa mu nastavi datum poslednej modifikacie suboru (Spatne to zistit nevieme). &lt;br /&gt;
	 *
	 *
	 * @param 	dir	Nazov virtualneho adresara, v ktorom je obrazok ulozeny napr. /images/gallery
	 * @param 	name	Nazov obrazka s priponou napr. obrazok.jpg
	 *
	 * @return	Vrati identifikator obrazka, ktory bol prave ulozeny do tabulky. Ak uz taky obrazok existuje, vrati jeho id. Ak nastal nejaky problem s DB, vrati -1.
	 */
	public static int setImage(String dir, String name)
	{
<span class="fc" id="L1189">		IwcmFile imageFile = new IwcmFile(dir + File.separator + name);</span>

<span class="fc" id="L1191">		SimpleQuery query = new SimpleQuery();</span>
<span class="fc" id="L1192">		int imageId = 0;</span>

		try
		{
<span class="fc" id="L1196">			imageId = query.forInt(&quot;SELECT image_id FROM gallery WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir, name);</span>
<span class="fc bfc" id="L1197" title="All 2 branches covered.">			if (GalleryDB.getUploadDateImage(dir, name) == null)</span>
<span class="fc" id="L1198">				GalleryDB.setUploadDateImage(dir, name, imageFile.lastModified());</span>

		}
<span class="nc" id="L1201">		catch (Exception e)</span>
		{
<span class="nc bnc" id="L1203" title="All 2 branches missed.">			if (imageId &gt; 0)</span>
<span class="nc" id="L1204">				return imageId;</span>
<span class="fc" id="L1205">		}</span>
<span class="fc bfc" id="L1206" title="All 2 branches covered.">		if (imageId &gt; 0)</span>
<span class="fc" id="L1207">			return imageId;</span>


<span class="fc" id="L1210">		int priority = getNewPriority(dir);</span>
<span class="fc" id="L1211">		String imageSource = GalleryService.getPixabayImageUrl(name, true);</span>
<span class="fc" id="L1212">		query.execute(&quot;INSERT INTO gallery (image_path, image_name, image_source, upload_datetime, sort_priority, domain_id) VALUES(?, ?, ?, ?, ?, ?)&quot;, dir, name, imageSource, new Timestamp(Tools.getNow()),priority, CloudToolsForCore.getDomainId());</span>

		//update pkey generator
<span class="fc" id="L1215">		PkeyGenerator.getNextValue(&quot;gallery&quot;);</span>

		try
		{
<span class="fc" id="L1219">			return query.forInt(&quot;SELECT image_id FROM gallery WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir, name);</span>
		}
<span class="nc" id="L1221">		catch (Exception e)</span>
		{
<span class="nc" id="L1223">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1224">			return -1;</span>
		}
	}

	/**
	 * Ulozi do tabulky gallery_dimension novy zaznam pre galeriu.
	 *
	 * @param 	dir	Nazov virtualneho adresara, v ktorom bude galeria ulozena napr. /images/gallery/new
	 * @author kmarton
	 *
	 * @return	Vrati identifikator galerie, ktora bola prave ulozena do tabulky. Ak uz taka galeria existuje, vrati jeho id. Ak nastal nejaky problem s DB, vrati -1.
	 */
	public static int setGallery(String dir)
	{
<span class="nc" id="L1238">		SimpleQuery query = new SimpleQuery();</span>
<span class="nc" id="L1239">		int galleryId = 0;</span>

		try
		{
<span class="nc" id="L1243">			galleryId = query.forInt(&quot;SELECT dimension_id FROM gallery_dimension WHERE image_path= ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir);</span>
		}
<span class="nc" id="L1245">		catch (Exception e)</span>
		{
			//
<span class="nc" id="L1248">		}</span>
<span class="nc bnc" id="L1249" title="All 2 branches missed.">		if (galleryId &gt; 0)</span>
<span class="nc" id="L1250">			return galleryId;</span>

<span class="nc" id="L1252">		Dimension[] dims = getDimension(dir);</span>

<span class="nc" id="L1254">		query.execute(&quot;INSERT INTO gallery_dimension (image_path, image_width, image_height, normal_width, normal_height, resize_mode, create_date, domain_id) VALUES(?, ?, ?, ?, ?, ?, ?, ?)&quot;,</span>
<span class="nc" id="L1255">					dir,dims[0].width, dims[0].height, dims[1].width, dims[1].height, GalleryDB.getResizeMode(dir, true), new Timestamp(Tools.getNow()), CloudToolsForCore.getDomainId());</span>
		try
		{
<span class="nc" id="L1258">			return query.forInt(&quot;SELECT dimension_id FROM gallery_dimension WHERE image_path= ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir);</span>
		}
<span class="nc" id="L1260">		catch (Exception e)</span>
		{
<span class="nc" id="L1262">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1263">			return -1;</span>
		}
	}

	/**
	 * Vrati identifikator obrazka z tabulky gallery podla jeho virtualnej cesty a mena
	 *
	 * @param 	dir	Nazov virtualneho adresara, v ktorom je obrazok ulozeny napr. /images/gallery
	 * @param 	name	Nazov obrazka s priponou napr. obrazok.jpg
	 *
	 * @return	Vrati identifikator obrazka podla jeho cesty a mena. Ak nastal nejaky problem pri spojeni s DB, prip. taky obrazok neexistuje, vrati -1
	 */
	public static int getImageId(String dir, String name)
	{
		try
		{
<span class="nc" id="L1279">			return new SimpleQuery().forInt(&quot;SELECT image_id FROM gallery WHERE image_path= ? AND image_name= ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir, name);</span>
		}
<span class="nc" id="L1281">		catch (Exception e)</span>
		{
<span class="nc" id="L1283">			return -1;</span>
		}
	}

	/**
	 * Description of the Method
	 *
	 *@param dir
	 *           Description of the Parameter
	 *@param name
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@param imageId
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 */
	public static void removeImage(String imageId, String dir, String name, ServletContext servletContext,
				HttpServletRequest request)
	{
<span class="nc" id="L1304">		int iID = Tools.getIntValue(imageId, -1);</span>
<span class="nc" id="L1305">		removeImage(iID, dir, name, servletContext, request);</span>
<span class="nc" id="L1306">	}</span>

	/**
	 * Description of the Method
	 *
	 *@param imageId
	 *           Description of the Parameter
	 *@param dir
	 *           Description of the Parameter
	 *@param name
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 */
	public static void removeImage(int imageId, String dir, String name, ServletContext servletContext, HttpServletRequest request)
	{
<span class="nc" id="L1324">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L1325">		java.sql.PreparedStatement ps = null;</span>
<span class="nc" id="L1326">		IwcmFile file = null;</span>
<span class="nc" id="L1327">		String sql = &quot;DELETE FROM gallery WHERE image_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>

<span class="nc bnc" id="L1329" title="All 2 branches missed.">		if (dir.startsWith(&quot;/&quot;)==false) dir = &quot;/&quot;+dir;</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">		if (name.startsWith(&quot;/&quot;)) name = name.substring(1);</span>

<span class="nc bnc" id="L1332" title="All 2 branches missed.">		if (imageId &lt; 1) imageId = getImageId(dir, name);</span>

<span class="nc" id="L1334">		String path = Tools.getRealPath(dir);</span>
		try
		{
<span class="nc bnc" id="L1337" title="All 2 branches missed.">			if (imageId &gt; 0)</span>
			{
<span class="nc" id="L1339">				db_conn = DBPool.getConnection();</span>
<span class="nc" id="L1340">				ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1341">				ps.setInt(1, imageId);</span>
<span class="nc" id="L1342">				ps.execute();</span>
<span class="nc" id="L1343">				ps.close();</span>
<span class="nc" id="L1344">				db_conn.close();</span>
<span class="nc" id="L1345">				ps = null;</span>
<span class="nc" id="L1346">				db_conn = null;</span>
			}
<span class="nc" id="L1348">			file = new IwcmFile(path + File.separator + name);</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">			if (file.exists())</span>
			{
<span class="nc" id="L1351">				boolean ok = file.delete();</span>
<span class="nc" id="L1352">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
<span class="nc" id="L1354">			file = new IwcmFile(path + File.separator + &quot;s_&quot; + name);</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">			if (file.exists())</span>
			{
<span class="nc" id="L1357">				boolean ok = file.delete();</span>
<span class="nc" id="L1358">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
<span class="nc" id="L1360">			file = new IwcmFile(path + File.separator + &quot;o_&quot; + name);</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">			if (file.exists())</span>
			{
<span class="nc" id="L1363">				boolean ok = file.delete();</span>
<span class="nc" id="L1364">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
		}
<span class="nc" id="L1367">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1370" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1372">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1374">	}</span>

	/**
	 * ziska info o obrazku z databazy
	 *
	 * @param src
	 * @param request
	 * @return
	 */
	public static GalleryBean getGalleryBean(String src, HttpServletRequest request)
	{
<span class="fc" id="L1385">		return (getGalleryBean(src, request, null));</span>
	}

	/**
	 * Ziska info o obrazku z databazy podla jazykovej mutacie
	 *
	 * @param src
	 * @param request
	 * @param lng
	 * @return
	 */
	public static GalleryBean getGalleryBean(String src, HttpServletRequest request, String lng)
	{
<span class="fc" id="L1398">		String dir = &quot;/&quot;;</span>
<span class="fc" id="L1399">		String name = src;</span>
<span class="fc" id="L1400">		int i = src.lastIndexOf('/');</span>
<span class="pc bpc" id="L1401" title="1 of 2 branches missed.">		if (i &gt; 0)</span>
		{
<span class="fc" id="L1403">			dir = src.substring(0, i);</span>
<span class="fc" id="L1404">			name = src.substring(i + 1, src.length()).trim();</span>
		}
<span class="fc" id="L1406">		return (getGalleryBean(dir, name, request, lng));</span>
	}

	/**
	 * Ziska info o obrazku z databazy
	 *
	 *@param dir
	 *           Description of the Parameter
	 *@param name
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@return The l_S_Description value
	 */
	public static GalleryBean getGalleryBean(String dir, String name, HttpServletRequest request)
	{
<span class="nc" id="L1422">		return (getGalleryBean(dir, name, request, null));</span>
	}

	/**
	 * Ziska info o obrazku z databazy pre danu jazykovu mutaciu
	 *
	 * @param dir
	 * @param name
	 * @param request
	 * @param lng
	 * @return
	 */
	public static GalleryBean getGalleryBean(String dir, String name, HttpServletRequest request, String lng)
	{
<span class="fc" id="L1436">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L1437">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L1438">		java.sql.ResultSet rs = null;</span>
		//order je tu kvoli bugu z duplicitou obrazkov
<span class="fc" id="L1440">		String sql = &quot;SELECT * FROM gallery WHERE image_path=? AND image_name=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY image_id ASC&quot;;</span>
<span class="fc" id="L1441">		boolean cyclicViewing = true;</span>
<span class="fc" id="L1442">		GalleryBean gBean = null;</span>
		IwcmFile file;
		try
		{
<span class="pc bpc" id="L1446" title="1 of 2 branches missed.">			if (&quot;false&quot;.equals(request.getParameter(&quot;cyclicViewing&quot;)))</span>
			{
<span class="nc" id="L1448">				cyclicViewing = false;</span>
			}
<span class="pc bpc" id="L1450" title="2 of 4 branches missed.">			if (!dir.equals(&quot;&quot;) &amp;&amp; !name.equals(&quot;&quot;))</span>
			{
<span class="pc bpc" id="L1452" title="1 of 2 branches missed.">				if (dir.startsWith(&quot;/&quot;)==false) dir = &quot;/&quot;+dir;</span>

<span class="fc" id="L1454">				gBean = new GalleryBean();</span>
<span class="fc bfc" id="L1455" title="All 2 branches covered.">				if (name.startsWith(&quot;s_&quot;))</span>
				{
<span class="fc" id="L1457">					name = name.substring(2, name.length());</span>
				}

<span class="fc" id="L1460">				request.setAttribute(&quot;imageURL&quot;, dir + &quot;/&quot; + name);</span>

<span class="fc bfc" id="L1462" title="All 2 branches covered.">				if (name.startsWith(&quot;o_&quot;))</span>
				{
					//toto mame kvoli najdeniu dat, ktore su pre normal image, ak ale clovek chcel o_ obrazok je nastavenie imageURL pred tymto blokom naschval
<span class="fc" id="L1465">					name = name.substring(2, name.length());</span>
				}

				// testni ci existuje originalImage
<span class="pc bpc" id="L1469" title="1 of 2 branches missed.">				if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;))</span>
				{
					//kvoli pluske prepnute na lazy testovanie o_ obrazku
<span class="nc" id="L1472">					gBean.setOriginalImage(null);</span>
				}
				else
				{
					try
					{
<span class="fc" id="L1478">						String originalImage = dir + &quot;/o_&quot; + name;</span>
<span class="fc" id="L1479">						file = new IwcmFile(Tools.getRealPath(originalImage));</span>
<span class="pc bpc" id="L1480" title="2 of 4 branches missed.">						if (file.exists() &amp;&amp; isImageFast(file))</span>
						{
<span class="fc" id="L1482">							gBean.setOriginalImage(originalImage);</span>
						}
					}
<span class="nc" id="L1485">					catch (Exception ex)</span>
					{
<span class="fc" id="L1487">					}</span>
				}

<span class="fc" id="L1490">				gBean.setImagePath(dir);</span>
<span class="fc" id="L1491">				gBean.setImageName(name);</span>

<span class="fc" id="L1493">				String lngAdd = getLngAdd(lng, request);</span>
<span class="fc" id="L1494">				db_conn = DBPool.getConnection(DBPool.getDBName(request));</span>
<span class="fc" id="L1495">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L1496">				ps.setString(1, dir);</span>
<span class="fc" id="L1497">				ps.setString(2, name);</span>
<span class="fc" id="L1498">				rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1499" title="1 of 2 branches missed.">				if (rs.next())</span>
				{
<span class="fc" id="L1501">					gBean.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="fc" id="L1502">					gBean.setImageName(DB.getDbString(rs, &quot;image_name&quot;));</span>
<span class="fc" id="L1503">					gBean.setImagePath(DB.getDbString(rs, &quot;image_path&quot;));</span>
<span class="fc" id="L1504">					gBean.setLongDescription(DB.getDbString(rs, &quot;l_description&quot; + lngAdd));</span>
<span class="fc" id="L1505">					gBean.setShortDescription(DB.getDbString(rs, &quot;s_description&quot; + lngAdd));</span>
<span class="fc" id="L1506">					gBean.setAuthor(DB.getDbString(rs, &quot;author&quot;));</span>
<span class="fc" id="L1507">					gBean.setSendCount(rs.getInt(&quot;send_count&quot;));</span>
<span class="fc" id="L1508">					gBean.setAllowedDomains(DB.getDbString(rs, &quot;allowed_domains&quot;));</span>
<span class="fc" id="L1509">					gBean.setPerexGroup(convertPerexGroupString(DB.getDbString(rs, &quot;perex_group&quot;)));</span>
<span class="fc" id="L1510">					gBean.setSelectedX(rs.getInt(&quot;selected_x&quot;));</span>
<span class="fc" id="L1511">					gBean.setSelectedY(rs.getInt(&quot;selected_y&quot;));</span>
<span class="fc" id="L1512">					gBean.setSelectedWidth(rs.getInt(&quot;selected_width&quot;));</span>
<span class="fc" id="L1513">					gBean.setSelectedHeight(rs.getInt(&quot;selected_height&quot;));</span>
<span class="fc" id="L1514">					gBean.setUploadDate(rs.getTimestamp(&quot;upload_datetime&quot;));</span>
<span class="fc" id="L1515">					gBean.setSortPriority(rs.getInt(&quot;sort_priority&quot;));</span>
				}
<span class="fc" id="L1517">				rs.close();</span>
<span class="fc" id="L1518">				ps.close();</span>
<span class="fc" id="L1519">				db_conn.close();</span>
<span class="fc" id="L1520">				rs = null;</span>
<span class="fc" id="L1521">				ps = null;</span>
<span class="fc" id="L1522">				db_conn = null;</span>
			}
<span class="pc bpc" id="L1524" title="1 of 2 branches missed.">			if (gBean != null) gBean.setCyclicViewing(cyclicViewing);</span>
		}
<span class="nc" id="L1526">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L1529" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L1530" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L1531" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L1532">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L1534">		return (gBean);</span>
	}

	public static void fillPrevNextLink(GalleryBean gBean, boolean cyclicViewing)
	{
		try
		{
<span class="nc" id="L1541">			String dir = gBean.getImagePath();</span>
<span class="nc" id="L1542">			String name = gBean.getImageName();</span>
<span class="nc bnc" id="L1543" title="All 4 branches missed.">			if (Tools.isEmpty(dir) &amp;&amp; Tools.isNotEmpty(gBean.getOriginalImage()))</span>
			{
<span class="nc" id="L1545">				dir = gBean.getOriginalImage().substring(0, gBean.getOriginalImage().lastIndexOf(&quot;/&quot;));</span>
<span class="nc" id="L1546">				name = gBean.getOriginalImage().substring(gBean.getOriginalImage().lastIndexOf(&quot;/&quot;)+1);</span>
			}

<span class="nc bnc" id="L1549" title="All 2 branches missed.">			if (Tools.isEmpty(dir)) return;</span>

			// ziskaj linku na predchadzajuci a nasledujuci obrazok
<span class="nc" id="L1552">			String realPath = Tools.getRealPath(dir);</span>
<span class="nc" id="L1553">			IwcmFile file = new IwcmFile(realPath);</span>
<span class="nc" id="L1554">			IwcmFile[] fileList = file.listFiles(new IwcmFileFilter()</span>
<span class="nc" id="L1555">			{</span>
				@Override
				public boolean accept(IwcmFile pathname)
				{
<span class="nc bnc" id="L1559" title="All 2 branches missed.">					return (isImageFast(pathname))</span>
<span class="nc bnc" id="L1560" title="All 2 branches missed.">								&amp;&amp; pathname.getName().startsWith(&quot;s_&quot;);</span>
				}
			});
			try
			{
<span class="nc" id="L1565">				Arrays.sort(fileList, new Comparator&lt;IwcmFile&gt;()</span>
<span class="nc" id="L1566">				{</span>
					@Override
					public int compare(IwcmFile f1, IwcmFile f2)
					{
<span class="nc" id="L1570">						return (f1.getName().compareTo(f2.getName()));</span>
					}
				});
			}
<span class="nc" id="L1574">			catch (Exception ex)</span>
			{
<span class="nc" id="L1576">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1577">			}</span>
<span class="nc bnc" id="L1578" title="All 2 branches missed.">			if (!name.startsWith(&quot;s_&quot;))</span>
			{
<span class="nc" id="L1580">				name = &quot;s_&quot; + name;</span>
			}
<span class="nc" id="L1582">			int i = 0;</span>
<span class="nc" id="L1583">			int end = fileList.length;</span>
<span class="nc bnc" id="L1584" title="All 2 branches missed.">			for (i = 0; i &lt; end; i++)</span>
			{
<span class="nc" id="L1586">				file = fileList[i];</span>
<span class="nc bnc" id="L1587" title="All 2 branches missed.">				if (file.getName().equals(name))</span>
				{
<span class="nc bnc" id="L1589" title="All 2 branches missed.">					if (i &gt; 0)</span>
					{
<span class="nc" id="L1591">						file = fileList[i - 1];</span>
						// meno suboru je s_nieco.jpg
<span class="nc" id="L1593">						gBean.setPrevImage(dir + &quot;/&quot; + file.getName().substring(2));</span>
					}
<span class="nc bnc" id="L1595" title="All 2 branches missed.">					else if (i == 0)</span>
					{
<span class="nc bnc" id="L1597" title="All 4 branches missed.">						if (cyclicViewing &amp;&amp; end &gt; 1)</span>
						{
<span class="nc" id="L1599">							file = fileList[end - 1];</span>
							// meno suboru je s_nieco.jpg
<span class="nc" id="L1601">							gBean.setPrevImage(dir + &quot;/&quot; + file.getName().substring(2));</span>
						}
						else
						{
<span class="nc" id="L1605">							gBean.setPrevImage(null);</span>
						}
					}
<span class="nc bnc" id="L1608" title="All 2 branches missed.">					if (i &lt; (end - 1))</span>
					{
<span class="nc" id="L1610">						file = fileList[i + 1];</span>
<span class="nc" id="L1611">						gBean.setNextImage(dir + &quot;/&quot; + file.getName().substring(2));</span>
					}
					else
					{
<span class="nc bnc" id="L1615" title="All 4 branches missed.">						if (cyclicViewing &amp;&amp; end &gt; 1)</span>
						{
<span class="nc" id="L1617">							file = fileList[0];</span>
<span class="nc" id="L1618">							gBean.setNextImage(dir + &quot;/&quot; + file.getName().substring(2));</span>
						}
						else
						{
<span class="nc" id="L1622">							gBean.setNextImage(null);</span>
						}
					}
<span class="nc" id="L1625">					break;</span>
				}
			}
		}
<span class="nc" id="L1629">		catch (Exception e)</span>
		{
<span class="nc" id="L1631">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1632">		}</span>
<span class="nc" id="L1633">	}</span>

	/**
	 * Vrati zoznam adresarov v zadanom adresari
	 *
	 *@param dir
	 *           Description of the Parameter
	 *@return The dirs value
	 */
	public static List&lt;FileDirBean&gt; getDirs(String dir)
	{
<span class="nc" id="L1644">		return getDirs(dir, listFiles(dir));</span>
	}
	/**
	 * Vrati zoznam adresarov v zadanom adresari
	 * @param dir
	 * @param fileList
	 * @return
	 */
	public static List&lt;FileDirBean&gt; getDirs(String dir, IwcmFile[] fileList)
	{
<span class="nc" id="L1654">		DebugTimer dt = new DebugTimer(&quot;GalleryDB.getDirs&quot;);</span>

<span class="nc bnc" id="L1656" title="All 4 branches missed.">		if (dir == null || dir.length() == 0)</span>
		{
<span class="nc bnc" id="L1658" title="All 2 branches missed.">			if (Constants.getString(&quot;imagesRootDir&quot;).length() &gt; 1)</span>
			{
<span class="nc" id="L1660">				dir = Constants.getString(&quot;imagesRootDir&quot;) + &quot;/&quot; + Constants.getString(&quot;galleryDirName&quot;);</span>
			}
			else
			{
<span class="nc" id="L1664">				dir = &quot;/&quot;;</span>
			}
		}
<span class="nc" id="L1667">		List&lt;FileDirBean&gt; aList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1668">		FileDirBean fBean = null;</span>
		try
		{
<span class="nc" id="L1671">				fBean = new FileDirBean();</span>
<span class="nc" id="L1672">				int index = dir.lastIndexOf('/');</span>
<span class="nc" id="L1673">				fBean.setName(&quot;..&quot;);</span>
<span class="nc" id="L1674">				fBean.setIcon(&quot;/components/_common/mime/folderback.gif&quot;);</span>
<span class="nc bnc" id="L1675" title="All 2 branches missed.">				if (index &gt; 0)</span>
				{
<span class="nc" id="L1677">					fBean.setPath(dir.substring(0, index));</span>
				}
				else
				{
<span class="nc" id="L1681">					fBean.setPath(&quot;/&quot;);</span>
				}
<span class="nc bnc" id="L1683" title="All 2 branches missed.">				if (dir.length() &gt; 1)</span>
				{
<span class="nc" id="L1685">					aList.add(fBean);</span>
				}

				try
				{
					// usortuj to podla abecedy
<span class="nc" id="L1691">					Arrays.sort(fileList, new Comparator&lt;IwcmFile&gt;()</span>
<span class="nc" id="L1692">					{</span>
						@Override
						public int compare(IwcmFile f1, IwcmFile f2)
						{
<span class="nc" id="L1696">							return (f1.getName().toLowerCase().compareTo(f2.getName().toLowerCase()));</span>
						}
					});
				}
<span class="nc" id="L1700">				catch (Exception ex)</span>
				{
<span class="nc" id="L1702">					sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1703">				}</span>

<span class="nc" id="L1705">				dt.diff(&quot;after compare&quot;);</span>

				int imgCount;
				String name;
<span class="nc bnc" id="L1709" title="All 2 branches missed.">				for (int i = 0; i &lt; fileList.length; i++)</span>
				{
<span class="nc bnc" id="L1711" title="All 2 branches missed.">					if (isDirectoryFast(fileList[i]))</span>
					{
<span class="nc" id="L1713">						fBean = new FileDirBean();</span>
						// ziskaj pocet obrazkov v danom adresari
<span class="nc bnc" id="L1715" title="All 2 branches missed.">						if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)) imgCount = 0;</span>
<span class="nc" id="L1716">						else imgCount = getTotalImagesInDir(dir + &quot;/&quot; + fileList[i].getName());</span>

<span class="nc bnc" id="L1718" title="All 2 branches missed.">						if (imgCount &gt; 0)</span>
						{
<span class="nc" id="L1720">							fBean.setImagesInDir(Integer.toString(imgCount));</span>
						}

<span class="nc" id="L1723">						fBean.setName(fileList[i].getName());</span>
<span class="nc" id="L1724">						fBean.setIcon(&quot;/components/_common/mime/folder.gif&quot;);</span>
<span class="nc" id="L1725">						fBean.setPath(dir + &quot;/&quot; + fileList[i].getName());</span>

<span class="nc" id="L1727">						name = fBean.getPath() + &quot;/&quot;;</span>

<span class="nc bnc" id="L1729" title="All 6 branches missed.">						if (name.startsWith(&quot;/WEB-INF/&quot;) || name.startsWith(&quot;/admin/&quot;) || name.startsWith(&quot;/templates/&quot;)</span>
<span class="nc bnc" id="L1730" title="All 6 branches missed.">									|| name.startsWith(&quot;/components/&quot;) || name.startsWith(&quot;/css/&quot;) || name.startsWith(&quot;/jscripts/&quot;)</span>
<span class="nc bnc" id="L1731" title="All 6 branches missed.">									|| name.startsWith(&quot;/CVS/&quot;) || name.startsWith(&quot;/META-INF/&quot;) || name.indexOf(&quot;.svn&quot;) != -1)</span>
						{
							// Logger.println(GalleryDB.class,&quot;som web inf&quot;);
<span class="nc" id="L1734">							continue;</span>
						}
<span class="nc" id="L1736">						aList.add(fBean);</span>
					}
				}

<span class="nc" id="L1740">				dt.diff(&quot;after total images&quot;);</span>
		}
<span class="nc" id="L1742">		catch (Exception ex)</span>
		{
<span class="nc" id="L1744">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1745">		}</span>
<span class="nc" id="L1746">		return aList;</span>
	}

	/**
	 * Description of the Method
	 *
	 *@param request
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 */
	public static void changeDimension(ServletContext servletContext, HttpServletRequest request, PrintWriter out, Prop prop)
	{
<span class="nc" id="L1759">		Dimension dim = new Dimension();</span>
<span class="nc" id="L1760">		Dimension normalDim = new Dimension();</span>
<span class="nc" id="L1761">		String dir = request.getParameter(&quot;dir&quot;);</span>
		try
		{
			try
			{
<span class="nc" id="L1766">				dim.width = Integer.parseInt(request.getParameter(&quot;imageWidth&quot;));</span>
			}
<span class="nc" id="L1768">			catch (Exception ex)</span>
			{
<span class="nc" id="L1770">				dim.width = 160;</span>
<span class="nc" id="L1771">			}</span>
			try
			{
<span class="nc" id="L1774">				dim.height = Integer.parseInt(request.getParameter(&quot;imageHeight&quot;));</span>
			}
<span class="nc" id="L1776">			catch (Exception ex)</span>
			{
<span class="nc" id="L1778">				dim.height = 120;</span>
<span class="nc" id="L1779">			}</span>
			try
			{
<span class="nc" id="L1782">				normalDim.width = Integer.parseInt(request.getParameter(&quot;imageWidthNormal&quot;));</span>
			}
<span class="nc" id="L1784">			catch (Exception ex)</span>
			{
<span class="nc" id="L1786">				normalDim.width = 0;</span>
<span class="nc" id="L1787">			}</span>
			try
			{
<span class="nc" id="L1790">				normalDim.height = Integer.parseInt(request.getParameter(&quot;imageHeightNormal&quot;));</span>
			}
<span class="nc" id="L1792">			catch (Exception ex)</span>
			{
<span class="nc" id="L1794">				normalDim.height = 0;</span>
<span class="nc" id="L1795">			}</span>
<span class="nc" id="L1796">			changeDimension(servletContext, dir, dim, normalDim, request, out, prop);</span>
		}
<span class="nc" id="L1798">		catch (NumberFormatException nfe)</span>
		{
<span class="nc" id="L1800">			sk.iway.iwcm.Logger.error(nfe);</span>
<span class="nc" id="L1801">		}</span>
<span class="nc" id="L1802">	}</span>

	/**
	 * Description of the Method
	 *
	 *@param request
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 */
	public static void changeDimension(ServletContext servletContext, String dir, HttpServletRequest request, PrintWriter out,
				Prop prop)
	{
<span class="nc" id="L1815">		Dimension dim = new Dimension();</span>
<span class="nc" id="L1816">		Dimension normalDim = new Dimension();</span>
		try
		{
			try
			{
<span class="nc" id="L1821">				dim.width = Integer.parseInt(request.getParameter(&quot;imageWidth&quot;));</span>
			}
<span class="nc" id="L1823">			catch (Exception ex)</span>
			{
<span class="nc" id="L1825">				dim.width = 160;</span>
<span class="nc" id="L1826">			}</span>
			try
			{
<span class="nc" id="L1829">				dim.height = Integer.parseInt(request.getParameter(&quot;imageHeight&quot;));</span>
			}
<span class="nc" id="L1831">			catch (Exception ex)</span>
			{
<span class="nc" id="L1833">				dim.height = 120;</span>
<span class="nc" id="L1834">			}</span>
			try
			{
<span class="nc" id="L1837">				normalDim.width = Integer.parseInt(request.getParameter(&quot;imageWidthNormal&quot;));</span>
			}
<span class="nc" id="L1839">			catch (Exception ex)</span>
			{
<span class="nc" id="L1841">				normalDim.width = 0;</span>
<span class="nc" id="L1842">			}</span>
			try
			{
<span class="nc" id="L1845">				normalDim.height = Integer.parseInt(request.getParameter(&quot;imageHeightNormal&quot;));</span>
			}
<span class="nc" id="L1847">			catch (Exception ex)</span>
			{
<span class="nc" id="L1849">				normalDim.height = 0;</span>
<span class="nc" id="L1850">			}</span>
<span class="nc" id="L1851">			changeDimension(servletContext, dir, dim, normalDim, request, out, prop);</span>
		}
<span class="nc" id="L1853">		catch (NumberFormatException nfe)</span>
		{
<span class="nc" id="L1855">			sk.iway.iwcm.Logger.error(nfe);</span>
<span class="nc" id="L1856">		}</span>
<span class="nc" id="L1857">	}</span>

	public static void changeDimension(ServletContext servletContext, String dir, Dimension dim, Dimension dimNormal,
				HttpServletRequest request)
	{
<span class="nc" id="L1862">		changeDimension(servletContext, dir, dim, dimNormal, request, null, null);</span>
<span class="nc" id="L1863">	}</span>

	public static void println(PrintWriter out, String message)
	{
<span class="nc" id="L1867">		out.println(message + &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L1868">		out.flush();</span>
<span class="nc" id="L1869">	}</span>

	public static void printlnError(PrintWriter out, String message)
	{
<span class="nc" id="L1873">		out.println(&quot;&lt;font color='red'&gt;&quot; + message + &quot;&lt;/font&gt;&lt;br&gt;&quot;);</span>
<span class="nc" id="L1874">		out.flush();</span>
<span class="nc" id="L1875">	}</span>

	/**
	 * Description of the Method
	 *
	 *@param dir
	 *           Description of the Parameter
	 *@param dim
	 *           Description of the Parameter
	 *@param request
	 *           Description of the Parameter
	 *@param servletContext
	 *           Description of the Parameter
	 *@param dimNormal
	 *           Description of the Parameter
	 */
	public static void changeDimension(ServletContext servletContext, String dir, Dimension dim, Dimension dimNormal,
				HttpServletRequest request, PrintWriter out, Prop prop)
	{
<span class="nc" id="L1894">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L1895">		java.sql.PreparedStatement ps = null;</span>

		//oprava 9.8.2012, povodny stav:
		//Date createDate = new Date(DB.getTimestamp(request.getParameter(&quot;createdDate&quot;), request.getParameter(&quot;time&quot;)));
		Date createDate;

<span class="nc" id="L1901">		String resizeMode = &quot;&quot;;</span>
<span class="nc" id="L1902">		String galleryName = &quot;&quot;;</span>
<span class="nc" id="L1903">		String galleryPerex = &quot;&quot;;</span>
<span class="nc" id="L1904">		String author = &quot;&quot;;</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">		if (request != null)</span>
		{
<span class="nc" id="L1907">			resizeMode = request.getParameter(&quot;resizeMode&quot;);</span>
<span class="nc" id="L1908">			galleryName = request.getParameter(&quot;galleryName&quot;);</span>
<span class="nc" id="L1909">			galleryPerex = request.getParameter(&quot;galleryPerex&quot;);</span>
<span class="nc" id="L1910">			author = request.getParameter(&quot;author&quot;);</span>
			//novy stav
<span class="nc" id="L1912">			createDate = new Date(DB.getTimestamp(request.getParameter(&quot;createdDate&quot;), request.getParameter(&quot;time&quot;)));</span>
		}
		else
			//novy stav
<span class="nc" id="L1916">			createDate = Calendar.getInstance().getTime();</span>
		try
		{
<span class="nc bnc" id="L1919" title="All 2 branches missed.">			if (!dir.equals(&quot;&quot;))</span>
			{
<span class="nc" id="L1921">				db_conn = DBPool.getConnection();</span>
<span class="nc" id="L1922">				ps = db_conn.prepareStatement(&quot;DELETE FROM gallery_dimension WHERE image_path=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1923">				ps.setString(1, normalizeDir(dir));</span>
<span class="nc" id="L1924">				ps.execute();</span>
<span class="nc" id="L1925">				ps.close();</span>
<span class="nc" id="L1926">				ps = db_conn</span>
<span class="nc" id="L1927">					.prepareStatement(&quot;INSERT INTO gallery_dimension (image_width, image_height, image_path, normal_width, normal_height, resize_mode,&quot; +</span>
							&quot;gallery_name, gallery_perex, create_date, author, watermark, watermark_saturation, watermark_placement, domain_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;);
<span class="nc" id="L1929">				ps.setInt(1, dim.width);</span>
<span class="nc" id="L1930">				ps.setInt(2, dim.height);</span>
<span class="nc" id="L1931">				ps.setString(3, normalizeDir(dir));</span>
<span class="nc" id="L1932">				ps.setInt(4, dimNormal.width);</span>
<span class="nc" id="L1933">				ps.setInt(5, dimNormal.height);</span>
<span class="nc" id="L1934">				ps.setString(6, resizeMode);</span>
<span class="nc" id="L1935">				ps.setString(7, galleryName);</span>
<span class="nc" id="L1936">				ps.setString(8, galleryPerex);</span>
<span class="nc" id="L1937">				ps.setTimestamp(9, new Timestamp(createDate.getTime()));</span>
<span class="nc" id="L1938">				ps.setString(10, author);</span>
<span class="nc bnc" id="L1939" title="All 2 branches missed.">				if (request != null)</span>
				{
<span class="nc" id="L1941">					ps.setString(11, StringUtils.abbreviate(request.getParameter(&quot;watermark&quot;), 255));</span>
<span class="nc" id="L1942">					ps.setInt(12, Tools.getIntValue(request.getParameter(&quot;watermarkSaturation&quot;), 0));</span>
<span class="nc" id="L1943">					ps.setString(13, request.getParameter(&quot;watermarkPlacement&quot;));</span>
				}
				else
				{
<span class="nc" id="L1947">					ps.setString(11, &quot;&quot;);</span>
<span class="nc" id="L1948">					ps.setInt(12, 0);</span>
<span class="nc" id="L1949">					ps.setString(13, &quot;&quot;);</span>
				}
<span class="nc" id="L1951">				ps.setInt(14, CloudToolsForCore.getDomainId());</span>
<span class="nc" id="L1952">				ps.execute();</span>
<span class="nc" id="L1953">				ps.close();</span>
<span class="nc" id="L1954">				db_conn.close();</span>
<span class="nc" id="L1955">				db_conn = null;</span>
<span class="nc" id="L1956">				ps = null;</span>
			}

<span class="nc bnc" id="L1959" title="All 4 branches missed.">			if(request == null || request.getAttribute(&quot;notGenerateAgain&quot;) == null) // ak sa nieco zmenilo v dimenziach, pregeneruj gallery opat</span>
			{
<span class="nc" id="L1961">				boolean recursive = true;</span>
<span class="nc bnc" id="L1962" title="All 2 branches missed.">				if (request != null) recursive = &quot;true&quot;.equals(request.getParameter(&quot;recursive&quot;));</span>
<span class="nc bnc" id="L1963" title="All 2 branches missed.">				if(recursive) updateDirectoryDim(dir, dim, dimNormal, resizeMode, recursive);</span>

<span class="nc" id="L1965">				resizePicturesInDirectory(dir, out, prop, resizeMode, recursive);</span>
			}
		}
<span class="nc" id="L1968">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="nc bnc" id="L1971" title="All 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="nc bnc" id="L1972" title="All 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="nc" id="L1973">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="nc" id="L1975">	}</span>

	/**
	 * Upravi fyzicku velkost obrazkov v zadanom adresari
	 * @param dir - URL adresa adresara s obrazkami
	 * @param recursive - ak je true, aplikuje sa aj na podadresare
	 * @param prop - Prop objekt s prekladmi pre vypis informacie
	 * @param out - vystupny objekt pre vypis sprav, moze byt NULL
	 */
	public static void resizePicturesInDirectory(String dir, boolean recursive, Prop prop, PrintWriter out) {
<span class="fc" id="L1985">		String resizeMode = getResizeMode(dir, true);</span>
<span class="fc" id="L1986">		resizePicturesInDirectory(dir, out, prop, resizeMode, recursive);</span>
<span class="fc" id="L1987">	}</span>

	/**
	 * Upravi velkost obrazkov v zadanom adresari podla zadaneho rezimu
	 * @param dir
	 * @param out
	 * @param prop
	 * @param resizeMode
	 * @param recursive
	 */
	private static void resizePicturesInDirectory(String dir, PrintWriter out, Prop prop, String resizeMode, boolean recursive)
	{
<span class="pc bpc" id="L1999" title="1 of 2 branches missed.">		if (null != out)</span>
		{
<span class="nc" id="L2001">			out.println(prop.getText(&quot;components.gallery.resizing_images_in&quot;, dir));</span>
		}
<span class="fc" id="L2003">		Dimension[] dims = getDimension(dir);</span>
<span class="fc" id="L2004">		dir = Tools.replace(dir, &quot;/&quot;, File.separator);</span>
<span class="fc" id="L2005">		IwcmFile directory = IwcmFile.fromVirtualPath(&quot;/&quot; + dir);</span>
<span class="pc bpc" id="L2006" title="2 of 4 branches missed.">		if (directory.exists() &amp;&amp; directory.isDirectory())</span>
		{
<span class="fc" id="L2008">			IwcmFile[] fileList = directory.listFiles();</span>
<span class="fc bfc" id="L2009" title="All 2 branches covered.">			for (IwcmFile file : fileList)</span>
			{
<span class="fc bfc" id="L2011" title="All 4 branches covered.">				if (recursive &amp;&amp; file.isDirectory())</span>
<span class="fc" id="L2012">					resizePicturesInDirectory(file.getVirtualPath(), out, prop, resizeMode, recursive);</span>
<span class="fc bfc" id="L2013" title="All 6 branches covered.">				if (file.isFile() &amp;&amp; !file.getName().startsWith(&quot;s_&quot;) &amp;&amp; !file.getName().startsWith(&quot;o_&quot;))</span>
				{
<span class="fc" id="L2015">					resizePictureImpl(dims, file.getAbsolutePath(), out, prop, resizeMode);</span>
				}
			}
		}
<span class="fc" id="L2019">	}</span>

	/**
	 * Skopiruje subor oldFilePath na newFilePath
	 *
	 *@param oldFilePath
	 *           Description of the Parameter
	 *@param newFilePath
	 *           Description of the Parameter
	 *@return Description of the Return Value
	 */
	public static boolean copyFile(String oldFilePath, String newFilePath)
	{
<span class="fc" id="L2032">		Logger.debug(GalleryDB.class, &quot;copyFile &quot; + oldFilePath + &quot;-&gt;&quot; + newFilePath);</span>
<span class="pc bpc" id="L2033" title="1 of 2 branches missed.">		if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(oldFilePath)))</span>
		{
<span class="nc" id="L2035">			IwcmFsDB.copyTo(new IwcmFile(oldFilePath), new IwcmFile(newFilePath));</span>
<span class="nc" id="L2036">			return true;</span>
		}
		try
		{
<span class="fc" id="L2040">			File newFile = new File(newFilePath);</span>
<span class="fc" id="L2041">			File oldFile = new File(oldFilePath);</span>
<span class="fc bfc" id="L2042" title="All 2 branches covered.">			if (newFile.exists()==false)</span>
			{
<span class="pc bpc" id="L2044" title="1 of 2 branches missed.">				if(newFile.createNewFile() == false) return false;</span>
				//if(newFile.delete() == false) return false;
			}
<span class="fc" id="L2047">			FileInputStream inStream = new FileInputStream(oldFile);</span>
<span class="fc" id="L2048">			FileOutputStream out = new FileOutputStream(newFile);</span>
			int c;
<span class="fc" id="L2050">			byte[] buff = new byte[150000];</span>
<span class="fc bfc" id="L2051" title="All 2 branches covered.">			while ((c = inStream.read(buff)) != -1)</span>
			{
<span class="fc" id="L2053">				out.write(buff, 0, c);</span>
			}
<span class="fc" id="L2055">			out.close();</span>
<span class="fc" id="L2056">			inStream.close();</span>
<span class="fc" id="L2057">			return (true);</span>
		}
<span class="nc" id="L2059">		catch (Exception ex)</span>
		{
<span class="nc" id="L2061">			sk.iway.iwcm.Logger.error(ex);</span>
		}
<span class="nc" id="L2063">		return (false);</span>
	}

	public static Dimension[] getDimension(String dir)
	{
<span class="fc" id="L2068">		return (getDimension(dir, true));</span>
	}

	public static Dimension[] getDimension(String dir, boolean recursive)
	{
<span class="fc" id="L2073">		return (getDimension(dir, recursive, true));</span>
	}

	/**
	 * Ziskanie velkosti foldra
	 * @param dir
	 * @param recursive
	 * @param returnDefault - ak sa nic nenajde a doiteruje sa k root foldru vratia sa default hodnoty
	 * @return
	 */
	public static Dimension[] getDimension(String dir, boolean recursive, boolean returnDefault)
	{
<span class="fc" id="L2085">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L2086">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L2087">		ResultSet rs = null;</span>
<span class="fc" id="L2088">		Dimension dim = null;</span>
<span class="fc" id="L2089">		Dimension dimNormal = null;</span>
<span class="fc" id="L2090">		dir = dir.replace('\\', '/');</span>
		try
		{
<span class="pc bpc" id="L2093" title="1 of 2 branches missed.">			if (!dir.equals(&quot;&quot;))</span>
			{
<span class="fc" id="L2095">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2096">				ps = db_conn.prepareStatement(&quot;SELECT * FROM gallery_dimension WHERE image_path=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L2097">				ps.setString(1, normalizeDir(dir));</span>
<span class="fc" id="L2098">				rs = ps.executeQuery();</span>
<span class="fc bfc" id="L2099" title="All 2 branches covered.">				if (rs.next())</span>
				{
<span class="fc" id="L2101">					dim = new Dimension(rs.getInt(&quot;image_width&quot;), rs.getInt(&quot;image_height&quot;));</span>
<span class="fc" id="L2102">					dimNormal = new Dimension(rs.getInt(&quot;normal_width&quot;), rs.getInt(&quot;normal_height&quot;));</span>
				}
<span class="fc" id="L2104">				rs.close();</span>
<span class="fc" id="L2105">				ps.close();</span>
<span class="fc" id="L2106">				db_conn.close();</span>
<span class="fc" id="L2107">				db_conn = null;</span>
<span class="fc" id="L2108">				ps = null;</span>
<span class="fc" id="L2109">				rs = null;</span>
			}
		}
<span class="nc" id="L2112">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L2115" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2116" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2117" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2118">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="pc bpc" id="L2120" title="2 of 6 branches missed.">		if (recursive &amp;&amp; (dim == null || dimNormal == null))</span>
		{
<span class="fc" id="L2122">			int index = dir.lastIndexOf('/');</span>
<span class="fc bfc" id="L2123" title="All 2 branches covered.">			if (index &gt; 1)</span>
			{
<span class="fc" id="L2125">				String parent = dir.substring(0, index);</span>
<span class="fc" id="L2126">				Logger.debug(GalleryDB.class, &quot;Testujem gallery size parent: &quot; + parent);</span>
<span class="fc" id="L2127">				return (getDimension(parent, recursive, returnDefault));</span>
			}
<span class="pc bpc" id="L2129" title="1 of 2 branches missed.">			else if (returnDefault)</span>
			{
<span class="nc" id="L2131">				dim = new Dimension(160, 120);</span>
<span class="nc" id="L2132">				dimNormal = new Dimension(750, 560);</span>
			}
		}
<span class="fc" id="L2135">		Dimension[] dims = new Dimension[2];</span>
<span class="fc" id="L2136">		dims[0] = dim;</span>
<span class="fc" id="L2137">		dims[1] = dimNormal;</span>
<span class="fc" id="L2138">		return (dims);</span>
	}

	public static String getResizeMode(String dir, boolean recursive)
	{
<span class="fc" id="L2143">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L2144">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L2145">		ResultSet rs = null;</span>
<span class="fc" id="L2146">		dir = dir.replace('\\', '/');</span>
<span class="fc" id="L2147">		String resizeMode = null;</span>
		try
		{
<span class="pc bpc" id="L2150" title="1 of 2 branches missed.">			if (!dir.equals(&quot;&quot;))</span>
			{
<span class="fc" id="L2152">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2153">				ps = db_conn.prepareStatement(&quot;SELECT * FROM gallery_dimension WHERE image_path=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L2154">				ps.setString(1, normalizeDir(dir));</span>
<span class="fc" id="L2155">				rs = ps.executeQuery();</span>
<span class="fc bfc" id="L2156" title="All 2 branches covered.">				if (rs.next())</span>
				{
<span class="fc" id="L2158">					resizeMode = rs.getString(&quot;resize_mode&quot;);</span>
				}
<span class="fc" id="L2160">				rs.close();</span>
<span class="fc" id="L2161">				ps.close();</span>
<span class="fc" id="L2162">				db_conn.close();</span>
<span class="fc" id="L2163">				db_conn = null;</span>
<span class="fc" id="L2164">				ps = null;</span>
<span class="fc" id="L2165">				rs = null;</span>
			}
		}
<span class="nc" id="L2168">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L2171" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2172" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2173" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2174">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="pc bpc" id="L2176" title="1 of 4 branches missed.">		if (recursive &amp;&amp; (Tools.isEmpty(resizeMode)))</span>
		{
<span class="fc" id="L2178">			int index = dir.lastIndexOf('/');</span>
<span class="pc bpc" id="L2179" title="1 of 2 branches missed.">			if (index &gt; 1)</span>
			{
<span class="fc" id="L2181">				String parent = dir.substring(0, index);</span>
<span class="fc" id="L2182">				Logger.debug(GalleryDB.class, &quot;Testujem gallery size parent: &quot; + parent);</span>
<span class="fc" id="L2183">				return (getResizeMode(parent, recursive));</span>
			}
			else
			{
<span class="nc" id="L2187">				resizeMode = null;</span>
			}
		}
<span class="fc" id="L2190">		return (resizeMode);</span>
	}

	public static String getResizeMode(String dir)
	{
<span class="fc" id="L2195">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L2196">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L2197">		ResultSet rs = null;</span>
<span class="fc" id="L2198">		String ret = null;</span>
<span class="fc" id="L2199">		dir = dir.replace('\\', '/');</span>
		try
		{
<span class="pc bpc" id="L2202" title="1 of 2 branches missed.">			if (!dir.equals(&quot;&quot;))</span>
			{
<span class="fc" id="L2204">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L2205">				ps = db_conn.prepareStatement(&quot;SELECT resize_mode FROM gallery_dimension WHERE image_path=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L2206">				ps.setString(1, normalizeDir(dir));</span>
<span class="fc" id="L2207">				rs = ps.executeQuery();</span>
<span class="fc bfc" id="L2208" title="All 2 branches covered.">				if (rs.next())</span>
				{
<span class="fc" id="L2210">					ret = rs.getString(&quot;resize_mode&quot;);</span>
				}
<span class="fc" id="L2212">				rs.close();</span>
<span class="fc" id="L2213">				ps.close();</span>
<span class="fc" id="L2214">				db_conn.close();</span>

<span class="fc" id="L2216">				rs = null;</span>
<span class="fc" id="L2217">				ps = null;</span>
<span class="fc" id="L2218">				db_conn = null;</span>
			}
		}
<span class="nc" id="L2221">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L2224" title="1 of 2 branches missed.">				if (rs != null) rs.close();</span>
<span class="pc bpc" id="L2225" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2226" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L2227">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L2229">		return ret;</span>
	}

	/**
	 * Zo zadanďż˝ho obrďż˝zku na serveri pripravi nahladovy a normalny obrazok
	 *
	 *@param realPath
	 *           cesta k obrazku na serveri
	 *@param dir
	 *           cesta k adresaru s nastavenim velkosti obrazkov galerie
	 *@param request
	 *           Description of the Parameter
	 */
	public static void resizePicture(String realPath, String dir)
	{
<span class="fc" id="L2244">		Dimension[] dims = getDimension(dir);</span>
<span class="fc" id="L2245">		String resizeMode = getResizeMode(dir, true);</span>
<span class="fc" id="L2246">		resizePictureImpl(dims, realPath, null, null, resizeMode);</span>
<span class="fc" id="L2247">	}</span>

	/**
	 * @param dims
	 * @param realPath
	 * @param out
	 * @param prop
	 * @return
	 */
	public static boolean resizePictureImpl(Dimension[] dims, String realPath, PrintWriter out, Prop prop)
	{
<span class="nc" id="L2258">		IwcmFile actualDir = new IwcmFile(realPath);</span>
<span class="nc" id="L2259">		return resizePictureImpl(dims, realPath, out, prop, GalleryDB.getResizeMode(actualDir.getVirtualParent()));</span>
	}

	/**
	 * mody: S - shrink to fit C - crop to fit A - presne rozmery W - presna
	 * sirka H - presna vyska iny - shrink to fit fyzicka zmena velkosti obrazka
	 *
	 * @param dims
	 * @param realPath
	 * @param out
	 */
	public static boolean resizePictureImpl(Dimension[] dims, String realPath, PrintWriter out, Prop prop, String resizeMode)
	{
<span class="fc" id="L2272">		boolean ret = true;</span>
<span class="fc" id="L2273">		File img = new File(realPath);</span>

		//uprava pre fotky zacinajuce na o_ alebo s_
<span class="fc" id="L2276">		String imageName = img.getName();</span>
<span class="pc bpc" id="L2277" title="2 of 4 branches missed.">		while(imageName.startsWith(&quot;o_&quot;) || imageName.startsWith(&quot;s_&quot;))</span>
		{
<span class="nc" id="L2279">			imageName = imageName.substring(2);</span>
		}
<span class="pc bpc" id="L2281" title="1 of 2 branches missed.">		if(!imageName.equals(img.getName()))</span>
		{
<span class="nc" id="L2283">			File renamedFile = new File(img.getParent()+File.separator+imageName);</span>
<span class="nc bnc" id="L2284" title="All 2 branches missed.">			if(img.renameTo(renamedFile))</span>
			{
<span class="nc" id="L2286">				img = renamedFile;</span>
<span class="nc" id="L2287">				realPath = img.getParent()+File.separator+imageName;</span>
			}
		}
		//koniec upravy

<span class="fc" id="L2292">		String imgNameLC = img.getName().toLowerCase();</span>

<span class="pc bpc" id="L2294" title="1 of 6 branches missed.">		if (!imgNameLC.endsWith(&quot;.jpg&quot;) &amp;&amp; !imgNameLC.endsWith(&quot;.gif&quot;) &amp;&amp; !imgNameLC.endsWith(&quot;.png&quot;)</span>
<span class="pc bpc" id="L2295" title="1 of 2 branches missed.">					&amp;&amp; !imgNameLC.endsWith(&quot;.jpeg&quot;))</span>
		{
<span class="nc" id="L2297">			return (false);</span>
		}
<span class="fc" id="L2299">		String realPathSmall = Tools.replace(realPath, img.getName(), &quot;s_&quot; + img.getName());</span>
<span class="fc" id="L2300">		String realPathOrig = Tools.replace(realPath, img.getName(), &quot;o_&quot; + img.getName());</span>
<span class="fc" id="L2301">		String resizeFrom = realPathOrig;</span>
<span class="fc" id="L2302">		Dimension dim = dims[0];</span>
<span class="fc" id="L2303">		Dimension dimNormal = dims[1];</span>

<span class="fc" id="L2305">		IwcmFile normal = new IwcmFile(realPath);</span>

		//ak sa negeneruju miniatury, nevypisem hlasky o ich &quot;generovani&quot;
<span class="fc" id="L2308">		boolean miniatures = true;</span>
<span class="pc bpc" id="L2309" title="2 of 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
<span class="nc" id="L2310">			miniatures = false;</span>


<span class="pc bpc" id="L2313" title="3 of 4 branches missed.">		if (dimNormal.width != 0 || dimNormal.height != 0)</span>
		{
			// zisti ci mame original obrazok
<span class="fc" id="L2316">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="pc bpc" id="L2317" title="2 of 6 branches missed.">			if ((original.exists() == false || original.length()&lt;1) &amp;&amp; miniatures)</span>
			{
				// skopiruj ho
<span class="fc" id="L2320">				copyFile(realPath, realPathOrig);</span>
			}
<span class="pc bpc" id="L2322" title="5 of 6 branches missed.">			if (out != null &amp;&amp; prop != null &amp;&amp; miniatures)</span>
			{
<span class="nc" id="L2324">				println(out, prop.getText(&quot;gallery.resizing.normal&quot;) + &quot;: &quot; + normal.getName());</span>
			}
			// resizni
<span class="fc" id="L2327">			int status = resizePicture(realPathOrig, realPath, dimNormal.getWidth(), dimNormal.getHeight(), resizeMode);</span>
<span class="fc bfc" id="L2328" title="All 2 branches covered.">			if (status &gt; 0)</span>
			{
<span class="fc" id="L2330">				ret = false;</span>
<span class="pc bpc" id="L2331" title="3 of 4 branches missed.">				if (out != null &amp;&amp; prop != null)</span>
				{
<span class="nc" id="L2333">					println(out, normal.getName() + &quot;: &lt;span class='error'&gt;&quot; + prop.getText(&quot;gallery.resizing.error_&quot; + status)</span>
								+ &quot;&lt;/span&gt;&quot;);
				}
			}
<span class="fc" id="L2337">		}</span>
		else
		{
			// zisti ci mame original obrazok
<span class="nc" id="L2341">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="nc bnc" id="L2342" title="All 4 branches missed.">			if (original.exists() == true &amp;&amp; original.length()&gt;0)</span>
			{
				// skopiruj original na normal
<span class="nc" id="L2345">				copyFile(realPathOrig, realPath);</span>
<span class="nc" id="L2346">				resizeFrom = realPath;</span>
			}
			else
			{
				// vytvorim ho ako kopia normal do original
<span class="nc" id="L2351">				copyFile(realPath, realPathOrig);</span>
			}
<span class="nc bnc" id="L2353" title="All 6 branches missed.">			if (out != null &amp;&amp; prop != null &amp;&amp; miniatures)</span>
			{
<span class="nc" id="L2355">				println(out, prop.getText(&quot;gallery.resizing.normal&quot;) + &quot;: &quot; + normal.getName());</span>
			}
		}
<span class="pc bpc" id="L2358" title="5 of 6 branches missed.">		if (out != null &amp;&amp; prop != null &amp;&amp; miniatures)</span>
		{
<span class="nc" id="L2360">			println(out, prop.getText(&quot;gallery.resizing.preview&quot;) + &quot;: s_&quot; + normal.getName());</span>
		}
<span class="fc" id="L2362">		int status = resizePicture(resizeFrom, realPathSmall, dim.getWidth(), dim.getHeight(), resizeMode);</span>
<span class="pc bpc" id="L2363" title="1 of 2 branches missed.">		if (status &gt; 0)</span>
		{
<span class="nc" id="L2365">			ret = false;</span>
<span class="nc bnc" id="L2366" title="All 4 branches missed.">			if (out != null &amp;&amp; prop != null)</span>
			{
<span class="nc" id="L2368">				println(out, normal.getName() + &quot;: &lt;span class='error'&gt;&quot; + prop.getText(&quot;gallery.resizing.error_&quot; + status)</span>
							+ &quot;&lt;/span&gt;&quot;);
			}
		}

<span class="pc bpc" id="L2373" title="2 of 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
		{
<span class="nc" id="L2375">			IwcmFile small = new IwcmFile(realPathSmall);</span>
<span class="nc bnc" id="L2376" title="All 2 branches missed.">			if(small.exists())</span>
<span class="nc bnc" id="L2377" title="All 4 branches missed.">				ret = small.delete() &amp;&amp; ret;</span>
<span class="nc" id="L2378">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="nc bnc" id="L2379" title="All 2 branches missed.">			if(original.exists())</span>
<span class="nc bnc" id="L2380" title="All 4 branches missed.">				ret = original.delete() &amp;&amp; ret;</span>
		}

<span class="fc" id="L2383">		return (ret);</span>
	}

	/**
	 * fyzicka zmena velkosti obrazka
	 *
	 * @param dims
	 * @param realPath
	 * @param out
	 */
	public static boolean resizePictureEdit(Dimension[] dims, String realPathOrig, PrintWriter out, Prop prop)
	{
<span class="nc" id="L2395">		boolean ret = true;</span>
<span class="nc" id="L2396">		IwcmFile img = new IwcmFile(realPathOrig);</span>

<span class="nc" id="L2398">		String realPathSmall = Tools.replace(realPathOrig, img.getName(), &quot;s_&quot; + img.getName().substring(2));</span>
		// odstran o_
<span class="nc" id="L2400">		String realPath = Tools.replace(realPathOrig, img.getName(), img.getName().substring(2));</span>
<span class="nc" id="L2401">		String resizeFrom = realPath;</span>
<span class="nc" id="L2402">		Dimension dim = dims[0];</span>
<span class="nc" id="L2403">		Dimension dimNormal = dims[1];</span>
<span class="nc bnc" id="L2404" title="All 4 branches missed.">		if (dimNormal.width != 0 &amp;&amp; dimNormal.height != 0)</span>
		{
			// zisti ci mame original obrazok
<span class="nc" id="L2407">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="nc bnc" id="L2408" title="All 2 branches missed.">			if (original.exists() == false)</span>
			{
				// skopiruj ho
<span class="nc" id="L2411">				copyFile(realPathOrig, realPath);</span>
			}
<span class="nc bnc" id="L2413" title="All 4 branches missed.">			if (out != null &amp;&amp; prop != null)</span>
			{
				// println(out, prop.getText(&quot;gallery.resizing.normal&quot;) + &quot;: &quot; +
				// normal.getName());
			}
			// resizni
<span class="nc" id="L2419">			int status = resizePicture(realPathOrig, realPath, dimNormal.getWidth(), dimNormal.getHeight());</span>
<span class="nc bnc" id="L2420" title="All 2 branches missed.">			if (status &gt; 0)</span>
			{
<span class="nc" id="L2422">				ret = false;</span>
<span class="nc bnc" id="L2423" title="All 4 branches missed.">				if (out != null &amp;&amp; prop != null)</span>
				{
					// println(out, normal.getName() + &quot;: &lt;span class='error'&gt;&quot; +
					// prop.getText(&quot;gallery.resizing.error_&quot; + status)+&quot;&lt;/span&gt;&quot;);
				}
			}
<span class="nc" id="L2429">			resizeFrom = realPathOrig;</span>
<span class="nc" id="L2430">		}</span>
		else
		{
<span class="nc" id="L2433">			resizeFrom = realPathOrig;</span>
			// skopiruj original na normal
<span class="nc" id="L2435">			IwcmFile original = new IwcmFile(realPathOrig);</span>
<span class="nc bnc" id="L2436" title="All 2 branches missed.">			if (original.exists() == true)</span>
			{
				// skopiruj ho
<span class="nc" id="L2439">				copyFile(realPathOrig, realPath);</span>
			}
		}
<span class="nc bnc" id="L2442" title="All 4 branches missed.">		if (out != null &amp;&amp; prop != null)</span>
		{
			// println(out, prop.getText(&quot;gallery.resizing.preview&quot;) + &quot;: s_&quot; +
			// normal.getName());
		}
<span class="nc" id="L2447">		int status = resizePicture(resizeFrom, realPathSmall, dim.getWidth(), dim.getHeight());</span>
<span class="nc bnc" id="L2448" title="All 2 branches missed.">		if (status &gt; 0)</span>
		{
<span class="nc" id="L2450">			ret = false;</span>
<span class="nc bnc" id="L2451" title="All 4 branches missed.">			if (out != null &amp;&amp; prop != null)</span>
			{
				// println(out, normal.getName() + &quot;: &lt;span class='error'&gt;&quot; +
				// prop.getText(&quot;gallery.resizing.error_&quot; + status)+&quot;&lt;/span&gt;&quot;);
			}
		}

<span class="nc" id="L2458">		String resizeMode = getResizeMode(img.getVirtualParent(), true);</span>
<span class="nc bnc" id="L2459" title="All 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
		{
<span class="nc" id="L2461">			IwcmFile small = new IwcmFile(realPathSmall);</span>
<span class="nc" id="L2462">			IwcmFile normal = new IwcmFile(realPath);</span>
<span class="nc bnc" id="L2463" title="All 2 branches missed.">			if(small.exists())</span>
<span class="nc bnc" id="L2464" title="All 4 branches missed.">				ret = small.delete() &amp;&amp; ret;</span>
<span class="nc bnc" id="L2465" title="All 2 branches missed.">			if(normal.exists())</span>
<span class="nc bnc" id="L2466" title="All 4 branches missed.">				ret = normal.delete() &amp;&amp; ret;</span>
		}

<span class="nc" id="L2469">		return (ret);</span>
	}

	/**
	 * Resizne obrazok, vrati: 0-vsetko je OK 1-obrazok je uz teraz mensi
	 * 2-nepodarilo sa ulozit obrazok 3-nastala neznama chyba 4-obrazok je v
	 * nepodporovanom formate
	 *
	 *@param realPath
	 *           Description of the Parameter
	 *@param realPathSmall
	 *           Description of the Parameter
	 *@param width
	 *           Description of the Parameter
	 *@param height
	 *           Description of the Parameter
	 */
	public static int resizePicture(String realPath, String realPathSmall, double width, double height)
	{
<span class="fc" id="L2488">		int status = resizePicture(realPath, realPathSmall, width, height, &quot;&quot;);</span>
<span class="fc" id="L2489">		return status;</span>
	}

	/**
	 * Prida vodotlac
	 *
	 * @param realPath Absolutna cesta k obrazku, nad ktorym sa bude prevadzat vodotlac
	 */
	private static void performWatermarking(String realPath)
	{
		//o_ stands for original image
<span class="pc bpc" id="L2500" title="2 of 6 branches missed.">		boolean shouldPerformWatermarking = (!realPath.contains(&quot;/o_&quot;) &amp;&amp; existImageMagickCompositeCommand()) &amp;&amp; Constants.getBoolean(&quot;galleryEnableWatermarking&quot;);</span>
<span class="fc bfc" id="L2501" title="All 2 branches covered.">		if (shouldPerformWatermarking)</span>
		{
<span class="fc" id="L2503">			String galleryPath = new IwcmFile(realPath).getVirtualParent();</span>
<span class="fc" id="L2504">			GalleryDimension galleryContainingImage = getGalleryInfo(galleryPath, -1);</span>
<span class="pc bpc" id="L2505" title="1 of 2 branches missed.">			if (galleryContainingImage!=null) {</span>
<span class="fc" id="L2506">				GalleryDimension watermark = findWaterMarkFor(galleryContainingImage);</span>
<span class="fc bfc" id="L2507" title="All 2 branches covered.">				if (watermark.getWatermark() != null)</span>
<span class="fc" id="L2508">					addWatermarkSignature(realPath, watermark);</span>
			}
		}
<span class="fc" id="L2511">	}</span>

	private static boolean existImageMagickCompositeCommand()
	{	
<span class="pc bpc" id="L2515" title="1 of 2 branches missed.">		String filename = System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;win&quot;) ? &quot;magick.exe&quot; : &quot;composite&quot;;</span>
<span class="fc" id="L2516">		return new IwcmFile(Constants.getString(&quot;imageMagickDir&quot;), filename).exists();</span>
	}

	/**
	 * Najde vodotlac aj s nastaveniami sytosti farieb a polohy. Hlada
	 * v zadanom adresari a vsetkych nadadresaroch az kym dosiahne /images/gallery
	 */
	public static GalleryDimension findWaterMarkFor(GalleryDimension leaf)
	{
<span class="fc" id="L2525">		Logger.debug(GalleryDB.class, String.format(&quot;Watermark lookup for %s&quot;, leaf.getGalleryPath()));</span>
<span class="fc" id="L2526">		List&lt;GalleryDimension&gt; dirs = getDirectoriesToGalleryRoot(leaf);</span>

<span class="fc bfc" id="L2528" title="All 2 branches covered.">		for (GalleryDimension dir : dirs)</span>
		{
<span class="pc bpc" id="L2530" title="1 of 4 branches missed.">			if (dir.getWatermark() == null || isEmpty(dir.getGalleryPath()))</span>
<span class="nc" id="L2531">				continue;</span>
<span class="pc bpc" id="L2532" title="1 of 2 branches missed.">			if (dir.getWatermark().exists())</span>
			{
<span class="fc" id="L2534">				Logger.debug(GalleryDB.class, String.format(&quot;Watermark found: %s&quot;, dir.getWatermark().getVirtualPath()));</span>
<span class="fc" id="L2535">				return dir;</span>
			}
<span class="nc" id="L2537">		}</span>

<span class="fc" id="L2539">		Logger.debug(GalleryDB.class, &quot;No watermark found&quot;);</span>
		//default if nothing is found
<span class="fc" id="L2541">		GalleryDimension nullWatermark = new GalleryDimension();</span>
<span class="fc" id="L2542">		nullWatermark.setWatermarkPlacement(Constants.getString(&quot;galleryWatermarkGravity&quot;));</span>
<span class="fc" id="L2543">		nullWatermark.setWatermarkSaturation(Constants.getInt(&quot;galleryWatermarkSaturation&quot;));</span>
<span class="fc" id="L2544">		nullWatermark.setGalleryPath(&quot;/images/gallery&quot;);</span>
<span class="fc" id="L2545">		return nullWatermark;</span>
	}

	private static List&lt;GalleryDimension&gt; getDirectoriesToGalleryRoot(GalleryDimension dir)
	{
<span class="fc" id="L2550">		String pathToGallery = &quot;/images/gallery&quot;; //NOSONAR</span>
<span class="fc" id="L2551">		List&lt;GalleryDimension&gt; upDirs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L2552">		GalleryDimension currentDir = dir;</span>
<span class="pc bpc" id="L2553" title="1 of 4 branches missed.">		while(currentDir != null &amp;&amp; currentDir.getGalleryPath().startsWith(pathToGallery))</span>
		{
<span class="fc" id="L2555">			upDirs.add(currentDir);</span>
<span class="fc" id="L2556">			String nextGalleryPath = IwcmFile.fromVirtualPath(currentDir.getGalleryPath()).getVirtualParent();</span>
<span class="fc" id="L2557">			currentDir = getGalleryInfo(nextGalleryPath, -1);</span>
<span class="fc" id="L2558">		}</span>
<span class="fc" id="L2559">		return upDirs;</span>
	}


	/**
	 * Samotny kod, ktory sposobi pridanie vodotlace do obrazku. Spolieha
	 * sa na kniznicu imageMagick a jej program &quot;composite&quot; s parametrom &quot;-watermark&quot;
	 * Cely prikaz vyzera podobne ako:
	 *  /usr/bin/composite -watermark 70x70 /watermark.png -gravity SouthWest /dest.jpg /dest.jpg
	 */
	private static void addWatermarkSignature(String realPath, GalleryDimension watermark)
	{
<span class="fc" id="L2571">		List&lt;String&gt; args = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L2573" title="1 of 2 branches missed.">		String filename = System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;win&quot;) ? &quot;magick.exe&quot; : &quot;composite&quot;;</span>
<span class="fc" id="L2574">		String command = new IwcmFile(Constants.getString(&quot;imageMagickDir&quot;), filename).getAbsolutePath();</span>

<span class="fc" id="L2576">		String watermarkPath = watermark.getWatermark().getAbsolutePath();</span>
<span class="fc" id="L2577">		IwcmFile imageFile = new IwcmFile(realPath);</span>
<span class="fc" id="L2578">		Logger.debug(GalleryDB.class, &quot;imageFile=&quot;+imageFile.getName());</span>
<span class="fc bfc" id="L2579" title="All 2 branches covered.">		if (imageFile.getName().startsWith(&quot;s_&quot;))</span>
		{
			//skus najst s_watermark subor
<span class="fc" id="L2582">			watermarkPath = Tools.getRealPath(getImagePathSmall(watermark.getWatermark().getVirtualPath()));</span>
<span class="fc" id="L2583">			Logger.debug(GalleryDB.class, &quot;testing S_watermark: &quot;+watermarkPath);</span>
		}

<span class="fc" id="L2586">		args.add(command);</span>
<span class="pc bpc" id="L2587" title="1 of 2 branches missed.">		if (filename.contains(&quot;magick.exe&quot;))</span>
<span class="nc" id="L2588">			args.add(&quot;composite&quot;);</span>
<span class="fc" id="L2589">		args.add(&quot;-dissolve&quot;);</span>
<span class="fc" id="L2590">		args.add(watermark.getWatermarkSaturation()+&quot;%&quot;);</span>

<span class="pc bpc" id="L2592" title="1 of 2 branches missed.">		if (watermarkPath.endsWith(&quot;.svg&quot;))</span>
		{
			//je to SVG obrazok, musime zistit rozmer orig obrazku a prepocitat velkost watermarku
<span class="fc" id="L2595">			ImageInfo ii = new ImageInfo(imageFile);</span>
<span class="fc" id="L2596">			int originalHeight = ii.getHeight();</span>
<span class="fc" id="L2597">			int svgHeight = (int)Math.round(originalHeight * (Constants.getInt(&quot;galleryWatermarkSvgSizePercent&quot;)/100d));</span>
<span class="fc bfc" id="L2598" title="All 2 branches covered.">			if (svgHeight &lt; Constants.getInt(&quot;galleryWatermarkSvgMinHeight&quot;)) svgHeight = Constants.getInt(&quot;galleryWatermarkSvgMinHeight&quot;);</span>

			//pockaj na GFS
<span class="fc" id="L2601">			MetadataCleaner.waitForGfs();</span>

<span class="fc" id="L2603">			args.add(&quot;-geometry&quot;);</span>
<span class="fc" id="L2604">			args.add(&quot;x&quot;+svgHeight+&quot;+0&quot;);</span>
<span class="fc" id="L2605">			args.add(&quot;-background&quot;);</span>
<span class="fc" id="L2606">			args.add(&quot;none&quot;);</span>
		}


<span class="fc" id="L2610">		args.add(watermarkPath);</span>
<span class="fc" id="L2611">		args.add(&quot;-gravity&quot;);</span>
<span class="fc" id="L2612">		args.add(watermark.getWatermarkPlacement());</span>
<span class="fc" id="L2613">		args.add(realPath); //zdrojovy subor</span>
<span class="fc" id="L2614">		args.add(realPath); //cielovy subor</span>
<span class="fc" id="L2615">		Logger.debug(GalleryDB.class, &quot;Watermark executing:\n&quot; + StringUtils.join(args.iterator(), ' '));</span>

		try
		{
<span class="fc" id="L2619">			Process pr = Runtime.getRuntime().exec(args.toArray(new String[0]));</span>
<span class="fc" id="L2620">			pr.waitFor();</span>
		}
<span class="pc" id="L2622">		catch (Exception e){sk.iway.iwcm.Logger.error(e);}</span>

		//pridaj vodotlac aj do originalneho suboru, nielen do s_
<span class="fc bfc" id="L2625" title="All 2 branches covered.">		if (imageFile.getName().startsWith(&quot;s_&quot;))</span>
		{
<span class="fc" id="L2627">			String originalPath = imageFile.getParent()+File.separatorChar+imageFile.getName().replace(&quot;s_&quot;, &quot;&quot;);</span>
<span class="fc" id="L2628">			addWatermarkSignature(originalPath, watermark);</span>
		}
<span class="fc" id="L2630">	}</span>

	/**
	 * Resizne obrazok, vrati: 0-vsetko je OK 1-obrazok je uz teraz mensi
	 * 2-nepodarilo sa ulozit obrazok 3-nastala neznama chyba 4-obrazok je v
	 * nepodporovanom formate
	 *
	 *@param realPath
	 *@param realPathSmall
	 *@param width
	 *@param height
	 *@param resizeMode
	 */
	public static int resizePicture(String realPath, String realPathSmall, double width, double height, String resizeMode)
	{
<span class="pc bpc" id="L2645" title="2 of 4 branches missed.">		if(resizeMode!=null &amp;&amp; resizeMode.equals(&quot;N&quot;))</span>
		{
<span class="nc" id="L2647">			IwcmFile fOrigImg = new IwcmFile(realPath);</span>
<span class="nc" id="L2648">			String imageName = fOrigImg.getName();</span>
<span class="nc bnc" id="L2649" title="All 4 branches missed.">			if (imageName.startsWith(&quot;s_&quot;) || imageName.startsWith(&quot;o_&quot;))</span>
<span class="nc" id="L2650">				imageName = imageName.substring(2);</span>
<span class="nc" id="L2651">			GalleryDB.setImage(fOrigImg.getVirtualParent(), imageName);</span>
<span class="nc" id="L2652">			return (0);</span>
		}

<span class="fc" id="L2655">		width = limitMaxSize(width);</span>
<span class="fc" id="L2656">		height = limitMaxSize(height);</span>

<span class="fc" id="L2658">		Logger.debug(GalleryDB.class, &quot;resizePicture(&quot; + realPath + &quot;,&quot; + realPathSmall + &quot;,&quot; + width + &quot;,&quot; + height+&quot;, &quot;+resizeMode);</span>
<span class="fc" id="L2659">		IwcmInputStream input=null;</span>
		try
		{
<span class="fc" id="L2662">			IwcmFile fSmallImg = new IwcmFile(realPathSmall);</span>
<span class="fc" id="L2663">			IwcmFile fOrigImg = new IwcmFile(realPath);</span>

<span class="fc bfc" id="L2665" title="All 2 branches covered.">			if (Tools.isEmpty(resizeMode))</span>
			{
				//skus vydedkukovat
<span class="fc" id="L2668">				String dir = fOrigImg.getVirtualParent();</span>
<span class="fc" id="L2669">				resizeMode = getResizeMode(dir);</span>
<span class="fc" id="L2670">				Logger.debug(GalleryDB.class, &quot;Forcing resize mode to:&quot;+resizeMode+&quot; for dir:&quot;+dir);</span>
			}

<span class="fc" id="L2673">			String imageName = fOrigImg.getName();</span>
<span class="fc bfc" id="L2674" title="All 4 branches covered.">			if (imageName.startsWith(&quot;s_&quot;) || imageName.startsWith(&quot;o_&quot;))</span>
<span class="fc" id="L2675">				imageName = imageName.substring(2);</span>

<span class="fc bfc" id="L2677" title="All 2 branches covered.">			if (realPathSmall.indexOf(Tools.replace(Constants.getString(&quot;thumbServletCacheDir&quot;), &quot;/&quot;, String.valueOf(File.separatorChar) ))==-1)</span>
			{
				//toto vykoname len ak sa nejedna o thumb obrazok
				//ulozi obrazok do tabulky gallery, ak je uz ulozeny a nema nastaveny upload_datetime, tak ho nastavi

				//Check if it's pixabay
<span class="fc" id="L2683">				String pixabayName = GalleryDB.getImagePathNormal( fSmallImg.getName() );</span>
<span class="fc bfc" id="L2684" title="All 2 branches covered.">				if( Tools.isNotEmpty( GalleryService.getPixabayImageUrl(pixabayName, false) ) )</span>
<span class="fc" id="L2685">					imageName = pixabayName;</span>

<span class="fc" id="L2687">				GalleryDB.setImage(fOrigImg.getVirtualParent(), imageName);</span>
			}

<span class="fc" id="L2690">			String realPathLC = realPath.toLowerCase();</span>
<span class="pc bpc" id="L2691" title="2 of 4 branches missed.">			if (fOrigImg.isFile() &amp;&amp; FileTools.isImage(realPathLC))</span>
			{
<span class="fc" id="L2693">				double scaleFactor = 0.3;</span>
				// opener = new Opener();
				// imp = opener.openImage(realPath);
<span class="fc" id="L2696">				ImageInfo originalImage = new ImageInfo();</span>
<span class="fc" id="L2697">				input=new IwcmInputStream(realPath);</span>
<span class="fc" id="L2698">				originalImage.setInput(input);</span>
<span class="fc" id="L2699">				originalImage.check();</span>
<span class="pc bpc" id="L2700" title="2 of 4 branches missed.">				if (originalImage.getWidth() &lt; 1 || originalImage.getHeight() &lt; 1)</span>
<span class="nc" id="L2701">					return (-4);</span>
				// BufferedImage originalImage = ImageIO.read(fOrigImg);
<span class="fc" id="L2703">				IwcmFile fDestDir = (new IwcmFile(realPathSmall)).getParentFile();</span>
<span class="fc bfc" id="L2704" title="All 2 branches covered.">				if (fDestDir.exists() == false)</span>
<span class="fc" id="L2705">					fDestDir.mkdirs();</span>
<span class="fc" id="L2706">				int w = (int) width;</span>
<span class="fc" id="L2707">				int h = (int) height;</span>
				// u crop suradnice laveho horneho rohu
<span class="fc" id="L2709">				int x = 0;</span>
<span class="fc" id="L2710">				int y = 0;</span>
<span class="fc" id="L2711">				int pom_w = 0;</span>
<span class="fc" id="L2712">				int pom_h = 0;</span>
<span class="fc" id="L2713">				double pomer = (double) originalImage.getWidth() / (double) originalImage.getHeight();</span>
<span class="fc" id="L2714">				boolean resizeAndCrop = false;</span>
<span class="fc bfc" id="L2715" title="All 2 branches covered.">				if (&quot;A&quot;.equals(resizeMode))</span>
				{// presny rozmer
				}
<span class="fc bfc" id="L2718" title="All 2 branches covered.">				else if (&quot;C&quot;.equals(resizeMode))</span>
				{
					// crop
<span class="fc bfc" id="L2721" title="All 4 branches covered.">					if (originalImage.getWidth() &gt; w &amp;&amp; originalImage.getHeight() &gt; h)</span>
					{
						// zmensit a orezat
<span class="fc" id="L2724">						pom_w = w;</span>
<span class="fc" id="L2725">						pom_h = h;</span>
<span class="fc" id="L2726">						resizeAndCrop = true;</span>
<span class="fc" id="L2727">						h = (int) Math.round(w * 1 / pomer);</span>
<span class="fc bfc" id="L2728" title="All 2 branches covered.">						if (h &lt; pom_h)</span>
						{
<span class="fc" id="L2730">							h = pom_h;</span>
<span class="fc" id="L2731">							w = (int) Math.round(h * pomer);</span>
							// orezeme so sirky
<span class="fc" id="L2733">							y = 0;</span>
<span class="fc" id="L2734">							x = (w - pom_w) / 2;</span>
						}
						else
						{
							// orezeme s vysky
<span class="fc" id="L2739">							x = 0;</span>
<span class="fc" id="L2740">							y = (h - pom_h) / 2;</span>
						}
					}
<span class="fc bfc" id="L2743" title="All 4 branches covered.">					else if (w &gt; originalImage.getWidth() &amp;&amp; h &lt;= originalImage.getHeight())</span>
					{
						// orezat z vysky
<span class="fc" id="L2746">						x = 0;</span>
<span class="fc" id="L2747">						w = originalImage.getWidth();</span>
<span class="fc" id="L2748">						y = (originalImage.getHeight() - h) / 2;</span>
					}
<span class="pc bpc" id="L2750" title="1 of 4 branches missed.">					else if (w &lt;= originalImage.getWidth() &amp;&amp; h &gt; originalImage.getHeight())</span>
					{
						// orezat so sirky
<span class="fc" id="L2753">						y = 0;</span>
<span class="fc" id="L2754">						h = originalImage.getHeight();</span>
<span class="fc" id="L2755">						x = (originalImage.getWidth() - w) / 2;</span>
					}
					else
					{

<span class="fc" id="L2760">						copyFile(realPath, realPathSmall);</span>
						//convertCmykToRgb(realPathSmall);
<span class="fc" id="L2762">						stripExif(realPathSmall);</span>

<span class="fc" id="L2764">						return (1);</span>
					}
					/*
					 * } else { w = originalImage.getWidth(); }
					 * if(originalImage.getHeight() &gt; h) { y =
					 * (originalImage.getHeight() - h)/2; } else { h =
					 * originalImage.getHeight(); }
					 */
				}
<span class="pc bpc" id="L2773" title="1 of 2 branches missed.">				else if (&quot;W&quot;.equals(resizeMode))</span>
				{// presna sirka
<span class="nc" id="L2775">					h = (int) Math.round(w * 1 / pomer);</span>
				}
<span class="pc bpc" id="L2777" title="1 of 2 branches missed.">				else if (&quot;H&quot;.equals(resizeMode))</span>
				{// presna vyska
<span class="nc" id="L2779">					w = (int) Math.round(h * pomer);</span>
				}
				else
				{
					// ak je obrazok uz teraz mensi, nerob nic
<span class="pc bpc" id="L2784" title="1 of 4 branches missed.">					if (originalImage.getWidth() &lt; w &amp;&amp; originalImage.getHeight() &lt; h)</span>
					{

						// skopiruj original na novy (ak bola nejaka operacia v
						// ImageTools)
<span class="fc" id="L2789">						copyFile(realPath, realPathSmall);</span>
						// skonvertuj do RGB ak treba a je nastavene
						//convertCmykToRgb(realPathSmall);

<span class="fc" id="L2793">						stripExif(realPathSmall);</span>
<span class="fc" id="L2794">						return (1);</span>
					}
<span class="pc bpc" id="L2796" title="3 of 4 branches missed.">					if (width &lt; 0 &amp;&amp; height &lt; 0)</span>
					{
<span class="nc" id="L2798">						w = (int) -width;</span>
<span class="nc" id="L2799">						h = (int) -height;</span>
					}
<span class="pc bpc" id="L2801" title="2 of 4 branches missed.">					else if (width &gt; 1 &amp;&amp; height &gt; 1)</span>
					{
<span class="fc" id="L2803">						scaleFactor = (width * 1.0) / (originalImage.getWidth() * 1.0);</span>
<span class="fc" id="L2804">						int newHeight = (int) (originalImage.getHeight() * scaleFactor);</span>
<span class="pc bpc" id="L2805" title="1 of 2 branches missed.">						if (newHeight &gt; height)</span>
						{
<span class="nc" id="L2807">							scaleFactor = (height * 1.0) / (originalImage.getHeight() * 1.0);</span>
<span class="nc" id="L2808">							w = (int) (originalImage.getWidth() * scaleFactor);</span>
<span class="nc" id="L2809">							h = (int) height;</span>
						}
						else
						{
<span class="fc" id="L2813">							w = (int) width;</span>
<span class="fc" id="L2814">							h = (int) (originalImage.getHeight() * scaleFactor);</span>
						}
<span class="fc" id="L2816">					}</span>
<span class="nc bnc" id="L2817" title="All 2 branches missed.">					else if (width &gt; 1)</span>
					{
<span class="nc" id="L2819">						scaleFactor = (width * 1.0) / (originalImage.getWidth() * 1.0);</span>
						// Logger.println(GalleryDB.class,&quot;scaleFactor: &quot; +
						// scaleFactor);
<span class="nc" id="L2822">						w = (int) width;</span>
<span class="nc" id="L2823">						h = (int) (originalImage.getHeight() * scaleFactor);</span>
					}
<span class="nc bnc" id="L2825" title="All 2 branches missed.">					else if (height &gt; 1)</span>
					{
<span class="nc" id="L2827">						scaleFactor = (height * 1.0) / (originalImage.getHeight() * 1.0);</span>
<span class="nc" id="L2828">						w = (int) (originalImage.getWidth() * scaleFactor);</span>
<span class="nc" id="L2829">						h = (int) height;</span>
					}
				}

<span class="fc" id="L2833">				w = GalleryDBTools.limitMaxSize(w);</span>
<span class="fc" id="L2834">				h = GalleryDBTools.limitMaxSize(h);</span>

<span class="fc bfc" id="L2836" title="All 2 branches covered.">				if (fSmallImg.exists())</span>
				{
					//netreba, convert subor prepise fSmallImg.delete();
				}
<span class="fc" id="L2840">				String imageMagickDir = getImageMagicDir();</span>
				// mame ho aj dostupny
<span class="fc" id="L2842">				boolean convertExists = false;</span>
<span class="fc" id="L2843">				String runtimeFile = getRuntimeFile();</span>

<span class="pc bpc" id="L2845" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(imageMagickDir))</span>
				{
<span class="fc" id="L2847">					File f = new File(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="pc bpc" id="L2848" title="2 of 4 branches missed.">					if (f.exists() &amp;&amp; f.canRead())</span>
					{
<span class="fc" id="L2850">						convertExists = true;</span>
					}
				}
<span class="pc bpc" id="L2853" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(imageMagickDir)</span>
<span class="fc bfc" id="L2854" title="All 4 branches covered.">							&amp;&amp; (originalImage.getWidth() &gt; 500 || originalImage.getHeight() &gt; 500 || Constants</span>
<span class="pc bpc" id="L2855" title="2 of 4 branches missed.">										.getBoolean(&quot;galleryAlwaysUseImageMagick&quot;)) &amp;&amp; convertExists)</span>
				{
<span class="fc" id="L2857">					Logger.debug(GalleryDB.class, &quot;executing image magick: &quot; + imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="fc" id="L2858">					Runtime rt = Runtime.getRuntime();</span>
<span class="fc" id="L2859">					File resizePomFile = null;</span>
<span class="fc" id="L2860">					List&lt;String&gt; args = null;</span>
<span class="fc" id="L2861">					boolean galleryStripExif = Constants.getBoolean(&quot;galleryStripExif&quot;);</span>

<span class="fc" id="L2863">					String pripona = realPathSmall.substring(realPathSmall.lastIndexOf('.'));</span>

<span class="fc bfc" id="L2865" title="All 2 branches covered.">					if (&quot;C&quot;.equals(resizeMode))</span>
					{
						// crop image
<span class="fc bfc" id="L2868" title="All 2 branches covered.">						if (resizeAndCrop)</span>
						{
							// zmensit a orezat
							// longCmd = imageMagickDir + File.separatorChar +
							// runtimeFile + &quot; '&quot; + realPath + &quot;' -resize &quot; + w + &quot;x&quot; +
							// h + &quot;! '&quot; + realPathSmall+&quot;_pomresize'&quot;;
<span class="fc" id="L2874">							String pomresize = Tools.replace(realPathSmall, pripona, &quot;.pomresize&quot; + pripona);</span>
<span class="fc" id="L2875">							args = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L2877" title="1 of 2 branches missed.">							if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPath)))</span>
							{
<span class="nc" id="L2879">								IwcmFsDB.writeFileToDisk(new File(realPath),new File(IwcmFsDB.getTempFilePath(realPath)));</span>
<span class="nc" id="L2880">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2881">								args.add(IwcmFsDB.getTempFilePath(realPath));</span>
<span class="nc" id="L2882">								args.add(&quot;-resize&quot;);</span>
<span class="nc" id="L2883">								args.add(w + &quot;x&quot; + h + &quot;!&quot;);</span>
<span class="nc bnc" id="L2884" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2885" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2886">								args.add(IwcmFsDB.getTempFilePath(pomresize));</span>
							}
							else
							{
<span class="fc" id="L2890">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="fc" id="L2891">								args.add(realPath);</span>
<span class="fc" id="L2892">								args.add(&quot;-resize&quot;);</span>
<span class="fc" id="L2893">								args.add(w + &quot;x&quot; + h + &quot;!&quot;);</span>
<span class="pc bpc" id="L2894" title="1 of 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="pc bpc" id="L2895" title="1 of 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="fc" id="L2896">								args.add(pomresize);</span>
							}

<span class="fc" id="L2899">							StringBuilder params = new StringBuilder();</span>
<span class="pc bpc" id="L2900" title="1 of 2 branches missed.">							if (args != null)</span>
							{
<span class="fc bfc" id="L2902" title="All 2 branches covered.">								for (int i = 0; i &lt; args.size(); i++)</span>
								{
<span class="fc" id="L2904">									params.append(' ').append(args.get(i));</span>
								}
							}
<span class="fc" id="L2907">							Logger.debug(GalleryDB.class, &quot;LONGCMD:\n&quot; + params);</span>
<span class="fc" id="L2908">							Process proc = rt.exec(args.toArray(new String[0]));</span>
<span class="fc" id="L2909">							InputStream stderr = proc.getErrorStream();</span>
<span class="fc" id="L2910">							BufferedReader br = new BufferedReader(new InputStreamReader(stderr, Constants.FILE_ENCODING));</span>
<span class="fc" id="L2911">							String line = null;</span>
<span class="pc bpc" id="L2912" title="1 of 2 branches missed.">							while ((line = br.readLine()) != null)</span>
							{
<span class="nc" id="L2914">								Logger.debug(GalleryDB.class, line);</span>
							}
<span class="fc" id="L2916">							br.close();</span>
<span class="fc" id="L2917">							int exitValue = proc.waitFor();</span>
<span class="fc" id="L2918">							Logger.debug(GalleryDB.class, &quot;ExitValue: &quot; + exitValue);</span>
							// longCmd = imageMagickDir + File.separatorChar +
							// runtimeFile +&quot; '&quot; + realPathSmall+&quot;_pomresize&quot; + &quot;' '&quot; +
							// realPath + &quot;' -crop &quot; + w + &quot;x&quot; + h + &quot;+&quot;+ x + &quot;+&quot; + y +
							// &quot; -crop &quot; + w + &quot;x&quot; + h + &quot;-&quot;+ x + &quot;-&quot; + y +&quot; '&quot;+
							// realPathSmall+&quot;'&quot;;

<span class="fc" id="L2925">							args = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L2926" title="1 of 2 branches missed.">							if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPath)))</span>
							{
<span class="nc" id="L2928">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2929">								args.add(IwcmFsDB.getTempFilePath(pomresize));</span>
<span class="nc" id="L2930">								args.add(&quot;-crop&quot;);</span>
<span class="nc" id="L2931">								args.add((int) width + &quot;x&quot; + (int) height + &quot;+&quot; + x + &quot;+&quot; + y);</span>
<span class="nc bnc" id="L2932" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2933" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2934">								args.add(IwcmFsDB.getTempFilePath(realPathSmall));</span>
							}
							else
							{
<span class="fc" id="L2938">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="fc" id="L2939">								args.add(pomresize);</span>
								// args[2] = realPath;
<span class="fc" id="L2941">								args.add(&quot;-crop&quot;);</span>
<span class="fc" id="L2942">								args.add((int) width + &quot;x&quot; + (int) height + &quot;+&quot; + x + &quot;+&quot; + y);</span>
								// args[5] = &quot;-crop&quot;;
								// args[6] = w + &quot;x&quot; + h + &quot;-&quot;+ x + &quot;-&quot; + y;
<span class="pc bpc" id="L2945" title="1 of 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="pc bpc" id="L2946" title="1 of 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="fc" id="L2947">								args.add(realPathSmall);</span>
							}
<span class="fc" id="L2949">							resizePomFile = new File(pomresize);</span>
<span class="fc" id="L2950">						}</span>
						else
						{
							// iba orezat
							// longCmd = imageMagickDir + File.separatorChar +
							// runtimeFile + &quot; '&quot; + realPath + &quot;' -crop &quot; +
							// originalImage.getWidth() + &quot;x&quot; +
							// originalImage.getHeight() + &quot;+&quot;+ x + &quot;+&quot; + y + &quot; -crop &quot;
							// + originalImage.getWidth() + &quot;x&quot; +
							// originalImage.getHeight() + &quot;-&quot;+ x + &quot;-&quot; + y +&quot; '&quot;+
							// realPathSmall+&quot;'&quot;;
<span class="fc" id="L2961">							args = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L2962" title="1 of 2 branches missed.">							if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPath)))</span>
							{
<span class="nc" id="L2964">								IwcmFsDB.writeFileToDisk(new File(realPath),new File(IwcmFsDB.getTempFilePath(realPath)));</span>
<span class="nc" id="L2965">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2966">								args.add(IwcmFsDB.getTempFilePath(realPath));</span>
<span class="nc" id="L2967">								args.add(&quot;-crop&quot;);</span>
<span class="nc" id="L2968">								args.add((int) width + &quot;x&quot; + (int) height + &quot;+&quot; + x + &quot;+&quot; + y);</span>
<span class="nc bnc" id="L2969" title="All 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L2970" title="All 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc" id="L2971">								args.add(IwcmFsDB.getTempFilePath(realPathSmall));</span>
							}
							else
							{
<span class="fc" id="L2975">								args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="fc" id="L2976">								args.add(realPath);</span>
<span class="fc" id="L2977">								args.add(&quot;-crop&quot;);</span>
<span class="fc" id="L2978">								args.add((int) width + &quot;x&quot; + (int) height + &quot;+&quot; + x + &quot;+&quot; + y);</span>
								// args[5] = &quot;-crop&quot;;
								// args[6] = originalImage.getWidth() + &quot;x&quot; +
								// originalImage.getHeight() + &quot;-&quot;+ x + &quot;-&quot; + y;
<span class="pc bpc" id="L2982" title="1 of 2 branches missed.">								if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="pc bpc" id="L2983" title="1 of 2 branches missed.">								if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="fc" id="L2984">								args.add(realPathSmall);</span>
							}
						}
					}
					else
					{
						// longCmd = imageMagickDir + File.separatorChar + runtimeFile
						// + &quot; '&quot; + realPath + &quot;' -resize &quot; + w + &quot;x&quot; + h + &quot;! '&quot; +
						// realPathSmall+&quot;'&quot;;
<span class="fc" id="L2993">						args = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L2994" title="1 of 2 branches missed.">						if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPath)))</span>
						{
<span class="nc" id="L2996">							IwcmFsDB.writeFileToDisk(new File(realPath),new File(IwcmFsDB.getTempFilePath(realPath)));</span>
<span class="nc" id="L2997">							args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc" id="L2998">							args.add(IwcmFsDB.getTempFilePath(realPath));</span>
<span class="nc" id="L2999">							args.add(&quot;-resize&quot;);</span>
<span class="nc" id="L3000">							args.add(w + &quot;x&quot; + h + &quot;!&quot;);</span>
<span class="nc bnc" id="L3001" title="All 2 branches missed.">							if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="nc bnc" id="L3002" title="All 2 branches missed.">							if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="nc bnc" id="L3003" title="All 2 branches missed.">							if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPathSmall))) args.add(IwcmFsDB.getTempFilePath(realPathSmall));</span>
<span class="nc" id="L3004">							else args.add(realPathSmall);</span>
						}
						else
						{
<span class="fc" id="L3008">							args.add(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="fc" id="L3009">							args.add(realPath);</span>
<span class="fc" id="L3010">							args.add(&quot;-resize&quot;);</span>
<span class="fc" id="L3011">							args.add(w + &quot;x&quot; + h + &quot;!&quot;);</span>
<span class="pc bpc" id="L3012" title="1 of 2 branches missed.">							if (galleryStripExif) args.add(&quot;-strip&quot;);</span>
<span class="pc bpc" id="L3013" title="1 of 2 branches missed.">							if (&quot;gif&quot;.equalsIgnoreCase(pripona)) args.add(&quot;+repage&quot;);</span>
<span class="fc" id="L3014">							args.add(realPathSmall);</span>
						}
					}
<span class="fc" id="L3017">					String params = &quot;&quot;;</span>
<span class="pc bpc" id="L3018" title="1 of 2 branches missed.">					if (args != null)</span>
					{
<span class="fc" id="L3020">						StringBuilder buf = new StringBuilder();</span>
<span class="fc bfc" id="L3021" title="All 2 branches covered.">						for (int i = 0; i &lt; args.size(); i++)</span>
						{
<span class="fc" id="L3023">							buf.append(' ').append(args.get(i));</span>
						}
<span class="fc" id="L3025">						params = buf.toString();</span>
					}
<span class="fc" id="L3027">					Logger.debug(GalleryDB.class, &quot;LONGCMD:\n&quot; + params);</span>
<span class="fc" id="L3028">					Process proc = rt.exec(args.toArray(new String[0]));</span>
<span class="fc" id="L3029">					Logger.debug(GalleryDB.class, &quot;executed&quot;);</span>
<span class="fc" id="L3030">					InputStream stderr = proc.getErrorStream();</span>
<span class="fc" id="L3031">					BufferedReader br = new BufferedReader(new InputStreamReader(stderr, Constants.FILE_ENCODING));</span>
<span class="fc" id="L3032">					String line = null;</span>
<span class="pc bpc" id="L3033" title="1 of 2 branches missed.">					while ((line = br.readLine()) != null)</span>
					{
<span class="nc" id="L3035">						Logger.debug(GalleryDB.class, line);</span>
					}
<span class="fc" id="L3037">					br.close();</span>
<span class="fc" id="L3038">					int exitValue = proc.waitFor();</span>
<span class="fc" id="L3039">					Logger.debug(GalleryDB.class, &quot;ExitValue: &quot; + exitValue);</span>

<span class="fc bfc" id="L3041" title="All 2 branches covered.">					if (resizePomFile != null)</span>
<span class="pc bpc" id="L3042" title="1 of 2 branches missed.">						if(resizePomFile.delete() == false) return 3;</span>

<span class="pc bpc" id="L3044" title="1 of 2 branches missed.">					if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(realPathSmall)))</span>
					{
<span class="nc" id="L3046">						IwcmFsDB.writeFileToDB(new File(IwcmFsDB.getTempFilePath(realPathSmall)), new File(realPathSmall));</span>
<span class="nc bnc" id="L3047" title="All 2 branches missed.">						if(new File(IwcmFsDB.getTempFilePath(realPathSmall)).delete() == false) return 3;</span>
<span class="nc bnc" id="L3048" title="All 2 branches missed.">						if(new File(IwcmFsDB.getTempFilePath(realPath)).delete() == false) return 3;</span>
					}

<span class="pc bpc" id="L3051" title="1 of 2 branches missed.">					if (exitValue == 0)</span>
					{
<span class="fc" id="L3053">						performWatermarking(realPathSmall);</span>
<span class="fc" id="L3054">						return (0);</span>
					}
					else
<span class="nc" id="L3057">						return (3);</span>
				}
				else
				{
<span class="nc" id="L3061">					IwcmInputStream iwStream =  new IwcmInputStream(fOrigImg.getPath(), false);</span>
<span class="nc" id="L3062">					BufferedImage originalBufferedImage = ImageIO.read(iwStream);</span>
<span class="nc" id="L3063">					iwStream.close();</span>
					// Logger.println(GalleryDB.class,&quot;w=&quot;+w+&quot; h=&quot;+h);
<span class="nc" id="L3065">					int scaleType = Image.SCALE_AREA_AVERAGING;</span>
<span class="nc bnc" id="L3066" title="All 2 branches missed.">					if (originalImage.getWidth() &gt; 1000)</span>
					{
<span class="nc" id="L3068">						Logger.debug(GalleryDB.class, &quot;smooth resize&quot;);</span>
<span class="nc" id="L3069">						scaleType = Image.SCALE_SMOOTH;</span>
					}
					// toto je pre ThumbServlet
<span class="nc bnc" id="L3072" title="All 2 branches missed.">					if (realPathSmall.indexOf(Constants.getString(&quot;thumbServletCacheDir&quot;)) != -1)</span>
<span class="nc" id="L3073">						scaleType = Image.SCALE_FAST;</span>
<span class="nc bnc" id="L3074" title="All 2 branches missed.">					if (originalImage.getWidth() &gt; 2000)</span>
					{
						// Logger.debug(GalleryDB.class,&quot;smooth fast&quot;);
						// scaleType = Image.SCALE_FAST;
					}
<span class="nc" id="L3079">					DebugTimer timer = new DebugTimer(&quot;ImageResize&quot;);</span>
<span class="nc" id="L3080">					timer.diff(&quot;starting: &quot; + scaleType);</span>
<span class="nc" id="L3081">					Image smallImage = null;</span>
<span class="nc bnc" id="L3082" title="All 2 branches missed.">					if (&quot;C&quot;.equals(resizeMode))</span>
					{// crop image
<span class="nc bnc" id="L3084" title="All 2 branches missed.">						if (resizeAndCrop)</span>
						{// zmensit a orezat
<span class="nc" id="L3086">							smallImage = originalBufferedImage.getScaledInstance(w, h, scaleType);</span>
<span class="nc" id="L3087">							BufferedImage bi = new BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);</span>
<span class="nc" id="L3088">							Graphics2D g = bi.createGraphics();</span>
<span class="nc" id="L3089">							g.drawImage(smallImage, 0, 0, null);</span>
<span class="nc" id="L3090">							smallImage = bi.getSubimage(x, y, pom_w, pom_h);</span>
<span class="nc" id="L3091">							w = pom_w;</span>
<span class="nc" id="L3092">							h = pom_h;</span>
<span class="nc" id="L3093">						}</span>
						else
						{// iba orezat
<span class="nc" id="L3096">							smallImage = originalBufferedImage.getSubimage(x, y, w, h);</span>
						}
					}
					else
					{
<span class="nc" id="L3101">						smallImage = originalBufferedImage.getScaledInstance(w, h, scaleType);</span>
					}
<span class="nc" id="L3103">					timer.diff(&quot;scaled&quot;);</span>
<span class="nc" id="L3104">					BufferedImage bufSmall = new BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);</span>
<span class="nc" id="L3105">					timer.diff(&quot;buf created&quot;);</span>
					// bufSmall.getGraphics().drawImage(smallImage, 0, 0, null);
<span class="nc" id="L3107">					bufSmall.createGraphics().drawImage(smallImage, 0, 0, null);</span>
<span class="nc" id="L3108">					timer.diff(&quot;image drawed&quot;);</span>
<span class="nc" id="L3109">					bufSmall.getGraphics().dispose();</span>
<span class="nc" id="L3110">					timer.diff(&quot;disposed&quot;);</span>
					try
					{
<span class="nc" id="L3113">						ImageWriteParam iwparam = null;</span>
						// ImageIO.write(bufSmall, format,iwparam, fSmallImg);
						// Jimi.putImage(&quot;image/&quot; + type, image, realPathSmall);
<span class="nc" id="L3116">						ImageWriter writer = null;</span>

<span class="nc" id="L3118">						String format = &quot;jpg&quot;;</span>
<span class="nc bnc" id="L3119" title="All 2 branches missed.">                        if (realPathLC.endsWith(&quot;.png&quot;))</span>
                        {
<span class="nc" id="L3121">                            format = &quot;png&quot;;</span>
                        }
                        else
                        {
<span class="nc" id="L3125">                            iwparam = new JPEGImageWriteParam(null);</span>
<span class="nc" id="L3126">                            iwparam.setCompressionMode(ImageWriteParam.MODE_EXPLICIT);</span>
<span class="nc" id="L3127">                            iwparam.setCompressionQuality(0.85F);</span>
                        }

<span class="nc" id="L3130">						Iterator&lt;ImageWriter&gt; iter = ImageIO.getImageWritersByFormatName(format);</span>
<span class="nc bnc" id="L3131" title="All 2 branches missed.">						if (iter.hasNext())</span>
						{
<span class="nc" id="L3133">							writer = iter.next();</span>
						}
<span class="nc bnc" id="L3135" title="All 2 branches missed.">						if (writer != null) {</span>
							// Prepare output file
<span class="nc" id="L3137">							IwcmOutputStream out = new IwcmOutputStream(fSmallImg.getPath());</span>
<span class="nc" id="L3138">							ImageOutputStream ios = ImageIO.createImageOutputStream(out);</span>
<span class="nc" id="L3139">							writer.setOutput(ios);</span>
<span class="nc" id="L3140">							timer.diff(&quot;write start&quot;);</span>
							// Write the image
<span class="nc" id="L3142">							writer.write(null, new IIOImage(bufSmall, null, null), iwparam);</span>
<span class="nc" id="L3143">							timer.diff(&quot;writed to file&quot;);</span>
							// Cleanup
<span class="nc" id="L3145">							ios.flush();</span>
<span class="nc" id="L3146">							writer.dispose();</span>
<span class="nc" id="L3147">							ios.close();</span>
<span class="nc" id="L3148">							out.close();</span>
						}
<span class="nc" id="L3150">						return (0);</span>
					}
<span class="nc" id="L3152">					catch (Exception ex)</span>
					{
<span class="nc" id="L3154">						sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3155">						return (2);</span>
					}
				}
			}
		}
<span class="nc" id="L3160">		catch (javax.imageio.IIOException ex)</span>
		{
<span class="nc" id="L3162">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3163">			return (4);</span>
		}
<span class="nc" id="L3165">		catch (Exception ex)</span>
		{
<span class="nc" id="L3167">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
<span class="pc bpc" id="L3171" title="1 of 2 branches missed.">			if (input!=null)</span>
			{
				try
				{
<span class="fc" id="L3175">				input.close();</span>
				}
<span class="nc" id="L3177">				catch (Exception e) {</span>
<span class="nc" id="L3178">					sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L3179">				}</span>
			}
		}
<span class="nc" id="L3182">		return (3);</span>
	}

	/**
	 * @param runtimeFile
	 * @return
	 */
	public static String getRuntimeFile()
	{
<span class="fc" id="L3191">		String result = &quot;convert&quot;;</span>
<span class="pc bpc" id="L3192" title="1 of 2 branches missed.">		if (System.getProperty(&quot;os.name&quot;).indexOf(&quot;Windows&quot;) != -1)</span>
		{
<span class="nc" id="L3194">			result  = &quot;convert.exe&quot;;</span>
		}
<span class="fc" id="L3196">		return result ;</span>
	}

	public static String getImageMagicDir()
	{
<span class="fc" id="L3201">		return Constants.getString(&quot;imageMagickDir&quot;);</span>
	}

	/**
	 * Vrati linku na obrazok so zadanym prefixom
	 *
	 * @param prefix
	 * @param fullPath
	 * @return
	 */
	public static String getImagePathPrefix(String prefix, String fullPath)
	{
<span class="nc" id="L3213">		return GalleryToolsForCore.getImagePathPrefix(prefix,fullPath);</span>
	}

	/**
	 * Vrati malu verziu obrazku z galerie (ak existuje)
	 *
	 * @param fullPath
	 * @return
	 */
	public static String getImagePathSmall(String fullPath)
	{
<span class="fc" id="L3224">		return GalleryToolsForCore.getImagePathSmall(fullPath);</span>
	}

	/**
	 * Vrati velku verziu obrazku z galerie (ak existuje)
	 *
	 * @param fullPath
	 * @return
	 */
	public static String getImagePathNormal(String fullPath)
	{
<span class="fc" id="L3235">		return GalleryToolsForCore.getImagePathNormal(fullPath);</span>
	}

	public static String getImagePathOriginal(String fullPath)
	{
<span class="fc" id="L3240">		return GalleryToolsForCore.getImagePathOriginal(fullPath);</span>
	}

	/**
	 * Normalizuje cestu k adresaru (v DB v tabulke gallery_dimension), odstrani
	 * koncove lomitko
	 *
	 * @param url
	 * @return
	 */
	private static String normalizeDir(String url)
	{
<span class="pc bpc" id="L3252" title="1 of 2 branches missed.">		if (url.endsWith(&quot;/&quot;))</span>
<span class="nc" id="L3253">			return (url.substring(0, url.length() - 1));</span>
<span class="fc" id="L3254">		return (url);</span>
	}

	/**
	 * Vytvori adresar galerie so zadanymi rozmermi (nastavi ich do databazy)
	 *
	 * @param url
	 * @param width
	 * @param height
	 * @param normalWidth
	 * @param normalHeight
	 * @return
	 */
	public static boolean createGalleryFolder(String url, int width, int height, int normalWidth, int normalHeight)
	{
<span class="nc" id="L3269">		IwcmFile f = new IwcmFile(Tools.getRealPath(url));</span>
<span class="nc" id="L3270">		f.mkdirs();</span>
<span class="nc" id="L3271">		Adminlog.add(Adminlog.TYPE_GALLERY, &quot;Create gallery folder: url= &quot; + url + &quot; w=&quot; + width + &quot; h=&quot; + height + &quot; nw=&quot; + normalWidth + &quot; nh=&quot; + normalHeight, -1, -1);</span>
<span class="nc" id="L3272">		Dimension dim = new Dimension(width, height);</span>
<span class="nc" id="L3273">		Dimension normalDim = new Dimension(normalWidth, normalHeight);</span>
<span class="nc" id="L3274">		changeDimension(Constants.getServletContext(), url, dim, normalDim, null, null, null);</span>
<span class="nc" id="L3275">		return (false);</span>
	}

	/**
	 * Otestuje, ci zadany adresar je galeria
	 *
	 * @param galleryFolderUrl
	 * @return
	 */
	public static boolean isGalleryFolder(String galleryFolderUrl)
	{
<span class="fc" id="L3286">		galleryFolderUrl = galleryFolderUrl.replace('\\', '/');</span>
<span class="fc bfc" id="L3287" title="All 2 branches covered.">		if (galleryFolderUrl.indexOf(&quot;/&quot; + Constants.getString(&quot;galleryDirName&quot;)) != -1)</span>
<span class="fc" id="L3288">			return (true);</span>
		// skus zistit, ci mame dany adresar v databaze
<span class="fc" id="L3290">		Dimension[] dim = getDimension(galleryFolderUrl, true, false);</span>
<span class="pc bpc" id="L3291" title="3 of 4 branches missed.">		if (dim[0] != null &amp;&amp; dim[1] != null)</span>
<span class="nc" id="L3292">			return (true);</span>
<span class="fc" id="L3293">		return (false);</span>
	}
	/**
	 * Increments send_count for image identified by imgPath
	 * @param imgPath
	 */
	public static void incSendCount(HttpServletRequest request, String imgPath)
	{


<span class="nc" id="L3303">		java.sql.Connection db_conn = null;</span>
<span class="nc" id="L3304">		java.sql.PreparedStatement ps = null;</span>

<span class="nc" id="L3306">		ResultSet rs  = null;</span>
<span class="nc" id="L3307">		int imageId = -1;</span>
		try
		{

<span class="nc" id="L3311">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L3312">			ps = db_conn.prepareStatement(&quot;select image_id from gallery where image_path = ? and image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L3313">			ps.setString(1,imgPath.substring(0,imgPath.lastIndexOf('/')));</span>
<span class="nc" id="L3314">			ps.setString(2, imgPath.substring(imgPath.lastIndexOf('/')+1));</span>
<span class="nc" id="L3315">			rs=ps.executeQuery();</span>

<span class="nc bnc" id="L3317" title="All 2 branches missed.">			if (rs.next())</span>
			{
<span class="nc" id="L3319">				imageId=rs.getInt(&quot;image_id&quot;);</span>
			}
<span class="nc" id="L3321">			rs.close();</span>
<span class="nc" id="L3322">			rs = null;</span>
<span class="nc" id="L3323">			ps.close();</span>
<span class="nc bnc" id="L3324" title="All 2 branches missed.">			if (imageId&gt;0) //ak existuje robime update</span>
			{
<span class="nc" id="L3326">				ps = db_conn.prepareStatement(&quot;update gallery set send_count = send_count + 1 where image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L3327">				ps.setInt(1, imageId);</span>
<span class="nc" id="L3328">				ps.executeUpdate();</span>
			}
			else //inak insert noveho zaznamu
			{
<span class="nc" id="L3332">				ps = db_conn.prepareStatement(&quot;insert into gallery  (image_path,image_name,send_count, domain_id) values (?,?,1,?)&quot;);</span>

<span class="nc" id="L3334">				ps.setString(1, imgPath.substring(0,imgPath.lastIndexOf('/')));</span>
<span class="nc" id="L3335">				ps.setString(2, imgPath.substring(imgPath.lastIndexOf('/')+1));</span>
<span class="nc" id="L3336">				ps.setInt(3, CloudToolsForCore.getDomainId());</span>
<span class="nc" id="L3337">				ps.executeUpdate();</span>

				//update pkey generator
<span class="nc" id="L3340">				PkeyGenerator.getNextValue(&quot;gallery&quot;);</span>
			}

<span class="nc" id="L3343">			ps.close();</span>
<span class="nc" id="L3344">			db_conn.close();</span>
<span class="nc" id="L3345">			ps = null;</span>
<span class="nc" id="L3346">			db_conn = null;</span>
		}
<span class="nc" id="L3348">		catch (Exception ex)</span>
		{
<span class="nc" id="L3350">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L3356" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L3357">					rs.close();</span>
<span class="nc bnc" id="L3358" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L3359">					ps.close();</span>
<span class="nc bnc" id="L3360" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L3361">					db_conn.close();</span>
			}
<span class="nc" id="L3363">			catch (Exception ex2)</span>
			{
<span class="nc" id="L3365">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L3366">			}</span>
		}
<span class="nc" id="L3368">	}</span>

	/**
	 * Test, ci je mozne pohladnicu poslat na zadany email
	 * @param email - email adresa prijemcu
	 * @param gBean - gallery bean
	 * @return
	 */
	public static boolean canSendToEmail(String email, GalleryBean gBean)
	{
<span class="nc bnc" id="L3378" title="All 2 branches missed.">		if (Tools.isEmail(email)==false) return false;</span>
<span class="nc bnc" id="L3379" title="All 2 branches missed.">		if (gBean == null) return false;</span>
<span class="nc bnc" id="L3380" title="All 2 branches missed.">		if (Tools.isEmpty(gBean.getAllowedDomains())) return true;</span>

<span class="nc" id="L3382">		email = email.toLowerCase();</span>
<span class="nc" id="L3383">		StringTokenizer st = new StringTokenizer(gBean.getAllowedDomains(), &quot;,+\n&quot;);</span>
<span class="nc bnc" id="L3384" title="All 2 branches missed.">		while (st.hasMoreTokens())</span>
		{
<span class="nc" id="L3386">			String domain = st.nextToken().toLowerCase();</span>
<span class="nc bnc" id="L3387" title="All 2 branches missed.">			if (email.endsWith(domain)) return true;</span>
<span class="nc" id="L3388">		}</span>

<span class="nc" id="L3390">		return false;</span>
	}

	/**
	 * Vrati atribut perex_group obrazka s identifikatorom imageId v String tvare, cize nieco ako ,45,12,13, kde cisla su identifikatory perex skupin
	 * @author kmarton
	 *
	 * @param imageId	identifikator obrazka, pre ktory chceme zistit jeho perex skupiny. Musi byt vacsi ako 0.
	 * @return
	 */
	public static String getImagePerexGroupString(int imageId)
	{
<span class="nc" id="L3402">		return (new SimpleQuery().forString(&quot;SELECT perex_group FROM gallery WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), imageId));</span>
	}

	/**
	 * Nastavi atribut perex_group podla perexGroupString obrazku s identifikatorom imageId
	 * @author kmarton
	 *
	 * @param perexGroupString		retazec v tvare ,perexGroupId,perexGroupId,perexGroupId... nieco ako ,15,16,7,
	 * @param imageId					identifikator obrazku, ktoremu chceme nastavit pozadovany perexGroupString
	 */
	public static void setImagePerexGroupString(String perexGroupString, int imageId)
	{
<span class="nc bnc" id="L3414" title="All 2 branches missed.">		if (imageId &lt; 1)</span>
<span class="nc" id="L3415">			return;</span>
		try
		{
<span class="nc" id="L3418">			new SimpleQuery().execute(&quot;UPDATE gallery SET perex_group = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), perexGroupString, imageId);</span>
		}
<span class="nc" id="L3420">		catch (Exception e)</span>
		{
<span class="nc" id="L3422">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L3423">		}</span>
<span class="nc" id="L3424">	}</span>

	/**
	 * Prida existujucemu obrazku s identifikatorom taggedImageInt identifikator perex skupiny tagPerexGroupId.
	 * Obsahuje kontrolu, ci uz obrazok perexGroupu nahodou neobsahuje. Ak ano, tak ju nepridava.
	 *
	 * @author kmarton
	 *
	 * @param 	taggedImageInt	Identifikator obrazka, ktoremu sa doplni perex skupina
	 * @param 	tagPerexGroupId	Identifikator perex skupiny, ktora sa doplni k uz existujucim perex skupina obrazka
	 *
	 * @return	Vrati true ak sa operacia podarila, inak vrati false
	 */
	public static boolean addPerexGroup(int taggedImageInt, int tagPerexGroupId)
	{
		try
		{
<span class="nc" id="L3441">   		String existPerexGroupString = GalleryDB.getImagePerexGroupString(taggedImageInt);</span>
<span class="nc bnc" id="L3442" title="All 2 branches missed.">   		if (Tools.isEmpty(existPerexGroupString))</span>
<span class="nc" id="L3443">   			existPerexGroupString = &quot;,&quot;;</span>
<span class="nc bnc" id="L3444" title="All 2 branches missed.">   		if (existPerexGroupString.indexOf(&quot;,&quot; + tagPerexGroupId + &quot;,&quot;) == -1)	 //kontrola, ci uz danu perexGroupu nahodou neobsahuje. Ak ano, tak nepridavam</span>
<span class="nc" id="L3445">   			GalleryDB.setImagePerexGroupString((existPerexGroupString + tagPerexGroupId + &quot;,&quot;), taggedImageInt);</span>
<span class="nc" id="L3446">   		return true;</span>
		}
<span class="nc" id="L3448">		catch (Exception ex)</span>
		{
<span class="nc" id="L3450">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3451">			return false;</span>
		}
	}

	/**
	 * Odoberie existujucemu obrazku s identifikatorom taggedImageInt identifikator perex skupiny tagPerexGroupId.
	 * Ak obrazok danu perex skupinu neobsahuje, nevykona sa nic a vrati sa true.
	 *
	 * @author kmarton
	 *
	 * @param 	taggedImageInt	Identifikator obrazka, ktoremu sa odoberie perex skupina
	 * @param 	tagPerexGroupId	Identifikator perex skupiny, ktora sa odoberie z uz existujucich perex skupina obrazka
	 *
	 * @return	Vrati true ak sa operacia podarila, inak vrati false
	 */
	public static boolean removePerexGroup(int taggedImageInt, int tagPerexGroupId)
	{
		try
		{
<span class="nc" id="L3470">   		String existPerexGroupString = GalleryDB.getImagePerexGroupString(taggedImageInt);</span>
<span class="nc bnc" id="L3471" title="All 2 branches missed.">   		if (Tools.isEmpty(existPerexGroupString))</span>
<span class="nc" id="L3472">   			return true;</span>

<span class="nc bnc" id="L3474" title="All 2 branches missed.">   		if (existPerexGroupString.indexOf(&quot;,&quot; + tagPerexGroupId + &quot;,&quot;) != -1)	 //odstrani skupinu, len ak ju obsahuje</span>
<span class="nc" id="L3475">   			GalleryDB.setImagePerexGroupString((existPerexGroupString.replace(tagPerexGroupId + &quot;,&quot;, &quot;&quot;)), taggedImageInt);</span>
<span class="nc bnc" id="L3476" title="All 2 branches missed.">   		if (GalleryDB.getImagePerexGroupString(taggedImageInt).length() &lt; 3)// ak bola nastavena iba jedna skupina, zmaz vsetky zvysne ciarky</span>
<span class="nc" id="L3477">   			GalleryDB.setImagePerexGroupString(&quot;&quot;, taggedImageInt);</span>
<span class="nc" id="L3478">   		return true;</span>
		}
<span class="nc" id="L3480">		catch (Exception ex)</span>
		{
<span class="nc" id="L3482">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3483">			return false;</span>
		}
	}

	/**
	 * Funkcia vrati nazov perex skupiny podla jeho identifikatora
	 *
	 * @param perexGroupId	identifikator skupiny, ktorej nazov chceme zistit
	 * @return
	 */
	public static String getPerexGroupName(int perexGroupId)
	{
<span class="nc" id="L3495">		return new SimpleQuery().forString(&quot;SELECT perex_group_name FROM perex_groups WHERE perex_group_id = ?&quot;, perexGroupId);</span>
	}

	/**
	 * Funkcia, ktora z retazca identifikatorov perex skupin (v tvare napr. ,12,15,78,2,) vrati retazec ich zodpovedajucich nazvov (interway, auto, kvety)
	 *
	 * @param perexGroupString retazec pozostavajuci z identifikatorov jednotlivych perex skupin oddelenych ciarkami - napr. ,12,15,78,2,
	 * @return
	 */
	public static String getPerexGroupNameString(String perexGroupString)
	{
<span class="nc" id="L3506">		StringBuilder retValue = new StringBuilder();</span>
<span class="nc" id="L3507">		String[] perexGroups = convertPerexGroupString(perexGroupString);</span>
<span class="nc bnc" id="L3508" title="All 4 branches missed.">		if (perexGroups != null &amp;&amp; perexGroups.length &gt; 0)</span>
<span class="nc bnc" id="L3509" title="All 2 branches missed.">      	for (String perexGroup : perexGroups)</span>
<span class="nc" id="L3510">      		retValue.append(GalleryDB.getPerexGroupName(Tools.getIntValue(perexGroup, -1))).append(&quot;, &quot;);</span>

<span class="nc" id="L3512">		return retValue.substring(0, (retValue.length()-2));		//odreze poslednu medzeru a ciarku na konci</span>
	}

	public static String convertPerexGroupString(String[] perexGroup)
	{
<span class="nc" id="L3517">		StringBuilder ret = new StringBuilder();</span>
		try
		{
<span class="nc bnc" id="L3520" title="All 2 branches missed.">			if (perexGroup!=null)</span>
			{
<span class="nc" id="L3522">				int size = perexGroup.length;</span>
				int i;
<span class="nc bnc" id="L3524" title="All 2 branches missed.">				for (i=0; i&lt;size; i++)</span>
				{
<span class="nc" id="L3526">					ret.append(&quot;,&quot;).append(perexGroup[i]);</span>
				}
<span class="nc" id="L3528">				ret.append(&quot;,&quot;);</span>
			}
		}
<span class="nc" id="L3531">		catch (Exception ex)</span>
		{
<span class="nc" id="L3533">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L3534">		}</span>

		//Logger.println(GalleryBean.class, &quot;getPerexGroupString = &quot; + ret);

<span class="nc" id="L3538">		return(ret.toString());</span>
	}

	public static String[] convertPerexGroupString(String perexGroupString)
	{
<span class="fc" id="L3543">		String[] perexGroup = null;</span>

<span class="fc bfc" id="L3545" title="All 2 branches covered.">		if (perexGroupString == null)</span>
<span class="fc" id="L3546">			perexGroupString = &quot;&quot;;</span>

<span class="fc" id="L3548">		StringTokenizer st = new StringTokenizer(perexGroupString, &quot;,+_&quot;);</span>

		try
		{
<span class="fc" id="L3552">			perexGroup = new String[st.countTokens()];</span>
<span class="fc" id="L3553">			int i=0;</span>
<span class="pc bpc" id="L3554" title="1 of 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L3556">				int pGroupId = Tools.getIntValue(st.nextToken().trim(), -1);</span>
<span class="nc" id="L3557">				perexGroup[i++] = Integer.toString(pGroupId);</span>
<span class="nc" id="L3558">			}</span>
		}
<span class="nc" id="L3560">		catch (Exception ex)</span>
		{
<span class="nc" id="L3562">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L3563">		}</span>

<span class="fc" id="L3565">		return perexGroup;</span>
	}

	public static void updateSelectedInfo(int imageId, int selectedX, int selectedY, int selectedWidht, int selectedHeight)
	{
<span class="nc" id="L3570">		Connection db_conn = null;</span>
<span class="nc" id="L3571">		PreparedStatement ps = null;</span>
		try
		{
<span class="nc" id="L3574">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L3575">			ps = db_conn.prepareStatement(&quot;UPDATE gallery SET selected_x=?, selected_y=?, selected_width=?, selected_height=? WHERE image_id=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L3576">			int index = 1;</span>
<span class="nc" id="L3577">			ps.setInt( index++,selectedX);</span>
<span class="nc" id="L3578">			ps.setInt( index++,selectedY);</span>
<span class="nc" id="L3579">			ps.setInt( index++,selectedWidht);</span>
<span class="nc" id="L3580">			ps.setInt(index++,selectedHeight);</span>
<span class="nc" id="L3581">			ps.setInt(index++,imageId);</span>
<span class="nc" id="L3582">			ps.execute();</span>
<span class="nc" id="L3583">			ps.close();</span>
<span class="nc" id="L3584">			db_conn.close();</span>
<span class="nc" id="L3585">			ps = null;</span>
<span class="nc" id="L3586">			db_conn = null;</span>
		}
<span class="nc" id="L3588">		catch (Exception ex)</span>
		{
<span class="nc" id="L3590">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L3596" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L3597">					ps.close();</span>
<span class="nc bnc" id="L3598" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L3599">					db_conn.close();</span>
			}
<span class="nc" id="L3601">			catch (Exception ex2)</span>
			{
<span class="nc" id="L3603">			}</span>
		}
<span class="nc" id="L3605">	}</span>

	/**
	 * Sprav crop z obrazka &quot;from&quot; podla zadanych parametrov a zapise ho do  &quot;to&quot;
	 * POZOR: Ignoruje DB storage
	 * @param from
	 * @param width
	 * @param height
	 * @param left
	 * @param top
	 * @param to
	 * @return
	 */
	public static int crop(IwcmFile from, int width,int height,int left,int top,IwcmFile to)
	{
<span class="nc bnc" id="L3620" title="All 2 branches missed.">		if (!to.getParentFile().exists())</span>
		{
<span class="nc" id="L3622">			to.getParentFile().mkdirs();</span>
		}

<span class="nc" id="L3625">		String[] args = new String[5];</span>
<span class="nc" id="L3626">		args[1]=from.getAbsolutePath();</span>
<span class="nc" id="L3627">		args[2]=&quot;-crop&quot;;</span>
<span class="nc" id="L3628">		args[3]=width+&quot;x&quot;+height+&quot;+&quot;+left+&quot;+&quot;+top;</span>
<span class="nc" id="L3629">		args[4]=to.getAbsolutePath();</span>
<span class="nc" id="L3630">		return executeImageMagickCommand(args);</span>
	}


	/**
	 * Spusti imageMagic s parametrami v args, args[0] sa nastavi automaticky podla cesty k ImageMagic
	 * @param args
	 */
	public static int executeImageMagickCommand(String[] args)
	{
<span class="fc" id="L3640">		args[0] = getImageMagicDir()+File.separatorChar+getRuntimeFile();</span>
<span class="fc" id="L3641">		Runtime rt = Runtime.getRuntime();</span>
<span class="fc" id="L3642">		Process process = null;</span>
		try
		{
			//odstraneny if nie je potrebny
<span class="fc" id="L3646">			StringBuilder params = new StringBuilder();</span>
//			if (args != null)
//			{
<span class="fc bfc" id="L3649" title="All 2 branches covered.">				for (int i = 0; i &lt; args.length; i++)</span>
				{
<span class="fc" id="L3651">					params.append(' ').append(args[i]);</span>
				}
//			}
<span class="fc" id="L3654">			Logger.debug(GalleryDB.class, &quot;LONGCMD:\n&quot; + params);</span>

<span class="fc" id="L3656">			process= rt.exec(args);</span>

<span class="fc" id="L3658">			InputStream stderr = process.getErrorStream();</span>
<span class="fc" id="L3659">			BufferedReader br = new BufferedReader(new InputStreamReader(stderr, Constants.FILE_ENCODING));</span>
<span class="fc" id="L3660">			String line = null;</span>
<span class="pc bpc" id="L3661" title="1 of 2 branches missed.">			while ((line = br.readLine()) != null)</span>
			{
<span class="nc" id="L3663">				Logger.debug(GalleryDB.class, line);</span>
			}
<span class="fc" id="L3665">			br.close();</span>

<span class="fc" id="L3667">			int ret = process.waitFor();</span>
			//convert vrati 1 namiesto 0 lebo pri -debug hlasi, ze destination subor neexistuje/nepozna .new priponu
<span class="pc bpc" id="L3669" title="1 of 2 branches missed.">			if (ret==1) ret = 0;</span>

<span class="fc" id="L3671">			return ret;</span>
		}
<span class="nc" id="L3673">		catch (Exception e)</span>
		{
<span class="nc" id="L3675">			sk.iway.iwcm.Logger.error(e);</span>
		}
<span class="nc" id="L3677">		return -1;</span>
	}

	/**
	 * Matoda, ktora zmeni urcitu vlastnost obrazka, ak obrazok neexistuje, vytvori novy s pozadovanymi hodnotami
	 *
	 * @author kmarton
	 *
	 * @param imageId	identifikator obrazka, ktoreho vlastnosti chceme zmenit
	 * @param item		vlastnost obrazka, ktoru chceme zmenit prepisanim starej hodnoty na novu value
	 * @param value	hodnota, ktoru chceme zapisat do vlastnosti item obrazka
	 */
	public static boolean updateImageItem(int imageId, String item, String value, String imagePath, String imageName, String lng)
	{
		//System.out.println(&quot;IMAGEID NA ZMENU::: &quot; + imageId +&quot; - &quot; + imagePath + &quot; - &quot; + imageName);
		//System.out.println(&quot;DEBUG: JAZYK NA ZMENU::: &quot; + imageId +&quot; - &quot; + lng);

<span class="nc bnc" id="L3694" title="All 4 branches missed.">		if(item == null || value == null)</span>
<span class="nc" id="L3695">			return false;</span>

<span class="nc bnc" id="L3697" title="All 2 branches missed.">		if (imageId &lt; 0)</span>
<span class="nc" id="L3698">			imageId = GalleryDB.setImage(imagePath, imageName);</span>

<span class="nc bnc" id="L3700" title="All 2 branches missed.">		if (imageId &lt; 0)</span>
<span class="nc" id="L3701">			return false;</span>

		try
		{
<span class="nc bnc" id="L3705" title="All 2 branches missed.">			if (&quot;short&quot;.equals(item))</span>
<span class="nc" id="L3706">				new SimpleQuery().execute(&quot;UPDATE gallery SET s_description_&quot; + lng + &quot; = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), DB.prepareString(EditorDB.escapeInvalidCharacters(value), 255), imageId);</span>
<span class="nc bnc" id="L3707" title="All 2 branches missed.">			else if (&quot;long&quot;.equals(item))</span>
<span class="nc" id="L3708">				new SimpleQuery().execute(&quot;UPDATE gallery SET l_description_&quot; + lng + &quot; = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), EditorDB.escapeInvalidCharacters(value), imageId);</span>
<span class="nc bnc" id="L3709" title="All 2 branches missed.">			else if (&quot;author&quot;.equals(item))</span>
<span class="nc" id="L3710">				new SimpleQuery().execute(&quot;UPDATE gallery SET author = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), DB.prepareString(value, 255), imageId);</span>
<span class="nc bnc" id="L3711" title="All 2 branches missed.">			else if (&quot;priority&quot;.equals(item))</span>
<span class="nc" id="L3712">				new SimpleQuery().execute(&quot;UPDATE gallery SET sort_priority = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), Integer.parseInt(value), imageId);</span>
<span class="nc bnc" id="L3713" title="All 2 branches missed.">			else if (&quot;upload&quot;.equals(item))</span>
<span class="nc" id="L3714">				new SimpleQuery().execute(&quot;UPDATE gallery SET upload_datetime = ? WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), new Timestamp(Long.parseLong(value)), imageId);</span>

<span class="nc" id="L3716">			return true;</span>
		}
<span class="nc" id="L3718">		catch (Exception e)</span>
		{
<span class="nc" id="L3720">			sk.iway.iwcm.Logger.error(e);</span>
		}

<span class="nc" id="L3723">		return false;</span>
	}

	/**
	 * Matoda, ktora zmeni urcitu vlastnost galerie
	 *
	 * @author kmarton
	 *
	 * @param path	identifikator galerie - cesta k jej priecinku, ktorej vlastnosti chceme zmenit
	 * @param item		vlastnost galerie, ktoru chceme zmenit prepisanim starej hodnoty na novu value
	 * @param value	hodnota, ktoru chceme zapisat do vlastnosti item galerie
	 */
	public static boolean updateGalleryItem(String path, String item, String value)
	{
		//System.out.println(&quot;IMAGEID NA ZMENU::: &quot; + imageId +&quot; - &quot; + imagePath + &quot; - &quot; + imageName);
		//System.out.println(&quot;DEBUG: JAZYK NA ZMENU::: &quot; + imageId +&quot; - &quot; + lng);

<span class="nc bnc" id="L3740" title="All 4 branches missed.">		if(item == null || value == null)</span>
<span class="nc" id="L3741">			return false;</span>

<span class="nc bnc" id="L3743" title="All 2 branches missed.">		if (Tools.isEmpty(path))</span>
<span class="nc" id="L3744">			return false;</span>

<span class="nc" id="L3746">		int galleryId = GalleryDB.setGallery(path);</span>

<span class="nc bnc" id="L3748" title="All 2 branches missed.">		if (galleryId &gt; 0)</span>
		{
   		try
   		{
<span class="nc bnc" id="L3752" title="All 2 branches missed.">   			if (&quot;short&quot;.equals(item))</span>
<span class="nc" id="L3753">   				new SimpleQuery().execute(&quot;UPDATE gallery_dimension SET gallery_name = ? WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), DB.prepareString(value, 255), galleryId);</span>
<span class="nc bnc" id="L3754" title="All 2 branches missed.">   			else if (&quot;long&quot;.equals(item))</span>
<span class="nc" id="L3755">   				new SimpleQuery().execute(&quot;UPDATE gallery_dimension SET gallery_perex = ? WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), value, galleryId);</span>
<span class="nc bnc" id="L3756" title="All 2 branches missed.">   			else if (&quot;author&quot;.equals(item))</span>
<span class="nc" id="L3757">   				new SimpleQuery().execute(&quot;UPDATE gallery_dimension SET author = ? WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), DB.prepareString(value, 255), galleryId);</span>

   		}
<span class="nc" id="L3760">   		catch (Exception e)</span>
   		{
<span class="nc" id="L3762">   			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L3763">   			return false;</span>
<span class="nc" id="L3764">   		}</span>

<span class="nc" id="L3766">   		return true;</span>
		}
<span class="nc" id="L3768">		return false;</span>
	}

	/**
	 * Vrati hodnotu obrazka v galerii, ktora uz existuju v tabulke na zaklade jazyka
	 *
	 * @param imageId identifikator obrazka
	 * @param item		polozka, vlastnost, ktoru chceme zistit
	 * @param lng		jazyk
	 *
	 *	@author kmarton
	 * @return
	 */
	public static String getDescriptionLng(int imageId, String item, String lng)
	{
<span class="nc" id="L3783">		String retValue = &quot;&quot;;</span>
		try
		{
<span class="nc bnc" id="L3786" title="All 2 branches missed.">   		if (&quot;short&quot;.equals(item))</span>
<span class="nc" id="L3787">   			retValue = new SimpleQuery().forString(&quot;SELECT s_description_&quot; + lng + &quot; FROM gallery WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), imageId);</span>
<span class="nc bnc" id="L3788" title="All 2 branches missed.">   		if (&quot;long&quot;.equals(item))</span>
<span class="nc" id="L3789">   			retValue = new SimpleQuery().forString(&quot;SELECT l_description_&quot; + lng + &quot; FROM gallery WHERE image_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), imageId);</span>
   	}
<span class="nc" id="L3791">   	catch (Exception e)</span>
   	{
<span class="nc" id="L3793">   	}</span>
<span class="nc bnc" id="L3794" title="All 2 branches missed.">   	if (retValue == null)</span>
<span class="nc" id="L3795">   		retValue = &quot;&quot;;</span>

<span class="nc" id="L3797">   	return retValue;</span>
	}


	/**
	 * malo by sa pouzivat getGalleryInfo(String galleryPath, int dimensionId)
	 *
	 *@deprecated
	 */
	@Deprecated
	public static GalleryDimension getGalleryInfo(String galleryPath)
	{
<span class="nc" id="L3809">		return getGalleryInfo(galleryPath, -1);</span>
	}

	/**
	 * upravil bhric, aby sa dali ziskat info aj pomocou ID galerie
	 *
	 * Metoda vrati informacie o galerie presnejsie jej nazov, id, perex, datum vytvorenia, pocet videni a autorovi
	 *
	 * @author kmarton
	 *
	 * @param galleryPath	cesta k priecinku fotogalerie, podla ktorej sa identifikuje
	 * @param dimensionId	ID galerie, zhodne s dimension_id - pokial je mensie ako 1, tak vyhlada podla galleryPath
	 * @return vrati bean GalleryDimension naplneny informaciami
	 */
	public static GalleryDimension getGalleryInfo(String galleryPath, int dimensionId)
	{
<span class="fc" id="L3825">		GalleryDimension emptyDimensionIfNothingIsFound = new GalleryDimension();</span>
<span class="fc" id="L3826">		emptyDimensionIfNothingIsFound.setGalleryPath(galleryPath);</span>
<span class="fc" id="L3827">		String sql = &quot;&quot;;</span>
<span class="pc bpc" id="L3828" title="1 of 2 branches missed.">		if(dimensionId &gt; 0)</span>
<span class="nc" id="L3829">			sql = &quot;SELECT * FROM gallery_dimension WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="pc bpc" id="L3830" title="1 of 2 branches missed.">		else if(Tools.isNotEmpty(galleryPath))</span>
<span class="fc" id="L3831">			sql = &quot;SELECT * FROM gallery_dimension WHERE image_path = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
		else
<span class="nc" id="L3833">			return null;</span>

<span class="fc" id="L3835">		ComplexQuery query = new ComplexQuery().setSql(sql);</span>
<span class="pc bpc" id="L3836" title="1 of 2 branches missed.">		if (dimensionId &gt; 0)</span>
<span class="nc" id="L3837">			query.setParams(dimensionId);</span>
		else
<span class="fc" id="L3839">			query.setParams(galleryPath);</span>

<span class="fc" id="L3841">		List&lt;GalleryDimension&gt; dimensions = query.list(dimensionMapper);</span>
<span class="fc bfc" id="L3842" title="All 2 branches covered.">		return dimensions.size() &gt; 0 ? dimensions.get(0) : emptyDimensionIfNothingIsFound;</span>
	}

	/**
	 * Metoda vrati informacie o count poslednych galeriach
	 *
	 * @author kmarton
	 *
	 * @param count pocet fotogalerii, ktore sa ma vratit
	 * @return vrati List GalleryDimension naplneny informaciami
	 */
	public static List&lt;GalleryDimension&gt; getLastGalleriesInfo(int count)
	{
<span class="nc" id="L3855">		String sql = null;</span>

<span class="nc bnc" id="L3857" title="All 5 branches missed.">		switch (Constants.DB_TYPE)</span>
		{
<span class="nc" id="L3859">			case Constants.DB_MYSQL : sql = &quot;SELECT * FROM gallery_dimension WHERE create_date IS NOT NULL&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY create_date DESC LIMIT &quot;+count;</span>
<span class="nc" id="L3860">				break;</span>
<span class="nc" id="L3861">			case Constants.DB_PGSQL : sql = &quot;SELECT * FROM gallery_dimension WHERE create_date IS NOT NULL&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY create_date DESC LIMIT &quot;+count;</span>
<span class="nc" id="L3862">				break;</span>
<span class="nc" id="L3863">			case Constants.DB_MSSQL : sql = &quot;SELECT TOP &quot;+count+&quot; * FROM gallery_dimension WHERE create_date IS NOT NULL&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY create_date DESC&quot;;</span>
<span class="nc" id="L3864">				break;</span>
<span class="nc" id="L3865">			case Constants.DB_ORACLE : sql = &quot;SELECT GD.*, ROWNUM FROM gallery_dimension GD WHERE create_date IS NOT NULL&quot;+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; AND ROWNUM &lt; &quot;+count+&quot; ORDER BY create_date DESC&quot;;</span>
<span class="nc" id="L3866">				break;</span>
<span class="nc" id="L3867">			default: throw new IllegalStateException(&quot;Unknown database type&quot;);</span>
		}

<span class="nc" id="L3870">		return new ComplexQuery().setSql(sql).list(dimensionMapper);</span>
	}

	/**
	 * Funkcia vrati GalleryDimensionBeany, ktore obsahuju aspon jednu fotku otagovanu danou perex skupinou a tie budu usporiadane podla datumu vytvorenia
	 *
	 * @param perexGroupId	identifikator skupiny, ktorej aspon jedna fotka sa ma v galerii vyskytovat
	 * @param count			pocet galerii, ktore sa maju vratit
	 *
	 * @return
	 */
	public static List&lt;GalleryDimension&gt; getGalleriesPathByPerexGroup(int perexGroupId, int count)
	{
<span class="nc" id="L3883">		List&lt;GalleryDimension&gt; retList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L3884">		String perexGroupSql = &quot;%,&quot; + perexGroupId + &quot;,%&quot;;</span>

		try
		{
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L3889">			List&lt;String&gt; galleriesPaths = new SimpleQuery().forList(&quot;SELECT DISTINCT image_path FROM gallery WHERE gallery.perex_group LIKE ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), perexGroupSql);</span>
<span class="nc bnc" id="L3890" title="All 2 branches missed.">			for (String galleryPath : galleriesPaths)</span>
			{
<span class="nc" id="L3892">				GalleryDimension gd = getGalleryInfo(galleryPath, -1);</span>
<span class="nc" id="L3893">				retList.add(gd);</span>
<span class="nc" id="L3894">			}</span>

		}
<span class="nc" id="L3897">		catch (Exception e)</span>
		{
<span class="nc" id="L3899">		}</span>

		try
		{
<span class="nc" id="L3903">			Collections.sort(retList, new Comparator&lt;GalleryDimension&gt;()</span>
<span class="nc" id="L3904">			{</span>
				@Override
				public int compare(GalleryDimension gd1, GalleryDimension gd2)
				{
<span class="nc" id="L3908">					return (gd2.getGalleryDate().compareTo(gd1.getGalleryDate()));</span>
				}
			});
		}
<span class="nc" id="L3912">		catch (Exception ex)</span>
		{
			//sk.iway.iwcm.Logger.error(ex);
<span class="nc" id="L3915">		}</span>

<span class="nc bnc" id="L3917" title="All 2 branches missed.">		if (retList.isEmpty())</span>
<span class="nc" id="L3918">			return retList;</span>

<span class="nc bnc" id="L3920" title="All 2 branches missed.">		if (count &gt; retList.size())</span>
<span class="nc" id="L3921">			return retList;</span>

<span class="nc" id="L3923">		return retList.subList(0, count);</span>
	}

	/**
	 * Funkcia vrati GalleryBean prveho obrazka, ktory patri do zadanej fotogalerie podla jej identifikatora
	 *
	 * @param galleryPath	cesta galerie, z ktorej sa ma vybrat prvy obrazok na zaklade abecedneho poradia
	 *
	 * @return
	 */
	public static GalleryBean getFirstImageFromGalleryByPerexGroupFromDB(String galleryPath)
	{
<span class="nc" id="L3935">		GalleryBean firstImage = new GalleryBean();</span>

<span class="nc" id="L3937">		Connection db_conn = null;</span>
<span class="nc" id="L3938">		PreparedStatement ps = null;</span>
<span class="nc" id="L3939">		ResultSet rs = null;</span>

<span class="nc" id="L3941">		String limitSQLAfter = &quot;&quot;;</span>
<span class="nc" id="L3942">		String limitSqlBefore = &quot;&quot;;</span>
<span class="nc" id="L3943">		String whereCondition = &quot;&quot;;</span>

<span class="nc bnc" id="L3945" title="All 4 branches missed.">		if(Constants.DB_TYPE == Constants.DB_MYSQL || Constants.DB_TYPE==Constants.DB_PGSQL)</span>
<span class="nc" id="L3946">			limitSQLAfter = &quot; LIMIT 1&quot;;</span>

<span class="nc bnc" id="L3948" title="All 2 branches missed.">		else if(Constants.DB_TYPE == Constants.DB_MSSQL)</span>
<span class="nc" id="L3949">			limitSqlBefore = &quot; TOP &quot; + 1;</span>

<span class="nc bnc" id="L3951" title="All 2 branches missed.">		else if(Constants.DB_TYPE == Constants.DB_ORACLE)</span>
<span class="nc" id="L3952">			whereCondition = &quot; AND LINENUM BETWEEN 0 AND 1&quot;;</span>

		try
		{
<span class="nc" id="L3956">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L3958">			ps = db_conn.prepareStatement(&quot;SELECT&quot;+limitSqlBefore+&quot; image_id, image_path, image_name FROM gallery WHERE image_path = ?&quot;+whereCondition+CloudToolsForCore.getDomainIdSqlWhere(true)+&quot; ORDER BY image_name ASC &quot; + limitSQLAfter);</span>
<span class="nc" id="L3959">			int psCounter = 1;</span>
<span class="nc" id="L3960">			ps.setString(psCounter++, galleryPath);</span>

<span class="nc" id="L3962">			rs = ps.executeQuery();</span>

<span class="nc bnc" id="L3964" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L3966">				firstImage.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="nc" id="L3967">				firstImage.setImagePath(rs.getString(&quot;image_path&quot;));</span>
<span class="nc" id="L3968">				firstImage.setImageName(rs.getString(&quot;image_name&quot;));</span>
			}

<span class="nc" id="L3971">			rs.close();</span>
<span class="nc" id="L3972">			ps.close();</span>
<span class="nc" id="L3973">			db_conn.close();</span>

<span class="nc" id="L3975">			rs = null;</span>
<span class="nc" id="L3976">			ps = null;</span>
<span class="nc" id="L3977">			db_conn = null;</span>
		}
<span class="nc" id="L3979">		catch (Exception ex)</span>
		{
<span class="nc" id="L3981">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L3987" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L3988">					rs.close();</span>
<span class="nc bnc" id="L3989" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L3990">					ps.close();</span>
<span class="nc bnc" id="L3991" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L3992">					db_conn.close();</span>
			}
<span class="nc" id="L3994">			catch (Exception ex2)</span>
			{
<span class="nc" id="L3996">				sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L3997">			}</span>
		}

<span class="nc" id="L4000">		return firstImage;</span>
	}

	/**
	 * Funkcia vrati GalleryBean prveho obrazka, ktory patri do zadanej fotogalerie na zaklade jej adresara
	 *
	 * @param galleryPath	cesta galerie, z ktorej sa ma vybrat prvy obrazok na zaklade abecedneho poradia
	 *
	 * @return
	 */
	public static GalleryBean getFirstImageFromGalleryByPerexGroupFromDir(String galleryPath)
	{
<span class="nc" id="L4012">		GalleryBean firstImage = new GalleryBean();</span>

<span class="nc" id="L4014">		String realPath = sk.iway.iwcm.Tools.getRealPath(galleryPath);</span>
		IwcmFile[] fileList;
<span class="nc" id="L4016">		IwcmFile file = null;</span>

<span class="nc" id="L4018">		file = new IwcmFile(realPath);</span>
<span class="nc" id="L4019">		fileList = file.listFiles(new IwcmFileFilter()</span>
<span class="nc" id="L4020">		{</span>
			@Override
			public boolean accept(IwcmFile pathname)
			{
<span class="nc bnc" id="L4024" title="All 2 branches missed.">				return (isImageFast(pathname))</span>
<span class="nc bnc" id="L4025" title="All 2 branches missed.">							&amp;&amp; pathname.getName().startsWith(&quot;s_&quot;);</span>
			}
		});

<span class="nc bnc" id="L4029" title="All 2 branches missed.">   	if (fileList == null)</span>
<span class="nc" id="L4030">   		fileList = new IwcmFile[0];</span>
   	try
   	{
<span class="nc" id="L4033">   		Arrays.sort(fileList, new Comparator&lt;IwcmFile&gt;()</span>
<span class="nc" id="L4034">   		{</span>
   			@Override
				public int compare(IwcmFile f1, IwcmFile f2)
   			{
<span class="nc" id="L4038">   				return (f1.getName().compareTo(f2.getName()));</span>
   			}
   		});
   	}
<span class="nc" id="L4042">   	catch (Exception ex)</span>
   	{
<span class="nc" id="L4044">   		sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L4045">   	}</span>

<span class="nc bnc" id="L4047" title="All 2 branches missed.">   	if (fileList.length &gt; 0)</span>
   	{
<span class="nc" id="L4049">   		firstImage.setImagePath(fileList[0].getVirtualParent());</span>
<span class="nc" id="L4050">   		firstImage.setImageName(fileList[0].getName().substring(2));</span>
   	}
   	else
<span class="nc" id="L4053">   		return null;</span>

<span class="nc" id="L4055">   	return firstImage;</span>
   	}

   /**
	 * zvysi pocet videni o jeden
	 * @param dimId - zhodne s dimension_id
	 */
	public static void addGalleryViews(int dimId)
	{
<span class="nc" id="L4064">		int views = 0;</span>
<span class="nc" id="L4065">		GalleryDimension info = getGalleryInfo(null, dimId);</span>
<span class="nc bnc" id="L4066" title="All 4 branches missed.">		if(info == null || info.getGalleryId() &lt; 1)</span>
<span class="nc" id="L4067">			return;</span>
		try
		{
<span class="nc" id="L4070">			views = DB.queryForInt(&quot;SELECT views FROM gallery_dimension WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), Integer.valueOf(dimId));</span>
<span class="nc" id="L4071">			++views;</span>
		}
<span class="nc" id="L4073">		catch (IllegalStateException e)</span>
		{
<span class="nc" id="L4075">			views = 1;</span>
<span class="nc" id="L4076">		}</span>
<span class="nc" id="L4077">		DB.execute(&quot;UPDATE gallery_dimension SET views = ? WHERE dimension_id = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), Integer.valueOf(views), Integer.valueOf(dimId));</span>
<span class="nc" id="L4078">	}</span>

	public static void stripExif(String filePath)
	{
<span class="pc bpc" id="L4082" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;galleryStripExif&quot;) == false) return;</span>

<span class="fc" id="L4084">		String imageMagickDir = getImageMagicDir();</span>
<span class="fc" id="L4085">		boolean convertExists = false;</span>
<span class="fc" id="L4086">		String runtimeFile = getRuntimeFile();</span>

		try
		{
<span class="pc bpc" id="L4090" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(imageMagickDir))</span>
			{
<span class="fc" id="L4092">				File f = new File(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="pc bpc" id="L4093" title="2 of 4 branches missed.">				if (f.exists() &amp;&amp; f.canRead())</span>
				{
<span class="fc" id="L4095">					convertExists = true;</span>
				}
			}
<span class="pc bpc" id="L4098" title="2 of 4 branches missed.">			if (Tools.isNotEmpty(imageMagickDir) &amp;&amp; convertExists)</span>
			{
<span class="fc" id="L4100">				Logger.debug(GalleryDB.class, &quot;executing image magick: &quot; + imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="fc" id="L4101">				Runtime rt = Runtime.getRuntime();</span>

<span class="fc" id="L4103">				String[] args = new String[4];</span>

<span class="pc bpc" id="L4105" title="1 of 2 branches missed.">				if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(filePath)))</span>
				{
<span class="nc" id="L4107">					IwcmFsDB.writeFileToDisk(new File(filePath),new File(IwcmFsDB.getTempFilePath(filePath)));</span>
<span class="nc" id="L4108">					args[0] = imageMagickDir + File.separatorChar + runtimeFile;</span>
<span class="nc" id="L4109">					args[1] = IwcmFsDB.getTempFilePath(filePath);</span>
<span class="nc" id="L4110">					args[2] = &quot;-strip&quot;;</span>
<span class="nc" id="L4111">					args[3] = IwcmFsDB.getTempFilePath(filePath);</span>
				}
				else
				{
<span class="fc" id="L4115">					args[0] = imageMagickDir + File.separatorChar + runtimeFile;</span>
<span class="fc" id="L4116">					args[1] = filePath;</span>
<span class="fc" id="L4117">					args[2] = &quot;-strip&quot;;</span>
<span class="fc" id="L4118">					args[3] = filePath;</span>
				}

<span class="fc" id="L4121">				StringBuilder params = new StringBuilder();</span>
<span class="fc bfc" id="L4122" title="All 2 branches covered.">				for (int i = 0; i &lt; args.length; i++)</span>
				{
<span class="fc" id="L4124">					params.append(' ').append(args[i]);</span>
				}
<span class="fc" id="L4126">				Logger.debug(GalleryDB.class, &quot;LONGCMD:\n&quot; + params);</span>
<span class="fc" id="L4127">				Process proc = rt.exec(args);</span>
<span class="fc" id="L4128">				InputStream stderr = proc.getErrorStream();</span>
<span class="fc" id="L4129">				BufferedReader br = new BufferedReader(new InputStreamReader(stderr, Constants.FILE_ENCODING));</span>
<span class="fc" id="L4130">				String line = null;</span>
<span class="pc bpc" id="L4131" title="1 of 2 branches missed.">				while ((line = br.readLine()) != null)</span>
				{
<span class="nc" id="L4133">					Logger.debug(GalleryDB.class, line);</span>
				}
<span class="fc" id="L4135">				br.close();</span>
<span class="fc" id="L4136">				int exitValue = proc.waitFor();</span>
<span class="fc" id="L4137">				Logger.debug(GalleryDB.class, &quot;ExitValue: &quot; + exitValue);</span>
			}

		}
<span class="nc" id="L4141">		catch (Exception ex)</span>
		{
<span class="nc" id="L4143">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L4144">		}</span>
<span class="fc" id="L4145">	}</span>
	/**
	 * Vrati statistiku odoslani obrazkov
	 *
	 * @param imagePath	cesta obrazka, ktory sa ma vyhladat
	 * @param alsoEmpty  ci ma vratit aj nulove pocty
	 * @return zoznam objektov GalleryBean
	 */
	public static List&lt;GalleryBean&gt; getAllSendCount(String imagePath,boolean alsoEmpty)
	{
<span class="nc" id="L4155">		List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L4157">   	StringBuilder sql = new StringBuilder();</span>
<span class="nc" id="L4158">		sql.append(&quot;SELECT image_name, send_count, image_path, image_id, image_path FROM gallery WHERE image_id &gt; 0&quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>

<span class="nc bnc" id="L4160" title="All 2 branches missed.">   	if (Tools.isNotEmpty(imagePath))</span>
   	{
<span class="nc" id="L4162">   		sql.append(&quot; AND image_path LIKE ?&quot;);</span>
<span class="nc" id="L4163">   		params.add(&quot;%&quot; + imagePath + &quot;%&quot;);</span>
   	}
<span class="nc bnc" id="L4165" title="All 2 branches missed.">   	if(!alsoEmpty){</span>
<span class="nc" id="L4166">   		sql.append(&quot; AND send_count &gt; 0 &quot;);</span>
   	}
<span class="nc" id="L4168">   	sql.append(&quot; ORDER BY send_count DESC&quot;);</span>

<span class="nc" id="L4170">      List&lt;GalleryBean&gt; imageBeans = new ComplexQuery().setSql(sql.toString()).setParams(params.toArray()).list(new Mapper&lt;GalleryBean&gt;()</span>
<span class="nc" id="L4171">      {</span>
         @Override
			public GalleryBean map(ResultSet rs) throws SQLException
         {
<span class="nc" id="L4175">         	GalleryBean imageBean = new GalleryBean();</span>

<span class="nc" id="L4177">         	imageBean.setImagePath(rs.getString(&quot;image_path&quot;));</span>
<span class="nc" id="L4178">         	imageBean.setImageName(rs.getString(&quot;image_name&quot;));</span>
<span class="nc" id="L4179">				imageBean.setImageId(rs.getInt(&quot;image_id&quot;));</span>
<span class="nc" id="L4180">				imageBean.setSendCount(rs.getInt(&quot;send_count&quot;));</span>

<span class="nc" id="L4182">         	return imageBean;</span>
         }
      });

<span class="nc" id="L4186">		return imageBeans;</span>
	}

	/**
	 * Vrati statistiku odoslani obrazkov, aj tie ktore maju pocet odoslani 0
	 * @param imagePath	cesta obrazka, ktory sa ma vyhladat
	 * @return zoznam objektov GalleryBean
	 */
	public static List&lt;GalleryBean&gt; getAllSendCount(String imagePath)
	{
<span class="nc" id="L4196">		return getAllSendCount(imagePath,true);</span>
	}

	/**
	 * Vrati datum a cas uploadu obrazku z fotogalerie na server
	 *
	 * @param dir	adresar, v ktorom sa obrazok nachadza
	 * @param name	nazov obrazka aj s priponou
	 *
	 * @return datum a cas nahratia obrazku na server, null vrati v pripade, ze sa nepodari spojenie s DB alebo obrazok nema nastaveny upload_datetime
	 */
	public static Date getUploadDateImage(String dir, String name)
	{
		try
		{
<span class="fc" id="L4211">			return new SimpleQuery().forDate(&quot;SELECT upload_datetime FROM gallery WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), dir, name);</span>
		}
<span class="nc" id="L4213">		catch (Exception e)</span>
		{
<span class="nc" id="L4215">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L4216">			return null;</span>
		}
	}

	/**
	 * Nastavi obrazku, ktory nema ulozeny datum uploadu, datum poslednej modifikacie suboru
	 *
	 * @param dir			adresar obrazka
	 * @param name			meno obrazka
	 * @param uploadDate	datum, ktory sa ma nastavit ako datum uploadu
	 *
	 * @return true ak sa operacia podarila, inak false
	 */
	public static boolean setUploadDateImage(String dir, String name, long uploadDate)
	{
		try
		{
<span class="fc" id="L4233">			new SimpleQuery().execute(&quot;UPDATE gallery SET upload_datetime = ? WHERE image_path = ? AND image_name = ?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), new Timestamp(uploadDate), dir, name);</span>
<span class="fc" id="L4234">			return true;</span>
		}
<span class="nc" id="L4236">		catch (Exception e)</span>
		{
<span class="nc" id="L4238">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L4239">			return false;</span>
		}
	}

	/**
	 * Konvertuje obrazok na JPG
	 * @param f
	 */
	public static void convertToJPG(IwcmFile f)
	{
<span class="nc" id="L4249">		String[] args = new String[]{&quot;imagemagick&quot;, &quot;from&quot;, &quot;to&quot;};</span>
<span class="nc" id="L4250">		String filePath = f.getAbsolutePath();</span>
<span class="nc" id="L4251">		String extension = FileTools.getFileExtension(filePath);</span>
		try
		{
<span class="nc bnc" id="L4254" title="All 2 branches missed.">			if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(filePath)))</span>
			{
<span class="nc" id="L4256">				IwcmFsDB.writeFileToDisk(new File(filePath), new File(IwcmFsDB.getTempFilePath(filePath)));</span>
<span class="nc" id="L4257">				args[1] = IwcmFsDB.getTempFilePath(filePath);</span>
<span class="nc" id="L4258">				args[2] = IwcmFsDB.getTempFilePath(filePath.replace(&quot;.&quot; + extension, &quot;.jpg&quot;));</span>
			}
			else
			{
<span class="nc" id="L4262">				args[1] = filePath;</span>
<span class="nc" id="L4263">				args[2] = filePath.replace(&quot;.&quot; + extension, &quot;.jpg&quot;);</span>
			}
<span class="nc" id="L4265">			executeImageMagickCommand(args);</span>
		}
<span class="nc" id="L4267">		catch (Exception e)</span>
		{
<span class="nc" id="L4269">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L4270">		}</span>
<span class="nc" id="L4271">	}</span>

	/**
	 * pokus o ziskanie datumu vytvorenia JPG fotky z EXIF metadat
	 * @param waitForBytes
	 * @return - v pripade ze nenejade, vrati aktualny datum/cas
	 */
	public static Date getExifDateOriginal(IwcmFile file)
	{
<span class="pc bpc" id="L4280" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;galleryEnableExifDate&quot;)==false) return null;</span>

		try
		{
<span class="pc bpc" id="L4284" title="1 of 6 branches missed.">			if(file != null &amp;&amp; (file.getName().toLowerCase().endsWith(&quot;jpg&quot;) || file.getName().toLowerCase().endsWith(&quot;jpeg&quot;)))</span>
			{
<span class="fc" id="L4286">				Metadata metadata = null;</span>
<span class="pc bpc" id="L4287" title="1 of 2 branches missed.">				if(file != null)</span>
				{
					try
					{
<span class="fc" id="L4291">						IwcmInputStream is = new IwcmInputStream(file);</span>
<span class="fc" id="L4292">						metadata = ImageMetadataReader.readMetadata(is);</span>
<span class="fc" id="L4293">						is.close();</span>
						//metadata = ImageMetadataReader.readMetadata(bis, waitForBytes);
					}
<span class="nc" id="L4296">					catch (Exception ex2)</span>
					{
<span class="nc" id="L4298">						sk.iway.iwcm.Logger.error(ex2);</span>
<span class="nc" id="L4299">						metadata = null;</span>
<span class="fc" id="L4300">					}</span>
				}

<span class="pc bpc" id="L4303" title="1 of 2 branches missed.">				if(metadata != null)</span>
				{
<span class="fc bfc" id="L4305" title="All 2 branches covered.">					for(Directory dir : metadata.getDirectories())</span>
					{
						//adredar ktory drzi EXIF metedata
<span class="pc bpc" id="L4308" title="1 of 2 branches missed.">						if(&quot;Exif SubIFD&quot;.equals(dir.getName()))</span>
						{
<span class="nc bnc" id="L4310" title="All 2 branches missed.">							for(Tag tag : dir.getTags())</span>
							{
<span class="nc bnc" id="L4312" title="All 2 branches missed.">								if(&quot;Date/Time Original&quot;.equals(tag.getTagName()))</span>
								{
									//datum je v tvare 2002:07:13 15:58:28, takze to musime rozparsovat a dat do spravneho tvaru. teda 13.07.2002 15:58:28
<span class="nc" id="L4315">									String[] dateTime = Tools.getTokens(tag.getDescription(), &quot; &quot;);</span>
<span class="nc bnc" id="L4316" title="All 4 branches missed.">									if(dateTime != null &amp;&amp; dateTime.length == 2)</span>
									{
<span class="nc" id="L4318">										String[] datum = Tools.getTokens(dateTime[0], &quot;:&quot;);</span>
<span class="nc bnc" id="L4319" title="All 10 branches missed.">										if(datum != null &amp;&amp; datum.length == 3 &amp;&amp; Tools.getIntValue(datum[2],-1) != -1 &amp;&amp; Tools.getIntValue(datum[1],-1) != -1 &amp;&amp; Tools.getIntValue(datum[0],-1) != -1)</span>
										{
<span class="nc" id="L4321">											Date date = new Date(DB.getTimestamp(datum[2]+datum[1]+datum[0], dateTime[1]));</span>
<span class="nc" id="L4322">											return date;</span>
										}
									}
								}
<span class="nc" id="L4326">							}</span>
						}
<span class="fc" id="L4328">					}</span>
				}
			}
		}
<span class="nc" id="L4332">		catch (Exception e)</span>
		{
<span class="nc" id="L4334">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L4335">		}</span>

<span class="fc" id="L4337">		return null;</span>
	}

	public static boolean existsImageMagickConvertCommand()
	{
<span class="nc" id="L4342">		String imageMagickDir = getImageMagicDir();</span>
<span class="nc" id="L4343">		boolean convertExists = false;</span>
<span class="nc" id="L4344">		String runtimeFile = getRuntimeFile();</span>

<span class="nc bnc" id="L4346" title="All 2 branches missed.">		if (Tools.isNotEmpty(imageMagickDir))</span>
		{
<span class="nc" id="L4348">			File f = new File(imageMagickDir + File.separatorChar + runtimeFile);</span>
<span class="nc bnc" id="L4349" title="All 4 branches missed.">			if (f.exists() &amp;&amp; f.canRead())</span>
			{
<span class="nc" id="L4351">				convertExists = true;</span>
			}
		}
<span class="nc" id="L4354">		return convertExists;</span>
	}

	/**
	 * Vrati hodnotu pre parameter quality z ImageMagick convert prikazu, hodnota sa preberie bud z parametra q alebo z konstanty galleryImageQuality
	 * Vrati -1 ak sa ma pouzit automaticky mod (parameter quality pre convert sa nenastavi)
	 * @param request
	 * @param imageWidth
	 * @return
	 */
	public static int getImageQuality(HttpServletRequest request, int imageWidth)
	{
<span class="fc" id="L4366">		int imageQuality = -1;</span>

<span class="pc bpc" id="L4368" title="1 of 2 branches missed.">		if (request != null)</span>
		{
<span class="fc" id="L4370">			int qParam = Tools.getIntValue(request.getParameter(&quot;q&quot;), -1);</span>
<span class="pc bpc" id="L4371" title="1 of 4 branches missed.">			if (qParam &gt; 10 &amp;&amp; qParam &lt;= 100) imageQuality = qParam;</span>
		}

<span class="fc bfc" id="L4374" title="All 2 branches covered.">		if (imageQuality == -1)</span>
		{
<span class="fc" id="L4376">			String galleryImageQuality = Constants.getString(&quot;galleryImageQuality&quot;);</span>
<span class="pc bpc" id="L4377" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(galleryImageQuality))</span>
			{
<span class="nc" id="L4379">				StringTokenizer st = new StringTokenizer(galleryImageQuality, &quot;;&quot;);</span>
<span class="nc bnc" id="L4380" title="All 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
<span class="nc" id="L4382">					String token = st.nextToken();</span>
					try
					{
<span class="nc" id="L4385">						int index = token.indexOf(':');</span>
<span class="nc bnc" id="L4386" title="All 2 branches missed.">						if (index != -1)</span>
						{
<span class="nc" id="L4388">							int w = Tools.getIntValue(token.substring(0, index), -1);</span>
<span class="nc" id="L4389">							int q = Tools.getIntValue(token.substring(index+1), -1);</span>
<span class="nc bnc" id="L4390" title="All 6 branches missed.">							if (w &gt; 0 &amp;&amp; q &gt; 0 &amp;&amp; w &lt;= imageWidth)</span>
							{
<span class="nc" id="L4392">								imageQuality = q;</span>
							}
						}
<span class="nc" id="L4395">					} catch (Exception ex)</span>
					{
<span class="nc" id="L4397">						sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L4398">					}</span>
<span class="nc" id="L4399">				}</span>
			}
		}

<span class="fc" id="L4403">		return imageQuality;</span>
	}

	public static boolean isVideo(GalleryBean gBean)
	{
<span class="nc" id="L4408">		String fileName=gBean.getImageName();</span>
<span class="nc" id="L4409">		int index = fileName.lastIndexOf(&quot;.&quot;);</span>
<span class="nc" id="L4410">		String videoName = gBean.getImagePath()+&quot;/&quot;+fileName.substring(0,index)+&quot;.mp4&quot;;</span>
		//File f = new File(gBean.getImagePath()+&quot;/&quot;+videoName);
<span class="nc" id="L4412">		IwcmFile f = new IwcmFile(Tools.getRealPath(videoName));</span>
<span class="nc bnc" id="L4413" title="All 2 branches missed.">		if (f.exists())</span>
		{
<span class="nc" id="L4415">			return true;</span>
		}
<span class="nc" id="L4417">		return false;</span>
	}

	/**
	 * Premenuje obrazok v galerii vratane upravy databazy (tabulka gallery a media) a pridania presmerovania
	 * @param originalUrl
	 * @param newUrl
	 * @return
	 */
	public static boolean renameFile(String originalUrl, String newUrl)
	{
<span class="nc" id="L4428">		Logger.debug(GalleryDB.class, &quot;renameFile orig=&quot;+originalUrl+&quot; new=&quot;+newUrl);</span>

		//skontroluj priponu
<span class="nc" id="L4431">		String origExtension = FileTools.getFileExtension(originalUrl).toLowerCase();</span>
<span class="nc" id="L4432">		String newExtension = FileTools.getFileExtension(newUrl).toLowerCase();</span>

<span class="nc bnc" id="L4434" title="All 2 branches missed.">		if (origExtension.equalsIgnoreCase(newExtension)==false)</span>
		{
<span class="nc" id="L4436">			newUrl = newUrl + &quot;.&quot; + origExtension;</span>
<span class="nc" id="L4437">			Logger.debug(GalleryDB.class, &quot;Adding extension: &quot;+origExtension+&quot; newUrl=&quot;+newUrl);</span>
		}

<span class="nc" id="L4440">		boolean moved = false;</span>
		try
		{
<span class="nc" id="L4443">			moved = FileTools.moveFile(originalUrl, newUrl);</span>
<span class="nc bnc" id="L4444" title="All 2 branches missed.">			if (moved)</span>
			{
<span class="nc" id="L4446">				Adminlog.add(Adminlog.TYPE_GALLERY, &quot;Rename file from=&quot;+originalUrl+&quot; to=&quot;+newUrl, -1, -1);</span>

				//presun subor iba ak existuje
<span class="nc bnc" id="L4449" title="All 2 branches missed.">				if (GalleryDB.getImagePathOriginal(originalUrl).startsWith(&quot;o_&quot;)) FileTools.moveFile(GalleryDB.getImagePathOriginal(originalUrl), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newUrl));</span>
<span class="nc bnc" id="L4450" title="All 2 branches missed.">				if (GalleryDB.getImagePathSmall(originalUrl).startsWith(&quot;s_&quot;)) FileTools.moveFile(GalleryDB.getImagePathSmall(originalUrl), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newUrl));</span>

				//otestuj aj video subory
<span class="nc" id="L4453">				String videoFileName = FileTools.getFilePathWithoutExtension(originalUrl)+&quot;.mp4&quot;;</span>
<span class="nc" id="L4454">				IwcmFile f = new IwcmFile(Tools.getRealPath(videoFileName));</span>
<span class="nc bnc" id="L4455" title="All 2 branches missed.">				if (f.exists())</span>
				{
<span class="nc" id="L4457">					FileTools.moveFile(videoFileName, FileTools.getFilePathWithoutExtension(newUrl)+&quot;.mp4&quot;);</span>
				}
<span class="nc" id="L4459">				videoFileName = FileTools.getFilePathWithoutExtension(originalUrl)+&quot;.flv&quot;;</span>
<span class="nc" id="L4460">				f = new IwcmFile(Tools.getRealPath(videoFileName));</span>
<span class="nc bnc" id="L4461" title="All 2 branches missed.">				if (f.exists())</span>
				{
<span class="nc" id="L4463">					FileTools.moveFile(videoFileName, FileTools.getFilePathWithoutExtension(newUrl)+&quot;.flv&quot;);</span>
				}

				//presun data v databaze
<span class="nc" id="L4467">				updateGalleryBeanLinkInDatabase(originalUrl, newUrl);</span>

<span class="nc bnc" id="L4469" title="All 2 branches missed.">				if ( isGalleryFolder(newUrl) )</span>
				{
<span class="nc" id="L4471">					String BASE_DIR = newUrl.substring(0, newUrl.lastIndexOf(&quot;/&quot;)+1);</span>
<span class="nc" id="L4472">					Prop prop = Prop.getInstance();</span>
<span class="nc" id="L4473">					Dimension[] dims = GalleryDB.getDimension(BASE_DIR);</span>
<span class="nc" id="L4474">					GalleryDB.resizePictureImpl(dims, Tools.getRealPath(newUrl), null, prop, GalleryDB.getResizeMode(BASE_DIR));</span>
				}
			}
		}
<span class="nc" id="L4478">		catch (Exception ex)</span>
		{
<span class="nc" id="L4480">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L4481">		}</span>
<span class="nc" id="L4482">		return moved;</span>
	}

	private static void updateGalleryBeanLinkInDatabase(String originalUrl, String newUrl)
	{
<span class="nc" id="L4487">		String originalDir = originalUrl.substring(0, originalUrl.lastIndexOf(&quot;/&quot;));</span>
<span class="nc" id="L4488">		String originalFile = originalUrl.substring(originalUrl.lastIndexOf(&quot;/&quot;)+1);</span>

<span class="nc" id="L4490">		String newDir = newUrl.substring(0, newUrl.lastIndexOf(&quot;/&quot;));</span>
<span class="nc" id="L4491">		String newFile = newUrl.substring(newUrl.lastIndexOf(&quot;/&quot;)+1);</span>

<span class="nc" id="L4493">		(new SimpleQuery()).execute(&quot;DELETE FROM gallery WHERE image_path=? AND image_name=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), newDir, newFile);</span>
<span class="nc" id="L4494">		(new SimpleQuery()).execute(&quot;UPDATE gallery SET image_path=?, image_name=? WHERE image_path=? AND image_name=?&quot;+CloudToolsForCore.getDomainIdSqlWhere(true), newDir, newFile, originalDir, originalFile);</span>
<span class="nc bnc" id="L4495" title="All 2 branches missed.">		(new SimpleQuery()).execute(&quot;UPDATE documents SET perex_image=? WHERE perex_image=?&quot;+(InitServlet.isTypeCloud() ? (&quot; &quot;+StatDB.getRootGroupWhere(&quot;group_id&quot;, CloudToolsForCore.getDomainId())) : &quot;&quot;), newDir+&quot;/&quot;+newFile, originalDir+&quot;/&quot;+originalFile);</span>
<span class="nc bnc" id="L4496" title="All 2 branches missed.">		(new SimpleQuery()).execute(&quot;UPDATE documents SET perex_image=? WHERE perex_image=?&quot;+(InitServlet.isTypeCloud() ? (&quot; &quot;+StatDB.getRootGroupWhere(&quot;group_id&quot;, CloudToolsForCore.getDomainId())) : &quot;&quot;), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newDir+&quot;/&quot;+newFile), GalleryDB.getImagePathPrefix(&quot;o_&quot;, originalDir+&quot;/&quot;+originalFile));</span>
<span class="nc bnc" id="L4497" title="All 2 branches missed.">		(new SimpleQuery()).execute(&quot;UPDATE documents SET perex_image=? WHERE perex_image=?&quot;+(InitServlet.isTypeCloud() ? (&quot; &quot;+StatDB.getRootGroupWhere(&quot;group_id&quot;, CloudToolsForCore.getDomainId())) : &quot;&quot;), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newDir+&quot;/&quot;+newFile), GalleryDB.getImagePathPrefix(&quot;s_&quot;, originalDir+&quot;/&quot;+originalFile));</span>

<span class="nc" id="L4499">		MediaDB.updateLink(originalUrl, newUrl);</span>
<span class="nc" id="L4500">		MediaDB.updateThumb(originalUrl, newUrl);</span>
<span class="nc" id="L4501">		EditorDB.replaceUrl(originalUrl, newUrl, null);</span>

<span class="nc" id="L4503">		MediaDB.updateLink(GalleryDB.getImagePathPrefix(&quot;o_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newUrl));</span>
<span class="nc" id="L4504">		MediaDB.updateThumb(GalleryDB.getImagePathPrefix(&quot;o_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newUrl));</span>
<span class="nc" id="L4505">		EditorDB.replaceUrl(GalleryDB.getImagePathPrefix(&quot;o_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;o_&quot;, newUrl), null);</span>

<span class="nc" id="L4507">		MediaDB.updateLink(GalleryDB.getImagePathPrefix(&quot;s_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newUrl));</span>
<span class="nc" id="L4508">		MediaDB.updateThumb(GalleryDB.getImagePathPrefix(&quot;s_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newUrl));</span>
<span class="nc" id="L4509">		EditorDB.replaceUrl(GalleryDB.getImagePathPrefix(&quot;s_&quot;, originalUrl), GalleryDB.getImagePathPrefix(&quot;s_&quot;, newUrl), null);</span>
<span class="nc" id="L4510">	}</span>

	/**
	 * Pomocna metoda na test suboru, ci sa jedna o obrazok, testuje na zaklade pripony
	 * ak je zapnute galleryUseFastLoading netestuje, ci sa realne jedna o subor alebo adresar, testuje len priponu
	 * pouziva sa pri clustri a pripojenom pomalom NAS
	 * @param file
	 * @return
	 */
	private static boolean isImageFast(IwcmFile file)
	{
		//ak je vypnute fast otestuj, ci sa nejedna o adresar, ak ano, nemoze to byt obrazok
<span class="pc bpc" id="L4522" title="1 of 4 branches missed.">		if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)==false &amp;&amp; file.isFile()==false) return false;</span>

<span class="fc" id="L4524">		String suffix = FileTools.getFileExtension(file.getName()).toLowerCase();</span>
<span class="pc bpc" id="L4525" title="3 of 8 branches missed.">		if (&quot;png&quot;.equals(suffix) || &quot;jpg&quot;.equals(suffix) || &quot;jpeg&quot;.equals(suffix) || &quot;gif&quot;.equals(suffix))</span>
		{
<span class="fc" id="L4527">			return true;</span>
		}
<span class="nc" id="L4529">		return false;</span>
	}

	/**
	 * Pomocna metoda na test suboru, ci sa jedna o adresar
	 * ak je zapnute galleryUseFastLoading netestuje, ci sa realne jedna o subor alebo adresar, testuje len priponu
	 * pouziva sa pri clustri a pripojenom pomalom NAS
	 * @param file
	 * @return
	 */
	private static boolean isDirectoryFast(IwcmFile file)
	{
		//ak je vypnute fast vratime rovno ci je to adresar
<span class="pc bpc" id="L4542" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;galleryUseFastLoading&quot;)==false) return file.isDirectory();</span>

<span class="nc" id="L4544">		String suffix = FileTools.getFileExtension(file.getName()).toLowerCase();</span>
<span class="nc bnc" id="L4545" title="All 12 branches missed.">		if (&quot;png&quot;.equals(suffix) || &quot;jpg&quot;.equals(suffix) || &quot;jpeg&quot;.equals(suffix) || &quot;gif&quot;.equals(suffix) || &quot;bmp&quot;.equals(suffix) || &quot;zip&quot;.equals(suffix))</span>
		{
<span class="nc" id="L4547">			return false;</span>
		}
<span class="nc" id="L4549">		return file.isDirectory();</span>
	}

	private static double limitMaxSize(double size)
	{
<span class="pc bpc" id="L4554" title="1 of 2 branches missed.">		if (size &gt; 5000) return 5000;</span>
<span class="fc" id="L4555">		return size;</span>
	}

	/**
	 * Metoda zmaze celu galeriu vratane podadresarov a vsetkych medii v ramci aktualnej domeny
	 * @param path cesta ku galerii (napr /images/gallery/nejakaGaleria)
	 * @return true ak sa podari zmazat vsetky media a vratane podadresarov, inak false
	 * @throws IllegalArgumentException if path is empty or null
	 * @author mhalas
	 */
	public static boolean deleteGallery(String path)
	{
<span class="fc" id="L4567">		boolean success = false;</span>
<span class="pc bpc" id="L4568" title="1 of 2 branches missed.">		if(Tools.isEmpty(path)) throw new IllegalArgumentException(&quot;path can't be empty&quot;);</span>
<span class="fc" id="L4569">		String galleryRootFolder = getGalleryRootFolder();</span>
<span class="pc bpc" id="L4570" title="1 of 2 branches missed.">		if(path.equals(galleryRootFolder))</span>
		{
<span class="nc" id="L4572">			Logger.debug(GalleryDB.class,&quot;Root gallery folder, skipping...&quot;);</span>
<span class="nc" id="L4573">			return success;</span>
		}
<span class="pc bpc" id="L4575" title="1 of 2 branches missed.">		if(isGalleryFolder(path))</span>
		{
<span class="fc" id="L4577">			Logger.debug(GalleryDB.class, &quot;Deleting gallery &quot; + path + &quot; ...&quot;);</span>
<span class="fc" id="L4578">			Map&lt;String, GalleryBean&gt; beans = getGalleryBeanTable(path, &quot;_sk&quot;, true);</span>
<span class="fc" id="L4579">			Logger.debug(GalleryDB.class, &quot;Deleting images...&quot;);</span>
<span class="fc bfc" id="L4580" title="All 2 branches covered.">			for(GalleryBean b : beans.values())</span>
			{
<span class="fc" id="L4582">				removeImage(b);</span>
<span class="fc" id="L4583">			}</span>
<span class="fc" id="L4584">			Logger.debug(GalleryDB.class, &quot;Deleted &quot; + beans.size() + &quot; images&quot;);</span>
<span class="fc" id="L4585">			new SimpleQuery().execute(&quot;DELETE from gallery_dimension WHERE image_path LIKE ? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true), path+&quot;%&quot;);</span>
			try{
<span class="fc" id="L4587">				Logger.debug(GalleryDB.class, &quot;Deleting directory: &quot; + Tools.getRealPath(path));</span>
<span class="fc" id="L4588">				FileUtils.deleteDirectory(new File(Tools.getRealPath(path)));</span>
<span class="fc" id="L4589">				success = true;</span>
<span class="fc" id="L4590">				Logger.debug(GalleryDB.class, &quot;Gallery &quot;+path+&quot; deleted&quot;);</span>
			}
<span class="nc" id="L4592">			catch(IOException e){</span>
<span class="nc" id="L4593">				Logger.debug(GalleryDB.class, &quot;Failed to delete gallery &quot; + path + &quot; reason: &quot;+e.getMessage());</span>
<span class="fc" id="L4594">			}</span>
<span class="fc" id="L4595">		}</span>
		else
		{
<span class="nc" id="L4598">			Logger.debug(GalleryDB.class, path + &quot; is not a gallery folder, skipping...&quot;);</span>
		}
<span class="fc" id="L4600">		return success;</span>
	}

	/**
	 * Vrati relative path to root adresar galerie
	 * @return
	 * @author mhalas
	 */
	public static String getGalleryRootFolder()
	{
<span class="fc" id="L4610">		return Constants.getString(&quot;imagesRootDir&quot;) + &quot;/&quot; + Constants.getString(&quot;galleryDirName&quot;);</span>
	}

	/**
	 * Vymaze gallery bean z DB aj fyzicky subory vo vsetkych velkostiach
	 * @param b
	 * @author mhalas
	 */
	private static void removeImage(GalleryBean b)
	{
<span class="fc" id="L4620">		java.sql.Connection db_conn = null;</span>
<span class="fc" id="L4621">		java.sql.PreparedStatement ps = null;</span>
<span class="fc" id="L4622">		IwcmFile file = null;</span>
<span class="fc" id="L4623">		String sql = &quot;DELETE FROM gallery WHERE image_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="fc" id="L4624">		String dir = b.getImagePath();</span>
<span class="fc" id="L4625">		String name = b.getImageName();</span>
<span class="fc" id="L4626">		int imageId = b.getImageId();</span>
<span class="pc bpc" id="L4627" title="1 of 2 branches missed.">		if (dir.startsWith(&quot;/&quot;)==false) dir = &quot;/&quot;+dir;</span>
<span class="pc bpc" id="L4628" title="1 of 2 branches missed.">		if (name.startsWith(&quot;/&quot;)) name = name.substring(1);</span>

<span class="pc bpc" id="L4630" title="1 of 2 branches missed.">		if (imageId &lt; 1) imageId = getImageId(dir, name);</span>

<span class="fc" id="L4632">		String path = Tools.getRealPath(dir);</span>
		try
		{
<span class="pc bpc" id="L4635" title="1 of 2 branches missed.">			if (imageId &gt; 0)</span>
			{
<span class="fc" id="L4637">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L4638">				ps = db_conn.prepareStatement(sql);</span>
<span class="fc" id="L4639">				ps.setInt(1, imageId);</span>
<span class="fc" id="L4640">				ps.execute();</span>
<span class="fc" id="L4641">				ps.close();</span>
<span class="fc" id="L4642">				db_conn.close();</span>
<span class="fc" id="L4643">				ps = null;</span>
<span class="fc" id="L4644">				db_conn = null;</span>
			}
<span class="fc" id="L4646">			file = new IwcmFile(path + File.separator + name);</span>
<span class="pc bpc" id="L4647" title="1 of 2 branches missed.">			if (file.exists())</span>
			{
<span class="fc" id="L4649">				boolean ok = file.delete();</span>
<span class="fc" id="L4650">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
<span class="fc" id="L4652">			file = new IwcmFile(path + File.separator + &quot;s_&quot; + name);</span>
<span class="pc bpc" id="L4653" title="1 of 2 branches missed.">			if (file.exists())</span>
			{
<span class="fc" id="L4655">				boolean ok = file.delete();</span>
<span class="fc" id="L4656">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
<span class="fc" id="L4658">			file = new IwcmFile(path + File.separator + &quot;o_&quot; + name);</span>
<span class="pc bpc" id="L4659" title="1 of 2 branches missed.">			if (file.exists())</span>
			{
<span class="fc" id="L4661">				boolean ok = file.delete();</span>
<span class="fc" id="L4662">				Logger.debug(GalleryDB.class, &quot;Deleting file=&quot;+file.getAbsolutePath()+&quot; ok=&quot;+ok);</span>
			}
		}
<span class="nc" id="L4665">		catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
		finally{
			try{
<span class="pc bpc" id="L4668" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L4669" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L4670">			}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
		}
<span class="fc" id="L4672">	}</span>

	/**
	 * V databaze nastavi rozmer a rezim zmeny velkosti podadresarom podla nastaveneho adresara
	 * @param dir
	 * @param recursive
	 */
	public static void updateDirectoryDimToSubfolders(String dir) {
<span class="fc" id="L4680">		Dimension[] dims = getDimension(dir, true);</span>
<span class="fc" id="L4681">		String resizeMode = getResizeMode(dir, true);</span>
<span class="fc" id="L4682">		updateDirectoryDim(dir, dims[0], dims[1], resizeMode, true);</span>
<span class="fc" id="L4683">	}</span>

	private static void updateDirectoryDim(String dir, Dimension dim, Dimension dimNormal, String resizeMode, boolean recursive)
	{
<span class="fc" id="L4687">		IwcmFile directory = IwcmFile.fromVirtualPath(&quot;/&quot; + dir);</span>
<span class="pc bpc" id="L4688" title="2 of 4 branches missed.">		if (directory.exists() &amp;&amp; directory.isDirectory())</span>
		{
<span class="fc" id="L4690">			IwcmFile[] fileList = directory.listFiles();</span>
<span class="fc bfc" id="L4691" title="All 2 branches covered.">			for (IwcmFile file : fileList)</span>
			{
<span class="fc bfc" id="L4693" title="All 2 branches covered.">				if (file.isDirectory())</span>
				{
<span class="fc" id="L4695">					java.sql.Connection db_conn = null;</span>
<span class="fc" id="L4696">					java.sql.PreparedStatement ps = null;</span>

					try
					{
<span class="pc bpc" id="L4700" title="1 of 2 branches missed.">						if (!dir.equals(&quot;&quot;))</span>
						{
<span class="fc" id="L4702">							db_conn = DBPool.getConnection();</span>
<span class="fc" id="L4703">							ps = db_conn</span>
<span class="fc" id="L4704">								.prepareStatement(&quot;UPDATE gallery_dimension SET image_width=?, image_height=?, normal_width=?, normal_height=?, resize_mode=? WHERE image_path=?&quot;);</span>
<span class="fc" id="L4705">							ps.setInt(1, dim.width);</span>
<span class="fc" id="L4706">							ps.setInt(2, dim.height);</span>
<span class="fc" id="L4707">							ps.setInt(3, dimNormal.width);</span>
<span class="fc" id="L4708">							ps.setInt(4, dimNormal.height);</span>
<span class="fc" id="L4709">							ps.setString(5, resizeMode);</span>
<span class="fc" id="L4710">							ps.setString(6, normalizeDir(file.getVirtualPath()));</span>
<span class="fc" id="L4711">							ps.execute();</span>
<span class="fc" id="L4712">							ps.close();</span>
<span class="fc" id="L4713">							db_conn.close();</span>
<span class="fc" id="L4714">							db_conn = null;</span>
<span class="fc" id="L4715">							ps = null;</span>
						}
					}
<span class="nc" id="L4718">					catch (Exception ex){sk.iway.iwcm.Logger.error(ex);}</span>
					finally{
						try{
<span class="pc bpc" id="L4721" title="1 of 2 branches missed.">							if (ps != null) ps.close();</span>
<span class="pc bpc" id="L4722" title="1 of 2 branches missed.">							if (db_conn != null) db_conn.close();</span>
<span class="pc" id="L4723">						}catch (Exception e) {sk.iway.iwcm.Logger.error(e);}</span>
					}

<span class="pc bpc" id="L4726" title="1 of 2 branches missed.">					if(recursive)</span>
<span class="fc" id="L4727">						updateDirectoryDim(normalizeDir(file.getVirtualPath()), dim, dimNormal, resizeMode, recursive);</span>
				}
			}
		}
<span class="fc" id="L4731">	}</span>

	/**
	 * aplikuje na &quot;obrazok&quot; vodotlac podla domeny
	 * @param obrazok
	 */
	public static void applyWatermarkOnUpload(IwcmFile obrazok)
	{
<span class="pc bpc" id="L4739" title="2 of 4 branches missed.">		if(obrazok == null || obrazok.exists() == false) return;</span>
<span class="fc" id="L4740">		String suffix = FileTools.getFileExtension(obrazok.getName().toLowerCase());</span>
<span class="pc bpc" id="L4741" title="2 of 4 branches missed.">		boolean shouldPerformWatermarking = existImageMagickCompositeCommand() &amp;&amp; Constants.getBoolean(&quot;galleryWatermarkApplyOnUpload&quot;)</span>
<span class="pc bnc" id="L4742" title="All 6 branches missed.">														&amp;&amp; (&quot;png&quot;.equals(suffix) || &quot;jpg&quot;.equals(suffix) || &quot;jpeg&quot;.equals(suffix));</span>

<span class="fc" id="L4744">		String[] exceptions = Tools.getTokens(Constants.getString(&quot;galleryWatermarkApplyOnUploadExceptions&quot;), &quot;,&quot;);</span>
<span class="pc bpc" id="L4745" title="2 of 4 branches missed.">		if (exceptions != null &amp;&amp; exceptions.length&gt;0)</span>
		{
<span class="fc bfc" id="L4747" title="All 2 branches covered.">			for (String exception : exceptions)</span>
			{
<span class="pc bpc" id="L4749" title="1 of 2 branches missed.">				if (obrazok.getAbsolutePath().contains(exception))	shouldPerformWatermarking = false;</span>
			}
		}

<span class="pc bpc" id="L4753" title="1 of 2 branches missed.">		if (shouldPerformWatermarking)</span>
		{
<span class="nc" id="L4755">			Logger.debug(GalleryDB.class, &quot;(applyWatermarkOnUpload) absolutePath=&quot;+obrazok.getAbsolutePath());</span>
<span class="nc" id="L4756">			GalleryDimension watermark = new GalleryDimension();</span>
<span class="nc" id="L4757">			watermark.setWatermarkPlacement(Constants.getString(&quot;galleryWatermarkGravity&quot;));</span>
<span class="nc" id="L4758">			watermark.setWatermarkSaturation(Constants.getInt(&quot;galleryWatermarkSaturation&quot;));</span>

<span class="nc" id="L4760">			RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="nc" id="L4761">			String galleryWatermarkApplyOnUploadDir = Constants.getStringExecuteMacro(&quot;galleryWatermarkApplyOnUploadDir&quot;);</span>
<span class="nc bnc" id="L4762" title="All 2 branches missed.">			if(galleryWatermarkApplyOnUploadDir.endsWith(&quot;/&quot;) == false) galleryWatermarkApplyOnUploadDir += &quot;/&quot;;</span>
			//skusim skontrolovat obrazok pre vodotlac podla domeny
<span class="nc" id="L4764">			IwcmFile wmFile = new IwcmFile(Tools.getRealPath(galleryWatermarkApplyOnUploadDir+rb.getDomain()+&quot;.svg&quot;));</span>
			//ak nemam domenovy, pouzijem default
<span class="nc bnc" id="L4766" title="All 2 branches missed.">			if(wmFile.exists() == false) wmFile = new IwcmFile(Tools.getRealPath(galleryWatermarkApplyOnUploadDir+&quot;default.svg&quot;));</span>
<span class="nc bnc" id="L4767" title="All 2 branches missed.">			if(wmFile.exists() == false)</span>
			{
<span class="nc" id="L4769">				Logger.debug(GalleryDB.class, &quot;(applyWatermarkOnUpload) nemam watermark obrazok {domena=&quot;+rb.getDomain()+&quot;}: &quot;+wmFile.getVirtualPath());</span>
<span class="nc" id="L4770">				return;</span>
			}
<span class="nc" id="L4772">			watermark.setWatermark(wmFile.getVirtualPath());</span>
<span class="nc" id="L4773">			addWatermarkSignature(obrazok.getAbsolutePath(), watermark);</span>
		}
<span class="fc" id="L4775">	}</span>

	/**
	 * @deprecated - use GalleryDBTools.getImageSize
	 */
	@Deprecated
	public static int[] getImageSize(IwcmFile imageFile){
<span class="nc" id="L4782">		return GalleryDBTools.getImageSize(imageFile);</span>
    }

	/**
	 * @deprecated - use GalleryDBTools.cropAndResize
	 */
    @Deprecated
	public static int cropAndResize(IwcmFile from, int cwidth, int cheight, int cleft, int ctop, int finalWidth, int finalHeight, String fillColor, boolean exactFinalSize, IwcmFile to, int imageQuality, int ip)
	{
<span class="nc" id="L4791">		return GalleryDBTools.cropAndResize(from,cwidth,cheight,cleft,ctop,finalWidth,finalHeight,fillColor,exactFinalSize,to,imageQuality,ip);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>