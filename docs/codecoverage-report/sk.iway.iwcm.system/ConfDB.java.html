<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.system</a> &gt; <span class="el_source">ConfDB.java</span></div><h1>ConfDB.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.system;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import sk.iway.Password;
import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PathFilter;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.ninja.Ninja;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.system.multidomain.MultiDomainFilter;
import sk.iway.iwcm.system.spring.events.WebjetEvent;
import sk.iway.iwcm.system.spring.events.WebjetEventType;
import sk.iway.iwcm.users.UserDetails;

public class ConfDB
{
<span class="fc" id="L33">	public static String CONF_TABLE_NAME = &quot;_conf_&quot;; //NOSONAR</span>
<span class="fc" id="L34">	public static String CONF_PREPARED_TABLE_NAME = &quot;_conf_prepared_&quot;; //NOSONAR</span>
<span class="fc" id="L35">	public static String MODULES_TABLE_NAME = &quot;_modules_&quot;; //NOSONAR</span>
<span class="fc" id="L36">	public static String ADMINLOG_TABLE_NAME = &quot;_adminlog_&quot;; //NOSONAR</span>
<span class="fc" id="L37">	public static String DB_TABLE_NAME = &quot;_db_&quot;; //NOSONAR</span>
<span class="fc" id="L38">	public static String PROPERTIES_TABLE_NAME = &quot;_properties_&quot;; //NOSONAR</span>

<span class="nc" id="L40">	protected ConfDB() {</span>
		//utility class
<span class="nc" id="L42">	}</span>

	public static List&lt;ConfDetails&gt; getConfig()
	{
<span class="fc" id="L46">		return(getConfig(null));</span>
	}

	/**
	 * Vrati konfiguracne hodnotu, ak prefix nie je null tak zacinajuce sa na hodnotu prefixu
	 * @param prefix
	 * @return
	 */
	public static List&lt;ConfDetails&gt; getConfig(String prefix)
	{
<span class="fc" id="L56">		List&lt;ConfDetails&gt; conf = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L57">		Connection db_conn = null;</span>
<span class="fc" id="L58">		PreparedStatement ps = null;</span>
<span class="fc" id="L59">		ResultSet rs = null;</span>
		try
		{
			//nacitaj data z DB
<span class="fc" id="L63">			db_conn = DBPool.getConnection();</span>
<span class="fc" id="L64">			ps = db_conn.prepareStatement(&quot;SELECT * FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; ORDER BY name&quot;);</span>
<span class="fc" id="L65">			rs = ps.executeQuery();</span>
			String value;
			String name;
<span class="fc bfc" id="L68" title="All 2 branches covered.">			while (rs.next())</span>
			{
				//for e.g. export we need unfiltered values
<span class="fc" id="L71">				name = DB.getDbString(rs, &quot;name&quot;, false);</span>
<span class="fc" id="L72">				value = DB.getDbString(rs, &quot;value&quot;, false);</span>

<span class="fc bfc" id="L74" title="All 4 branches covered.">				if (Tools.isEmpty(prefix) || name.startsWith(prefix))</span>
				{
<span class="fc" id="L76">					conf.add(new ConfDetails(name, value, DB.getDate(rs, &quot;date_changed&quot;)));</span>
				}
			}
<span class="fc" id="L79">			rs.close();</span>
<span class="fc" id="L80">			ps.close();</span>
<span class="fc" id="L81">			db_conn.close();</span>
<span class="fc" id="L82">			rs = null;</span>
<span class="fc" id="L83">			ps = null;</span>
<span class="fc" id="L84">			db_conn = null;</span>
		}
<span class="nc" id="L86">		catch (Exception ex)</span>
		{
<span class="nc" id="L88">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L95">					rs.close();</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L97">					ps.close();</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L99">					db_conn.close();</span>
			}
<span class="nc" id="L101">			catch (Exception ex2)</span>
			{
<span class="fc" id="L103">			}</span>
		}
<span class="fc" id="L105">		return conf;</span>
	}

	public static List&lt;ConfDetails&gt; filterConfDetailsByPerms(Identity user, List&lt;ConfDetails&gt; confList)
	{
		//odfiltruj zoznam podla prav
<span class="fc" id="L111">		String configEnabledKeys = Constants.getStringExecuteMacro(&quot;configEnabledKeys&quot;);</span>

<span class="pc bpc" id="L113" title="1 of 4 branches missed.">		if (Tools.isEmpty(configEnabledKeys) || user.isEnabledItem(&quot;conf.show_all_variables&quot;)) return confList;</span>

<span class="fc" id="L115">		List&lt;ConfDetails&gt; filtered = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L116">		String[] enabledKeys = Tools.getTokens(configEnabledKeys, &quot;,&quot;);</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">		for (ConfDetails c : confList)</span>
		{
<span class="fc bfc" id="L119" title="All 2 branches covered.">			if (isKeyVisibleToUser(user, enabledKeys, c.getName()))</span>
			{
<span class="fc" id="L121">				filtered.add(c);</span>
			}
<span class="fc" id="L123">		}</span>

<span class="fc" id="L125">		return filtered;</span>
	}

	public static List&lt;String&gt; filterByPerms(Identity user, List&lt;String&gt; confList)
	{
		//odfiltruj zoznam podla prav
<span class="nc" id="L131">		String configEnabledKeys = Constants.getStringExecuteMacro(&quot;configEnabledKeys&quot;);</span>

<span class="nc bnc" id="L133" title="All 4 branches missed.">		if (Tools.isEmpty(configEnabledKeys) || user.isEnabledItem(&quot;conf.show_all_variables&quot;)) return confList;</span>

<span class="nc" id="L135">		List&lt;String&gt; filtered = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L136">		String[] enabledKeys = Tools.getTokens(configEnabledKeys, &quot;,&quot;);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">		for (String c : confList)</span>
		{
<span class="nc bnc" id="L139" title="All 2 branches missed.">			if (isKeyVisibleToUser(user, enabledKeys, c))</span>
			{
<span class="nc" id="L141">				filtered.add(c);</span>
			}
<span class="nc" id="L143">		}</span>

<span class="nc" id="L145">		return filtered;</span>
	}

	public static boolean isKeyVisibleToUser(Identity user, String key) {
		//odfiltruj zoznam podla prav
<span class="nc" id="L150">		String configEnabledKeys = Constants.getStringExecuteMacro(&quot;configEnabledKeys&quot;);</span>

<span class="nc bnc" id="L152" title="All 4 branches missed.">		if (Tools.isEmpty(configEnabledKeys) || user.isEnabledItem(&quot;conf.show_all_variables&quot;)) return true;</span>

<span class="nc" id="L154">		String[] enabledKeys = Tools.getTokens(configEnabledKeys, &quot;,&quot;);</span>
<span class="nc" id="L155">		return isKeyVisibleToUser(user, enabledKeys, key);</span>
	}

	public static boolean isKeyVisibleToUser(Identity user, String[] enabledKeys, String key)
	{
<span class="pc bpc" id="L160" title="2 of 4 branches missed.">		if (Tools.isEmpty(key) || user.isEnabledItem(&quot;conf.show_all_variables&quot;)) return true;</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">		for (String testKey : enabledKeys)</span>
		{
<span class="fc bfc" id="L164" title="All 2 branches covered.">			if (key.startsWith(testKey))</span>
			{
<span class="fc" id="L166">				return true;</span>
			}
		}
<span class="fc" id="L169">		return false;</span>
	}

	public static boolean deleteName(String name)
	{
<span class="fc" id="L174">		Connection db_conn = null;</span>
<span class="fc" id="L175">		PreparedStatement psDelete = null;</span>
		try
		{
			//nacitaj data z DB
<span class="fc" id="L179">			String sqlDel = &quot;&quot;;</span>
			//editacia DB _conf_
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">			if (name != null)</span>
			{
<span class="fc" id="L183">				db_conn = DBPool.getConnection();</span>
<span class="fc" id="L184">				sqlDel = &quot;DELETE FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; WHERE name=?&quot;;</span>
<span class="fc" id="L185">				psDelete = db_conn.prepareStatement(sqlDel);</span>
<span class="fc" id="L186">				psDelete.setString(1, name);</span>
<span class="fc" id="L187">				psDelete.execute();</span>
				//Logger.println(this,&quot;Number of DELETED rows= &quot; + update);
<span class="fc" id="L189">				psDelete.close();</span>
<span class="fc" id="L190">				db_conn.close();</span>
<span class="fc" id="L191">				psDelete = null;</span>
<span class="fc" id="L192">				db_conn = null;</span>
<span class="fc" id="L193">				Adminlog.add(Adminlog.TYPE_CONF_DELETE, &quot;Zmazana konfiguracna premenna: &quot;+name, -1, -1);</span>

<span class="pc bpc" id="L195" title="1 of 2 branches missed.">				if (&quot;statLanguageDomain&quot;.equals(name)) StatDB.setLanguageDomainTable(null);</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">				if (name.startsWith(&quot;multiDomainAlias:&quot;)) MultiDomainFilter.clearDomainAlias();</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">				if (&quot;responseHeaders&quot;.equals(name)) PathFilter.resetResponseHeaders();</span>

				//if (update != 0)
<span class="fc" id="L200">				return true;</span>
			}

		}
<span class="nc" id="L204">		catch (Exception ex)</span>
		{
<span class="nc" id="L206">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">				if (psDelete != null)</span>
<span class="nc" id="L213">					psDelete.close();</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L215">					db_conn.close();</span>
			}
<span class="nc" id="L217">			catch (Exception ex2)</span>
			{
<span class="fc" id="L219">			}</span>
		}
<span class="nc" id="L221">		return false;</span>
	}

	/**
	 * Pokusi sa desifrovat hodnotu ktora je zasifrovana v konfiguracii
	 * @param value
	 * @return
	 */
	public static String tryDecrypt(String value)
	{
<span class="fc bfc" id="L231" title="All 6 branches covered.">		if (value!=null &amp;&amp; value.length()&gt;32 &amp;&amp; value.startsWith(&quot;encrypted:&quot;))</span>
		{
			try {
<span class="fc" id="L234">				Password pass = new Password();</span>
<span class="fc" id="L235">				String decoded = pass.decrypt(value.substring(&quot;encrypted:&quot;.length()));</span>
<span class="fc" id="L236">				value = decoded;</span>
			}
<span class="nc" id="L238">			catch (Exception ex)</span>
			{
<span class="nc" id="L240">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L241">			}</span>
		}
<span class="fc" id="L243">		return value;</span>
	}

	public static boolean setName(String nameParam, String value)
	{
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">		if (Tools.isEmpty(nameParam)) return false;</span>

		//do not save these values
<span class="fc" id="L251">		boolean saveToDb = true;</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">		if (isOnlyLocalConfig(nameParam)) saveToDb = false;</span>

<span class="fc" id="L254">		boolean ret = false;</span>
<span class="fc" id="L255">		Connection db_conn = null;</span>
<span class="fc" id="L256">		PreparedStatement psInsert = null;</span>
		try
		{
<span class="fc" id="L259">			String name = cleanTextRemoveNonPrintableCharacters(nameParam);</span>

			//vyvolaj event
<span class="fc" id="L262">			ConfDetails conf = null;</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">			if (value != null) {</span>
<span class="fc" id="L264">				 conf = new ConfDetails(name, value);</span>
			}
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">			if (conf != null) (new WebjetEvent&lt;ConfDetails&gt;(conf, WebjetEventType.ON_START)).publishEvent();</span>

<span class="pc bpc" id="L268" title="1 of 4 branches missed.">			if (value != null &amp;&amp; saveToDb)</span>
			{
				//nacitaj data z DB
<span class="fc" id="L271">				db_conn = DBPool.getConnection();</span>

<span class="fc" id="L273">				String sqlUpdate = &quot;UPDATE &quot; + ConfDB.CONF_TABLE_NAME + &quot; SET value=?, date_changed=? WHERE name=?&quot;;</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">				if (SetCharacterEncodingFilter.getCurrentRequestBean() != null &amp;&amp;</span>
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">					SetCharacterEncodingFilter.getCurrentRequestBean().getUserId() &gt; 0)</span>
				{
<span class="fc" id="L277">					StringBuilder message = new StringBuilder(&quot;Nastavena konfiguracna premenna: &quot;).append(name).append('\n');</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">					if (Tools.isNotEmpty(Constants.getString(name)))</span>
<span class="fc" id="L279">						message.append(Constants.getString(name)).append(&quot; =&gt; &quot;);</span>
<span class="fc" id="L280">					message.append(value);</span>
<span class="fc" id="L281">					Adminlog.add(Adminlog.TYPE_CONF_UPDATE, message.toString(), -1, -1);</span>
				}
<span class="fc" id="L283">				psInsert = db_conn.prepareStatement(sqlUpdate);</span>
<span class="fc" id="L284">				psInsert.setString(1, value);</span>
<span class="fc" id="L285">				psInsert.setTimestamp(2, new java.sql.Timestamp(Tools.getNow()));</span>
<span class="fc" id="L286">				psInsert.setString(3, name);</span>
<span class="fc" id="L287">				int update = psInsert.executeUpdate();</span>
<span class="fc" id="L288">				psInsert.close();</span>
<span class="fc" id="L289">				psInsert = null;</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">				if (update &lt; 1)</span>
				{
<span class="fc" id="L292">					String sqlIns = &quot;INSERT INTO &quot; + ConfDB.CONF_TABLE_NAME + &quot; (name, value, date_changed) VALUES (?,?,?)&quot;;</span>
<span class="fc" id="L293">					psInsert = db_conn.prepareStatement(sqlIns);</span>
<span class="fc" id="L294">					psInsert.setString(1, name);</span>
<span class="fc" id="L295">					psInsert.setString(2, value);</span>
<span class="fc" id="L296">					psInsert.setTimestamp(3, new java.sql.Timestamp(Tools.getNow()));</span>
<span class="fc" id="L297">					psInsert.execute();</span>
<span class="fc" id="L298">					psInsert.close();</span>
<span class="fc" id="L299">					psInsert = null;</span>
				}
<span class="fc" id="L301">				ret = true;</span>
				//refreshni hodnotu v Constants, odporucany je ale aj tak restart

<span class="fc" id="L304">				db_conn.close();</span>
<span class="fc" id="L305">				db_conn = null;</span>
			}
<span class="fc" id="L307">			setConstantValueImpl(name, value);</span>

<span class="pc bpc" id="L309" title="1 of 2 branches missed.">			if (conf != null) (new WebjetEvent&lt;ConfDetails&gt;(conf, WebjetEventType.AFTER_SAVE)).publishEvent();</span>
		}
<span class="nc" id="L311">		catch (Exception ex)</span>
		{
<span class="nc" id="L313">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">				if (psInsert != null)</span>
<span class="nc" id="L320">					psInsert.close();</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L322">					db_conn.close();</span>
			}
<span class="nc" id="L324">			catch (Exception ex2)</span>
			{
<span class="fc" id="L326">			}</span>
		}
<span class="fc" id="L328">		return ret;</span>
	}

	private static void setConstantValueImpl(String name, String valueParam)
	{
<span class="fc bfc" id="L333" title="All 2 branches covered.">		if (valueParam == null) return;</span>
<span class="fc" id="L334">		String value = tryDecrypt(valueParam);</span>

<span class="pc bpc" id="L336" title="1 of 2 branches missed.">		if (&quot;linkType&quot;.equals(name))</span>
		{
<span class="nc bnc" id="L338" title="All 2 branches missed.">			if (&quot;html&quot;.equalsIgnoreCase(value))</span>
			{
<span class="nc" id="L340">				Constants.setInt(name, Constants.LINK_TYPE_HTML);</span>
			}
			else
			{
<span class="nc" id="L344">				Constants.setInt(name, Constants.LINK_TYPE_DOCID);</span>
			}
		}
		else
		{
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">			if (&quot;statLanguageDomain&quot;.equals(name)) StatDB.setLanguageDomainTable(null);</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">			else if (name.startsWith(&quot;multiDomainAlias:&quot;)) MultiDomainFilter.clearDomainAlias();</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">			else if (&quot;logLevel&quot;.equals(name)) Logger.setWJLogLevel(value);</span>
<span class="fc bfc" id="L352" title="All 2 branches covered.">			else if (&quot;logLevels&quot;.equals(name)) Logger.setWJLogLevels(Logger.getLogLevelsMap(value));</span>
<span class="pc bpc" id="L353" title="2 of 4 branches missed.">			else if (&quot;cacheStaticContentSeconds&quot;.equals(name) || &quot;cacheStaticContentSuffixes&quot;.equals(name)) PathFilter.resetCacheStaticContentSeconds();</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">			else if (&quot;responseHeaders&quot;.equals(name)) PathFilter.resetResponseHeaders();</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">			else if (&quot;constantsAliasSearch&quot;.equals(name)) Constants.setConstantsAliasSearch(&quot;true&quot;.equals(value));</span>
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">			else if (&quot;multiDomainFolders&quot;.equals(name)) MultiDomainFilter.clearDomainFolders();</span>
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">			else if (&quot;xssHtmlAllowedFields&quot;.equals(name)) DB.resetHtmlAllowedFields();</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">			else if (&quot;ninjaNbspReplaceRegex&quot;.equals(name)) Ninja.resetNbspReplaceRegex();</span>
<span class="fc" id="L359">			Constants.setString(name, value);</span>
		}
<span class="fc" id="L361">	}</span>

	/**
	 * Zadisabluje polozku menu vsetkym administratorom
	 *
	 * @param menuItemName
	 * @return
	 */
	public static List&lt;UserDetails&gt; disableMenuItemAll(String menuItemName)
	{
<span class="nc" id="L371">		List&lt;UserDetails&gt; users = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L372">		List&lt;UserDetails&gt; changedUsers = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">		if(Tools.isEmpty(menuItemName)) return changedUsers;</span>
<span class="nc" id="L374">		Connection db_conn = null;</span>
<span class="nc" id="L375">		PreparedStatement ps = null;</span>
<span class="nc" id="L376">		ResultSet rs = null;</span>
		try
		{
			//nacitaj data z DB
<span class="nc" id="L380">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L382">			ps = db_conn.prepareStatement(&quot;SELECT * FROM  users WHERE is_admin=?&quot;); //NOSONAR</span>
<span class="nc" id="L383">			ps.setBoolean(1, true);</span>
<span class="nc" id="L384">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L387">				UserDetails user = new UserDetails();</span>
<span class="nc" id="L388">				user.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L389">				user.setFirstName(DB.getDbString(rs, &quot;first_name&quot;));</span>
<span class="nc" id="L390">				user.setLastName(DB.getDbString(rs, &quot;last_name&quot;));</span>
<span class="nc" id="L391">				users.add(user);</span>
<span class="nc" id="L392">			}</span>
<span class="nc" id="L393">			rs.close();</span>
<span class="nc" id="L394">			ps.close();</span>
<span class="nc" id="L395">			rs = null;</span>
<span class="nc" id="L396">			ps = null;</span>
			//preiteruj cez userov a zrus im danu polozku
			boolean found;
<span class="nc bnc" id="L399" title="All 2 branches missed.">			for (UserDetails user : users)</span>
			{
<span class="nc" id="L401">				ps = db_conn.prepareStatement(&quot;SELECT * FROM user_disabled_items WHERE user_id=? AND item_name=?&quot;); //NOSONAR</span>
<span class="nc" id="L402">				ps.setInt(1, user.getUserId());</span>
<span class="nc" id="L403">				ps.setString(2, menuItemName); //NOSONAR</span>
<span class="nc" id="L404">				rs = ps.executeQuery();</span>
<span class="nc" id="L405">				found = false;</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">				if (rs.next())</span>
				{
<span class="nc" id="L408">					found = true;</span>
				}
<span class="nc" id="L410">				rs.close();</span>
<span class="nc" id="L411">				ps.close();</span>
<span class="nc" id="L412">				rs = null;</span>
<span class="nc" id="L413">				ps = null;</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">				if (!found)</span>
				{
<span class="nc" id="L416">					ps = db_conn.prepareStatement(&quot;INSERT INTO user_disabled_items (user_id, item_name) VALUES (?, ?)&quot;); //NOSONAR</span>
<span class="nc" id="L417">					ps.setInt(1, user.getUserId());</span>
<span class="nc" id="L418">					ps.setString(2, menuItemName); //NOSONAR</span>
<span class="nc" id="L419">					ps.execute();</span>
<span class="nc" id="L420">					ps.close();</span>
<span class="nc" id="L421">					ps = null;</span>
<span class="nc" id="L422">					changedUsers.add(user);</span>
				}
<span class="nc" id="L424">			}</span>
<span class="nc" id="L425">			db_conn.close();</span>
<span class="nc" id="L426">			db_conn = null;</span>
		}
<span class="nc" id="L428">		catch (Exception ex)</span>
		{
<span class="nc" id="L430">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L436" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L437">					rs.close();</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L439">					ps.close();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L441">					db_conn.close();</span>
			}
<span class="nc" id="L443">			catch (Exception ex2)</span>
			{
<span class="nc" id="L445">			}</span>
		}
<span class="nc" id="L447">		return (changedUsers);</span>
	}

	/**
	 * Ziskam si premennu z DB
	 *
	 * @param name -
	 *           nazov premennej
	 * @return
	 */
	public static ConfDetails getVariable(String name)
	{
<span class="fc" id="L459">		Connection db_conn = null;</span>
<span class="fc" id="L460">		PreparedStatement ps = null;</span>
<span class="fc" id="L461">		ResultSet rs = null;</span>
		try
		{
<span class="pc bpc" id="L464" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(name))</span>
			{
				//nacitaj data z DB (uncomited je tu kvoli clustru a MonitoringManager citaniu session hodnot)
<span class="fc" id="L467">				db_conn = DBPool.getConnectionReadUncommited();</span>
<span class="fc" id="L468">				ps = db_conn.prepareStatement(&quot;SELECT * FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; WHERE name=?&quot;);</span>
<span class="fc" id="L469">				ps.setString(1, name);</span>
<span class="fc" id="L470">				rs = ps.executeQuery();</span>
				String value;
<span class="fc" id="L472">				ConfDetails cDet = null;</span>
<span class="fc bfc" id="L473" title="All 2 branches covered.">				if (rs.next())</span>
				{
<span class="fc" id="L475">					value = DB.getDbString(rs, &quot;value&quot;);</span>
<span class="fc" id="L476">					cDet = new ConfDetails(name, value, DB.getDate(rs, &quot;date_changed&quot;));</span>
				}
<span class="fc" id="L478">				rs.close();</span>
<span class="fc" id="L479">				ps.close();</span>
<span class="fc" id="L480">				db_conn.close();</span>
<span class="fc" id="L481">				rs = null;</span>
<span class="fc" id="L482">				ps = null;</span>
<span class="fc" id="L483">				db_conn = null;</span>
<span class="fc" id="L484">				return (cDet);</span>
				//  Logger.println(this,&quot;Name= &quot; +varName+ &quot;\t\t Value= &quot; +varValue+
				// &quot;\t\t Action= &quot; +varAction);
			}
		}
<span class="nc" id="L489">		catch (Exception ex)</span>
		{
<span class="nc" id="L491">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L498">					rs.close();</span>
<span class="pc bpc" id="L499" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L500">					ps.close();</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L502">					db_conn.close();</span>
			}
<span class="nc" id="L504">			catch (Exception ex2)</span>
			{
<span class="fc" id="L506">			}</span>
		}
<span class="nc" id="L508">		return (null);</span>
	}

	/**
	 * Vrati zoznam moznych konfiguracnych premennych pre zadanu JSP stranku (pouziva pomocnik)
	 * @param url
	 * @return
	 */
	public static List&lt;ConfDetails&gt; getConfForJsp(String url)
	{
<span class="nc" id="L518">		List&lt;ConfDetails&gt; list = new ArrayList&lt;&gt;();</span>
		try
		{
			//najskor uprav URL na nazov modulu
<span class="nc" id="L522">			int i = url.lastIndexOf('/');</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">			if (i != -1) url = url.substring(i+1);</span>

<span class="nc" id="L525">			i = url.lastIndexOf('.');</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">			if (i != -1) url = url.substring(0, i);</span>

<span class="nc bnc" id="L528" title="All 2 branches missed.">			if (&quot;banner_system&quot;.equals(url)) url = &quot;banner&quot;;</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">			else if (&quot;forms&quot;.equals(url)) url = &quot;form&quot;;</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">			else if (&quot;related_pages&quot;.equals(url)) url = &quot;related-pages&quot;;</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">			else if (&quot;dynamic_tags&quot;.equals(url)) url = &quot;webpages&quot;;</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">			else if (&quot;reservations&quot;.equals(url)) url = &quot;reservation&quot;;</span>

<span class="nc" id="L534">			Logger.debug(ConfDB.class, &quot;getConfForJsp url = &quot;+url);</span>

<span class="nc bnc" id="L536" title="All 2 branches missed.">			for (ConfDetails conf : Constants.getAllValues())</span>
			{
<span class="nc bnc" id="L538" title="All 6 branches missed.">				if (conf.getModules()!=null &amp;&amp; (conf.getModules().indexOf(url)==0 || conf.getModules().indexOf(&quot;;&quot;+url)!=-1)) list.add(conf);</span>
<span class="nc" id="L539">			}</span>
		}
<span class="nc" id="L541">		catch (Exception e)</span>
		{
<span class="nc" id="L543">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L544">		}</span>
<span class="nc" id="L545">		return list;</span>
	}

	/**
	 * Vyhladavanie v konfiguracii (meno a popis)
	 * @param text
	 * @return
	 */
	public static List&lt;ConfDetails&gt; searchConfig(String text)
	{
<span class="nc" id="L555">		text = DB.internationalToEnglish(text).toLowerCase();</span>
<span class="nc" id="L556">		List&lt;ConfDetails&gt; list = new ArrayList&lt;&gt;();</span>
		try
		{
<span class="nc bnc" id="L559" title="All 2 branches missed.">			for (ConfDetails conf : Constants.getAllValues())</span>
			{
<span class="nc bnc" id="L561" title="All 4 branches missed.">				if (conf.getName().toLowerCase().indexOf(text)!=-1 || DB.internationalToEnglish(conf.getDescription()).toLowerCase().indexOf(text)!=-1)</span>
				{
<span class="nc" id="L563">					list.add(conf);</span>
				}
<span class="nc" id="L565">			}</span>
		}
<span class="nc" id="L567">		catch (Exception e)</span>
		{
<span class="nc" id="L569">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L570">		}</span>
<span class="nc" id="L571">		return list;</span>
	}

    /**
     * Obnovi v Constants konfiguracnu premmenu podla hodnoty v databaze
     * @param name
     */
    public static void refreshVariable(String name)
	 {
<span class="fc" id="L580">	 	 String value = new SimpleQuery().forString(&quot;SELECT value FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; WHERE name=?&quot;,name);</span>
<span class="fc bfc" id="L581" title="All 2 branches covered.">		 if (value == null) {</span>
<span class="fc" id="L582">			int count = new SimpleQuery().forInt(&quot;SELECT COUNT(*) FROM &quot; + ConfDB.CONF_TABLE_NAME + &quot; WHERE name=?&quot;,name);</span>
<span class="pc bpc" id="L583" title="1 of 2 branches missed.">			if (count &gt; 0) {</span>
				//ak je v DB ale hodnota je null tak ju nastavime na prazdny retazec
<span class="nc" id="L585">				value = &quot;&quot;;</span>
			}
		 }
<span class="fc" id="L588">		 setConstantValueImpl(name, value);</span>
<span class="fc" id="L589">    }</span>

	private static String cleanTextRemoveNonPrintableCharacters(String text)
	{
		// strips off all non-ASCII characters
<span class="fc" id="L594">		text = text.replaceAll(&quot;[^\\x00-\\x7F]&quot;, &quot;&quot;);</span>

		// erases all the ASCII control characters
<span class="fc" id="L597">		text = text.replaceAll(&quot;[\\p{Cntrl}&amp;&amp;[^\r\n\t]]&quot;, &quot;&quot;);</span>

		// removes non-printable characters from Unicode
<span class="fc" id="L600">		text = text.replaceAll(&quot;\\p{C}&quot;, &quot; &quot;);</span>

<span class="fc" id="L602">		text = Tools.replace(text, &quot;'&quot;, &quot;&quot;);</span>
<span class="fc" id="L603">		text = Tools.replace(text, &quot; &quot;, &quot;&quot;);</span>

<span class="fc" id="L605">		return text.trim();</span>
	}

    public static boolean setNamePrepared(String name, String value, Date datePrepared)
 	{
<span class="fc bfc" id="L610" title="All 2 branches covered.">		if (isOnlyLocalConfig(name)) return true;</span>

<span class="fc" id="L612">		boolean ret = false;</span>
<span class="fc" id="L613"> 		Connection db_conn = null;</span>
<span class="fc" id="L614"> 		PreparedStatement psInsert = null;</span>
 		try
 		{
 			//nacitaj data z DB
<span class="fc" id="L618"> 			db_conn = DBPool.getConnection();</span>
 			//editacia DB _conf_
<span class="pc bpc" id="L620" title="2 of 4 branches missed."> 			if (name != null &amp;&amp; value != null)</span>
 			{
 				/*String sqlUpdate = &quot;UPDATE &quot; + ConfDB.CONF_PREPARED_TABLE_NAME + &quot; SET value=?, date_changed=?, date_prepared=? WHERE name=?&quot;;
 				if (SetCharacterEncodingFilter.getCurrentRequestBean() != null &amp;&amp;
 					SetCharacterEncodingFilter.getCurrentRequestBean().getUserId() &gt; 0)
 				{
 					StringBuilder message = new StringBuilder(&quot;Nastavena konfiguracna premenna: &quot;).append(name).append('\n');
 					if (Tools.isNotEmpty(Constants.getString(name)))
 						message.append(Constants.getString(name)).append(&quot; =&gt; &quot;);
 					message.append(value);
 					//Adminlog.add(Adminlog.TYPE_CONF_UPDATE, message.toString(), -1, -1);
 				}
 				psInsert = db_conn.prepareStatement(sqlUpdate);
 				psInsert.setString(1, value);
 				psInsert.setTimestamp(2, new java.sql.Timestamp(Tools.getNow()));

 				if (datePrepared!=null) psInsert.setTimestamp(4, new java.sql.Timestamp(datePrepared.getTime()));
				else psInsert.setNull(4, Types.TIMESTAMP);

				psInsert.setString(3, name);

 				int update = psInsert.executeUpdate();
 				psInsert.close();
 				psInsert = null;

 				*/
<span class="fc" id="L646">				Integer userId = null;</span>

<span class="fc" id="L648">				RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">				if (rb != null) userId = Integer.valueOf(rb.getUserId());</span>

<span class="fc" id="L651">				String sqlIns = &quot;INSERT INTO &quot; + ConfDB.CONF_PREPARED_TABLE_NAME + &quot; (name, value, date_changed, date_prepared, user_id) VALUES (?,?,?,?,?)&quot;;</span>
<span class="fc" id="L652">				psInsert = db_conn.prepareStatement(sqlIns);</span>
<span class="fc" id="L653">				psInsert.setString(1, name);</span>
<span class="fc" id="L654">				psInsert.setString(2, value);</span>
<span class="fc" id="L655">				psInsert.setTimestamp(3, new java.sql.Timestamp(Tools.getNow()));</span>

<span class="pc bpc" id="L657" title="1 of 2 branches missed.">				if (datePrepared!=null) psInsert.setTimestamp(4, new java.sql.Timestamp(datePrepared.getTime()));</span>
<span class="fc" id="L658">				else psInsert.setNull(4, Types.TIMESTAMP);</span>

<span class="pc bpc" id="L660" title="1 of 2 branches missed.">				if (userId != null) psInsert.setInt(5, userId.intValue());</span>
<span class="nc" id="L661">				else psInsert.setNull(5, Types.INTEGER);</span>

<span class="fc" id="L663">				psInsert.execute();</span>
<span class="fc" id="L664">				psInsert.close();</span>
<span class="fc" id="L665">				psInsert = null;</span>
<span class="fc" id="L666"> 				ret = true;</span>
 			}
<span class="fc" id="L668"> 			db_conn.close();</span>
<span class="fc" id="L669"> 			db_conn = null;</span>
 		}
<span class="nc" id="L671"> 		catch (Exception ex)</span>
 		{
<span class="nc" id="L673"> 			sk.iway.iwcm.Logger.error(ex);</span>
 		}
 		finally
 		{
 			try
 			{
<span class="pc bpc" id="L679" title="1 of 2 branches missed."> 				if (psInsert != null)</span>
<span class="nc" id="L680"> 					psInsert.close();</span>
<span class="pc bpc" id="L681" title="1 of 2 branches missed."> 				if (db_conn != null)</span>
<span class="nc" id="L682"> 					db_conn.close();</span>
 			}
<span class="nc" id="L684"> 			catch (Exception ex2)</span>
 			{
<span class="fc" id="L686"> 			}</span>
 		}
<span class="fc" id="L688"> 		return ret;</span>
 	}

 	public static boolean deleteNamePrepared(String name, long now)
 	{
<span class="nc" id="L693"> 		Connection db_conn = null;</span>
<span class="nc" id="L694"> 		PreparedStatement psDelete = null;</span>
 		try
 		{
<span class="nc" id="L697"> 			String sqlDel = &quot;&quot;;</span>
<span class="nc bnc" id="L698" title="All 2 branches missed."> 			if (name != null)</span>
 			{
<span class="nc" id="L700"> 				db_conn = DBPool.getConnection();</span>
<span class="nc" id="L701"> 				sqlDel = &quot;UPDATE &quot; + ConfDB.CONF_PREPARED_TABLE_NAME + &quot; SET date_published=? WHERE name=? AND date_published IS NULL AND date_prepared IS NOT NULL AND date_prepared &lt; ?&quot;;</span>
<span class="nc" id="L702"> 				psDelete = db_conn.prepareStatement(sqlDel);</span>
<span class="nc" id="L703">				psDelete.setTimestamp(1, new Timestamp(Tools.getNow()));</span>
<span class="nc" id="L704"> 				psDelete.setString(2, name);</span>
<span class="nc" id="L705">				psDelete.setTimestamp(3, new Timestamp(now));</span>
<span class="nc" id="L706"> 				psDelete.execute();</span>
<span class="nc" id="L707"> 				psDelete.close();</span>
<span class="nc" id="L708"> 				db_conn.close();</span>
<span class="nc" id="L709"> 				psDelete = null;</span>
<span class="nc" id="L710"> 				db_conn = null;</span>
 				//Adminlog.add(Adminlog.TYPE_CONF_DELETE, &quot;Zmazana prepared konfiguracna premenna: &quot;+name, -1, -1);
<span class="nc" id="L712"> 				return true;</span>
 			}
 		}
<span class="nc" id="L715"> 		catch (Exception ex)</span>
 		{
<span class="nc" id="L717"> 			sk.iway.iwcm.Logger.error(ex);</span>
 		}
 		finally
 		{
 			try
 			{
<span class="nc bnc" id="L723" title="All 2 branches missed."> 				if (psDelete != null)</span>
<span class="nc" id="L724"> 					psDelete.close();</span>
<span class="nc bnc" id="L725" title="All 2 branches missed."> 				if (db_conn != null)</span>
<span class="nc" id="L726"> 					db_conn.close();</span>
 			}
<span class="nc" id="L728"> 			catch (Exception ex2)</span>
 			{
<span class="nc" id="L730"> 			}</span>
 		}
<span class="nc" id="L732"> 		return false;</span>
 	}

	/**
	 * Vrati predpripravenu konfiguracne hodnotu, ak prefix nie je null tak zacinajuce sa na hodnotu prefixu
	 * @param prefix
	 * @return
	 */
	public static List&lt;ConfPreparedDetails&gt; getConfigPrepared(String prefix)
	{
<span class="nc" id="L742">		List&lt;ConfPreparedDetails&gt; conf = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L743">		Connection db_conn = null;</span>
<span class="nc" id="L744">		PreparedStatement ps = null;</span>
<span class="nc" id="L745">		ResultSet rs = null;</span>
		try
		{
			//nacitaj data z DB
<span class="nc" id="L749">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L750">			ps = db_conn.prepareStatement(&quot;SELECT * FROM &quot; + ConfDB.CONF_PREPARED_TABLE_NAME + &quot; ORDER BY name&quot;);</span>
<span class="nc" id="L751">			rs = ps.executeQuery();</span>
			String value;
			String name;
<span class="nc bnc" id="L754" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L756">				name = DB.getDbString(rs, &quot;name&quot;);</span>
<span class="nc" id="L757">				value = DB.getDbString(rs, &quot;value&quot;);</span>

<span class="nc bnc" id="L759" title="All 4 branches missed.">				if (Tools.isEmpty(prefix) || name.startsWith(prefix))</span>
				{
<span class="nc" id="L761">					conf.add(new ConfPreparedDetails(name, value, DB.getDate(rs, &quot;date_changed&quot;), DB.getDate(rs, &quot;date_prepared&quot;)));</span>
				}
			}
<span class="nc" id="L764">			rs.close();</span>
<span class="nc" id="L765">			ps.close();</span>
<span class="nc" id="L766">			db_conn.close();</span>
<span class="nc" id="L767">			rs = null;</span>
<span class="nc" id="L768">			ps = null;</span>
<span class="nc" id="L769">			db_conn = null;</span>
<span class="nc bnc" id="L770" title="All 2 branches missed.">			if (conf.size() &gt; 0)</span>
<span class="nc" id="L771">				return (conf);</span>
			//  Logger.println(this,&quot;Name= &quot; +varName+ &quot;\t\t Value= &quot; +varValue+
			// &quot;\t\t Action= &quot; +varAction);
		}
<span class="nc" id="L775">		catch (Exception ex)</span>
		{
<span class="nc" id="L777">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L783" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L784">					rs.close();</span>
<span class="nc bnc" id="L785" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L786">					ps.close();</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L788">					db_conn.close();</span>
			}
<span class="nc" id="L790">			catch (Exception ex2)</span>
			{
<span class="nc" id="L792">			}</span>
		}
<span class="nc" id="L794">		return (null);</span>
	}

	/**
	 * Check if name is localOnly - not saved to DB and synchronized across cluster
	 * @param name - conf. name
	 * @return
	 */
	public static boolean isOnlyLocalConfig(String name)
	{
<span class="fc bfc" id="L804" title="All 2 branches covered.">		if (&quot;licenseExpiryDate&quot;.equals(name)) return true;</span>
<span class="fc" id="L805">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>