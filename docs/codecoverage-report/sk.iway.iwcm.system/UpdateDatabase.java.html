<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UpdateDatabase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.system</a> &gt; <span class="el_source">UpdateDatabase.java</span></div><h1>UpdateDatabase.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.system;

import java.beans.XMLDecoder;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.List;
import java.util.Map;
import java.util.Scanner;
import java.util.Set;
import java.util.StringTokenizer;

import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.FileTools;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PkeyGenerator;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DebugTimer;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.editor.service.WebpagesService;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmInputStream;
import sk.iway.iwcm.stat.StatNewDB;
import sk.iway.iwcm.stripes.SyncDirAction;
import sk.iway.iwcm.sync.WarningListener;
import sk.iway.iwcm.system.cluster.ClusterDB;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UsersDB;


/**
 *  Aktualizuje databazu
 *
 *@Title        WebJET
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: 1.4 $
 *@created      Nedele, 2004, marec 7
 *@modified     $Date: 2004/03/14 20:23:31 $
 */
public class UpdateDatabase
{
<span class="nc" id="L64">	protected UpdateDatabase() {</span>
		//utility class
<span class="nc" id="L66">	}</span>

	/**
	 *  Description of the Method
	 */
	public static void update()
	{
<span class="fc" id="L73">		Logger.println(UpdateDatabase.class,&quot;----- Updating database [DBType=&quot;+Constants.DB_TYPE+&quot;] -----&quot;);</span>
		//aktualizuj databazu
<span class="fc" id="L75">		autoUpdateDatabase();</span>

		//aktualizuj zlozitejsie veci
<span class="fc" id="L78">		splitFullName();</span>
<span class="fc" id="L79">		disabledItems();</span>
<span class="fc" id="L80">		prepareSync();</span>
<span class="fc" id="L81">		setRegDate();</span>
<span class="fc" id="L82">		importMeniny();</span>
<span class="fc" id="L83">		convertPerexGroups();</span>
<span class="fc" id="L84">		fixGroupIdInStatViews();</span>
<span class="fc" id="L85">		mediaGroupsUpdate();</span>

<span class="fc" id="L87">		updateMediaDomainIdColumn();</span>
<span class="fc" id="L88">		updateEmailsCampainDomainIdColumn();</span>

<span class="fc" id="L90">		deletePoiClasses();</span>

		// upravi uz existujuce browserId, aby sa nepocitali do statistiky kvoli novym upravam v kode
<span class="fc" id="L93">		UpdateDatabase.fixBrowserId();</span>

<span class="fc" id="L95">		disabledItemsConfigRights();</span>

<span class="fc" id="L97">		updateStatViewsColumns();</span>

<span class="fc" id="L99">		updateStopwords();</span>

<span class="fc" id="L101">		zmluvyOrganizacieUpdate();</span>
		//zatial nie, ponechame do WJ8 updateArchiveFormat();

<span class="fc" id="L104">        setDefaultMapProvider();</span>

<span class="fc" id="L106">		statErrorAddDomainId();</span>

<span class="fc" id="L108">		Logger.println(UpdateDatabase.class,&quot;----- Database updated  -----&quot;);</span>
<span class="fc" id="L109">	}</span>

	/*
	private static void updateArchiveFormat(){
		Connection db_conn = null;
		PreparedStatement ps = null;

		db_conn = DBPool.getConnection();

		try
		{
			String sql = &quot;INSERT INTO forms_archive SELECT f.* FROM forms f WHERE form_name like 'Archiv-%'&quot;;
			ps = db_conn.prepareStatement(sql);
			ps.execute();
			ps.close();

			sql = &quot;DELETE FROM forms f WHERE form_name like 'Archiv-%'&quot;;
			ps = db_conn.prepareStatement(sql);
			ps.execute();
			ps.close();

			sql =  &quot;UPDATE forms_archive SET form_name = SUBSTRING(form_name, 8) WHERE form_name like 'Archiv-%'&quot;;
			ps = db_conn.prepareStatement(sql);
			ps.execute();

		}
		catch (SQLException e)
		{
			sk.iway.iwcm.Logger.error(e);
		}
		finally
		{
			if(ps != null)
			{
				try
				{
					ps.close();
				}
				catch (SQLException e)
				{
					sk.iway.iwcm.Logger.error(e);
				}
			}
		}

	}*/

	/**
	 * Skontroluje ci je pocet stopslov v db rovnaky ako v subore a ak nie je, spravi update
	 */
	private static void updateStopwords()
	{

<span class="fc" id="L162">		int databaseCount = new SimpleQuery().forInt(&quot;select count(*) from stopword&quot;);</span>
<span class="fc" id="L163">		int fileCount = 0;</span>

<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		if (FileTools.isFile(&quot;/WEB-INF/sql/stopwords.csv&quot;)==false) return;</span>

		Scanner scanner;
		try
		{
<span class="fc" id="L170">			scanner = new Scanner(new File(Tools.getRealPath(&quot;/WEB-INF/sql/stopwords.csv&quot;)),&quot;UTF-8&quot;);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">			while (scanner.hasNextLine())</span>
			{
<span class="fc" id="L173">				fileCount++;</span>
<span class="fc" id="L174">				scanner.nextLine();</span>
			}
		}
<span class="nc" id="L177">		catch (FileNotFoundException e)</span>
		{
<span class="nc" id="L179">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L180">			return;</span>
<span class="fc" id="L181">		}</span>

		/*check count*/

<span class="pc bpc" id="L185" title="1 of 2 branches missed.">		if (databaseCount != fileCount)</span>
		{
<span class="nc" id="L187">			Connection db_conn = null;</span>
<span class="nc" id="L188">			PreparedStatement ps = null;</span>
			try
			{
<span class="nc" id="L191">				db_conn = DBPool.getConnection();</span>


<span class="nc" id="L194">				ps = db_conn.prepareStatement(&quot;delete from stopword&quot;);</span>
<span class="nc" id="L195">				ps.executeUpdate();</span>
<span class="nc" id="L196">				ps.close();</span>

<span class="nc" id="L198">				ps = db_conn.prepareStatement(&quot;insert into stopword (word,language) values (?,?)&quot;);</span>
<span class="nc" id="L199">				scanner.close();</span>
<span class="nc" id="L200">				scanner = new Scanner(new File(Tools.getRealPath(&quot;/WEB-INF/sql/stopwords.csv&quot;)),&quot;UTF-8&quot;);</span>

<span class="nc bnc" id="L202" title="All 2 branches missed.">				while (scanner.hasNext())</span>
				{
<span class="nc" id="L204">					String line = scanner.nextLine();</span>
<span class="nc" id="L205">					String[] split = line.split(&quot;;&quot;);</span>
<span class="nc" id="L206">					String stopword = split[0].trim();</span>
<span class="nc" id="L207">					String language = split[1].trim();</span>
<span class="nc" id="L208">					ps.setString(1, stopword);</span>
<span class="nc" id="L209">					ps.setString(2, language);</span>
<span class="nc" id="L210">					ps.executeUpdate();</span>
<span class="nc" id="L211">				}</span>
<span class="nc" id="L212">				ps.close();</span>
<span class="nc" id="L213">				db_conn.close();</span>
<span class="nc" id="L214">				ps = null;</span>
<span class="nc" id="L215">				db_conn = null;</span>
			}
<span class="nc" id="L217">			catch (Exception ex)</span>
			{
<span class="nc" id="L219">				sk.iway.iwcm.Logger.error(ex);</span>
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L225" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L226">						ps.close();</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L228">						db_conn.close();</span>
				}
<span class="nc" id="L230">				catch (Exception ex2)</span>
				{
<span class="nc" id="L232">				}</span>
			}
		}
<span class="fc" id="L235">	}</span>

	public static void updateAfterInit()
	{
<span class="fc" id="L239">		configureModules();</span>
<span class="fc" id="L240">	}</span>

	/**
	 * Automaticka aktualizacia databazy na zaklade XML suboru
	 */
	@SuppressWarnings(&quot;resource&quot;)
	private static void autoUpdateDatabase(IwcmFile f, String dbName) throws IOException
	{
<span class="fc" id="L248">		Logger.println(UpdateDatabase.class,&quot;--&gt; updating from file: &quot; + f.getName());</span>
<span class="fc" id="L249">		InputStream is = new IwcmInputStream(f);</span>
<span class="fc" id="L250">		is = SyncDirAction.checkXmlForAttack(is);</span>
<span class="fc" id="L251">		XMLDecoder decoder = new XMLDecoder(is, null, new WarningListener());</span>
<span class="fc" id="L252">		Object objUpdates = decoder.readObject();</span>

<span class="pc bpc" id="L254" title="1 of 2 branches missed.">		if (!(objUpdates instanceof List)) return;</span>

<span class="fc" id="L256">		List&lt;?&gt; updates = (List&lt;?&gt;)objUpdates;</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">		for (Object objUdb : updates)</span>
		{

<span class="pc bpc" id="L260" title="1 of 2 branches missed.">			if (!(objUdb instanceof UpdateDBBean)) continue;</span>

<span class="fc" id="L262">			UpdateDBBean udb = (UpdateDBBean)objUdb;</span>
<span class="fc" id="L263">			updateDB(udb, dbName);</span>
<span class="fc" id="L264">		}</span>
<span class="fc" id="L265">		is.close();</span>
<span class="fc" id="L266">	}</span>

	/**
	 * Automaticka aktualizacia databazy na zaklade XML suboru
	 */
	private static void autoUpdateDatabase()
	{
		try
		{
<span class="fc" id="L275">			IwcmFile f = new IwcmFile(Tools.getRealPath(&quot;/WEB-INF/sql/autoupdate.xml&quot;));</span>
<span class="fc" id="L276">			autoUpdateDatabase(f, &quot;iwcm&quot;);</span>

<span class="fc" id="L278">			f = new IwcmFile(Tools.getRealPath(&quot;/WEB-INF/sql/autoupdate-&quot;+Constants.getInstallName()+&quot;.xml&quot;));</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">			if (f.exists())</span>
			{
<span class="nc" id="L281">				autoUpdateDatabase(f, &quot;iwcm&quot;);</span>
			}

			//update pre webjet9 a dalsie podla skinu
<span class="fc" id="L285">			f = new IwcmFile(Tools.getRealPath(&quot;/WEB-INF/sql/autoupdate-&quot;+Constants.getString(&quot;defaultSkin&quot;)+&quot;.xml&quot;));</span>
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">			if (f.exists())</span>
			{
<span class="fc" id="L288">				autoUpdateDatabase(f, &quot;iwcm&quot;);</span>
			}

<span class="fc" id="L291">			IwcmFile dir = new IwcmFile(Tools.getRealPath(&quot;/WEB-INF/sql&quot;));</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">			if (dir.isDirectory())</span>
			{
<span class="fc" id="L294">				IwcmFile[] files = dir.listFiles();</span>
<span class="fc" id="L295">				int size = files.length;</span>
				int i;
<span class="fc bfc" id="L297" title="All 2 branches covered.">				for (i=0; i&lt;size; i++)</span>
				{
<span class="fc" id="L299">					f = files[i];</span>
<span class="pc bpc" id="L300" title="2 of 4 branches missed.">					if (f.isFile() &amp;&amp; f.getName().startsWith(&quot;autoupdate-&quot;+Constants.getInstallName()))</span>
					{
<span class="nc" id="L302">						int start = (&quot;autoupdate-&quot;+Constants.getInstallName()).length() + 1;</span>
<span class="nc" id="L303">						int end = f.getName().length() - 4;</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">						if (start&gt;end)</span>
<span class="nc" id="L305">							continue;</span>

<span class="nc" id="L307">						String dbName = f.getName().substring(start, end).trim();</span>

<span class="nc" id="L309">						Logger.println(UpdateDatabase.class,&quot;--&gt; updating from file: &quot; + f.getName() + &quot; database: &quot; + dbName);</span>
<span class="nc" id="L310">						autoUpdateDatabase(f, dbName);</span>
					}
				}
			}
		}
<span class="nc" id="L315">		catch (Exception e)</span>
		{
<span class="nc" id="L317">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L318">		}</span>
<span class="fc" id="L319">	}</span>

<span class="fc" id="L321">	private static Set&lt;String&gt; allreadyExecutedUpdates = null;</span>
	private static boolean isAllreadyUpdated(String note)
	{
<span class="fc bfc" id="L324" title="All 2 branches covered.">		if (allreadyExecutedUpdates==null)</span>
		{
<span class="fc" id="L326">			List&lt;String&gt; notes = new SimpleQuery().forListString(&quot;SELECT note FROM &quot;+ConfDB.DB_TABLE_NAME);</span>
<span class="fc" id="L327">			allreadyExecutedUpdates = new HashSet&lt;&gt;(notes);</span>
		}

<span class="fc bfc" id="L330" title="All 2 branches covered.">		if (allreadyExecutedUpdates.contains(note)) return true;</span>

<span class="fc" id="L332">		return false;</span>
	}

	private static void saveSuccessUpdate(String note)
	{
<span class="nc" id="L337">		String sqlUpdate = &quot;INSERT INTO &quot;+ConfDB.DB_TABLE_NAME+&quot; (create_date, note) VALUES (?, ?)&quot;;</span>
<span class="nc" id="L338">		new SimpleQuery().execute(sqlUpdate, new Timestamp(Tools.getNow()), note);</span>

<span class="nc bnc" id="L340" title="All 2 branches missed.">		if (allreadyExecutedUpdates != null) allreadyExecutedUpdates.add(note);</span>
<span class="nc" id="L341">	}</span>

	/**
	 * Skontroluje, ci treba aktualizovat DB, ak ano, aktuzlizuje
	 * @param udb - Bean s popisom aktualizacie
	 * @return
	 */
	private static boolean updateDB(UpdateDBBean udb, String dbName)
	{
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">		if (isAllreadyUpdated(udb.getNote())) return true;</span>

<span class="nc" id="L352">		boolean ret = false;</span>

<span class="nc" id="L354">		Connection db_conn = null;</span>
<span class="nc" id="L355">		PreparedStatement ps = null;</span>
<span class="nc" id="L356">		Statement sta = null;</span>
<span class="nc" id="L357">		ResultSet rs = null;</span>
<span class="nc" id="L358">		String sql = null;</span>
		try
		{
<span class="nc" id="L361">			db_conn = DBPool.getConnection(dbName);</span>

			boolean updateSuccess;
<span class="nc" id="L364">			Logger.println(UpdateDatabase.class,&quot;   &quot; + udb.getNote()+&quot; &quot;);</span>
			//aktualizuj DB
<span class="nc bnc" id="L366" title="All 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MYSQL)</span>
			{
<span class="nc" id="L368">				sql = udb.getMysql();</span>
			}
<span class="nc bnc" id="L370" title="All 2 branches missed.">			else if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
			{
<span class="nc" id="L372">				sql = udb.getMssql();</span>
			}
<span class="nc bnc" id="L374" title="All 2 branches missed.">			else if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
			{
<span class="nc" id="L376">				sql = udb.getOracle();</span>
			}
<span class="nc bnc" id="L378" title="All 2 branches missed.">			else if (Constants.DB_TYPE == Constants.DB_PGSQL)</span>
			{
<span class="nc" id="L380">				sql = udb.getPgsql();</span>
			}

<span class="nc" id="L383">			updateSuccess = true;</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">			if (Tools.isNotEmpty(sql))</span>
			{
<span class="nc" id="L386">				StringTokenizer st = new StringTokenizer(sql, &quot;;&quot;);</span>
<span class="nc" id="L387">				int counter = 1;</span>
<span class="nc" id="L388">				int count = st.countTokens();</span>
<span class="nc" id="L389">				Logger.println(UpdateDatabase.class, &quot;count=&quot;+count+&quot; &quot;);</span>
<span class="nc" id="L390">				String defaultEngine = Constants.getString(&quot;mariaDbDefaultEngine&quot;);</span>
<span class="nc bnc" id="L391" title="All 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
					try
					{

<span class="nc" id="L396">						sql = st.nextToken().trim();</span>

						//na public nodoch nevykonavam GRANT prikazy
<span class="nc bnc" id="L399" title="All 4 branches missed.">						if (sql.indexOf(&quot;GRANT&quot;)!=-1 &amp;&amp; &quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;))) continue;</span>

<span class="nc bnc" id="L401" title="All 2 branches missed.">						if (sql.contains(&quot;{CONSTRAIN:&quot;)) {</span>
							//MSSQL nema drop constrain podla mena ale musi sa najskor ziskat z DB presny nazov, az potom sa da spravit drop
							try {
<span class="nc" id="L404">								String tableName = sql.substring(sql.indexOf(&quot;ALTER TABLE&quot;)+11, sql.indexOf(&quot;DROP CONSTRAINT&quot;)).trim();</span>
<span class="nc" id="L405">								int i = sql.indexOf(&quot;{CONSTRAIN:&quot;);</span>
<span class="nc" id="L406">								String constrainName = sql.substring(sql.indexOf(&quot;:&quot;, i)+1, sql.indexOf(&quot;}&quot;, i));</span>
								String constrainSql;
<span class="nc bnc" id="L408" title="All 2 branches missed.">								if (&quot;PK&quot;.equals(constrainName)) {</span>
<span class="nc" id="L409">									constrainSql = &quot;SELECT name FROM sys.key_constraints WHERE type = 'PK' AND OBJECT_NAME(parent_object_id) = N'&quot;+tableName+&quot;'&quot;;</span>
								} else {
<span class="nc" id="L411">									constrainSql = &quot;SELECT name FROM sys.default_constraints WHERE OBJECT_NAME(parent_object_id) = N'&quot;+tableName+&quot;' AND name LIKE '%__&quot;+constrainName+&quot;__%'&quot;;</span>
								}

<span class="nc" id="L414">								String constrainKey = new SimpleQuery(dbName).forString(constrainSql);</span>

<span class="nc" id="L416">								String replaceText = sql.substring(i, sql.indexOf(&quot;}&quot;, i)+1);</span>
<span class="nc" id="L417">								sql = Tools.replace(sql, replaceText, constrainKey);</span>
							}
<span class="nc" id="L419">							catch (Exception ex) {</span>
<span class="nc" id="L420">								Logger.error(UpdateDatabase.class, ex);</span>
<span class="nc" id="L421">							}</span>
						}

<span class="nc bnc" id="L424" title="All 4 branches missed.">						if (Tools.isNotEmpty(sql) &amp;&amp; sql.startsWith(&quot;//&quot;)==false)</span>
						{
<span class="nc bnc" id="L426" title="All 2 branches missed.">							if (Constants.DB_TYPE == Constants.DB_ORACLE)</span>
							{
<span class="nc" id="L428">								sql = Tools.replace(sql, &quot;|&quot;, &quot;;&quot;);</span>
<span class="nc" id="L429">								sql = Tools.replace(sql, &quot;;;&quot;, &quot;||&quot;);</span>
<span class="nc bnc" id="L430" title="All 4 branches missed.">							} else if (Constants.DB_TYPE == Constants.DB_MYSQL &amp;&amp; &quot;myisam&quot;.equalsIgnoreCase(defaultEngine)==false) {</span>
<span class="nc" id="L431">								sql = Tools.replace(sql, &quot;ENGINE=MyISAM&quot;, &quot;ENGINE=&quot;+defaultEngine);</span>
<span class="nc" id="L432">								sql = Tools.replace(sql, &quot;engine=MyISAM&quot;, &quot;ENGINE=&quot;+defaultEngine);</span>
							}
<span class="nc" id="L434">							Logger.println(UpdateDatabase.class, &quot;[&quot;+counter+&quot;/&quot;+count+&quot;] &quot;+sql);</span>
<span class="nc" id="L435">							counter++;</span>

<span class="nc" id="L437">							sta = db_conn.createStatement();</span>
<span class="nc" id="L438">							sta.execute(sql);</span>
<span class="nc" id="L439">							sta.close();</span>

<span class="nc" id="L441">							Logger.println(UpdateDatabase.class, &quot;[OK] &quot;);</span>

<span class="nc bnc" id="L443" title="All 2 branches missed.">							if (sql.toLowerCase().indexOf(ConfDB.CONF_TABLE_NAME)!=-1) updateConstantsValue(sql);</span>
						}

					}
<span class="nc" id="L447">					catch (SQLException e)</span>
					{
<span class="nc" id="L449">						String message = e.getMessage().toLowerCase();</span>
						//POZOR: message je LOWER CASE, tak aj porovnanie musi byt
<span class="nc" id="L451">						if (</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">								message.contains(&quot;already exists&quot;) ||</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">								message.contains(&quot;duplicate column name&quot;) ||</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">								message.contains(&quot;is specified more than once&quot;) ||</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">								message.contains(&quot;duplicate entry&quot;) ||</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">								message.contains(&quot;already an object&quot;) ||</span>
<span class="nc bnc" id="L457" title="All 2 branches missed.">								message.contains(&quot;tabuľke existuje&quot;) ||</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">								message.contains(&quot;duplicate key&quot;) ||</span>
<span class="nc bnc" id="L459" title="All 2 branches missed.">								message.contains(&quot;názov už používa existujúci objekt&quot;) ||</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">								message.contains(&quot;už existuje&quot;) ||</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">								message.contains(&quot;already used&quot;) ||</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">								message.contains(&quot;porušenie jedinečného obmedzenia&quot;) ||</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">								message.contains(&quot;already indexed&quot;) ||</span>
<span class="nc bnc" id="L464" title="All 4 branches missed.">								(message.contains(&quot;can't drop column&quot;) &amp;&amp; message.contains(&quot;check that it exists&quot;)) ||</span>
<span class="nc bnc" id="L465" title="All 4 branches missed.">								message.contains(&quot;ora-01442 &quot;) || message.contains(&quot;stĺpec, ktorý má byť modifikovaný na not null, je už not null&quot;) ||</span>
								//mssql premenovanie stlpca, ktory uz je premenovany
<span class="nc bnc" id="L467" title="All 2 branches missed.">								message.contains(&quot;either the parameter @objname is ambiguous or the claimed @objtype (column) is wrong&quot;) ||</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">								message.contains(&quot;column to be modified to NULL cannot be modified to NULL&quot;)</span>

							)
						{
							//uz existuje, je to OK
<span class="nc" id="L473">							Logger.println(UpdateDatabase.class, &quot;[EXISTS] &quot;);</span>
<span class="nc" id="L474">							Logger.debug(UpdateDatabase.class, e.getMessage());</span>
						}
<span class="nc bnc" id="L476" title="All 4 branches missed.">						else if (sql.contains(&quot;DROP&quot;) &amp;&amp; message.contains(&quot;does not exist&quot;))</span>
						{
							//uz neexistuje, je to OK
<span class="nc" id="L479">							Logger.println(UpdateDatabase.class, &quot;[NOT EXISTS] &quot;);</span>
<span class="nc" id="L480">							Logger.debug(UpdateDatabase.class, e.getMessage());</span>
						}
						else
						{
							//Logger.System.out.println(&quot;SQL: &quot;+sql);
<span class="nc" id="L485">							Logger.error(UpdateDatabase.class,String.format(&quot;note: %s, [FAIL], %nSQL: %s&quot;, udb.getNote(), sql));</span>
							//sk.iway.iwcm.Logger.error(e);
<span class="nc" id="L487">							sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L488">							updateSuccess = false;</span>
						}
					}
					finally
					{
						try
						{
<span class="nc bnc" id="L495" title="All 2 branches missed.">							if (sta != null)</span>
<span class="nc" id="L496">								sta.close();</span>
						}
<span class="nc" id="L498">						catch (Exception ex2)</span>
						{
<span class="nc" id="L500">						}</span>
<span class="nc" id="L501">					}</span>
				}
			}

<span class="nc bnc" id="L505" title="All 2 branches missed.">			if (updateSuccess)</span>
			{
				//zapis, ze je to aktualizovane
<span class="nc" id="L508">				saveSuccessUpdate(udb.getNote());</span>
<span class="nc" id="L509">				Logger.println(UpdateDatabase.class,&quot;[OK]&quot;);</span>
			}

<span class="nc" id="L512">			rs = null;</span>
<span class="nc" id="L513">			ps = null;</span>
<span class="nc" id="L514">			sta = null;</span>
		}
<span class="nc" id="L516">		catch (Exception ex)</span>
		{
<span class="nc" id="L518">			Logger.error(UpdateDatabase.class,&quot;SQL: &quot; + sql);</span>
<span class="nc" id="L519">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L520">			Logger.println(UpdateDatabase.class,udb.getNote() + &quot; [FAIL]&quot;);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L526" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L527">					db_conn.close();</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L529">					rs.close();</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L531">					ps.close();</span>
<span class="nc bnc" id="L532" title="All 2 branches missed.">				if (sta != null)</span>
<span class="nc" id="L533">					sta.close();</span>
			}
<span class="nc" id="L535">			catch (Exception ex2)</span>
			{
<span class="nc" id="L537">			}</span>
		}

<span class="nc" id="L540">		return(ret);</span>
	}

	/**
	 * ak SQL prikaz obsahoval insert do conf tabulky skus danu hodnotu updatnut, kedze updateDB sa vykona az po nahrati Constants z DB
	 * @param sql - INSERT INTO webjet_conf (name, value) VALUES ('editorNewDocDefaultAvailableChecked', 'false')
	 */
	private static void updateConstantsValue(String sql)
	{
		try
		{
<span class="nc" id="L551">			ConfDetails conf = null;</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">			if (sql.toLowerCase().indexOf(&quot;update &quot;+ConfDB.CONF_TABLE_NAME)!=-1)</span>
			{
				//update
				//UPDATE webjet_conf SET serverMonitoringEnable='false'
<span class="nc" id="L556">				int setStart = sql.indexOf(&quot;SET &quot;);</span>
<span class="nc bnc" id="L557" title="All 2 branches missed.">				if (setStart == -1) return;</span>
<span class="nc" id="L558">				int rovnasa = sql.indexOf('=', setStart);</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">				if (rovnasa &lt; setStart) return;</span>

				//ziskaj meno
<span class="nc" id="L562">				String confName = sql.substring(setStart+4, rovnasa);</span>
<span class="nc" id="L563">				conf = ConfDB.getVariable(confName);</span>
<span class="nc" id="L564">			}</span>
			else
			{
				//insert
				//INSERT INTO webjet_conf (name, value) VALUES ('editorNewDocDefaultAvailableChecked', 'false')
<span class="nc" id="L569">				int apostrofStart = sql.indexOf('\'');</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">				if (apostrofStart == -1) return;</span>
<span class="nc" id="L571">				int apostrofKoniec = sql.indexOf('\'', apostrofStart+1);</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">				if (apostrofKoniec &lt; apostrofStart) return;</span>

				//ziskaj meno
<span class="nc" id="L575">				String confName = sql.substring(apostrofStart+1, apostrofKoniec);</span>
<span class="nc" id="L576">				conf = ConfDB.getVariable(confName);</span>
			}

<span class="nc bnc" id="L579" title="All 4 branches missed.">			if (conf == null &amp;&amp; sql.contains(&quot;SET name='syncGroupAndWebpageTitle' WHERE name='groupCreateBlankWebpageAfterCreate'&quot;)) {</span>
				//specialita rozdelenia konf. premennej
<span class="nc" id="L581">				conf = ConfDB.getVariable(&quot;syncGroupAndWebpageTitle&quot;);</span>
<span class="nc bnc" id="L582" title="All 2 branches missed.">				if (conf != null) {</span>
<span class="nc" id="L583">					conf.setName(&quot;syncGroupAndWebpageTitle&quot;);</span>

					//vytvor nanovo aj povodnu premennu, ta bola premenovana
<span class="nc" id="L586">					ConfDB.setName(&quot;groupCreateBlankWebpageAfterCreate&quot;, conf.getValue());</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">					if (ClusterDB.isServerRunningInClusterMode()) ClusterDB.addRefresh(&quot;sk.iway.iwcm.system.ConfDB-groupCreateBlankWebpageAfterCreate&quot;);</span>
				}
			}

<span class="nc bnc" id="L591" title="All 2 branches missed.">			if (conf != null)</span>
			{
<span class="nc" id="L593">				Logger.debug(UpdateDatabase.class, &quot;Updating Constants name=&quot;+conf.getName()+&quot; value=&quot;+conf.getValue());</span>
<span class="nc" id="L594">				ConfDB.setName(conf.getName(), conf.getValue());</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">				if (ClusterDB.isServerRunningInClusterMode()) ClusterDB.addRefresh(&quot;sk.iway.iwcm.system.ConfDB-&quot;+conf.getName());</span>
			}
		}
<span class="nc" id="L598">		catch (Exception e)</span>
		{
<span class="nc" id="L600">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L601">		}</span>
<span class="nc" id="L602">	}</span>

	/**
	 * Konverzia pristupovych prav na novy format
	 */
	private static void disabledItems()
	{
		//najskor skontroluj, ci je uz vytvorena tabulka
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">		if (isAllreadyUpdated(&quot;disabled items pouzivatelov&quot;)==false) return;</span>

<span class="fc" id="L612">		String note = &quot;Konverzia pristupovych prav&quot;;</span>
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L615">		Connection db_conn = null;</span>
<span class="nc" id="L616">		PreparedStatement ps = null;</span>
<span class="nc" id="L617">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L620">			db_conn = DBPool.getConnection();</span>

			int i;
			//nacitaj si zoznam userov
<span class="nc" id="L624">			ps = db_conn.prepareStatement(&quot;SELECT * FROM  users WHERE is_admin=?&quot;);</span>
<span class="nc" id="L625">			ps.setBoolean(1, true);</span>
<span class="nc" id="L626">			rs = ps.executeQuery();</span>
<span class="nc" id="L627">			List&lt;Identity&gt; users = new ArrayList&lt;&gt;();</span>
			boolean isMenu;
			StringBuilder menus;
<span class="nc bnc" id="L630" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L632">				Identity user = new Identity();</span>
<span class="nc" id="L633">				user.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L634">				user.setFirstName(DB.getDbString(rs, &quot;first_name&quot;));</span>
<span class="nc" id="L635">				user.setLastName(DB.getDbString(rs, &quot;last_name&quot;));</span>
				//davame to do company!!!
<span class="nc" id="L637">				user.setCompany(DB.getDbString(rs, &quot;disabled_items&quot;));</span>

<span class="nc" id="L639">				menus = new StringBuilder();</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">				for (i = 0; i &lt; 15; i++)</span>
				{
<span class="nc" id="L642">					isMenu = rs.getBoolean(&quot;menu&quot; + i);</span>
					//user.setMenu(i, );
<span class="nc bnc" id="L644" title="All 2 branches missed.">					if (isMenu)</span>
					{
<span class="nc" id="L646">						menus.append('1');</span>
					}
					else
					{
<span class="nc" id="L650">						menus.append('0');</span>
					}
				}
<span class="nc" id="L653">				user.setAdress(menus.toString());</span>

<span class="nc" id="L655">				users.add(user);</span>
<span class="nc" id="L656">			}</span>
<span class="nc" id="L657">			rs.close();</span>
<span class="nc" id="L658">			ps.close();</span>

			//vymaz tabulku prav
<span class="nc" id="L661">			ps = db_conn.prepareStatement(&quot;DELETE FROM user_disabled_items&quot;);</span>
<span class="nc" id="L662">			ps.execute();</span>
<span class="nc" id="L663">			ps.close();</span>

<span class="nc" id="L665">			String[] menuNames = new String[15];</span>
<span class="nc" id="L666">			menuNames[0] = &quot;menuWebpages&quot;;</span>
<span class="nc" id="L667">			menuNames[1] = &quot;menuTemplates&quot;;</span>
<span class="nc" id="L668">			menuNames[2] = &quot;menuUsers&quot;;</span>
<span class="nc" id="L669">			menuNames[3] = &quot;menuStats&quot;;</span>
<span class="nc" id="L670">			menuNames[4] = &quot;menuEmail&quot;;</span>
<span class="nc" id="L671">			menuNames[5] = &quot;menuCalendar&quot;;</span>
<span class="nc" id="L672">			menuNames[6] = &quot;menuForms&quot;;</span>
<span class="nc" id="L673">			menuNames[7] = &quot;menu_7&quot;;</span>
<span class="nc" id="L674">			menuNames[8] = &quot;editorMiniEdit&quot;;</span>
<span class="nc" id="L675">			menuNames[9] = &quot;menuQa&quot;;</span>
<span class="nc" id="L676">			menuNames[10] = &quot;menuFbrowser&quot;;</span>
<span class="nc" id="L677">			menuNames[11] = &quot;menuInquiry&quot;;</span>
<span class="nc" id="L678">			menuNames[12] = &quot;menuGallery&quot;;</span>
<span class="nc" id="L679">			menuNames[13] = &quot;menu_13&quot;;</span>
<span class="nc" id="L680">			menuNames[14] = &quot;menu_14&quot;;</span>

			//ok, mame userov, naimportuj to do novej tabulky
			StringTokenizer st;
			String disabledItem;
<span class="nc bnc" id="L685" title="All 2 branches missed.">			for (Identity user : users)</span>
			{
<span class="nc" id="L687">				Logger.println(UpdateDatabase.class,&quot;Konverujem prava: user_id=&quot;+user.getUserId()+&quot; name=&quot;+DB.internationalToEnglish(user.getFullName()));</span>
				//najskor zapis menu

<span class="nc bnc" id="L690" title="All 2 branches missed.">				for (i = 0; i &lt; 15; i++)</span>
				{
<span class="nc bnc" id="L692" title="All 4 branches missed.">					if (user.getAdress().charAt(i) == '0' &amp;&amp; menuNames[i].length()&gt;1)</span>
					{
<span class="nc" id="L694">						ps = db_conn.prepareStatement(&quot;INSERT INTO user_disabled_items (user_id, item_name) VALUES (?, ?)&quot;);</span>
<span class="nc" id="L695">						ps.setInt(1, user.getUserId());</span>
<span class="nc" id="L696">						ps.setString(2, menuNames[i]);</span>
<span class="nc" id="L697">						ps.execute();</span>
<span class="nc" id="L698">						ps.close();</span>
					}
				}

				//teraz zapis disabled items - disabled items mame v company
<span class="nc" id="L703">				st = new StringTokenizer(user.getCompany(), &quot;,&quot;);</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
<span class="nc" id="L706">					disabledItem = st.nextToken();</span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">					if (disabledItem.length()&gt;1)</span>
					{
<span class="nc" id="L709">						ps = db_conn.prepareStatement(&quot;INSERT INTO user_disabled_items (user_id, item_name) VALUES (?, ?)&quot;);</span>
<span class="nc" id="L710">						ps.setInt(1, user.getUserId());</span>
<span class="nc" id="L711">						ps.setString(2, disabledItem);</span>
<span class="nc" id="L712">						ps.execute();</span>
<span class="nc" id="L713">						ps.close();</span>
					}
				}
<span class="nc" id="L716">			}</span>

			//zapis, ze sme to uz skonvertovali
<span class="nc" id="L719">			saveSuccessUpdate(note);</span>

			//dropni fields
<span class="nc" id="L722">			String sql = &quot;ALTER TABLE  users DROP &quot;;</span>
<span class="nc bnc" id="L723" title="All 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
			{
<span class="nc" id="L725">				sql = &quot;ALTER TABLE  users DROP COLUMN &quot;;</span>
			}
			//dropni menuXX
<span class="nc bnc" id="L728" title="All 2 branches missed.">			for (i = 0; i &lt; 15; i++)</span>
			{
<span class="nc" id="L730">				ps = db_conn.prepareStatement(sql+&quot;menu&quot;+i);</span>
<span class="nc" id="L731">				ps.execute();</span>
<span class="nc" id="L732">				ps.close();</span>
			}

<span class="nc" id="L735">			ps = db_conn.prepareStatement(sql+&quot;disabled_items&quot;);</span>
<span class="nc" id="L736">			ps.execute();</span>
<span class="nc" id="L737">			ps.close();</span>


<span class="nc" id="L740">			rs = null;</span>
<span class="nc" id="L741">			ps = null;</span>
		}
<span class="nc" id="L743">		catch (Exception ex)</span>
		{
<span class="nc" id="L745">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L751" title="All 2 branches missed.">				if (db_conn!=null) db_conn.close();</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}
<span class="nc" id="L755">			catch (Exception ex2)</span>
			{

<span class="nc" id="L758">			}</span>
		}
<span class="nc" id="L760">	}</span>

	/**
	 * Rozdelenie celeho mena na titul, meno, priezvisko
	 */
	private static void splitFullName()
	{
		//najskor skontroluj, ci je uz vytvorena tabulka
<span class="pc bpc" id="L768" title="1 of 2 branches missed.">		if (isAllreadyUpdated(&quot;rozdelenie full name na meno a priezvisko&quot;)==false) return;</span>

<span class="fc" id="L770">		String note = &quot;implemetacia rozdelenia full name&quot;;</span>
<span class="pc bpc" id="L771" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L773">		Connection db_conn = null;</span>
<span class="nc" id="L774">		PreparedStatement ps = null;</span>
<span class="nc" id="L775">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L778">			db_conn = DBPool.getConnection();</span>

			//nacitaj si zoznam userov
<span class="nc" id="L781">			ps = db_conn.prepareStatement(&quot;SELECT * FROM  users&quot;);</span>
<span class="nc" id="L782">			rs = ps.executeQuery();</span>
<span class="nc" id="L783">			List&lt;Identity&gt; users = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L784" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L786">				Identity user = new Identity();</span>
<span class="nc" id="L787">				user.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="nc" id="L788">				user.splitFullName(DB.getDbString(rs, &quot;full_name&quot;));</span>
<span class="nc" id="L789">				users.add(user);</span>
<span class="nc" id="L790">			}</span>
<span class="nc" id="L791">			rs.close();</span>
<span class="nc" id="L792">			ps.close();</span>

			//ok, mame userov, rozdel im meno a priezvisko
<span class="nc bnc" id="L795" title="All 2 branches missed.">			for (Identity user : users)</span>
			{
<span class="nc" id="L797">				Logger.println(UpdateDatabase.class,&quot;Konverujem cele meno: user_id=&quot;+user.getUserId()+&quot; name=&quot;+DB.internationalToEnglish(user.getFullName()));</span>

<span class="nc" id="L799">				ps = db_conn.prepareStatement(&quot;UPDATE  users SET title=?, first_name=?, last_name=? WHERE user_id=?&quot;);</span>
<span class="nc" id="L800">				ps.setString(1, user.getTitle());</span>
<span class="nc" id="L801">				ps.setString(2, user.getFirstName());</span>
<span class="nc" id="L802">				ps.setString(3, user.getLastName());</span>
<span class="nc" id="L803">				ps.setInt(4, user.getUserId());</span>
<span class="nc" id="L804">				ps.execute();</span>
<span class="nc" id="L805">				ps.close();</span>
<span class="nc" id="L806">			}</span>

			//zapis, ze sme to uz skonvertovali
<span class="nc" id="L809">			saveSuccessUpdate(note);</span>

<span class="nc" id="L811">			String sql = &quot;ALTER TABLE  users DROP full_name&quot;;</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
			{
<span class="nc" id="L814">				sql = &quot;ALTER TABLE  users DROP COLUMN full_name&quot;;</span>
			}
			//dropni full name
<span class="nc" id="L817">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L818">			ps.execute();</span>
<span class="nc" id="L819">			ps.close();</span>


<span class="nc" id="L822">			rs = null;</span>
<span class="nc" id="L823">			ps = null;</span>
		}
<span class="nc" id="L825">		catch (Exception ex)</span>
		{
<span class="nc" id="L827">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L833" title="All 2 branches missed.">				if (db_conn!=null) db_conn.close();</span>
<span class="nc bnc" id="L834" title="All 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}
<span class="nc" id="L837">			catch (Exception ex2)</span>
			{

<span class="nc" id="L840">			}</span>
		}
<span class="nc" id="L842">	}</span>

	/**
	 * Priprava synchronizacie medzi live a stage serverom
	 *
	 */
	private static void prepareSync()
	{
		//najskor skontroluj, ci je uz vytvorena tabulka
<span class="pc bpc" id="L851" title="1 of 2 branches missed.">		if (isAllreadyUpdated(&quot;id a stav synchronizacie (status: 0=novy, 1=updated, 2=synchronized)&quot;)==false) return;</span>

<span class="fc" id="L853">		String note = &quot;priprava synchronizacie&quot;;</span>
<span class="pc bpc" id="L854" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L856">		Connection db_conn = null;</span>
<span class="nc" id="L857">		PreparedStatement ps = null;</span>
		try
		{
<span class="nc" id="L860">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L862">			Logger.println(UpdateDatabase.class,&quot;PREPARE SYNC: groups&quot;);</span>

			//groups
<span class="nc" id="L865">			ps = db_conn.prepareStatement(&quot;UPDATE groups SET sync_id=group_id, sync_status=2&quot;);</span>
<span class="nc" id="L866">			ps.execute();</span>
<span class="nc" id="L867">			ps.close();</span>

<span class="nc" id="L869">			Logger.println(UpdateDatabase.class,&quot;PREPARE SYNC: documents&quot;);</span>

			//	documents
<span class="nc" id="L872">			ps = db_conn.prepareStatement(&quot;UPDATE documents SET sync_id=doc_id, sync_status=2&quot;);</span>
<span class="nc" id="L873">			ps.execute();</span>
<span class="nc" id="L874">			ps.close();</span>

<span class="nc" id="L876">			Logger.println(UpdateDatabase.class,&quot;PREPARE SYNC: documents_history&quot;);</span>

			//	documents_history
<span class="nc" id="L879">			ps = db_conn.prepareStatement(&quot;UPDATE documents_history SET sync_id=history_id, sync_status=2&quot;);</span>
<span class="nc" id="L880">			ps.execute();</span>
<span class="nc" id="L881">			ps.close();</span>

			//zapis, ze sme to uz skonvertovali
<span class="nc" id="L884">			saveSuccessUpdate(note);</span>

<span class="nc" id="L886">			ps = null;</span>
		}
<span class="nc" id="L888">		catch (Exception ex)</span>
		{
<span class="nc" id="L890">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L896" title="All 2 branches missed.">				if (db_conn!=null) db_conn.close();</span>
<span class="nc bnc" id="L897" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}
<span class="nc" id="L899">			catch (Exception ex2)</span>
			{

<span class="nc" id="L902">			}</span>
		}
<span class="nc" id="L904">	}</span>

	/**
	 * Nastavi registracny datum pouzivatelom (podla last_logon, alebo na aktualny datum)
	 *
	 */
	private static void setRegDate()
	{
<span class="fc" id="L912">		String note = &quot;nastavenie reg date pouzivatelov&quot;;</span>
<span class="pc bpc" id="L913" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L915">		Connection db_conn = null;</span>
<span class="nc" id="L916">		PreparedStatement ps = null;</span>
		try
		{
<span class="nc" id="L919">			db_conn = DBPool.getConnection();</span>
<span class="nc" id="L920">			Logger.println(UpdateDatabase.class,&quot;Nastavenie reg date pouzivatelov&quot;);</span>

<span class="nc" id="L922">			ps = db_conn.prepareStatement(&quot;UPDATE  users SET reg_date=last_logon WHERE reg_date IS NULL&quot;);</span>
<span class="nc" id="L923">			ps.execute();</span>
<span class="nc" id="L924">			ps.close();</span>

<span class="nc" id="L926">			ps = db_conn.prepareStatement(&quot;UPDATE  users SET reg_date=? WHERE reg_date IS NULL&quot;);</span>
<span class="nc" id="L927">			ps.setTimestamp(1, new Timestamp(Tools.getNow()));</span>
<span class="nc" id="L928">			ps.execute();</span>
<span class="nc" id="L929">			ps.close();</span>

			//zapis, ze sme to uz skonvertovali
<span class="nc" id="L932">			saveSuccessUpdate(note);</span>

<span class="nc" id="L934">			ps = null;</span>
		}
<span class="nc" id="L936">		catch (Exception ex)</span>
		{
<span class="nc" id="L938">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L944" title="All 2 branches missed.">				if (db_conn!=null) db_conn.close();</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}
<span class="nc" id="L947">			catch (Exception ex2)</span>
			{

<span class="nc" id="L950">			}</span>
		}
<span class="nc" id="L952">	}</span>



	private static void importMeniny()
	{
		//skontroluj ci existuje DB tabulka
<span class="pc bpc" id="L959" title="1 of 2 branches missed.">		if (isAllreadyUpdated(&quot;kalendar s meninami&quot;)==false) return;</span>

<span class="nc" id="L961">		String note = &quot;import kalendara menin z excelu&quot;;</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

		try
		{
<span class="nc" id="L966">			FileInputStream in = new FileInputStream(Tools.getRealPath(&quot;/WEB-INF/sql/meniny.xls&quot;));</span>
<span class="nc" id="L967">			MeninyImport mi = new MeninyImport(in, null, null);</span>
<span class="nc" id="L968">			Prop prop = Prop.getInstance(Constants.getServletContext(), &quot;sk&quot;, false);</span>
<span class="nc" id="L969">			mi.doImport(prop);</span>

			//zapis do DB, ze je to importnute
<span class="nc" id="L972">			saveSuccessUpdate(note);</span>

<span class="nc" id="L974">			in.close();</span>
		}
<span class="nc" id="L976">		catch (Exception ex)</span>
		{
<span class="nc" id="L978">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L979">		}</span>
<span class="nc" id="L980">	}</span>

	/**
	 * Zkonvertuje perex_group v tab. documents z perex_group_name na
	 * perex_group_id. Novy zapis je vo forme &quot;,ID,&quot; .
	 *
	 */
	public static void convertPerexGroups()
	{
<span class="fc" id="L989">		String note = &quot;konverzia perex_group v tab. documents z name na id&quot;;</span>
<span class="pc bpc" id="L990" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L992">		Connection db_conn = null;</span>
<span class="nc" id="L993">		PreparedStatement ps = null;</span>
<span class="nc" id="L994">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L997">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L999">			Logger.println(UpdateDatabase.class,&quot;Converting perex_group&quot;);</span>
<span class="nc" id="L1000">			Map&lt;String, Integer&gt; perexGroups = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L1001">			ps = db_conn.prepareStatement(&quot;SELECT * FROM perex_groups&quot;);</span>
<span class="nc" id="L1002">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L1005">				perexGroups.put(DB.getDbString(rs, &quot;perex_group_name&quot;), Integer.valueOf(rs.getInt(&quot;perex_group_id&quot;)));</span>
			}
<span class="nc" id="L1007">			rs.close();</span>
<span class="nc" id="L1008">			ps.close();</span>

<span class="nc bnc" id="L1010" title="All 2 branches missed.">			if (perexGroups.size() &gt; 0)</span>
			{
				String gName;
<span class="nc" id="L1013">				String perexGroupStr = null;</span>
				StringBuilder newPerexGroupStr;
				StringTokenizer st;
<span class="nc" id="L1016">				List&lt;DocDetails&gt; groups = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1018">				ps = db_conn.prepareStatement(&quot;SELECT * FROM documents WHERE perex_group IS NOT NULL&quot;);</span>
<span class="nc" id="L1019">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">				while (rs.next())</span>
				{
<span class="nc" id="L1022">					DocDetails docDet = new DocDetails();</span>
<span class="nc" id="L1023">					docDet.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="nc" id="L1024">					docDet.setPerexGroupString(DB.getDbString(rs, &quot;perex_group&quot;));</span>
<span class="nc" id="L1025">					groups.add(docDet);</span>
<span class="nc" id="L1026">				}</span>
<span class="nc" id="L1027">				rs.close();</span>
<span class="nc" id="L1028">				ps.close();</span>

<span class="nc bnc" id="L1030" title="All 2 branches missed.">				for (DocDetails docDet : groups)</span>
				{
<span class="nc" id="L1032">					newPerexGroupStr = null;</span>
<span class="nc" id="L1033">					perexGroupStr = docDet.getPerexGroupString();</span>
<span class="nc" id="L1034">					st = new StringTokenizer(perexGroupStr, &quot;,&quot;);</span>
<span class="nc bnc" id="L1035" title="All 2 branches missed.">					while (st.hasMoreTokens())</span>
					{
<span class="nc" id="L1037">						gName = st.nextToken().trim();</span>
<span class="nc bnc" id="L1038" title="All 2 branches missed.">						if (perexGroups.get(gName) != null)</span>
						{
<span class="nc bnc" id="L1040" title="All 2 branches missed.">							if (newPerexGroupStr==null)</span>
							{
<span class="nc" id="L1042">								newPerexGroupStr = new StringBuilder(&quot;,&quot;).append(perexGroups.get(gName)).append(',');</span>
							}
							else
							{
<span class="nc" id="L1046">								newPerexGroupStr.append(perexGroups.get(gName)).append(',');</span>
							}
						}
					}
					//Logger.println(UpdateDatabase.class,&quot;****\nDocID: &quot; +docDet.getDocId()+ &quot;\nold groups: &quot; +perexGroupStr+ &quot;\nnew groups; &quot; +newPerexGroupStr);

<span class="nc bnc" id="L1052" title="All 2 branches missed.">					if (newPerexGroupStr!=null)</span>
					{
<span class="nc" id="L1054">						ps = db_conn.prepareStatement(&quot;UPDATE documents SET perex_group=? WHERE doc_id=?&quot;);</span>
<span class="nc" id="L1055">						ps.setString(1, newPerexGroupStr.toString());</span>
<span class="nc" id="L1056">						ps.setInt(2, docDet.getDocId());</span>
<span class="nc" id="L1057">						ps.execute();</span>
<span class="nc" id="L1058">						ps.close();</span>
					}
<span class="nc" id="L1060">				}</span>
				//Logger.println(UpdateDatabase.class,&quot;****&quot;);
			}

			//zapis, ze sme to uz skonvertovali
<span class="nc" id="L1065">			saveSuccessUpdate(note);</span>

<span class="nc" id="L1067">			rs = null;</span>
<span class="nc" id="L1068">			ps = null;</span>
		}
<span class="nc" id="L1070">		catch (Exception ex)</span>
		{
<span class="nc" id="L1072">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1078" title="All 2 branches missed.">				if (db_conn!=null) db_conn.close();</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}
<span class="nc" id="L1082">			catch (Exception ex2)</span>
			{

<span class="nc" id="L1085">			}</span>
		}
<span class="nc" id="L1087">	}</span>

	/**
	 * ImportImpl cistej databazy
	 * @return - null, alebo text chybovej hlasky
	 */
	@SuppressWarnings(&quot;java:S106&quot;)
	public static String fillEmptyDatabaseMySQL()
	{
<span class="nc" id="L1096">		System.out.println(&quot;fillEmptyDatabaseMySQL&quot;);</span>

<span class="nc" id="L1098">		StringBuilder errMsg = null;</span>

<span class="nc" id="L1100">		Connection db_conn = null;</span>
<span class="nc" id="L1101">		PreparedStatement ps = null;</span>
<span class="nc" id="L1102">		ResultSet rs = null;</span>
<span class="nc" id="L1103">		String sql = null;</span>
		try
		{
			//over, ci mame nejaku databazu
<span class="nc" id="L1107">			boolean hasDatabase = false;</span>

<span class="nc" id="L1109">			System.out.println(&quot;fillEmptyDatabaseMySQL 1&quot;);</span>

<span class="nc" id="L1111">			db_conn = DBPool.getConnection();</span>
			try
			{
<span class="nc" id="L1114">				ps = db_conn.prepareStatement(&quot;SHOW TABLES&quot;);</span>
<span class="nc" id="L1115">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">				if (rs.next())</span>
				{
<span class="nc" id="L1118">					hasDatabase = true;</span>
				}
			}
			finally
			{
<span class="nc bnc" id="L1123" title="All 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}

<span class="nc" id="L1127">			System.out.println(&quot;fillEmptyDatabaseMySQL 2&quot;);</span>

<span class="nc" id="L1129">			System.out.println(&quot;hasDatabase=&quot;+hasDatabase);</span>

<span class="nc bnc" id="L1131" title="All 2 branches missed.">			if (hasDatabase)</span>
			{
<span class="nc" id="L1133">				return(null);</span>
			}

			//	nacitaj obsah suboru
<span class="nc" id="L1137">			String data = FileTools.readFileContent(&quot;/WEB-INF/sql/blank_web.sql&quot;, &quot;utf-8&quot;);</span>
<span class="nc" id="L1138">			String defaultEngine = Constants.getString(&quot;mariaDbDefaultEngine&quot;);</span>

			//System.out.println(data);

<span class="nc" id="L1142">			StringTokenizer st = new StringTokenizer(data, &quot;;&quot;);</span>

<span class="nc bnc" id="L1144" title="All 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L1146">				sql = st.nextToken();</span>
<span class="nc bnc" id="L1147" title="All 2 branches missed.">				if (Tools.isNotEmpty(sql))</span>
				{
<span class="nc bnc" id="L1149" title="All 2 branches missed.">					if (&quot;myisam&quot;.equalsIgnoreCase(defaultEngine)==false) {</span>
<span class="nc" id="L1150">						sql = Tools.replace(sql, &quot;ENGINE=MyISAM&quot;, &quot;ENGINE=&quot;+defaultEngine);</span>
<span class="nc" id="L1151">						sql = Tools.replace(sql, &quot;engine=MyISAM&quot;, &quot;ENGINE=&quot;+defaultEngine);</span>
					}

<span class="nc" id="L1154">					System.out.println(&quot;Executing: &quot;+sql);</span>

<span class="nc" id="L1156">					ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1157">					ps.execute();</span>
<span class="nc" id="L1158">					ps.close();</span>
				}
			}

<span class="nc" id="L1162">			rs = null;</span>
<span class="nc" id="L1163">			ps = null;</span>
		}
<span class="nc" id="L1165">		catch (Exception ex)</span>
		{
<span class="nc bnc" id="L1167" title="All 2 branches missed.">			if (ex.getMessage()!=null) errMsg = new StringBuilder(ex.getMessage());</span>
<span class="nc bnc" id="L1168" title="All 4 branches missed.">			if (sql != null &amp;&amp; errMsg!=null)</span>
			{
<span class="nc" id="L1170">				errMsg.append(&quot; - &quot;).append(sql);</span>
			}
<span class="nc" id="L1172">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1173">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1179" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1180">					db_conn.close();</span>
<span class="nc bnc" id="L1181" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1182">					rs.close();</span>
<span class="nc bnc" id="L1183" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1184">					ps.close();</span>
			}
<span class="nc" id="L1186">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1188">			}</span>
		}

<span class="nc bnc" id="L1191" title="All 2 branches missed.">		if (errMsg == null) return null;</span>

<span class="nc" id="L1193">		return(errMsg.toString());</span>
	}

	/**
	 * ImportImpl cistej databazy
	 * @return - null, alebo text chybovej spravy
	 */
	public static String fillEmptyDatabaseMSSQL()
	{
<span class="nc" id="L1202">		StringBuilder errMsg = new StringBuilder();</span>

<span class="nc" id="L1204">		Connection db_conn = null;</span>
<span class="nc" id="L1205">		Statement ps = null;</span>
<span class="nc" id="L1206">		ResultSet rs = null;</span>
<span class="nc" id="L1207">		String sql = null;</span>
		try
		{
			//over, ci mame nejaku databazu
<span class="nc" id="L1211">			boolean hasDatabase = false;</span>

<span class="nc" id="L1213">			db_conn = DBPool.getConnection();</span>
			try
			{
<span class="nc" id="L1216">				ps = db_conn.createStatement();</span>
<span class="nc" id="L1217">				rs = ps.executeQuery(&quot;SELECT * FROM &quot;+ConfDB.CONF_TABLE_NAME);</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">				if (rs.next())</span>
				{

				}
<span class="nc" id="L1222">				hasDatabase = true;</span>
			}
<span class="nc" id="L1224">			catch (Exception ex)</span>
			{
				//databaza nie je naplnena
			}
			finally
			{
<span class="nc bnc" id="L1230" title="All 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="nc bnc" id="L1231" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}

<span class="nc bnc" id="L1234" title="All 2 branches missed.">			if (hasDatabase)</span>
			{
<span class="nc" id="L1236">				return(null);</span>
			}

			//	nacitaj obsah suboru
<span class="nc" id="L1240">			String data = FileTools.readFileContent(&quot;/WEB-INF/sql/blank_web_mssql.sql&quot;, &quot;utf-8&quot;);</span>
<span class="nc" id="L1241">			StringTokenizer st = new StringTokenizer(data, &quot;;&quot;);</span>
<span class="nc bnc" id="L1242" title="All 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L1244">				sql = st.nextToken();</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">				if (Tools.isNotEmpty(sql))</span>
				{
<span class="nc" id="L1247">					Logger.println(UpdateDatabase.class,&quot;Executing: &quot;+sql);</span>

<span class="nc" id="L1249">					ps = db_conn.createStatement();</span>
<span class="nc" id="L1250">					ps.execute(sql);</span>
<span class="nc" id="L1251">					ps.close();</span>
				}
			}

<span class="nc" id="L1255">			rs = null;</span>
<span class="nc" id="L1256">			ps = null;</span>
		}
<span class="nc" id="L1258">		catch (Exception ex)</span>
		{
<span class="nc" id="L1260">			errMsg.append(ex.getMessage());</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">			if (sql != null)</span>
			{
<span class="nc" id="L1263">				errMsg.append(&quot; - &quot;).append(sql);</span>
			}
<span class="nc" id="L1265">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1271" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1272">					db_conn.close();</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1274">					rs.close();</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1276">					ps.close();</span>
			}
<span class="nc" id="L1278">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1280">			}</span>
		}

<span class="nc" id="L1283">		return(errMsg.toString());</span>
	}

	/**
	 * Naplnenie oracle databazy (ked je prazdna)
	 * @return
	 */
	public static String fillEmptyDatabaseOracle()
	{
<span class="nc" id="L1292">		Logger.println(UpdateDatabase.class,&quot;fillEmptyDatabaseOracle&quot;);</span>

<span class="nc" id="L1294">		StringBuilder errMsg = new StringBuilder();</span>

<span class="nc" id="L1296">		Connection db_conn = null;</span>
<span class="nc" id="L1297">		PreparedStatement ps = null;</span>
<span class="nc" id="L1298">		ResultSet rs = null;</span>
<span class="nc" id="L1299">		String sql = null;</span>
		try
		{
			//over, ci mame nejaku databazu
<span class="nc" id="L1303">			boolean hasDatabase = false;</span>

<span class="nc" id="L1305">			db_conn = DBPool.getConnection();</span>
			try
			{
<span class="nc" id="L1308">				ps = db_conn.prepareStatement(&quot;SELECT * FROM documents&quot;);</span>
<span class="nc" id="L1309">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">				if (rs.next())</span>
				{

				}
<span class="nc" id="L1314">				hasDatabase = true;</span>
			}
<span class="nc" id="L1316">			catch (Exception ex)</span>
			{
				//databaza nie je naplnena
			}
			finally
			{
<span class="nc bnc" id="L1322" title="All 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="nc bnc" id="L1323" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}

			//Logger.println(UpdateDatabase.class,&quot;Oracle hasDatabase=&quot;+hasDatabase);

<span class="nc bnc" id="L1328" title="All 2 branches missed.">			if (hasDatabase)</span>
			{
<span class="nc" id="L1330">				return(null);</span>
			}

			//	nacitaj obsah suboru
<span class="nc" id="L1334">			String data = FileTools.readFileContent(&quot;/WEB-INF/sql/blank_web_oracle.sql&quot;, &quot;utf-8&quot;);</span>
<span class="nc" id="L1335">			StringTokenizer st = new StringTokenizer(data, &quot;;&quot;);</span>
			java.sql.Statement s;
<span class="nc bnc" id="L1337" title="All 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L1339">				sql = st.nextToken().trim();</span>
<span class="nc bnc" id="L1340" title="All 4 branches missed.">				if (Tools.isNotEmpty(sql) &amp;&amp; sql.startsWith(&quot;#&quot;)==false)</span>
				{
<span class="nc" id="L1342">					sql = Tools.replace(sql, &quot;|&quot;, &quot;;&quot;);</span>
<span class="nc" id="L1343">					Logger.println(UpdateDatabase.class,&quot;Executing: &quot;+sql);</span>
<span class="nc bnc" id="L1344" title="All 2 branches missed.">					if (sql.indexOf(&quot;TRIGGER&quot;)!=-1)</span>
					{
<span class="nc" id="L1346">						sql = sql.replace('\n', ' ');</span>
<span class="nc" id="L1347">						sql = sql.replace('\r', ' ');</span>
<span class="nc" id="L1348">						sql = sql.replace('\t', ' ');</span>
					}
<span class="nc" id="L1350">					s = db_conn.createStatement();</span>
<span class="nc" id="L1351">					s.execute(sql);</span>
<span class="nc" id="L1352">					s.close();</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">					if (Constants.getBoolean(&quot;jtdsCommit&quot;)) db_conn.commit();</span>
				}
			}

<span class="nc" id="L1357">			rs = null;</span>
<span class="nc" id="L1358">			ps = null;</span>
		}
<span class="nc" id="L1360">		catch (Exception ex)</span>
		{
<span class="nc" id="L1362">			errMsg.append(ex.getMessage());</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">			if (sql != null)</span>
			{
<span class="nc" id="L1365">				errMsg.append(&quot; - &quot;).append(sql);</span>
			}
<span class="nc" id="L1367">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1373" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1374">					db_conn.close();</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1376">					rs.close();</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1378">					ps.close();</span>
			}
<span class="nc" id="L1380">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1382">			}</span>
		}

<span class="nc" id="L1385">		return(errMsg.toString());</span>
	}

	@SuppressWarnings(&quot;java:S106&quot;)
	public static String fillEmptyDatabasePgSQL(String schema)
	{
<span class="nc" id="L1391">		System.out.println(&quot;fillEmptyDatabasePgSQL, schema=&quot;+schema);</span>

<span class="nc" id="L1393">		StringBuilder errMsg = null;</span>

<span class="nc" id="L1395">		Connection db_conn = null;</span>
<span class="nc" id="L1396">		PreparedStatement ps = null;</span>
<span class="nc" id="L1397">		ResultSet rs = null;</span>
<span class="nc" id="L1398">		String sql = null;</span>
		try
		{
			//over, ci mame nejaku databazu
<span class="nc" id="L1402">			boolean hasDatabase = false;</span>

<span class="nc" id="L1404">			System.out.println(&quot;fillEmptyDatabasePgSQL 1&quot;);</span>

<span class="nc" id="L1406">			db_conn = DBPool.getConnection();</span>
			try
			{
<span class="nc" id="L1409">				ps = db_conn.prepareStatement(&quot;SELECT * FROM documents&quot;);</span>
<span class="nc" id="L1410">				rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">				if (rs.next())</span>
				{
<span class="nc" id="L1413">					hasDatabase = true;</span>
				}
			}
<span class="nc" id="L1416">			catch (Exception ex)</span>
			{
				//databaza nie je naplnena
			}
			finally
			{
<span class="nc bnc" id="L1422" title="All 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="nc bnc" id="L1423" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}

<span class="nc" id="L1426">			System.out.println(&quot;fillEmptyDatabasePgSQL 2&quot;);</span>

<span class="nc" id="L1428">			System.out.println(&quot;hasDatabase=&quot;+hasDatabase);</span>

<span class="nc bnc" id="L1430" title="All 2 branches missed.">			if (hasDatabase)</span>
			{
<span class="nc" id="L1432">				return(null);</span>
			}

			//	nacitaj obsah suboru
<span class="nc" id="L1436">			String data = FileTools.readFileContent(&quot;/WEB-INF/sql/blank_web_pgsql.sql&quot;, &quot;utf-8&quot;);</span>

			//System.out.println(data);

<span class="nc" id="L1440">			StringTokenizer st = new StringTokenizer(data, &quot;;&quot;);</span>

<span class="nc bnc" id="L1442" title="All 2 branches missed.">			while (st.hasMoreTokens())</span>
			{
<span class="nc" id="L1444">				sql = st.nextToken();</span>
<span class="nc bnc" id="L1445" title="All 2 branches missed.">				if (Tools.isNotEmpty(sql))</span>
				{
<span class="nc bnc" id="L1447" title="All 2 branches missed.">					if (&quot;webjet_cms&quot;.equals(schema)==false) {</span>
<span class="nc" id="L1448">						sql = Tools.replace(sql, &quot;CREATE SCHEMA IF NOT EXISTS \&quot;webjet_cms\&quot;&quot;, &quot;CREATE SCHEMA IF NOT EXISTS \&quot;&quot;+schema+&quot;\&quot;&quot;);</span>
<span class="nc" id="L1449">						sql = Tools.replace(sql, &quot;SCHEMA \&quot;webjet_cms\&quot;&quot;, &quot;SCHEMA \&quot;&quot;+schema+&quot;\&quot;&quot;);</span>
<span class="nc" id="L1450">						sql = Tools.replace(sql, &quot;\&quot;webjet_cms\&quot;.&quot;, &quot;\&quot;&quot;+schema+&quot;\&quot;.&quot;);</span>
					}

<span class="nc" id="L1453">					System.out.println(&quot;Executing: &quot;+sql);</span>

<span class="nc" id="L1455">					ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1456">					ps.execute();</span>
<span class="nc" id="L1457">					ps.close();</span>
				}
			}

<span class="nc" id="L1461">			rs = null;</span>
<span class="nc" id="L1462">			ps = null;</span>
		}
<span class="nc" id="L1464">		catch (Exception ex)</span>
		{
<span class="nc bnc" id="L1466" title="All 2 branches missed.">			if (ex.getMessage()!=null) errMsg = new StringBuilder(ex.getMessage());</span>
<span class="nc bnc" id="L1467" title="All 4 branches missed.">			if (sql != null &amp;&amp; errMsg!=null)</span>
			{
<span class="nc" id="L1469">				errMsg.append(&quot; - &quot;).append(sql);</span>
			}
<span class="nc" id="L1471">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1472">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1478" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1479">					db_conn.close();</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1481">					rs.close();</span>
<span class="nc bnc" id="L1482" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1483">					ps.close();</span>
			}
<span class="nc" id="L1485">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1487">			}</span>
		}

<span class="nc bnc" id="L1490" title="All 2 branches missed.">		if (errMsg == null) return null;</span>

<span class="nc" id="L1492">		return(errMsg.toString());</span>
	}

	private static void configureModules()
	{
<span class="pc bpc" id="L1497" title="1 of 2 branches missed.">		if (&quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;)))</span>
		{
<span class="nc" id="L1499">			return;</span>
		}

<span class="fc" id="L1502">		Connection db_conn = null;</span>
<span class="fc" id="L1503">		PreparedStatement ps = null;</span>
		try
		{
<span class="fc" id="L1506">			db_conn = DBPool.getConnection();</span>

<span class="fc" id="L1508">			ps = db_conn.prepareStatement(&quot;UPDATE user_disabled_items SET item_name=? WHERE item_name=?&quot;);</span>
<span class="fc" id="L1509">			ps.setString(1, &quot;cmp_stat&quot;);</span>
<span class="fc" id="L1510">			ps.setString(2, &quot;menuStats&quot;);</span>
<span class="fc" id="L1511">			ps.execute();</span>
<span class="fc" id="L1512">			ps.close();</span>
<span class="fc" id="L1513">			ps = null;</span>

<span class="fc" id="L1515">			ps = db_conn.prepareStatement(&quot;UPDATE user_disabled_items SET item_name=? WHERE item_name=?&quot;);</span>
<span class="fc" id="L1516">			ps.setString(1, &quot;cmp_calendar&quot;);</span>
<span class="fc" id="L1517">			ps.setString(2, &quot;menuCalendar&quot;);</span>
<span class="fc" id="L1518">			ps.execute();</span>
<span class="fc" id="L1519">			ps.close();</span>
<span class="fc" id="L1520">			ps = null;</span>

<span class="fc" id="L1522">			ps = db_conn.prepareStatement(&quot;UPDATE user_disabled_items SET item_name=? WHERE item_name=?&quot;);</span>
<span class="fc" id="L1523">			ps.setString(1, &quot;cmp_form&quot;);</span>
<span class="fc" id="L1524">			ps.setString(2, &quot;menuForms&quot;);</span>
<span class="fc" id="L1525">			ps.execute();</span>
<span class="fc" id="L1526">			ps.close();</span>
<span class="fc" id="L1527">			ps = null;</span>

			//zadisabluj moduly, ktore sa objavili prvy krat
<span class="fc" id="L1530">			List&lt;ModuleInfo&gt; modules = Modules.getInstance().getAvailableModules();</span>
<span class="fc bfc" id="L1531" title="All 2 branches covered.">			for (ModuleInfo mi : modules)</span>
			{
<span class="fc bfc" id="L1533" title="All 2 branches covered.">				if (mi.isDefaultDisabled())</span>
				{
<span class="fc" id="L1535">					disableFirstTimeModule(mi.getItemKey(), db_conn);</span>
				}
<span class="pc bpc" id="L1537" title="1 of 4 branches missed.">				if (mi.getSubmenus()!=null &amp;&amp; mi.getSubmenus().size()&gt;0)</span>
				{
<span class="fc bfc" id="L1539" title="All 2 branches covered.">					for (ModuleInfo submi : mi.getSubmenus())</span>
					{
<span class="fc bfc" id="L1541" title="All 2 branches covered.">						if (submi.isDefaultDisabled()) disableFirstTimeModule(submi.getItemKey(), db_conn);</span>
<span class="fc" id="L1542">					}</span>
				}
<span class="fc" id="L1544">			}</span>

<span class="pc bpc" id="L1546" title="1 of 2 branches missed.">			if(db_conn != null)</span>
			{
<span class="fc" id="L1548">				db_conn.close();</span>
<span class="fc" id="L1549">				db_conn = null;</span>
			}

		}
<span class="nc" id="L1553">		catch (Exception ex)</span>
		{
<span class="nc" id="L1555">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L1561" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1562">					db_conn.close();</span>
<span class="pc bpc" id="L1563" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1564">					ps.close();</span>
			}
<span class="nc" id="L1566">			catch (Exception ex2)</span>
			{
<span class="fc" id="L1568">			}</span>
		}
<span class="fc" id="L1570">	}</span>

	/**
	 * Zakaze modul vsetkym pouzivatelom, ak je to prva inicializacia modulu
	 * @param itemKey
	 * @param db_conn
	 * @throws SQLException
	 */
	private static void disableFirstTimeModule(String itemKey, Connection db_conn)
	{
<span class="fc" id="L1580">		String note = &quot;NEW MODULE: &quot;+itemKey;</span>
<span class="pc bpc" id="L1581" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L1583">		List&lt;UserDetails&gt; changedUsers = ConfDB.disableMenuItemAll(itemKey);</span>
<span class="nc" id="L1584">		Logger.println(UpdateDatabase.class,&quot;Disabling &quot; + itemKey + &quot; for all users (&quot;+changedUsers.size()+&quot;)&quot;);</span>

<span class="nc" id="L1586">		saveSuccessUpdate(note);</span>
<span class="nc" id="L1587">	}</span>

	private static void fixGroupIdInStatViews()
	{
		//	otestuj, ci uz nebol importovany subor
<span class="fc" id="L1592">		String note = &quot;nastavenie hodnot group_id pre tabulku stat_views&quot;;</span>
<span class="pc bpc" id="L1593" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L1595">		Connection db_conn = null;</span>
<span class="nc" id="L1596">		PreparedStatement ps = null;</span>
<span class="nc" id="L1597">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L1600">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L1602">			String sql = &quot;SELECT doc_id, title, navbar, external_link, group_id, virtual_path, available, show_in_menu FROM documents ORDER BY doc_id ASC&quot;;</span>

<span class="nc" id="L1604">			ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1605">			rs = ps.executeQuery();</span>
<span class="nc" id="L1606">			List&lt;DocDetails&gt; list = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1607" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L1609">				DocDetails doc = new DocDetails();</span>
<span class="nc" id="L1610">				doc.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="nc" id="L1611">				doc.setTitle(DB.getDbString(rs, &quot;title&quot;));</span>
<span class="nc" id="L1612">				doc.setNavbar(DB.getDbString(rs, &quot;navbar&quot;));</span>
<span class="nc" id="L1613">				doc.setExternalLink(DB.getDbString(rs, &quot;external_link&quot;));</span>
<span class="nc" id="L1614">				doc.setGroupId(rs.getInt(&quot;group_id&quot;));</span>
<span class="nc" id="L1615">				doc.setVirtualPath(DB.getDbString(rs, &quot;virtual_path&quot;));</span>
<span class="nc" id="L1616">				doc.setAvailable(rs.getBoolean(&quot;available&quot;));</span>
<span class="nc" id="L1617">				doc.setShowInMenu(rs.getBoolean(&quot;show_in_menu&quot;));</span>

<span class="nc" id="L1619">				list.add(doc);</span>
<span class="nc" id="L1620">			}</span>
<span class="nc" id="L1621">			rs.close();</span>
<span class="nc" id="L1622">			ps.close();</span>
<span class="nc" id="L1623">			rs = null;</span>
<span class="nc" id="L1624">			ps = null;</span>

<span class="nc" id="L1626">			int counter = 0;</span>
<span class="nc" id="L1627">			int size = list.size();</span>
<span class="nc" id="L1628">			DebugTimer timer = new DebugTimer(&quot;&quot;);</span>
<span class="nc bnc" id="L1629" title="All 2 branches missed.">			for (DocDetails doc : list)</span>
			{
<span class="nc" id="L1631">				counter++;</span>
<span class="nc" id="L1632">				Logger.info(UpdateDatabase.class, &quot;Updating stat [&quot;+counter+&quot;/&quot;+size+&quot;]: docId=&quot;+doc.getDocId()+&quot; title=&quot;+DB.internationalToEnglish(doc.getTitle()));</span>
<span class="nc" id="L1633">				ps = db_conn.prepareStatement(&quot;UPDATE stat_views SET group_id=? WHERE doc_id=?&quot;);</span>
<span class="nc" id="L1634">				ps.setInt(1, doc.getGroupId());</span>
<span class="nc" id="L1635">				ps.setInt(2, doc.getDocId());</span>
<span class="nc" id="L1636">				ps.execute();</span>
<span class="nc" id="L1637">				ps.close();</span>
<span class="nc" id="L1638">				ps = null;</span>

<span class="nc" id="L1640">				ps = db_conn.prepareStatement(&quot;UPDATE stat_views SET last_group_id=? WHERE last_doc_id=?&quot;);</span>
<span class="nc" id="L1641">				ps.setInt(1, doc.getGroupId());</span>
<span class="nc" id="L1642">				ps.setInt(2, doc.getDocId());</span>
<span class="nc" id="L1643">				ps.execute();</span>
<span class="nc" id="L1644">				ps.close();</span>
<span class="nc" id="L1645">				ps = null;</span>

<span class="nc" id="L1647">				Logger.info(UpdateDatabase.class, &quot; [OK] - &quot; + timer.getDiff() + &quot; ms&quot;);</span>
<span class="nc" id="L1648">			}</span>

<span class="nc" id="L1650">			db_conn.close();</span>
<span class="nc" id="L1651">			ps = null;</span>
<span class="nc" id="L1652">			db_conn = null;</span>

			//zapis do DB, ze je to importnute
<span class="nc" id="L1655">			saveSuccessUpdate(note);</span>
		}
<span class="nc" id="L1657">		catch (Exception ex)</span>
		{
<span class="nc" id="L1659">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1665" title="All 2 branches missed.">				if (db_conn!=null) db_conn.close();</span>
<span class="nc bnc" id="L1666" title="All 2 branches missed.">				if (rs!=null) rs.close();</span>
<span class="nc bnc" id="L1667" title="All 2 branches missed.">				if (ps!=null) ps.close();</span>
			}
<span class="nc" id="L1669">			catch (Exception ex2)</span>
			{

<span class="nc" id="L1672">			}</span>
		}
<span class="nc" id="L1674">	}</span>

	public static void deletePoiClasses()
	{
<span class="fc" id="L1678">		IwcmFile f = new IwcmFile(Tools.getRealPath(&quot;/WEB-INF/classes/org/apache/poi/&quot;));</span>
<span class="fc" id="L1679">		FileTools.deleteDirTree(f);</span>
<span class="fc" id="L1680">	}</span>

	/**
	 * Funkcia, ktora vsetky vyskyty browserId v existujuich tabulkach zvysi o konstantu 1 500 000, nad ktorou identifikujeme neprihlasenych pouzivatelov
	 * kvoli integrite statistickych zaznamov, ovplyvnuje tabulku stat_from a stat_views
	 *
	 * @author kmarton
	 */
	public static void fixBrowserId()
	{
<span class="fc" id="L1690">		fixBrowserId(false);</span>
<span class="fc" id="L1691">	}</span>


	public static void fixBrowserId(boolean forceUpdate)
	{
<span class="fc" id="L1696">		Connection db_conn = null;</span>
<span class="fc" id="L1697">		PreparedStatement ps = null;</span>
<span class="fc" id="L1698">		ResultSet rs = null;</span>

<span class="fc" id="L1700">		String note = &quot;14.3.2009 [kmarton] nastavenie spravnych hodnot browserId kvoli kompatibilite noveho kodu, ovplynuje tabulku stat_from a stat_views&quot;;</span>

		try
		{
<span class="fc" id="L1704">			boolean found = false;</span>

<span class="pc bpc" id="L1706" title="1 of 2 branches missed.">			if (forceUpdate == false)</span>
			{
				//	otestuj, ci uz takato operacia neprebehla
<span class="pc bpc" id="L1709" title="1 of 2 branches missed.">				if (isAllreadyUpdated(note)) found = true;</span>
			}

<span class="pc bpc" id="L1712" title="3 of 4 branches missed.">			if (found == true || Constants.getBoolean(&quot;updateDisableFixBrowserId&quot;))</span>
			{
<span class="fc" id="L1714">				return;</span>
			}

<span class="nc" id="L1717">			db_conn = DBPool.getConnection();</span>

			//vygeneruje vsetky mozne nazvy tabuliek, ktore obsahuju browserId (hlavne parcionovane stat_views) a ulozi do Listu
<span class="nc" id="L1720">			List&lt;String&gt; tableBrowserIdNames = UpdateDatabase.generateBrowserIdTableNames();</span>

<span class="nc" id="L1722">			int count=1;</span>

<span class="nc bnc" id="L1724" title="All 2 branches missed.">			for (String tableBrowserIdName : tableBrowserIdNames)</span>
			{
<span class="nc" id="L1726">				Logger.println(UpdateDatabase.class, &quot;Updating browserId in table &quot;+tableBrowserIdName+&quot; &quot;+count+&quot;/&quot;+tableBrowserIdNames.size());</span>

<span class="nc" id="L1728">				String sql = &quot;UPDATE &quot; + tableBrowserIdName + &quot; SET browser_id = browser_id + &quot; + Constants.getString(&quot;unloggedUserBrowserId&quot;) + &quot; WHERE browser_id &lt; &quot;+Constants.getString(&quot;loggedUserBrowserId&quot;);</span>

				try
				{
<span class="nc" id="L1732">					ps = db_conn.prepareStatement(sql);</span>
<span class="nc" id="L1733">					int updated = ps.executeUpdate();</span>
<span class="nc" id="L1734">					Logger.println(UpdateDatabase.class, &quot;Updated &quot;+tableBrowserIdName+&quot; &quot;+updated+&quot; rows&quot;);</span>
<span class="nc" id="L1735">					ps.close();</span>
<span class="nc" id="L1736">					ps = null;</span>
				}
<span class="nc" id="L1738">				catch (Exception e)</span>
				{
					// ak tabulka s danym nazvom neexistuje, vypise to a pokracuje
<span class="nc" id="L1741">					Logger.info(UpdateDatabase.class, &quot;\nTable - &quot; + tableBrowserIdName + &quot; doesn't exist.\n&quot;);</span>
					try
					{
<span class="nc bnc" id="L1744" title="All 2 branches missed.">						if (ps != null) ps.close();</span>
					}
<span class="nc" id="L1746">					catch (Exception ex2) {}</span>
<span class="nc" id="L1747">				}</span>
<span class="nc" id="L1748">				count++;</span>
<span class="nc" id="L1749">			}</span>

<span class="nc bnc" id="L1751" title="All 2 branches missed.">			if (forceUpdate == false)</span>
			{
<span class="nc" id="L1753">				saveSuccessUpdate(note);</span>
			}

<span class="nc" id="L1756">			db_conn.close();</span>
<span class="nc" id="L1757">			ps = null;</span>
<span class="nc" id="L1758">			db_conn = null;</span>
		}
<span class="nc" id="L1760">		catch (Exception ex)</span>
		{
<span class="nc" id="L1762">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="pc bpc" id="L1768" title="1 of 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1769">					rs.close();</span>
<span class="pc bpc" id="L1770" title="1 of 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1771">					ps.close();</span>
<span class="pc bpc" id="L1772" title="1 of 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1773">					db_conn.close();</span>
			}
<span class="nc" id="L1775">			catch (Exception ex2)</span>
			{
<span class="fc" id="L1777">			}</span>
		}
<span class="nc" id="L1779">	}</span>
	/**
	 * Funkcia, ktora vrati v Liste vsetky mozne nazvy tabuliek, ktore obsahuju browserId, ktore je potrebne zmenit
	 * &lt;br /&gt; Ak je nastavena konstanta statEnableTablePartitioning na false, vratia sa iba tabulky stat_from a stat_views
	 * &lt;br /&gt; Inak sa vratia vsetky particiovane tabulky od 2000_1 po aktualnu
	 *
	 * @author kmarton
	 * @return zoznam nazvov tabuliek
	 */
	private static List&lt;String&gt; generateBrowserIdTableNames()
	{
<span class="nc" id="L1790">		List&lt;String&gt; tableBrowserIdNames = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1792">		tableBrowserIdNames.add(&quot;stat_from&quot;);</span>
<span class="nc" id="L1793">		tableBrowserIdNames.add(&quot;stat_views&quot;);</span>

<span class="nc bnc" id="L1795" title="All 2 branches missed.">		if (!Constants.getBoolean(&quot;statEnableTablePartitioning&quot;))</span>
<span class="nc" id="L1796">			return tableBrowserIdNames;</span>

<span class="nc" id="L1798">		Calendar cal = Calendar.getInstance();</span>

<span class="nc bnc" id="L1800" title="All 2 branches missed.">		for (int year = 2000; year &lt; (cal.get(Calendar.YEAR)+1); year++)</span>
		{
<span class="nc bnc" id="L1802" title="All 2 branches missed.">			for (int month = 1; month &lt; 13; month++)</span>
			{
<span class="nc" id="L1804">				tableBrowserIdNames.add(&quot;stat_views_&quot;+year+&quot;_&quot;+month);</span>
<span class="nc bnc" id="L1805" title="All 4 branches missed.">				if ((year == cal.get(Calendar.YEAR)) &amp;&amp; (month == (cal.get(Calendar.MONTH)+1)))</span>
<span class="nc" id="L1806">					break;</span>
			}
		}

<span class="nc" id="L1810">		return (tableBrowserIdNames);</span>
	}

	/**
	 * Zmena konfiguracie prav pre ovladaci panel. Po novom uz nie je jedno privilegium pre vsetky polozky Ovladacieho panela, ale na pre kazdu polozku sa prava nastavuju osobitne
	 * Metoda pre vsetkych uzivatelov ktori maju Ovladaci panel (menuConfig) ako disabled_item, prida dalsich 12 prav Ovladacieho panela do disabled items
	 */
	public static void disabledItemsConfigRights()
	{
<span class="fc" id="L1819">		String note = &quot;11.01.2010 [jraska] rozdelenie pristupovych prav ovladacieho panela na jednotlive podkategorie&quot;;</span>
<span class="pc bpc" id="L1820" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L1822">		Connection db_conn = null;</span>
<span class="nc" id="L1823">		PreparedStatement ps = null;</span>
<span class="nc" id="L1824">		ResultSet rs = null;</span>
		try
		{
<span class="nc" id="L1827">			db_conn = DBPool.getConnection();</span>

<span class="nc" id="L1829">			SimpleQuery sq = new SimpleQuery();</span>
<span class="nc" id="L1830">			String [] newRights = {&quot;modUpdate&quot;,&quot;cmp_attributes&quot;,&quot;cmp_adminlog&quot;,&quot;edit_text&quot;,&quot;export_offline&quot;,&quot;cmp_clone_structure&quot;,&quot;cmp_data_deleting&quot;,&quot;cmp_server_monitoring&quot;,&quot;cmp_redirects&quot;,&quot;modRestart&quot;,&quot;cmp_crontab&quot;,&quot;make_zip_archive&quot;};</span>
			//sq.execute(&quot;&quot;, newRights[0], newRights[1], newRights[2], newRights[3], newRights[4], newRights[5], newRights[6], newRights[7], newRights[8], newRights[9], newRights[10], newRights[11]);
<span class="nc" id="L1832">			sq.execute(&quot;DELETE FROM user_disabled_items WHERE item_name IN (?,?,?,?,?,?,?,?,?,?,?,?)&quot;, (Object[])newRights);</span>

<span class="nc" id="L1834">			ps = db_conn.prepareStatement(&quot;SELECT user_id FROM user_disabled_items WHERE item_name=?&quot;);</span>
<span class="nc" id="L1835">			ps.setString(1, &quot;menuConfig&quot;);</span>
<span class="nc" id="L1836">			rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1837" title="All 2 branches missed.">			while (rs.next())</span>
			{
<span class="nc" id="L1839">				int user_id = rs.getInt(&quot;user_id&quot;);</span>
<span class="nc bnc" id="L1840" title="All 2 branches missed.">				for(int i=0;i&lt;newRights.length;i++)</span>
				{
<span class="nc" id="L1842">					sq.execute(&quot;INSERT INTO user_disabled_items(user_id,item_name) VALUES(?,?)&quot;, user_id,newRights[i]);</span>
				}

<span class="nc" id="L1845">			}</span>
<span class="nc" id="L1846">			rs.close();</span>
<span class="nc" id="L1847">			ps.close();</span>
<span class="nc" id="L1848">			db_conn.close();</span>
<span class="nc" id="L1849">			rs = null;</span>
<span class="nc" id="L1850">			ps = null;</span>
<span class="nc" id="L1851">			db_conn = null;</span>

			//zapis do DB, ze je to importnute
<span class="nc" id="L1854">			saveSuccessUpdate(note);</span>
		}
<span class="nc" id="L1856">		catch (Exception ex)</span>
		{
<span class="nc" id="L1858">			sk.iway.iwcm.Logger.error(ex);</span>
		}
		finally
		{
			try
			{
<span class="nc bnc" id="L1864" title="All 2 branches missed.">				if (rs != null)</span>
<span class="nc" id="L1865">					rs.close();</span>
<span class="nc bnc" id="L1866" title="All 2 branches missed.">				if (ps != null)</span>
<span class="nc" id="L1867">					ps.close();</span>
<span class="nc bnc" id="L1868" title="All 2 branches missed.">				if (db_conn != null)</span>
<span class="nc" id="L1869">					db_conn.close();</span>
			}
<span class="nc" id="L1871">			catch (Exception ex2)</span>
			{
<span class="nc" id="L1873">			}</span>
		}
<span class="nc" id="L1875">	}</span>


	public static void updateStatViewsColumns()
	{
<span class="fc" id="L1880">		String note = &quot;14.5.2010 [jeeff] pridanie novych stlpcov do stat_views&quot;;</span>
<span class="pc bpc" id="L1881" title="2 of 4 branches missed.">		if (Constants.getBoolean(&quot;updateDisableFixBrowserId&quot;) || isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L1883">		Connection db_conn = null;</span>
<span class="nc" id="L1884">		PreparedStatement ps = null;</span>

<span class="nc" id="L1886">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1887">		cal.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L1888">		long to = cal.getTimeInMillis();</span>
<span class="nc" id="L1889">		cal.set(Calendar.YEAR, 2000);</span>
<span class="nc" id="L1890">		cal.set(Calendar.DATE, 1);</span>
<span class="nc" id="L1891">		cal.set(Calendar.MONTH, Calendar.JANUARY);</span>
<span class="nc" id="L1892">		long from = cal.getTimeInMillis();</span>

<span class="nc" id="L1894">		String[] suffixes = StatNewDB.getTableSuffix(from, to);</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
			try
			{
<span class="nc" id="L1899">				Logger.println(UpdateDatabase.class, &quot;Updating stat_views columns &quot;+(s+1)+&quot;/&quot;+suffixes.length+&quot; &quot;+suffixes[s]);</span>

<span class="nc" id="L1901">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L1903">				StringBuilder sql = new StringBuilder(&quot;ALTER TABLE stat_views&quot;);</span>
<span class="nc" id="L1904">				sql.append(suffixes[s]);</span>
<span class="nc" id="L1905">				sql.append(' ');</span>

<span class="nc bnc" id="L1907" title="All 2 branches missed.">				if (Constants.DB_TYPE==Constants.DB_ORACLE) sql.append(&quot;ADD (browser_ua_id INT, platform_id INT, subplatform_id INT, country VARCHAR(4))&quot;);</span>
<span class="nc bnc" id="L1908" title="All 2 branches missed.">				else if (Constants.DB_TYPE==Constants.DB_MSSQL) sql.append(&quot;ADD browser_ua_id INT, platform_id INT, subplatform_id INT, country VARCHAR(4)&quot;);</span>
<span class="nc" id="L1909">				else sql.append(&quot;ADD browser_ua_id INT, ADD platform_id INT, ADD subplatform_id INT, ADD country VARCHAR(4)&quot;);</span>

<span class="nc" id="L1911">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L1912">				ps.execute();</span>
<span class="nc" id="L1913">				ps.close();</span>
<span class="nc" id="L1914">				ps = null;</span>

				//nastav prazdne hodnoty
<span class="nc" id="L1917">				sql = new StringBuilder(&quot;UPDATE stat_views&quot;);</span>
<span class="nc" id="L1918">				sql.append(suffixes[s]);</span>
<span class="nc" id="L1919">				sql.append(&quot; SET browser_ua_id=0, platform_id=0, subplatform_id=0, country='unkn'&quot;);</span>

<span class="nc" id="L1921">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L1922">				ps.execute();</span>
<span class="nc" id="L1923">				ps.close();</span>
<span class="nc" id="L1924">				db_conn.close();</span>
<span class="nc" id="L1925">				ps = null;</span>
<span class="nc" id="L1926">				db_conn = null;</span>
			}
<span class="nc" id="L1928">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1930" title="All 4 branches missed.">				if (ex.getMessage().indexOf(&quot;exist&quot;)==-1 &amp;&amp; ex.getMessage().indexOf(&quot;duplicate&quot;)==-1)</span>
				{
<span class="nc" id="L1932">					sk.iway.iwcm.Logger.error(ex);</span>
				}
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L1939" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L1940">						ps.close();</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L1942">						db_conn.close();</span>
				}
<span class="nc" id="L1944">				catch (Exception ex2)</span>
				{
<span class="nc" id="L1946">				}</span>
			}
		}

		//zapis do DB, ze je to aktualizovane
<span class="nc" id="L1951">		saveSuccessUpdate(note);</span>
<span class="nc" id="L1952">	}</span>

	public static void statErrorAddDomainId()
	{
<span class="fc" id="L1956">		String note = &quot;20.3.2024 [jeeff] stat_error add domain_id column&quot;;</span>
<span class="pc bpc" id="L1957" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

<span class="nc" id="L1959">		Connection db_conn = null;</span>
<span class="nc" id="L1960">		PreparedStatement ps = null;</span>

<span class="nc" id="L1962">		Calendar cal = Calendar.getInstance();</span>
<span class="nc" id="L1963">		cal.add(Calendar.YEAR, 1);</span>
<span class="nc" id="L1964">		long to = cal.getTimeInMillis();</span>
<span class="nc" id="L1965">		cal.set(Calendar.YEAR, 2000);</span>
<span class="nc" id="L1966">		cal.set(Calendar.DATE, 1);</span>
<span class="nc" id="L1967">		cal.set(Calendar.MONTH, Calendar.JANUARY);</span>
<span class="nc" id="L1968">		long from = cal.getTimeInMillis();</span>

<span class="nc" id="L1970">		String[] suffixes = StatNewDB.getTableSuffix(from, to);</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">		for (int s=0; s&lt;suffixes.length; s++)</span>
		{
			try
			{
<span class="nc" id="L1975">				Logger.println(UpdateDatabase.class, &quot;Add domain_id to stat_error&quot;+suffixes[s]+&quot; &quot;+(s+1)+&quot;/&quot;+suffixes.length);</span>

<span class="nc" id="L1977">				db_conn = DBPool.getConnection();</span>

<span class="nc" id="L1979">				StringBuilder sql = new StringBuilder(&quot;ALTER TABLE stat_error&quot;);</span>
<span class="nc" id="L1980">				sql.append(suffixes[s]);</span>
<span class="nc" id="L1981">				sql.append(' ');</span>

<span class="nc" id="L1983">				sql.append(&quot;ADD domain_id INT DEFAULT 0 NOT NULL&quot;);</span>

<span class="nc" id="L1985">				ps = db_conn.prepareStatement(sql.toString());</span>
<span class="nc" id="L1986">				ps.execute();</span>
<span class="nc" id="L1987">				ps.close();</span>
<span class="nc" id="L1988">				db_conn.close();</span>
<span class="nc" id="L1989">				ps = null;</span>
<span class="nc" id="L1990">				db_conn = null;</span>
			}
<span class="nc" id="L1992">			catch (Exception ex)</span>
			{
<span class="nc bnc" id="L1994" title="All 4 branches missed.">				if (ex.getMessage().indexOf(&quot;exist&quot;)==-1 &amp;&amp; ex.getMessage().indexOf(&quot;duplicate&quot;)==-1)</span>
				{
<span class="nc" id="L1996">					sk.iway.iwcm.Logger.error(ex);</span>
				}
			}
			finally
			{
				try
				{
<span class="nc bnc" id="L2003" title="All 2 branches missed.">					if (ps != null)</span>
<span class="nc" id="L2004">						ps.close();</span>
<span class="nc bnc" id="L2005" title="All 2 branches missed.">					if (db_conn != null)</span>
<span class="nc" id="L2006">						db_conn.close();</span>
				}
<span class="nc" id="L2008">				catch (Exception ex2)</span>
				{
<span class="nc" id="L2010">				}</span>
			}
		}

		//zapis do DB, ze je to aktualizovane
<span class="nc" id="L2015">		saveSuccessUpdate(note);</span>
<span class="nc" id="L2016">	}</span>

	/**
	 * Zmluvy - migracia do novej struktury, ak sa pouzivali zmluvy pred pridanim organizacie (#23935)
	 */
	public static void zmluvyOrganizacieUpdate()
	{
		//ak sa pouzivali zmluvy pred pridanim organizacie
<span class="pc bpc" id="L2024" title="1 of 2 branches missed.">		if(Constants.getInt(&quot;zmluvyApproveGroupId&quot;) != -1)</span>
		{
<span class="nc" id="L2026">			Logger.println(UpdateDatabase.class, &quot;(zmluvyOrganizacieUpdate) updating zmluvy, zmluvy_organizacia, zmluvy_organizacia_users, zmluvy_organizacia_approvers&quot;);</span>
			try {
				//ak existuje novy typ zmluv s pridanim organizacie
<span class="nc" id="L2029">				Class.forName(&quot;sk.iway.iwcm.components.zmluvy.ZmluvyOrganizaciaBean&quot;);</span>
				//ak mame zmluvy vo viacerych domenach, vytvorim pre kazdu domenu default organizaciu
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L2032">				List&lt;Integer&gt; domeny = DB.queryForList(&quot;SELECT DISTINCT domain_id FROM zmluvy&quot;);</span>
<span class="nc bnc" id="L2033" title="All 4 branches missed.">				if(domeny != null &amp;&amp; domeny.size() &gt; 0)</span>
				{
<span class="nc bnc" id="L2035" title="All 2 branches missed.">					for(Integer did : domeny)</span>
					{
<span class="nc bnc" id="L2037" title="All 2 branches missed.">						if(did.intValue() &gt; 1)</span>
						{
<span class="nc" id="L2039">							DB.execute(&quot;INSERT INTO zmluvy_organizacia (nazov, domain_id) VALUES (?, ?);&quot;, &quot;default&quot;, did);</span>
<span class="nc" id="L2040">							int orgId = DB.queryForInt(&quot;SELECT MAX(zmluvy_organizacia_id) FROM zmluvy_organizacia&quot;);</span>
<span class="nc" id="L2041">							DB.execute(&quot;UPDATE zmluvy SET organizacia_id = ? WHERE domain_id = ?&quot;, Integer.valueOf(orgId), did);</span>
						}
<span class="nc" id="L2043">					}</span>
				}
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L2046">				List&lt;Integer&gt; organizacie = DB.queryForList(&quot;SELECT zmluvy_organizacia_id FROM zmluvy_organizacia&quot;);</span>
				//migrujem schvalovatelov zo skupiny definovanej v zmluvyApproveGroupId do tabulky zmluvy_organizacia_approvers
<span class="nc bnc" id="L2048" title="All 2 branches missed.">				if(Constants.getInt(&quot;zmluvyApproveGroupId&quot;) &gt; 0)</span>
				{
<span class="nc" id="L2050">					List&lt;UserDetails&gt; approvers = UsersDB.getUsersByGroup(Constants.getInt(&quot;zmluvyApproveGroupId&quot;)); //vsetci schvalovatelia</span>
<span class="nc bnc" id="L2051" title="All 4 branches missed.">					if(approvers != null &amp;&amp; approvers.size() &gt; 0)</span>
					{
<span class="nc bnc" id="L2053" title="All 2 branches missed.">						for(UserDetails u : approvers)</span>
						{
<span class="nc bnc" id="L2055" title="All 2 branches missed.">							for(Integer oid : organizacie)</span>
<span class="nc" id="L2056">								DB.execute(&quot;INSERT INTO zmluvy_organizacia_approvers (organizacia_id, user_id) VALUES (?, ?);&quot;, oid, Integer.valueOf(u.getUserId()));</span>
<span class="nc" id="L2057">						}</span>
					}
				}
				//ak sa pouzivali zmluvy (ratam aspon s troma, ak by niekto skusal vytvarat nejake testovacie), zmigrujem tych co maju prava na modul Zmluvy presunut do zmluvy_organizacia_users
<span class="nc bnc" id="L2061" title="All 2 branches missed.">				if(DB.queryForInt(&quot;SELECT count(*) FROM zmluvy&quot;) &gt; 2)</span>
				{
<span class="nc" id="L2063">					List&lt;UserDetails&gt; admins = UsersDB.getAdmins();</span>
<span class="nc bnc" id="L2064" title="All 4 branches missed.">					if(admins != null &amp;&amp; admins.size() &gt; 0)</span>
					{
<span class="nc bnc" id="L2066" title="All 2 branches missed.">						for(UserDetails u : admins)</span>
						{
<span class="nc bnc" id="L2068" title="All 2 branches missed.">							if(DB.queryForInt(&quot;SELECT count(*) FROM user_disabled_items WHERE user_id=? AND item_name = ?&quot;, Integer.valueOf(u.getUserId()), &quot;cmp_zmluvy&quot;) == 0)</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">								for(Integer oid : organizacie)</span>
<span class="nc" id="L2070">									DB.execute(&quot;INSERT INTO zmluvy_organizacia_users (organizacia_id, user_id) VALUES (?, ?);&quot;, oid, Integer.valueOf(u.getUserId()));</span>
<span class="nc" id="L2071">						}</span>
					}
				}
				//vymazem z premennych
<span class="nc bnc" id="L2075" title="All 2 branches missed.">				if (ConfDB.deleteName(&quot;zmluvyApproveGroupId&quot;))</span>
				{
<span class="nc bnc" id="L2077" title="All 4 branches missed.">					if (Constants.deleteConstant(&quot;zmluvyApproveGroupId&quot;) &amp;&amp; ClusterDB.isServerRunningInClusterMode())</span>
<span class="nc" id="L2078">						ClusterDB.addRefresh(&quot;sk.iway.iwcm.system.ConfDB-zmluvyApproveGroupId&quot;);</span>
				}
<span class="nc" id="L2080">			} catch( ClassNotFoundException e ) {</span>
				//my class isn't there!
			}
<span class="nc" id="L2083">			catch( Exception ex ) {</span>
				//asi nastala SQL chyba
<span class="nc" id="L2085">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L2086">			}</span>
		}
<span class="fc" id="L2088">	}</span>
	public static void mediaGroupsUpdate()
	{
<span class="pc bpc" id="L2091" title="1 of 2 branches missed.">		if (&quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;))) return;</span>

		try
		{
			//tu si cachujeme vlozene media skupiny, nech nemusime po to chodit stale do DB

<span class="fc" id="L2097">			Map&lt;String, Integer&gt; groupIdTable = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L2099">			int rows = DB.queryForInt(&quot;SELECT count(*) FROM media_group_to_media&quot;); // ak este nieje ziadny zaznam, spustim import</span>
<span class="pc bpc" id="L2100" title="1 of 2 branches missed.">			if (rows == 0)</span>
			{
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L2103">				List&lt;Number&gt; media = DB.queryForList(&quot;SELECT media_id FROM media&quot;);</span>
<span class="nc bnc" id="L2104" title="All 4 branches missed.">				if (media != null &amp;&amp; media.size() &gt; 0)</span>
				{
<span class="nc bnc" id="L2106" title="All 2 branches missed.">					for (Number m : media)</span>
					{
<span class="nc" id="L2108">						String oldGroups = DB.queryForString(&quot;SELECT media_group FROM media WHERE media_id = ?&quot;, m);</span>
<span class="nc bnc" id="L2109" title="All 2 branches missed.">						if (oldGroups != null)</span>
						{
							//String[] oldGroupsArray = oldGroups.split(&quot;,&quot;);
<span class="nc" id="L2112">							String[] oldGroupsArray = Tools.getTokens(oldGroups, &quot;,&quot;, true);</span>

<span class="nc bnc" id="L2114" title="All 2 branches missed.">							for (String g : oldGroupsArray)</span>
							{
<span class="nc" id="L2116">								Integer mediaGroupId = groupIdTable.get(g);</span>
<span class="nc bnc" id="L2117" title="All 2 branches missed.">								if (mediaGroupId == null)</span>
								{
<span class="nc" id="L2119">									int newGroupId = DB.queryForInt(&quot;SELECT media_group_id FROM media_groups WHERE media_group_name = ?&quot;, g);</span>
<span class="nc bnc" id="L2120" title="All 2 branches missed.">									if (newGroupId == 0)</span>
									{
<span class="nc" id="L2122">										DB.execute(&quot;INSERT INTO media_groups (media_group_id, media_group_name) VALUES (?, ?)&quot;, PkeyGenerator.getNextValue(&quot;MediaGroup&quot;), g);</span>
<span class="nc" id="L2123">										Logger.info(UpdateDatabase.class, &quot;Vytvaram novu media skupinu: &quot; + g + &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L2124">										newGroupId = DB.queryForInt(&quot;SELECT media_group_id FROM media_groups WHERE media_group_name = ?&quot;, g);</span>
									}
									//vloz do cache pre dalsie pouzitie
<span class="nc" id="L2127">									mediaGroupId = Integer.valueOf(newGroupId);</span>
<span class="nc" id="L2128">									groupIdTable.put(g, mediaGroupId);</span>
								}

								try
								{
									//robime priamo insert, ak by bola duplicita, tak to padne, je to vyrazne rychlejsie ako neustale testovat ci uz zaznam existuje
<span class="nc" id="L2134">									DB.execute(&quot;INSERT INTO media_group_to_media (media_group_id, media_id) VALUES (?,?)&quot;, mediaGroupId, m);</span>
<span class="nc" id="L2135">									Logger.info(UpdateDatabase.class, &quot;Priradujem media skupinu: &quot; + g + &quot; ku mediu s ID &quot; + m + &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L2136">								} catch (Exception ex) {}</span>
							}
						}
<span class="nc" id="L2139">					}</span>
				}
			}
		}
<span class="nc" id="L2143">		catch (Exception ex)</span>
		{
<span class="nc" id="L2145">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L2146">		}</span>
<span class="fc" id="L2147">	}</span>

    /**
     * Nastavi map providera na GoogleMap ak je neprazdna konf. premenna googleMapsApiKey (lebo default je OpenStreetMap)
     */
    public static void setDefaultMapProvider()
    {
<span class="fc" id="L2154">		String note = &quot;10.03.2018 [lbalat] nastavenie defaultneho map providera podla nastavenia googleMapsApiKey&quot;;</span>
<span class="pc bpc" id="L2155" title="1 of 2 branches missed.">		if (isAllreadyUpdated(note)) return;</span>

		try
		{
<span class="nc bnc" id="L2159" title="All 2 branches missed.">			if (Tools.isNotEmpty(Constants.getString(&quot;googleMapsApiKey&quot;)))</span>
			{
<span class="nc" id="L2161">					SimpleQuery sq = new SimpleQuery();</span>
<span class="nc" id="L2162">					sq.execute(&quot;INSERT INTO &quot; + ConfDB.CONF_TABLE_NAME + &quot; (name, value) VALUES ('mapProvider', 'GoogleMap')&quot;);</span>
			}
		}
<span class="nc" id="L2165">		catch (Exception ex)</span>
		{
			//ak to padlo, asi uz je konf. premenna mapProvider nastavena, nevadi, povazujeme za vybavene
<span class="nc" id="L2168">		}</span>

<span class="nc" id="L2170">		saveSuccessUpdate(note);</span>
<span class="nc" id="L2171">    }</span>

	public static void updateMediaDomainIdColumn() {
<span class="fc" id="L2174">		String note = &quot;8.6.2023 [sivan] pridanie stlpcu domain_id do tabulky media&quot;;</span>
<span class="pc bpc" id="L2175" title="2 of 4 branches missed.">		if(!Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;) || isAllreadyUpdated(note)) return;</span>

		try {
			//We are using DISTINCT, because we set same domainid for all media records that obtain same media_fk_id (aka docId)
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L2180">			List&lt;Number&gt; mediaFkIds = DB.queryForList(&quot;SELECT DISTINCT media_fk_id FROM media&quot;);</span>

<span class="nc bnc" id="L2182" title="All 2 branches missed.">			for(Number mediaFkId : mediaFkIds) {</span>

<span class="nc" id="L2184">				DocDB docDB = DocDB.getInstance();</span>
<span class="nc" id="L2185">				String domain = docDB.getDomain(mediaFkId.intValue());</span>

<span class="nc" id="L2187">				Integer domainId = GroupsDB.getDomainId(domain);</span>
<span class="nc bnc" id="L2188" title="All 2 branches missed.">				if(domainId == -1) domainId = 1;</span>

				try {
					//Set domain id based on media_fk_id (aka docId)
<span class="nc" id="L2192">					DB.execute(&quot;UPDATE media SET domain_id = ? WHERE media_fk_id = ?&quot;, domainId, mediaFkId);</span>
<span class="nc" id="L2193">					Logger.info(UpdateDatabase.class, &quot;Nastavujem media domainId = &quot; + domainId + &quot; pre docId = &quot; + mediaFkId + &quot; &lt;br&gt;&quot;);</span>
<span class="nc" id="L2194">				} catch (Exception ex) {}</span>
<span class="nc" id="L2195">			}</span>

<span class="nc" id="L2197">		} catch (Exception e) {</span>
<span class="nc" id="L2198">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L2199">		}</span>

		//zapis do DB, ze domain_id stlpec bol uz aktualizovany
<span class="nc" id="L2202">		saveSuccessUpdate(note);</span>
<span class="nc" id="L2203">	}</span>

	public static void updateEmailsCampainDomainIdColumn() {
<span class="fc" id="L2206">		String note = &quot;18.3.2024 [sivan] pridanie stlpcu domain_id do tabulky emails_campain&quot;;</span>
<span class="pc bpc" id="L2207" title="1 of 2 branches missed.">		if(isAllreadyUpdated(note)) return;</span>

		try {
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L2211">			List&lt;String&gt; emailsCampainUrl = DB.queryForList(&quot;SELECT DISTINCT url FROM emails_campain&quot;);</span>

<span class="nc bnc" id="L2213" title="All 2 branches missed.">			for(String url : emailsCampainUrl) {</span>
<span class="nc" id="L2214">				int domainId = getDomainIdBasedOnUrl(url);</span>

				try {
					//Set domain id based on URL
<span class="nc" id="L2218">					DB.execute(&quot;UPDATE emails_campain SET domain_id = ? WHERE url = ?&quot;, domainId, url);</span>
<span class="nc" id="L2219">					Logger.info(UpdateDatabase.class, &quot;Setting emails_campain domainId = &quot; + domainId + &quot; for url = &quot; + url);</span>
<span class="nc" id="L2220">				} catch (Exception ex) {}</span>

				try {
					//Set domain id based on URL
<span class="nc" id="L2224">					DB.execute(&quot;UPDATE emails SET domain_id = ? WHERE url LIKE ?&quot;, domainId, url+&quot;%&quot;);</span>
<span class="nc" id="L2225">					Logger.info(UpdateDatabase.class, &quot;Settings emails domainId = &quot; + domainId + &quot; for url = &quot; + url);</span>
<span class="nc" id="L2226">				} catch (Exception ex) {}</span>
<span class="nc" id="L2227">			}</span>

<span class="nc" id="L2229">		} catch (Exception e) {</span>
<span class="nc" id="L2230">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L2231">		}</span>

		//zapis do DB, ze domain_id stlpec bol uz aktualizovany
<span class="nc" id="L2234">		saveSuccessUpdate(note);</span>
<span class="nc" id="L2235">	}</span>

	private static int getDomainIdBasedOnUrl(String url) throws Exception {
<span class="nc" id="L2238">		int domainId = 1;</span>
<span class="nc bnc" id="L2239" title="All 2 branches missed.">		if( Tools.isNotEmpty(url) ) {</span>
<span class="nc" id="L2240">			DocDetails doc = WebpagesService.getBasicDocFromUrl(url);</span>
<span class="nc bnc" id="L2241" title="All 2 branches missed.">			if(doc != null) {</span>
<span class="nc" id="L2242">				GroupDetails group = doc.getGroup();</span>
<span class="nc bnc" id="L2243" title="All 2 branches missed.">				if(group != null) {</span>
<span class="nc" id="L2244">					String domainName = group.getDomainName();</span>
<span class="nc bnc" id="L2245" title="All 2 branches missed.">					if( Tools.isNotEmpty(domainName) ) {</span>
<span class="nc" id="L2246">						domainId = GroupsDB.getDomainId(domainName);</span>
<span class="nc bnc" id="L2247" title="All 2 branches missed.">						if(domainId &lt; 1) domainId = 1;</span>
					}
				}
<span class="nc" id="L2250">			} else {</span>
				try {
					//get domainId from URL
<span class="nc bnc" id="L2253" title="All 2 branches missed.">					if (url.startsWith(&quot;http&quot;)) {</span>
<span class="nc" id="L2254">						int to = url.indexOf(&quot;/&quot;, 8);</span>
<span class="nc bnc" id="L2255" title="All 2 branches missed.">						if (to==-1) to = url.indexOf(&quot;:&quot;, 8);</span>
<span class="nc bnc" id="L2256" title="All 2 branches missed.">						if (to==-1) to = url.indexOf(&quot;?&quot;, 8);</span>

<span class="nc" id="L2258">						String domainName = url.substring(url.indexOf(&quot;://&quot;)+3, to);</span>
<span class="nc" id="L2259">						int portDelimiter = domainName.indexOf(&quot;:&quot;);</span>
<span class="nc bnc" id="L2260" title="All 2 branches missed.">						if (portDelimiter &gt; 0) domainName = domainName.substring(0, portDelimiter);</span>

<span class="nc" id="L2262">						domainId = GroupsDB.getDomainId(domainName);</span>
					}
<span class="nc" id="L2264">				} catch (Exception e) {</span>
					//do nothing
<span class="nc" id="L2266">				}</span>
			}
		}

<span class="nc" id="L2270">		return domainId;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>