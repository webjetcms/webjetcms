<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DocForumService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.components.forum.rest</a> &gt; <span class="el_source">DocForumService.java</span></div><h1>DocForumService.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.components.forum.rest;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.StringTokenizer;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.web.multipart.commons.CommonsMultipartFile;

import sk.iway.Password;
import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.LabelValueDetails;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.SpamProtection;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.common.ForumTools;
import sk.iway.iwcm.common.SearchTools;
import sk.iway.iwcm.components.forum.jpa.DocForumEntity;
import sk.iway.iwcm.components.forum.jpa.DocForumIdAndParentId;
import sk.iway.iwcm.components.forum.jpa.DocForumRepository;
import sk.iway.iwcm.components.forum.jpa.ForumGroupEntity;
import sk.iway.iwcm.database.ComplexQuery;
import sk.iway.iwcm.database.Mapper;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.doc.ShowDoc;
import sk.iway.iwcm.forum.ForumDB;
import sk.iway.iwcm.forum.ForumSortBy;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.system.datatable.json.LabelValue;
import sk.iway.iwcm.system.fulltext.indexed.Forums;
import sk.iway.iwcm.users.UsersDB;
import sk.iway.spirit.MediaDB;
import sk.iway.spirit.model.Media;

public class DocForumService {

    private static final String SAVE_FORUM_SUCCESS = &quot;/components/forum/saveok&quot;;

	private DocForumService() {
		//utility class
	}

	/**
	 * Represent recursive action's upon forum's.
	 */
<span class="fc" id="L73">	public enum ActionType {</span>
<span class="fc" id="L74">		DELETE, //Delete forum recursive (with all child's)</span>
<span class="fc" id="L75">		RECOVER, //Recover forum recursive (with all child's)</span>
<span class="fc" id="L76">		APPROVE, //Approve forum recursive (with all child's)</span>
<span class="fc" id="L77">		REJECT, //Reject forum recursive (with all child's)</span>
<span class="fc" id="L78">		LOCK, //Lock forum recursive (with all child's)</span>
<span class="fc" id="L79">		UNLOCK //Unlock forum recursive (with all child's)</span>
	}

    /**
     * Return icon options for status icon select.
     * @param prop
     * @return
     */
    public static List&lt;LabelValue&gt; getStatusIconOptions(Prop prop) {
<span class="fc" id="L88">		List&lt;LabelValue&gt; icons = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L90">        icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-circle-check\&quot; style=\&quot;color: #00be9f;\&quot;&gt;&lt;/i&gt; &quot; + prop.getText(&quot;apps.forum.icon.confirmed&quot;), &quot;confirmed:true&quot;));</span>
<span class="fc" id="L91">        icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-circle-x\&quot; style=\&quot;color: #ff4b58;\&quot;&gt;&lt;/i&gt; &quot; + prop.getText(&quot;apps.forum.icon.non_confirmed&quot;), &quot;confirmed:false&quot;));</span>
<span class="fc" id="L92">        icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-lock\&quot; style=\&quot;color: #000000;\&quot;&gt;&lt;/i&gt; &quot; + prop.getText(&quot;apps.forum.icon.non_active&quot;), &quot;active:false&quot;));</span>
<span class="fc" id="L93">        icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-lock-open\&quot; style=\&quot;color: #000000;\&quot;&gt;&lt;/i&gt; &quot; + prop.getText(&quot;apps.forum.icon.active&quot;), &quot;active:true&quot;));</span>
<span class="fc" id="L94">        icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-trash\&quot; style=\&quot;color: #fabd00;\&quot;&gt;&lt;/i&gt; &quot; + prop.getText(&quot;apps.forum.icon.deleted&quot;), &quot;deleted:true&quot;));</span>
<span class="fc" id="L95">        icons.add(new LabelValue(&quot;&lt;i class=\&quot;ti ti-trash-off\&quot; style=\&quot;color: #fabd00;\&quot;&gt;&lt;/i&gt; &quot; + prop.getText(&quot;apps.forum.icon.not_deleted&quot;), &quot;deleted:false&quot;));</span>

<span class="fc" id="L97">		return icons;</span>
	}

	/******************************* MAIN LOGIC methods (save / delete / recover / approve / reject) ****************************************** */

	/**
	 * Save given ForumFormBean entity, update and send confirmation notification email
	 *
	 * @param request
	 * @param response
	 * @param forumForm - entity to be saved (forum)
	 * @return
	 * @throws IOException
	 */
    public static String saveDocForum(HttpServletRequest request, HttpServletResponse response, DocForumEntity forumForm) {
<span class="fc" id="L112">		DocForumRepository docForumRepository = getDocForumRepository();</span>
<span class="fc" id="L113">		HttpSession session = request.getSession();</span>
<span class="fc" id="L114">		Identity sender = (Identity) session.getAttribute(Constants.USER_KEY);</span>

<span class="fc" id="L116">		Integer domainId = Tools.getIntValue(DocDB.getDomain(request), 1);</span>
<span class="fc" id="L117">		int userId = -1;</span>
		String hashCode;

<span class="fc" id="L120">		RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="fc" id="L121">		String language = rb.getLng();</span>
<span class="fc" id="L122">		Prop prop = Prop.getInstance(language);</span>

<span class="pc bpc" id="L124" title="1 of 4 branches missed.">		if (sender == null || sender.isAdmin() == false) {</span>
<span class="fc" id="L125">			synchronized (DocForumRepository.class) {</span>
				//kontrola pred duplicitnym odoslanim prispevku (nejaka ajax haluz) - http://helpdesk.interway.sk/?bugID=4676
				//v access logu servera sa zaznamy skutocne nasli viac krat, preco nikto netusi
<span class="fc" id="L128">				String lastSessionText = (String)session.getAttribute(&quot;DocForumRepository.lastText&quot;);</span>
<span class="pc bpc" id="L129" title="3 of 4 branches missed.">				if (lastSessionText!=null &amp;&amp; lastSessionText.equals(forumForm.getQuestion())) {</span>
<span class="nc" id="L130">					setPermissionDenied(request, &quot;sameText&quot;);</span>
<span class="nc" id="L131">					return SAVE_FORUM_SUCCESS;</span>
				}

<span class="fc" id="L134">				session.setAttribute(&quot;DocForumRepository.lastText&quot;, forumForm.getQuestion());</span>
<span class="fc" id="L135">			}</span>
		}

		//Get forum group aka setting
<span class="fc" id="L139">		ForumGroupEntity forumGroup = ForumGroupService.getForum(forumForm.getDocId(), true);</span>

		//Check if parent we answering to (if set) is active
		//If not permit this comment / forum ...
<span class="fc bfc" id="L143" title="All 2 branches covered.">		if(forumForm.getParentId() &gt; 0) {</span>
<span class="fc" id="L144">			boolean isParentActive = (new SimpleQuery()).forBoolean(&quot;SELECT active FROM document_forum WHERE forum_id=?&quot;, forumForm.getParentId());</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">			if(!isParentActive) {</span>
<span class="nc" id="L146">				boolean isAdmin = false;</span>
<span class="nc bnc" id="L147" title="All 4 branches missed.">				if(forumGroup != null &amp;&amp; forumGroup.isAdmin(sender)) isAdmin = true;</span>

				//Only admin can be exception for restriction
<span class="nc bnc" id="L150" title="All 2 branches missed.">				if(!isAdmin) {</span>
<span class="nc" id="L151">					setError(request, prop.getText(&quot;components.forum.active.error&quot;));</span>
<span class="nc" id="L152">					return SAVE_FORUM_SUCCESS;</span>
				}
			}
		}

<span class="pc bpc" id="L157" title="1 of 2 branches missed.">		if (forumGroup == null) {</span>
			//najdi parent adresar a skus podla neho
<span class="nc" id="L159">			DocDetails docDetails = DocDB.getInstance().getBasicDocDetails(forumForm.getDocId(), false);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">			if (docDetails != null) {</span>
<span class="nc" id="L161">				GroupDetails group = GroupsDB.getInstance().getGroup(docDetails.getGroupId());</span>
<span class="nc bnc" id="L162" title="All 2 branches missed.">				if (group != null) {</span>
<span class="nc" id="L163">					GroupDetails parentGroup = GroupsDB.getInstance().getGroup(group.getParentGroupId());</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">					if (parentGroup!=null)</span>
<span class="nc" id="L165">						forumGroup = ForumGroupService.getForum(parentGroup.getDefaultDocId(), true);</span>
				}
			}
		}

<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        if (forumGroup == null) {</span>
<span class="nc" id="L171">            DocDetails docDetails = DocDB.getInstance().getDoc(forumForm.getDocId());</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (docDetails != null) {</span>
<span class="nc" id="L173">                int defaultDocId = docDetails.getGroup().getDefaultDocId();</span>
<span class="nc" id="L174">                DocDetails defaultDocDetails = DocDB.getInstance().getDoc(defaultDocId);</span>
<span class="nc" id="L175">                forumGroup = ForumGroupService.getForum(defaultDocDetails.getDocId(), true);</span>
            }
        }

<span class="fc" id="L179">		ForumGroupEntity forumGroupPerms = forumGroup;</span>
<span class="pc bpc" id="L180" title="3 of 4 branches missed.">		if (forumGroupPerms == null &amp;&amp; Tools.isNotEmpty(Constants.getString(&quot;forumDefaultAddmessageGroups&quot;))) {</span>
<span class="nc" id="L181">			forumGroupPerms = new ForumGroupEntity();</span>
<span class="nc" id="L182">			forumGroupPerms.setAddmessageGroups(Constants.getString(&quot;forumDefaultAddmessageGroups&quot;));</span>
		}

<span class="pc bpc" id="L185" title="2 of 4 branches missed.">		if (forumGroupPerms != null &amp;&amp; forumGroupPerms.canPostMessage(sender)==false) {</span>
			//nema dostatocne prava (kontrola user groups)
<span class="nc" id="L187">			setError(request, &quot;components.forum.wrong_user_groups_for_post&quot;);</span>
<span class="nc" id="L188">			return SAVE_FORUM_SUCCESS;</span>
		}

<span class="pc bpc" id="L191" title="5 of 6 branches missed.">		if (ForumGroupService.isActive(forumForm.getDocId()) == false &amp;&amp; (sender == null || sender.isAdmin() == false)) {</span>
<span class="nc" id="L192">			setError(request, &quot;components.forum.forum_closed&quot;);</span>
<span class="nc" id="L193">			return SAVE_FORUM_SUCCESS;</span>
		}

<span class="pc bpc" id="L196" title="2 of 4 branches missed.">		if (isVulgar(forumForm.getAuthorName()) || isVulgar(forumForm.getAuthorEmail()) ||</span>
<span class="pc bpc" id="L197" title="2 of 4 branches missed.">			 isVulgar(forumForm.getQuestion()) || isVulgar(forumForm.getSubject()) ||</span>
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">			 ShowDoc.getXssRedirectUrl(request)!=null)</span>
		{
<span class="nc" id="L200">			request.setAttribute(&quot;isVulgar&quot;, &quot;true&quot;);</span>
<span class="nc" id="L201">			return SAVE_FORUM_SUCCESS;</span>
		}

<span class="fc" id="L204">		String plainQuestion = SearchTools.htmlToPlain(forumForm.getQuestion());</span>
<span class="fc" id="L205">		plainQuestion = Tools.replace(plainQuestion, &quot;\n&quot;, &quot;&quot;);</span>
<span class="fc" id="L206">		plainQuestion = Tools.replace(plainQuestion, &quot;\r&quot;, &quot;&quot;);</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">		if (&quot;true&quot;.equals(request.getParameter(&quot;forumAllowEmptyMessage&quot;))==false &amp;&amp;</span>
<span class="pc bpc" id="L208" title="2 of 4 branches missed.">			 (Tools.isEmpty(forumForm.getQuestion()) || Tools.isEmpty(plainQuestion)))</span>
		{
<span class="nc" id="L210">			setError(request, &quot;components.forum.error.questionEmpty&quot;);</span>
<span class="nc" id="L211">			return SAVE_FORUM_SUCCESS;</span>
		}

		//fixni hlasku o nahravani editora (ak tam je)
<span class="fc" id="L215">		forumForm.setQuestion(Tools.replace(forumForm.getQuestion(), prop.getText(&quot;editor.loading_please_wait&quot;), &quot;&quot;));</span>

		//ak je vypnuty wysiwyg editor, tak nedovol HTML
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;disableWysiwyg&quot;)) {</span>
<span class="nc" id="L219">			String oldText = forumForm.getQuestion();</span>
<span class="nc" id="L220">			String newText = oldText.replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;);</span>
<span class="nc" id="L221">			newText = newText.replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;);</span>
<span class="nc" id="L222">			newText = newText.replace(&quot;\n&quot;, &quot;&lt;br /&gt;&quot;);</span>
<span class="nc" id="L223">			forumForm.setQuestion(newText);</span>
		}

		//nastav linkam nofollow
<span class="fc" id="L227">		forumForm.setQuestion(Tools.replace(forumForm.getQuestion(), &quot;&lt;a href&quot;, &quot;&lt;a rel=\&quot;nofollow\&quot; href&quot;));</span>
<span class="fc" id="L228">		forumForm.setQuestion(Tools.replace(forumForm.getQuestion(), &quot;&lt;A HREF&quot;, &quot;&lt;a rel=\&quot;nofollow\&quot; href&quot;));</span>

<span class="pc bpc" id="L230" title="1 of 4 branches missed.">		if (sender == null || sender.isAdmin() == false) forumForm.setId((long) -1);</span>

<span class="fc bfc" id="L232" title="All 2 branches covered.">		if (sender != null) userId = sender.getUserId();</span>

		//Clear MsOffice tags from question
<span class="fc" id="L235">		forumForm.setQuestion( clearMsOfficeTags( forumForm.getQuestion() ) );</span>

<span class="fc" id="L237">		hashCode = Password.generatePassword(15);</span>

<span class="pc bpc" id="L239" title="3 of 6 branches missed.">		if (sender != null &amp;&amp; Tools.isNotEmpty(sender.getSignature()) &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;addSignature&quot;))) {</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">			if (&quot;true&quot;.equals(request.getParameter(&quot;dontReplaceSignatureCodes&quot;)))</span>
<span class="nc" id="L241">				forumForm.setQuestion(forumForm.getQuestion() + &quot;&lt;div class='forumSignature'&gt;&quot;+sender.getSignature()+&quot;&lt;/div&gt;&quot;);</span>
			else
<span class="nc" id="L243">				forumForm.setQuestion(forumForm.getQuestion() + &quot;&lt;div class='forumSignature'&gt;&quot;+ ForumTools.replaceSignatureCodes(sender)+&quot;&lt;/div&gt;&quot;);</span>
		}

<span class="pc bpc" id="L246" title="1 of 2 branches missed.">		if (!SpamProtection.canPost(&quot;forum&quot;, forumForm.getQuestion(), request)) {</span>
<span class="nc" id="L247">			setPermissionDenied(request, &quot;postLimit&quot;);</span>
<span class="nc" id="L248">			return SAVE_FORUM_SUCCESS;</span>
		}

<span class="fc bfc" id="L251" title="All 2 branches covered.">		if (sender != null) {</span>
			//ako autora povolime len login, alebo meno
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">			if (sender.getLogin().equals(forumForm.getAuthorName())==false) forumForm.setAuthorName(sender.getFullName());</span>
<span class="fc" id="L254">			forumForm.setAuthorEmail(sender.getEmail());</span>
		}

<span class="fc bfc" id="L257" title="All 2 branches covered.">		if (forumForm.getParentId() == -1) {</span>
			//
<span class="fc" id="L259">			prepareForumForSave(forumForm, forumGroup, sender, request, hashCode, userId, true);</span>
<span class="fc" id="L260">			docForumRepository.save(forumForm);</span>
<span class="fc" id="L261">			Adminlog.add(Adminlog.TYPE_FORUM_CREATE, &quot;Vytvorena tema diskusie: &quot;+forumForm.getSubject(), -1, forumForm.getDocId());</span>
		} else {
			//
<span class="fc" id="L264">			prepareForumForSave(forumForm, forumGroup, sender, request, hashCode, userId, false);</span>
<span class="fc" id="L265">			docForumRepository.save(forumForm);</span>

			//Update SUBTOPIC by incrementing statReplies and setting actual lastPost Date
<span class="fc" id="L268">			int fId = ForumDB.getForumMessageParent(forumForm.getParentId(), forumForm.getDocId());</span>
<span class="fc bfc" id="L269" title="All 2 branches covered.">			if (fId &gt; 0) docForumRepository.updateSubtopic(new Date(), Long.valueOf(fId), domainId);</span>

<span class="fc" id="L271">			Adminlog.add(Adminlog.TYPE_FORUM_CREATE, &quot;Vytvoreny prispevok: &quot;+forumForm.getSubject(), -1, forumForm.getDocId());</span>
		}

		//If user is logged, increment user forum rank
<span class="fc bfc" id="L275" title="All 2 branches covered.">		if(userId &gt; 0) (new SimpleQuery()).execute(&quot;UPDATE users SET forum_rank=forum_rank+1 WHERE user_id=?&quot;, userId);</span>

		//Increment WebPage forum_count
<span class="fc" id="L278">		(new SimpleQuery()).execute(&quot;UPDATE documents SET forum_count=forum_count+1 WHERE doc_id=?&quot;, forumForm.getDocId());</span>

		//get new forum ID and set it into forum form
<span class="fc bfc" id="L281" title="All 2 branches covered.">		if (forumForm.getId() &lt; 1)</span>
<span class="fc" id="L282">			forumForm.setId( new SimpleQuery().forLong(&quot;SELECT max(forum_id) AS forum_id FROM document_forum WHERE doc_id = ? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true), forumForm.getDocId()) );</span>

		//Set default forum group values
<span class="pc bpc" id="L285" title="1 of 2 branches missed.">		if (forumGroup == null) {</span>
<span class="nc" id="L286">			String forumDefaultApproveEmail = Constants.getString(&quot;forumDefaultApproveEmail&quot;);</span>
<span class="nc" id="L287">			String forumDefaultNotifyEmail = Constants.getString(&quot;forumDefaultNotifyEmail&quot;);</span>

<span class="nc bnc" id="L289" title="All 4 branches missed.">			if (Tools.isNotEmpty(forumDefaultApproveEmail) || Tools.isNotEmpty(forumDefaultNotifyEmail)) {</span>
<span class="nc" id="L290">				forumGroup = new ForumGroupEntity();</span>
<span class="nc" id="L291">				forumGroup.setMessageConfirmation(false);</span>

<span class="nc bnc" id="L293" title="All 2 branches missed.">				if (Tools.isNotEmpty(forumDefaultApproveEmail)) {</span>
<span class="nc" id="L294">					forumGroup.setApproveEmail(forumDefaultApproveEmail);</span>
<span class="nc" id="L295">					forumGroup.setMessageConfirmation(true);</span>
				}

<span class="nc bnc" id="L298" title="All 2 branches missed.">				if (Tools.isNotEmpty(forumDefaultNotifyEmail))</span>
<span class="nc" id="L299">					forumGroup.setNotifEmail(forumDefaultNotifyEmail);</span>
			}
		}

		//Send confirmation email
<span class="fc" id="L304">		DocForumEmailService emailService = new DocForumEmailService(forumForm, forumGroupPerms, request, prop);</span>
<span class="fc" id="L305">		emailService.sendForumEmails();</span>

<span class="fc" id="L307">		String fromName = Constants.getString(&quot;forumNotifySenderName&quot;);</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">		if(Tools.isEmpty(fromName)) fromName = forumForm.getAuthorName();</span>

<span class="fc" id="L310">		String fromEmail = Constants.getString(&quot;forumNotifySenderEmail&quot;);</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">		if (Tools.isEmpty(fromEmail)) fromEmail = forumForm.getAuthorEmail();</span>

<span class="pc bpc" id="L313" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(fromName)) {</span>
			//uloz meno a email do cookies
<span class="fc" id="L315">			Cookie forumName = new Cookie(&quot;forumname&quot;, Tools.URLEncode(fromName));</span>
<span class="fc" id="L316">			forumName.setPath(&quot;/&quot;);</span>
<span class="fc" id="L317">			forumName.setMaxAge(60 * 24 * 3600);</span>
<span class="fc" id="L318">			forumName.setHttpOnly(true);</span>

<span class="fc" id="L320">			Cookie forumEmail = new Cookie(&quot;forumemail&quot;, Tools.URLEncode(fromEmail));</span>
<span class="fc" id="L321">			forumEmail.setPath(&quot;/&quot;);</span>
<span class="fc" id="L322">			forumEmail.setMaxAge(60 * 24 * 3600);</span>
<span class="fc" id="L323">			forumEmail.setHttpOnly(true);</span>

<span class="fc" id="L325">			Tools.addCookie(forumName, response, request);</span>
<span class="fc" id="L326">			Tools.addCookie(forumEmail, response, request);</span>
		}

<span class="fc" id="L329">		Forums.updateSingleQuestion(forumForm.getId().intValue());</span>

		//return link to saveok.jsp
<span class="fc" id="L332">		return SAVE_FORUM_SUCCESS;</span>
	}

	/**
	 * Perform recursive supported action uppon forum.
	 * More details in this fn code coments.
	 *
	 * @param actionType - Supported recursive actions
	 * @param forumId
	 * @param docId
	 * @param user - logged user
	 * @return
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public static boolean docForumRecursiveAction(ActionType actionType, int forumId, int docId, Identity user) {
		//There must be logged user
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">		if(user == null) return true;</span>

<span class="fc" id="L350">		String domainSql = CloudToolsForCore.getDomainIdSqlWhere(true);</span>

		//Get all forum's under this one (all child's)
<span class="fc" id="L353">		List&lt;DocForumEntity&gt; msgList = getForumFieldsForDoc(actionType, docId, forumId, true);</span>
<span class="fc" id="L354">		String fIds = getChildForumIdsRecursive(msgList, forumId);</span>

<span class="fc bfc" id="L356" title="All 2 branches covered.">		if (Tools.isNotEmpty(fIds)) fIds += forumId;</span>
<span class="fc" id="L357">		else fIds = Integer.toString(forumId);</span>

<span class="fc" id="L359">		boolean isAdmin = user.isAdmin();</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">		if (isAdmin == false) {</span>
<span class="nc" id="L361">			ForumGroupEntity forumGroupBean = ForumGroupService.getForum(docId, false);</span>
<span class="nc" id="L362">			isAdmin = forumGroupBean.isAdmin(user);</span>
		}

		//Customize query
<span class="fc" id="L366">		StringBuilder simpleQuery = new StringBuilder(&quot;SELECT user_id FROM document_forum WHERE forum_id IN (&quot; + fIds + &quot;)&quot; + domainSql);</span>
<span class="fc bfc" id="L367" title="All 2 branches covered.">		if(actionType == ActionType.DELETE) simpleQuery.append(&quot; AND deleted &lt; 1&quot;); //Because change will affect only NON-Deleted forum's</span>
<span class="fc bfc" id="L368" title="All 2 branches covered.">		else if(actionType == ActionType.RECOVER) simpleQuery.append(&quot; AND deleted &gt; 0&quot;); //Because change will affect only Deleted forum's</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">		else if(actionType == ActionType.APPROVE) simpleQuery.append(&quot; AND confirmed &lt; 1&quot;); //Because change will affect only NON-Confirmed forum's</span>
<span class="fc bfc" id="L370" title="All 2 branches covered.">		else if(actionType == ActionType.REJECT) simpleQuery.append(&quot; AND confirmed &gt; 0&quot;); //Because change will affect only Confirmed forum's</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">		else if(actionType == ActionType.LOCK) simpleQuery.append(&quot; AND active &gt; 0&quot;); //Because change will affect only Active forum's</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">		else if(actionType == ActionType.UNLOCK) simpleQuery.append(&quot; AND active &lt; 1&quot;); //Because change will affect only NON-Active forum's</span>

		//Get users from affected forum's (those where I perform action)
<span class="fc" id="L375">		List&lt;Number&gt; usersInForums = null;</span>
		try {
<span class="fc" id="L377">			usersInForums = new SimpleQuery().forList(simpleQuery.toString());</span>
<span class="nc" id="L378">		} catch (Exception ex) {</span>
<span class="nc" id="L379">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L380">			usersInForums = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">			if (isAdmin == false) usersInForums.add(user.getUserId());</span>
<span class="fc" id="L382">		}</span>

<span class="fc" id="L384">		final String WHERE_FORUM_ID_IN = &quot; WHERE forum_id IN (&quot;;</span>
<span class="fc" id="L385">		final String AND_USER_ID = &quot; AND user_id=&quot;;</span>

		//PREPARE QUERY FOR THE ACTION
<span class="fc" id="L388">		simpleQuery = new StringBuilder(&quot;&quot;);</span>
<span class="fc bfc" id="L389" title="All 2 branches covered.">		if(actionType == ActionType.DELETE) {</span>
			//By constant decide if use SOFT delete or HARD delete
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">			if (Constants.getBoolean(&quot;forumReallyDeleteMessages&quot;))</span>
<span class="nc" id="L392">				simpleQuery.append(&quot;DELETE FROM document_forum WHERE forum_id IN (&quot;).append(fIds).append(&quot;)&quot;).append(domainSql); //HARD DELETE</span>
			else
<span class="fc" id="L394">				simpleQuery.append(&quot;UPDATE document_forum SET deleted = &quot;).append(DB.getBooleanSql(true)).append(WHERE_FORUM_ID_IN).append(fIds).append(&quot;) &quot;).append(domainSql); //SOFT DELETE (update)</span>

<span class="fc bfc" id="L396" title="All 2 branches covered.">		} else if(actionType == ActionType.RECOVER) {</span>
<span class="fc" id="L397">			simpleQuery.append(&quot;UPDATE document_forum SET deleted = &quot;).append(DB.getBooleanSql(false)).append(WHERE_FORUM_ID_IN).append(fIds).append(&quot;)&quot;).append(domainSql);</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">		} else if(actionType == ActionType.APPROVE) {</span>
<span class="fc" id="L399">			simpleQuery.append(&quot;UPDATE document_forum SET confirmed = &quot;).append(DB.getBooleanSql(true)).append(WHERE_FORUM_ID_IN).append(fIds).append(&quot;)&quot;).append(domainSql);</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">		} else if(actionType == ActionType.REJECT) {</span>
<span class="fc" id="L401">			simpleQuery.append(&quot;UPDATE document_forum SET confirmed = &quot;).append(DB.getBooleanSql(false)).append(WHERE_FORUM_ID_IN).append(fIds).append(&quot;)&quot;).append(domainSql);</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">		} else if(actionType == ActionType.LOCK) {</span>
<span class="nc" id="L403">			simpleQuery.append(&quot;UPDATE document_forum SET active = &quot;).append(DB.getBooleanSql(false)).append(WHERE_FORUM_ID_IN).append(fIds).append(&quot;)&quot;).append(domainSql);</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">		} else if(actionType == ActionType.UNLOCK) {</span>
<span class="fc" id="L405">			simpleQuery.append(&quot;UPDATE document_forum SET active = &quot;).append(DB.getBooleanSql(true)).append(WHERE_FORUM_ID_IN).append(fIds).append(&quot;)&quot;).append(domainSql);</span>
		}

		// Specification for user if is not admin
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">		if(!isAdmin) simpleQuery.append(AND_USER_ID).append(user.getUserId());</span>

		//PERFORM action AND save number of changed rows
<span class="fc" id="L412">		Integer numberOfUpdated = new SimpleQuery().executeWithUpdateCount(simpleQuery.toString());</span>

<span class="pc bpc" id="L414" title="3 of 8 branches missed.">		if(numberOfUpdated != null &amp;&amp; numberOfUpdated &gt; 0 &amp;&amp; usersInForums != null &amp;&amp; usersInForums.isEmpty() == false) {</span>
<span class="fc" id="L415">			String loggerMsg = &quot;&quot;;</span>
<span class="fc" id="L416">			String sqlSign = &quot;&quot;;</span>

<span class="fc bfc" id="L418" title="All 4 branches covered.">			if(actionType == ActionType.DELETE || actionType == ActionType.REJECT) {</span>
				//During DELETE / REJECT action, user's loosing rank, and forum loosing count
<span class="fc" id="L420">				loggerMsg = &quot;Lowering rank for user: &quot;;</span>
<span class="fc" id="L421">				sqlSign = &quot;-&quot;;</span>
			} else {
				//During RECOVER / APPROVE action, user's retrieve rank, and forum retrieve count
<span class="fc" id="L424">				loggerMsg = &quot;Increasing rank for user: &quot;;</span>
<span class="fc" id="L425">				sqlSign = &quot;+&quot;;</span>
			}

			//Update user rank
<span class="fc bfc" id="L429" title="All 2 branches covered.">			for (Number userId : usersInForums) {</span>
<span class="fc" id="L430">				Logger.debug(DocForumService.class, loggerMsg + userId.intValue());</span>

				//Only real user (-1 userId represent NOT logged user)
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">				if(userId.intValue() &gt; 0)</span>
<span class="fc" id="L434">					(new SimpleQuery()).execute(&quot;UPDATE users SET forum_rank=forum_rank&quot; + sqlSign + &quot;1 WHERE user_id=?&quot;, userId.intValue());</span>
<span class="fc" id="L435">			}</span>

			//Update webpage forum_count
<span class="fc" id="L438">			(new SimpleQuery()).execute(&quot;UPDATE documents SET forum_count=forum_count&quot; + sqlSign + &quot;? WHERE doc_id=?&quot;, numberOfUpdated, docId);</span>
		}

<span class="fc" id="L441">		DocForumEntity docForumEntity = getForumBean(forumId, true);</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">		Integer parentId = docForumEntity != null ? docForumEntity.getParentId() : -1;</span>

		//Update forum info like stat view ...
<span class="fc" id="L445">		updateForumStatInfo(docId, parentId);</span>

<span class="pc bpc" id="L447" title="1 of 2 branches missed.">		if(docForumEntity != null) {</span>
<span class="fc bfc" id="L448" title="All 2 branches covered.">			if(actionType == ActionType.DELETE)</span>
<span class="fc" id="L449">				Adminlog.add(Adminlog.TYPE_FORM_DELETE, &quot;Zmazany diskusny prispevok: &quot; + docForumEntity.getSubject(), forumId, docId);</span>
<span class="fc bfc" id="L450" title="All 2 branches covered.">			else if(actionType == ActionType.RECOVER)</span>
<span class="pc bpc" id="L451" title="1 of 2 branches missed.">				Adminlog.add(Adminlog.TYPE_FORUM_UNDELETE, &quot;Obnoveny prispevok: &quot; + (docForumEntity == null ? &quot; ktory neexistuje&quot; : docForumEntity.getSubject()), forumId, parentId);</span>
		}

<span class="fc" id="L454">		return true;</span>
	}

    /**
	 * testuje, ci nie je prispevok vulgarny, alebo obsahuje nepovoleny HTML kod
	 * @param message
	 * @return
	 */
	public static boolean isVulgar(String message) {
		//Get vulgar words
<span class="fc" id="L464">		String vulgarisms = Constants.getString(&quot;vulgarizmy&quot;);</span>
<span class="pc bpc" id="L465" title="1 of 2 branches missed.">		if (Tools.isEmpty(vulgarisms)) return false;</span>

		//Test message
<span class="pc bpc" id="L468" title="1 of 2 branches missed.">		if(Tools.isNotEmpty(message)) {</span>
<span class="fc" id="L469">			message = &quot; &quot; + message.toLowerCase();</span>
			//aby to naslo aj take ze ...text&lt;script...
<span class="fc" id="L471">			message = Tools.replace(message, &quot;&lt;&quot;, &quot; &lt;&quot;);</span>
<span class="fc" id="L472">			message = Tools.replace(message, &quot;&gt;&quot;, &quot;&gt; &quot;);</span>
<span class="fc" id="L473">			message = message.replace('\n', ' ');</span>
<span class="fc" id="L474">			message = message.replace('\r', ' ');</span>

<span class="fc" id="L476">			StringTokenizer st = new StringTokenizer(vulgarisms, &quot;,&quot;);</span>
<span class="fc bfc" id="L477" title="All 2 branches covered.">			while (st.hasMoreTokens()) {</span>
<span class="fc" id="L478">				String word = st.nextToken().trim();</span>
<span class="pc bpc" id="L479" title="1 of 2 branches missed.">				if (Tools.isEmpty(word)) continue;</span>

<span class="pc bpc" id="L481" title="1 of 2 branches missed.">				if (message.indexOf(&quot; &quot; + word) != -1) {</span>
<span class="nc" id="L482">					Logger.println(DocForumService.class, &quot;vulgar: &quot; + word + &quot; message: &quot; + message);</span>
<span class="nc" id="L483">					Adminlog.add(Adminlog.TYPE_FORUM_SAVE, &quot;vulgar: &quot; + word + &quot; message: &quot; + message, -1, -1);</span>
<span class="nc" id="L484">					return true;</span>
				}
<span class="fc" id="L486">			}</span>
		}

<span class="fc" id="L489">		return false;</span>
	}

	/**
	 * Odstrani Microsot Office tagy z textu. Tieto tagy mozu sposobovat zle
	 * odsadzovanie textu.
	 *
	 * @return String - povodny text ostripovany o tagy
	 */
	public static String clearMsOfficeTags(String text) {
<span class="fc" id="L499">		String oldText = text;</span>
<span class="fc" id="L500">		String forumWysiwygIcons = Constants.getString(&quot;forumWysiwygIcons&quot;);</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">		if (forumWysiwygIcons.indexOf(&quot;createlink&quot;) == -1) {</span>
			//odpazme linky
<span class="nc" id="L503">			Pattern linkPattern = Pattern.compile(&quot;&lt;\\s*[^&gt;]*\\s*a\\s*href\\s*=\\s*\&quot;[^\&quot;]*\&quot;\\s*[^&gt;]*&gt;|&lt;/a&gt;&quot;, Pattern.MULTILINE | Pattern.CASE_INSENSITIVE); //NOSONAR</span>
<span class="nc" id="L504">			Matcher linkMatcher = linkPattern.matcher(text);</span>
<span class="nc" id="L505">			text = linkMatcher.replaceAll(&quot;&quot;);</span>
		}

<span class="pc bpc" id="L508" title="1 of 2 branches missed.">		if (forumWysiwygIcons.indexOf(&quot;insertimage&quot;) == -1) {</span>
			//odpazme linky
<span class="nc" id="L510">			Pattern linkPattern = Pattern.compile(&quot;&lt;\\s*[^&gt;]*\\s*img\\s*src\\s*=\\s*\&quot;[^\&quot;]*\&quot;\\s*[^&gt;]*&gt;|&lt;/img&gt;&quot;, Pattern.MULTILINE | Pattern.CASE_INSENSITIVE); //NOSONAR</span>
<span class="nc" id="L511">			Matcher linkMatcher = linkPattern.matcher(text);</span>
<span class="nc" id="L512">			text = linkMatcher.replaceAll(&quot;&quot;);</span>
		}

		try {
			//ak neobsahuje tento text, tak sa nie je coho bat
<span class="pc bpc" id="L517" title="2 of 4 branches missed.">			if (!text.contains(&quot;class=MsoNormal&quot;) &amp;&amp; !text.contains(&quot;class=\&quot;MsoNormal\&quot;&quot;))</span>
<span class="fc" id="L518">				return text;</span>

			//v prvom rade zmaz vsetky &lt;FONT&gt; a &lt;/FONT&gt; tagy
<span class="nc" id="L521">			Pattern fontPattern = Pattern.compile(&quot;&lt;FONT .*?&gt;&quot;,Pattern.MULTILINE | Pattern.CASE_INSENSITIVE); //NOSONAR</span>
<span class="nc" id="L522">			Matcher fontMatcher = fontPattern.matcher(text);</span>

<span class="nc bnc" id="L524" title="All 2 branches missed.">			while (fontMatcher.find()) {</span>
<span class="nc" id="L525">				text = text.replace(fontMatcher.group(0), &quot;&quot;);</span>
<span class="nc" id="L526">				fontMatcher = fontPattern.matcher(text);</span>
			}

<span class="nc" id="L529">			text = text.replace(&quot;&lt;/FONT&gt;&quot;, &quot;&quot;);</span>

			//potom samotne MsoNormal tagy
<span class="nc" id="L532">			Pattern msTagPattern = Pattern.compile(&quot;&lt;P.*?class=.?MsoNormal.*?&gt;&quot;,Pattern.MULTILINE | Pattern.CASE_INSENSITIVE); //NOSONAR</span>
<span class="nc" id="L533">			Matcher msTagMatcher = msTagPattern.matcher(text);</span>

<span class="nc bnc" id="L535" title="All 2 branches missed.">			while (msTagMatcher.find()) {</span>
<span class="nc" id="L536">				text = text.replace(msTagMatcher.group(0), &quot;&lt;P&gt;&quot;);</span>
<span class="nc" id="L537">				msTagMatcher = msTagPattern.matcher(text);</span>
			}

			//toto su dalsie MS specific tagy...
<span class="nc" id="L541">			text = text.replace(&quot;&lt;o:p&gt;&quot;, &quot;&quot;);</span>
<span class="nc" id="L542">			text = text.replace(&quot;&lt;/o:p&gt;&quot;, &quot;&quot;);</span>
<span class="nc" id="L543">		} catch (Exception e) {</span>
<span class="nc" id="L544">			sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L545">			return oldText;</span>
<span class="nc" id="L546">		}</span>

<span class="nc" id="L548">		return text;</span>
	}

	/**
	 * Prepare new created instance of DocForumEntity for save.
	 *
	 */
	private static void prepareForumForSave(DocForumEntity forumForm, ForumGroupEntity forumGroup, Identity sender, HttpServletRequest request, String hashCode, Integer userId, Boolean isSubtopic) {
		//If user is logged, use his login/email as sender or use data from forumForm
<span class="pc bpc" id="L557" title="1 of 4 branches missed.">		if(sender != null &amp;&amp; Tools.isEmpty(forumForm.getAuthorName())) {</span>
<span class="nc" id="L558">			forumForm.setAuthorName( sender.getLogin() );</span>
<span class="nc" id="L559">			forumForm.setAuthorEmail( sender.getEmail());</span>
		}

		//If validation is ENABLED, set confirmed as FALSE (because it needs approve)
<span class="pc bpc" id="L563" title="2 of 4 branches missed.">		if (forumGroup != null &amp;&amp;  forumGroup.getMessageConfirmation()) {</span>
			//Need's approve
			//BUT if user is logged AND he is approver of forum AND he is author of this new contribution ... DO a AUTO approve
<span class="nc bnc" id="L566" title="All 6 branches missed.">			if(sender != null &amp;&amp; sender.getEmail().equals(forumGroup.getApproveEmail()) &amp;&amp; sender.getEmail().equals(forumForm.getAuthorEmail()))</span>
<span class="nc" id="L567">				forumForm.setConfirmed(true);</span>
			else
<span class="nc" id="L569">				forumForm.setConfirmed(false);</span>
		} else //Forum do NOT need approve
<span class="fc" id="L571">			forumForm.setConfirmed(true);</span>

<span class="fc" id="L573">		forumForm.setQuestionDate( new Date() );</span>
<span class="fc" id="L574">		forumForm.setIp( Tools.getRemoteIP(request) );</span>
<span class="fc" id="L575">		forumForm.setHashCode(hashCode);</span>
<span class="fc" id="L576">		forumForm.setUserId(userId);</span>
<span class="fc" id="L577">		forumForm.setActive(true);</span>
<span class="fc" id="L578">		forumForm.setDomainId( CloudToolsForCore.getDomainId() );</span>
<span class="fc" id="L579">		forumForm.setDeleted(false);</span>

<span class="fc bfc" id="L581" title="All 2 branches covered.">		if(Boolean.TRUE.equals(isSubtopic)) {</span>
			//If the forumForm represent subtopic
<span class="fc" id="L583">			forumForm.setStatViews(0);</span>
<span class="fc" id="L584">			forumForm.setStatReplies(0);</span>
<span class="fc" id="L585">			forumForm.setStatLastPost(new Date());</span>
		}
<span class="fc" id="L587">	}</span>

	/**
	 * Get DocForumEntity based on forumId (id), is entity is present, convert it to dDocForumEntity or return null.
	 *
	 * @param forumId - entity id
	 * @param sortAscending - true = ASC, false = DESC
	 * @return
	 */
	public static DocForumEntity getForumBean(int forumId, boolean sortAscending) {
<span class="fc" id="L597">		DocForumRepository docForumRepository = getDocForumRepository();</span>
<span class="fc" id="L598">		Integer domainId = CloudToolsForCore.getDomainId();</span>

		//Based on param sortAscending call getData
		Optional&lt;DocForumEntity&gt; entityOpt;
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">		if(sortAscending)</span>
<span class="fc" id="L603">			entityOpt = docForumRepository.findByIdAndDomainIdOrderByQuestionDateAsc(Long.valueOf(forumId), domainId);</span>
		else
<span class="nc" id="L605">			entityOpt = docForumRepository.findByIdAndDomainIdOrderByQuestionDateDesc(Long.valueOf(forumId), domainId);</span>

<span class="fc bfc" id="L607" title="All 2 branches covered.">		if(entityOpt.isPresent())</span>
<span class="fc" id="L608">			return entityOpt.get();</span>

<span class="fc" id="L610">		return null;</span>
	}

	/**
	 * Recursively sort List (unsorted) and sorted values add into List (sorted).
	 *
	 * @param unsorted
	 * @param sorted
	 * @param level
	 * @param parent
	 */
	public static void recursiveSort(List&lt;DocForumEntity&gt; unsorted, List&lt;DocForumEntity&gt; sorted, int level, int parent) {
<span class="fc bfc" id="L622" title="All 2 branches covered.">		for (DocForumEntity fb : unsorted) {</span>
<span class="pc bpc" id="L623" title="1 of 4 branches missed.">			if (fb.getParentId() != null &amp;&amp; fb.getParentId().intValue() == parent) {</span>
<span class="fc" id="L624">				fb.setPrefix(&quot;&lt;div style=\&quot;margin-left:&quot; + (20 * level) + &quot;px\&quot;&gt;&quot;);</span>
<span class="fc" id="L625">				fb.setLevel(level);</span>
<span class="fc" id="L626">				sorted.add(fb);</span>
<span class="fc" id="L627">				recursiveSort(unsorted, sorted, level + 1, fb.getId().intValue());</span>
			}
<span class="fc" id="L629">		}</span>
<span class="fc" id="L630">	}</span>

	public static List&lt;DocForumEntity&gt; getForumFieldsForDoc(HttpServletRequest request, int docId, boolean onlyConfirmed, int parentId, boolean sortAscending, boolean showDeleted, boolean isForumSearch) {
		//It's Mental gymnastic, we using SQL where BOOLEAN params are compared as (boolean == val1 OR boolean == val2)
		//By setting val1 and val2 we can return all combinations true/false/doesnt matter

<span class="pc bpc" id="L636" title="1 of 2 branches missed.">		if(showDeleted)</span>
<span class="nc" id="L637">			return getForumFieldsForDoc(docId, parentId, sortAscending, onlyConfirmed, true, true, false, isForumSearch); //speaking about deleted, true &amp;&amp; false -&gt; all forum's, not depending on deleted value</span>
		else
<span class="fc" id="L639">			return getForumFieldsForDoc(docId, parentId, sortAscending, onlyConfirmed, true, false, false, isForumSearch); //speaking about deleted, flase &amp;&amp; false -&gt; only not deleted forum's</span>
	}

	private static List&lt;DocForumEntity&gt; getForumFieldsForDoc(ActionType actionType, int docId, int parentId, boolean sortAscending) {
<span class="fc" id="L643">		boolean deleteA = true;</span>
<span class="fc" id="L644">		boolean deleteB = false;</span>
<span class="fc" id="L645">		boolean confirmA = true;</span>
<span class="fc" id="L646">		boolean confirmB = false;</span>

<span class="fc bfc" id="L648" title="All 2 branches covered.">		if(actionType == ActionType.DELETE) //Only NOT deleted</span>
<span class="fc" id="L649">			deleteA = false;</span>
<span class="fc bfc" id="L650" title="All 2 branches covered.">		else if(actionType == ActionType.RECOVER) //Only deleted</span>
<span class="fc" id="L651">			deleteB = true;</span>
<span class="fc bfc" id="L652" title="All 2 branches covered.">		else if(actionType == ActionType.APPROVE) //Only NOT approved (not confirmed)</span>
<span class="fc" id="L653">			confirmA = false;</span>
<span class="fc bfc" id="L654" title="All 2 branches covered.">		else if(actionType == ActionType.REJECT) //Only approved (confirmed)</span>
<span class="fc" id="L655">			confirmB = true;</span>

<span class="fc" id="L657">		return getForumFieldsForDoc(docId, parentId, sortAscending, confirmA, confirmB, deleteA, deleteB, false);</span>
	}

	/**
	 * confirmedA == true &amp;&amp; confirmedB == true -&gt; only confirmed.
	 * confirmedA == false &amp;&amp; confirmedB == false -&gt; only NOT confirmed.
	 * else -&gt; all records, confirmed value doesnt matter.
	 *
	 * deletedA == true &amp;&amp; deletedB == true -&gt; only deleted.
	 * deletedA == false &amp;&amp; deletedB == false -&gt; only NOT deleted.
	 * else -&gt; all records, deleted value doesnt matter.
	 */
	private static List&lt;DocForumEntity&gt; getForumFieldsForDoc(int docId, int parentId, boolean sortAscending, boolean confirmedA,  boolean confirmedB, boolean deletedA, boolean deletedB, boolean isForumSearch) {
		//Returned List, even empty
<span class="fc" id="L671">		List&lt;DocForumEntity&gt; sorted = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L673" title="1 of 2 branches missed.">		if(docId &gt; 0) {</span>
<span class="fc" id="L674">			List&lt;DocForumEntity&gt; unsorted = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L675">			List&lt;Integer&gt; parentIds = new ArrayList&lt;&gt;(Arrays.asList(parentId));</span>
<span class="fc" id="L676">			HashSet&lt;Integer&gt; obtainedParentIds = new HashSet&lt;&gt;(Arrays.asList(parentId));</span>
<span class="fc" id="L677">			HashSet&lt;Integer&gt; obtainedChildIds = new HashSet&lt;&gt;();</span>
<span class="fc" id="L678">			Integer domainId = CloudToolsForCore.getDomainId();</span>

<span class="fc" id="L680">			DocForumRepository docForumRepository = getDocForumRepository();</span>

			//Get all relevant forum entities
			List&lt;DocForumIdAndParentId&gt; entities;

			//Very special FIX -&gt; only in case of calling ForumDB.getForumMessageParent (after forum search), we must include massage-board forum's with parent id &lt; 0
			//It's because we cant prepare link for forum in search, when we do not load allso root parent
<span class="pc bpc" id="L687" title="5 of 10 branches missed.">			if(isForumSearch) entities = docForumRepository.getDocForumListForumIdParentIdWithRootParents(docId, deletedA||deletedB, confirmedA||confirmedB, domainId);</span>
<span class="pc bpc" id="L688" title="2 of 8 branches missed.">			else entities = docForumRepository.getDocForumListForumIdParentId(docId, deletedA||deletedB, confirmedA||confirmedB, domainId);</span>

			//Loop all entities and make String of all parent ids (even sub levels)
<span class="fc bfc" id="L691" title="All 2 branches covered.">			for(DocForumIdAndParentId entity : entities) {</span>
<span class="fc" id="L692">				int childForumId = entity.getId().intValue();</span>
<span class="fc" id="L693">				int childParentId = entity.getParentId();</span>

				//To make answers work in simple forum
<span class="fc bfc" id="L696" title="All 2 branches covered.">				if (parentId == 0) parentIds.add(childParentId);</span>

<span class="fc bfc" id="L698" title="All 2 branches covered.">				if (obtainedParentIds.contains(childParentId))</span>
<span class="fc" id="L699">					obtainedChildIds.add(childForumId);</span>
<span class="fc bfc" id="L700" title="All 2 branches covered.">				else if (obtainedChildIds.contains(childParentId)) {</span>
<span class="fc" id="L701">					obtainedChildIds.add(childForumId);</span>
<span class="fc" id="L702">					obtainedParentIds.add(childParentId);</span>
<span class="fc" id="L703">					parentIds.add(childParentId);</span>
				}
<span class="fc" id="L705">			}</span>

			//Based of parent id's, get all their child's entities
<span class="fc" id="L708">			List&lt;DocForumEntity&gt; childForums = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L709" title="All 2 branches covered.">			if(sortAscending)</span>
<span class="pc bpc" id="L710" title="2 of 8 branches missed.">				childForums.addAll( docForumRepository.getDocForumListAsc(docId, parentIds, deletedA||deletedB, confirmedA||confirmedB, domainId) );</span>
			else
<span class="pc bpc" id="L712" title="5 of 8 branches missed.">				childForums.addAll( docForumRepository.getDocForumListDesc(docId, parentIds, deletedA||deletedB, confirmedA||confirmedB, domainId) );</span>

			//It must be ForumBean List
<span class="fc" id="L715">			unsorted.addAll( childForums );</span>

<span class="fc" id="L717">			DocForumEntity parentForum = getForumBean(parentId, true);</span>
			//Push from start
<span class="pc bpc" id="L719" title="1 of 4 branches missed.">			if(parentForum != null &amp;&amp; sortAscending) sorted.add(parentForum);</span>

			//Sort it
<span class="fc" id="L722">			recursiveSort(unsorted, sorted, 0, parentId);</span>

			//Push at end (aka first question)
<span class="pc bpc" id="L725" title="1 of 4 branches missed.">			if (parentForum != null &amp;&amp; !sortAscending) sorted.add(parentForum);</span>
		}

		//return sorted values
<span class="fc" id="L729">		return sorted;</span>
	}

	/**
	 * BAsed on give forumId, return string where are joined all children id's.
	 *
	 * @param msgList - list of entities to loop
	 * @param forumId - forumId of root parent
	 * @return
	 */
	public static String getChildForumIdsRecursive(List&lt;DocForumEntity&gt; msgList, int forumId) {
<span class="fc" id="L740">		StringBuilder idStr = new StringBuilder();</span>

<span class="pc bpc" id="L742" title="1 of 4 branches missed.">		if (msgList != null &amp;&amp; forumId &gt; 0) {</span>
<span class="fc bfc" id="L743" title="All 2 branches covered.">			for (DocForumEntity fb : msgList) {</span>
<span class="fc bfc" id="L744" title="All 2 branches covered.">				if (fb.getParentId() == forumId) {</span>
<span class="pc bpc" id="L745" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(idStr)) idStr.append(String.valueOf(fb.getId())).append(',');</span>
<span class="fc" id="L746">					else idStr = new StringBuilder(String.valueOf(fb.getId())).append(',');</span>
<span class="fc" id="L747">					idStr.append(getChildForumIdsRecursive(msgList, fb.getId().intValue()));</span>
				}
<span class="fc" id="L749">			}</span>
		}
<span class="fc" id="L751">		return idStr.toString();</span>
	}

	public static void updateForumStatInfo(int docId, int forumId) {
		String childForumIdsString;
		String[] childForumIds;
<span class="fc" id="L757">		int countStatReplies = 0;</span>
<span class="fc" id="L758">		List&lt;DocForumEntity&gt; msgList = getForumFieldsForDoc(null, docId, true, forumId, true, false, false);</span>
<span class="fc" id="L759">		int parentId = findParentRecursive(msgList, forumId);</span>
<span class="fc" id="L760">		String domain = CloudToolsForCore.getDomainIdSqlWhere(true);</span>

<span class="fc" id="L762">		childForumIdsString = getChildForumIdsRecursive(msgList, parentId);</span>
<span class="pc bpc" id="L763" title="3 of 4 branches missed.">		if (Tools.isNotEmpty(childForumIdsString) &amp;&amp; childForumIdsString.endsWith(&quot;,&quot;)) childForumIdsString = childForumIdsString.substring(0, childForumIdsString.length() - 1);</span>

<span class="fc" id="L765">		childForumIds = Tools.getTokens(childForumIdsString, &quot;,&quot;);</span>
<span class="pc bpc" id="L766" title="1 of 2 branches missed.">		if (childForumIds != null)</span>
<span class="fc" id="L767">			countStatReplies = childForumIds.length;</span>

<span class="pc bpc" id="L769" title="1 of 2 branches missed.">		if (countStatReplies == 0) {</span>
<span class="fc" id="L770">			(new SimpleQuery()).execute(&quot;UPDATE document_forum SET stat_replies=?, stat_last_post=question_date WHERE forum_id=? AND parent_id=-1&quot; + domain, countStatReplies, parentId);</span>
		}

<span class="pc bpc" id="L773" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(childForumIdsString)) {</span>
<span class="nc" id="L774">			StringBuilder sql = new StringBuilder(&quot;SELECT &quot;);</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MSSQL)</span>
<span class="nc" id="L776">				sql.append(&quot;TOP 1 &quot;);</span>
<span class="nc" id="L777">			sql.append(&quot;question_date FROM document_forum WHERE &quot;);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">			if(Constants.DB_TYPE == Constants.DB_ORACLE)</span>
<span class="nc" id="L779">				sql.append(&quot; rownum = 1 AND &quot;);</span>
<span class="nc" id="L780">			sql.append(&quot;doc_id=?&quot; + domain + &quot; AND forum_id IN (&quot; + childForumIdsString + &quot;)&quot; + &quot; ORDER BY question_date DESC&quot;);</span>
<span class="nc bnc" id="L781" title="All 4 branches missed.">			if (Constants.DB_TYPE == Constants.DB_MYSQL || Constants.DB_TYPE == Constants.DB_PGSQL)</span>
<span class="nc" id="L782">				sql.append(&quot; LIMIT 1&quot;);</span>

<span class="nc" id="L784">			Date lastPostDate = (new SimpleQuery()).forDate(sql.toString(), docId);</span>
<span class="nc bnc" id="L785" title="All 6 branches missed.">			if (lastPostDate != null &amp;&amp; lastPostDate.getTime() &gt; 0 &amp;&amp; countStatReplies &gt; 0)</span>
<span class="nc" id="L786">				(new SimpleQuery()).execute(&quot;UPDATE document_forum SET stat_replies=?, stat_last_post=? WHERE forum_id=? AND parent_id=-1&quot; + domain, countStatReplies, lastPostDate, parentId);</span>
		}
<span class="fc" id="L788">	}</span>

	/**
	 * Rekurzivne vyhlada forumId pod-temy
	 *
	 * @param msgList
	 * @param parentId
	 * @return
	 */
	public static int findParentRecursive(List&lt;DocForumEntity&gt; msgList, int parentId) {
<span class="fc" id="L798">		int forumId = -1;</span>

<span class="fc bfc" id="L800" title="All 2 branches covered.">		for (DocForumEntity fb : msgList) {</span>
<span class="fc bfc" id="L801" title="All 2 branches covered.">			if (fb.getId().intValue() == parentId) {</span>
<span class="fc" id="L802">				forumId = findParentRecursive(msgList, fb.getParentId());</span>
<span class="pc bpc" id="L803" title="1 of 2 branches missed.">				if (forumId &lt; 0) forumId = fb.getId().intValue();</span>
			}
<span class="fc" id="L805">		}</span>

<span class="fc" id="L807">		return forumId;</span>
	}

	/**
	 * Upload file for specific forum. Using MediaDB.
	 *
	 * @param uploadFile - file to upload
	 * @param request
	 * @param response
	 * @return - path to file (forward)
	 */
	public static String uploadForumFile(CommonsMultipartFile uploadFile, HttpServletRequest request) {
<span class="fc" id="L819">		int forumId = Tools.getIntValue(request.getParameter(&quot;forumId&quot;) , -1);</span>
<span class="pc bpc" id="L820" title="3 of 6 branches missed.">		if(forumId == -1 || uploadFile == null || uploadFile.isEmpty()) return null;</span>

<span class="fc" id="L822">		DocForumRepository docForumRepository = getDocForumRepository();</span>
<span class="fc" id="L823">		Optional&lt;DocForumEntity&gt; forumOpt = docForumRepository.findById((long) forumId);</span>
<span class="pc bpc" id="L824" title="1 of 2 branches missed.">		if(!forumOpt.isPresent()) return null;</span>

		try {
<span class="fc" id="L827">            return uploadForumFileLogic(uploadFile, forumOpt.get(), request);</span>
<span class="nc" id="L828">        } catch(Exception e) {</span>
<span class="nc" id="L829">           sk.iway.iwcm.Logger.error(e);</span>
        }

<span class="nc" id="L832">		return SAVE_FORUM_SUCCESS;</span>
	}

	private static String uploadForumFileLogic(CommonsMultipartFile uploadedFile, DocForumEntity docForum, HttpServletRequest request) throws IOException {
		//Check logged user
<span class="fc" id="L837">		Identity user = UsersDB.getCurrentUser(request);</span>
<span class="pc bpc" id="L838" title="1 of 2 branches missed.">		if (user == null) {</span>
<span class="nc" id="L839">			setPermissionDenied(request, &quot;true&quot;);</span>
<span class="nc" id="L840">			return SAVE_FORUM_SUCCESS;</span>
		}

		//Check if we upload file to MY post
<span class="pc bpc" id="L844" title="2 of 4 branches missed.">		if (docForum.getUserId() &lt; 1 || docForum.getUserId() != user.getUserId()) {</span>
<span class="nc" id="L845">			setPermissionDenied(request, &quot;true&quot;);</span>
<span class="nc" id="L846">			return SAVE_FORUM_SUCCESS;</span>
		}

		//Get upload limits
<span class="fc" id="L850">		LabelValueDetails uploadLimits = ForumDB.getUploadLimits(docForum.getDocId(), request);</span>
<span class="pc bpc" id="L851" title="1 of 2 branches missed.">		if (uploadLimits == null) {</span>
<span class="nc" id="L852">			setPermissionDenied(request, &quot;true&quot;);</span>
<span class="nc" id="L853">			return SAVE_FORUM_SUCCESS;</span>
		}

		//Check uploaded file size limit
<span class="pc bpc" id="L857" title="2 of 4 branches missed.">		if (uploadLimits.getInt1() &gt; 0 &amp;&amp; (uploadLimits.getInt1() * 1024) &lt; uploadedFile.getFileItem().getSize()) {</span>
<span class="nc" id="L858">			setPermissionDenied(request, &quot;fileSize&quot;);</span>
<span class="nc" id="L859">			return SAVE_FORUM_SUCCESS;</span>
		}

		//Check the file rights
<span class="fc" id="L863">		String fileName = DocTools.removeChars(uploadedFile.getFileItem().getName()).toLowerCase();</span>

		//Check the suffix
<span class="pc bpc" id="L866" title="2 of 4 branches missed.">		if (fileName.endsWith(&quot;.jsp&quot;) || fileName.endsWith(&quot;.class&quot;)) {</span>
<span class="nc" id="L867">			setPermissionDenied(request, &quot;true&quot;);</span>
<span class="nc" id="L868">			return SAVE_FORUM_SUCCESS;</span>
		}

<span class="fc" id="L871">		boolean canUpload = false;</span>
<span class="pc bpc" id="L872" title="1 of 2 branches missed.">		if (&quot;*&quot;.equals(uploadLimits.getValue())) {</span>
<span class="nc" id="L873">			canUpload = true;</span>
		} else {
			//skontroluj priponu suboru
<span class="fc" id="L876">			StringTokenizer st = new StringTokenizer(uploadLimits.getValue(), &quot;,&quot;);</span>
<span class="pc bpc" id="L877" title="1 of 4 branches missed.">			while (st.hasMoreTokens() &amp;&amp; canUpload == false)</span>
<span class="fc bfc" id="L878" title="All 2 branches covered.">				if (fileName.endsWith(st.nextToken())) canUpload = true;</span>
		}

<span class="pc bpc" id="L881" title="1 of 2 branches missed.">		if (!canUpload) {</span>
<span class="nc" id="L882">			setPermissionDenied(request, &quot;fileType&quot;);</span>
<span class="nc" id="L883">			return SAVE_FORUM_SUCCESS;</span>
		}

		//ok, let upload image
<span class="fc" id="L887">		String baseDir = &quot;/images/apps/forum/&quot;;</span>
<span class="fc" id="L888">		baseDir = baseDir.replace('\\', '/');</span>
<span class="pc bpc" id="L889" title="1 of 2 branches missed.">		if (baseDir.endsWith(&quot;/&quot;) == false) baseDir = baseDir + &quot;/&quot;;</span>
<span class="fc" id="L890">		fileName = user.getUserId() + &quot;-&quot; + docForum.getId() + &quot;-&quot; + fileName;</span>

<span class="fc" id="L892">		File f = new File(Tools.getRealPath(baseDir + fileName));</span>
<span class="pc bpc" id="L893" title="3 of 4 branches missed.">		if (f.getParentFile().exists() == false &amp;&amp; f.getParentFile().mkdirs() == false) {</span>
<span class="nc" id="L894">			setPermissionDenied(request, &quot;true&quot;);</span>
<span class="nc" id="L895">			return SAVE_FORUM_SUCCESS;</span>
		}

<span class="fc" id="L898">		boolean fileAllreadyExists = f.exists();</span>

		//zapis subor na disk
<span class="fc" id="L901">		int bytesRead = 0;</span>
<span class="fc" id="L902">		byte[] buffer = new byte[8192];</span>
<span class="fc" id="L903">		BufferedInputStream buffReader = new BufferedInputStream(uploadedFile.getFileItem().getInputStream());</span>
<span class="fc" id="L904">		FileOutputStream fos = new FileOutputStream(f);</span>
<span class="fc bfc" id="L905" title="All 2 branches covered.">		while ((bytesRead = buffReader.read(buffer, 0, 8192)) != -1)</span>
<span class="fc" id="L906">			fos.write(buffer, 0, bytesRead);</span>

<span class="fc" id="L908">		buffReader.close();</span>
<span class="fc" id="L909">		fos.close();</span>
<span class="fc" id="L910">		uploadedFile.getFileItem().delete();</span>

		//ak prepise existujuci subor, aby sa to neobjavilo v zozname viac krat
<span class="pc bpc" id="L913" title="1 of 2 branches missed.">		if (fileAllreadyExists == false) {</span>
			//zapis do medii
<span class="fc" id="L915">			Media m = new Media();</span>
<span class="fc" id="L916">			m.setMediaFkId( docForum.getId().intValue() );</span>
<span class="fc" id="L917">			m.setMediaFkTableName(&quot;document_forum&quot;);</span>

<span class="pc bpc" id="L919" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(docForum.getSubject()))</span>
<span class="fc" id="L920">				m.setMediaTitleSk(docForum.getSubject());</span>
			else
<span class="nc" id="L922">				m.setMediaTitleSk(uploadedFile.getFileItem().getName());</span>

<span class="fc" id="L924">			m.setMediaLink(baseDir + fileName);</span>
<span class="fc" id="L925">			m.setMediaSortOrder(10);</span>
<span class="fc" id="L926">			new MediaDB().save(m);</span>
		}

<span class="fc" id="L929">		return SAVE_FORUM_SUCCESS;</span>
	}

	public static DocForumEntity getForumStat(int docId) {

<span class="pc bpc" id="L934" title="1 of 2 branches missed.">		if(docId &lt; 1) return null;</span>

<span class="fc" id="L936">		Date lastPost = null;</span>
<span class="fc" id="L937">		int totalMessages = 0;</span>
<span class="fc" id="L938">		DocForumRepository docForumRepository = getDocForumRepository();</span>
<span class="fc" id="L939">		List&lt;DocForumEntity&gt; forums = docForumRepository.getForumStat(docId, false,  CloudToolsForCore.getDomainId());</span>

<span class="fc bfc" id="L941" title="All 2 branches covered.">		for(DocForumEntity forum : forums) {</span>
<span class="fc" id="L942">			totalMessages += forum.getStatReplies() + 1;</span>
<span class="pc bpc" id="L943" title="1 of 2 branches missed.">			if(forum.getStatLastPost() != null) lastPost = forum.getStatLastPost();</span>
<span class="fc" id="L944">		}</span>

<span class="fc" id="L946">		DocForumEntity stat = new DocForumEntity();</span>
<span class="fc" id="L947">		stat.setStatReplies(totalMessages);</span>
<span class="pc bpc" id="L948" title="1 of 2 branches missed.">		if(lastPost != null) stat.setStatLastPost(lastPost);</span>

<span class="fc" id="L950">		return stat;</span>
	}

	public static List&lt;DocForumEntity&gt; getForumTopics(int docId, boolean onlyConfirmed, boolean showDeleted, String flagSearch, ForumSortBy sortBy) {
<span class="fc" id="L954">		List&lt;DocForumEntity&gt; topics = new ArrayList&lt;&gt;();</span>

		//docId mus be set !!
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">		if(docId &lt; 1) return topics;</span>

		//Params for query
<span class="fc" id="L960">		List&lt;Object&gt; params = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L961">		params.add(docId);</span>

		//Prepare sql query
<span class="fc" id="L964">		String sql = &quot;SELECT * FROM document_forum WHERE doc_id=? AND parent_id=-1&quot; + CloudToolsForCore.getDomainIdSqlWhere(true);</span>
<span class="pc bpc" id="L965" title="1 of 2 branches missed.">		if (showDeleted == false) sql += &quot; AND deleted = &quot;+DB.getBooleanSql(false);</span>
<span class="pc bpc" id="L966" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(flagSearch)) {</span>
<span class="nc" id="L967">			sql += &quot; AND flag LIKE ?&quot;;</span>
<span class="nc" id="L968">			params.add(flagSearch + &quot;%&quot;);</span>
		}
<span class="fc" id="L970">		sql += &quot; ORDER BY flag DESC, &quot; + sortBy.getColumnName() + &quot; DESC&quot;;</span>

<span class="fc" id="L972">		Logger.debug(ForumDB.class, &quot;getForumTopics: docId=&quot; + docId + &quot; flagSearch=&quot; + flagSearch + &quot; sql=&quot; + sql);</span>

<span class="fc" id="L974">		new ComplexQuery().setSql(sql).setParams(params.toArray()).list(new Mapper&lt;DocForumEntity&gt;() {</span>
			@Override
			public DocForumEntity map(ResultSet rs) throws SQLException {
<span class="fc" id="L977">				boolean isConfirmed = rs.getBoolean(&quot;confirmed&quot;);</span>
<span class="pc bpc" id="L978" title="3 of 4 branches missed.">				if(onlyConfirmed &amp;&amp; !isConfirmed) {</span>
					//If confirmed only but this one is not confirmed
				} else {
<span class="fc" id="L981">					DocForumEntity tmpEntity = rsToDocForumEntity(rs);</span>

					//Insert to our list
<span class="pc bpc" id="L984" title="1 of 2 branches missed.">					if(tmpEntity != null)</span>
<span class="fc" id="L985">						topics.add(tmpEntity);</span>
				}

<span class="fc" id="L988">				return null;</span>
			}
		});

		//Add ForumGroupEntity
<span class="fc bfc" id="L993" title="All 2 branches covered.">		for(DocForumEntity topic : topics)</span>
<span class="fc" id="L994">			topic.setForumGroupEntity( ForumGroupService.getForum(topic.getDocId(), false) );</span>

<span class="fc" id="L996">		return topics;</span>
	}

	private static DocForumEntity rsToDocForumEntity(ResultSet rs) {
		try {
<span class="fc" id="L1001">			DocForumEntity tmpEntity = new DocForumEntity();</span>

<span class="fc" id="L1003">			tmpEntity.setId(rs.getLong(&quot;forum_id&quot;));</span>
<span class="fc" id="L1004">			tmpEntity.setDocId(rs.getInt(&quot;doc_id&quot;));</span>
<span class="fc" id="L1005">			tmpEntity.setParentId(rs.getInt(&quot;parent_id&quot;));</span>
<span class="fc" id="L1006">			tmpEntity.setSubject(DB.getDbString(rs, &quot;subject&quot;));</span>
<span class="fc" id="L1007">			tmpEntity.setQuestion(DB.getDbString(rs, &quot;question&quot;));</span>
<span class="fc" id="L1008">			tmpEntity.setQuestionDate( new Date( DB.getDbTimestamp(rs, &quot;question_date&quot;) ) );</span>
<span class="fc" id="L1009">			tmpEntity.setAuthorName(DB.getDbString(rs, &quot;author_name&quot;));</span>
<span class="fc" id="L1010">			tmpEntity.setAuthorEmail(DB.getDbString(rs, &quot;author_email&quot;));</span>
<span class="fc" id="L1011">			tmpEntity.setConfirmed(rs.getBoolean(&quot;confirmed&quot;));</span>
<span class="fc" id="L1012">			tmpEntity.setHashCode(DB.getDbString(rs, &quot;hash_code&quot;));</span>
<span class="fc" id="L1013">			tmpEntity.setSendAnswerNotif(rs.getBoolean(&quot;send_answer_notif&quot;));</span>
<span class="fc" id="L1014">			tmpEntity.setStatReplies(rs.getInt(&quot;stat_replies&quot;));</span>
<span class="fc" id="L1015">			tmpEntity.setStatViews(rs.getInt(&quot;stat_views&quot;));</span>
<span class="fc" id="L1016">			tmpEntity.setStatLastPost( new Date( DB.getDbTimestamp(rs, &quot;stat_last_post&quot;) ) );</span>
<span class="fc" id="L1017">			tmpEntity.setFlag(DB.getDbString(rs, &quot;flag&quot;));</span>
<span class="fc" id="L1018">			tmpEntity.setUserId(rs.getInt(&quot;user_id&quot;));</span>
<span class="fc" id="L1019">			tmpEntity.setActive(rs.getBoolean(&quot;active&quot;));</span>
<span class="fc" id="L1020">			tmpEntity.setDeleted(rs.getBoolean(&quot;deleted&quot;));</span>

<span class="fc" id="L1022">			return tmpEntity;</span>
<span class="nc" id="L1023">		} catch (SQLException ex) {</span>
<span class="nc" id="L1024">			sk.iway.iwcm.Logger.error(ex);</span>
		}

<span class="nc" id="L1027">		return null;</span>
	}

	public static DocForumEntity getLastMessage(int docId) {
<span class="nc" id="L1031">		DocForumRepository docForumRepository = getDocForumRepository();</span>
<span class="nc" id="L1032">		Optional&lt;DocForumEntity&gt; optMsp = docForumRepository.findFirstByDocIdAndDomainIdOrderByQuestionDateDesc(docId, CloudToolsForCore.getDomainId());</span>
<span class="nc bnc" id="L1033" title="All 2 branches missed.">		if(optMsp.isPresent()) return optMsp.get();</span>

<span class="nc" id="L1035">		return null;</span>
	}

	private static DocForumRepository getDocForumRepository() {
<span class="fc" id="L1039">		return Tools.getSpringBean(&quot;docForumRepository&quot;, DocForumRepository.class);</span>
	}

	private static void setError(HttpServletRequest request, String error) {
<span class="nc" id="L1043">		request.setAttribute(&quot;errorKey&quot;, error);</span>
<span class="nc" id="L1044">	}</span>

	private static void setPermissionDenied(HttpServletRequest request, String error) {
<span class="nc" id="L1047">		Logger.debug(ForumDB.class, &quot;Permission denied, error=&quot; + error + &quot; subject=&quot;+request.getParameter(&quot;subject&quot;));</span>
<span class="nc" id="L1048">		request.setAttribute(&quot;permissionDenied&quot;, error);</span>
<span class="nc" id="L1049">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>