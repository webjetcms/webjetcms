<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FormMailAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.form</a> &gt; <span class="el_source">FormMailAction.java</span></div><h1>FormMailAction.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.form;

import cvu.html.HTMLTokenizer;
import cvu.html.TagToken;
import net.sourceforge.stripes.action.ActionBeanContext;
import net.sourceforge.stripes.validation.SimpleError;
import org.apache.struts.util.ResponseUtils;
import sk.iway.Password;
import sk.iway.iwcm.*;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.common.PdfTools;
import sk.iway.iwcm.common.SearchTools;
import sk.iway.iwcm.common.WriteTagToolsForCore;
import sk.iway.iwcm.components.upload.XhrFileUploadServlet;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.*;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.form.validators.PhoneValidator;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmFsDB;
import sk.iway.iwcm.system.captcha.Captcha;
import sk.iway.iwcm.system.jpa.AllowSafeHtmlAttributeConverter;
import sk.iway.iwcm.system.multidomain.MultiDomainFilter;
import sk.iway.iwcm.system.stripes.CSRF;
import sk.iway.iwcm.tags.WriteTag;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UsersDB;
import sk.iway.upload.DiskMultiPartRequestHandler;
import sk.iway.upload.UploadedFile;

import javax.activation.DataHandler;
import javax.activation.FileDataSource;
import javax.activation.MimetypesFileTypeMap;
import javax.mail.*;
import javax.mail.internet.*;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.*;
import java.lang.reflect.Method;
import java.net.InetAddress;
import java.sql.*;
import java.util.*;

/**
 *  univerzalne poslanie mailu
 *
 *@Title        iwcm
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: 1.30 $
 *@created      ďż˝tvrtok, 2002, marec 28
 *@modified     $Date: 2004/03/23 19:23:02 $
 */
<span class="nc" id="L59">public class FormMailAction extends HttpServlet</span>
{
	private static final long serialVersionUID = 1L;

	/**
	 *  Description of the Field
	 */
	public static final String FORM_FILE_DIR = &quot;/WEB-INF/formfiles/&quot;;
	/**
	 *  Description of the Field
	 */
	public static final String FORM_HTML_DIR = &quot;/WEB-INF/formhtml/&quot;;

	/**
	 *  Zaslanie formularu z www stranky, nastavuje sa to cez:&lt;br&gt;
	 *  &lt;br&gt;
	 *  Kam sa to presmeruje po submite&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;forward&quot; value=&quot;/showdoc.do?docid=1250&quot;&gt;&lt;br&gt;
	 *  Dokumentu s predlohou formularu (fieldy su nahradene !meno_fieldu!)&lt;br&gt;
	 *  &lt;INPUT type=hidden value=&quot;formular.html&quot; name=&quot;source&quot;&gt;&lt;br&gt;
	 *  Prijemcovia mailu oddeleny ciarkou&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;recipients&quot; value=&quot;lubos.balat@interway.sk&quot;&gt;
	 *  ak je nastavene toto, ulozi sa formular do databazy&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;savedb&quot; value=&quot;nazov_formularu&quot;&gt;&lt;br&gt;
	 *  &lt;br&gt;
	 *  Subject mailu&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;subject&quot; value=&quot;Slovnaft WEB formular:
	 *  palivove karty (english)&quot;&gt;&lt;br&gt;
	 *  Zoznam fieldov ktore sa poslu a ulozia do DB&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;fields&quot;
	 *  value=&quot;Spolocnost,ICO,Meno,Adresa,Tel,Fax,Email,Info&quot;&gt;&lt;br&gt;
	 *  Field ktory urcuje ktory field je email&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;femail&quot; value=&quot;Email&quot;&gt;&lt;br&gt;
	 *  Field ktory urcuje ktory field je meno&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;fname&quot; value=&quot;Meno&quot;&gt;&lt;br&gt;
	 *  Zaciatok tela mailu&lt;br&gt;
	 *  &lt;INPUT type=&quot;hidden&quot; name=&quot;body&quot; value=&quot;Formular palivove karty z
	 *  www.slovnaft.sk&quot;&gt;&lt;br&gt;
	 *
	 *  formmail_sendUserInfoDocId - docId stranky, ktorej text sa posle emailom odosielatelovi formularu (jeho email je v poli email)
	 *  formmail_overwriteOldForms - ak je nastavene na true a je prihlaseny pouzivatel tak sa predtym vyplneny formular prepise novym
	 *  formmail_allowOnlyOneSubmit - ak je nastavene na true a je prihlaseny pouzivatel a uz vyplnil formular, nezapise sa znova do DB a formfail sa nastavi na formIsAllreadySubmitted
	 *
	 *
	 *
	 *@param  request               Description of the Parameter
	 *@param  response              Description of the Parameter
	 *@return                       Description of the Return Value
	 *@exception  IOException       Description of the Exception
	 *@exception  ServletException  Description of the Exception */


	protected static void execute(
			HttpServletRequest request,
			HttpServletResponse response)
			throws IOException, ServletException
	{
		//sprav upload

<span class="fc" id="L118">		DiskMultiPartRequestHandler multipartHandler = null;</span>
<span class="fc" id="L119">		List&lt;UploadedFile&gt; formFiles = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L120">		Map&lt;String, List&lt;UploadedFile&gt;&gt; formFilesTable = new Hashtable&lt;&gt;();</span>
<span class="fc" id="L121">		String formName = &quot;unknownForm&quot;;</span>
		try
		{
<span class="fc" id="L124">			multipartHandler = new DiskMultiPartRequestHandler();</span>
<span class="nc" id="L125">			request = multipartHandler.handleRequest(request);</span>

<span class="nc" id="L127">			formName = DB.internationalToEnglish(request.getParameter(&quot;savedb&quot;));</span>
<span class="nc" id="L128">			FormFileRestriction restriction = null;</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (FormDB.isThereFileRestrictionFor(formName))</span>
<span class="nc" id="L130">				restriction = FormDB.getFileRestrictionFor(formName);</span>

<span class="nc" id="L132">			Map&lt;String, List&lt;UploadedFile&gt;&gt; files = multipartHandler.getFileElementsMultiple();</span>

<span class="nc" id="L134">			Set&lt;Map.Entry&lt;String, List&lt;UploadedFile&gt;&gt;&gt; set = files.entrySet();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">			for(Map.Entry&lt;String, List&lt;UploadedFile&gt;&gt; me : set)</span>
			{
<span class="nc" id="L137">				formFilesTable.put(me.getKey(), me.getValue());</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">				for (UploadedFile formFile : me.getValue())</span>
				{
<span class="nc bnc" id="L141" title="All 4 branches missed.">					if (formFile != null &amp;&amp; formFile.getFileSize() &gt; 0)</span>
					{
<span class="nc" id="L143">						((IwcmRequest)request).setParameter(me.getKey(), &quot;NOT_EMPTY&quot;);</span>

<span class="nc" id="L145">						formFiles.add(formFile);</span>
<span class="nc bnc" id="L146" title="All 4 branches missed.">						if (restriction != null &amp;&amp; restriction.isSentFileValid(formFile)==false)</span>
						{
<span class="nc" id="L148">							request.setAttribute(&quot;invalidFiles&quot;, true);</span>
						}
					}
<span class="nc" id="L151">				}</span>
<span class="nc" id="L152">			}</span>
		}
<span class="fc" id="L154">		catch (Exception ex)</span>
		{
<span class="fc" id="L156">			multipartHandler = null;</span>
<span class="nc" id="L157">		}</span>

		//je to tu duplicitne ked padne multipart
<span class="fc" id="L160">		formName = DB.internationalToEnglish(request.getParameter(&quot;savedb&quot;));</span>

<span class="fc" id="L162">		request = fillRequestWithDatabaseOptions(formName, request, formFilesTable.get(&quot;fillRequestInterceptorFile&quot;));</span>

<span class="fc" id="L164">		String forward = saveForm(request, formFilesTable, formFiles, null);</span>

		//zmaz temp subory z uploadu
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">		if (multipartHandler != null) multipartHandler.rollback();</span>

<span class="fc" id="L169">		String forwardType=request.getParameter(&quot;forwardType&quot;);</span>

<span class="pc bpc" id="L171" title="1 of 2 branches missed.">		if (forward.indexOf(&quot;formfail=&quot;)!=-1)</span>
		{
			//musime nastavit na redirect, inak sa nespracuje failstatus
<span class="nc" id="L174">			forwardType = null;</span>
		}

<span class="pc bpc" id="L177" title="1 of 2 branches missed.">		if (&quot;forward&quot;.equals(forwardType))</span>
		{
			//ziskaj si URL
<span class="fc" id="L180">			String url = forward;</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">			if (forward.indexOf(&quot;showdoc.do&quot;)==-1)</span>
			{
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">				if (forward.indexOf('?')!=-1) url = forward.substring(0, forward.indexOf('?'));</span>

<span class="fc" id="L185">				DocDB docDB = DocDB.getInstance();</span>
<span class="fc" id="L186">				int docId = docDB.getVirtualPathDocId(url, DocDB.getDomain(request));</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">				if (docId &gt; 0) url = Tools.addParametersToUrlNoAmp(&quot;/showdoc.do?docid=&quot;+docId, forward.substring(forward.indexOf('?')+1));</span>
			}
<span class="fc" id="L189">			request.getRequestDispatcher(url).forward(request, response);</span>
<span class="fc" id="L190">			return;</span>
		}
<span class="nc bnc" id="L192" title="All 2 branches missed.">		if (&quot;addParams&quot;.equals(forwardType))</span>
		{
<span class="nc" id="L194">			Enumeration&lt;String&gt; parameters = request.getParameterNames();</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			while (parameters.hasMoreElements())</span>
			{
<span class="nc" id="L197">				String name = parameters.nextElement();</span>
<span class="nc bnc" id="L198" title="All 4 branches missed.">				if (&quot;docid&quot;.equals(name) || &quot;doShowdocAction&quot;.equals(name)) continue;</span>

<span class="nc" id="L200">				String[] values = request.getParameterValues(name);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">				for (int i=0; i&lt;values.length; i++)</span>
				{
<span class="nc" id="L203">					forward = Tools.addParameterToUrlNoAmp(forward, name, values[i]);</span>
				}
<span class="nc" id="L205">			}</span>
		}

<span class="nc" id="L208">		response.sendRedirect(forward);</span>
<span class="nc" id="L209">	}</span>

	public static HttpServletRequest fillRequestWithDatabaseOptions(String formName, HttpServletRequest request, List&lt;UploadedFile&gt; excelFile)
	{
<span class="fc" id="L213">		Map&lt;String, String&gt; options = new FormAttributeDB().load(formName);</span>
<span class="fc" id="L214">		IwcmRequest wrapped = new IwcmRequest(request);</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">		for(Map.Entry&lt;String, String&gt; entry : options.entrySet())</span>
		{
<span class="fc" id="L217">			String paramName = entry.getKey();</span>
			//nastaveny parameter useFormDocId ma prioritu z databazy (lebo WriteTag ho vzdy nastavi podla aktualnej stranky)
<span class="pc bpc" id="L219" title="3 of 4 branches missed.">			if (wrapped.hasParameter(paramName)==false || &quot;useFormDocId&quot;.equals(paramName))</span>
			{
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">				if (&quot;useFormDocId&quot;.equals(paramName))</span>
				{
<span class="nc" id="L223">					wrapped.setParameter(&quot;useFormDocIdOriginal&quot;, request.getParameter(&quot;useFormDocId&quot;));</span>
<span class="nc" id="L224">					Logger.debug(FormMailAction.class, &quot;fillRequestWithDatabaseOptions, setting: useFormDocIdOriginal with value from useFormDocId=&quot;+request.getParameter(&quot;useFormDocId&quot;));</span>
				}
<span class="fc" id="L226">				Logger.debug(FormMailAction.class, &quot;fillRequestWithDatabaseOptions, setting:&quot;+paramName+&quot;=&quot;+entry.getValue());</span>
<span class="fc" id="L227">				wrapped.setParameter(paramName, entry.getValue());</span>
<span class="fc" id="L228">				wrapped.setAttribute(&quot;DB&quot;+paramName, &quot;true&quot;);</span>
			}
<span class="fc" id="L230">		}</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(request.getParameter(&quot;fillRequestInterceptorClass&quot;))){</span>
			// moznost naplnit data zo vstupneho subora do nasho requestu (wrapped), pouzite napr. v jasr pri importe studentov
			// treba dat do formulara hidden parameter fillRequestInterceptorClass nastavenym na triedu ktora to ma vykonat
<span class="nc" id="L234">			InputStream is = null;</span>
			try
			{
<span class="nc" id="L237">				Class&lt;?&gt; c = Class.forName(request.getParameter(&quot;fillRequestInterceptorClass&quot;));</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">				if (FillRequestInterceptor.class.isAssignableFrom(c))</span>
				{
<span class="nc bnc" id="L240" title="All 4 branches missed.">					if (excelFile!=null &amp;&amp; excelFile.size()&gt;0) is = excelFile.get(0).getInputStream();</span>
<span class="nc" id="L241">					FillRequestInterceptor interceptor = (FillRequestInterceptor) c.getDeclaredConstructor().newInstance();</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">					if (interceptor!=null)</span>
					{
<span class="nc" id="L244">						boolean successfullyIntercepted = interceptor.intercept(is, wrapped);</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">						if (!successfullyIntercepted) {</span>
<span class="nc" id="L246">							Logger.error(FormMailAction.class, &quot;Nedoslo k naplneniu dat do wrappera v triede: &quot; + interceptor.getClass().getName());</span>
						}
					}
				}
<span class="nc" id="L250">			} catch (Exception e)</span>
			{
<span class="nc" id="L252">				Logger.error(FormMailAction.class, &quot;Problem s incerceptorom: &quot;, e);</span>
			}
			finally
			{
<span class="nc bnc" id="L256" title="All 2 branches missed.">			if (is!=null) try { is.close(); } catch (Exception ex) { /* */ }</span>
			}
		}
<span class="fc" id="L259">		return wrapped;</span>
	}

	public static String saveForm(HttpServletRequest request, Map&lt;String, List&lt;UploadedFile&gt;&gt; formFilesTable, List&lt;UploadedFile&gt; formFiles, ActionBeanContext context)
	{
<span class="fc" id="L264">		Prop prop = Prop.getInstance(PageLng.getUserLng(request));</span>
<span class="fc" id="L265">		List&lt;IwcmFile&gt; attachs = null;</span>
<span class="fc" id="L266">		boolean attachFiles = true;</span>
<span class="fc" id="L267">		String failStatus=null;</span>

<span class="fc" id="L269">		String formName = request.getParameter(&quot;savedb&quot;);</span>

		//skontroluj multiupload subory
<span class="fc" id="L272">		String[] uploadedFilesParamNameList = request.getParameterValues(&quot;Multiupload.formElementName&quot;);</span>
<span class="pc bpc" id="L273" title="3 of 4 branches missed.">		if (uploadedFilesParamNameList != null &amp;&amp; uploadedFilesParamNameList.length&gt;0)</span>
		{
			//mame to tu znova keby padlo mulipart parsovanie
<span class="nc" id="L276">			FormFileRestriction restriction = null;</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">			if (FormDB.isThereFileRestrictionFor(formName)) restriction = FormDB.getFileRestrictionFor(formName);</span>

			//over subory uploadnute cez HTML5 upload
<span class="nc bnc" id="L280" title="All 2 branches missed.">			for (String uploadedFilesParamName : uploadedFilesParamNameList)</span>
			{
<span class="nc bnc" id="L282" title="All 2 branches missed.">				if (Tools.isNotEmpty(request.getParameter(uploadedFilesParamName)))</span>
				{
<span class="nc" id="L284">					StringBuilder fileNames = new StringBuilder();</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">					for (String keys : request.getParameterValues(uploadedFilesParamName))</span>
					{

<span class="nc bnc" id="L289" title="All 2 branches missed.">						for (String fileKey : Tools.getTokens(keys, &quot;;&quot;))</span>
						{
<span class="nc bnc" id="L291" title="All 2 branches missed.">							if (restriction!=null)</span>
							{
<span class="nc" id="L293">								String filePath = XhrFileUploadServlet.getTempFilePath(fileKey);</span>
<span class="nc" id="L294">								Logger.debug(FormMailAction.class, &quot;Multiupload, fileKey=&quot; + fileKey + &quot; path=&quot; + filePath);</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">								if (filePath != null)</span>
								{
<span class="nc" id="L297">									IwcmFile file = new IwcmFile(filePath);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">									if (file.exists())</span>
									{
<span class="nc bnc" id="L300" title="All 2 branches missed.">										if (restriction.isSentFileValid(file) == false)</span>
										{
<span class="nc" id="L302">											request.setAttribute(&quot;invalidFiles&quot;, &quot;true&quot;);</span>
										}
									}
								}
							}
<span class="nc" id="L307">							String fileName = XhrFileUploadServlet.getTempFileName(fileKey);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">							if (Tools.isNotEmpty(fileName)) {</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">								if (fileNames.length()&gt;0) fileNames.append(&quot;, &quot;);</span>
<span class="nc" id="L310">								fileNames.append(fileName);</span>
							}
						}
					}

					//nastav hodnotu input pola so zoznamom suborov, aby sa nam to pekne vyrenderovalo v maile a HTML verzii
<span class="nc" id="L316">					((IwcmRequest)request).setParameter(uploadedFilesParamName+&quot;-fileNames&quot;, fileNames.toString());</span>
				}
			}
		}

<span class="fc bfc" id="L321" title="All 2 branches covered.">		if (formFiles==null) formFiles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">		if (formFilesTable==null) formFilesTable = new Hashtable&lt;&gt;();</span>

		//toto je thread safe
<span class="fc" id="L325">		String emailEncoding = SetCharacterEncodingFilter.getEncoding();</span>
<span class="fc" id="L326">		String formMailEncoding = Constants.getString(&quot;formMailEncoding&quot;);</span>
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(formMailEncoding))</span>
		{
<span class="nc" id="L329">			emailEncoding = formMailEncoding;</span>
		}
<span class="fc" id="L331">		String formMailEncodingParam = request.getParameter(&quot;formMailEncoding&quot;);</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(formMailEncodingParam))</span>
		{
<span class="nc" id="L334">			emailEncoding = formMailEncodingParam;</span>
		}

<span class="fc" id="L337">		String host = Constants.getString(&quot;smtpServer&quot;);</span>
<span class="fc" id="L338">		String recipients = null;</span>
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">		if (request.getParameter(&quot;recipients&quot;) != null)</span>
		{
<span class="fc" id="L341">			recipients = WriteTag.decodeEmailAddress(request.getParameter(&quot;recipients&quot;));</span>
		}
<span class="pc bpc" id="L343" title="2 of 4 branches missed.">		if (recipients != null &amp;&amp; recipients.indexOf('@') == -1)</span>
		{
<span class="nc" id="L345">			recipients = null;</span>
		}

<span class="fc" id="L348">		String subject = &quot;Formular z www stranky&quot;;</span>
<span class="fc bfc" id="L349" title="All 2 branches covered.">		if (request.getParameter(&quot;subject&quot;) != null)</span>
		{
<span class="fc" id="L351">			subject = request.getParameter(&quot;subject&quot;);</span>
		}

<span class="fc" id="L354">		String email = &quot;&quot;;</span>
<span class="fc" id="L355">		String meno = &quot;&quot;;</span>

<span class="fc" id="L357">		GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L358">		TemplatesDB tempDB = TemplatesDB.getInstance();</span>
<span class="fc" id="L359">		TemplateDetails temp = null;</span>
		GroupDetails group;

		//fmeno sa pouzivalo volakedy, uz je depreaced
<span class="pc bpc" id="L363" title="2 of 4 branches missed.">		if (request.getParameter(&quot;fmeno&quot;) != null || request.getParameter(&quot;fname&quot;) != null)</span>
		{
<span class="nc" id="L365">			String fmeno = request.getParameter(&quot;fmeno&quot;);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">			if (fmeno == null)</span>
			{
<span class="nc" id="L368">				fmeno = request.getParameter(&quot;fname&quot;);</span>
			}
<span class="nc bnc" id="L370" title="All 2 branches missed.">			if (fmeno.indexOf(',') == -1)</span>
			{
<span class="nc" id="L372">				meno = DB.internationalToEnglish(request.getParameter(fmeno));</span>
			}
			else
			{
<span class="nc" id="L376">				StringTokenizer st = new StringTokenizer(fmeno, &quot;,&quot;);</span>
				String token;
<span class="nc" id="L378">				meno = &quot;&quot;;</span>
<span class="nc" id="L379">				StringBuilder buf = new StringBuilder();</span>
<span class="nc bnc" id="L380" title="All 2 branches missed.">				while (st.hasMoreTokens())</span>
				{
<span class="nc" id="L382">					token = st.nextToken();</span>
<span class="nc" id="L383">					buf.append(' ').append(DB.internationalToEnglish(request.getParameter(token)));</span>
				}
<span class="nc" id="L385">				meno = buf.toString();</span>
			}
		}
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">		if (request.getParameter(&quot;femail&quot;) != null)</span>
		{
<span class="nc" id="L390">			email = request.getParameter(request.getParameter(&quot;femail&quot;));</span>
		}
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">		else if (request.getParameter(&quot;e-mail&quot;) != null)</span>
		{
<span class="nc" id="L394">			email = request.getParameter(&quot;e-mail&quot;);</span>
		}
<span class="fc bfc" id="L396" title="All 2 branches covered.">		else if (request.getParameter(&quot;email&quot;) != null)</span>
		{
<span class="fc" id="L398">			email = request.getParameter(&quot;email&quot;);</span>
		}

<span class="fc" id="L401">		String source = null;</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">		if (request.getParameter(&quot;source&quot;) != null)</span>
		{
<span class="nc" id="L404">			source = request.getParameter(&quot;source&quot;);</span>
		}

<span class="fc" id="L407">		String forwardDefault = &quot;/&quot;;</span>
<span class="fc" id="L408">		String forwardOk = null;</span>
<span class="fc" id="L409">		String forwardFail = null;</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">		if (request.getParameter(&quot;forward&quot;) != null) forwardOk = request.getParameter(&quot;forward&quot;);</span>
<span class="pc bpc" id="L411" title="1 of 2 branches missed.">		if (request.getParameter(&quot;forwardFail&quot;) != null) forwardFail = request.getParameter(&quot;forwardFail&quot;);</span>

<span class="fc" id="L413">		DocDB docDB = DocDB.getInstance();</span>

<span class="fc" id="L415">		Integer iLastDocId = null;</span>
<span class="fc" id="L416">		Integer iLastDocIdMail = null;</span>
		try
		{

			try
			{
<span class="fc" id="L422">				String referer = request.getHeader(&quot;referer&quot;);</span>
<span class="pc bpc" id="L423" title="2 of 4 branches missed.">				if (referer!=null &amp;&amp; referer.indexOf(&quot;docid=&quot;) != -1)</span>
				{
					try
					{
<span class="nc" id="L427">						referer = referer.substring(referer.indexOf(&quot;docid=&quot;) + 6);</span>
<span class="nc" id="L428">						StringTokenizer st = new StringTokenizer(referer, &quot;&amp;&quot;);</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">						if (st.hasMoreTokens())</span>
						{
<span class="nc" id="L431">							referer = st.nextToken();</span>
						}
<span class="nc" id="L433">						iLastDocId = Integer.valueOf(Integer.parseInt(referer));</span>
					}
<span class="nc" id="L435">					catch (Exception ex)</span>
					{
						//nerobime nic
<span class="nc" id="L438">					}</span>
				}
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">				else if (referer!=null)</span>
				{
<span class="fc" id="L442">					String url = referer;</span>
<span class="fc" id="L443">					Logger.debug(FormMailAction.class, &quot;referer=&quot;+referer);</span>
					try
					{
<span class="fc" id="L446">						int i = url.indexOf('?');</span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">						if (i!=-1) url = url.substring(0, i);</span>
						//odstran http://xxx/
<span class="fc" id="L449">						i = url.indexOf('/', 10);</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">						if (i != -1)</span>
						{
<span class="fc" id="L452">							url = url.substring(i);</span>
						}

<span class="fc" id="L455">						Logger.debug(FormMailAction.class, &quot;url=&quot;+url);</span>
<span class="fc" id="L456">						i = DocDB.getDocIdFromURL(url, DocDB.getDomain(request));</span>
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">						if (i &gt; 0) iLastDocId = i;</span>

<span class="fc" id="L459">						Logger.debug(FormMailAction.class, &quot;iLastDocId=&quot;+iLastDocId);</span>
					}
<span class="nc" id="L461">					catch (Exception e)</span>
					{
						//nerobime nic
<span class="fc" id="L464">					}</span>
				}
			}
<span class="nc" id="L467">			catch (NumberFormatException ex2)</span>
			{
				//nerobime nic
<span class="fc" id="L470">			}</span>
<span class="pc bpc" id="L471" title="1 of 2 branches missed.">			if (iLastDocId==null)</span>
			{
<span class="nc" id="L473">				iLastDocId = (Integer) request.getSession().getAttribute(&quot;last_doc_id&quot;);</span>
			}

			//niekedy je formular napr v pravom menu, potom sa neparsuje docid podla requestu, ale
			//sa mu musi presne povedat, kde sa ten formular nachadza
<span class="fc bfc" id="L478" title="All 2 branches covered.">			if (request.getParameter(&quot;useFormDocId&quot;)!=null)</span>
			{
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">				if (&quot;none&quot;.equals(request.getParameter(&quot;useFormDocId&quot;)))</span>
				{
<span class="nc" id="L482">					iLastDocId = null;</span>
				}
				else
				{
<span class="fc" id="L486">					iLastDocId = Integer.valueOf(Tools.getIntValue(request.getParameter(&quot;useFormDocId&quot;), -1));</span>
				}
			}
<span class="fc" id="L489">			iLastDocIdMail = iLastDocId;</span>
			//aby sme pre mail mohli specifikovat inu stranku ako to co sa zobrazuje
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">			if (request.getParameter(&quot;useFormMailDocId&quot;)!=null)</span>
			{
<span class="nc bnc" id="L493" title="All 2 branches missed.">				if (&quot;none&quot;.equals(request.getParameter(&quot;useFormMailDocId&quot;)))</span>
				{
<span class="nc" id="L495">					iLastDocIdMail = null;</span>
				}
				else
				{
<span class="nc" id="L499">					iLastDocIdMail = Integer.valueOf(Tools.getIntValue(request.getParameter(&quot;useFormMailDocId&quot;), -1));</span>
				}
			}
<span class="fc" id="L502">			Logger.debug(FormMailAction.class, &quot;iLastDocId=&quot;+iLastDocId);</span>
		}
<span class="pc" id="L504">		catch (Exception ex) { /* nerobime nic */ }</span>


		//id stranky z ktorej je automaticky vyparsovany HTML kod formularu
<span class="fc" id="L508">		int docId = -1;</span>

		//HTML kod stranky pre test emailu (aby sa nedal recipients nastavit iny ako je v stranke)
<span class="fc" id="L511">		String originalPageHtml = null;</span>

<span class="fc" id="L513">		StringBuilder htmlData = new StringBuilder();</span>
<span class="fc" id="L514">		boolean hasHtmlData = false;</span>

<span class="fc" id="L516">		String cssData = null;</span>
<span class="fc" id="L517">		String cssLink = null;</span>

		//tu budu ulozene hodnoty atributu class pre jednotlive polia
		//da sa tak spravit server side kontrola required poli
<span class="fc" id="L521">		List&lt;LabelValueDetails&gt; classNames = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L522">		Map&lt;String, String&gt; labelsTable = new Hashtable&lt;&gt;();</span>

<span class="fc" id="L524">		boolean forceTextPlain = &quot;true&quot;.equals(request.getParameter(&quot;forceTextPlain&quot;));</span>

		//iteruj cez polozky formularu
<span class="fc" id="L527">		StringBuilder fields = null;</span>
<span class="pc bpc" id="L528" title="1 of 2 branches missed.">		if (request.getParameter(&quot;fields&quot;) != null) fields = new StringBuilder(request.getParameter(&quot;fields&quot;));</span>
		//ak je true, fields sa generuju automaticky
<span class="fc" id="L530">		boolean autoFields = false;</span>
<span class="pc bpc" id="L531" title="3 of 4 branches missed.">		if (fields == null || fields.toString().equals(&quot;*&quot;))</span>
		{
			try
			{
<span class="pc bpc" id="L535" title="2 of 4 branches missed.">				if (iLastDocIdMail!=null &amp;&amp; iLastDocId!=null)</span>
				{
<span class="fc" id="L537">					Logger.debug(FormMailAction.class, &quot;iLastDocId(int)=&quot;+iLastDocIdMail);</span>
<span class="fc" id="L538">					DocDetails doc = docDB.getDoc(iLastDocIdMail, -1, false);</span>
<span class="fc" id="L539">					docId = iLastDocId.intValue();</span>

<span class="pc bpc" id="L541" title="1 of 2 branches missed.">					if (doc!=null)</span>
					{
						//toto potrebujeme pre technicke info
<span class="fc" id="L544">						request.setAttribute(&quot;doc_title&quot;, doc.getTitle());</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">						request.setAttribute(&quot;doc_title_seo&quot;, Tools.isEmpty(doc.getFieldQ()) ? doc.getTitle() : doc.getFieldQ());</span>
<span class="fc" id="L546">						request.setAttribute(&quot;doc_full_url&quot;, DocDB.getInstance().getDocLink(doc.getDocId(), doc.getExternalLink(), true, request));</span>

<span class="fc" id="L548">						originalPageHtml = originalPageHtml + doc.getData();</span>

<span class="fc" id="L550">						temp = tempDB.getTemplate(doc.getTempId());</span>
<span class="fc" id="L551">						group = groupsDB.getGroup(doc.getGroupId());</span>

<span class="fc bfc" id="L553" title="All 2 branches covered.">						if (doc.getData().contains(&quot;/components/formsimple/&quot;))</span>
						{
<span class="fc" id="L555">							doc.setData(EditorDB.renderIncludes(doc, false, request));</span>
						}

						//UPDATNI FIELDS
<span class="fc" id="L559">						doc.setData(getCroppedHTML(ShowDoc.updateCodes(null, doc.getData(), iLastDocIdMail.intValue(), request, Constants.getServletContext())));</span>

<span class="fc bfc" id="L561" title="All 2 branches covered.">						if (request.getParameter(&quot;subject&quot;) == null)</span>
						{
<span class="fc" id="L563">							subject = doc.getTitle();</span>
						}

<span class="fc bfc" id="L566" title="All 2 branches covered.">						if (request.getParameter(&quot;forward&quot;) == null)</span>
						{
							//forward robime podla normalneho lastDocId
<span class="fc" id="L569">							forwardDefault = docDB.getDocLink(iLastDocId.intValue());</span>
						}
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">						if (forwardFail==null) forwardFail = docDB.getDocLink(iLastDocId.intValue());</span>

<span class="pc bpc" id="L573" title="1 of 2 branches missed.">						if (request.getParameter(&quot;savedb&quot;) == null)</span>
						{
<span class="nc" id="L575">							formName = DocTools.removeCharsDir(DB.internationalToEnglish(doc.getTitle())).toLowerCase();</span>
						}

<span class="fc" id="L578">						fields = null;</span>
						String field;

						//vytvor strom
<span class="fc" id="L582">						HTMLTokenizer htmlTokenizer = new HTMLTokenizer(Tools.replace(doc.getData(), &quot;/&gt;&quot;, &quot;&gt;&quot;).toCharArray());</span>
						//HTMLTree htmlTree = new HTMLTree(htmlTokenizer);
						@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L585">						Enumeration&lt;Object&gt; e = htmlTokenizer.getTokens();</span>
						TagToken tagToken;
						Object o;
<span class="fc" id="L588">						String skipToTag = null;</span>
<span class="fc" id="L589">						StringBuilder labelContent = null;</span>
<span class="fc" id="L590">						String labelFor = null;</span>
<span class="fc bfc" id="L591" title="All 2 branches covered.">						while (e.hasMoreElements())</span>
						{
<span class="fc" id="L593">							o = e.nextElement();</span>
<span class="fc bfc" id="L594" title="All 2 branches covered.">							if (o instanceof TagToken)</span>
							{
<span class="fc" id="L596">								tagToken = (TagToken) o;</span>
<span class="pc bpc" id="L597" title="1 of 2 branches missed.">								if (hasHtmlData == false)</span>
								{
<span class="fc" id="L599">									htmlData.append(tagToken.getLineForm(request));</span>
								}
<span class="fc" id="L601">								field = tagToken.getFormField();</span>
<span class="fc bfc" id="L602" title="All 2 branches covered.">								if (field!=null)</span>
								{
<span class="fc bfc" id="L604" title="All 2 branches covered.">									if (fields==null) fields = new StringBuilder(field);</span>
									else
									{
										//aby sa neopakovali, napr. radiobuttony
<span class="pc bpc" id="L608" title="1 of 2 branches missed.">										if ((&quot;,&quot;+fields.toString()+&quot;,&quot;).indexOf(&quot;,&quot;+field+&quot;,&quot;)==-1)</span>
										{
<span class="fc" id="L610">											fields.append(&quot;,&quot;).append(field);</span>
										}
									}
								}
<span class="fc" id="L614">								skipToTag = tagToken.getSkipToTag(skipToTag);</span>
<span class="fc" id="L615">								String htmlClass = tagToken.getAttribute(&quot;class&quot;);</span>
<span class="fc bfc" id="L616" title="All 4 branches covered.">								if (htmlClass != null &amp;&amp; htmlClass.contains(&quot;formsimple-wysiwyg&quot;)) {</span>
									//use original value of the field
<span class="fc" id="L618">									request.setAttribute(tagToken.getAttribute(&quot;name&quot;)+&quot;-unescape&quot;, &quot;true&quot;);</span>
								}

<span class="fc" id="L621">								Logger.debug(FormMailAction.class, &quot;TagToken name=&quot;+tagToken.getName()+&quot; for=&quot;+tagToken.getAttribute(&quot;for&quot;));</span>
<span class="fc bfc" id="L622" title="All 2 branches covered.">								if (&quot;label&quot;.equalsIgnoreCase(tagToken.getName()))</span>
								{
<span class="fc bfc" id="L624" title="All 4 branches covered.">									if (tagToken.isEndTag() &amp;&amp; labelFor != null)</span>
									{
<span class="pc bpc" id="L626" title="1 of 2 branches missed.">										if (labelContent != null) labelsTable.put(labelFor, labelContent.toString());</span>
									}
									else
									{
<span class="fc" id="L630">										labelContent = null;</span>
<span class="fc bfc" id="L631" title="All 2 branches covered.">										if (Tools.isNotEmpty(tagToken.getAttribute(&quot;for&quot;))) labelFor = tagToken.getAttribute(&quot;for&quot;);</span>
<span class="fc" id="L632">										else labelFor = null;</span>
									}
								}


<span class="fc" id="L637">								field = tagToken.getAttribute(&quot;name&quot;);</span>
<span class="fc bfc" id="L638" title="All 2 branches covered.">								if (Tools.isEmpty(field)) field = tagToken.getAttribute(&quot;id&quot;);</span>

<span class="fc bfc" id="L640" title="All 2 branches covered.">								if (field!=null)</span>
								{
<span class="fc" id="L642">									String className = tagToken.getAttribute(&quot;class&quot;);</span>
<span class="fc bfc" id="L643" title="All 2 branches covered.">									if (className != null)</span>
									{
<span class="fc" id="L645">										LabelValueDetails lvb = new LabelValueDetails(field, className);</span>
<span class="fc" id="L646">										lvb.setValue2(tagToken.getAttribute(&quot;id&quot;));</span>
<span class="fc" id="L647">										classNames.add(lvb);</span>
<span class="fc" id="L648">										Logger.debug(FormMailAction.class, &quot;className: &quot;+field+&quot;=&quot;+className);</span>
									}

									//skus najst pole nazvane email, to bude odosielatel emailu
<span class="pc bpc" id="L652" title="1 of 2 branches missed.">									if (request.getParameter(&quot;femail&quot;) == null)</span>
									{
<span class="pc bpc" id="L654" title="1 of 4 branches missed.">										if (&quot;email&quot;.equalsIgnoreCase(field) || &quot;e-mail&quot;.equalsIgnoreCase(field))</span>
										{
											//email = request.getParameter(field);
											//field = tagToken.getAttribute(&quot;value&quot;);
<span class="fc" id="L658">											field = request.getParameter(field);</span>
<span class="pc bpc" id="L659" title="2 of 4 branches missed.">											if (field!=null &amp;&amp; field.length()&gt;3)</span>
											{
<span class="fc" id="L661">												email = field;</span>
											}
										}
									}
<span class="pc bpc" id="L665" title="1 of 2 branches missed.">									if (request.getParameter(&quot;fname&quot;) == null)</span>
									{
<span class="pc bpc" id="L667" title="1 of 2 branches missed.">										if (&quot;name&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L668" title="1 of 2 branches missed.">												&quot;firstname&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L669" title="1 of 2 branches missed.">												&quot;lastname&quot;.equalsIgnoreCase(field) ||</span>
<span class="fc bfc" id="L670" title="All 2 branches covered.">												&quot;meno&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L671" title="1 of 2 branches missed.">												&quot;priezvisko&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L672" title="1 of 2 branches missed.">												&quot;jmeno&quot;.equalsIgnoreCase(field) ||</span>
<span class="pc bpc" id="L673" title="1 of 2 branches missed.">												&quot;prijmeni&quot;.equalsIgnoreCase(field)</span>
										)
										{
											//field = tagToken.getAttribute(&quot;value&quot;);
<span class="fc" id="L677">											field = request.getParameter(field);</span>
<span class="pc bpc" id="L678" title="2 of 4 branches missed.">											if (field!=null &amp;&amp; field.length()&gt;3)</span>
											{
<span class="pc bpc" id="L680" title="2 of 4 branches missed.">												if (meno==null || meno.length()==0)</span>
												{
<span class="fc" id="L682">													meno = DB.internationalToEnglish(field);</span>
												}
												else
												{
<span class="nc" id="L686">													meno += &quot; &quot; + DB.internationalToEnglish(field); //NOSONAR</span>
												}
											}
										}
									}
								}
<span class="fc" id="L692">							}</span>
							else
							{
<span class="pc bpc" id="L695" title="1 of 2 branches missed.">								if (skipToTag == null) htmlData.append(o.toString());</span>
<span class="fc bfc" id="L696" title="All 2 branches covered.">								if (labelFor != null)</span>
								{
<span class="fc bfc" id="L698" title="All 2 branches covered.">									if (labelContent == null) labelContent = new StringBuilder(o.toString());</span>
<span class="fc" id="L699">									else labelContent.append(o.toString());</span>
								}
							}
						}

<span class="pc bpc" id="L704" title="1 of 2 branches missed.">						if (htmlData.length() &gt; 10)</span>
						{
<span class="fc" id="L706">							hasHtmlData = true;</span>

<span class="pc bpc" id="L708" title="1 of 4 branches missed.">							if (Constants.getBoolean(&quot;formMailSendPlainText&quot;)==false &amp;&amp; forceTextPlain==false)</span>
							{
								try
								{
<span class="fc" id="L712">									cssData = &quot;&lt;style type='text/css'&gt;&quot;;</span>
<span class="fc" id="L713">									cssLink = &quot;&quot;;</span>

<span class="pc bpc" id="L715" title="1 of 2 branches missed.">									if (temp != null)</span>
									{
<span class="fc" id="L717">										String domainAlias = MultiDomainFilter.getDomainAlias(group.getDomainName());</span>

<span class="fc" id="L719">										String tempCssLink = null;</span>
<span class="pc bpc" id="L720" title="2 of 4 branches missed.">										if (temp.getCss() != null &amp;&amp; temp.getCss().length() &gt; 1)</span>
										{
<span class="nc" id="L722">											tempCssLink = temp.getCss();</span>
<span class="nc bnc" id="L723" title="All 6 branches missed.">											if (group!=null &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;)==true &amp;&amp; Tools.isNotEmpty(group.getDomainName()))</span>
											{
												//ak je cssko v /templates adresari uz domain alias nepridavame
<span class="nc bnc" id="L726" title="All 6 branches missed.">												if (tempCssLink.contains(domainAlias)==false &amp;&amp; tempCssLink.contains(&quot;/templates/&quot;)==false &amp;&amp; tempCssLink.contains(&quot;/files/&quot;)==false)</span>
												{
<span class="nc" id="L728">													tempCssLink = Tools.replace(tempCssLink, &quot;/css/&quot;, &quot;/css/&quot; + domainAlias + &quot;/&quot;);</span>
												}
											}
										}
<span class="fc" id="L732">										String baseCssPath = temp.getBaseCssPath();</span>
<span class="pc bpc" id="L733" title="3 of 6 branches missed.">										if (group!=null &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;)==true &amp;&amp; Tools.isNotEmpty(group.getDomainName()))</span>
										{
											//ak je cssko v /templates adresari uz domain alias nepridavame
<span class="pc bpc" id="L736" title="5 of 6 branches missed.">											if (baseCssPath.contains(domainAlias)==false &amp;&amp; baseCssPath.contains(&quot;/templates/&quot;)==false &amp;&amp; baseCssPath.contains(&quot;/files/&quot;)==false)</span>
											{

<span class="nc" id="L739">												baseCssPath = Tools.replace(baseCssPath, &quot;/css/&quot;, &quot;/css/&quot; + MultiDomainFilter.getDomainAlias(group.getDomainName()) + &quot;/&quot;); //NOSONAR</span>
											}
										}

<span class="fc" id="L743">										String editorEditorCss = Constants.getString(&quot;editorEditorCss&quot;);</span>

<span class="fc" id="L745">										tempCssLink = checkEmailCssVersion(tempCssLink);</span>
<span class="fc" id="L746">										baseCssPath = checkEmailCssVersion(baseCssPath);</span>
<span class="fc" id="L747">										editorEditorCss = checkEmailCssVersion(editorEditorCss);</span>

<span class="fc" id="L749">										Logger.debug(FormMailAction.class, &quot;Reading baseCSS: &quot;+baseCssPath+&quot; tempCss: &quot;+tempCssLink);</span>

										//nacitaj css styl ako v editore stranok
<span class="fc" id="L752">										StringBuilder cssStyle = new StringBuilder(FileTools.readFileContent(baseCssPath)).append('\n');</span>
<span class="pc bpc" id="L753" title="1 of 2 branches missed.">										if (tempCssLink!=null) cssStyle.append(FileTools.readFileContent(tempCssLink)).append('\n');</span>
<span class="fc" id="L754">										cssStyle.append(FileTools.readFileContent(editorEditorCss)).append('\n');</span>

<span class="fc" id="L756">										cssData += cssStyle.toString();</span>
<span class="fc" id="L757">										cssLink += &quot;&lt;link rel='stylesheet' href='&quot;+baseCssPath+&quot;' type='text/css'/&gt;\n&quot;;</span>
<span class="pc bpc" id="L758" title="1 of 2 branches missed.">										if (tempCssLink!=null) cssLink += &quot;&lt;link rel='stylesheet' href='&quot;+tempCssLink+&quot;' type='text/css'/&gt;\n&quot;;</span>
<span class="fc" id="L759">										cssLink += &quot;&lt;link rel='stylesheet' href='&quot;+editorEditorCss+&quot;' type='text/css'/&gt;\n&quot;;</span>
<span class="fc" id="L760">									}</span>
									else
									{
										//nacitaj css styl
<span class="nc" id="L764">										InputStream is = Constants.getServletContext().getResourceAsStream(&quot;/css/email.css&quot;);</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">										if (is==null)</span>
										{
<span class="nc" id="L767">											is = Constants.getServletContext().getResourceAsStream(Constants.getString(&quot;editorPageCss&quot;));</span>
<span class="nc" id="L768">											cssLink += &quot;&lt;link rel='stylesheet' href='&quot;+Constants.getString(&quot;editorPageCss&quot;)+&quot;' type='text/css'/&gt;\n&quot;;</span>
										}
										else
										{
<span class="nc" id="L772">											cssLink += &quot;&lt;link rel='stylesheet' href='/css/email.css' type='text/css'/&gt;\n&quot;;</span>
										}
<span class="nc bnc" id="L774" title="All 2 branches missed.">										if (is!=null)</span>
										{
<span class="nc" id="L776">											BufferedReader br = new BufferedReader(new InputStreamReader(is, Constants.FILE_ENCODING));</span>
											String line;
<span class="nc" id="L778">											StringBuilder startBuf = new StringBuilder(cssData);</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">											while ((line=br.readLine())!=null)</span>
											{
<span class="nc" id="L781">												startBuf.append(line).append('\n');</span>
											}
<span class="nc" id="L783">											cssData = startBuf.toString();</span>
										}
									}
								}
<span class="nc" id="L787">								catch (Exception ex)</span>
								{
<span class="nc" id="L789">									Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L790">								}</span>

<span class="fc" id="L792">								cssData += &quot;&lt;/style&gt;&quot;;</span>
							}
						}
					}
				}
			}
<span class="nc" id="L798">			catch (Exception ex)</span>
			{
<span class="nc" id="L800">				Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L801">			}</span>
		}
<span class="pc bpc" id="L803" title="2 of 4 branches missed.">		if (fields == null || fields.toString().equals(&quot;*&quot;))</span>
		{
			//vytvor fields...
<span class="nc" id="L806">			fields = null;</span>
<span class="nc" id="L807">			autoFields = true;</span>
<span class="nc" id="L808">			Enumeration&lt;String&gt; params = request.getParameterNames();</span>
			String param;
<span class="nc bnc" id="L810" title="All 2 branches missed.">			while (params.hasMoreElements())</span>
			{
<span class="nc" id="L812">				param = params.nextElement();</span>
<span class="nc" id="L813">				param = Tools.replace(param, &quot;amp;&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L814" title="All 6 branches missed.">				if (&quot;recipients&quot;.equals(param) || &quot;savedb&quot;.equals(param) || &quot;__lng&quot;.equals(param)) continue;</span>

<span class="nc bnc" id="L816" title="All 2 branches missed.">				if (fields == null)</span>
				{
<span class="nc" id="L818">					fields = new StringBuilder(param);</span>
				}
				else
				{
<span class="nc" id="L822">					fields.append(&quot;,&quot;).append(param);</span>
				}
			}
		}

<span class="fc" id="L827">		Logger.debug(FormMailAction.class, &quot;fields=&quot;+fields);</span>

<span class="pc bpc" id="L829" title="1 of 2 branches missed.">		boolean hasCaptchaInclude = htmlData.indexOf(&quot;captcha.jsp&quot;)!=-1;</span>
<span class="fc bfc" id="L830" title="All 2 branches covered.">		if (forceTextPlain)</span>
		{
<span class="fc" id="L832">			hasHtmlData = false;</span>
<span class="fc" id="L833">			htmlData.setLength(0);</span>
		}

<span class="fc" id="L836">		CryptoFactory cryptoFactory = new CryptoFactory();</span>
<span class="fc" id="L837">		String publicKey = request.getParameter(&quot;encryptKey&quot;);</span>

<span class="fc" id="L839">		StringBuilder db_data = null;</span>
<span class="fc" id="L840">		StringBuilder db_data_names = null;</span>
<span class="fc" id="L841">		boolean addFieldToDatabase = true;</span>
<span class="pc bpc" id="L842" title="1 of 2 branches missed.">		if (fields != null)</span>
		{
<span class="fc" id="L844">			request.setAttribute(&quot;fields&quot;, fields.toString());</span>
<span class="fc" id="L845">			StringTokenizer st = new StringTokenizer(fields.toString(), &quot;,&quot;);</span>
			String field;
			String value;

<span class="fc bfc" id="L849" title="All 2 branches covered.">			while (st.hasMoreTokens())</span>
			{
<span class="fc" id="L851">				field = st.nextToken();</span>
<span class="pc bpc" id="L852" title="1 of 2 branches missed.">				if (field == null) continue;</span>

				//tieto pre istotu preskakujeme
<span class="pc bpc" id="L855" title="4 of 8 branches missed.">				if (&quot;useFormDocId&quot;.equals(field) || &quot;g-recaptcha-response&quot;.equals(field) || &quot;bSubmit&quot;.equals(field) || &quot;__token&quot;.equals(field) ||</span>
<span class="pc bpc" id="L856" title="3 of 6 branches missed.">						&quot;addTechInfo&quot;.equals(field) || &quot;forceTextPlain&quot;.equals(field) || &quot;subject&quot;.equals(field) ||</span>
<span class="pc bpc" id="L857" title="5 of 10 branches missed.">						&quot;pictureHeight&quot;.equals(field) || &quot;maxSizeInKilobytes&quot;.equals(field) || &quot;messageAsAttachFileName&quot;.equals(field) || &quot;useFormMailDocId&quot;.equals(field) || &quot;pictureWidth&quot;.equals(field) ||</span>
<span class="pc bpc" id="L858" title="2 of 4 branches missed.">						field.startsWith(&quot;formmail&quot;) || &quot;useFormDocIdOriginal&quot;.equals(field)) continue;</span>

<span class="fc" id="L860">				value = getValue(field, request, formFilesTable);</span>
<span class="fc" id="L861">				String fieldText = field;</span>
<span class="fc bfc" id="L862" title="All 2 branches covered.">				if (forceTextPlain) fieldText = fieldToText(fieldText, labelsTable);</span>

<span class="fc" id="L864">				value = value.replace('|', ' ');</span>
<span class="fc" id="L865">				field = field.replace('|', ' ');</span>

<span class="fc" id="L867">				RequestBean.addAllowedParameter(field);</span>

<span class="pc bpc" id="L869" title="5 of 6 branches missed.">				if (autoFields &amp;&amp; htmlData != null &amp;&amp; hasHtmlData)</span>
				{
					//do databazy pridavame iba fieldy ktore sa najdu v HTML
<span class="nc bnc" id="L872" title="All 2 branches missed.">					if (htmlData.indexOf(&quot;!&quot; + field + &quot;!&quot;) != -1)</span>
					{
<span class="nc" id="L874">						addFieldToDatabase = true;</span>
					}
					else
					{
<span class="nc" id="L878">						addFieldToDatabase = false;</span>
					}
				}
				else
				{
<span class="fc" id="L883">					addFieldToDatabase = true;</span>
				}

<span class="pc bpc" id="L886" title="1 of 2 branches missed.">				if (addFieldToDatabase)</span>
				{
<span class="fc bfc" id="L888" title="All 2 branches covered.">					if (db_data == null)</span>
					{
<span class="fc" id="L890">						db_data = new StringBuilder(field + &quot;~&quot; + cryptoFactory.encrypt(value, publicKey));</span>
<span class="fc" id="L891">						db_data_names = new StringBuilder(field);</span>
					}
					else
					{
<span class="pc bpc" id="L895" title="1 of 2 branches missed.">						if (db_data_names == null) db_data_names = new StringBuilder();</span>
<span class="fc" id="L896">						db_data.append(&quot;|&quot;).append(field).append(&quot;~&quot;).append(cryptoFactory.encrypt(value, publicKey));</span>
<span class="fc" id="L897">						db_data_names.append(&quot;|~&quot;).append(field);</span>
					}
				}
				try
				{
<span class="pc bpc" id="L902" title="1 of 4 branches missed.">					if (htmlData != null &amp;&amp; hasHtmlData)</span>
					{
						//ak je to nieco ako Hodnota_checkboxu zmen to na Hodnota checkboxu
<span class="fc bfc" id="L905" title="All 4 branches covered.">						if (value.indexOf(' ') == -1 &amp;&amp; value.indexOf('@')==-1)</span>
						{
<span class="fc" id="L907">							value = value.replace('_', ' ');</span>
						}
						//nahradu spravim len v pripade, ked nie je pouzity specialny tvar HTML kodu
<span class="pc bpc" id="L910" title="3 of 4 branches missed.">						if (value.length() &lt; 1 &amp;&amp; Tools.isEmpty(source))</span>
						{
<span class="nc" id="L912">							value = &quot;&amp;nbsp;&quot;;</span>
						}
<span class="fc" id="L914">						value = Tools.replace(value, &quot;\n&quot;, &quot;&lt;br&gt;&quot;);</span>
<span class="fc" id="L915">						htmlData = Tools.replace(htmlData, &quot;!&quot; + field + &quot;!&quot;, value);</span>
					}
					else
					{
						//asi checkbox
<span class="pc bpc" id="L920" title="1 of 4 branches missed.">						if (&quot;true&quot;.equals(value) || &quot;on&quot;.equals(value)) value = &quot;[X]&quot;;</span>
<span class="fc" id="L921">						fieldText = field;</span>
<span class="pc bpc" id="L922" title="1 of 2 branches missed.">						if (forceTextPlain) fieldText = fieldToText(fieldText, labelsTable);</span>
<span class="fc" id="L923">						htmlData.append(fieldText).append(&quot;: &quot;).append(value).append(&quot;\n&quot;);</span>
					}
				}
<span class="nc" id="L926">				catch (Exception ex)</span>
				{
<span class="nc" id="L928">					Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L929">				}</span>
<span class="fc" id="L930">			}</span>
		}

<span class="fc bfc" id="L933" title="All 2 branches covered.">		if (&quot;true&quot;.equals(request.getParameter(&quot;addTechInfo&quot;)))</span>
		{
<span class="fc" id="L935">			String techInfoHtml = prop.getText(&quot;components.formsimple.techinfo&quot;);</span>
<span class="fc" id="L936">			techInfoHtml = ShowDoc.updateCodes(null, techInfoHtml, docId, request, Constants.getServletContext());</span>
<span class="fc bfc" id="L937" title="All 2 branches covered.">			if (forceTextPlain)</span>
			{
<span class="fc" id="L939">				techInfoHtml = SearchTools.htmlToPlain(techInfoHtml);</span>
			}
<span class="fc" id="L941">			htmlData.append(&quot;\n\n&quot;).append(techInfoHtml);</span>
		}

		//ak je nastavene beforePostMethod tak to sem dokaze nastavit return parametre
<span class="fc" id="L945">		String beforePostReturnParams = null;</span>

		//ak aktualizujeme zaznam, toto potom nastavime na false, aby sa nic neposlalo
<span class="fc" id="L948">		boolean emailAllowed = true;</span>

		//kontrola recipients voci povodnemu HTML kodu
<span class="pc bpc" id="L951" title="2 of 4 branches missed.">		if (originalPageHtml!=null &amp;&amp; Tools.isNotEmpty(originalPageHtml))</span>
		{
<span class="pc bpc" id="L953" title="3 of 8 branches missed.">			if (recipients!=null &amp;&amp; Tools.isNotEmpty(recipients) &amp;&amp; Constants.getBoolean(&quot;spamProtection&quot;) &amp;&amp; !&quot;true&quot;.equals(request.getAttribute(&quot;DBrecipients&quot;))) //DBrecipients sa nastavi v fillRequestWithDatabaseOptions</span>
			{
				int j;
<span class="nc" id="L956">				String[] recipientsArray = recipients.toLowerCase().split(&quot;,&quot;);</span>

<span class="nc" id="L958">				String pageHtmlLC = originalPageHtml.toLowerCase();</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">				for (j=0; j&lt;recipientsArray.length; j++)</span>
				{
<span class="nc bnc" id="L961" title="All 4 branches missed.">					if (pageHtmlLC.indexOf(recipientsArray[j].trim())==-1 &amp;&amp; pageHtmlLC.indexOf(WriteTagToolsForCore.encodeEmailAddress(recipientsArray[j].trim()))==-1)</span>
					{
<span class="nc" id="L963">						emailAllowed = false;</span>
<span class="nc" id="L964">						break;</span>
					}
				}
<span class="nc" id="L967">			}</span>
		}
		else
		{
<span class="nc" id="L971">			emailAllowed = false;</span>
		}

<span class="fc" id="L974">		String allowedRecipients = Constants.getString(&quot;formmailAllowedRecipients&quot;);</span>
<span class="pc bpc" id="L975" title="1 of 2 branches missed.">		if (Tools.isEmpty(allowedRecipients)) allowedRecipients = &quot;@&quot;+Tools.getServerName(request); //aby sa nahodou nestalo, ze je niekde zabudnute nastavenie email adresy</span>
<span class="pc bpc" id="L976" title="9 of 10 branches missed.">		if (emailAllowed == false &amp;&amp; allowedRecipients!=null &amp;&amp; Tools.isNotEmpty(allowedRecipients) &amp;&amp; recipients!=null &amp;&amp; Tools.isNotEmpty(recipients))</span>
		{
			try
			{
<span class="nc" id="L980">				String[] arArray = allowedRecipients.split(&quot;,&quot;);</span>
				int i;
				int j;
<span class="nc" id="L983">				String[] recipientsArray = recipients.split(&quot;,&quot;);</span>

<span class="nc bnc" id="L985" title="All 2 branches missed.">				for (j=0; j&lt;recipientsArray.length; j++)</span>
				{
<span class="nc" id="L987">					boolean emailFound = false;</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">					for (i=0; i&lt;arArray.length; i++)</span>
					{
<span class="nc bnc" id="L990" title="All 2 branches missed.">						if (recipientsArray[j].toLowerCase().endsWith(arArray[i]))</span>
						{
<span class="nc" id="L992">							emailFound = true;</span>
						}
					}
<span class="nc bnc" id="L995" title="All 2 branches missed.">					if (emailFound)</span>
					{
<span class="nc" id="L997">						emailAllowed = true;</span>
<span class="nc" id="L998">						break;</span>
					}
				}
			}
<span class="nc" id="L1002">			catch (Exception ex)</span>
			{
<span class="nc" id="L1004">				Logger.error(FormMailAction.class, ex);</span>
<span class="nc" id="L1005">			}</span>
		}

<span class="pc bpc" id="L1008" title="1 of 2 branches missed.">		if (&quot;cloud&quot;.equals(Constants.getInstallName()))</span>
		{
<span class="nc bnc" id="L1010" title="All 2 branches missed.">			if (Tools.isEmpty(recipients))</span>
			{
<span class="nc" id="L1012">				UserDetails admin = CloudToolsForCore.getAdmin();</span>
<span class="nc bnc" id="L1013" title="All 4 branches missed.">				if (admin != null &amp;&amp; Tools.isEmail(admin.getEmail())) recipients = admin.getEmail();</span>
			}
		}

<span class="fc" id="L1017">		boolean spamProtectionEnabled = true;</span>
<span class="pc bpc" id="L1018" title="2 of 4 branches missed.">		if (temp != null) spamProtectionEnabled = temp.isDisableSpamProtection()==false;</span>

		//conf value overrides everything
<span class="fc bfc" id="L1021" title="All 2 branches covered.">		if (Constants.getBoolean(&quot;spamProtection&quot;)==false) spamProtectionEnabled = false;</span>

		//DETEKCIA SPAMU
<span class="fc" id="L1024">		boolean isCaptchOk = true;</span>
<span class="fc bfc" id="L1025" title="All 2 branches covered.">		if (spamProtectionEnabled) {</span>
<span class="fc" id="L1026">			isCaptchOk = checkCaptcha(request, hasCaptchaInclude);</span>
		}

<span class="fc" id="L1029">		boolean isSpam = true;</span>
		//spam kontrolujeme len ak je captcha OK, inak nam zarata odoslanie a musime cakat 30 sekund
<span class="pc bpc" id="L1031" title="1 of 2 branches missed.">		if (isCaptchOk) {</span>
<span class="fc bfc" id="L1032" title="All 2 branches covered.">			if (spamProtectionEnabled)	isSpam = detectSpam(request, htmlData.toString(), toString(db_data_names));</span>
<span class="fc" id="L1033">			else isSpam = false;</span>
		}

<span class="fc" id="L1036">		boolean requiredFieldsOk = checkRequiredFields(request, classNames, labelsTable, context);</span>
<span class="pc bpc" id="L1037" title="1 of 2 branches missed.">		boolean areFilesOk = request.getAttribute(&quot;invalidFiles&quot;) == null;</span>
<span class="fc" id="L1038">		boolean isFormNameOk = true;</span>
<span class="fc" id="L1039">		boolean isCsrfCorrect = true;</span>
<span class="fc bfc" id="L1040" title="All 2 branches covered.">		if (spamProtectionEnabled) {</span>
<span class="fc" id="L1041">			isCsrfCorrect = checkCsrf(request);</span>
		}

<span class="pc bpc" id="L1044" title="3 of 4 branches missed.">		if (&quot;public&quot;.equals(Constants.getString(&quot;clusterMyNodeType&quot;)) &amp;&amp; Constants.getBoolean(&quot;formAllowOnlyExistingFormsOnPublicNode&quot;)==true)</span>
		{
			//na public node umoznime odoslat len definovane formulare
<span class="nc" id="L1047">			int recordsCount = new SimpleQuery().forInt(&quot;select count(form_name) from form_attributes where form_name=?&quot;, formName);</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">			if (recordsCount &lt; 1)</span>
			{
<span class="nc" id="L1050">				isFormNameOk = false;</span>

				//RequestBean.setErrorText(&quot;send_mail_error.attributes&quot;);
<span class="nc" id="L1053">				RequestBean.addError(&quot;Chyba overenia atributov formularu (na public node, formular nema definovane ziadne atributy - asi neexistuje)&quot;);</span>
<span class="nc" id="L1054">				RequestBean.addParameter(&quot;formName&quot;, formName);</span>
<span class="nc" id="L1055">				RequestBean.addParameter(&quot;DBDataNames&quot;, toString(db_data_names));</span>

<span class="nc" id="L1057">				Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, -1);</span>

			}
		}

<span class="fc" id="L1062">		int formId = -1;</span>
<span class="pc bpc" id="L1063" title="6 of 14 branches missed.">		boolean validationFailed = isSpam || requiredFieldsOk==false || emailAllowed==false || areFilesOk==false || isCaptchOk==false || isFormNameOk==false || isCsrfCorrect==false;</span>
<span class="fc bfc" id="L1064" title="All 2 branches covered.">		if (validationFailed)</span>
		{
<span class="pc bpc" id="L1066" title="1 of 2 branches missed.">			if (emailAllowed==false) failStatus = &quot;probablySpamBotEmail&quot;;</span>
<span class="pc bpc" id="L1067" title="1 of 2 branches missed.">			else if (requiredFieldsOk==false) failStatus = &quot;requiredFields&quot;;</span>
<span class="pc bpc" id="L1068" title="1 of 2 branches missed.">			else if (areFilesOk==false) failStatus = &quot;bad_file&quot;;</span>
<span class="pc bpc" id="L1069" title="1 of 2 branches missed.">			else if (isCaptchOk==false) failStatus = &quot;captcha&quot;;</span>
<span class="pc bpc" id="L1070" title="1 of 2 branches missed.">			else if (isCsrfCorrect==false) failStatus = &quot;probablySpamBotCsrf&quot;;</span>
<span class="fc" id="L1071">			else failStatus = &quot;probablySpamBot&quot;;</span>

<span class="fc" id="L1073">			emailAllowed = false;</span>

			//RequestBean.setErrorText(&quot;send_mail_error.&quot; + failStatus);
<span class="fc" id="L1076">			RequestBean.addError(prop.getText(&quot;send_mail_error.&quot; + failStatus), false);</span>
<span class="fc" id="L1077">			RequestBean.addParameter(&quot;formName&quot;, request.getParameter(&quot;savedb&quot;));</span>

<span class="fc" id="L1079">			Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, formId);</span>

		}
		else
		{

			//DETEKCIA SPAMU KONIEC

<span class="fc" id="L1087">			htmlData = new StringBuilder(replaceCaptchaInclude(request, htmlData.toString()));</span>

<span class="fc" id="L1089">			StringBuilder fileNames = null;</span>
<span class="fc" id="L1090">			StringBuilder fileNamesSendLater = null;	//ak nemame SMTP server sem ukladame odkazy pre SendMail.sendLater (ma ich inak formatovane)</span>
			//oki doki, strc to do databazy

<span class="fc" id="L1093">			Logger.debug(FormMailAction.class, &quot;db_data_names=&quot;+toString(db_data_names)+&quot; db_data=&quot;+toString(db_data)+&quot; formName=&quot;+formName);</span>



<span class="fc" id="L1097">			Connection db_conn = null;</span>
<span class="fc" id="L1098">			PreparedStatement ps = null;</span>
<span class="fc" id="L1099">			ResultSet rs = null;</span>
			try
			{
<span class="pc bpc" id="L1102" title="4 of 8 branches missed.">				if (formName != null &amp;&amp; formName.length() &gt; 0 &amp;&amp; db_data_names!=null &amp;&amp; db_data_names.length()&gt;3)</span>
				{
<span class="fc" id="L1104">					db_conn = DBPool.getConnection(request);</span>
<span class="fc" id="L1105">					ps = db_conn.prepareStatement(&quot;SELECT min(id) AS id FROM forms WHERE form_name=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1106">					ps.setString(1, formName);</span>
<span class="fc" id="L1107">					rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1108" title="1 of 2 branches missed.">					if (rs.next())</span>
					{
<span class="fc" id="L1110">						formId = rs.getInt(&quot;id&quot;);</span>
					}
<span class="fc bfc" id="L1112" title="All 2 branches covered.">					if (formId &lt; 1)</span>
					{
<span class="fc" id="L1114">						formId = -1;</span>
					}

<span class="fc" id="L1117">					rs.close();</span>
<span class="fc" id="L1118">					ps.close();</span>
<span class="fc bfc" id="L1119" title="All 2 branches covered.">					if (formId == -1)</span>
					{
						//vytvor hlavicku s udajmi o datach formulara
<span class="fc" id="L1122">						ps = db_conn.prepareStatement(&quot;INSERT INTO forms (form_name, data, user_id, doc_id, domain_id) VALUES (?, ?, -1, -1, ?)&quot;);</span>
<span class="fc" id="L1123">						ps.setString(1, formName);</span>
<span class="fc" id="L1124">						DB.setClob(ps, 2, toString(db_data_names));</span>
<span class="fc" id="L1125">						ps.setInt(3, CloudToolsForCore.getDomainId());</span>
<span class="fc" id="L1126">						ps.execute();</span>
<span class="fc" id="L1127">						ps.close();</span>
					}
					else
					{
<span class="pc bpc" id="L1131" title="1 of 2 branches missed.">						if (db_data_names!=null)</span>
						{
							//hlavicka uz existuje, iba ju updatneme
<span class="fc" id="L1134">							ps = db_conn.prepareStatement(&quot;UPDATE forms SET data=? WHERE id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1135">							DB.setClob(ps, 1, toString(db_data_names));</span>
<span class="fc" id="L1136">							ps.setInt(2, formId);</span>
<span class="fc" id="L1137">							ps.execute();</span>
<span class="fc" id="L1138">							ps.close();</span>
						}
					}

<span class="fc" id="L1142">					int userId = -1;</span>
					try
					{
<span class="fc" id="L1145">						Identity user = UsersDB.getCurrentUser(request);</span>
<span class="fc bfc" id="L1146" title="All 2 branches covered.">						if (user!=null)</span>
						{
<span class="fc" id="L1148">							userId = user.getUserId();</span>
						}
					}
<span class="nc" id="L1151">					catch (Exception ex)</span>
					{
<span class="nc" id="L1153">						Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L1154">					}</span>

<span class="pc bpc" id="L1156" title="1 of 4 branches missed.">					if (userId &gt; 0 &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;formmail_overwriteOldForms&quot;)))</span>
					{
<span class="nc" id="L1158">						ps = db_conn.prepareStatement(&quot;DELETE FROM forms WHERE form_name=? AND user_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1159">						ps.setString(1, formName);</span>
<span class="nc" id="L1160">						ps.setInt(2, userId);</span>
<span class="nc" id="L1161">						ps.execute();</span>
<span class="nc" id="L1162">						ps.close();</span>
					}

<span class="fc" id="L1165">					boolean allowInsert = true;</span>

<span class="pc bpc" id="L1167" title="1 of 4 branches missed.">					if (userId &gt; 0 &amp;&amp; &quot;true&quot;.equals(request.getParameter(&quot;formmail_allowOnlyOneSubmit&quot;)))</span>
					{
<span class="nc" id="L1169">						ps = db_conn.prepareStatement(&quot;SELECT * FROM forms WHERE form_name=? AND user_id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1170">						ps.setString(1, formName);</span>
<span class="nc" id="L1171">						ps.setInt(2, userId);</span>
<span class="nc" id="L1172">						rs = ps.executeQuery();</span>
<span class="nc bnc" id="L1173" title="All 2 branches missed.">						if (rs.next())</span>
						{
<span class="nc" id="L1175">							emailAllowed = false;</span>
<span class="nc" id="L1176">							allowInsert = false;</span>
<span class="nc" id="L1177">							failStatus = &quot;formIsAllreadySubmitted&quot;;</span>

							//RequestBean.setServerClas(&quot;send_mail_error.formIsAllreadySubmitted&quot;);
<span class="nc" id="L1180">							RequestBean.addError(&quot;Formular sa uz odosiela&quot;);</span>
<span class="nc" id="L1181">							RequestBean.addParameter(&quot;formName&quot;, request.getParameter(&quot;savedb&quot;));</span>
<span class="nc" id="L1182">							RequestBean.addParameter(&quot;DBDataNames&quot;, toString(db_data_names));</span>

<span class="nc" id="L1184">							Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, formId);</span>

						}
<span class="nc" id="L1187">						rs.close();</span>
<span class="nc" id="L1188">						ps.close();</span>
					}

<span class="pc bpc" id="L1191" title="1 of 2 branches missed.">					if (allowInsert)</span>
					{
<span class="fc" id="L1193">						Identity user = UsersDB.getCurrentUser(request);</span>
<span class="fc" id="L1194">						int editFormId = Tools.getIntValue(request.getParameter(&quot;_editFormId&quot;), -1);</span>
<span class="fc" id="L1195">						Logger.debug(FormMailAction.class, &quot;editFormId=&quot;+editFormId);</span>
<span class="pc bpc" id="L1196" title="2 of 6 branches missed.">						if (user!=null &amp;&amp; user.isAdmin()==true &amp;&amp; editFormId&gt;0)</span>
						{
<span class="nc" id="L1198">							Logger.debug(FormMailAction.class, &quot;Updating form: &quot;+editFormId);</span>

<span class="nc" id="L1200">							ps = db_conn.prepareStatement(&quot;UPDATE forms SET data=?, html=? WHERE id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="nc" id="L1201">							DB.setClob(ps, 1, toString(db_data));</span>
<span class="nc" id="L1202">							DB.setClob(ps, 2, cryptoFactory.encrypt(appendStyle(htmlData.toString(), cssLink, null, forceTextPlain), publicKey));</span>
<span class="nc" id="L1203">							ps.setInt(3, editFormId);</span>
<span class="nc" id="L1204">							ps.execute();</span>
<span class="nc" id="L1205">							ps.close();</span>

<span class="nc" id="L1207">							formId = editFormId;</span>

<span class="nc" id="L1209">							emailAllowed = false;</span>
						}
						else
						{
<span class="fc" id="L1213">							long l_now = (new java.util.Date()).getTime();</span>
<span class="fc" id="L1214">							ps = db_conn.prepareStatement(&quot;INSERT INTO forms (form_name, data, create_date, html, user_id, doc_id, domain_id) VALUES (?, ?, ?, ?, ?, ?, ?)&quot;);</span>
<span class="fc" id="L1215">							ps.setString(1, formName);</span>
<span class="fc" id="L1216">							DB.setClob(ps, 2, toString(db_data));</span>
<span class="fc" id="L1217">							ps.setTimestamp(3, new Timestamp(l_now));</span>
<span class="fc" id="L1218">							DB.setClob(ps, 4, cryptoFactory.encrypt(appendStyle(htmlData.toString(), cssLink, null, forceTextPlain), publicKey));</span>
<span class="fc" id="L1219">							ps.setInt(5, userId);</span>
<span class="fc" id="L1220">							ps.setInt(6, docId);</span>
<span class="fc" id="L1221">							ps.setInt(7, CloudToolsForCore.getDomainId());</span>
<span class="fc" id="L1222">							ps.execute();</span>
<span class="fc" id="L1223">							ps.close();</span>

							//	ziskaj id zaznamu
<span class="fc" id="L1226">							ps = db_conn.prepareStatement(&quot;SELECT max(id) AS id FROM forms WHERE form_name=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1227">							ps.setString(1, formName);</span>
<span class="fc" id="L1228">							rs = ps.executeQuery();</span>
<span class="pc bpc" id="L1229" title="1 of 2 branches missed.">							if (rs.next())</span>
							{
<span class="fc" id="L1231">								formId = rs.getInt(&quot;id&quot;);</span>
							}
<span class="fc" id="L1233">							rs.close();</span>
<span class="fc" id="L1234">							ps.close();</span>

							try
							{
								//v try je to preto, ze som si nie isty ci Oracle zvladne zapis !=
								//updatni doc_id, pretoze historicky moze byt zapisane zle
<span class="fc" id="L1240">								ps = db_conn.prepareStatement(&quot;UPDATE forms SET doc_id=? WHERE form_name=? AND doc_id&gt;0 AND doc_id!=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1241">								ps.setInt(1, docId);</span>
<span class="fc" id="L1242">								ps.setString(2, formName);</span>
<span class="fc" id="L1243">								ps.setInt(3, docId);</span>
<span class="fc" id="L1244">								ps.execute();</span>
<span class="fc" id="L1245">								ps.close();</span>
							}
<span class="nc" id="L1247">							catch (Exception ex2)</span>
							{
								//nerobime nic
<span class="fc" id="L1250">							}</span>
						}

<span class="fc" id="L1253">						request.setAttribute(&quot;formMailFormFormId&quot;, Integer.toString(formId));</span>

<span class="fc" id="L1255">						String pdfUrl = &quot;&quot;;</span>
<span class="fc" id="L1256">						attachs = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L1258" title="1 of 2 branches missed.">						if(&quot;true&quot;.equals(request.getParameter(&quot;isPdfVersion&quot;)))</span>
						{
<span class="nc" id="L1260">							pdfUrl = saveFormAsPdf(appendStyle(htmlData.toString(), cssData, null, forceTextPlain), formId, request);</span>
<span class="nc" id="L1261">							IwcmFile pdfFile =  new IwcmFile(pdfUrl);</span>
							//fileNames = new StringBuilder(pdfFile.getVirtualPath() + &quot;;&quot; + pdfFile.getName());
<span class="nc bnc" id="L1263" title="All 2 branches missed.">							if (fileNames == null) fileNames = new StringBuilder();</span>
<span class="nc bnc" id="L1264" title="All 2 branches missed.">							if (fileNames.length()&gt;0) fileNames.append(&quot;;&quot;);</span>
<span class="nc" id="L1265">							fileNames.append(pdfFile.getName());</span>

							//fileNamesSendLater = new StringBuilder();
<span class="nc bnc" id="L1268" title="All 2 branches missed.">							if (fileNamesSendLater == null) fileNamesSendLater = new StringBuilder();</span>
<span class="nc bnc" id="L1269" title="All 2 branches missed.">							if (fileNamesSendLater.length()&gt;0) fileNamesSendLater.append(&quot;;&quot;);</span>
<span class="nc" id="L1270">							fileNamesSendLater.append(FORM_FILE_DIR).append(pdfFile.getName()).append(&quot;;&quot;).append(pdfFile.getName());</span>
<span class="nc" id="L1271">							attachs.add(new IwcmFile(pdfUrl));</span>
						}

						//ak su aj subory
<span class="pc bpc" id="L1275" title="1 of 2 branches missed.">						if (formFiles.size() &gt; 0)</span>
						{
							//skopiruj subory
							String newFileName;
<span class="nc" id="L1279">							String path = Tools.getRealPath(FORM_FILE_DIR);</span>
<span class="nc bnc" id="L1280" title="All 2 branches missed.">							if (path != null)</span>
							{
								String fileName;
<span class="nc bnc" id="L1283" title="All 2 branches missed.">								for (UploadedFile formFile : formFiles)</span>
								{
<span class="nc" id="L1285">									fileName = fixFileNameDirPath(formFile.getFileName().trim());</span>

									//Logger.println(this,&quot;we have a file name=&quot;+fileName+&quot; content type=&quot;+file.getContentType());

<span class="nc bnc" id="L1289" title="All 4 branches missed.">									if (fileName != null &amp;&amp; fileName.length() &gt; 1)</span>
									{
<span class="nc" id="L1291">										InputStream stream = formFile.getInputStream();</span>

<span class="nc" id="L1293">										newFileName = formId + &quot;_&quot; +</span>
<span class="nc" id="L1294">												DocTools.removeChars(</span>
<span class="nc" id="L1295">														DB.internationalToEnglish(fileName));</span>

<span class="nc bnc" id="L1297" title="All 2 branches missed.">										if (&quot;false&quot;.equals(Constants.getString(&quot;useSMTPServer&quot;)))</span>
										{
<span class="nc bnc" id="L1299" title="All 2 branches missed.">											if (fileNamesSendLater == null)</span>
											{
<span class="nc" id="L1301">												fileNamesSendLater = new StringBuilder(FORM_FILE_DIR + newFileName+&quot;;&quot;+fileName);</span>
											}
											else
											{
<span class="nc" id="L1305">												fileNamesSendLater.append(&quot;;&quot;).append(FORM_FILE_DIR).append(newFileName).append(&quot;;&quot;).append(fileName);</span>
											}
										}

<span class="nc bnc" id="L1309" title="All 2 branches missed.">										if (fileNames == null)</span>
										{
<span class="nc" id="L1311">											fileNames = new StringBuilder(newFileName);</span>
										}
										else
										{
<span class="nc" id="L1315">											fileNames.append(&quot;,&quot;).append(newFileName);</span>
										}

<span class="nc bnc" id="L1318" title="All 2 branches missed.">										if (!path.endsWith(Character.toString(File.separatorChar)))</span>
										{
<span class="nc" id="L1320">											path = path + File.separatorChar; //NOSONAR</span>
										}
<span class="nc" id="L1322">										IwcmFile fullPath = new IwcmFile(path + newFileName);</span>
<span class="nc" id="L1323">										fullPath.mkdirs();</span>
<span class="nc" id="L1324">										fullPath.delete();</span>
<span class="nc" id="L1325">										fullPath.createNewFile();</span>
<span class="nc" id="L1326">										attachs.add(fullPath);</span>

<span class="nc" id="L1328">										IwcmFsDB.writeFiletoDest(stream,new File(fullPath.getPath()),formFile.getFileSize());</span>
									}
<span class="nc" id="L1330">								}</span>
							}
						}

						//MBO: kukni ci tam neni nejaky multiupload
						//je mozne ze boli uploadovane subory
<span class="pc bpc" id="L1336" title="3 of 4 branches missed.">						if (uploadedFilesParamNameList != null &amp;&amp; uploadedFilesParamNameList.length&gt;0)</span>
						{
<span class="nc bnc" id="L1338" title="All 2 branches missed.">							for (String uploadedFilesParamName : uploadedFilesParamNameList)</span>
							{
<span class="nc" id="L1340">								String baseDirName = PathFilter.getRealPath(FORM_FILE_DIR + &quot;/&quot;);</span>
<span class="nc" id="L1341">								IwcmFile dir = new IwcmFile(baseDirName);</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">								if (!dir.exists()) dir.mkdirs();</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">								if (Tools.isNotEmpty(request.getParameter(uploadedFilesParamName)))</span>
								{
<span class="nc bnc" id="L1345" title="All 2 branches missed.">									for (String keys : request.getParameterValues(uploadedFilesParamName))</span>
									{
<span class="nc bnc" id="L1347" title="All 2 branches missed.">										for (String param : Tools.getTokens(keys, &quot;;&quot;))</span>
										{
<span class="nc" id="L1349">											String fileName = XhrFileUploadServlet.moveFile(param, baseDirName + File.separator);</span>
<span class="nc" id="L1350">											IwcmFile file = new IwcmFile(dir, fileName);</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">											if (file.exists())</span>
											{
<span class="nc" id="L1353">												IwcmFile dest = new IwcmFile(dir, formId + &quot;_&quot; + fileName);</span>
<span class="nc" id="L1354">												file.renameTo(dest);</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">												if (dest.exists())</span>
												{
<span class="nc bnc" id="L1357" title="All 2 branches missed.">													if (fileNames == null)</span>
													{
<span class="nc" id="L1359">														fileNames = new StringBuilder(dest.getName());</span>
													} else
													{
<span class="nc" id="L1362">														fileNames.append(&quot;,&quot;).append(dest.getName());</span>
													}
<span class="nc bnc" id="L1364" title="All 2 branches missed.">													if (&quot;false&quot;.equals(Constants.getString(&quot;useSMTPServer&quot;))) {</span>
<span class="nc bnc" id="L1365" title="All 2 branches missed.">														if (fileNamesSendLater==null) fileNamesSendLater = new StringBuilder();</span>
<span class="nc" id="L1366">														fileNamesSendLater.append(&quot;;&quot;).append(dest.getVirtualPath()).append(&quot;;&quot;).append(dest.getName());</span>
													}


<span class="nc" id="L1370">													attachs.add(dest);</span>
												}
											}
										}
									}
								}
							}
						}

<span class="pc bpc" id="L1379" title="1 of 2 branches missed.">						if(attachs != null)</span>
						{
<span class="fc" id="L1381">							long size = 0;</span>
<span class="pc bpc" id="L1382" title="1 of 2 branches missed.">							if (attachs != null)</span>
							{
								//ak je velkost prilohy vacsia ako stanovena hranica, prilohy k mailu nepripojim
<span class="pc bpc" id="L1385" title="1 of 2 branches missed.">								for(IwcmFile file : attachs)</span>
								{
<span class="nc" id="L1387">									size += file.length();</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">									if(size &gt; Constants.getLong(&quot;maxSizeOfAttachments&quot;)) attachFiles = false;</span>
<span class="nc" id="L1389">								}</span>
							}

							//updatni DB
<span class="fc" id="L1393">							ps = db_conn.prepareStatement(&quot;UPDATE forms SET files=? WHERE id=? &quot;+CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L1394">							DB.setClob(ps, 1, toString(fileNames));</span>
<span class="fc" id="L1395">							ps.setInt(2, formId);</span>
<span class="fc" id="L1396">							ps.execute();</span>
<span class="fc" id="L1397">							ps.close();</span>

<span class="pc bpc" id="L1399" title="1 of 2 branches missed.">							if(!attachFiles)</span>
							{
<span class="nc" id="L1401">								fileNamesSendLater = null;</span>
<span class="nc" id="L1402">								Logger.println(FormMailAction.class, &quot;Nepripajam prilohy do e-mailu: prekorocena max. velkost priloh=&quot;+size);</span>
							}
						}
					}
<span class="fc" id="L1406">					db_conn.close();</span>
<span class="fc" id="L1407">					db_conn = null;</span>
				}
			}
<span class="nc" id="L1410">			catch (Exception ex)</span>
			{
<span class="nc" id="L1412">				Logger.error(FormMailAction.class, ex);</span>


				//RequestBean.setServerClas(&quot;send_mail_error.savedb&quot;);
<span class="nc" id="L1416">				RequestBean.addError(&quot;Nastala chyba pri ukladani formularu - &quot; + ex.getMessage());</span>
<span class="nc" id="L1417">				RequestBean.addParameter(&quot;formName&quot;, request.getParameter(&quot;savedb&quot;));</span>
<span class="nc" id="L1418">				RequestBean.addParameter(&quot;DBDataNames&quot;, toString(db_data_names));</span>


<span class="nc" id="L1421">				Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, formId);</span>

<span class="nc" id="L1423">				failStatus = &quot;savedb&quot;;</span>
			}
			finally
			{
				try
				{
<span class="pc bpc" id="L1429" title="1 of 2 branches missed.">					if (rs != null) rs.close();</span>
<span class="pc bpc" id="L1430" title="1 of 2 branches missed.">					if (ps != null) ps.close();</span>
<span class="pc bpc" id="L1431" title="1 of 2 branches missed.">					if (db_conn != null) db_conn.close();</span>
				}
<span class="nc" id="L1433">				catch (Exception e)</span>
				{
					//nerobime nic
<span class="fc" id="L1436">				}</span>
			}

<span class="fc" id="L1439">			int sendUserInfoDocId = Tools.getIntValue(request.getParameter(&quot;formmail_sendUserInfoDocId&quot;), -1);</span>
<span class="fc" id="L1440">			Logger.debug(FormMailAction.class,&quot;sendUserInfoDocId=&quot;+sendUserInfoDocId+&quot; email=&quot;+email);</span>
<span class="fc bfc" id="L1441" title="All 2 branches covered.">			if (sendUserInfoDocId&gt;0)</span>
			{
<span class="fc" id="L1443">				sendUserInfo(sendUserInfoDocId, formId, email, attachs, formFilesTable, request);</span>
			}

<span class="fc" id="L1446">			Logger.println(FormMailAction.class,&quot;FormMailAction emailAllowed=&quot;+emailAllowed+&quot; recipients=&quot;+recipients);</span>

			//RequestBean.addAllowedParameter(&quot;recipients&quot;);
<span class="fc" id="L1449">			RequestBean.addParameter(&quot;recipients&quot;, new String[]{recipients});</span>
<span class="fc" id="L1450">			RequestBean.addParameter(&quot;formName&quot;, request.getParameter(&quot;savedb&quot;));</span>
<span class="fc" id="L1451">			RequestBean.addParameter(&quot;DBDataNames&quot;, toString(db_data_names));</span>

<span class="fc" id="L1453">			String beforePostMethod = request.getParameter(&quot;beforePostMethod&quot;);</span>
<span class="pc bpc" id="L1454" title="3 of 4 branches missed.">			if (Tools.isNotEmpty(request.getParameter(&quot;afterSendInterceptor&quot;))&amp;&amp;&quot;true&quot;.equals(request.getAttribute(&quot;DBafterSendInterceptor&quot;))) beforePostMethod = request.getParameter(&quot;afterSendInterceptor&quot;);</span>
<span class="pc bpc" id="L1455" title="1 of 2 branches missed.">			if (Tools.isEmpty(beforePostMethod)) beforePostMethod = Constants.getString(&quot;formMailBeforePostMethod&quot;);</span>

<span class="pc bpc" id="L1457" title="3 of 4 branches missed.">			if (Tools.isNotEmpty(beforePostMethod) &amp;&amp; Tools.isEmpty(recipients))</span>
			{
				//ked mame nastaveny interceptor je potrebne vojst nizsie aj ked nie je vyplneny email formularu (lebo sa to niekomu nezdalo vhodne)
				//je to tak preto, aby sa interceptor vobec zavolal (TB-specific)
<span class="nc bnc" id="L1461" title="All 2 branches missed.">				if (&quot;nobody@nowhere.com&quot;.equals(recipients)==false) recipients = Constants.getString(&quot;emailProtectionSenderEmail&quot;);</span>
			}

<span class="pc bpc" id="L1464" title="4 of 8 branches missed.">			if (emailAllowed &amp;&amp; &quot;nobody@nowhere.com&quot;.equals(recipients)==false &amp;&amp; recipients!=null &amp;&amp; recipients.contains(&quot;@&quot;))</span>
			{
<span class="pc bpc" id="L1466" title="1 of 4 branches missed.">				if (email == null || email.indexOf('@')==-1)</span>
				{
<span class="fc" id="L1468">					String emailProtectionSenderEmail = Constants.getString(SendMail.EMAIL_PROTECTION_SENDER_KEY);</span>
<span class="pc bpc" id="L1469" title="1 of 2 branches missed.">					if (Tools.isEmail(emailProtectionSenderEmail))</span>
					{
<span class="nc" id="L1471">						email = emailProtectionSenderEmail;</span>
					}
					else
					{
						//skus nastavit odosielatela ako prijemcu
<span class="fc" id="L1476">						String[] emails = recipients.split(&quot;,&quot;);</span>
<span class="pc bpc" id="L1477" title="2 of 4 branches missed.">						if (emails != null &amp;&amp; emails.length &gt; 0)</span>
						{
<span class="fc" id="L1479">							email = emails[0];</span>
						} else
						{
<span class="nc" id="L1482">							email = &quot;webform@&quot; + Tools.getServerName(request);</span>
						}
					}
				}
<span class="pc bpc" id="L1486" title="1 of 4 branches missed.">				if (meno == null || meno.trim().length() &lt; 1)</span>
				{
<span class="fc" id="L1488">					meno = email;</span>
				}

<span class="pc bpc" id="L1491" title="1 of 4 branches missed.">				if (Constants.getBoolean(&quot;formMailSendPlainText&quot;) || forceTextPlain)</span>
				{
<span class="fc" id="L1493">					htmlData = new StringBuilder(SearchTools.htmlToPlain(htmlData.toString()));</span>
<span class="fc" id="L1494">					cssData = null;</span>
				}
				else
				{
<span class="fc" id="L1498">					htmlData = new StringBuilder(SearchTools.removeCommands(htmlData.toString()));	//odstranim z HTML riadiace bloky napr.: !INCLUDE(...)!, !PARAMETER(...)!</span>
				}

<span class="pc bpc" id="L1501" title="1 of 2 branches missed.">				if (emailEncoding.indexOf(&quot;ASCII&quot;)!=-1) htmlData = new StringBuilder(DB.internationalToEnglish(htmlData.toString()));</span>
<span class="fc" id="L1502">				htmlData = new StringBuilder(createAbsolutePath(htmlData.toString(), request));</span>
<span class="fc" id="L1503">				cssData = createAbsolutePath(cssData, request);</span>

<span class="fc" id="L1505">				boolean sendMessageAsAttach = &quot;true&quot;.equals(request.getParameter(&quot;messageAsAttach&quot;));</span>
<span class="fc" id="L1506">				IwcmFile messageAsAttachFile = null;</span>
<span class="pc bpc" id="L1507" title="1 of 2 branches missed.">				if(sendMessageAsAttach)</span>
				{
<span class="nc" id="L1509">					String messageAsAttachFileName = request.getParameter(&quot;messageAsAttachFileName&quot;);</span>
<span class="nc bnc" id="L1510" title="All 2 branches missed.">					if(Tools.isEmpty(messageAsAttachFileName)) messageAsAttachFileName = &quot;priloha.html&quot;;</span>
<span class="nc" id="L1511">					else messageAsAttachFileName = DocTools.removeChars(messageAsAttachFileName);</span>
<span class="nc" id="L1512">					messageAsAttachFile = new IwcmFile(Tools.getRealPath(FORM_FILE_DIR + File.separator + formId+&quot;_&quot;+messageAsAttachFileName));</span>
<span class="nc bnc" id="L1513" title="All 2 branches missed.">					FileTools.saveFileContent(messageAsAttachFile.getVirtualPath(), &quot;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=&quot;+emailEncoding+&quot;\&quot;&gt;&quot;+(cssData == null ? &quot;&quot; : cssData)+&quot;&lt;/head&gt;&lt;body id=\&quot;WebJETEditorBody\&quot; class=\&quot;WebJETMailBody\&quot;&gt;&lt;div class=\&quot;WebJETMailWrapper\&quot;&gt;\n\n&quot;+htmlData+&quot;\n\n&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;, emailEncoding);</span>
				}

<span class="pc bpc" id="L1516" title="1 of 2 branches missed.">				if (&quot;false&quot;.equals(Constants.getString(&quot;useSMTPServer&quot;)))</span>
				{
<span class="nc bnc" id="L1518" title="All 4 branches missed.">					if(sendMessageAsAttach &amp;&amp; messageAsAttachFile!=null)</span>
					{
<span class="nc" id="L1520">						htmlData = new StringBuilder(prop.getText(&quot;form.formmailaction.pozrite_si_prilozeny_subor&quot;));</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">						if (fileNamesSendLater == null) fileNamesSendLater = new StringBuilder();</span>
<span class="nc" id="L1522">						fileNamesSendLater.append(&quot;;&quot;).append(FORM_FILE_DIR).append(messageAsAttachFile.getName()).append(&quot;;&quot;).append(messageAsAttachFile.getName());</span>
					}
<span class="nc bnc" id="L1524" title="All 4 branches missed.">					if(attachs != null &amp;&amp; !attachFiles) htmlData.append(prop.getText(&quot;email.too_large_attachments&quot;));</span>

<span class="nc" id="L1526">					String messageBody = htmlData.toString();</span>
<span class="nc bnc" id="L1527" title="All 4 branches missed.">					if (sendMessageAsAttach==false &amp;&amp; forceTextPlain==false)</span>
					{
<span class="nc" id="L1529">						messageBody = appendStyle(htmlData.toString(), cssData, emailEncoding, forceTextPlain);</span>
					}

					// interceptor pre send later
<span class="nc bnc" id="L1533" title="All 2 branches missed.">					if(canCallInterceptor(beforePostMethod)) {</span>
<span class="nc" id="L1534">						MimeMessage message = new MimeMessage(Session.getInstance(new Properties()));</span>
<span class="nc" id="L1535">						Multipart multipart = new MimeMultipart();</span>
<span class="nc" id="L1536">						BodyPart mbp = new MimeBodyPart();</span>

						try {
<span class="nc" id="L1539">							mbp.setContent(messageBody, &quot;text/html; &quot; + emailEncoding);</span>
<span class="nc" id="L1540">							multipart.addBodyPart(mbp);</span>
<span class="nc" id="L1541">							message.setContent(multipart);</span>
<span class="nc" id="L1542">						} catch (MessagingException e) {</span>
<span class="nc" id="L1543">							sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1544">						}</span>

<span class="nc" id="L1546">						beforePostReturnParams = callInterceptor(beforePostMethod, message, multipart, request);</span>
<span class="nc bnc" id="L1547" title="All 2 branches missed.">						if(hasInterceptorFailed(beforePostReturnParams)) {</span>
<span class="nc" id="L1548">							failStatus = &quot;beforePostMethod&quot;;</span>
						}

						try {
<span class="nc" id="L1552">							messageBody = (String) multipart.getBodyPart(0).getContent();</span>
<span class="nc" id="L1553">						} catch (Exception e) {</span>
<span class="nc" id="L1554">							sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L1555">						}</span>
					}

<span class="nc" id="L1558">					Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;Formular &quot;+formName+&quot; uspesne ulozeny do databazy, odoslany bude neskor&quot;, docId, formId);</span>

					//musime kvoli clustru a potencionalnemu zapisu suborov pozdrzat email
<span class="nc" id="L1561">					long sendLaterTime = Tools.getNow();</span>
<span class="nc" id="L1562">					sendLaterTime += (5 * Constants.getInt(&quot;clusterRefreshTimeout&quot;));</span>

<span class="nc" id="L1564">					SendMail.sendLater(meno, getFirstEmail(email), recipients, request.getParameter(&quot;replyTo&quot;), request.getParameter(&quot;ccEmails&quot;), request.getParameter(&quot;bccEmails&quot;), subject, messageBody, Tools.getBaseHref(request), Tools.formatDate(sendLaterTime), Tools.formatTime(sendLaterTime), toString(fileNamesSendLater));</span>
<span class="nc" id="L1565">				}</span>
				else
				{
					//vygeneruj mail a posli ho
<span class="fc" id="L1569">					Properties props = System.getProperties();</span>

					try
					{
<span class="pc bpc" id="L1573" title="2 of 4 branches missed.">						if (host != null &amp;&amp; host.length() &gt; 2)</span>
						{
<span class="fc" id="L1575">							props.put(&quot;mail.smtp.host&quot;, host);</span>
						}
<span class="nc bnc" id="L1577" title="All 2 branches missed.">						else if (props.getProperty(&quot;mail.smtp.host&quot;) == null)</span>
						{
<span class="nc" id="L1579">							props.put(&quot;mail.smtp.host&quot;, InetAddress.getLocalHost().getHostName());</span>
						}
					}
<span class="nc" id="L1582">					catch (Exception ex)</span>
					{
<span class="nc" id="L1584">						Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L1585">					}</span>

<span class="fc" id="L1587">					Session session = SendMail.getSession(props);</span>

<span class="fc" id="L1589">					MimeMessage msg = new MimeMessage(session);</span>
<span class="fc" id="L1590">					InternetAddress[] toAddrs = null;</span>

					try
					{
						//este potrebujeme updatnut linky na subory

<span class="fc" id="L1596">						FormDetails formDetails = new FormDetails();</span>
<span class="fc" id="L1597">						formDetails.setFiles(toString(fileNames));</span>

						//updatni linky na attachementy
<span class="fc" id="L1600">						String baseHref = Tools.getBaseHref(request);</span>
<span class="fc" id="L1601">						htmlData = Tools.replace(htmlData, &quot;!ATTACHMENTS!&quot;, formDetails.getAttachements(baseHref));</span>

						try
						{
<span class="fc" id="L1605">							String proxyHost = request.getHeader(&quot;x-forwarded-for&quot;);</span>
<span class="pc bpc" id="L1606" title="3 of 4 branches missed.">							if (proxyHost != null &amp;&amp; proxyHost.length()&gt;4)</span>
							{
<span class="nc" id="L1608">								msg.setHeader(&quot;X-sender-proxy&quot;, proxyHost);</span>
							}

<span class="fc" id="L1611">							msg.setHeader(&quot;X-sender-ip&quot;, Tools.getRemoteIP(request));</span>
<span class="fc" id="L1612">							msg.setHeader(&quot;X-sender-host&quot;, Tools.getRemoteHost(request));</span>
<span class="fc" id="L1613">							msg.setHeader(&quot;X-server-name&quot;, Tools.getServerName(request));</span>
<span class="fc" id="L1614">							Identity user = UsersDB.getCurrentUser(request);</span>
<span class="fc bfc" id="L1615" title="All 2 branches covered.">							if (user!=null)</span>
							{
<span class="fc" id="L1617">								msg.setHeader(&quot;X-sender-userid&quot;, Integer.toString(user.getUserId()));</span>
<span class="fc" id="L1618">								msg.setHeader(&quot;X-sender-fullname&quot;, DB.internationalToEnglish(user.getFullName()));</span>
							}
						}
<span class="nc" id="L1621">						catch (Exception ex)</span>
						{
<span class="nc" id="L1623">							Logger.error(FormMailAction.class, ex);</span>
<span class="fc" id="L1624">						}</span>

<span class="fc" id="L1626">						toAddrs = InternetAddress.parse(recipients, false);</span>
<span class="fc" id="L1627">						msg.setRecipients(Message.RecipientType.TO, toAddrs);</span>

<span class="fc" id="L1629">						String ccEmails = request.getParameter(&quot;ccEmails&quot;);</span>
<span class="pc bpc" id="L1630" title="3 of 4 branches missed.">						if (ccEmails != null &amp;&amp; ccEmails.indexOf('@')!=-1)</span>
						{
<span class="nc" id="L1632">							InternetAddress[] ccAddrs = InternetAddress.parse(ccEmails, false);</span>
<span class="nc" id="L1633">							msg.setRecipients(Message.RecipientType.CC, ccAddrs);</span>
						}
<span class="fc" id="L1635">						String bccEmails = request.getParameter(&quot;bccEmails&quot;);</span>
<span class="pc bpc" id="L1636" title="3 of 4 branches missed.">						if (bccEmails != null &amp;&amp; bccEmails.indexOf('@')!=-1)</span>
						{
<span class="nc" id="L1638">							InternetAddress[] bccAddrs = InternetAddress.parse(bccEmails, false);</span>
<span class="nc" id="L1639">							msg.setRecipients(Message.RecipientType.BCC, bccAddrs);</span>
						}

<span class="fc" id="L1642">						String from = email;</span>
<span class="fc" id="L1643">						msg.setFrom(new InternetAddress(getFirstEmail(email), meno));</span>

						//iteruj cez polozky formularu
<span class="fc" id="L1646">						String fieldsEmailHeader = request.getParameter(&quot;fieldsEmailHeader&quot;);</span>
<span class="pc bpc" id="L1647" title="1 of 2 branches missed.">						if (fieldsEmailHeader != null)</span>
						{
<span class="nc" id="L1649">							StringTokenizer st = new StringTokenizer(fieldsEmailHeader, &quot;,&quot;);</span>
							String field;
							String value;
<span class="nc bnc" id="L1652" title="All 2 branches missed.">							while (st.hasMoreTokens())</span>
							{
<span class="nc" id="L1654">								field = st.nextToken();</span>
<span class="nc" id="L1655">								value = ResponseUtils.filter(DB.internationalToEnglish(recode(request.getParameter(field)))).replace(&quot;\n&quot;, &quot; &quot;).replace(&quot;\r&quot;, &quot; &quot;);</span>
<span class="nc" id="L1656">								msg.setHeader(field, value);</span>
							}
						}

						//subject = new String(subject.getBytes(), emailEncoding);
						//msg.setSubject(subject);
<span class="fc" id="L1662">						msg.setSubject(MimeUtility.encodeText(subject, emailEncoding, null));</span>

<span class="fc" id="L1664">						msg.setSentDate(new java.util.Date());</span>

						//msg.setText(body);

						//MimeBodyPart text = new MimeBodyPart();

<span class="fc" id="L1670">						MimeBodyPart html = new MimeBodyPart();</span>

						//htmlData = new String(htmlData.getBytes(EMAIL_ENCODING));

<span class="pc bpc" id="L1674" title="1 of 2 branches missed.">						if(sendMessageAsAttach) htmlData = new StringBuilder(prop.getText(&quot;form.formmailaction.pozrite_si_prilozeny_subor&quot;));</span>
<span class="pc bpc" id="L1675" title="2 of 4 branches missed.">						if(attachs != null &amp;&amp; !attachFiles) htmlData.append(prop.getText(&quot;email.too_large_attachments&quot;));</span>

						//odstran diakritiku
<span class="pc bpc" id="L1678" title="1 of 2 branches missed.">						if (emailEncoding.indexOf(&quot;ASCII&quot;)!=-1)</span>
						{
<span class="nc" id="L1680">							htmlData = new StringBuilder(DB.internationalToEnglish(htmlData.toString()));</span>
						}

						//test ci je to HTML content, alebo nie. &lt;br&gt; za HTML content nepovazujem
<span class="fc" id="L1684">						String htmlDataNoBR = Tools.replace(htmlData.toString(), &quot;&lt;br&gt;&quot;, &quot;\n&quot;);</span>
<span class="fc" id="L1685">						htmlDataNoBR = Tools.replace(htmlDataNoBR, &quot;&lt;br/&gt;&quot;, &quot;\n&quot;);</span>
<span class="pc bpc" id="L1686" title="1 of 4 branches missed.">						if (htmlDataNoBR.indexOf('&lt;') != -1 &amp;&amp; htmlDataNoBR.indexOf('&gt;') != -1)</span>
						{
<span class="fc" id="L1688">							html.setContent(appendStyle(htmlData.toString(), cssData, emailEncoding, forceTextPlain), &quot;text/html; charset=&quot;+emailEncoding);</span>
						}
						else
						{
<span class="fc" id="L1692">							html.setContent(htmlData.toString(), &quot;text/plain; charset=&quot;+emailEncoding);</span>
						}

<span class="fc" id="L1695">						Multipart mp = new MimeMultipart(&quot;mixed&quot;);</span>
<span class="pc bpc" id="L1696" title="6 of 16 branches missed.">						if ((forceTextPlain==false || (attachs != null &amp;&amp; attachFiles)) &amp;&amp; (Tools.isNotEmpty(beforePostMethod) || formFiles.size()&gt;0 || sendMessageAsAttach || (htmlDataNoBR.indexOf('&lt;') != -1 &amp;&amp; htmlDataNoBR.indexOf('&gt;') != -1)))</span>
						{
							//html.setContent(htmlData, contentType);

							//mp.addBodyPart(text);

							//#15245 - ak je nastaveny forceTextPlain a mal som aj prilohy, text formularu necham ako text/plain a prilohy pridam standartnym sposobom
<span class="pc bpc" id="L1703" title="1 of 2 branches missed.">							if(forceTextPlain)</span>
<span class="nc" id="L1704">								html.setContent(SearchTools.htmlToPlain(htmlDataNoBR), &quot;text/plain; charset=&quot;+emailEncoding);</span>

<span class="fc" id="L1706">							mp.addBodyPart(html);</span>

							//Multipart mp = new MimeMultipart(&quot;mixed&quot;);

<span class="pc bpc" id="L1710" title="2 of 4 branches missed.">							if(attachs != null &amp;&amp; attachFiles)</span>
							{
<span class="pc bpc" id="L1712" title="1 of 2 branches missed.">								for(IwcmFile file : attachs)</span>
<span class="nc" id="L1713">									attFile(file, mp, emailEncoding);</span>
							}

<span class="pc bpc" id="L1716" title="1 of 2 branches missed.">							if(sendMessageAsAttach) attFile(messageAsAttachFile, mp, emailEncoding);</span>

<span class="fc" id="L1718">							msg.setContent(mp);</span>

<span class="pc bpc" id="L1720" title="1 of 2 branches missed.">							if (canCallInterceptor(beforePostMethod))</span>
							{
<span class="nc" id="L1722">								beforePostReturnParams = callInterceptor(beforePostMethod, msg, mp, request);</span>
<span class="nc bnc" id="L1723" title="All 2 branches missed.">								if(hasInterceptorFailed(beforePostReturnParams)) {</span>
<span class="nc" id="L1724">									failStatus = &quot;beforePostMethod&quot;;</span>
								}
							}
						}
						else
						{
							//mame iba textovy obsah, posli zjednodusene
<span class="fc" id="L1731">							htmlDataNoBR = SearchTools.htmlToPlain(htmlDataNoBR);</span>
<span class="fc" id="L1732">							msg.setContent(htmlDataNoBR, &quot;text/plain; charset=&quot;+emailEncoding);</span>
						}

<span class="fc" id="L1735">						String formMailFixedSenderEmail = Constants.getString(&quot;formMailFixedSenderEmail&quot;);</span>
<span class="pc bpc" id="L1736" title="1 of 2 branches missed.">						if (Tools.isEmail(formMailFixedSenderEmail))</span>
						{
<span class="nc" id="L1738">							msg.setFrom(new InternetAddress(formMailFixedSenderEmail, formMailFixedSenderEmail));</span>
						}
						else
						{
<span class="pc bpc" id="L1742" title="1 of 2 branches missed.">							if (Tools.isEmail(Constants.getString(SendMail.EMAIL_PROTECTION_SENDER_KEY)))</span>
							{
<span class="nc" id="L1744">								from = Constants.getString(SendMail.EMAIL_PROTECTION_SENDER_KEY);</span>
<span class="nc" id="L1745">								Address[] oldSenders = msg.getFrom();</span>
<span class="nc bnc" id="L1746" title="All 6 branches missed.">								if (oldSenders != null &amp;&amp; oldSenders.length&gt;0 &amp;&amp; from.equals(oldSenders[0].toString()) == false) msg.setReplyTo(oldSenders);</span>
<span class="nc" id="L1747">								msg.setFrom(new InternetAddress(from, from));</span>
							}
						}

						//ak mame parameter &quot;replyTo&quot;, nastavme ho
<span class="fc" id="L1752">						String replyTo = request.getParameter(&quot;replyTo&quot;);</span>
<span class="pc bpc" id="L1753" title="3 of 4 branches missed.">						if(Tools.isNotEmpty(replyTo) &amp;&amp; replyTo.indexOf(&quot;@&quot;) != -1)</span>
						{
<span class="nc" id="L1755">							InternetAddress[] replyToAddrs = InternetAddress.parse(replyTo, false);</span>
<span class="nc" id="L1756">							msg.setReplyTo(replyToAddrs);</span>
						}

<span class="pc bpc" id="L1759" title="3 of 4 branches missed.">						if(beforePostReturnParams==null || beforePostReturnParams.indexOf(&quot;doNotSend&quot;) == -1)</span>
						{
<span class="fc" id="L1761">							Transport.send(msg);</span>

<span class="fc" id="L1763">							RequestBean.addParameter(&quot;formName&quot;, formName);</span>
<span class="fc" id="L1764">							RequestBean.addParameter(&quot;beforePostMethod&quot;, beforePostMethod);</span>
<span class="fc" id="L1765">							RequestBean.addParameter(&quot;from&quot;, from);</span>
<span class="fc" id="L1766">							RequestBean.addParameter(&quot;to&quot;, recipients);</span>
<span class="fc" id="L1767">							RequestBean.addParameter(&quot;subject&quot;, subject);</span>

<span class="fc" id="L1769">							Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;Formular &quot;+formName+&quot; uspesne odoslany na email &quot;+recipients, docId, formId);</span>
						}
						else
						{
<span class="nc" id="L1773">							RequestBean.addParameter(&quot;formName&quot;, formName);</span>
<span class="nc" id="L1774">							RequestBean.addParameter(&quot;beforePostMethod&quot;, beforePostMethod);</span>
<span class="nc" id="L1775">							RequestBean.addParameter(&quot;from&quot;, from);</span>
<span class="nc" id="L1776">							RequestBean.addParameter(&quot;subject&quot;, subject);</span>

<span class="nc" id="L1778">							Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;Formular &quot;+formName+&quot; uspesne ulozeny&quot;, docId, formId);</span>
						}
					}
<span class="nc" id="L1781">					catch (Exception ex)</span>
					{
<span class="nc" id="L1783">						Logger.error(FormMailAction.class, ex);</span>
<span class="nc" id="L1784">						failStatus = &quot;emailsend&quot;;</span>

						//RequestBean.setErrorText(&quot;send_mail_error&quot;);
<span class="nc" id="L1787">						RequestBean.addError(&quot;Chyba pri odosielani emailu&quot;);</span>
<span class="nc" id="L1788">						RequestBean.addError(&quot;Stack Trace: \n&quot;+Logger.getStackTrace(ex));</span>
<span class="nc" id="L1789">						RequestBean.addParameter(&quot;formName&quot;, formName);</span>

<span class="nc" id="L1791">						Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;&quot;, docId, formId);</span>
<span class="fc" id="L1792">					}</span>
				}
<span class="fc" id="L1794">			}</span>
			else
			{
<span class="nc" id="L1797">				Adminlog.add(Adminlog.TYPE_FORMMAIL, &quot;Formular &quot;+formName+&quot; uspesne ulozeny do databazy&quot;, docId, formId);</span>
			}
		} //else isSpam

<span class="fc" id="L1801">		String param = &quot;formsend=true&quot;;</span>
<span class="fc bfc" id="L1802" title="All 2 branches covered.">		if (&quot;true&quot;.equals(request.getParameter(&quot;doubleOptIn&quot;))) param = &quot;formsend=trueDoubleOptIn&quot;;</span>

<span class="fc" id="L1804">		StringBuilder forward = new StringBuilder(forwardDefault);</span>
<span class="fc bfc" id="L1805" title="All 2 branches covered.">		if (failStatus!=null)</span>
		{
<span class="fc" id="L1807">			param = &quot;formfail=&quot;+failStatus;</span>
<span class="pc bpc" id="L1808" title="1 of 2 branches missed.">			if (Tools.isNotEmpty(forwardFail)) forward = new StringBuilder(forwardFail);</span>
		}
		else
		{
<span class="fc bfc" id="L1812" title="All 2 branches covered.">			if (Tools.isNotEmpty(forwardOk)) forward = new StringBuilder(forwardOk);</span>
		}

<span class="pc bpc" id="L1815" title="1 of 2 branches missed.">		if (forward.indexOf(&quot;?&quot;)==-1)</span>
		{
<span class="fc" id="L1817">			forward = forward.append('?').append(param);</span>
		}
		else
		{
<span class="nc" id="L1821">			forward =  forward.append('&amp;').append(param);</span>
		}
<span class="pc bpc" id="L1823" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(beforePostReturnParams))</span>
		{
<span class="nc" id="L1825">			forward =  forward.append('&amp;').append(beforePostReturnParams);</span>
		}

<span class="fc" id="L1828">		return (forward.toString());</span>
		//return(mapping.findForward(&quot;success&quot;));
	}

	/**
	 * Zisti ci ma zavolat afterSendInterceptor
	 * @param beforePostMethod
	 * @return true ak je pre formular nastaveny afterSendInterceptor
	 */
	private static boolean canCallInterceptor(String beforePostMethod) {
<span class="pc bpc" id="L1838" title="5 of 6 branches missed.">		return Tools.isNotEmpty(beforePostMethod) &amp;&amp; beforePostMethod.length()&gt;10 &amp;&amp; beforePostMethod.contains(&quot;.&quot;);</span>
	}

	/**
	 * Overi ci interceptor padol
	 * @param beforePostReturnParams
	 * @return true ak interceptor obsahuje string fail
	 */
	public static boolean hasInterceptorFailed(String beforePostReturnParams) {
<span class="nc bnc" id="L1847" title="All 2 branches missed.">		if(beforePostReturnParams == null) beforePostReturnParams = &quot;&quot;;</span>
<span class="nc bnc" id="L1848" title="All 2 branches missed.">		return beforePostReturnParams.indexOf(&quot;fail&quot;) != -1;</span>
	}

	/**
	 * Zavola afterSendInterceptor
	 * @param beforePostMethod
	 * @param message
	 * @param multipart
	 * @param request
	 * @return Map&lt;String, String&gt; obsahujuci failStatus a beforePostReturnParams
	 */
	private static String callInterceptor(String beforePostMethod, MimeMessage message, Multipart multipart, HttpServletRequest request) {
<span class="nc" id="L1860">		String beforePostReturnParams = null;</span>
<span class="nc" id="L1861">		int i = beforePostMethod.lastIndexOf('.');</span>
<span class="nc" id="L1862">		String beforePostClass = beforePostMethod.substring(0, i);</span>
<span class="nc" id="L1863">		beforePostMethod = beforePostMethod.substring(i+1);</span>
<span class="nc bnc" id="L1864" title="All 2 branches missed.">		if (Character.isUpperCase(beforePostMethod.charAt(0)))</span>
		{
			//je to pravdepodobne meno triedy
<span class="nc" id="L1867">			beforePostClass = beforePostClass+&quot;.&quot;+beforePostMethod;</span>
			try
			{
<span class="nc" id="L1870">				Class&lt;?&gt; c = Class.forName(beforePostClass);</span>
<span class="nc bnc" id="L1871" title="All 2 branches missed.">				if (AfterSendInterceptor.class.isAssignableFrom(c))</span>
				{
<span class="nc" id="L1873">					AfterSendInterceptor interceptor = (AfterSendInterceptor)c.getDeclaredConstructor().newInstance();</span>
<span class="nc bnc" id="L1874" title="All 2 branches missed.">					if (interceptor!=null)</span>
					{
<span class="nc" id="L1876">						beforePostReturnParams = interceptor.intercept(message, multipart, request);</span>
					}
				}
			}
<span class="nc" id="L1880">			catch (Exception ex)</span>
			{
<span class="nc" id="L1882">				Logger.error(FormMailAction.class, ex);</span>
<span class="nc" id="L1883">			}</span>
		}
		else
		{
			try
			{
<span class="nc" id="L1889">				Class&lt;?&gt; c = Class.forName(beforePostClass);</span>
<span class="nc" id="L1890">				Object o = c.getDeclaredConstructor().newInstance();</span>
				Method m;
<span class="nc" id="L1892">				Class&lt;?&gt;[] parameterTypes = new Class[] {MimeMessage.class, Multipart.class, HttpServletRequest.class};</span>
<span class="nc" id="L1893">				Object[] arguments = new Object[] {message, multipart, request};</span>
<span class="nc" id="L1894">				m = c.getMethod(beforePostMethod, parameterTypes);</span>
<span class="nc" id="L1895">				beforePostReturnParams = (String)m.invoke(o, arguments);</span>
			}
<span class="nc" id="L1897">			catch (Exception ex)</span>
			{
<span class="nc" id="L1899">				Logger.error(FormMailAction.class, ex);</span>
<span class="nc" id="L1900">			}</span>
		}

<span class="nc" id="L1903">		return beforePostReturnParams;</span>
	}

	/**
	 *  Description of the Method
	 *
	 *@param  input  Description of the Parameter
	 *@return        Description of the Return Value
	 */
	private static String recode(String input)
	{
<span class="nc bnc" id="L1914" title="All 2 branches missed.">		if (input == null)</span>
		{
<span class="nc" id="L1916">			return (&quot;&quot;);</span>
		}
		//Logger.println(this,&quot;Recoding: &quot;+input);
<span class="nc" id="L1919">		return (input.trim());</span>
	}

	/**
	 * Vrati parameter z request, ak ma request viac parametrov s rovnakym
	 * menom, spoji ich ciarkami
	 * @param name
	 * @param request
	 * @return
	 */
	private static String getValue(String name, HttpServletRequest request, Map&lt;String, List&lt;UploadedFile&gt;&gt; formFilesTable)
	{
		//recode(request.getParameter(field));

<span class="fc" id="L1933">		StringBuilder ret = null;</span>

		String[] params;
<span class="fc bfc" id="L1936" title="All 2 branches covered.">		if (request.getAttribute(name+&quot;-unescape&quot;)!=null) {</span>
<span class="fc" id="L1937">			params = new String[1];</span>
<span class="fc" id="L1938">			params[0] = AllowSafeHtmlAttributeConverter.sanitize( ((IwcmRequest)request).getOriginalParameter(name) );</span>
		} else {
<span class="fc" id="L1940">			params = request.getParameterValues(name);</span>
		}
<span class="fc bfc" id="L1942" title="All 2 branches covered.">		if (params != null) {</span>
<span class="fc" id="L1943">			String param = null;</span>
<span class="fc" id="L1944">			int size = 0;</span>
<span class="pc bpc" id="L1945" title="1 of 2 branches missed.">			if (params!=null) size = params.length;</span>
			int i;
<span class="fc bfc" id="L1947" title="All 2 branches covered.">			for (i=0; i&lt;size; i++)</span>
			{
<span class="fc" id="L1949">				param = params[i];</span>

				//takto mame v parametroch vrateny subor
<span class="pc bpc" id="L1952" title="1 of 2 branches missed.">				if (&quot;NOT_EMPTY&quot;.equals(param)) param = null;</span>

<span class="pc bpc" id="L1954" title="1 of 2 branches missed.">				if (param!=null)</span>
				{
<span class="pc bpc" id="L1956" title="1 of 2 branches missed.">					if (ret == null)</span>
					{
<span class="fc" id="L1958">						ret = new StringBuilder(param);</span>
					}
<span class="nc bnc" id="L1960" title="All 2 branches missed.">					else if (Tools.isNotEmpty(param))</span>
					{
<span class="nc" id="L1962">						ret.append(&quot;;;\n&quot;).append(param);</span>
					}
				}
			}
		}

<span class="fc bfc" id="L1968" title="All 2 branches covered.">		if (ret == null)</span>
		{
			//skus najst ako subor
<span class="fc" id="L1971">			Set&lt;Map.Entry&lt;String, List&lt;UploadedFile&gt;&gt;&gt; set = formFilesTable.entrySet();</span>
<span class="pc bpc" id="L1972" title="1 of 2 branches missed.">			for(Map.Entry&lt;String, List&lt;UploadedFile&gt;&gt; me : set)</span>
			{
<span class="nc bnc" id="L1974" title="All 2 branches missed.">				if (me.getKey().equals(name))</span>
				{
<span class="nc bnc" id="L1976" title="All 2 branches missed.">					for (UploadedFile f : me.getValue())</span>
					{
<span class="nc bnc" id="L1978" title="All 2 branches missed.">						if (ret == null) ret = new StringBuilder();</span>

<span class="nc bnc" id="L1980" title="All 2 branches missed.">						if (ret.length()&gt;0) ret.append(&quot;;;\n&quot;);</span>
<span class="nc" id="L1981">						ret.append(fixFileNameDirPath(f.getFileName()));</span>
<span class="nc" id="L1982">					}</span>
				}
<span class="nc" id="L1984">			}</span>
		}

<span class="fc bfc" id="L1987" title="All 2 branches covered.">		if (ret == null) return &quot;&quot;;</span>
<span class="fc" id="L1988">		return(ret.toString().trim());</span>
	}

	/**
	 *  Description of the Method
	 *
	 *@param  formFile  Description of the Parameter
	 *@param  mp        Description of the Parameter
	 */
	private static void attFile(IwcmFile formFile, Multipart mp, String emailEncoding)
	{
		try
		{
<span class="nc bnc" id="L2001" title="All 2 branches missed.">			if (formFile != null)</span>
			{
				//retrieve the file name
<span class="nc" id="L2004">				String fileName = formFile.getName().trim();</span>
				//Logger.println(this,&quot;we have the file name=&quot; + fileName);
<span class="nc bnc" id="L2006" title="All 4 branches missed.">				if (fileName != null &amp;&amp; fileName.length() &gt; 1)</span>
				{
<span class="nc" id="L2008">					fileName = DB.internationalToEnglish(fileName);</span>
<span class="nc" id="L2009">					int ind = fileName.indexOf(&quot;_&quot;);</span>
<span class="nc bnc" id="L2010" title="All 2 branches missed.">					if(ind != -1) fileName = fileName.substring(ind+1);</span>

<span class="nc" id="L2012">					MimeBodyPart mbp2 = new MimeBodyPart();</span>

<span class="nc" id="L2014">					FileDataSource fds = null;</span>

<span class="nc bnc" id="L2016" title="All 2 branches missed.">					if (IwcmFsDB.useDBStorage(IwcmFsDB.getVirtualPath(formFile.getAbsolutePath())))</span>
					{
<span class="nc" id="L2018">						IwcmFsDB.writeFileToDisk(new File(formFile.getAbsolutePath()),new File(IwcmFsDB.getTempFilePath(formFile.getAbsolutePath())));</span>
<span class="nc" id="L2019">						fds=new FileDataSource(IwcmFsDB.getTempFilePath(formFile.getAbsolutePath()));</span>
					}
					else
					{
<span class="nc" id="L2023">						fds=new FileDataSource(formFile.getAbsolutePath());</span>
					}
					//FileDataSource fds = new FileDataSource(formFile.getAbsolutePath());

<span class="nc" id="L2027">					mbp2.setDataHandler(new DataHandler(fds));</span>
<span class="nc" id="L2028">					mbp2.setFileName(fileName);</span>
<span class="nc" id="L2029">					MimetypesFileTypeMap mimeTypesMap = new MimetypesFileTypeMap();</span>
<span class="nc" id="L2030">					String mimeType = mimeTypesMap.getContentType(fileName);</span>
<span class="nc bnc" id="L2031" title="All 4 branches missed.">					if(Tools.isNotEmpty(mimeType) &amp;&amp; mimeType.startsWith(&quot;text&quot;))</span>
<span class="nc" id="L2032">						mbp2.setHeader(&quot;Content-Type&quot;, mimeType+&quot;; charset=&quot;+emailEncoding);</span>
<span class="nc" id="L2033">					mp.addBodyPart(mbp2);</span>
				}
			}
		}
<span class="nc" id="L2037">		catch (Exception ex)</span>
		{
<span class="nc" id="L2039">			sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L2040">		}</span>

<span class="nc" id="L2042">	}</span>

	public static final String CROP_START = &quot;&lt;!-- formmail crop form start --&gt;&quot;;
	public static final String CROP_END = &quot;&lt;!-- formmail crop form end --&gt;&quot;;
	/**
	 * Vrati orezany HTML kod (ak obsahuje CROP_START a CROP_END)
	 * @param data - html kod
	 * @return
	 */
	public static String getCroppedHTML(String data)
	{
		try
		{
			//odstran vsetko pred &lt;body&gt; a po &lt;/body&gt;
<span class="fc" id="L2056">			String data_lcase = data.toLowerCase();</span>

			int start;
			int end;

<span class="pc bpc" id="L2061" title="1 of 2 branches missed.">			if (Constants.getBoolean(&quot;formMailCropForm&quot;))</span>
			{
<span class="nc" id="L2063">				start = data_lcase.indexOf(&quot;&lt;form&quot;);</span>
<span class="nc bnc" id="L2064" title="All 2 branches missed.">				if (start != -1) start = data_lcase.indexOf('&gt;', start);</span>
<span class="nc" id="L2065">				end = data_lcase.indexOf(&quot;&lt;/form&quot;);</span>

<span class="nc bnc" id="L2067" title="All 2 branches missed.">				if (end &gt; start)</span>
				{
<span class="nc" id="L2069">					data = data.substring(start+1, end);</span>

				}
			}
			else
			{
<span class="fc" id="L2075">				start = data_lcase.indexOf(CROP_START);</span>
<span class="fc" id="L2076">				end = data_lcase.indexOf(CROP_END);</span>

<span class="fc bfc" id="L2078" title="All 2 branches covered.">				if (end &gt; start)</span>
				{
<span class="fc" id="L2080">					data = data.substring(start + CROP_START.length(), end);</span>

				}
			}


		}
<span class="nc" id="L2087">		catch (RuntimeException e)</span>
		{
<span class="nc" id="L2089">			sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L2090">		}</span>

<span class="fc" id="L2092">		return(data);</span>
	}

	/**
	 * Detekcia, ci sa nejedna o spamovanie
	 * @param request
	 * @param db_data_names
	 * @return
	 */
	private static boolean detectSpam(HttpServletRequest request, String htmlData, String db_data_names)
	{
		//aby sa to dalo vypnut
<span class="pc bpc" id="L2104" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;spamProtection&quot;)==false) return false;</span>

		//robot to posle ako amp;savedb
<span class="pc bpc" id="L2107" title="2 of 4 branches missed.">		if (Tools.isEmpty(request.getParameter(&quot;savedb&quot;)) || Tools.isEmpty(db_data_names))</span>
		{
			//RequestBean.setErrorText(&quot;send_mail_error.span_detected&quot;);
<span class="nc" id="L2110">			RequestBean.addError(&quot;Chyba meno formularu (savedb)&quot;);</span>

<span class="nc" id="L2112">			Logger.debug(FormMailAction.class, &quot;detectSpam TRUE, saved=&quot;+request.getParameter(&quot;savedb&quot;)+&quot; db_data_names=&quot;+db_data_names);</span>
			//spam roboty toto nevedia dobre poslat, kedze je to kombinacia post a get
<span class="nc" id="L2114">			return true;</span>
		}

		//preiteruj parametre a najdi nepovolene hodnoty
<span class="fc" id="L2118">		Enumeration&lt;String&gt; e = request.getParameterNames();</span>
<span class="fc bfc" id="L2119" title="All 2 branches covered.">		while (e.hasMoreElements())</span>
		{
<span class="fc" id="L2121">			String name = e.nextElement();</span>
<span class="pc bpc" id="L2122" title="3 of 6 branches missed.">			if (DocTools.testXss(name) || name.indexOf('&quot;')!=-1 || name.indexOf('\'')!=-1) return true;</span>
<span class="fc" id="L2123">			String[] values = request.getParameterValues(name);</span>
<span class="fc bfc" id="L2124" title="All 2 branches covered.">			for (int i=0; i&lt;values.length; i++)</span>
			{
<span class="pc bpc" id="L2126" title="1 of 2 branches missed.">				if (DocTools.testXss(values[i]))</span>
				{
<span class="nc" id="L2128">					RequestBean.addError(&quot;Detekovane XSS &quot;+values[i]);</span>
<span class="nc" id="L2129">					Logger.debug(FormMailAction.class, &quot;detectSpam TRUE, val=&quot;+values[i]);</span>
<span class="nc" id="L2130">					return true;</span>
				}
			}
<span class="fc" id="L2133">		}</span>

		//test na cookies (spameri zvycajne nemaju nastavene)
<span class="pc bpc" id="L2136" title="2 of 4 branches missed.">		if (request.getCookies()==null || request.getCookies().length==0)</span>
		{
<span class="nc" id="L2138">			RequestBean.addError(&quot;Cookies su prazdne&quot;);</span>

<span class="nc" id="L2140">			Logger.debug(FormMailAction.class, &quot;detectSpam TRUE, cookies are empty&quot;);</span>
<span class="nc" id="L2141">			return true;</span>
		}

<span class="fc bfc" id="L2144" title="All 2 branches covered.">		if (!SpamProtection.canPost(&quot;form&quot;, htmlData, request))</span>
		{
<span class="fc" id="L2146">			Logger.debug(FormMailAction.class, &quot;detectSpam TRUE, can't post&quot;);</span>
<span class="fc" id="L2147">			return true;</span>
		}

<span class="fc" id="L2150">		return false;</span>
	}

	/**
	 * Vrati true, ak su zadane vsetky pozadovane povinne polia
	 * @param request
	 * @param classNames
	 * @return
	 */
	private static boolean checkRequiredFields(HttpServletRequest request, List&lt;LabelValueDetails&gt; classNames, Map&lt;String, String&gt; labelsTable, ActionBeanContext context)
	{
<span class="fc" id="L2161">		request.getSession().removeAttribute(&quot;formMailValidationErrors&quot;);</span>
<span class="fc" id="L2162">		request.getSession().removeAttribute(&quot;formMailValidationErrorsElementNameTable&quot;);</span>

<span class="fc" id="L2164">		boolean allOK = true;</span>

<span class="fc" id="L2166">		Prop prop = Prop.getInstance(PageLng.getUserLng(request));</span>

<span class="fc" id="L2168">		StringBuilder formMailValidationErrors = new StringBuilder();</span>
<span class="fc" id="L2169">		Map&lt;String, String&gt; formMailValidationErrorsElementNameTable = new Hashtable&lt;&gt;();</span>

<span class="fc bfc" id="L2171" title="All 2 branches covered.">		for (LabelValueDetails lvb : classNames )</span>
		{
<span class="fc" id="L2173">			String fieldName = lvb.getLabel();</span>
<span class="fc" id="L2174">			String className = lvb.getValue();</span>

<span class="pc bpc" id="L2176" title="1 of 2 branches missed.">			if (Tools.isEmpty(className)) continue;</span>

<span class="pc bpc" id="L2178" title="1 of 2 branches missed.">			if (fieldName != null) fieldName = fieldName.trim();</span>
<span class="fc" id="L2179">			String paramValue = request.getParameter(fieldName);</span>

<span class="fc bfc" id="L2181" title="All 2 branches covered.">			if (className.indexOf(&quot;required&quot;)!=-1)</span>
			{
<span class="pc bpc" id="L2183" title="1 of 2 branches missed.">				if (Tools.isEmpty(paramValue))</span>
				{
<span class="nc" id="L2185">					Logger.debug(FormMailAction.class, &quot;checkRequiredFields: name=&quot;+fieldName+&quot; value=&quot;+paramValue+&quot; class=&quot;+className);</span>
<span class="nc bnc" id="L2186" title="All 2 branches missed.">					if (Tools.isNotEmpty(lvb.getValue2()))</span>
					{
<span class="nc" id="L2188">						String labelValue = labelsTable.get(lvb.getValue2());</span>
<span class="nc bnc" id="L2189" title="All 2 branches missed.">						if (Tools.isNotEmpty(labelValue)) fieldName = labelValue;</span>
					}

<span class="nc bnc" id="L2192" title="All 2 branches missed.">					if (context!=null)</span>
					{
<span class="nc" id="L2194">						context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(prop.getText(&quot;validation.required.valueNotPresent&quot;), &quot;{0}&quot;, fieldName)));</span>
					}
<span class="nc" id="L2196">					formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(prop.getText(&quot;validation.required.valueNotPresent&quot;), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc" id="L2197">					formMailValidationErrorsElementNameTable.put(fieldName, className);</span>

<span class="nc" id="L2199">					allOK = false;</span>
				}
			}
<span class="fc bfc" id="L2202" title="All 2 branches covered.">			if (Tools.isNotEmpty(paramValue))</span>
			{
<span class="fc" id="L2204">				PhoneValidator phoneValidator = PhoneValidator.getInstance();</span>
<span class="fc" id="L2205">				List&lt;String&gt; phoneClasses = phoneValidator.getPhoneClasses();</span>
<span class="pc bpc" id="L2206" title="2 of 4 branches missed.">				if (phoneClasses!=null &amp;&amp; phoneClasses.size()&gt;0)</span>
				{
<span class="nc" id="L2208">					List&lt;String&gt; classes = Arrays.asList(Tools.getTokens(className, &quot; &quot;));</span>
<span class="nc bnc" id="L2209" title="All 4 branches missed.">					if (phoneValidator.hasBlacklistedPhoneClass(classes) &amp;&amp; phoneValidator.isBlacklisted(paramValue)) {</span>
<span class="nc bnc" id="L2210" title="All 2 branches missed.">						String text = &quot;components.tatrabanka.blacklistedNumber&quot;.equalsIgnoreCase(prop.getText(&quot;components.tatrabanka.blacklistedNumber&quot;)) ? prop.getText(&quot;components.form.blacklistedNumber&quot;) : prop.getText(&quot;components.tatrabanka.blacklistedNumber&quot;);</span>
<span class="nc bnc" id="L2211" title="All 2 branches missed.">						if (context != null)</span>
						{
<span class="nc" id="L2213">							context.getValidationErrors().add(fieldName, new SimpleError(text));</span>
						}
<span class="nc" id="L2215">						formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(text).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc" id="L2216">						Logger.debug(FormMailAction.class, &quot;formMailValidationErrors: &quot; + formMailValidationErrors);</span>
<span class="nc" id="L2217">						formMailValidationErrorsElementNameTable.put(fieldName, className);</span>

<span class="nc" id="L2219">						allOK = false;</span>
<span class="nc" id="L2220">					}</span>
<span class="nc bnc" id="L2221" title="All 4 branches missed.">					else if (phoneValidator.hasPhoneClass(classes) &amp;&amp; !phoneValidator.isValid(phoneClasses, paramValue))</span>
					{
<span class="nc bnc" id="L2223" title="All 2 branches missed.">						if (context != null)</span>
						{
<span class="nc" id="L2225">							context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(Tools.replace(prop.getText(&quot;validation.expression.valueFailedExpression&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)));</span>
						}
<span class="nc" id="L2227">						formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(Tools.replace(prop.getText(&quot;validation.expression.valueFailedExpression&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc" id="L2228">						Logger.debug(FormMailAction.class, &quot;formMailValidationErrors: &quot; + formMailValidationErrors);</span>
<span class="nc" id="L2229">						formMailValidationErrorsElementNameTable.put(fieldName, className);</span>

<span class="nc" id="L2231">						allOK = false;</span>
					}
				}

<span class="fc" id="L2235">				FormDB myFormDB = FormDB.getInstance();</span>
<span class="fc" id="L2236">				List&lt;String[]&gt; regularExpr = myFormDB.getAllRegularExpression();</span>

<span class="fc" id="L2238">				List&lt;String&gt; classNameList = Arrays.asList(Tools.getTokens(className, &quot; &quot;));</span>

				//case insensitive porovnanie
<span class="fc" id="L2241">				paramValue = paramValue.toLowerCase();</span>
<span class="fc bfc" id="L2242" title="All 2 branches covered.">				for(String[] regExp: regularExpr)</span>
				{
					//paramValue je LC, musime dat aj regexp na LC
<span class="fc" id="L2245">					String regex = Tools.replace(regExp[2], &quot;\\\\&quot;, &quot;\\&quot;).toLowerCase();</span>
<span class="pc bpc" id="L2246" title="1 of 4 branches missed.">					if (classNameList.contains(regExp[1]) &amp;&amp; paramValue.matches(regex)==false)</span>
					{
<span class="nc" id="L2248">						Logger.debug(FormMailAction.class, &quot;checkRequiredFields regex: name=&quot;+fieldName+&quot; value=&quot;+paramValue+&quot; class=&quot;+className+&quot; regExp name=&quot;+regExp[1]+&quot; regExp=&quot;+regex);</span>

<span class="nc bnc" id="L2250" title="All 2 branches missed.">						if (DocTools.testXss(paramValue)) paramValue = &quot;&quot;;</span>
<span class="nc bnc" id="L2251" title="All 2 branches missed.">						if (DocTools.testXss(fieldName)) fieldName = &quot;&quot;;</span>

<span class="nc" id="L2253">						paramValue = ResponseUtils.filter(paramValue);</span>
<span class="nc" id="L2254">						fieldName = ResponseUtils.filter(fieldName);</span>

<span class="nc bnc" id="L2256" title="All 2 branches missed.">						if (context!=null)</span>
						{
<span class="nc bnc" id="L2258" title="All 2 branches missed.">							if(className.indexOf(&quot;email&quot;) != -1)</span>
<span class="nc" id="L2259">								context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(prop.getText(&quot;converter.email.invalidEmail&quot;), &quot;{1}&quot;, paramValue)));</span>
<span class="nc bnc" id="L2260" title="All 2 branches missed.">							else if(className.indexOf(&quot;minLen&quot;) != -1)</span>
<span class="nc" id="L2261">								context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(Tools.replace(prop.getText(&quot;validation.minlength.valueTooShort&quot;), &quot;{2}&quot;, paramValue.replaceFirst(&quot;minLen&quot;, &quot;&quot;)), &quot;{0}&quot;, fieldName)));</span>
<span class="nc bnc" id="L2262" title="All 2 branches missed.">							else if(className.indexOf(&quot;number&quot;) != -1)</span>
<span class="nc" id="L2263">								context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(Tools.replace(prop.getText(&quot;converter.number.invalidNumber&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)));</span>
							else
<span class="nc" id="L2265">								context.getValidationErrors().add(fieldName, new SimpleError(Tools.replace(Tools.replace(prop.getText(&quot;validation.expression.valueFailedExpression&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)));</span>
						}
<span class="nc bnc" id="L2267" title="All 2 branches missed.">						if(className.indexOf(&quot;email&quot;) != -1)</span>
<span class="nc" id="L2268">							formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(prop.getText(&quot;converter.email.invalidEmail&quot;), &quot;{1}&quot;, paramValue)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc bnc" id="L2269" title="All 2 branches missed.">						else if(className.indexOf(&quot;minLen&quot;) != -1)</span>
<span class="nc" id="L2270">							formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(Tools.replace(prop.getText(&quot;validation.minlength.valueTooShort&quot;), &quot;{2}&quot;, className.replaceFirst(&quot;minLen&quot;, &quot;&quot;)), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc bnc" id="L2271" title="All 2 branches missed.">						else if(className.indexOf(&quot;number&quot;) != -1)</span>
<span class="nc" id="L2272">							formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(Tools.replace(prop.getText(&quot;converter.number.invalidNumber&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
						else
<span class="nc" id="L2274">							formMailValidationErrors.append(&quot;&lt;li&gt;&quot;).append(Tools.replace(Tools.replace(prop.getText(&quot;validation.expression.valueFailedExpression&quot;), &quot;{1}&quot;, paramValue), &quot;{0}&quot;, fieldName)).append(&quot;&lt;/li&gt;&quot;).append('\n');</span>
<span class="nc" id="L2275">						Logger.debug(FormMailAction.class, &quot;formMailValidationErrors: &quot; + formMailValidationErrors);</span>
<span class="nc" id="L2276">						formMailValidationErrorsElementNameTable.put(fieldName, className);</span>

<span class="nc" id="L2278">						RequestBean.addError(&quot;Chyba regexp validacie &quot;+fieldName+&quot;: &quot;+formMailValidationErrors.toString());</span>

<span class="nc" id="L2280">						allOK = false;</span>
					}
<span class="fc" id="L2282">				}</span>
			}
<span class="fc" id="L2284">		}</span>

<span class="pc bpc" id="L2286" title="1 of 2 branches missed.">		if (formMailValidationErrors.length() &gt; 4)</span>
		{
<span class="nc" id="L2288">			request.getSession().setAttribute(&quot;formMailValidationErrors&quot;, &quot;&lt;ol class='formMailValidationErrors'&gt;&quot;+formMailValidationErrors.toString()+&quot;&lt;/ol&gt;&quot;);</span>
<span class="nc" id="L2289">			request.getSession().setAttribute(&quot;formMailValidationErrorsElementNameTable&quot;, formMailValidationErrorsElementNameTable);</span>
		}

<span class="fc" id="L2292">		return allOK;</span>
	}

	/**
	 * Ulozi formular ako pdfko
	 * @param htmlData
	 */
	private static String saveFormAsPdf(String htmlData, int formId, HttpServletRequest request)
	{
<span class="nc" id="L2301">		Logger.println(FormMailAction.class, &quot;Exportujem formular do pdf, form_id: &quot;+formId+&quot; path: &quot;+</span>
<span class="nc" id="L2302">				Tools.getRealPath(FORM_FILE_DIR)+File.separator+formId+&quot;_pdf.pdf&quot;);</span>
		try
		{
<span class="nc" id="L2305">			IwcmFile dir = new IwcmFile(Tools.getRealPath(FORM_FILE_DIR));</span>
<span class="nc bnc" id="L2306" title="All 2 branches missed.">			if (dir.exists()==false) dir.mkdirs();</span>

<span class="nc" id="L2308">			FileOutputStream fos = new FileOutputStream(Tools.getRealPath(FORM_FILE_DIR)+File.separator+formId+&quot;_pdf.pdf&quot;);</span>

<span class="nc" id="L2310">			PdfTools.renderHtmlCode(htmlData, fos, request);</span>

<span class="nc" id="L2312">			fos.close();</span>

<span class="nc" id="L2314">			return Tools.getRealPath(FORM_FILE_DIR)+File.separator+formId+&quot;_pdf.pdf&quot;;</span>
		}
<span class="nc" id="L2316">		catch (Exception e)</span>
		{
<span class="nc" id="L2318">			sk.iway.iwcm.Logger.error(e);</span>
		}

<span class="nc" id="L2321">		return &quot;&quot;;</span>
	}

	/**
	 * Skontroluje captcha kod, ak v htmlData je retazes captcha.jsp
	 * @param request
	 * @param hasCaptchaInclude
	 * @return
	 */
	private static boolean checkCaptcha(HttpServletRequest request, boolean hasCaptchaInclude)
	{
<span class="fc" id="L2332">		String captchaType = Constants.getString(&quot;captchaType&quot;);</span>
<span class="pc bpc" id="L2333" title="1 of 2 branches missed.">		if (Tools.isEmpty(captchaType)) captchaType = &quot;none&quot;;</span>

<span class="pc bpc" id="L2335" title="1 of 2 branches missed.">		if (&quot;internal&quot;.equals(captchaType)==false)</span>
		{
			//nie su nastavene premenne, takze nemozeme validovat
<span class="nc bnc" id="L2338" title="All 6 branches missed.">			if(!Constants.getBoolean(&quot;reCaptchaEnabled&quot;) || Tools.isEmpty(Constants.getString(&quot;reCaptchaSiteKey&quot;)) || Tools.isEmpty(Constants.getString(&quot;reCaptchaSecret&quot;)))</span>
			{
<span class="nc" id="L2340">				captchaType = &quot;none&quot;;</span>
			}
		}

<span class="fc" id="L2344">		String captchaResponse = getCaptchaRespons(request);</span>
<span class="pc bpc" id="L2345" title="3 of 6 branches missed.">		if (&quot;none&quot;.equals(captchaType)==false &amp;&amp; (Tools.isNotEmpty(captchaResponse) || hasCaptchaInclude))</span>
		{
<span class="nc" id="L2347">			boolean captchaOK = Captcha.validateResponse(request, captchaResponse, null);</span>
<span class="nc" id="L2348">			return captchaOK;</span>
		}

<span class="fc" id="L2351">		return true;</span>
	}

	private static String getCaptchaRespons(HttpServletRequest request)
	{
<span class="fc" id="L2356">		String captchaResponse = Tools.getStringValue(request.getParameter(&quot;g-recaptcha-response&quot;), &quot;&quot;);</span>
<span class="pc bpc" id="L2357" title="1 of 2 branches missed.">		if (Tools.isEmpty(captchaResponse)) {</span>
<span class="fc" id="L2358">			captchaResponse = Tools.getStringValue(request.getParameter(&quot;wjcaptcha&quot;), &quot;&quot;);</span>
		}
<span class="fc" id="L2360">		return captchaResponse;</span>
	}

	/**
	 * Nahradi kod captcha include zadanou hodnotou pouzivatela
	 * @param request
	 * @param htmlData
	 * @return
	 */
	private static String replaceCaptchaInclude(HttpServletRequest request, String htmlData)
	{
<span class="fc" id="L2371">		String value = getCaptchaRespons(request);</span>
<span class="pc bpc" id="L2372" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(value))</span>
		{
<span class="nc" id="L2374">			htmlData = Tools.replace(htmlData, &quot;!INCLUDE(/components/form/captcha.jsp)!&quot;, value);</span>
		}
<span class="fc" id="L2376">		return htmlData;</span>
	}

	private static String appendStyle(String htmlData, String styleHtml, String emailEncoding, boolean forceTextPlain)
	{
<span class="pc bpc" id="L2381" title="1 of 4 branches missed.">		if (forceTextPlain || Constants.getBoolean(&quot;formMailSendPlainText&quot;)) return htmlData;</span>

<span class="pc bpc" id="L2383" title="1 of 2 branches missed.">		if (styleHtml == null) styleHtml = &quot;&quot;;</span>

<span class="fc" id="L2385">		String metaEncoding = &quot;&quot;;</span>
<span class="fc bfc" id="L2386" title="All 2 branches covered.">		if (Tools.isNotEmpty(emailEncoding)) metaEncoding = &quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=&quot;+emailEncoding+&quot;\&quot;&gt;&quot;;</span>

<span class="fc" id="L2388">		return (&quot;&lt;html&gt;&lt;head&gt;&quot;+metaEncoding+styleHtml+&quot;&lt;/head&gt;&lt;body id='WebJETEditorBody' class=\&quot;WebJETMailBody\&quot;&gt;&lt;div class=\&quot;WebJETMailWrapper\&quot;&gt;\n\n&quot;+htmlData+&quot;\n\n&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
	}

	/**
	 * Vytvori absolutne cesty v zadanom HTML kode
	 * @param htmlCode - HTML kod
	 * @return
	 */
	private static String createAbsolutePath(String htmlCode, HttpServletRequest request)
	{
<span class="fc" id="L2398">		String basePath = Tools.getBaseHref(request);</span>
		//ak je tam uz base path, tak ju zrus, inak tam bude 2x
		//zrusene, pretoze to odstranovalo domenu z technickeho info htmlCode = Tools.replace(htmlCode, basePath, &quot;&quot;);
<span class="fc" id="L2401">		htmlCode = Tools.replace(htmlCode, &quot;../&quot;, &quot;/&quot;);</span>
<span class="fc" id="L2402">		htmlCode = Tools.replace(htmlCode, &quot;url(images/&quot;, &quot;url(&quot;+basePath+&quot;/images/&quot;);</span>
<span class="fc" id="L2403">		htmlCode = Tools.replace(htmlCode, &quot;url(/images/&quot;, &quot;url(&quot;+basePath+&quot;/images/&quot;);</span>
<span class="fc" id="L2404">		htmlCode = Tools.replace(htmlCode, &quot;\&quot;/images/&quot;, &quot;\&quot;&quot;+basePath+&quot;/images/&quot;);</span>
<span class="fc" id="L2405">		htmlCode = Tools.replace(htmlCode, &quot;\&quot;/files/&quot;, &quot;\&quot;&quot;+basePath+&quot;/files/&quot;);</span>
<span class="fc" id="L2406">		htmlCode = Tools.replace(htmlCode, &quot;\&quot;/css/&quot;, &quot;\&quot;&quot;+basePath+&quot;/css/&quot;);</span>

<span class="fc" id="L2408">		return(htmlCode);</span>
	}

	private static String checkEmailCssVersion(String cssLink)
	{
<span class="fc bfc" id="L2413" title="All 2 branches covered.">		if (cssLink == null) return cssLink;</span>

		//sprav custom verziu
<span class="fc" id="L2416">		String emailCssLink = Tools.replace(cssLink, &quot;.css&quot;, &quot;-email.css&quot;);</span>
<span class="pc bpc" id="L2417" title="1 of 2 branches missed.">		if (FileTools.isFile(emailCssLink)) return emailCssLink;</span>

<span class="fc" id="L2419">		return cssLink;</span>
	}

	/**
	 * IE8 a podobne vratia ako meno suboru kompletnu cestu na disku cize c:\adresar\meno.doc, toto z toho spravi len meno.doc
	 * @param fileName
	 * @return
	 */
	private static String fixFileNameDirPath(String fileName)
	{
		try
		{
<span class="nc" id="L2431">			int lomka = fileName.lastIndexOf(&quot;/&quot;);</span>
<span class="nc bnc" id="L2432" title="All 2 branches missed.">			if (lomka &gt; 0) fileName = fileName.substring(lomka+1);</span>
<span class="nc" id="L2433">			lomka = fileName.lastIndexOf(&quot;\\&quot;);</span>
<span class="nc bnc" id="L2434" title="All 2 branches missed.">			if (lomka &gt; 0) fileName = fileName.substring(lomka+1);</span>
		}
<span class="nc" id="L2436">		catch (Exception e)</span>
		{
<span class="nc" id="L2438">			Logger.error(FormMailAction.class, e);</span>
<span class="nc" id="L2439">		}</span>

<span class="nc" id="L2441">		return fileName;</span>
	}

	/**
	 * Skontroluje CSRF token
	 * @param request
	 * @return
	 */
	private static boolean checkCsrf(HttpServletRequest request)
	{
<span class="fc" id="L2451">		String spamProtectionJavascript = Constants.getString(&quot;spamProtectionJavascript&quot;);</span>
<span class="pc bpc" id="L2452" title="1 of 2 branches missed.">		if (spamProtectionJavascript.contains(&quot;formmailCsrf&quot;)==false)</span>
		{
			//csrf token sa nepouziva
<span class="nc" id="L2455">			return true;</span>
		}
<span class="fc" id="L2457">		boolean isCorrect = CSRF.verifyTokenAndDeleteIt(request);</span>
<span class="fc" id="L2458">		return isCorrect;</span>
	}

	private static String fieldToText(String fieldName, Map&lt;String, String&gt; labelsTable)
	{
<span class="fc" id="L2463">		String label = labelsTable.get(fieldName);</span>

		//ak je to radiobutton ma vlastny label, skus najst label bez _rb_ nazvu
		//Pozadavek-na-odber-el-energie_rb_Ne -&gt; Pozadavek-na-odber-el-energie
<span class="pc bpc" id="L2467" title="2 of 4 branches missed.">		if (fieldName!=null &amp;&amp; fieldName.toLowerCase().endsWith(&quot;_rb&quot;))</span>
		{
<span class="nc" id="L2469">			int i = fieldName.indexOf(&quot;_rb&quot;);</span>
<span class="nc bnc" id="L2470" title="All 2 branches missed.">			if (i&gt;2)</span>
			{
<span class="nc" id="L2472">				String labelRadioButtons = labelsTable.get(fieldName.substring(0, i));</span>
<span class="nc bnc" id="L2473" title="All 2 branches missed.">				if (Tools.isNotEmpty(labelRadioButtons))</span>
				{
<span class="nc" id="L2475">					label = labelRadioButtons;</span>
				}
			}
		}

<span class="fc bfc" id="L2480" title="All 2 branches covered.">		if (Tools.isEmpty(label)) label = Tools.replace(fieldName, &quot;-&quot;, &quot; &quot;);</span>

<span class="fc" id="L2482">		label = Tools.replace(label, &quot; *&quot;, &quot;&quot;);</span>
<span class="fc" id="L2483">		label = Tools.replace(label, &quot;e mail&quot;, &quot;e-mail&quot;);</span>

<span class="fc" id="L2485">		return label;</span>
	}

	/**
	 * Vrati prvy email so zoznamu (email1@domena.sk,email2@domena.sk vrati email1@domena.sk)
	 * @param emails
	 * @return
	 */
	private static String getFirstEmail(String emails)
	{
<span class="pc bpc" id="L2495" title="1 of 2 branches missed.">		if (Tools.isEmpty(emails)) return &quot;&quot;;</span>

<span class="fc" id="L2497">		String[] emailsArr = Tools.getTokens(emails, &quot;,&quot;, true);</span>
<span class="pc bpc" id="L2498" title="1 of 2 branches missed.">		if (emailsArr.length&gt;0) return emailsArr[0];</span>

<span class="nc" id="L2500">		return &quot;&quot;;</span>
	}

	private static String getDoubleOptInParameters(HttpServletRequest request, int formId) {
<span class="fc" id="L2504">		String hash = Password.generateStringHash(16);</span>
<span class="fc" id="L2505">		updateHash(request, formId, hash);</span>
<span class="fc" id="L2506">		return hash;</span>
	}

	private static void updateHash(HttpServletRequest request, int formId, String hash) {
<span class="fc" id="L2510">		Connection db_conn = null;</span>
<span class="fc" id="L2511">		PreparedStatement ps = null;</span>

		try {
<span class="fc" id="L2514">			db_conn = DBPool.getConnection(request);</span>
<span class="fc" id="L2515">			ps = db_conn.prepareStatement(&quot;UPDATE forms SET double_optin_hash=? WHERE id=? &quot; + CloudToolsForCore.getDomainIdSqlWhere(true));</span>
<span class="fc" id="L2516">			ps.setString(1, hash);</span>
<span class="fc" id="L2517">			ps.setInt(2, formId);</span>
<span class="fc" id="L2518">			ps.execute();</span>
<span class="fc" id="L2519">			ps.close();</span>
<span class="nc" id="L2520">		} catch (SQLException e) {</span>
<span class="nc" id="L2521">			sk.iway.iwcm.Logger.error(e);</span>
		} finally
		{
			try
			{
<span class="pc bpc" id="L2526" title="1 of 2 branches missed.">				if (ps != null) ps.close();</span>
<span class="pc bpc" id="L2527" title="1 of 2 branches missed.">				if (db_conn != null) db_conn.close();</span>
			}
<span class="nc" id="L2529">			catch (Exception e)</span>
			{
<span class="nc" id="L2531">				sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L2532">			}</span>
		}
<span class="fc" id="L2534">	}</span>

	/**
	 * Odoslanie notifikacie na email navstevnika, ktory ho vyplnil, zadane v poli formmail_sendUserInfoDocId
	 * @param sendUserInfoDocId
	 * @param formId
	 * @param email
	 * @param attachs
	 * @param request
	 */
	private static void sendUserInfo(int sendUserInfoDocId, int formId, String email, List&lt;IwcmFile&gt; attachs, Map&lt;String, List&lt;UploadedFile&gt;&gt; formFilesTable, HttpServletRequest request)
	{
<span class="fc" id="L2546">		DocDB docDB = DocDB.getInstance();</span>

<span class="fc" id="L2548">		DocDetails doc = docDB.getDoc(sendUserInfoDocId);</span>
<span class="pc bpc" id="L2549" title="1 of 2 branches missed.">		Logger.debug(FormMailAction.class,&quot;doubleOptIn=&quot;+request.getParameter(&quot;doubleOptIn&quot;)+&quot;, sendUserInfoDocId-doc=&quot;+(doc != null ? doc.getDocId() : null));</span>
<span class="pc bpc" id="L2550" title="1 of 2 branches missed.">		if (doc != null)</span>
		{
<span class="fc" id="L2552">			String data = SearchTools.removeCommands(doc.getData()); //odstranim z HTML riadiace bloky napr.: !INCLUDE(...)!, !PARAMETER(...)!</span>
<span class="fc" id="L2553">			StringBuilder attachments = new StringBuilder();</span>
<span class="pc bpc" id="L2554" title="1 of 2 branches missed.">			for (IwcmFile attach : attachs) {</span>
<span class="nc" id="L2555">				attachments.append(attach.getVirtualPath());</span>
<span class="nc" id="L2556">				attachments.append(&quot;;&quot;);</span>
<span class="nc" id="L2557">				attachments.append(attach.getName());</span>
<span class="nc" id="L2558">				attachments.append(&quot;;&quot;);</span>
<span class="nc" id="L2559">			}</span>

<span class="pc bpc" id="L2561" title="1 of 2 branches missed.">			if (&quot;true&quot;.equals(request.getParameter(&quot;doubleOptIn&quot;))) {</span>
<span class="fc" id="L2562">				String hash = getDoubleOptInParameters(request, formId);</span>
<span class="fc" id="L2563">				data = Tools.replace(data, &quot;!FORM_ID!&quot;, &quot;&quot; + formId);</span>
<span class="fc" id="L2564">				data = Tools.replace(data, &quot;!OPTIN_HASH!&quot;, hash);</span>
			}

<span class="fc bfc" id="L2567" title="All 2 branches covered.">			for (String parameterName: Collections.list(request.getParameterNames()))</span>
			{
<span class="fc" id="L2569">				String value = getValue(parameterName, request, formFilesTable);</span>

<span class="fc" id="L2571">				data = Tools.replace(data, &quot;!&quot; + parameterName.toUpperCase() + &quot;!&quot;, value);</span>
<span class="fc" id="L2572">				data = Tools.replace(data, &quot;!&quot; + parameterName + &quot;!&quot;, value);</span>
<span class="fc" id="L2573">			}</span>

<span class="fc" id="L2575">			String authorName = Constants.getString(&quot;formmailSendUserInfoSenderName&quot;);</span>
<span class="pc bpc" id="L2576" title="1 of 2 branches missed.">			if(Tools.isEmpty(authorName)) authorName = SendMail.getDefaultSenderName(&quot;formmail&quot;, doc.getAuthorName());</span>
<span class="fc" id="L2577">			String authorEmail = Constants.getString(&quot;formmailSendUserInfoSenderEmail&quot;);</span>
<span class="pc bpc" id="L2578" title="1 of 2 branches missed.">			if(Tools.isEmail(authorEmail) == false) authorEmail = SendMail.getDefaultSenderEmail(&quot;formmail&quot;, doc.getAuthorEmail());</span>
<span class="fc" id="L2579">			Logger.debug(FormMailAction.class,&quot;sendUserInfoSenderName=&quot;+authorName+&quot;, sendUserInfoSenderEmail=&quot;+authorEmail);</span>
<span class="fc" id="L2580">			SendMail.send(authorName, authorEmail, email, null, null, null, doc.getTitle(), &quot;&lt;html&gt;&lt;body&gt;&quot;+data+&quot;&lt;/body&gt;&lt;/html&gt;&quot;, Tools.getBaseHref(request), attachments.toString());</span>
		}
<span class="fc" id="L2582">	}</span>

	private static String toString(StringBuilder sb) {
<span class="fc bfc" id="L2585" title="All 2 branches covered.">		if (sb == null) return null;</span>
<span class="fc" id="L2586">		return sb.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>