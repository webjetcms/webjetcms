<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WriteTag.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.tags</a> &gt; <span class="el_source">WriteTag.java</span></div><h1>WriteTag.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.tags;

import net.sourceforge.stripes.exception.SourcePageNotFoundException;
import org.apache.commons.lang.time.StopWatch;
import org.apache.struts.Globals;
import org.apache.struts.util.ResponseUtils;
import org.springframework.context.ApplicationContext;
import sk.iway.iwcm.*;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.common.SearchTools;
import sk.iway.iwcm.common.WriteTagToolsForCore;
import sk.iway.iwcm.doc.DebugTimer;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.ninja.Amp;
import sk.iway.iwcm.editor.EditorDB;
import sk.iway.iwcm.editor.InlineEditor;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.stat.BrowserDetector;
import sk.iway.iwcm.system.WJResponseWrapper;
import sk.iway.iwcm.system.context.ContextFilter;
import sk.iway.iwcm.system.monitoring.ExecutionTimeMonitor;
import sk.iway.iwcm.system.monitoring.MemoryMeasurement;
import sk.iway.iwcm.system.spring.components.SpringContext;
import sk.iway.iwcm.system.spring.webjet_component.WebjetComponentParser;
import sk.iway.iwcm.users.UsersDB;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import javax.servlet.jsp.JspException;
import javax.servlet.jsp.PageContext;
import javax.servlet.jsp.tagext.BodyTagSupport;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.ArrayList;
import java.util.List;
import java.util.StringTokenizer;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 *  vypise string ulozeny v request objekte (vyhodne ked sa to setne v nejakej
 *  Action triede)
 *
 *@Title        Interway Content Management
 *@Company      Interway s.r.o. (www.interway.sk)
 *@Copyright    Interway s.r.o. (c) 2001-2002
 *@author       $Author: jeeff $
 *@version      $Revision: 1.45 $
 *@created      $Date: 2010/01/20 10:13:50 $
 */
<span class="fc" id="L54">public class WriteTag extends BodyTagSupport</span>
{
	private static final long serialVersionUID = -5549714303388477615L;

	public static final String SKIP_BODY = &quot;writeTag.skipBody&quot;;

	// Name of request attribute - required
<span class="fc" id="L61">	private String name = null;</span>

	private static final String INCLUDE_START = &quot;!INCLUDE(&quot;;
	private static final String INCLUDE_END = &quot;)!&quot;;

	public static final String PAGE_PARAMS = &quot;includePageParams&quot;;

	private static final String AFTER_WRITE_INCLUDE_LIST = &quot;sk.iway.iwcm.tags.afterWriteIncludeFile&quot;;

	private static final String INLINE_EDITING_BUTTONS_KEY = &quot;inlineEditingButtons&quot;;
	private static final String INLINE_EDITING_BUTTONS_TOP_KEY = &quot;inlineEditingButtonsTop&quot;;
	private static final String INLINE_EDITING_MODULE_PROPS_DISABLE_KEY = &quot;inlineEditingModulePropsDisabled&quot;;
	private static final String INLINE_EDITING_MODULE_PROPS_TEXT_KEY = &quot;inlineEditingModulePropsTextKey&quot;;
	private static final String INLINE_EDITING_MODULE_PROPS_ICON = &quot;inlineEditingModulePropsIcon&quot;;
	public static final String INLINE_EDITING_PLACEHOLDER = &quot;&lt;div class='inlineEditingToolbarPlaceholder'&gt;&lt;/div&gt;&quot;;

	private static final String INLINE_EDITING_DISABLE_DELETE_BUTTON = &quot;inlineEditingDisableDeleteButton&quot;;


	@Override
	public void release()
	{
<span class="fc" id="L83">		super.release();</span>
<span class="fc" id="L84">		name = null;</span>
<span class="fc" id="L85">	}</span>

	/**
	 *  Description of the Method
	 *
	 *@return                   Description of the Return Value
	 *@exception  JspException  Description of the Exception
	 */
	@Override
	public final int doEndTag() throws JspException
	{
		try
		{
<span class="fc" id="L98">			HttpServletRequest request = (HttpServletRequest) pageContext.getRequest();</span>

<span class="fc" id="L100">			Object value = null;</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">			if (Tools.isNotEmpty(name))</span>
			{
<span class="fc" id="L103">				value = request.getAttribute(name);</span>
			}
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">			else if (getBodyContent()!=null)</span>
			{
<span class="fc" id="L107">				value = getBodyContent().getString();</span>
			}

<span class="fc" id="L110">			request.setAttribute(&quot;writeTagName&quot;, name);</span>
<span class="fc" id="L111">			pageContext.setAttribute(&quot;writeTagName&quot;, name);</span>

<span class="fc" id="L113">			String lng = PageLng.getUserLng(request);</span>
<span class="fc" id="L114">			pageContext.setAttribute(&quot;lng&quot;, lng);</span>

<span class="fc" id="L116">			int docId = Tools.getDocId(request);</span>
<span class="fc" id="L117">			boolean inlineEditingToolbarAppended = false;</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">			if (&quot;doc_data&quot;.equals(name))</span>
			{
				//WebJET7 vyzaduje jQuery
<span class="fc" id="L121">				String tempName = (String)request.getAttribute(&quot;doc_temp_name&quot;);</span>
				//ochrana pre RSS aby sa negenerovalo
<span class="pc bpc" id="L123" title="3 of 6 branches missed.">				if (tempName == null || (tempName.toLowerCase().indexOf(&quot;rss&quot;)==-1 &amp;&amp; tempName.toLowerCase().indexOf(&quot;nojquery&quot;)==-1))</span>
				{
<span class="fc" id="L125">					String jQueryHtml = Tools.insertJQuery(request);</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">					if (Tools.isNotEmpty(jQueryHtml))</span>
					{
<span class="nc" id="L128">						pageContext.getOut().write(jQueryHtml);</span>
					}
				}

<span class="fc bfc" id="L132" title="All 2 branches covered.">				if (InlineEditor.isInlineEditingEnabled(request))</span>
				{
<span class="fc" id="L134">					Identity user = UsersDB.getCurrentUser(request);</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">					if (isInlinePageEditable(user, docId, request))</span>
					{
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">						if (&quot;true&quot;.equals(request.getParameter(&quot;inlineEditorAdmin&quot;))) {</span>
<span class="fc" id="L138">							request.setAttribute(&quot;writeTag.inlineEditingScriptInserted&quot;, &quot;1&quot;);</span>
<span class="fc" id="L139">							pageContext.include(WriteTag.getCustomPageAdminNotNull(&quot;/admin/inline/inline_page_toolbar_v9.jsp&quot;, request));</span>
<span class="fc" id="L140">							inlineEditingToolbarAppended = true;</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">							if (request.getAttribute(SKIP_BODY)!=null)</span>
							{
<span class="nc" id="L143">								value = null;</span>
							}
						} else {
<span class="nc" id="L146">							appendInlineEditingScript(pageContext, request);</span>
<span class="nc" id="L147">							pageContext.include(WriteTag.getCustomPageAdminNotNull(&quot;/admin/inline/inline_page_toolbar.jsp&quot;, request));</span>
<span class="nc" id="L148">							inlineEditingToolbarAppended = true;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">							if (request.getAttribute(SKIP_BODY)!=null)</span>
							{
<span class="nc" id="L151">								value = null;</span>
							}
						}
					}
				}
<span class="fc" id="L156">			}</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">			else if (InlineEditor.isInlineEditingEnabled(request))</span>
			{
<span class="fc" id="L159">				String editableObjects = Constants.getString(&quot;inlineEditableObjects&quot;);</span>
<span class="pc bpc" id="L160" title="3 of 6 branches missed.">				if (Tools.isNotEmpty(name) &amp;&amp; Tools.isNotEmpty(editableObjects) &amp;&amp; editableObjects.indexOf(name)!=-1)</span>
				{
<span class="nc" id="L162">					DocDetails doc = (DocDetails)request.getAttribute(name+&quot;-docDetails&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">					if (doc != null)</span>
					{
<span class="nc" id="L165">						Identity user = UsersDB.getCurrentUser(request);</span>
<span class="nc bnc" id="L166" title="All 4 branches missed.">						if (isInlinePageEditable(user, docId, request) &amp;&amp; isInlinePageEditable(user, doc.getDocId(), request))</span>
						{
<span class="nc" id="L168">							String html = (String)request.getAttribute(name);</span>
<span class="nc" id="L169">							value = &quot;&lt;div id='&quot;+name+&quot;Editor'&quot;+InlineEditor.getEditAttrs(request, doc)+&quot;&gt;&quot;+html+&quot;&lt;/div&gt;&quot;;</span>
						}
					}
				}
			}

<span class="fc" id="L175">			String afterWriteEndTag = null;</span>
<span class="pc bpc" id="L176" title="1 of 4 branches missed.">			if (inlineEditingToolbarAppended &amp;&amp; &quot;doc_data&quot;.equals(name))</span>
			{
<span class="fc" id="L178">				DocDetails doc = (DocDetails)request.getAttribute(&quot;docDetails&quot;);</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">				if (doc != null)</span>
				{
<span class="fc" id="L181">					pageContext.getOut().write(&quot;&lt;div id='wjInline-docdata' &quot;+InlineEditor.getEditAttrs(request, doc, &quot;doc_data&quot;, false)+&quot;&gt;&quot;);</span>

<span class="fc" id="L183">					afterWriteEndTag = &quot;&lt;/div&gt;&quot;;</span>
				}
			}

<span class="fc bfc" id="L187" title="All 2 branches covered.">			if (value != null)</span>
			{
<span class="fc" id="L189">				writeText(value.toString(), pageContext, name);</span>
			}

<span class="fc bfc" id="L192" title="All 2 branches covered.">			if (afterWriteEndTag != null)</span>
			{
<span class="fc" id="L194">				pageContext.getOut().print(afterWriteEndTag);</span>
			}

<span class="fc bfc" id="L197" title="All 4 branches covered.">			if (&quot;doc_data&quot;.equals(name) || &quot;doc_header&quot;.equals(name))</span>
			{
				try
				{
<span class="fc" id="L201">					boolean showToolbar = true;</span>

					//skus ziskat zo sablony priznak, ze sa nema zobrazit
<span class="fc" id="L204">					String afterBody = (String)request.getAttribute(&quot;after_body&quot;);</span>

<span class="pc bpc" id="L206" title="2 of 4 branches missed.">					if (afterBody!=null &amp;&amp; afterBody.indexOf(&quot;NO WJTOOLBAR&quot;)!=-1)</span>
					{
<span class="nc" id="L208">						showToolbar = false;</span>
					}

<span class="fc bfc" id="L211" title="All 2 branches covered.">					if (request.getParameter(&quot;NO_WJTOOLBAR&quot;)!=null)</span>
					{
<span class="fc" id="L213">						request.getSession().setAttribute(&quot;NO_WJTOOLBAR&quot;, &quot;1&quot;);</span>
					}

<span class="pc bpc" id="L216" title="3 of 12 branches missed.">					if (request.getHeader(&quot;dmail&quot;)!=null || request.getAttribute(&quot;NO WJTOOLBAR&quot;)!=null || (request.getSession()!=null &amp;&amp; request.getSession().getAttribute(&quot;NO_WJTOOLBAR&quot;)!=null) || request.getParameter(&quot;NO_WJTOOLBAR&quot;)!=null || request.getAttribute(&quot;isPreview&quot;)!=null)</span>
					{
<span class="fc" id="L218">						showToolbar = false;</span>
					}

<span class="fc bfc" id="L221" title="All 2 branches covered.">					if (request.getSession().getAttribute(&quot;userWasInWebpages&quot;) == null)</span>
					{
						//este nebol realne v admin casti v menu WebStranky (mozno sa prihlasil ako normalny user)
<span class="fc" id="L224">						showToolbar = false;</span>
					}

<span class="fc bfc" id="L227" title="All 2 branches covered.">					if (Constants.getBoolean(&quot;disableWebJETToolbar&quot;))</span>
					{
<span class="fc" id="L229">						showToolbar = false;</span>
					}

<span class="fc bfc" id="L232" title="All 2 branches covered.">					if (&quot;false&quot;.equals(request.getParameter(&quot;NO_WJTOOLBAR&quot;)))</span>
					{
<span class="fc" id="L234">						showToolbar = true;</span>
<span class="fc" id="L235">						request.getSession().removeAttribute(&quot;NO_WJTOOLBAR&quot;);</span>
					}

<span class="fc bfc" id="L238" title="All 2 branches covered.">					if (inlineEditingToolbarAppended)</span>
					{
<span class="fc" id="L240">						showToolbar = false;</span>
					}

<span class="fc bfc" id="L243" title="All 2 branches covered.">					if (showToolbar)</span>
					{
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">						if (&quot;doc_data&quot;.equals(name))</span>
						{
<span class="fc" id="L247">							pageContext.include(&quot;/admin/page_toolbar.jsp&quot;);</span>
						}
					}
				}
<span class="nc" id="L251">				catch (Exception e)</span>
				{
<span class="nc" id="L253">					Logger.error(WriteTag.class, e);</span>
<span class="fc" id="L254">				}</span>

<span class="pc bpc" id="L256" title="1 of 2 branches missed.">				if (request.getParameter(&quot;_editFormId&quot;)!=null)</span>
				{
<span class="nc" id="L258">					pageContext.include(&quot;/components/form/admin_fill_form_data.jsp&quot;);</span>
				}
			}

			//dt.diff(&quot;done: &quot;+(String)value);
		}
<span class="nc" id="L264">		catch (JspException je)</span>
		{
<span class="nc" id="L266">			Logger.error(WriteTag.class, &quot;{&quot;+Constants.getInstallName()+&quot;} error: &quot; + je.getMessage());</span>
<span class="nc" id="L267">			Logger.error(WriteTag.class, je);</span>
		}
<span class="nc" id="L269">		catch (Exception e)</span>
		{
<span class="nc" id="L271">			Logger.error(WriteTag.class, &quot;{&quot;+Constants.getInstallName()+&quot;} error: &quot; + e.getMessage());</span>
<span class="nc" id="L272">			Logger.error(WriteTag.class, e);</span>
<span class="pc" id="L273">		}</span>
<span class="fc" id="L274">		return EVAL_PAGE;</span>
	}

	/**
	 *  Set the required tag attribute &lt;b&gt;name&lt;/b&gt; .
	 *
	 *@param  newName  The new name value
	 */
	public final void setName(String newName)
	{
<span class="fc" id="L284">		name = newName;</span>
<span class="fc" id="L285">	}</span>

	/**
	 * @deprecated pouzi WriteTagToolsForCore.isFileExists((fileUrl));
	 */
	@Deprecated
	public static boolean isFileExists(String fileUrl)
	{
<span class="nc" id="L293">		return WriteTagToolsForCore.isFileExists((fileUrl));</span>
	}

	/**
	 * Pre zadane URL JSP suboru najde jeho custom alternativu
	 * @param includeFileName
	 * @param request
	 * @return
	 *
	 * @deprecated pouzi WriteTagToolsForCore.getCustomPage(includeFileName,request);
	 */
	@Deprecated
	public static String getCustomPage(String includeFileName, HttpServletRequest request)
	{
<span class="fc" id="L307">		return WriteTagToolsForCore.getCustomPage(includeFileName,request);</span>
	}

	/**
	 * Vrati custom cestu ku komponente, alebo null, ak nie je custom cesta
	 * @param includeFileName
	 * @param request
	 * @return
	 *
	 * @deprecated pouzi WriteTagToolsForCore.getCustomPageNull(includeFileName,request);
	 */
	@Deprecated
	public static String getCustomPageNull(String includeFileName, HttpServletRequest request)
	{
<span class="fc" id="L321">		return WriteTagToolsForCore.getCustomPageNull(includeFileName,request);</span>

	}

	/**
	 * Vrati cestu k custom page pre Admin cast, alebo null, ak neexistuje ziadna
	 * @param pageURL
	 * @param request
	 * @return
	 *
	 * @deprecated pouzi WriteTagToolsForCore.getCustomPageAdmin(pageURL,request);
	 */
	@Deprecated
	public static String getCustomPageAdmin(String pageURL, HttpServletRequest request)
	{
<span class="fc" id="L336">		return WriteTagToolsForCore.getCustomPageAdmin(pageURL,request);</span>
	}

	/**
	 * Vrati cestu k custom verzii stranky, ak neexistuje vrati povodnu pageURL
	 * @param pageURL
	 * @param request
	 * @return
	 */
	public static String getCustomPageAdminNotNull(String pageURL, HttpServletRequest request)
	{
<span class="fc" id="L347">		String customPath = WriteTagToolsForCore.getCustomPageAdmin(pageURL, request);</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">		if (customPath != null) return customPath;</span>

<span class="fc" id="L350">		return pageURL;</span>
	}

	public static void writeText(String text, PageContext pageContext, String name) throws Exception
	{
<span class="fc" id="L355">		DebugTimer dt = new DebugTimer(&quot;WriteTag&quot;);</span>
<span class="fc" id="L356">		StringBuilder buff = new StringBuilder(text);</span>

<span class="pc bpc" id="L358" title="1 of 2 branches missed.">		if (Constants.getBoolean(&quot;editorEnableXHTML&quot;))</span>
		{
<span class="fc" id="L360">			pageContext.setAttribute(Globals.XHTML_KEY, &quot;true&quot;, PageContext.PAGE_SCOPE);</span>
		}

<span class="fc" id="L363">		HttpServletRequest request = (HttpServletRequest) pageContext.getRequest();</span>
<span class="fc" id="L364">		HttpServletResponse response = (HttpServletResponse) pageContext.getResponse();</span>

<span class="fc" id="L366">		boolean writePerfStat = false;</span>
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">		if (&quot;true&quot;.equals(request.getParameter(&quot;_writePerfStat&quot;))) writePerfStat = true;</span>
<span class="fc" id="L368">		boolean disableCache = false;</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">		if (&quot;true&quot;.equals(request.getParameter(&quot;_disableCache&quot;))) disableCache = true;</span>

<span class="fc" id="L371">		buff = WriteTagToolsForCore.fixXhtml(buff, request);</span>
<span class="fc" id="L372">		buff = WriteTagToolsForCore.preventSpam(buff, request);</span>
<span class="fc" id="L373">		buff = WriteTagToolsForCore.secureFormmail(buff, request);</span>

<span class="fc" id="L375">		BrowserDetector browser = BrowserDetector.getInstance(request);</span>
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">		if (browser.isAmp()) {</span>
<span class="nc" id="L377">			Amp amp = new Amp(request);</span>
<span class="nc" id="L378">			buff = new StringBuilder(amp.replaceInString(buff.toString()));</span>
		}

		//Logger.println(this,&quot;BUFF SIZE=&quot;+ response.getBufferSize());
		//Logger.println(this,&quot;BUFF SIZE JSP=&quot;+ pageContext.getOut().getBufferSize());


		/*WJResponseWrapper respWrapper = new WJResponseWrapper(response);

      pageContext.getOut().write(&quot;ahoj&quot;);

      //pageContext.include(&quot;/components/sopk/meniny.jsp&quot;);
      request.getRequestDispatcher(&quot;/components/sopk/redir.jsp&quot;).include(request, respWrapper);

      if (respWrapper.redirectURL!=null)
      {
      	response.sendRedirect(respWrapper.redirectURL);
      	return;
      }

      pageContext.getOut().write(respWrapper.strWriter.getBuffer().toString());

      //response.sendRedirect(&quot;http://www.interway.sk&quot;);
      //response.sendRedirect(&quot;http://www.sme.sk&quot;);
      Logger.println(this,&quot;redirected 5&quot;);
      if (1==1) return;*/

<span class="fc" id="L405">		HttpSession session = request.getSession();</span>
<span class="fc" id="L406">		Identity user = null;</span>
		try
		{
			//ziskaj meno lognuteho usera
<span class="fc bfc" id="L410" title="All 2 branches covered.">			if (session.getAttribute(Constants.USER_KEY) != null)</span>
			{
<span class="fc" id="L412">				user = (Identity) session.getAttribute(Constants.USER_KEY);</span>
			}
		}
<span class="nc" id="L415">		catch (Exception ex)</span>
		{
<span class="nc" id="L417">			Logger.error(WriteTag.class, ex);</span>
<span class="fc" id="L418">		}</span>

<span class="fc" id="L420">		StringBuilder content = new StringBuilder();</span>
<span class="fc" id="L421">		Prop prop = Prop.getInstance(request);</span>
<span class="fc" id="L422">		String lng = PageLng.getUserLng(request);</span>

		try
		{
			//text = new String(text.getBytes(), &quot;iso-8859-1&quot;);
<span class="fc" id="L427">			int docId = -1;</span>
			try
			{
<span class="fc bfc" id="L430" title="All 2 branches covered.">				if (Tools.isNotEmpty(request.getParameter(&quot;docid&quot;)))</span>
				{
<span class="fc" id="L432">					docId = Integer.parseInt(Tools.getParameter(request, &quot;docid&quot;));</span>
				}
				else
				{
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">					if (request.getAttribute(&quot;docid&quot;)!=null)</span>
					{
<span class="nc" id="L438">						docId = Integer.parseInt((String)request.getAttribute(&quot;docid&quot;));</span>
					}
				}
			}
<span class="nc" id="L442">			catch (Exception ex)</span>
			{
<span class="nc" id="L444">				Logger.error(WriteTag.class, ex);</span>
<span class="fc" id="L445">			}</span>
<span class="fc" id="L446">			buff = DocTools.updateCodes(user, buff, docId, request, pageContext.getServletContext());</span>
		}
<span class="nc" id="L448">		catch (Exception ex2)</span>
		{
<span class="nc" id="L450">			Logger.error(WriteTag.class, ex2);</span>
<span class="fc" id="L451">		}</span>

		//Logger.println(this,&quot;----&gt; QUERY WRITE TAG: &quot; + request.getQueryString());

<span class="fc" id="L455">		Cache c = Cache.getInstance();</span>

		//skus zistit ci tam je nejaky include
<span class="fc bfc" id="L458" title="All 2 branches covered.">		if (buff.indexOf(INCLUDE_START)!=-1)</span>
		{
			try
			{
<span class="fc" id="L462">				int startIndex = buff.indexOf(INCLUDE_START);</span>
				int includeEndIndex;
<span class="fc" id="L464">				String includeFileName = &quot;&quot;;</span>
<span class="fc" id="L465">				String includeText = &quot;&quot;;</span>
				String pageParams;
				int commaIndex;
<span class="fc" id="L468">				int failsafe = 0;</span>
<span class="fc" id="L469">				int cacheTime = 0;</span>
<span class="fc" id="L470">				String cacheKey = null;</span>
<span class="pc bpc" id="L471" title="1 of 4 branches missed.">				while (startIndex != -1 &amp;&amp; failsafe &lt; 100)</span>
				{
<span class="fc" id="L473">					failsafe++;</span>
					try
					{
						//zapis zaciatocny text
<span class="fc" id="L477">						includeEndIndex = buff.indexOf(INCLUDE_END, startIndex);</span>

<span class="pc bpc" id="L479" title="1 of 2 branches missed.">						if (includeEndIndex &lt; 0)</span>
						{
							//nenasiel sa koniec
<span class="nc" id="L482">							content.append(buff.substring(0, startIndex+INCLUDE_START.length()));</span>
<span class="nc" id="L483">							buff.delete(0,startIndex+INCLUDE_START.length());</span>
<span class="nc" id="L484">							startIndex = buff.indexOf(INCLUDE_START);</span>
<span class="nc" id="L485">							continue;</span>
						}

<span class="fc" id="L488">						includeText = buff.substring(startIndex, includeEndIndex);</span>
<span class="fc" id="L489">						cacheTime = 0;</span>
<span class="fc" id="L490">						cacheKey = &quot;writeTag_&quot;+includeText;</span>
						//aby sa dala spravit page dependent cache
						//lng - aby sa neprekryvali verzie v roznych jazykoch
<span class="fc" id="L493">						cacheKey = Tools.replace(cacheKey, &quot;!DOC_ID!&quot;, request.getParameter(&quot;docid&quot;)) + &quot; ;&quot;+lng;</span>


<span class="fc" id="L496">						StopWatch executionTimeStopWatch = new StopWatch();</span>
<span class="fc" id="L497">						executionTimeStopWatch.start();</span>
<span class="fc" id="L498">						MemoryMeasurement memoryConsumed = new MemoryMeasurement();</span>

						try
						{
<span class="fc bfc" id="L502" title="All 2 branches covered.">							if (disableCache==false)</span>
							{
<span class="fc" id="L504">								int cacheTimePos = includeText.indexOf(&quot;cacheMinutes=&quot;);</span>

								//news komponenta nemoze cachovat ak ma parameter page
<span class="pc bpc" id="L507" title="3 of 8 branches missed.">								if (cacheTimePos!=-1 &amp;&amp; includeText.indexOf(&quot;/news/news&quot;)!=-1 &amp;&amp; (request.getParameter(&quot;page&quot;)!=null &amp;&amp; &quot;1&quot;.equals(request.getParameter(&quot;page&quot;))==false))</span>
								{
<span class="nc" id="L509">									cacheTimePos = -1;</span>
								}

<span class="fc bfc" id="L512" title="All 2 branches covered.">								if (cacheTimePos != -1)</span>
								{
<span class="fc" id="L514">									StringTokenizer st = new StringTokenizer(includeText.substring(cacheTimePos+13), &quot; ,)&quot;);</span>
<span class="pc bpc" id="L515" title="1 of 2 branches missed.">									if (st.hasMoreTokens())</span>
									{
<span class="fc" id="L517">										cacheTime = Tools.getIntValue(Tools.replace(st.nextToken(), &quot;&amp;quot;&quot;, &quot;&quot;), 0);</span>
									}

									//vybereme z cache, adminom ale zobrazujeme priamo (a dole spravime refresh cache)
<span class="pc bpc" id="L521" title="3 of 8 branches missed.">									if (cacheTime &gt; 0 &amp;&amp; (user==null || user.isAdmin()==false || Constants.getBoolean(&quot;cacheStaticContentForAdmin&quot;)==true))</span>
									{
										//skus ziskat z cache
<span class="nc" id="L524">										String htmlCode = (String)c.getObject(cacheKey);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">										if (htmlCode == null)</span>
										{
											//nastav do cache nieco, aby ostatne thready nespustili lavinu
<span class="nc" id="L528">											c.setObjectSeconds(cacheKey, &quot;&lt;!-- caching data, try reload --&gt;&quot;, 120, false);</span>
										}
<span class="nc bnc" id="L530" title="All 2 branches missed.">										if (Tools.isNotEmpty(htmlCode))</span>
										{
<span class="nc" id="L532">											Logger.debug(WriteTag.class, &quot;Serving from cache: &quot;+cacheKey);</span>
											//vypiseme vysledok z cache
<span class="nc bnc" id="L534" title="All 2 branches missed.">											if (startIndex &gt; 0)</span>
											{
<span class="nc" id="L536">												content.append(buff.substring(0, startIndex));</span>
											}
<span class="nc" id="L538">											content.append(htmlCode);</span>
<span class="nc" id="L539">											buff.delete(0,includeEndIndex + INCLUDE_END.length());</span>
<span class="nc" id="L540">											startIndex = buff.indexOf(INCLUDE_START);</span>

<span class="nc bnc" id="L542" title="All 2 branches missed.">											if (writePerfStat)</span>
											{
<span class="nc" id="L544">												long diff = dt.getDiff();</span>
<span class="nc" id="L545">												long lastDiff = dt.getLastDiff();</span>
<span class="nc" id="L546">												String logText = &quot;PerfStat: &quot; + diff + &quot; ms (+&quot;+lastDiff+&quot;) &quot; + includeText+&quot;\n&quot;;</span>
<span class="nc" id="L547">												content.append('\n').append(logText);</span>
<span class="nc" id="L548">												Logger.debug(WriteTag.class, logText);</span>
											}

<span class="nc" id="L551">											executionTimeStopWatch.stop();</span>
<span class="nc" id="L552">											ExecutionTimeMonitor.recordComponentExecutionFromCache(cacheKey, executionTimeStopWatch.getTime());</span>
<span class="nc" id="L553">											continue;</span>
										}

<span class="nc" id="L556">										request.setAttribute(BuffTag.IS_BUFF_TAG, &quot;true&quot;);</span>
									}
								}
							}
						}
<span class="nc" id="L561">						catch (Exception e)</span>
						{
<span class="nc" id="L563">							Logger.error(WriteTag.class, e);</span>
<span class="fc" id="L564">						}</span>

<span class="fc" id="L566">						content.append(WriteTagToolsForCore.replaceWriteText(new StringBuilder(buff.substring(0, startIndex)), request));</span>

						//ziskaj data

<span class="fc" id="L570">						includeFileName = buff.substring(startIndex + INCLUDE_START.length(), includeEndIndex);</span>
<span class="fc" id="L571">						includeFileName = Tools.replace(includeFileName, &quot;%20&quot;, &quot; &quot;);</span>
<span class="fc" id="L572">						includeFileName = Tools.replace(includeFileName, &quot;\n&quot;, &quot;&quot;);</span>
<span class="fc" id="L573">						includeFileName = Tools.replace(includeFileName, &quot;\r&quot;, &quot;&quot;);</span>
<span class="fc" id="L574">						commaIndex = includeFileName.indexOf(',');</span>
<span class="fc bfc" id="L575" title="All 2 branches covered.">						if (commaIndex != -1)</span>
						{
<span class="fc" id="L577">							pageParams = includeFileName.substring(commaIndex + 1);</span>
<span class="fc" id="L578">							includeFileName =includeFileName.substring(0, commaIndex);</span>
						}
						else
						{
<span class="fc" id="L582">							pageParams = &quot;&quot;;</span>
						}

<span class="fc" id="L585">						includeFileName = includeFileName.trim();</span>
<span class="fc" id="L586">						pageParams = pageParams.trim();</span>

<span class="fc" id="L588">						pageContext.getRequest().removeAttribute(PAGE_PARAMS);</span>
<span class="fc" id="L589">						pageContext.getRequest().setAttribute(PAGE_PARAMS,  pageParams);</span>
						//zisti ci ten include existuje
<span class="fc" id="L591">						includeFileName = WriteTagToolsForCore.getCustomPage(includeFileName, request);</span>


<span class="fc" id="L594">						boolean canInclude = false;</span>
<span class="fc" id="L595">						boolean isSpringComponent = false;</span>
<span class="fc" id="L596">						ApplicationContext applicationContext = SpringContext.getApplicationContext();</span>
<span class="fc bfc" id="L597" title="All 2 branches covered.">						if (applicationContext.containsBean(includeFileName)) {</span>
<span class="fc" id="L598">							canInclude = true;</span>
<span class="fc" id="L599">							isSpringComponent = true;</span>
						}
<span class="pc bpc" id="L601" title="5 of 6 branches missed.">						else if(includeFileName.startsWith(&quot;/components&quot;) || includeFileName.startsWith(&quot;/apps&quot;) || includeFileName.startsWith(&quot;/templates&quot;))</span>
						{
<span class="fc" id="L603">							canInclude = true;</span>
						}
<span class="nc bnc" id="L605" title="All 2 branches missed.">						else if (includeFileName.startsWith(&quot;/maillist.do&quot;))</span>
						{
<span class="nc" id="L607">							canInclude = true;</span>
						}
						else
						{
<span class="nc" id="L611">							Logger.debug(WriteTag.class, &quot;attempt to include non component file: &quot; + includeFileName + &quot;, include denied&quot;);</span>
						}

						//Only if banner can be included
<span class="fc" id="L615">						boolean checkDeviceType = true;</span>
<span class="fc" id="L616">						final String deviceParam = &quot;device=&quot;;</span>
						//In preview mode it does not matter what type of device we use (we want see all banners)
<span class="fc bfc" id="L618" title="All 2 branches covered.">						if (request.getAttribute(&quot;inPreviewMode&quot;)!=null) checkDeviceType = false;</span>

						/** Check if this app can be included in current device type **/
<span class="pc bpc" id="L621" title="1 of 6 branches missed.">						if(canInclude &amp;&amp; checkDeviceType &amp;&amp; includeText.contains(deviceParam)) {</span>
<span class="fc" id="L622">							final String regex = &quot;([^\&quot;;, ]*)&quot;;</span>
<span class="fc" id="L623">							Pattern pattern = Pattern.compile(deviceParam + regex);</span>
<span class="fc" id="L624">							Matcher matcher = pattern.matcher(Tools.replace(includeText, &quot;&amp;quot;&quot;, &quot;&quot;));</span>

							//Is deviceParam presented in include ? -&gt; NO, then do nothing
<span class="pc bpc" id="L627" title="1 of 2 branches missed.">							if(matcher.find()) {</span>
<span class="fc" id="L628">								String devicesString = matcher.group(1);</span>
								//Does deviceParam contain any value ? -&gt; NO, then do nothing
<span class="pc bpc" id="L630" title="1 of 2 branches missed.">								if(Tools.isNotEmpty(devicesString)) {</span>
									//Devices values are separated by &quot;+&quot;
<span class="fc" id="L632">									StringTokenizer devices = new StringTokenizer(devicesString, &quot;+&quot;);</span>

									//So there is set device type limitation, set canInclude to false, until we verify that actual device is right type (supported device type)
<span class="pc bpc" id="L635" title="1 of 2 branches missed.">									if(devices.hasMoreTokens()) canInclude = false;</span>

									//Loop all suported device types and check if actual device has right type
<span class="fc bfc" id="L638" title="All 2 branches covered.">									while(devices.hasMoreTokens()) {</span>
<span class="fc" id="L639">										String device = Tools.getStringValue(devices.nextToken(), &quot;&quot;);</span>

<span class="fc bfc" id="L641" title="All 4 branches covered.">										if(&quot;phone&quot;.equals(device) &amp;&amp; browser.isPhone()) {</span>
<span class="fc" id="L642">											canInclude = true;</span>
<span class="fc" id="L643">											break;</span>
<span class="fc bfc" id="L644" title="All 4 branches covered.">										} else if(&quot;tablet&quot;.equals(device) &amp;&amp; browser.isTablet()) {</span>
<span class="fc" id="L645">											canInclude = true;</span>
<span class="fc" id="L646">											break;</span>
<span class="fc bfc" id="L647" title="All 4 branches covered.">										} else if(&quot;pc&quot;.equals(device) &amp;&amp; browser.isDesktop()) {</span>
<span class="fc" id="L648">											canInclude = true;</span>
<span class="fc" id="L649">											break;</span>
										}
<span class="fc" id="L651">									}</span>
								}
							}
						}

<span class="fc" id="L656">						buff.delete(0,includeEndIndex + INCLUDE_END.length());</span>

<span class="fc bfc" id="L658" title="All 2 branches covered.">						if(canInclude)</span>
						{
<span class="fc" id="L660">							Logger.debug(WriteTag.class, &quot;INCLUDING: &quot;+includeFileName);</span>
							//Logger.println(this,&quot;includeFileName=&quot;+includeFileName);
<span class="pc bpc" id="L662" title="3 of 10 branches missed.">							if (WriteTagToolsForCore.isFileExists(includeFileName) || includeFileName.endsWith(&quot;.do&quot;) || includeFileName.indexOf(&quot;.do?&quot;)!=-1 || includeFileName.endsWith(&quot;.action&quot;) || isSpringComponent)</span>
							{
<span class="fc" id="L664">								preserveParametersSet(includeFileName, request);</span>

<span class="pc bpc" id="L666" title="3 of 8 branches missed.">								if (request.getAttribute(&quot;writeTagDisableCodeFix&quot;)==null &amp;&amp; Constants.getBoolean(&quot;disableWJResponseWrapper&quot;)==false &amp;&amp; (request.getAttribute(BuffTag.IS_BUFF_TAG)!=null || Constants.getBoolean(&quot;editorEnableXHTML&quot;)))</span>
								{
									//respWrapper.setBufferSize(response.getBufferSize());
									//FakeHttpServletResponse respWrapper = new FakeHttpServletResponse(response);

									//inline toolbar append
<span class="fc" id="L672">									StringBuilder inlineEditingStart = null;</span>
<span class="fc" id="L673">									boolean inlineEditingAppendEndDiv = false;</span>
<span class="fc" id="L674">									request.removeAttribute(INLINE_EDITING_BUTTONS_KEY);</span>
									//request.removeAttribute(INLINE_EDITING_BUTTONS_TOP_KEY); - toto je globalne pre cely request
<span class="fc" id="L676">									request.removeAttribute(INLINE_EDITING_MODULE_PROPS_DISABLE_KEY);</span>
<span class="fc" id="L677">									request.removeAttribute(INLINE_EDITING_MODULE_PROPS_TEXT_KEY);</span>
<span class="fc" id="L678">									request.removeAttribute(INLINE_EDITING_MODULE_PROPS_ICON);</span>
<span class="fc" id="L679">									request.removeAttribute(&quot;isInlineEditing&quot;);</span>
<span class="fc" id="L680">									int inlineDocId = -1;</span>
<span class="fc" id="L681">									boolean isInlineEditing = false;</span>
<span class="pc bpc" id="L682" title="1 of 2 branches missed.">									if (Constants.getBoolean(&quot;inlineEditingEnabled&quot;))</span>
									{
<span class="nc bnc" id="L684" title="All 8 branches missed.">										if (request.getHeader(&quot;dmail&quot;) == null &amp;&amp; request.getParameter(&quot;NO_WJTOOLBAR&quot;) == null &amp;&amp; request.getParameter(&quot;isDmail&quot;) == null &amp;&amp; request.getAttribute(&quot;isPreview&quot;) == null)</span>
										{
<span class="nc bnc" id="L686" title="All 4 branches missed.">											if (&quot;doc_data&quot;.equals(name) || request.getAttribute(name + &quot;-docId=&quot;) != null)</span>
											{
<span class="nc bnc" id="L688" title="All 4 branches missed.">												if (user != null &amp;&amp; user.isAdmin())</span>
												{
<span class="nc" id="L690">													inlineDocId = DocTools.getRequestNameDocId(name, request);</span>
<span class="nc" id="L691">													request.setAttribute(&quot;isInlineEditing&quot;, &quot;true&quot;);</span>
<span class="nc" id="L692">													isInlineEditing = true;</span>
												}
											}
										}
									}

<span class="fc" id="L698">									StringBuilder htmlCode = null;</span>
<span class="pc bpc" id="L699" title="1 of 4 branches missed.">									if (applicationContext != null &amp;&amp; applicationContext.containsBean(includeFileName)) {</span>
<span class="fc" id="L700">										WebjetComponentParser webjetComponentParser = applicationContext.getBean(&quot;webjetComponentParser&quot;, WebjetComponentParser.class);</span>
<span class="pc bpc" id="L701" title="1 of 2 branches missed.">										if (webjetComponentParser != null) {</span>
<span class="fc" id="L702">											htmlCode = new StringBuilder(webjetComponentParser.parse(request, response, text));</span>
										}
									}

<span class="fc bfc" id="L706" title="All 2 branches covered.">									if (htmlCode == null) {</span>
<span class="fc" id="L707">										WJResponseWrapper respWrapper = new WJResponseWrapper(response,request);</span>
<span class="fc" id="L708">										request.getRequestDispatcher(includeFileName).include(request, respWrapper);</span>
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">										if (respWrapper.redirectURL != null) {</span>
<span class="nc" id="L710">											response.sendRedirect(respWrapper.redirectURL);</span>
<span class="nc" id="L711">											return;</span>
										}

<span class="fc" id="L714">										htmlCode = new StringBuilder(respWrapper.strWriter.getBuffer().toString());</span>
									}

<span class="fc" id="L717">									htmlCode = WriteTagToolsForCore.fixXhtml(htmlCode, request);</span>
<span class="fc" id="L718">									htmlCode = WriteTagToolsForCore.preventSpam(htmlCode, request);</span>
<span class="fc" id="L719">									htmlCode = WriteTagToolsForCore.secureFormmail(htmlCode, request);</span>
<span class="fc" id="L720">									htmlCode = WriteTagToolsForCore.replaceWriteText(htmlCode, request);</span>
<span class="fc" id="L721">									executionTimeStopWatch.stop();</span>
<span class="fc" id="L722">									ExecutionTimeMonitor.recordComponentExecution(cacheKey, executionTimeStopWatch.getTime(), memoryConsumed.diff());</span>

<span class="pc bpc" id="L724" title="3 of 4 branches missed.">									if (isInlineEditing &amp;&amp; isInlinePageEditable(user, inlineDocId, request))</span>
									{
<span class="nc" id="L726">										inlineEditingStart = getInlineEditingStart(includeFileName, includeText, user, inlineDocId, request, prop);</span>
									}

<span class="pc bpc" id="L729" title="1 of 2 branches missed.">									if (inlineEditingStart!=null)</span>
									{
										//ak nenastalo volanie hideInlineComponentEditButton
<span class="nc bnc" id="L732" title="All 2 branches missed.">										if (isInlineComponentEditButton(request))</span>
										{
<span class="nc" id="L734">											appendInlineEditingScript(pageContext, request);</span>

<span class="nc" id="L736">											StringBuilder inlineEditingButtons = (StringBuilder)request.getAttribute(INLINE_EDITING_BUTTONS_KEY);</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">											if (inlineEditingButtons != null)</span>
											{
<span class="nc" id="L739">												inlineEditingStart = Tools.replace(inlineEditingStart, &quot;{inlineEditingButtons}&quot;, inlineEditingButtons.toString());</span>
											}
											else
											{
<span class="nc" id="L743">												inlineEditingStart = Tools.replace(inlineEditingStart, &quot;{inlineEditingButtons}&quot;, &quot;&quot;);</span>
											}

<span class="nc bnc" id="L746" title="All 2 branches missed.">											if (htmlCode.indexOf(INLINE_EDITING_PLACEHOLDER)==-1)</span>
											{
<span class="nc" id="L748">												content.append(inlineEditingStart);</span>
<span class="nc" id="L749">												inlineEditingAppendEndDiv = true;</span>
											}
											else
											{
<span class="nc" id="L753">												htmlCode = Tools.replace(htmlCode, INLINE_EDITING_PLACEHOLDER, inlineEditingStart.append(&quot;&lt;/div&gt;&quot;).toString());</span>
											}

										}
									}

<span class="fc" id="L759">									StringBuilder buttonsTop = (StringBuilder)request.getAttribute(INLINE_EDITING_BUTTONS_TOP_KEY);</span>
<span class="pc bpc" id="L760" title="5 of 6 branches missed.">									if (isInlineEditing &amp;&amp; buttonsTop != null &amp;&amp; buttonsTop.length()&gt;0)</span>
									{
<span class="nc" id="L762">										appendInlineEditingScript(pageContext, request);</span>

<span class="nc" id="L764">										String buttonsTopString = buttonsTop.toString();</span>
<span class="nc bnc" id="L765" title="All 2 branches missed.">										if (buttonsTopString.indexOf(&quot;{inlineComponentEdit}&quot;)!=-1)</span>
										{
											//ak sme toto nespravili nenaslo nam to nizsie getInlineEditorComponent
<span class="nc" id="L768">											request.removeAttribute(INLINE_EDITING_MODULE_PROPS_DISABLE_KEY);</span>

<span class="nc" id="L770">											StringBuilder href = new StringBuilder();</span>
<span class="nc" id="L771">											href.append(&quot;javascript:inlineComponentEdit('&quot;).append(includeFileName).append(&quot;', '&quot;).append(JSEscapeTag.jsEscape(pageParams)).append(&quot;', &quot;);</span>
<span class="nc" id="L772">											href.append(&quot; '&quot;).append(JSEscapeTag.jsEscape(includeText)).append(&quot;', &quot;);</span>
<span class="nc" id="L773">											href.append(&quot; '&quot;).append(JSEscapeTag.jsEscape(getInlineEditorComponent(includeFileName, request))).append(&quot;', &quot;);</span>
<span class="nc" id="L774">											href.append(inlineDocId);</span>
<span class="nc" id="L775">											href.append(&quot;)&quot;);</span>

<span class="nc" id="L777">											buttonsTopString = Tools.replace(buttonsTopString, &quot;{inlineComponentEdit}&quot;, href.toString());</span>
										}

<span class="nc" id="L780">										content.append(&quot;&lt;div class=\&quot;inlineComponentEditButtonsTop\&quot;&gt;&quot;).append(buttonsTopString).append(&quot;&lt;/div&gt;&quot;);</span>

<span class="nc" id="L782">										request.removeAttribute(INLINE_EDITING_BUTTONS_TOP_KEY);</span>
									}

<span class="fc" id="L785">									content.append(htmlCode);</span>

<span class="pc bpc" id="L787" title="1 of 2 branches missed.">									if (inlineEditingAppendEndDiv) content.append(&quot;&lt;/div&gt;&quot;);</span>

<span class="fc bfc" id="L789" title="All 2 branches covered.">									if (cacheTime &gt; 0)</span>
									{
<span class="fc" id="L791">										Logger.debug(WriteTag.class, &quot;Setting to cache: &quot;+cacheKey);</span>
<span class="fc" id="L792">										c.setObjectSeconds(cacheKey, htmlCode.toString(), cacheTime*60, true);</span>
									}

<span class="fc" id="L795">									preserveParametersRemove(includeFileName, request);</span>
<span class="fc" id="L796">								}</span>
								else
								{
<span class="nc" id="L799">									pageContext.include(includeFileName);</span>
								}
							}
							else
							{
								//subor neexistuje
<span class="fc" id="L805">								content.append(getErrorMessage(prop, &quot;writetag.error_not_exists&quot;, includeFileName));</span>
							}
						}
					}
<span class="nc" id="L809">					catch (SourcePageNotFoundException ex1) {</span>
						//toto nas nezaujima, pravdepodobne to je len search bot
<span class="nc" id="L811">						Logger.error(WriteTag.class, &quot;WRITE TAG INCLUDE ERROR: &quot; + ex1.getMessage());</span>
<span class="nc" id="L812">						content.append(getErrorMessage(prop, &quot;writetag.error&quot;, includeFileName));</span>
					}
<span class="nc" id="L814">					catch (Exception ex1)</span>
					{
<span class="nc" id="L816">						Logger.error(WriteTag.class,&quot;WRITE TAG INCLUDE ERROR: &quot; + ex1.getMessage());</span>

<span class="nc" id="L818">						StringWriter sw = new StringWriter();</span>
<span class="nc" id="L819">						ex1.printStackTrace(new PrintWriter(sw));</span>

<span class="nc" id="L821">						String stack = sw.toString();</span>

<span class="nc bnc" id="L823" title="All 6 branches missed.">						if (stack != null &amp;&amp; stack.contains(&quot;Unabled to prepare ActionBean for JSP Usage&quot;)==false &amp;&amp; stack.contains(&quot;_404_jsp&quot;)==false)</span>
						{
<span class="nc" id="L825">							Logger.error(WriteTag.class, ex1);</span>
<span class="nc" id="L826">							content.append(getErrorMessage(prop, &quot;writetag.error&quot;, includeFileName));</span>

<span class="nc bnc" id="L828" title="All 8 branches missed.">							if (user != null &amp;&amp; user.isAdmin() &amp;&amp; user.isEnabledItem(&quot;cmp_adminlog&quot;) &amp;&amp; request.getAttribute(&quot;writeTagDontShowError&quot;) == null)</span>
							{
<span class="nc" id="L830">								content.append(&quot;&lt;div style='border:2px solid red; background-color: white; color: black; margin: 5px; white-space: pre;'&gt;&quot; + ResponseUtils.filter(ex1.getMessage()) + &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L831">								String stackTrace = ResponseUtils.filter(stack);</span>
<span class="nc" id="L832">								content.append(stackTrace + &quot;&lt;/div&gt;&quot;);</span>
							}

<span class="nc" id="L835">							Adminlog.add(Adminlog.TYPE_JSPERROR, &quot;ERROR: &quot; + includeFileName + &quot;\n\n&quot; + ex1.getMessage() + &quot;\n\n&quot; + sw.toString(), -1, -1);</span>
							//break;
						}
<span class="pc" id="L838">					}</span>

<span class="pc bpc" id="L840" title="1 of 2 branches missed.">					if (request.getAttribute(SKIP_BODY)!=null)</span>
					{
						//uz neincludujeme vysledok dalej
<span class="nc" id="L843">						buff = new StringBuilder();</span>
<span class="nc" id="L844">						request.removeAttribute(SKIP_BODY);</span>
					}

<span class="fc" id="L847">					startIndex = buff.indexOf(INCLUDE_START);</span>

					//dt.diff(includeText);
<span class="pc bpc" id="L850" title="1 of 2 branches missed.">					if (writePerfStat)</span>
					{
<span class="nc" id="L852">						long diff = dt.getDiff();</span>
<span class="nc" id="L853">						long lastDiff = dt.getLastDiff();</span>
<span class="nc" id="L854">						String logText = &quot;PerfStat: &quot; + diff + &quot; ms (+&quot;+lastDiff+&quot;) &quot; + includeText+&quot;\n&quot;;</span>
<span class="nc" id="L855">						content.append('\n').append(logText);</span>
<span class="nc" id="L856">						Logger.debug(WriteTag.class, logText);</span>
<span class="nc" id="L857">					}</span>
				}

<span class="fc" id="L860">				content.append(WriteTagToolsForCore.replaceWriteText(buff, request));</span>
			}
<span class="nc" id="L862">			catch (Exception ex)</span>
			{
<span class="nc" id="L864">				Logger.error(WriteTag.class, ex);</span>
				//nieco sa nam potototo...
<span class="nc" id="L866">				content.append(buff.toString());</span>
<span class="pc" id="L867">			}</span>
		}
		else
		{
<span class="fc" id="L871">			content.append(WriteTagToolsForCore.replaceWriteText(buff, request));</span>
		}

		try
		{
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L877">			List&lt;String&gt; afterWriteIncludeFile = (List&lt;String&gt;)request.getAttribute(AFTER_WRITE_INCLUDE_LIST);</span>
<span class="pc bpc" id="L878" title="1 of 2 branches missed.">			if (afterWriteIncludeFile!=null)</span>
			{
<span class="nc bnc" id="L880" title="All 2 branches missed.">				for (String includeFileName : afterWriteIncludeFile)</span>
				{
<span class="nc" id="L882">					pageContext.include(includeFileName);</span>
<span class="nc" id="L883">				}</span>
<span class="nc" id="L884">				request.removeAttribute(AFTER_WRITE_INCLUDE_LIST);</span>
			}
		}
<span class="nc" id="L887">		catch (RuntimeException ex1)</span>
		{
<span class="nc" id="L889">			sk.iway.iwcm.Logger.error(ex1);</span>
<span class="fc" id="L890">		}</span>

<span class="fc" id="L892">		String html = content.toString();</span>

		//replace cloud keys with texts in corresponding language, ticket 15053
<span class="pc bpc" id="L895" title="7 of 8 branches missed.">		if(Constants.getString(&quot;installName&quot;).equals(&quot;cloud&quot;) &amp;&amp; InitServlet.isTypeCloud()==false &amp;&amp; (DocDB.getDomain(request).indexOf(&quot;template&quot;)!=-1 || request.getParameter(&quot;forceLng&quot;)!=null))</span>
		{
			//preklad pri zobrazeni sa vykonava len pre manager node
<span class="nc" id="L898">			Logger.debug(WriteTag.class, &quot;cloud manager, translating texts.., lng=&quot;+lng);</span>
<span class="nc" id="L899">			html = CloudToolsForCore.translate(lng, html);</span>
		}

<span class="fc" id="L902">		pageContext.getOut().write(html);</span>
<span class="fc" id="L903">	}</span>

	/**
	 * Prida do zoznamu subor, ktory sa includne po vykonani tohto write
	 * (ak nemoze byt includnuty kdekolvek do textu toho write)
	 * @param file - url suboru pre include (napr. /component/nieco/subor.jsp)
	 */
	public static void addAfterWriteInclude(String file, HttpServletRequest request)
	{
		@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L913">		List&lt;String&gt; afterWriteIncludeFile = (List&lt;String&gt;)request.getAttribute(AFTER_WRITE_INCLUDE_LIST);</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">		if (afterWriteIncludeFile==null)</span>
		{
<span class="nc" id="L916">			afterWriteIncludeFile = new ArrayList&lt;&gt;();</span>
		}
<span class="nc bnc" id="L918" title="All 2 branches missed.">		for (String includeFileName : afterWriteIncludeFile)</span>
		{
<span class="nc bnc" id="L920" title="All 2 branches missed.">			if (file.equals(includeFileName))</span>
			{
				//uz je to tam pridane, preskakujem
<span class="nc" id="L923">				return;</span>
			}
<span class="nc" id="L925">		}</span>
<span class="nc" id="L926">		afterWriteIncludeFile.add(file);</span>
<span class="nc" id="L927">		request.setAttribute(AFTER_WRITE_INCLUDE_LIST, afterWriteIncludeFile);</span>
<span class="nc" id="L928">	}</span>

	/**
	 * Vykona nahradenie znaciek !WRITE a !CALL v texte ktory sa vypisuje (napr. az po vykonani nejakeho include)
	 * @param text
	 * @param request
	 * @return
	 *
	 * @deprecated pouzi WriteTagToolsForCore.replaceWriteText(text,request);
	 */
	@Deprecated
	public static StringBuilder replaceWriteText(StringBuilder text, HttpServletRequest request)
	{
<span class="nc" id="L941">		return WriteTagToolsForCore.replaceWriteText(text,request);</span>
	}

	public static String getErrorMessage(Prop prop, String key, String fullPath)
	{
<span class="fc" id="L946">		String fileName = fullPath;</span>
		try
		{
<span class="fc" id="L949">			int i = fullPath.lastIndexOf('/');</span>
<span class="pc bpc" id="L950" title="1 of 2 branches missed.">			if (i&gt;0) fileName = fullPath.substring(i+1);</span>
		}
<span class="nc" id="L952">		catch (Exception e)</span>
		{
			//
<span class="fc" id="L955">		}</span>
<span class="fc" id="L956">		String fileNameUser = Tools.replace(fileName, &quot;.jsp&quot;, &quot;&quot;);</span>
<span class="fc" id="L957">		fileNameUser = Tools.replace(fileNameUser, &quot;_&quot;, &quot; &quot;);</span>
<span class="fc" id="L958">		fileNameUser = Tools.replace(fileNameUser, &quot;-&quot;, &quot; &quot;);</span>

<span class="fc" id="L960">		return prop.getText(key, fullPath, fileName, fileNameUser);</span>
	}

	/**
	 * @deprecated pouzi WriteTagToolsForCore.fixXhtml(text,request);
	 */
	@Deprecated
	public static StringBuilder fixXhtml(StringBuilder text, HttpServletRequest request)
	{
<span class="nc" id="L969">		return WriteTagToolsForCore.fixXhtml(text,request);</span>
	}

	/**
	 * @deprecated pouzi WriteTagToolsForCore.preventSpam(text,request);
	 */
	@Deprecated
	public static StringBuilder preventSpam(StringBuilder text, HttpServletRequest request)
	{
<span class="nc" id="L978">		return WriteTagToolsForCore.preventSpam(text,request);</span>
	}

	/**
	 * @deprecated pouzi WriteTagToolsForCore.encodeEmailAddress(email);
	 */
	@Deprecated
	public static String encodeEmailAddress(String email)
	{
<span class="nc" id="L987">		return WriteTagToolsForCore.encodeEmailAddress(email);</span>
	}

	public static String decodeEmailAddress(String email)
	{
<span class="pc bpc" id="L992" title="2 of 4 branches missed.">		if (email.indexOf('~')==-1 &amp;&amp; email.indexOf('!')==-1)</span>
		{
			//nie je zakodovane
<span class="fc" id="L995">			return(email);</span>
		}

<span class="nc" id="L998">		String returnEmail = email;</span>
<span class="nc" id="L999">		returnEmail = returnEmail.replace('~', '@');</span>
<span class="nc" id="L1000">		returnEmail = returnEmail.replace('!', '.');</span>

		//cele to pre istotu otoc
<span class="nc" id="L1003">		char[] newEmail = new char[returnEmail.length()];</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">		for (int i=0; i&lt;returnEmail.length(); i++)</span>
		{
<span class="nc" id="L1006">			newEmail[i] = returnEmail.charAt(returnEmail.length()-i-1);</span>
		}
<span class="nc" id="L1008">		returnEmail = new String(newEmail);</span>

<span class="nc" id="L1010">		return(returnEmail);</span>
	}

	/**
	 * Vlozi do stranky subor pre podporu inline editacia (primarne JavaScript kod)
	 * @param context
	 * @param request
	 * @throws Exception
	 */
	public static void appendInlineEditingScript(PageContext context, HttpServletRequest request) throws Exception
	{
<span class="nc" id="L1021">		String KEY = &quot;writeTag.inlineEditingScriptInserted&quot;;</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">		if (request.getAttribute(KEY)!=null) return;</span>

<span class="nc" id="L1024">		context.include( WriteTag.getCustomPageAdminNotNull(&quot;/admin/inline/inline_script.jsp&quot;, request));</span>

<span class="nc" id="L1026">		request.setAttribute(KEY, &quot;1&quot;);</span>
<span class="nc" id="L1027">	}</span>

	/**
	 * Pre zadanu cestu k JSP komponente najde jej verziu editor_component.jsp, alebo NULL ak neexistuje
	 * @param includeFileName
	 * @return
	 */
	@SuppressWarnings(&quot;java:S1075&quot;)
	private static String getInlineEditorComponent(String includeFileName, HttpServletRequest request)
	{
<span class="nc bnc" id="L1037" title="All 2 branches missed.">		if (isInlineComponentEditButton(request)==false) return null;</span>

<span class="nc" id="L1039">		String path = includeFileName.substring(0, includeFileName.lastIndexOf(&quot;/&quot;))+&quot;/editor_component.jsp&quot;;</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">		if (FileTools.isFile(path))</span>
		{
<span class="nc bnc" id="L1042" title="All 2 branches missed.">			if (ContextFilter.isRunning(request)) path = ContextFilter.addContextPath(request.getContextPath(), path);</span>
<span class="nc" id="L1043">			return path;</span>
		}

		//skus removnut installName
<span class="nc bnc" id="L1047" title="All 2 branches missed.">		if (path.indexOf(&quot;/&quot;+Constants.getInstallName()+&quot;/&quot;)!=-1)</span>
		{
<span class="nc" id="L1049">			path = Tools.replace(path, &quot;/&quot;+Constants.getInstallName()+&quot;/&quot;, &quot;/&quot;);</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">			if (FileTools.isFile(path))</span>
			{
<span class="nc bnc" id="L1052" title="All 2 branches missed.">				if (ContextFilter.isRunning(request)) path = ContextFilter.addContextPath(request.getContextPath(), path);</span>
<span class="nc" id="L1053">				return path;</span>
			}
		}

		//skus pridat installName
<span class="nc bnc" id="L1058" title="All 2 branches missed.">		if (path.indexOf(&quot;/&quot;+Constants.getInstallName()+&quot;/&quot;)==-1)</span>
		{
<span class="nc" id="L1060">			path = Tools.replace(path, &quot;/components/&quot;, &quot;/components/&quot;+Constants.getInstallName()+&quot;/&quot;);</span>
<span class="nc bnc" id="L1061" title="All 2 branches missed.">			if (FileTools.isFile(path))</span>
			{
<span class="nc bnc" id="L1063" title="All 2 branches missed.">				if (ContextFilter.isRunning(request)) path = ContextFilter.addContextPath(request.getContextPath(), path);</span>
<span class="nc" id="L1064">				return path;</span>
			}
		}

<span class="nc" id="L1068">		return null;</span>
	}

	/**
	 * Pomocna metoda pre cachovanie hodnoty EditorDB.isEditable
	 * @param user
	 * @param docId
	 * @param request
	 * @return
	 */
	public static boolean isInlinePageEditable(Identity user, int docId, HttpServletRequest request)
	{
<span class="pc bpc" id="L1080" title="2 of 4 branches missed.">		if (user == null || user.isAdmin()==false) return false;</span>

<span class="fc" id="L1082">		String KEY = &quot;writeTag.isInlinePageEditable-&quot;+docId;</span>
<span class="fc" id="L1083">		Boolean isEditable = (Boolean)request.getAttribute(KEY);</span>
<span class="pc bpc" id="L1084" title="1 of 2 branches missed.">		if (isEditable == null)</span>
		{
<span class="fc" id="L1086">			String path = PathFilter.getOrigPath(request);</span>

<span class="pc bpc" id="L1088" title="1 of 2 branches missed.">			if (DocTools.isXssStrictUrlException(path, &quot;inlineEditingDisabledUrls&quot;)) isEditable = Boolean.FALSE;</span>

<span class="pc bpc" id="L1090" title="1 of 2 branches missed.">			if (isEditable==null) isEditable = Boolean.valueOf(EditorDB.isPageEditable(user, docId));</span>

			//Logger.debug(WriteTag.class, &quot;isInlinePageEditable, docId=&quot;+docId+&quot; path=&quot;+path+&quot; exception=&quot;+ShowDocAction.isXssStrictUrlException(path, &quot;inlineEditingDisabledUrls&quot;)+&quot; isEditable=&quot;+isEditable);
<span class="fc" id="L1093">			request.setAttribute(KEY, isEditable);</span>
		}
<span class="fc" id="L1095">		return isEditable.booleanValue();</span>
	}

	/**
	 * Vrati HTML kod pre inline editaciu, alebo NULL ak pre danu komponentu inline editacia nie je podporovana
	 * @param includeFileName
	 * @param includeText
	 * @param user
	 * @param docId
	 * @param request
	 * @return
	 */
	public static StringBuilder getInlineEditingStart(String includeFileName, String includeText, Identity user, int docId, HttpServletRequest request, Prop prop)
	{
<span class="nc bnc" id="L1109" title="All 6 branches missed.">		if (Constants.getBoolean(&quot;inlineEditingEnabled&quot;)==false || user == null || user.isAdmin()==false) return null;</span>

		//test na isPageEditable je az tu, aby sa zbytocne netestoval pre ine komponenty na zaciatku metody
<span class="nc" id="L1112">		String includeFileNameNoInstallName = includeFileName;</span>

<span class="nc" id="L1114">		String returnIncludeFileName = includeFileName;</span>
<span class="nc bnc" id="L1115" title="All 2 branches missed.">		if (includeFileNameNoInstallName.startsWith(&quot;/components/&quot;+Constants.getInstallName())) returnIncludeFileName = &quot;/components&quot;+returnIncludeFileName.substring((&quot;/components/&quot;+Constants.getInstallName()).length());</span>

<span class="nc bnc" id="L1117" title="All 6 branches missed.">		if (DocTools.isXssStrictUrlException(returnIncludeFileName, &quot;inlineEditingComponents&quot;)  &amp;&amp; isInlinePageEditable(user, docId, request) &amp;&amp; Tools.isNotEmpty(getInlineComponentEditTextKey(request)))</span>
		{
<span class="nc" id="L1119">			StringBuilder html = new StringBuilder();</span>
<span class="nc" id="L1120">			html.append(&quot;&lt;div class=\&quot;inlineComponentEdit\&quot;&gt;&lt;div class='inlineComponentButtonsWrapper'&gt;&lt;div class='inlineComponentButtons'&gt;&quot;);</span>

<span class="nc" id="L1122">			String editorComponent = getInlineEditorComponent(returnIncludeFileName, request);</span>

<span class="nc" id="L1124">			String pageParams = &quot;&quot;;</span>
<span class="nc bnc" id="L1125" title="All 4 branches missed.">			if (editorComponent != null &amp;&amp; Tools.isNotEmpty(getInlineComponentEditTextKey(request)))</span>
			{
<span class="nc" id="L1127">				int ciarka = includeText.indexOf(',');</span>
<span class="nc bnc" id="L1128" title="All 2 branches missed.">				if (ciarka &gt; 0)</span>
				{
<span class="nc" id="L1130">					pageParams = includeText.substring(ciarka+1);</span>
				}

<span class="nc" id="L1133">				html.append(&quot;&lt;a href=\&quot;javascript:inlineComponentEdit('&quot;).append(returnIncludeFileName).append(&quot;', '&quot;).append(JSEscapeTag.jsEscape(pageParams)).append(&quot;', &quot;);</span>
<span class="nc" id="L1134">				html.append(&quot; '&quot;).append(JSEscapeTag.jsEscape(includeText)).append(&quot;', &quot;);</span>
<span class="nc" id="L1135">				html.append(&quot; '&quot;).append(JSEscapeTag.jsEscape(editorComponent)).append(&quot;', &quot;);</span>
<span class="nc" id="L1136">				html.append(docId);</span>
<span class="nc" id="L1137">				html.append(&quot;)\&quot; class=\&quot;inlineComponentButton inlineComponentButtonEdit cke_button\&quot; style=\&quot;background-image:url('&quot;);</span>
<span class="nc" id="L1138">				html.append(getInlineComponentEditIcon(request));</span>
<span class="nc" id="L1139">				html.append(&quot;');\&quot;&gt;&lt;span&gt;&quot;);</span>
<span class="nc" id="L1140">				html.append(prop.getText(getInlineComponentEditTextKey(request)));</span>
<span class="nc" id="L1141">				html.append(&quot;&lt;/span&gt;&lt;/a&gt;&quot;);</span>
			}

<span class="nc" id="L1144">			html.append(&quot;{inlineEditingButtons}&quot;);</span>

<span class="nc bnc" id="L1146" title="All 6 branches missed.">			if (editorComponent != null &amp;&amp; Constants.getBoolean(&quot;inlineEditingAllowDelete&quot;) &amp;&amp; request.getAttribute(INLINE_EDITING_DISABLE_DELETE_BUTTON)==null)</span>
			{
<span class="nc" id="L1148">				html.append(&quot;&lt;a href=\&quot;javascript:inlineComponentDelete('&quot;).append(returnIncludeFileName).append(&quot;', '&quot;).append(JSEscapeTag.jsEscape(pageParams)).append(&quot;', &quot;);</span>
<span class="nc" id="L1149">				html.append(&quot; '&quot;).append(JSEscapeTag.jsEscape(includeText)).append(&quot;', &quot;);</span>
<span class="nc" id="L1150">				html.append(&quot; '&quot;).append(JSEscapeTag.jsEscape(editorComponent)).append(&quot;', &quot;);</span>
<span class="nc" id="L1151">				html.append(docId);</span>
<span class="nc" id="L1152">				html.append(&quot;)\&quot; class=\&quot;inlineComponentButton inlineComponentButtonDelete cke_button\&quot; style=\&quot;background-image:url('&quot;);</span>
<span class="nc" id="L1153">				html.append(&quot;/components/_common/admin/inline/icon-delete.png&quot;);</span>
<span class="nc" id="L1154">				html.append(&quot;');\&quot;&gt;&lt;span&gt;&quot;);</span>
<span class="nc" id="L1155">				html.append(prop.getText(&quot;button.delete&quot;));</span>
<span class="nc" id="L1156">				html.append(&quot;&lt;/span&gt;&lt;/a&gt;&quot;);</span>
			}
<span class="nc" id="L1158">			request.removeAttribute(INLINE_EDITING_DISABLE_DELETE_BUTTON);</span>

<span class="nc" id="L1160">			html.append(&quot;&lt;/div&gt;&lt;/div&gt;&quot;);</span>

<span class="nc" id="L1162">			return html;</span>
		}

<span class="nc" id="L1165">		return null;</span>
	}

	/**
	 * Vrati true ak je pre aktualne vkladanu komponentu do stranky povolena inline editacia, vola sa priamo z danej JSP
	 * @param request
	 * @return
	 */
	public static boolean isInlineEditing(HttpServletRequest request)
	{
<span class="nc" id="L1175">		return &quot;true&quot;.equals(request.getAttribute(&quot;isInlineEditing&quot;));</span>
	}

	public static void addInlineButton(String textKey, String iconLink, String href, String textParam1, String textParam2, HttpServletRequest request)
	{
<span class="nc" id="L1180">		String lng = PageLng.getUserLng(request);</span>
<span class="nc" id="L1181">		Prop prop = Prop.getInstance(lng);</span>

<span class="nc" id="L1183">		StringBuilder buttons = (StringBuilder)request.getAttribute(INLINE_EDITING_BUTTONS_KEY);</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">		if (buttons == null)</span>
		{
<span class="nc" id="L1186">			buttons = new StringBuilder();</span>
<span class="nc" id="L1187">			request.setAttribute(INLINE_EDITING_BUTTONS_KEY, buttons);</span>
		}

<span class="nc" id="L1190">		buttons.append(&quot;&lt;a class=\&quot;inlineComponentButton\&quot; href=\&quot;&quot;);</span>
<span class="nc" id="L1191">		buttons.append(href);</span>
<span class="nc" id="L1192">		buttons.append(&quot;\&quot; style=\&quot;background-image:url('&quot;);</span>
<span class="nc" id="L1193">		buttons.append(iconLink);</span>
<span class="nc" id="L1194">		buttons.append(&quot;');\&quot;&gt;&lt;span&gt;&quot;);</span>
<span class="nc" id="L1195">		buttons.append(prop.getText(textKey, textParam1, textParam2));</span>
<span class="nc" id="L1196">		buttons.append(&quot;&lt;/span&gt;&lt;/a&gt;&quot;);</span>
<span class="nc" id="L1197">	}</span>

	public static void addInlineButtonTop(String textKey, String iconLink, String href, String textParam1, String textParam2, HttpServletRequest request)
	{
<span class="fc" id="L1201">		String lng = PageLng.getUserLng(request);</span>
<span class="fc" id="L1202">		Prop prop = Prop.getInstance(lng);</span>

<span class="fc" id="L1204">		StringBuilder buttons = (StringBuilder)request.getAttribute(INLINE_EDITING_BUTTONS_TOP_KEY);</span>
<span class="pc bpc" id="L1205" title="1 of 2 branches missed.">		if (buttons == null)</span>
		{
<span class="fc" id="L1207">			buttons = new StringBuilder();</span>
<span class="fc" id="L1208">			request.setAttribute(INLINE_EDITING_BUTTONS_TOP_KEY, buttons);</span>
		}

<span class="fc" id="L1211">		buttons.append(&quot;&lt;a class=\&quot;inlineComponentButton\&quot; href=\&quot;&quot;);</span>
<span class="fc" id="L1212">		buttons.append(href);</span>
<span class="fc" id="L1213">		buttons.append(&quot;\&quot; style=\&quot;background-image:url('&quot;);</span>
<span class="fc" id="L1214">		buttons.append(iconLink);</span>
<span class="fc" id="L1215">		buttons.append(&quot;');\&quot;&gt;&quot;);</span>
<span class="fc" id="L1216">		buttons.append(prop.getText(textKey, textParam1, textParam2));</span>
<span class="fc" id="L1217">		buttons.append(&quot;&lt;/a&gt;&quot;);</span>
<span class="fc" id="L1218">	}</span>

	public static void hideInlineComponentEditButton(HttpServletRequest request)
	{
<span class="fc" id="L1222">		request.setAttribute(INLINE_EDITING_MODULE_PROPS_DISABLE_KEY, Boolean.FALSE);</span>
<span class="fc" id="L1223">	}</span>

	private static boolean isInlineComponentEditButton(HttpServletRequest request)
	{
<span class="nc bnc" id="L1227" title="All 2 branches missed.">		if (request.getAttribute(INLINE_EDITING_MODULE_PROPS_DISABLE_KEY)!=null)</span>
		{
<span class="nc" id="L1229">			return false;</span>
		}
<span class="nc" id="L1231">		return true;</span>
	}

	public static void setInlineComponentEditTextKey(String key, HttpServletRequest request)
	{
<span class="fc" id="L1236">		request.setAttribute(INLINE_EDITING_MODULE_PROPS_TEXT_KEY, key);</span>
<span class="fc" id="L1237">	}</span>

	public static void disableDeleteButton(HttpServletRequest request)
	{
<span class="nc" id="L1241">		request.setAttribute(INLINE_EDITING_DISABLE_DELETE_BUTTON, &quot;1&quot;);</span>
<span class="nc" id="L1242">	}</span>

	private static String getInlineComponentEditTextKey(HttpServletRequest request)
	{
<span class="nc" id="L1246">		String key = (String)request.getAttribute(INLINE_EDITING_MODULE_PROPS_TEXT_KEY);</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">		if (key == null) key = &quot;editor.inline.editComponent&quot;;</span>

<span class="nc" id="L1249">		return key;</span>
	}

	public static void setInlineComponentEditIcon(String url, HttpServletRequest request)
	{
<span class="fc" id="L1254">		request.setAttribute(INLINE_EDITING_MODULE_PROPS_ICON, url);</span>
<span class="fc" id="L1255">	}</span>

	private static String getInlineComponentEditIcon(HttpServletRequest request)
	{
<span class="nc" id="L1259">		String icon = (String)request.getAttribute(INLINE_EDITING_MODULE_PROPS_ICON);</span>
<span class="nc bnc" id="L1260" title="All 2 branches missed.">		if (icon == null) icon = &quot;/components/_common/admin/inline/icon-properties.png&quot;;</span>

<span class="nc" id="L1262">		return icon;</span>
	}

	private static void preserveParametersSet(String includeFileName, HttpServletRequest request)
	{
		//toto robi search komponente problem, koliduje to s jej vyrazmi, kvoli problemom s custom JSP to davam radsej sem
<span class="fc bfc" id="L1268" title="All 2 branches covered.">		if (includeFileName.indexOf(&quot;/search&quot;)!=-1)</span>
		{
<span class="fc bfc" id="L1270" title="All 2 branches covered.">			for (String pname : SearchTools.getCheckInputParams())</span>
			{
<span class="fc" id="L1272">				String value = (String)request.getAttribute(pname);</span>
<span class="fc bfc" id="L1273" title="All 2 branches covered.">				if (Tools.isNotEmpty(value))</span>
				{
<span class="fc" id="L1275">					request.setAttribute(&quot;preserve_&quot;+pname, value);</span>
<span class="fc" id="L1276">					request.removeAttribute(pname);</span>
				}
			}
		}
<span class="fc" id="L1280">	}</span>

	private static void preserveParametersRemove(String includeFileName, HttpServletRequest request)
	{
		//toto robi search komponente problem, koliduje to s jej vyrazmi, kvoli problemom s custom JSP to davam radsej sem
<span class="fc bfc" id="L1285" title="All 2 branches covered.">		if (includeFileName.indexOf(&quot;/search&quot;)!=-1)</span>
		{
<span class="fc bfc" id="L1287" title="All 2 branches covered.">			for (String pname : SearchTools.getCheckInputParams())</span>
			{
<span class="fc" id="L1289">				String value = (String)request.getAttribute(&quot;preserve_&quot;+pname);</span>
<span class="pc bpc" id="L1290" title="1 of 2 branches missed.">				if (Tools.isNotEmpty(value))</span>
				{
<span class="nc" id="L1292">					request.setAttribute(pname, value);</span>
<span class="nc" id="L1293">					request.removeAttribute(&quot;preserve_&quot;+pname);</span>
				}
			}
		}
<span class="fc" id="L1297">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>