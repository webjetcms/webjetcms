<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileArchivatorKit.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.components.file_archiv</a> &gt; <span class="el_source">FileArchivatorKit.java</span></div><h1>FileArchivatorKit.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.components.file_archiv;

import java.security.MessageDigest;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Collection;
import java.util.Date;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.apache.commons.codec.digest.DigestUtils;

import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Cache;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.FileTools;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PkeyGenerator;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.common.CloudToolsForCore;
import sk.iway.iwcm.common.DocTools;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.helpers.BeanDiff;
import sk.iway.iwcm.helpers.BeanDiffPrinter;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmInputStream;
import sk.iway.iwcm.system.cluster.ClusterDB;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UsersDB;

/**
 *	FileArchivatorKit.java
 *
 *
 * Title			webjet7
 * Company		Interway s.r.o. (www.interway.sk)
 * Copyright 	Interway s.r.o. (c) 2001-2015
 * @author		$Author: jeeff $(prau)
 * @version		Revision: 1.3  11.2.2015
 * created		Date: 11.2.2015 14:40:05
 * modified   	Date: 11.2.2015 14:40:05
 * Ticket 		Number: #17263
 */
public class FileArchivatorKit
{
<span class="fc" id="L51">    private Prop prop = Prop.getInstance();</span>
    private List&lt;String&gt; errorsList;

    public FileArchivatorKit(Prop paramProp)
<span class="fc" id="L55">    {</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">        if(paramProp != null)</span>
        {
<span class="fc" id="L58">            prop = paramProp;</span>
        }
<span class="fc" id="L60">    }</span>

    /** Skontroluje ci je modul File Archiv povoleny pre aktualneho usera
     *
     */
    public static boolean isArchivEnabled(HttpServletRequest request)
    {
<span class="nc" id="L67">        return isArchivEnabled(UsersDB.getCurrentUser(request));</span>
    }

    /** Skontroluje ci je modul File Archiv povoleny pre usera
     *
     * @param userIdentity Identity
     */
    public static boolean isArchivEnabled(Identity userIdentity)
    {
<span class="pc bpc" id="L76" title="2 of 4 branches missed.">        return userIdentity != null &amp;&amp; userIdentity.isEnabledItem(&quot;cmp_file_archiv&quot;);</span>
    }

	public static String getArchivPath()
	{
	    //robi lokalne problem pri zapnutej konf. premennej &quot;enableStaticFilesExternalDir&quot;
<span class="fc" id="L82">		String defaultArchivPath = &quot;files/archiv/&quot;;</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">		if(Tools.isEmpty(Constants.getString(&quot;fileArchivDefaultDirPath&quot;)))</span>
<span class="nc" id="L84">			return defaultArchivPath;</span>

<span class="fc" id="L86">		return Constants.getString(&quot;fileArchivDefaultDirPath&quot;);</span>
	}


	public static String getInsertLaterPath()
	{
<span class="nc" id="L92">		String defaultInsertLaterPath = &quot;files/archiv_insert_later/&quot;;</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if(Tools.isEmpty(Constants.getString(&quot;fileArchivInsertLaterDirPath&quot;)))</span>
<span class="nc" id="L94">			return defaultInsertLaterPath;</span>

<span class="nc" id="L96">		return Constants.getString(&quot;fileArchivInsertLaterDirPath&quot;);</span>
	}

	public static String getFullInsertLaterPath()
	{
<span class="nc" id="L101">		return getArchivPath() + getInsertLaterPath();</span>
	}

	/** Vrati unikatne meno suboru
	 *
	 * @param file - subor
	 * @param directoryPath - cesta k suboru
	 * @param preferredDate - null / preferovany datum
	 */
	public static String getUniqueFileName(String fileNameParam, String directoryPath, String preferredDate)
	{
<span class="fc" id="L112">		String dirPath = directoryPath;</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">		if(Tools.isAnyEmpty(fileNameParam, dirPath) == false)</span>
		{
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">			if(!dirPath.endsWith(&quot;/&quot;))</span>
<span class="nc" id="L116">				dirPath += &quot;/&quot;;</span>

<span class="fc" id="L118">			String ext = DB.internationalToEnglish(FileTools.getFileExtension(fileNameParam));</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">			if(Tools.isNotEmpty(ext)) ext = &quot;.&quot;+ext;</span>
<span class="fc" id="L120">			String fileName = DocTools.removeChars(FileTools.getFileNameWithoutExtension(fileNameParam), false);</span>
<span class="fc" id="L121">			int version = 0;</span>
<span class="fc" id="L122">			int loopSafe = 10000;</span>
			String str_version;
<span class="fc" id="L124">			String dateStamp = &quot;&quot;;</span>
			//funkcia nebola ziadana
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">			if(Constants.getBoolean(FileArchivatorDB.getConstantsPrefix()+&quot;CreateFileDateStamp&quot;))</span>
			{
<span class="nc" id="L128">				dateStamp = getDateStampAsString();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">				if(Tools.isNotEmpty(preferredDate))</span>
<span class="nc" id="L130">					dateStamp = preferredDate;</span>
			}
<span class="fc" id="L132">			String fullFileName = fileName+ext;</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">			if(FileTools.isFile(dirPath+fullFileName))</span>
			{
				do
				{
<span class="nc" id="L137">					version++;</span>
<span class="nc" id="L138">					str_version = version+&quot;&quot;;</span>
<span class="nc" id="L139">					fullFileName = fileName+&quot;_v_&quot;+str_version+dateStamp+ext;</span>
<span class="nc bnc" id="L140" title="All 4 branches missed.">				}while( FileTools.isFile(dirPath+fullFileName) &amp;&amp; version &lt; loopSafe);</span>
<span class="nc" id="L141">				return fullFileName;</span>
			}
<span class="fc" id="L143">			return fileName+ext;</span>
		}
<span class="nc" id="L145">		return null;</span>
	}

	/** vytvori bean pre novy subor, upravi referenciu (referenceId) u starych suborov
	 *
	 * @return true ak vsetko prebehlo v poriadku
	 */
	public static boolean setFilePropertiesAfterUpload(FileArchivatorBean newFab, int oldId, boolean uploadLater, HttpServletRequest req)
	{
<span class="fc" id="L154">		boolean result = true;</span>
		//pri nahravani neskor existenciu kontrolujeme skor kvoli multidomain
<span class="pc bpc" id="L156" title="2 of 4 branches missed.">		if(uploadLater == false &amp;&amp; !FileTools.isFile(newFab.getFilePath()+newFab.getFileName()))</span>
		{
<span class="nc" id="L158">			return false;</span>
		}

<span class="fc" id="L161">		newFab.setDomainId(CloudToolsForCore.getDomainId());</span>
		//always set referenceId, if provided. For main file it will be fixed in reSetReference method.
<span class="fc" id="L163">		newFab.setReferenceId(oldId);</span>

<span class="pc bpc" id="L165" title="1 of 2 branches missed.">		if(!newFab.save())</span>
		{
<span class="nc" id="L167">			Logger.debug(FileArchivatorKit.class, &quot; new FileArchivatorBean(...) !newFab.save() &quot;+newFab.toString());</span>
<span class="nc" id="L168">			return false;</span>
		}

<span class="fc" id="L171">		boolean newVersion = false;</span>
		//ak uz existuje nejaka starsia verzia naseho suboru
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">		if(oldId &gt; 0)</span>
		{
<span class="nc" id="L175">            newVersion = true;</span>
<span class="nc" id="L176">			FileArchivatorBean oldFab = FileArchivatorDB.getInstance().getById(oldId);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">			if(oldFab == null)</span>
			{
<span class="nc" id="L179">				Logger.debug(FileArchivatorKit.class, &quot;setFilePropertiesAfterUpload() fileBean == null&quot;);</span>
<span class="nc" id="L180">				return false;</span>
			}

			//ak sa ma subor nahrat neskor, to je vsetko
<span class="nc bnc" id="L184" title="All 2 branches missed.">			if(uploadLater)</span>
<span class="nc" id="L185">				return result;</span>

			//premenujeme (vymenime) subory stary-&gt;novy a novy-&gt;stary
<span class="nc bnc" id="L188" title="All 2 branches missed.">			if(renameFile(newFab.getFilePath(), newFab.getFileName(), oldFab))</span>
			{
				//premenujeme v DB
<span class="nc" id="L191">				String tempNameUrl = oldFab.getFileName();</span>
<span class="nc" id="L192">				oldFab.setFileName(newFab.getFileName());</span>
<span class="nc" id="L193">				newFab.setFileName(tempNameUrl);</span>
				//premenujeme aj cestu
<span class="nc" id="L195">				tempNameUrl = oldFab.getFilePath();</span>
<span class="nc" id="L196">				oldFab.setFilePath(newFab.getFilePath());</span>
<span class="nc" id="L197">				newFab.setFilePath(tempNameUrl);</span>
				//zmenime referenciu v hlavnom subore
<span class="nc" id="L199">				oldFab.setReferenceId(newFab.getId());</span>
				//globalne id je rovnake pre vsetky subory vo vlakne.
<span class="nc" id="L201">				newFab.setGlobalId(oldFab.getGlobalId());</span>
<span class="nc" id="L202">				newFab.setDateInsert(new Date());</span>
<span class="nc bnc" id="L203" title="All 4 branches missed.">				if(!oldFab.save() || !newFab.save())</span>
<span class="nc" id="L204">					result = false;</span>

				//zmenime referenciu u suborov, ktore na neho odkazuju (a po novom budu odkazovat na novy subor)
<span class="nc bnc" id="L207" title="All 2 branches missed.">				if(!reSetReference(oldId, newFab.getId()))</span>
<span class="nc" id="L208">					result = false;</span>

				//posunieme order_id o jednu uroven
<span class="nc" id="L211">				incrementOrderId(newFab.getId());</span>
				//return result;
<span class="nc" id="L213">			}</span>
			else
            {
<span class="nc" id="L216">                Logger.debug(FileArchivatorKit.class, &quot;nezbehlo renameFile: &quot;+newFab.getVirtualPath()+&quot; vs. &quot;+oldFab.getVirtualPath());</span>
<span class="nc" id="L217">                return false;</span>
            }
<span class="nc" id="L219">		}</span>
		else
		{
			//ak uz existuju subory s rovnakym hashom, na frontende ponukneme moznosti riesenia
<span class="fc" id="L223">			List&lt;FileArchivatorBean&gt; sameFilesList = existSameFiles(newFab, true);</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">			if(req!=null)</span>
			{
<span class="fc" id="L226">				req.setAttribute(&quot;fileArchivSameFiles&quot;, sameFilesList);</span>
                //kvoli mfsr potrebujem setovat vzdy
<span class="fc" id="L228">                req.setAttribute(&quot;fileArchivLastFile&quot;, newFab);</span>

<span class="fc" id="L230">                FileArchivValidator fav = (FileArchivValidator)req.getAttribute(&quot;validator&quot;);</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">                if(fav == null)</span>
<span class="fc" id="L232">                    fav = new FileArchivDefaultValidator();</span>

<span class="pc bpc" id="L234" title="1 of 2 branches missed.">                if(!fav.validatePropertiesAfterUpload(newFab,req))</span>
                {
<span class="nc" id="L236">                    Logger.debug(FileArchivatorKit.class, &quot;nezbehlo validatePropertiesAfterUpload: &quot;+newFab.getVirtualPath());</span>
<span class="nc" id="L237">                    return false;</span>
                }

            }

			//novemu suboru vo vlakne nastavime nove globalne ID
<span class="fc" id="L243">			newFab.setGlobalId(generateNextGlobalId());</span>
<span class="fc" id="L244">			newFab.save();</span>
		}
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">		if (req != null) req.setAttribute(&quot;after_save_fab&quot;, newFab);</span>
<span class="fc" id="L247">		addSaveLogToAdminlog(newFab, newVersion);</span>
<span class="fc" id="L248">		return result;</span>
	}

	/**
	 * Method is called when we are replacing existing file without creating new version in history
	 * @param newFab
	 * @param oldId
	 * @param userId
	 * @param req
	 * @return
	 */
	public static boolean setFilePropertiesAfterUploadReplace(FileArchivatorBean newFab, int oldId, HttpServletRequest req)
	{
<span class="nc bnc" id="L261" title="All 2 branches missed.">		if(!FileTools.isFile(newFab.getFilePath()+newFab.getFileName()))</span>
		{
<span class="nc" id="L263">			return false;</span>
		}

<span class="nc" id="L266">		newFab.setId(oldId);</span>
<span class="nc" id="L267">		newFab.setDateInsert(new Date());</span>

		//ak uz existuju subory s rovnakym hashom, na frontende ponukneme moznosti riesenia
<span class="nc" id="L270">		List&lt;FileArchivatorBean&gt; sameFilesList = existSameFiles(newFab, false);</span>
<span class="nc" id="L271">		req.setAttribute(&quot;fileArchivSameFiles&quot;, sameFilesList);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">		if(sameFilesList != null)</span>
		{
<span class="nc" id="L274">			req.setAttribute(&quot;fileArchivLastFile&quot;, newFab);</span>
		}

<span class="nc" id="L277">        FileArchivValidator fav = (FileArchivValidator)req.getAttribute(&quot;validator&quot;);</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">        if(fav == null)</span>
<span class="nc" id="L279">            fav = new FileArchivDefaultValidator();</span>

<span class="nc bnc" id="L281" title="All 2 branches missed.">        if(!fav.validateAfterUploadReplace(newFab,req))</span>
        {
<span class="nc" id="L283">            Logger.debug(FileArchivatorKit.class, &quot; new FileArchivatorBean(...) !newFab.save() &quot;+newFab.toString());</span>
<span class="nc" id="L284">            return false;</span>
        }

<span class="nc bnc" id="L287" title="All 2 branches missed.">		if(!newFab.save())</span>
		{
<span class="nc" id="L289">			Logger.debug(FileArchivatorKit.class, &quot; new FileArchivatorBean(...) !newFab.save() &quot;+newFab.toString());</span>
<span class="nc" id="L290">			return false;</span>
		}
<span class="nc" id="L292">		addSaveLogToAdminlog(newFab, false, true);</span>
		//delete cache
<span class="nc" id="L294">		FileArchivatorKit.deleteFileArchiveCache();</span>

<span class="nc" id="L296">		return true;</span>
	}


	/**
	 * zamena obsahu suborov dirPath+fileName &lt;-&gt; oldFileBean.getFilePath()+oldFileBean.getFileName()
	 * BHR: musel som prerobit z Tools.renameFile, pretoze sa stalo, ze niekedy nezmazalo zdrojovy subor a teda sa premenovanie nedokoncilo
	 */
	public static boolean renameFile(String dirPath, String fileName, FileArchivatorBean oldFileBean)
	{
<span class="nc" id="L306">		boolean renamed = true;</span>
<span class="nc" id="L307">		IwcmFile oldFile = new IwcmFile(Tools.getRealPath(oldFileBean.getFilePath()+oldFileBean.getFileName()));</span>
<span class="nc" id="L308">		IwcmFile newFile = new IwcmFile(Tools.getRealPath(dirPath+fileName));</span>
<span class="nc" id="L309">		IwcmFile tmpFile = new IwcmFile(Tools.getRealPath(dirPath+&quot;empty_file_for_rename_only&quot;+getFileExtension(fileName)));</span>
		try
		{
			//copy old file to temp file for later usage
<span class="nc bnc" id="L313" title="All 2 branches missed.">			if(FileTools.copyFile(oldFile, tmpFile) == false)</span>
			{
<span class="nc" id="L315">				 Logger.error(FileArchivatorKit.class, &quot;renameFile: nepodarilo sa premenovat &quot;+oldFile.getVirtualPath()+&quot; &gt; &quot;+tmpFile.getVirtualPath());</span>
<span class="nc" id="L316">				 renamed = false;</span>
			}
			//owerwrite old file with new file
<span class="nc bnc" id="L319" title="All 2 branches missed.">			if(FileTools.copyFile(newFile, oldFile) == false)</span>
			{
<span class="nc" id="L321">				 Logger.error(FileArchivatorKit.class, &quot;renameFile: nepodarilo sa premenovat &quot;+newFile.getVirtualPath()+&quot; &gt; &quot;+oldFile.getVirtualPath());</span>
<span class="nc" id="L322">				 renamed = false;</span>
			}
			//copy temp (old) file over new file
<span class="nc bnc" id="L325" title="All 2 branches missed.">			if(FileTools.copyFile(tmpFile, newFile) == false)</span>
			{
<span class="nc" id="L327">				 Logger.error(FileArchivatorKit.class, &quot;renameFile: nepodarilo sa premenovat &quot;+tmpFile.getVirtualPath()+&quot; &gt; &quot;+newFile.getVirtualPath());</span>
<span class="nc" id="L328">				 renamed = false;</span>
			}
		}
<span class="nc" id="L331">		catch(Exception e)</span>
		{
<span class="nc" id="L333">			renamed = false;</span>
<span class="nc" id="L334">			sk.iway.iwcm.Logger.error(e);</span>
		}
		finally
		{
<span class="nc bnc" id="L338" title="All 4 branches missed.">			if(renamed &amp;&amp; tmpFile.exists())</span>
<span class="nc" id="L339">				 tmpFile.delete();</span>
		}
<span class="nc" id="L341">		return renamed;</span>
	}

	public static boolean reSetReference(int oldReferenceId, int newReferenceId)
	{
<span class="nc" id="L346">		List&lt;FileArchivatorBean&gt; files = FileArchivatorDB.getByReferenceId(oldReferenceId);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">		if(files != null)</span>
		{
<span class="nc bnc" id="L349" title="All 2 branches missed.">			for(FileArchivatorBean file:files)</span>
			{
<span class="nc" id="L351">				Logger.debug(FileArchivatorKit.class, &quot;Change reference from &quot;+oldReferenceId+&quot; to &quot;+newReferenceId+&quot; file: &quot;+file.getFilePath()+file.getFileName());</span>
<span class="nc" id="L352">				file.setReferenceId(newReferenceId);</span>
<span class="nc bnc" id="L353" title="All 2 branches missed.">				if(!file.save())</span>
				{
<span class="nc" id="L355">					return false;</span>
				}
<span class="nc" id="L357">			}</span>
		}
<span class="nc" id="L359">		FileArchivatorBean newBean = FileArchivatorDB.getInstance().getById(newReferenceId);</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">		if (newBean != null)</span>
		{
<span class="nc" id="L362">			newBean.setReferenceId(-1);</span>
			//force save to call FullTextIndexer
<span class="nc" id="L364">			newBean.save();</span>
		}
<span class="nc" id="L366">		return true;</span>
	}

	/** Zisti ci sa nejde menit hlavny (aktualny) subor na ktory odkazuju ostatne. napriklad pri editacii viacerymi pouzivatelmi
	 *
	 */
	public static boolean isConcurrentModification(int oldId)
	{
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">		if(oldId &gt; 0)</span>
		{
<span class="nc" id="L376">			FileArchivatorBean fileBean = FileArchivatorDB.getInstance().getById(oldId);</span>
<span class="nc bnc" id="L377" title="All 4 branches missed.">			if(fileBean != null &amp;&amp; fileBean.getReferenceId() != -1)</span>
			{
<span class="nc" id="L379">				Logger.debug(FileArchivatorKit.class, &quot;Pozor !!! Moze nastat ConcurrentModification pri id: &quot;+oldId+&quot; subor: &quot;+fileBean.getFileName());</span>
<span class="nc" id="L380">				return true;</span>
			}
		}
<span class="fc" id="L383">		return false;</span>
	}

	public static String getMD5(IwcmFile iwcmFile)
	{
<span class="fc" id="L388">		String md5Hex = &quot;null&quot;;</span>
<span class="pc bpc" id="L389" title="2 of 4 branches missed.">		if(iwcmFile == null || iwcmFile.exists() == false)</span>
		{
<span class="nc" id="L391">			return md5Hex;</span>
		}

		try
		{
<span class="fc" id="L396">			md5Hex = DigestUtils.md5Hex(new IwcmInputStream(iwcmFile));</span>
		}
<span class="nc" id="L398">		catch(Exception exc)</span>
		{
<span class="nc" id="L400">			Logger.debug(FileArchivatorKit.class, &quot;Zlyhalo generovanie MD5 odtlacku&quot;);</span>
<span class="nc" id="L401">			sk.iway.iwcm.Logger.error(exc);</span>
<span class="fc" id="L402">		}</span>
<span class="fc" id="L403">		return md5Hex;</span>
	}

	/** Vrati datum ako String.
	 *
	 */
	public static String getDateStampAsString()
	{
<span class="nc" id="L411">		return getDateStampAsString(null);</span>
	}

	/** Vrati datum a cas ako String.
	 *
	 */
	public static String getDateStampAsString(Date date)
	{
<span class="nc" id="L419">		Calendar now = Calendar.getInstance();</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">		if(date != null)</span>
<span class="nc" id="L421">			now.setTime(date);</span>
<span class="nc" id="L422">		StringBuilder dateString = new StringBuilder();</span>
<span class="nc" id="L423">		dateString.append(now.get(Calendar.YEAR)).append(&quot;.&quot;).append(now.get(Calendar.MONTH)+1).append(&quot;.&quot;).append(now.get(Calendar.DAY_OF_MONTH)).append(&quot;_&quot;).append(now.get(Calendar.HOUR_OF_DAY)).append(&quot;.&quot;).append(now.get(Calendar.MINUTE));</span>
<span class="nc" id="L424">		return dateString.toString();</span>
	}

	public static String getFileExtension(String fileName)
	{
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">		if(fileName == null)</span>
<span class="nc" id="L430">			return &quot;empty&quot;;</span>
<span class="pc bpc" id="L431" title="1 of 2 branches missed.">		if(fileName.lastIndexOf(&quot;.&quot;) != -1)</span>
<span class="fc" id="L432">			return fileName.toLowerCase().substring(fileName.lastIndexOf(&quot;.&quot;));</span>
<span class="nc" id="L433">		return &quot;nul&quot;;</span>
	}

    public static String getFileExtension(String fileName, boolean allowNull)
    {
<span class="nc bnc" id="L438" title="All 2 branches missed.">        if(fileName == null)</span>
        {
<span class="nc bnc" id="L440" title="All 2 branches missed.">            if(allowNull)</span>
<span class="nc" id="L441">                return null;</span>
<span class="nc" id="L442">            return &quot;empty&quot;;</span>
        }
<span class="nc bnc" id="L444" title="All 2 branches missed.">        if(fileName.lastIndexOf(&quot;.&quot;) != -1)</span>
<span class="nc" id="L445">            return fileName.toLowerCase().substring(fileName.lastIndexOf(&quot;.&quot;));</span>

<span class="nc bnc" id="L447" title="All 2 branches missed.">        if(allowNull)</span>
<span class="nc" id="L448">            return null;</span>

<span class="nc" id="L450">        return &quot;nul&quot;;</span>
    }

	public static void incrementOrderId(int referenceId)
	{
		//DB.execute(&quot;UPDATE file_archiv SET order_id = order_id+1 WHERE reference_id = ? AND order_id &gt;= 0&quot;, referenceId);
		//DB.execute(&quot;UPDATE file_archiv SET order_id = 1 WHERE reference_id = ? AND order_id &lt; 0&quot;, referenceId);
		//USE JPA API to update because of JPA cache/object state
<span class="nc" id="L458">		List&lt;FileArchivatorBean&gt; files = FileArchivatorDB.getByReferenceId(referenceId);</span>
<span class="nc" id="L459">		int oldOrder = -1;</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">		if(files != null)</span>
		{
<span class="nc bnc" id="L462" title="All 2 branches missed.">			for(FileArchivatorBean file:files)</span>
			{
<span class="nc" id="L464">				oldOrder = file.getOrderId();</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">				if(file.getOrderId() == -1)</span>
<span class="nc" id="L466">					file.setOrderId(2);</span>
				else
<span class="nc" id="L468">					file.setOrderId(file.getOrderId()+1);</span>
<span class="nc" id="L469">				Logger.debug(FileArchivatorKit.class, &quot;Increment orderId from &quot;+oldOrder+&quot; to &quot;+file.getOrderId()+&quot; file: &quot;+file.getFilePath()+file.getFileName());</span>
<span class="nc" id="L470">				file.save();</span>
<span class="nc" id="L471">			}</span>
		}
		//musim tu vymazat cache
<span class="nc" id="L474">		FileArchivatorKit.deleteFileArchiveCache();</span>
<span class="nc" id="L475">		Logger.debug(FileArchivatorKit.class, &quot;Increment orderId for referenceId = &quot;+referenceId);</span>
<span class="nc" id="L476">	}</span>

	public static String[] getDomainNames()
	{
<span class="nc" id="L480">		return Tools.getTokens(Constants.getString(&quot;fileArchivDomainsName&quot;), &quot;,&quot;);</span>
	}

	/** Mazanie za podmienky ze na subor NEexistuje referencia
	 *
	 */
	public static boolean deleteFile(int fabId, UserDetails user)
	{
<span class="nc" id="L488">		List&lt;FileArchivatorBean&gt; fabList = FileArchivatorDB.getByReferenceId(fabId);</span>
<span class="nc bnc" id="L489" title="All 4 branches missed.">		if(fabList == null || fabList.size() == 0)</span>
		{
<span class="nc" id="L491">			FileArchivatorBean fabToDelete = FileArchivatorDB.getInstance().getById(fabId);</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">			if(fabToDelete != null)</span>
			{
<span class="nc bnc" id="L494" title="All 4 branches missed.">				if(user == null || !user.isFolderWritable(&quot;/&quot;+fabToDelete.getFilePath()))</span>
				{
<span class="nc bnc" id="L496" title="All 2 branches missed.">					Logger.debug(FileArchivatorKit.class, &quot;Pouzivatel &quot;+((user != null)?&quot;id: &quot;+user.getUserId():&quot;null&quot;)+&quot; nema pravo na zmazanie suboru: &quot;+fabToDelete.getFilePath()+fabToDelete.getFileName()+&quot; &quot;);</span>
<span class="nc" id="L497">					return false;</span>
				}

<span class="nc" id="L500">				boolean isSuccess = false;</span>
<span class="nc" id="L501">				IwcmFile iFile = new IwcmFile(Tools.getRealPath(fabToDelete.getFilePath()+fabToDelete.getFileName()));</span>
<span class="nc bnc" id="L502" title="All 4 branches missed.">				if(iFile.exists() &amp;&amp; iFile.delete())</span>
				{
<span class="nc" id="L504">					isSuccess = true;</span>
<span class="nc" id="L505">					deletePattern(FileArchivatorDB.getPatern(fabToDelete.getFilePath()+fabToDelete.getFileName()), user);</span>
				}
				else
				{
<span class="nc" id="L509">					Logger.debug(FileArchivatorKit.class, &quot;Subor :&quot;+fabToDelete.getFilePath()+fabToDelete.getFileName()+&quot; sa nepodarilo zmazat.&quot;);</span>
				}

<span class="nc bnc" id="L512" title="All 4 branches missed.">				if(isSuccess &amp;&amp; fabToDelete.delete())</span>
				{
<span class="nc" id="L514">					String fileDescription = &quot;Subor &quot;+fabToDelete.getFilePath()+fabToDelete.getFileName()+&quot; zmazany \n &quot;+fabToDelete.toString();</span>
<span class="nc" id="L515">					Adminlog.add(Adminlog.TYPE_FILE_ARCHIVE, fileDescription, -1, -1);</span>
<span class="nc" id="L516">					return true;</span>
				}

			}
		}
<span class="nc" id="L521">		return false;</span>
	}

	public static boolean deleteStructure(int fabId,UserDetails user)
	{
<span class="fc" id="L526">		boolean isSuccess = true;</span>

		//najskorej zmazeme referencie
<span class="fc" id="L529">		List&lt;FileArchivatorBean&gt; fabList = FileArchivatorDB.getByReferenceId(fabId);</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">		if(fabList != null)</span>
		{
			//ak na niektory z mazanych suborov nemame pravo, nezmazeme ani tie na ktore mame pravo.
<span class="pc bpc" id="L533" title="1 of 2 branches missed.">			for(FileArchivatorBean fab:fabList)</span>
			{
<span class="nc bnc" id="L535" title="All 4 branches missed.">				if(user == null || !user.isFolderWritable(&quot;/&quot;+fab.getFilePath()))</span>
				{
<span class="nc bnc" id="L537" title="All 2 branches missed.">					Logger.debug(FileArchivatorKit.class, &quot;Pouzivatel &quot;+((user != null)?&quot;id: &quot;+user.getUserId():&quot;null&quot;)+&quot; nema pravo na zmazanie suboru (v liste): &quot;+fab.getFilePath()+fab.getFileName()+&quot; &quot;);</span>
<span class="nc" id="L538">					return false;</span>
				}
<span class="nc" id="L540">			}</span>

<span class="pc bpc" id="L542" title="1 of 2 branches missed.">			for(FileArchivatorBean fab:fabList)</span>
			{
<span class="nc" id="L544">				isSuccess = deleteFile(fab, &quot;Sub &quot;, user);</span>
<span class="nc" id="L545">			}</span>
		}

<span class="pc bpc" id="L548" title="1 of 2 branches missed.">		if(!isSuccess)</span>
<span class="nc" id="L549">			return false;</span>

		//a teraz zmazeme hlavny subor
<span class="fc" id="L552">		FileArchivatorBean fabToDelete = FileArchivatorDB.getInstance().getById(fabId);</span>

<span class="pc bpc" id="L554" title="1 of 2 branches missed.">		if(fabToDelete != null)</span>
		{
			//prava na zmazanie sa vykonava v metode deleteFile(String ,String );
			//zmazeme vzor
<span class="fc" id="L558">			deletePattern(FileArchivatorDB.getPatern(fabToDelete.getFilePath()+fabToDelete.getFileName()),user);</span>
<span class="fc" id="L559">			isSuccess = deleteFile(fabToDelete,&quot;Hlavny &quot;, user);</span>
		}

<span class="fc" id="L562">		return isSuccess;</span>
	}

	/** Ak je bean vzorom (ma vyplnene &quot;reference_to_main&quot;) tak bude zmazany
	 *
	 */
	private static boolean deletePattern(FileArchivatorBean fabPattern, UserDetails user)
	{
<span class="pc bpc" id="L570" title="5 of 6 branches missed.">		if(fabPattern == null || Tools.isEmpty(fabPattern.getReferenceToMain()) || !Constants.getBoolean(FileArchivatorDB.getConstantsPrefix() + &quot;AutoDeletePattern&quot;))</span>
<span class="fc" id="L571">			return false;</span>

<span class="nc" id="L573">		return deleteFile(fabPattern, &quot;Vzor &quot;, user);</span>
	}

	/** Skontroluje prava na subory, zmaze subor fyzicky z disku a zmaze aj Bean
	 *
	 */
	private static boolean deleteFile(FileArchivatorBean fabToDelete, String prefixText, UserDetails user)
	{
<span class="pc bpc" id="L581" title="1 of 2 branches missed.">		if(fabToDelete == null)</span>
		{
<span class="nc" id="L583">			Logger.debug(FileArchivatorKit.class, prefixText+&quot; FAB je null &quot;);</span>
<span class="nc" id="L584">			return false;</span>
		}

<span class="pc bpc" id="L587" title="2 of 4 branches missed.">		if(user == null || !user.isFolderWritable(&quot;/&quot;+fabToDelete.getFilePath()))</span>
		{
<span class="nc bnc" id="L589" title="All 2 branches missed.">			Logger.debug(FileArchivatorKit.class, &quot;Pouzivatel &quot;+((user != null)?&quot;id: &quot;+user.getUserId():&quot;null&quot;)+&quot; nema pravo na zmazanie (&quot;+prefixText+&quot;) suboru: &quot;+fabToDelete.getFilePath()+fabToDelete.getFileName()+&quot; &quot;);</span>
<span class="nc" id="L590">			return false;</span>
		}
<span class="fc" id="L592">		boolean isSuccess = true;</span>
<span class="fc" id="L593">		IwcmFile iFile = new IwcmFile(Tools.getRealPath(fabToDelete.getFilePath()+fabToDelete.getFileName()));</span>
<span class="pc bpc" id="L594" title="3 of 6 branches missed.">		if(iFile == null || !iFile.exists() || !iFile.delete())</span>
		{
<span class="nc" id="L596">			isSuccess = false;</span>
<span class="nc" id="L597">			Logger.debug(FileArchivatorKit.class, prefixText+&quot; subor :&quot;+fabToDelete.getFilePath()+fabToDelete.getFileName()+&quot; sa nepodarilo zmazat.&quot;);</span>
		}
		else
		{
			// delete file index
<span class="fc" id="L602">			new SimpleQuery().execute(&quot;DELETE FROM documents WHERE external_link=?&quot;, &quot;'/&quot; + fabToDelete.getFilePath()+fabToDelete.getFileName() + &quot;'&quot;);</span>

<span class="pc bpc" id="L604" title="1 of 2 branches missed.">			if(fabToDelete.delete()) {</span>
<span class="fc" id="L605">				String fileDescription = &quot;Subor &quot;+fabToDelete.getFilePath()+fabToDelete.getFileName()+&quot; zmazany \n &quot;+fabToDelete.toString();</span>
<span class="fc" id="L606">				Adminlog.add(Adminlog.TYPE_FILE_ARCHIVE, fileDescription, user.getUserId(), -1);</span>
			}
		}

<span class="fc" id="L610">		return isSuccess;</span>
	}

	/** Zisti ci na subor ktory chceme nahrat uz v databaze neexistovala URL a subor bol zmazany bez zmazania zaznamu o subore
	 *
	 */
	public static boolean existsPathInDB(String path)
	{
<span class="pc bpc" id="L618" title="2 of 4 branches missed.">		if(path != null &amp;&amp; path.lastIndexOf(&quot;/&quot;)+1 &lt; path.length())</span>
		{
<span class="fc" id="L620">			String filePath = path.substring(0,path.lastIndexOf(&quot;/&quot;)+1);</span>
<span class="fc" id="L621">			String fileName = path.substring(path.lastIndexOf(&quot;/&quot;)+1);</span>
<span class="pc bpc" id="L622" title="1 of 2 branches missed.">			return FileArchivatorDB.getByPath(filePath, fileName) != null;</span>
		}
<span class="nc" id="L624">		return false;</span>
	}

	/**Skontroluje konzisteciu suborov, ak niektory chyba, vrati naplneny string. Pozor ! Vypoctovo narocne, prechadza vsetky zaznamy v DB a fyzicky kontroluje ci subory existuju
	 *
	 */
	public static String checkFileConsistency()
	{
<span class="nc" id="L632">		StringBuilder result = new StringBuilder();</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">		for(FileArchivatorBean fab: FileArchivatorDB.getInstance().getAll())</span>
		{
<span class="nc bnc" id="L635" title="All 2 branches missed.">			if(!FileTools.isFile(fab.getFilePath()+fab.getFileName()))</span>
<span class="nc" id="L636">				result.append(&quot;Error file &quot;).append(fab.getFilePath()).append(fab.getFileName()).append(&quot; is missing ! Id: &quot;)</span>
<span class="nc" id="L637">						 .append(fab.getId()).append(&quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L638">		}</span>
<span class="nc" id="L639">		return result.toString();</span>
	}

	/** Ziska security hash zo stringu, pri chybe vrati prazdny string
	 *
	 */
	public static String getSecurityHash(String input)
	{
<span class="fc" id="L647">		String ret = &quot;&quot;;</span>
		try{
<span class="fc" id="L649">			String source = input + input.length();</span>
<span class="fc" id="L650">			MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);</span>
<span class="fc" id="L651">			md.update(source.getBytes());</span>
<span class="fc" id="L652">			byte[] byteData = md.digest();</span>
<span class="fc" id="L653">			StringBuilder sb = new StringBuilder();</span>
<span class="fc bfc" id="L654" title="All 2 branches covered.">			for (byte byteDatum : byteData) {</span>
<span class="fc" id="L655">				sb.append(Integer.toString((byteDatum &amp; 0xff) + 0x100, 16).substring(1));</span>
			}
<span class="fc" id="L657">			ret = sb.toString();</span>
		}
<span class="nc" id="L659">		catch (Exception e)</span>
		{
<span class="nc" id="L661">			Logger.debug(FileArchivatorKit.class, &quot;Problem generating security hash. Cause: &quot; + e.getMessage());</span>
<span class="fc" id="L662">		}</span>
<span class="fc" id="L663">		return ret;</span>
	}

	/** Ak uz fyzicky existuje subor s rovnakym hash-om, vratime list beanov, inak null
	 *
	 */
	public static List&lt;FileArchivatorBean&gt; existSameFiles(FileArchivatorBean newFab, boolean removePattern)
	{
<span class="fc" id="L671">		List&lt;FileArchivatorBean&gt; returnList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L672">		List&lt;FileArchivatorBean&gt; fabHashList = FileArchivatorDB.getByHash(newFab);</span>

		// fabHashList.size() &gt; 1 preto, lebo 1 je newFab
<span class="pc bpc" id="L675" title="2 of 4 branches missed.">		if(fabHashList != null &amp;&amp; fabHashList.size() &gt; 1)</span>
		{

<span class="nc bnc" id="L678" title="All 2 branches missed.">			for(FileArchivatorBean fab: fabHashList )</span>
			{
				//odstranime prave nahraty subor, archivy a vzory
<span class="nc bnc" id="L681" title="All 8 branches missed.">				if(fab.getId() != newFab.getId() &amp;&amp; fab.getReferenceId() == -1 &amp;&amp; (!removePattern || Tools.isEmpty(fab.getReferenceToMain())))</span>
				{
<span class="nc" id="L683">					returnList.add(fab);</span>
				}
<span class="nc" id="L685">			}</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">			if(returnList.size() &gt; 0)</span>
<span class="nc" id="L687">				return returnList;</span>
		}
<span class="fc" id="L689">		return null;</span>
	}

	/** Zmaze celu cache archivu suborov na vsetkych nodoch ak je systemova premenna &quot;fileArchiv-delete-cache-public-node&quot;
	 *
	 *
	 */
	public static void deleteFileArchiveCache()
	{
		//refresh aktualneho nodu node
<span class="fc" id="L699">		Cache.getInstance().removeObjectStartsWithName(FileArchivatorDB.getCachePrefix());</span>

		//refresh nodov clustra
<span class="pc bpc" id="L702" title="1 of 2 branches missed.">		if(ClusterDB.isServerRunningInClusterMode() &amp;&amp;</span>
<span class="pc bpc" id="L703" title="1 of 2 branches missed.">			Constants.getBoolean(FileArchivatorDB.getCachePrefix()+&quot;delete-cache-public-node&quot;))</span>
		{
<span class="fc" id="L705">			 ClusterDB.addRefresh(&quot;sk.iway.iwcm.Cache-&quot; + FileArchivatorDB.getCachePrefix());</span>
		}
<span class="fc" id="L707">	}</span>

	public static int generateNextGlobalId()
	{
<span class="fc" id="L711">		return PkeyGenerator.getNextValue(&quot;file_archiv_global_id&quot;);//nn_file_archives_global_id</span>
	}

	/**
	 * vymazanie aktualneho suboru z vlakna a jeho nahradenie predchadzajucim suborom z vlakna
	 *
	 */
	public static boolean rollback(int fabId, UserDetails user)
	{
<span class="nc" id="L720">		boolean result = true;</span>
<span class="nc" id="L721">		FileArchivatorBean actualFab = FileArchivatorDB.getInstance().getById(fabId);</span>
<span class="nc bnc" id="L722" title="All 4 branches missed.">        if(user == null || !user.isFolderWritable(&quot;/&quot;+actualFab.getFilePath()))</span>
        {
<span class="nc bnc" id="L724" title="All 2 branches missed.">            Logger.debug(FileArchivatorKit.class, &quot;Pouzivatel &quot;+((user != null)?&quot;id: &quot;+user.getUserId():&quot;null&quot;)+&quot; nema pravo na ROLLBACK suboru: &quot;+actualFab.getFilePath()+actualFab.getFileName()+&quot; &quot;);</span>
<span class="nc" id="L725">            return false;</span>
        }

<span class="nc" id="L728">		FileArchivatorBean previousFab = FileArchivatorDB.getPrevious(fabId);</span>
<span class="nc bnc" id="L729" title="All 2 branches missed.">		if(previousFab != null)</span>
		{

<span class="nc" id="L732">			IwcmFile iFileActual = new IwcmFile(Tools.getRealPath(actualFab.getFilePath()+actualFab.getFileName()));</span>
<span class="nc" id="L733">			IwcmFile renamed = new IwcmFile(Tools.getRealPath(actualFab.getFilePath()+actualFab.getFileName()));</span>
<span class="nc" id="L734">			IwcmFile iFilePrevious = new IwcmFile(Tools.getRealPath(previousFab.getFilePath()+previousFab.getFileName()));</span>
<span class="nc bnc" id="L735" title="All 8 branches missed.">			if(iFilePrevious.exists() &amp;&amp; iFileActual.exists() &amp;&amp; iFileActual.delete() &amp;&amp; iFilePrevious.renameTo(renamed))</span>
			{
<span class="nc" id="L737">				previousFab.setFilePath(actualFab.getFilePath());</span>
<span class="nc" id="L738">				previousFab.setFileName(actualFab.getFileName());</span>
<span class="nc" id="L739">				previousFab.setReferenceId(-1);</span>
<span class="nc" id="L740">				previousFab.setOrderId(-1);</span>
<span class="nc" id="L741">				int reference = actualFab.getId();</span>

<span class="nc bnc" id="L743" title="All 2 branches missed.">				if(actualFab.delete())</span>
				{
<span class="nc bnc" id="L745" title="All 2 branches missed.">					if(previousFab.save())</span>
					{
<span class="nc" id="L747">						List&lt;FileArchivatorBean&gt; files = FileArchivatorDB.getByReferenceId(reference);</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">						if(files!=null)</span>
						{
<span class="nc bnc" id="L750" title="All 2 branches missed.">							for(FileArchivatorBean file:files)</span>
							{
<span class="nc" id="L752">								file.setReferenceId(previousFab.getId());</span>
<span class="nc" id="L753">								file.setOrderId(file.getOrderId()-1);</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">								if(!file.save())</span>
								{
<span class="nc" id="L756">									Logger.error(FileArchivatorKit.class, &quot;Chyba pri editacii vlakna :&quot;+file.toString());</span>
<span class="nc" id="L757">									result = false;</span>
								}
<span class="nc" id="L759">							}</span>
						}
<span class="nc" id="L761">                        Adminlog.add(Adminlog.TYPE_FILE_ARCHIVE, &quot;EDIT: File Archiv ROLLBACK zmeny:&quot;+FileArchivatorKit.getPojoZmeny(previousFab, actualFab), actualFab.getId(), previousFab.getId());</span>
<span class="nc" id="L762">						return result;</span>
					}
					else
<span class="nc" id="L765">						Logger.error(FileArchivatorKit.class, &quot;Chyba pri ukladani do DB :&quot;+previousFab.toString());</span>
				}
				else
<span class="nc" id="L768">					Logger.error(FileArchivatorKit.class, &quot;Chyba pri vymazavani z DB :&quot;+actualFab.toString());</span>
<span class="nc" id="L769">			}</span>
			else
<span class="nc" id="L771">				Logger.error(FileArchivatorKit.class, &quot;Chyba pri premenovani suboru :&quot;+previousFab.getFilePath()+actualFab.getFileName()+&quot; na &quot;+actualFab.getFilePath()+actualFab.getFileName());</span>
<span class="nc" id="L772">		}</span>
		else
<span class="nc" id="L774">			Logger.error(FileArchivatorKit.class, &quot;Nepodarilo sa vykonat rollback: neexistujuci hlavny subor, alebo ziadny predchadzajuci subor vo vlakne. Id :&quot;+fabId);</span>

<span class="nc" id="L776">		return false;</span>
	}

    public static Collection&lt;String&gt; createCollection(String paramName, HttpServletRequest req)
    {
<span class="nc" id="L781">        String[] propertyArray = Tools.getTokens(Tools.getParameter(req,paramName), &quot;+&quot;);</span>
<span class="nc bnc" id="L782" title="All 4 branches missed.">        if(propertyArray != null &amp;&amp; propertyArray.length &gt; 0)</span>
<span class="nc" id="L783">            return Arrays.asList(propertyArray);</span>
<span class="nc" id="L784">        return null;</span>
    }

    public static String getVal(HttpServletRequest request, String parameterName)
    {
<span class="nc bnc" id="L789" title="All 2 branches missed.">        if(request.getParameter(parameterName) == null)</span>
<span class="nc" id="L790">            return &quot;&quot;;</span>
<span class="nc" id="L791">        return Tools.getParameter(request,parameterName);</span>
    }

    public static String getIconClass(FileArchivatorBean fab)
    {
<span class="nc" id="L796">        String extension = FileArchivatorKit.getFileExtension(fab.getFileName());</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">        if(&quot;.pdf&quot;.equals(extension))</span>
<span class="nc" id="L798">            return &quot;pdf&quot;;</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">        if(&quot;.rtf&quot;.equals(extension))</span>
<span class="nc" id="L800">            return &quot;rtf&quot;;</span>
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if(&quot;.mp3&quot;.equals(extension))</span>
<span class="nc" id="L802">            return &quot;mp3&quot;;</span>
<span class="nc bnc" id="L803" title="All 4 branches missed.">        if(&quot;.xls&quot;.equals(extension) || &quot;.xlsx&quot;.equals(extension))</span>
<span class="nc" id="L804">            return &quot;xls&quot;;</span>
<span class="nc bnc" id="L805" title="All 4 branches missed.">        if(&quot;.doc&quot;.equals(extension) || &quot;.docx&quot;.equals(extension))</span>
<span class="nc" id="L806">            return &quot;doc&quot;;</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">        if(&quot;.csv&quot;.equals(extension))</span>
<span class="nc" id="L808">            return &quot;csv&quot;;</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">        if(&quot;.exe&quot;.equals(extension))</span>
<span class="nc" id="L810">            return &quot;exe&quot;;</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">        if(&quot;.txt&quot;.equals(extension))</span>
<span class="nc" id="L812">            return &quot;txt&quot;;</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">        if(&quot;.zip&quot;.equals(extension))</span>
<span class="nc" id="L814">            return &quot;zip&quot;;</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">        if(&quot;.rar&quot;.equals(extension))</span>
<span class="nc" id="L816">            return &quot;rar&quot;;</span>
<span class="nc" id="L817">        return &quot;notFound&quot;;</span>
    }

    /** bean ulozeny v ResultArchivBean.fab je potrebne ulozit.
     *
     * @param fab FileArchivatorBean (Musi mat vyplneny filePath - cestu k subroru bez lomitka na zaciatku (napr files/archiv/89/) a fileName - nazov suboru s priponou (priloha_1.pdf) a userId - id usera ktory subor nahrava)
     * @param oldId - id suboru, ktory aktualizujeme
     * @return ResultArchivBean
     */
    //prepareAndValidate
    public ResultArchivBean prepareAndValidate(FileArchivatorBean fab, int oldId, UserDetails user)
    {
<span class="nc" id="L829">        return prepareAndValidate(fab, oldId, user, false) ;</span>
    }

    public ResultArchivBean prepareAndValidate(FileArchivatorBean fab, int oldId, UserDetails user, boolean isEdit)
    {
<span class="nc" id="L834">        ResultArchivBean resultBean = new ResultArchivBean();</span>
<span class="nc bnc" id="L835" title="All 2 branches missed.">        if(errorsList == null)</span>
<span class="nc" id="L836">            errorsList = new ArrayList&lt;&gt;();</span>
        else
<span class="nc" id="L838">            errorsList.clear();</span>

<span class="nc bnc" id="L840" title="All 2 branches missed.">        if(user == null)</span>
        {
<span class="nc" id="L842">            return addErrorMessageAndReturnFalse(&quot;error.userNotLogged&quot;);</span>
        }

<span class="nc bnc" id="L845" title="All 4 branches missed.">        if(!isEdit &amp;&amp; FileArchivatorKit.existsPathInDB(fab.getFilePath()+fab.getFileName()))</span>
        {
<span class="nc" id="L847">            return addErrorMessageAndReturnFalse(&quot;components.file_archiv.file_exists&quot;);</span>
        }

<span class="nc bnc" id="L850" title="All 2 branches missed.">        if(Tools.isEmpty(fab.getVirtualFileName()))</span>
        {
<span class="nc" id="L852">            return addErrorMessageAndReturnFalse(&quot;components.file_archiv.file_virtual_cannot_be_empty&quot;);</span>
        }

<span class="nc" id="L855">        IwcmFile file = new IwcmFile(Tools.getRealPath(fab.getFilePath()+fab.getFileName()));</span>

<span class="nc" id="L857">        fab.setUserId(user.getUserId());</span>
<span class="nc" id="L858">        fab.setMd5(FileArchivatorKit.getMD5(file));</span>
<span class="nc" id="L859">        fab.setFileSize(file.length());</span>
<span class="nc" id="L860">        fab.setDomainId(CloudToolsForCore.getDomainId());</span>
<span class="nc" id="L861">        resultBean.setFab(fab);</span>
        // Logger.debug(SaveFileAction.class, &quot;saveFile() IP: &quot;+Tools.getRemoteIP(getRequest())+&quot; file: &quot;+fileName+&quot;,&quot;+param_oldId_name+&quot;:&quot;+getOldId());

<span class="nc" id="L864">        boolean isDestinationFolderWritable = true;</span>
        //kontrola prav na zapis do suboru
<span class="nc bnc" id="L866" title="All 2 branches missed.">        if(!user.isFolderWritable(fab.getFilePath()))</span>
        {
<span class="nc" id="L868">            Logger.debug(FileArchivatorKit.class, &quot;User nema pravo na zapis do priecinku:  &quot;+fab.getFilePath());</span>
<span class="nc" id="L869">            setError(&quot;components.elfinder.commands.upload.error&quot;);</span>
<span class="nc" id="L870">            isDestinationFolderWritable = false;</span>
        }

<span class="nc bnc" id="L873" title="All 4 branches missed.">        if (isDestinationFolderWritable &amp;&amp; checkFileProperties(file.getName(), file.getLength(), fab.getFilePath()+fab.getFileName(),oldId))</span>
        {
<span class="nc bnc" id="L875" title="All 2 branches missed.">            if(setFilePropertiesAfterUpload(fab,oldId))</span>
            {
<span class="nc" id="L877">                resultBean.setSuccess(true);</span>
<span class="nc" id="L878">                return resultBean;</span>
            }
        }

<span class="nc" id="L882">        resultBean.setErrors(errorsList);</span>
<span class="nc" id="L883">        resultBean.setSuccess(false);</span>
<span class="nc" id="L884">        return resultBean;</span>
    }

    private ResultArchivBean addErrorMessageAndReturnFalse(String propText)
    {
<span class="nc" id="L889">        setError(propText);</span>
<span class="nc" id="L890">        ResultArchivBean rab = new ResultArchivBean();</span>
<span class="nc" id="L891">        rab.setErrors(errorsList);</span>
<span class="nc" id="L892">        rab.setSuccess(false);</span>
<span class="nc" id="L893">        return rab;</span>
    }

    protected void setError(String key)
    {
<span class="nc" id="L898">        addErrorText(prop.getText(key));</span>
<span class="nc" id="L899">    }</span>

    private void setError(String key, String param1)
    {
<span class="nc" id="L903">        addErrorText(prop.getText(key, param1));</span>
<span class="nc" id="L904">    }</span>

    private void setError(String key, String param1, String param2)
    {
<span class="nc" id="L908">        addErrorText(prop.getText(key, param1, param2));</span>
<span class="nc" id="L909">    }</span>

    private void addErrorText(String text)
    {
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if(errorsList == null)</span>
<span class="nc" id="L914">            errorsList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L915">        errorsList.add(text);</span>
<span class="nc" id="L916">    }</span>

	 public boolean checkFileProperties(String fileName, long length, String pathName, int oldId)
	 {
		  // errorsList = new ArrayList&lt;String&gt;();
<span class="nc bnc" id="L921" title="All 4 branches missed.">		  if(fileName == null || fileName.length() &lt; 5)</span>
		  {
<span class="nc" id="L923">				Logger.debug(SaveFileAction.class, &quot;checkFileProperties() fileName je null alebo ma kratky nazov. Subor: &quot;+fileName);</span>
<span class="nc" id="L924">				setError(&quot;components.file_archiv.upload.file_not_exists_or_short_name&quot;, fileName);</span>
<span class="nc" id="L925">				return false;</span>
		  }

<span class="nc bnc" id="L928" title="All 2 branches missed.">		  if(!hasAllowedExtensions(fileName, oldId))</span>
		  {
<span class="nc" id="L930">				return false;</span>
		  }

<span class="nc bnc" id="L933" title="All 2 branches missed.">		  if(length &gt;= getMaxFileSize())</span>
		  {
<span class="nc" id="L935">				Logger.debug(SaveFileAction.class, &quot;Velkost suboru je prekrocena. Aktualna velkost: &quot;+length+&quot; maximalna velkost: &quot;+getMaxFileSize());</span>
<span class="nc" id="L936">				setError(&quot;components.file_archiv.upload.file_is_too_big&quot;, length+&quot;&quot;, getMaxFileSize()+&quot;&quot;);</span>
<span class="nc" id="L937">				return false;</span>
		  }


		  //ak uz existuje referencia v databaze k suboru ktory este len ideme nahrat, tak je to problem. Niekto zmazal subor rucne.
		  //subor nemozeme nahrat pretoze by mohol byt zmazany inym zaznamom v databaze - omylom
<span class="nc bnc" id="L943" title="All 4 branches missed.">		  if(FileArchivatorKit.existsPathInDB(pathName) &amp;&amp; !FileTools.isFile(pathName) )</span>
		  {
<span class="nc" id="L945">				setError(&quot;components.file_archiv.upload.db_enrty_exists&quot;);</span>
<span class="nc" id="L946">				return false;</span>
		  }

<span class="nc" id="L949">		  return true;</span>
	 }

    /** Sluzi na validaciu {@link FileArchivatorBean} pred ulozenim. Skontroluje velkost suboru, priponu atd.
     * @return Ak vrati true, mozeme {@link FileArchivatorBean} ulozit.
     */
    public boolean hasAllowedExtensions(String fileName, int oldId)
    {
<span class="pc bpc" id="L957" title="1 of 2 branches missed.">        if(Tools.isEmpty(fileName))</span>
        {
<span class="nc" id="L959">            setError(&quot;components.file_archiv.upload.file_is_null&quot;);</span>
<span class="nc" id="L960">            return false;</span>
        }

        //nahravam novu verziu dokumentu, musia ma rovnaku priponu
<span class="pc bpc" id="L964" title="1 of 2 branches missed.">        if(oldId &gt; 0)</span>
        {
<span class="nc" id="L966">	        FileArchivatorBean fab = FileArchivatorDB.getInstance().getById(oldId);</span>
<span class="nc bnc" id="L967" title="All 2 branches missed.">	        if(fab != null)</span>
	        {
<span class="nc bnc" id="L969" title="All 2 branches missed.">		        if(getFileExtension(fab.getFileName()).equalsIgnoreCase(getFileExtension(fileName)))</span>
<span class="nc" id="L970">		        	return true;</span>
		        else
<span class="nc" id="L972">		            setError(&quot;components.file_archiv.upload.file_shoud_have_end_with&quot;,getFileExtension(fab.getFileName()));</span>
	        }
	        else
	        {
<span class="nc" id="L976">		        setError(&quot;components.file_archiv.upload.wrong_oldId&quot;, String.valueOf(oldId));</span>
	        }
<span class="nc" id="L978">        }</span>
        else
        {
<span class="pc bpc" id="L981" title="1 of 2 branches missed.">	        if(Tools.containsOneItem(Tools.getTokens(Constants.getString(&quot;fileArchivAllowExt&quot;), &quot;,&quot;), getFileExtension(fileName)))</span>
<span class="fc" id="L982">	        	return true;</span>
	        else
	        {
<span class="nc" id="L985">		        Logger.debug(SaveFileAction.class, &quot;File &quot;+fileName+&quot; has not allowed extension. Allowed extensions : &quot;+Constants.getString(&quot;fileArchivAllowExt&quot;));</span>
<span class="nc" id="L986">		        setError(&quot;components.file_archiv.upload.file_not_allowed_extensions&quot;, Constants.getString(&quot;fileArchivAllowExt&quot;) , getFileExtension(fileName));</span>
	        }
        }

<span class="nc" id="L990">        return false;</span>
    }

    public static long getMaxFileSize()
    {
<span class="fc" id="L995">        return Tools.getIntValue(Constants.getString(&quot;fileArchivMaxUploadFileSize&quot;), 60000000);</span>
    }

    public boolean setFilePropertiesAfterUpload(FileArchivatorBean newFab, int oldId)
    {
<span class="nc bnc" id="L1000" title="All 2 branches missed.">        if(!FileTools.isFile(newFab.getFilePath()+newFab.getFileName()))</span>
        {
<span class="nc" id="L1002">            addErrorText(prop.getText(&quot;components.import_web_pages.import_error&quot;));</span>
<span class="nc" id="L1003">            return false;</span>
        }

<span class="nc" id="L1006">        newFab.setDomainId(CloudToolsForCore.getDomainId());</span>

        //ak uz existuje nejaka starsia verzia naseho suboru
<span class="nc" id="L1009">        boolean result = true;</span>
<span class="nc" id="L1010">        boolean newVersion = false;</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">        if(oldId &gt; 0)</span>
        {
<span class="nc" id="L1013">            newVersion = true;</span>
<span class="nc" id="L1014">            FileArchivatorBean oldFab = FileArchivatorDB.getInstance().getById(oldId);</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">            if(oldFab == null)</span>
            {
<span class="nc" id="L1017">                Logger.debug(FileArchivatorKit.class, &quot;setFilePropertiesAfterUpload() fileBean == null&quot;);</span>
<span class="nc" id="L1018">                addErrorText(prop.getText(&quot;components.file_archiv.older_file_not_exists&quot;));</span>
<span class="nc" id="L1019">                return false;</span>
            }

<span class="nc bnc" id="L1022" title="All 2 branches missed.">            if(!newFab.getFilePath().equals(oldFab.getFilePath()))</span>
            {
<span class="nc" id="L1024">                Logger.debug(FileArchivatorKit.class, &quot;zdrojovy a cielovy priecinok, nie su rovnake&quot;);</span>
<span class="nc" id="L1025">                addErrorText(prop.getText(&quot;components.file_archiv.source_and_destination_file_different&quot;));</span>
<span class="nc" id="L1026">                return false;</span>
            }

            //premenujeme (vymenime) subory stary-&gt;novy a novy-&gt;stary
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if(FileArchivatorKit.renameFile(newFab.getFilePath(), newFab.getFileName(), oldFab))</span>
            {
                //premenujeme v DB
<span class="nc" id="L1033">                String tempNameUrl = oldFab.getFileName();</span>
<span class="nc" id="L1034">                oldFab.setFileName(newFab.getFileName());</span>
<span class="nc" id="L1035">                newFab.setFileName(tempNameUrl);</span>
                //premenujeme aj cestu
<span class="nc" id="L1037">                tempNameUrl = oldFab.getFilePath();</span>
<span class="nc" id="L1038">                oldFab.setFilePath(newFab.getFilePath());</span>
<span class="nc" id="L1039">                newFab.setFilePath(tempNameUrl);</span>
                //ak ideme na newFab nastavovat referenciu, musi byt ulozeny aby mal vytvorene ID.
<span class="nc bnc" id="L1041" title="All 2 branches missed.">                if(newFab.getId() &lt;= 0)</span>
<span class="nc" id="L1042">                    newFab.save();</span>
                //zmenime referenciu v hlavnom subore
<span class="nc" id="L1044">                oldFab.setReferenceId(newFab.getId());</span>

<span class="nc" id="L1046">                newFab.setCategory(oldFab.getCategory());</span>
<span class="nc" id="L1047">                newFab.setVirtualFileName(oldFab.getVirtualFileName());</span>
<span class="nc" id="L1048">                newFab.setFieldA(oldFab.getFieldA());</span>
<span class="nc" id="L1049">                newFab.setFieldB(oldFab.getFieldB());</span>

                //globalne id je rovnake pre vsetky subory vo vlakne.
<span class="nc" id="L1052">                newFab.setGlobalId(oldFab.getGlobalId());</span>
<span class="nc bnc" id="L1053" title="All 4 branches missed.">                if(!oldFab.save() || !newFab.save())</span>
                {
<span class="nc" id="L1055">                    result = false;</span>
                }
                else
                {
<span class="nc" id="L1059">                    addSaveLogToAdminlog(newFab, newVersion);</span>
                }



                //zmenime referenciu u suborov, ktore na neho odkazuju (a po novom budu odkazovat na novy subor)
<span class="nc bnc" id="L1065" title="All 2 branches missed.">                if(!FileArchivatorKit.reSetReference(oldId, newFab.getId()))</span>
<span class="nc" id="L1066">                    result = false;</span>

                //posunieme order_id o jednu uroven
<span class="nc" id="L1069">                FileArchivatorKit.incrementOrderId(newFab.getId());</span>
<span class="nc" id="L1070">                return result;</span>
            }
            else
            {
<span class="nc" id="L1074">                addErrorText(prop.getText(&quot;components.file_archiv.rename_error&quot;));</span>
<span class="nc" id="L1075">                return false;</span>
            }
        }
        else
        {
            //novemu suboru vo vlakne nastavime nove globalne ID
<span class="nc" id="L1081">            newFab.setGlobalId(FileArchivatorKit.generateNextGlobalId());</span>
<span class="nc" id="L1082">            addSaveLogToAdminlog(newFab, newVersion);</span>
<span class="nc" id="L1083">            newFab.save();</span>
        }

<span class="nc" id="L1086">        return true;</span>
    }

    private static void addSaveLogToAdminlog(FileArchivatorBean fab, boolean newVersion)
    {
<span class="fc" id="L1091">        addSaveLogToAdminlog(fab, newVersion, false);</span>
<span class="fc" id="L1092">    }</span>

    private static void addSaveLogToAdminlog(FileArchivatorBean fab, boolean newVersion, boolean replace)
    {
<span class="fc" id="L1096">        String strNewVersion = &quot;&quot;;</span>
<span class="pc bpc" id="L1097" title="1 of 2 branches missed.">        if(newVersion)</span>
<span class="nc" id="L1098">            strNewVersion = &quot;(Aktualizacia existujuceho suboru) &quot;;</span>
<span class="pc bpc" id="L1099" title="1 of 2 branches missed.">        if(replace)</span>
<span class="nc" id="L1100">            strNewVersion = &quot;(Nahradenie povodneho suboru) &quot;;</span>

<span class="fc" id="L1102">        Adminlog.add(Adminlog.TYPE_FILE_ARCHIVE, &quot;EDIT: File Archiv &quot;+strNewVersion+&quot;ulozenie:\n&quot;+fab.toString(true), fab.getId(), -1);</span>
<span class="fc" id="L1103">    }</span>

    public static String getPojoZmeny(Object newObj,Object originalObj)
    {
<span class="nc bnc" id="L1107" title="All 4 branches missed.">        if(newObj == null || originalObj == null)</span>
<span class="nc" id="L1108">            return &quot;Bez zmeny&quot;;</span>
<span class="nc" id="L1109">        BeanDiff diff = new BeanDiff().setNew(newObj).setOriginal(originalObj);</span>
<span class="nc" id="L1110">        return new BeanDiffPrinter(diff).toString();</span>
    }

	public List&lt;String&gt; getErrorsList()
	{
<span class="nc" id="L1115">		return errorsList;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>