<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LogonTools.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjetcms</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.common</a> &gt; <span class="el_source">LogonTools.java</span></div><h1>LogonTools.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.common;

import java.lang.reflect.Method;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;

import sk.iway.Password;
import sk.iway.iwcm.Adminlog;
import sk.iway.iwcm.Cache;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DB;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.Identity;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.PageLng;
import sk.iway.iwcm.PathFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.i18n.Prop;
import sk.iway.iwcm.stat.StatDB;
import sk.iway.iwcm.stripes.AfterLogonLogoffInterceptor;
import sk.iway.iwcm.system.multidomain.MultiDomainFilter;
import sk.iway.iwcm.system.spring.WebjetAuthentificationProvider;
import sk.iway.iwcm.users.PasswordSecurity;
import sk.iway.iwcm.users.PasswordsHistoryBean;
import sk.iway.iwcm.users.PermissionGroupBean;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UserGroupsDB;
import sk.iway.iwcm.users.UsersDB;

public class LogonTools {

<span class="nc" id="L50">    protected LogonTools() {</span>
        //utility class
<span class="nc" id="L52">    }</span>

    /**
     * Skontroluje ci sa moze pouzivatel prihlasit vzhladom na zadane datumy mozneho prihlasenia
     * @param rs
     * @return
     */
    public static boolean checkAllowLoginDates(ResultSet rs)
    {
        try
        {
<span class="fc" id="L63">            java.sql.Date start = rs.getDate(&quot;allow_login_start&quot;);</span>
<span class="fc" id="L64">            java.sql.Date end = rs.getDate(&quot;allow_login_end&quot;);</span>

<span class="fc" id="L66">            long startL = 0;</span>
<span class="fc" id="L67">            long endL = Long.MAX_VALUE;</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">            if (start != null) startL = start.getTime();</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">            if (end != null) endL = end.getTime() + (60*60*24 * 1000);</span>

<span class="fc" id="L71">            long now = Tools.getNow();</span>

<span class="pc bpc" id="L73" title="1 of 4 branches missed.">            if (now &gt; startL &amp;&amp; now &lt; endL) return(true);</span>
        }
<span class="nc" id="L75">        catch (SQLException ex)</span>
        {
<span class="nc" id="L77">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L78">        }</span>
<span class="fc" id="L79">        return(false);</span>
    }

    /**
     *  Description of the Method
     *
     *@param  username  Description of the Parameter
     *@param  password  Description of the Parameter
     *@param  user      Description of the Parameter
     *@param  errors    Description of the Parameter
     *@param  request   Description of the Parameter
     *@return           Description of the Return Value
     */
    public static String logon(String username, String password, Identity user, Map&lt;String, String&gt; errors, HttpServletRequest request, sk.iway.iwcm.i18n.Prop prop)
    {
<span class="fc" id="L94">        String forward = &quot;logon_ok_admin&quot;;</span>

<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (LogonTools.isLoginBlocked(request)) {</span>
<span class="fc" id="L97">            request.setAttribute(&quot;logon.error.blocked&quot;, &quot;1&quot;);</span>
<span class="fc" id="L98">            errors.put(&quot;ERROR_KEY&quot;, prop.getText(&quot;logon.error.blocked&quot;));</span>
<span class="fc" id="L99">            return forward;</span>
        }

<span class="fc" id="L102">        String logonMethod = Constants.getString(&quot;adminLogonMethod&quot;);</span>
<span class="fc" id="L103">        String tryNormalLogon = null;</span>
<span class="fc" id="L104">        String adminUsersAllowNormalLogon = Constants.getString(&quot;adminUsersAllowNormalLogon&quot;); //moznost pre niektore loginy sa prihlasit normalne (ak pouzivame LDAP prihlasovanie)</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;adminLogonMethodAllowNormalTry&quot;)) tryNormalLogon = request.getParameter(&quot;tryNormalLogon&quot;);</span>

<span class="pc bpc" id="L107" title="5 of 6 branches missed.">        if (Tools.isNotEmpty(logonMethod) &amp;&amp; tryNormalLogon==null &amp;&amp; (Tools.isEmpty(adminUsersAllowNormalLogon) ||</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">             Tools.containsOneItem(Tools.getTokens(adminUsersAllowNormalLogon, &quot;,|&quot;), new String[]{username}) == false))</span>
        {
<span class="nc" id="L110">            int i = logonMethod.lastIndexOf('.');</span>
<span class="nc" id="L111">            String beforePostClass = logonMethod.substring(0, i);</span>
<span class="nc" id="L112">            logonMethod = logonMethod.substring(i+1);</span>
            //String
            try
            {
<span class="nc" id="L116">                Class&lt;?&gt; c = Class.forName(beforePostClass);</span>
<span class="nc" id="L117">                Object o = c.getDeclaredConstructor().newInstance();</span>
                Method m;
<span class="nc" id="L119">                Class&lt;?&gt;[] parameterTypes = new Class&lt;?&gt;[] {String.class, String.class, Identity.class, Map.class, HttpServletRequest.class, sk.iway.iwcm.i18n.Prop.class};</span>
<span class="nc" id="L120">                Object[] arguments = new Object[] {username, password, user, errors, request, prop};</span>
<span class="nc" id="L121">                m = c.getMethod(logonMethod, parameterTypes);</span>
<span class="nc" id="L122">                return((String)m.invoke(o, arguments));</span>
            }
<span class="nc" id="L124">            catch (Exception ex)</span>
            {
<span class="nc" id="L126">                sk.iway.iwcm.Logger.error(ex);</span>
            }
        }

<span class="pc bpc" id="L130" title="2 of 4 branches missed.">        if (username == null || password == null)</span>
        {
<span class="nc" id="L132">            return (&quot;&quot;);</span>
        }
<span class="fc" id="L134">        StringBuilder err = new StringBuilder();</span>
        //String user_name = &quot;&quot;;
        //String user_pass =&quot;&quot;;

        try
        {

<span class="fc" id="L141">            Connection db_conn = DBPool.getConnection();</span>
            try
            {
<span class="fc" id="L144">                String sql = &quot;&quot;;</span>
<span class="fc" id="L145">                boolean hasEmailParam = false;</span>

<span class="pc bpc" id="L147" title="3 of 4 branches missed.">                if (request.getParameter(&quot;emailLogon&quot;) != null &amp;&amp; &quot;true&quot;.equalsIgnoreCase(request.getParameter(&quot;emailLogon&quot;)))</span>
                {
<span class="nc" id="L149">                    sql = &quot;SELECT * FROM users WHERE &quot;+DB.fixAiCiCol(&quot;email&quot;)+&quot;=?&quot;;</span>
                }
                else
                {
<span class="fc" id="L153">                    hasEmailParam = true;</span>
<span class="fc" id="L154">                    sql = &quot;SELECT * FROM users WHERE &quot;+DB.fixAiCiCol(&quot;login&quot;)+&quot;=?&quot;+&quot; OR &quot;+DB.fixAiCiCol(&quot;email&quot;)+&quot;=?&quot;;</span>
                }

<span class="fc" id="L157">                sql += UsersDB.getDomainIdSqlWhere(true);</span>

<span class="fc" id="L159">                sql += &quot;ORDER BY is_admin DESC, user_id ASC&quot;;</span>

<span class="fc" id="L161">                PreparedStatement ps = db_conn.prepareStatement(sql);</span>
                try
                {
<span class="fc" id="L164">                    ps.setString(1, DB.fixAiCiValue(username));</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">                    if (hasEmailParam) ps.setString(2, DB.fixAiCiValue(username));</span>
<span class="fc" id="L166">                    ResultSet db_result = ps.executeQuery();</span>
                    try
                    {
<span class="fc bfc" id="L169" title="All 2 branches covered.">                        if (db_result.next())</span>
                        {
                            //skontroluj ci je platny datum prihlasenia
<span class="fc" id="L172">                            boolean allowDateLogin = checkAllowLoginDates(db_result);</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">                            if (allowDateLogin == false)</span>
                            {
<span class="nc" id="L175">                                err.append(&quot;&lt;li&gt;&quot;).append(prop.getText(&quot;logon.err.dateLoginDissabled&quot;, DB.getDbDate(db_result, &quot;allow_login_start&quot;), DB.getDbDate(db_result, &quot;allow_login_end&quot;)));</span>
<span class="nc" id="L176">                                request.setAttribute(&quot;logon.err.dateLoginDissabled&quot;, &quot;true&quot;);</span>

<span class="nc" id="L178">                                Adminlog.add(Adminlog.TYPE_USER_LOGON, &quot;LogonAction - login date disabled: name= &quot; + username, -1, -1);</span>
                            }
                            else
                            {
                                //skontroluj heslo
<span class="fc" id="L183">                                boolean passok = false;</span>
<span class="fc" id="L184">                                String salt = db_result.getString(&quot;password_salt&quot;);</span>
<span class="fc" id="L185">                                String passwordInDb = db_result.getString(&quot;password&quot;);</span>
<span class="fc" id="L186">                                sk.iway.Password pass = new sk.iway.Password();</span>
                                //spatna kompatibilita je potrebna, ak admin zmeni passwordUseHash a zabudne zavolat update_passwords.jsp
<span class="pc bpc" id="L188" title="1 of 4 branches missed.">                                if (pass.encrypt(password).equals(passwordInDb) || PasswordSecurity.isPasswordCorrect(password, salt, passwordInDb))</span>
                                {
<span class="fc" id="L190">                                    passok = true;</span>
                                }
<span class="fc bfc" id="L192" title="All 2 branches covered.">                                if (passok==false)</span>
                                {
                                    //skus overit mobiletoken, pre istotu znova kontroluj header, aby sa nedal pouzit na bezne prihlasenie
<span class="fc bfc" id="L195" title="All 2 branches covered.">                                    if (Tools.isNotEmpty(request.getHeader(Constants.getString(&quot;logonTokenHeaderName&quot;))))</span>
                                    {
                                        try
                                        {
<span class="fc" id="L199">                                            String apiKey = db_result.getString(&quot;api_key&quot;);</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">                                            if (Tools.isNotEmpty(apiKey))</span>
                                            {
                                                //splitni, je to vo formate salt|token
<span class="fc" id="L203">                                                int i = apiKey.indexOf(&quot;|&quot;);</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                                                if (i &gt; 0)</span>
                                                {
<span class="fc" id="L206">                                                    salt = apiKey.substring(0, i);</span>
<span class="fc" id="L207">                                                    passwordInDb = apiKey.substring(i+1);</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">                                                    if (PasswordSecurity.isPasswordCorrect(password, salt, passwordInDb)) passok = true;</span>
                                                }

                                            }
<span class="nc" id="L212">                                        } catch (Exception ex) {</span>
                                            //
<span class="fc" id="L214">                                        }</span>
                                    }
                                }
<span class="fc bfc" id="L217" title="All 2 branches covered.">                                if (passok)</span>
                                {
<span class="fc" id="L219">                                    user.setAuthorized(db_result.getBoolean(&quot;authorized&quot;));</span>

<span class="pc bpc" id="L221" title="1 of 2 branches missed.">                                    if (user.isAuthorized())</span>
                                    {
                                        //je to ok, mozeme ho presunut do hlavneho menu
<span class="fc" id="L224">                                        UsersDB.fillUserDetails(user, db_result);</span>

                                        //user_name = username;
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">                                        if (user.isAdmin())</span>
                                        {
<span class="pc bpc" id="L229" title="2 of 4 branches missed.">                                            if(request.getAttribute(&quot;isMobileVersion&quot;) != null || &quot;true&quot;.equals(request.getParameter(&quot;isMobileVersion&quot;)))</span>
                                            {
<span class="nc" id="L231">                                                forward = &quot;logon_mobile&quot;;</span>
                                            }
                                            else
                                            {
<span class="fc" id="L235">                                                forward = &quot;logon_ok_admin&quot;;</span>
                                            }
<span class="fc" id="L237">                                            Adminlog.add(Adminlog.TYPE_USER_LOGON, user.getUserId(), &quot;LogonAction - user (ADMIN) successfully loged: name=&quot; + username , -1, -1);</span>
                                        }
                                        else
                                        {
<span class="nc" id="L241">                                            Logger.error(LogonTools.class,&quot;user nie je administrator&quot;);</span>
                                            //errors.add(ActionMessages.GLOBAL_ERROR, new ActionMessage(&quot;error.logon.noadmin&quot;));
<span class="nc" id="L243">                                            err.append(&quot;&lt;li&gt;&quot;).append(prop.getText(&quot;logon.err.noadmin&quot;));</span>
<span class="nc" id="L244">                                            request.setAttribute(&quot;logon.err.noadmin&quot;, &quot;true&quot;);</span>
                                            //return (mapping.findForward(forward));

<span class="nc bnc" id="L247" title="All 2 branches missed.">                                            if (Constants.getBoolean(&quot;auditDontLogUsrlogon&quot;)==false) Adminlog.add(Adminlog.TYPE_USER_LOGON, user.getUserId(), &quot;LogonAction - user successfully loged: name=&quot; + username , -1, -1);</span>
                                        }

<span class="fc" id="L250">                                        setUserPerms(user);</span>
                                    }
                                    else
                                    {
<span class="nc" id="L254">                                        err = new StringBuilder(&quot;&lt;li&gt;&quot;).append(prop.getText(&quot;logon.err.userUnknown&quot;));</span>
<span class="nc" id="L255">                                        request.setAttribute(&quot;logon.err.userUnknown&quot;, &quot;true&quot;);</span>

<span class="nc" id="L257">                                        Adminlog.add(Adminlog.TYPE_USER_LOGON, &quot;LogonAction - user not authorized: name= &quot; + username, -1, -1);</span>
                                    }
                                }
                                else
                                {
<span class="fc" id="L262">                                    Logger.error(LogonTools.class,&quot;zle heslo&quot;);</span>
                                    //ma zle heslo, napis chybu
                                    //errors.add(ActionMessages.GLOBAL_ERROR, new ActionMessage(&quot;error.logon.wrong.pass&quot;));
<span class="fc" id="L265">                                    err.append(&quot;&lt;li&gt;&quot;).append(prop.getText(&quot;logon.err.wrongPass&quot;));</span>
<span class="fc" id="L266">                                    request.setAttribute(&quot;logon.err.wrongPass&quot;, &quot;true&quot;);</span>

<span class="fc" id="L268">                                    Adminlog.add(Adminlog.TYPE_USER_LOGON, &quot;LogonAction - wrong password: name= &quot; + username, -1, -1);</span>
                                }
                            }

<span class="fc" id="L272">                        }</span>
                        else
                        {
<span class="fc" id="L275">                            Logger.error(LogonTools.class,&quot;user neexistuje&quot;);</span>
                            //zadany user neexistuje
                            //errors.add(ActionMessages.GLOBAL_ERROR, new ActionMessage(&quot;error.logon.user.unknown&quot;));
<span class="fc" id="L278">                            err.append(&quot;&lt;li&gt;&quot;).append(prop.getText(&quot;logon.err.userUnknown&quot;));</span>
<span class="fc" id="L279">                            request.setAttribute(&quot;logon.err.userUnknown&quot;, &quot;true&quot;);</span>

<span class="fc" id="L281">                            Adminlog.add(Adminlog.TYPE_USER_LOGON, &quot;LogonAction - user unknown: name= &quot; + username, -1, -1);</span>
                        }
                    }
<span class="fc" id="L284">                    finally { db_result.close(); }</span>
                }
<span class="fc" id="L286">                finally { ps.close(); }</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">                if (user.getUserId()&gt;0)</span>
                {
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">                    if (user.isAuthorized()==false)</span>
                    {
                        //Logger.println(this,&quot;JE neautorizovany!!&quot;);
                        //ak nie je autorizovany, napis iba ze user neexistuje a nezaoberaj sa heslom
<span class="nc" id="L293">                        err = new StringBuilder(&quot;&lt;li&gt;&quot;).append(prop.getText(&quot;logon.err.userUnknown&quot;));</span>
<span class="nc" id="L294">                        request.setAttribute(&quot;logon.err.userUnknown&quot;, &quot;true&quot;);</span>

<span class="nc" id="L296">                        Adminlog.add(Adminlog.TYPE_USER_LOGON, &quot;LogonAction - user unknown: name= &quot; + username, -1, -1);</span>
                    }
                    else
                    {
                        //nacitaj pristupove prava
<span class="fc" id="L301">                        UsersDB.setDisabledItems(user);</span>

<span class="fc" id="L303">                        ps = db_conn.prepareStatement(&quot;UPDATE  users SET last_logon=? WHERE user_id=?&quot;);</span>
                        try
                        {
<span class="fc" id="L306">                            ps.setTimestamp(1, new Timestamp( (new java.util.Date()).getTime()));</span>
<span class="fc" id="L307">                            ps.setInt(2, user.getUserId());</span>
<span class="fc" id="L308">                            ps.execute();</span>
                        }
<span class="fc" id="L310">                        finally { ps.close(); }</span>
                    }
                }
            }
<span class="fc" id="L314">            finally { db_conn.close(); }</span>
        }
<span class="nc" id="L316">        catch (Exception ex)</span>
        {
<span class="nc" id="L318">            Logger.error(LogonTools.class,&quot;LogonAction: error&quot;);</span>
<span class="nc" id="L319">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L320">        }</span>

<span class="fc bfc" id="L322" title="All 2 branches covered.">        if (err.toString().trim().length()&gt;1)</span>
        {
<span class="fc" id="L324">            errors.put(&quot;ERROR_KEY&quot;, prop.getText(&quot;approveAction.err.badPass&quot;));</span>
            //aby sa vzdy zobrazil dialog poslat heslo
<span class="fc" id="L326">            request.setAttribute(&quot;logon.err.wrongPass&quot;, &quot;true&quot;);</span>

<span class="fc" id="L328">            setLoginBlocked(request);</span>
        }

<span class="fc" id="L331">        return (forward);</span>
    }


    /**
     * Nastavi userovi prava na adresare (editable groups a pages)
     * @param user
     */
    public static void setUserPerms(Identity user)
    {
        try
        {
<span class="fc bfc" id="L343" title="All 4 branches covered.">            if (user.getEditablePages().length()&gt;0 &amp;&amp; user.getEditableGroups().length()==0)</span>
            {
<span class="fc" id="L345">                user.setEditableGroups(Integer.toString(Constants.getInt(&quot;systemPagesMyPages&quot;)));</span>
            }

            //#23245
<span class="fc" id="L349">            StringBuilder permWritableFolders = new StringBuilder();</span>
<span class="fc" id="L350">            List&lt;PermissionGroupBean&gt; permissionGroups = UserGroupsDB.getPermissionGroupsFor(user.getUserId());</span>
            // pre kazdu skupinu prav pridame prava
<span class="fc bfc" id="L352" title="All 2 branches covered.">            for (PermissionGroupBean permGroup : permissionGroups)</span>
            {
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">                if(Tools.isNotEmpty(permGroup.getWritableFolders()))</span>
                {
<span class="nc bnc" id="L356" title="All 2 branches missed.">                    if(!permGroup.getWritableFolders().startsWith(&quot; &quot;))</span>
<span class="nc" id="L357">                        permWritableFolders.append(&quot; &quot;);</span>

<span class="nc" id="L359">                    permWritableFolders.append(permGroup.getWritableFolders());</span>
                }
<span class="fc" id="L361">            }</span>
<span class="fc" id="L362">            user.setWritableFolders(user.getWritableFolders()+permWritableFolders.toString());</span>

            //#20460 uzivatelom sa nastavia rovnake prava na subory ako su nastavene vo na web strankach
<span class="pc bpc" id="L365" title="2 of 8 branches missed.">            if(Constants.getBoolean(&quot;userPermsActualPageAutomatic&quot;) &amp;&amp; user.getEditableGroups().length() &gt; 0 &amp;&amp; (Tools.isNotEmpty(user.getWritableFolders()) || Constants.getBoolean(&quot;defaultDisableUpload&quot;) == true ))</span>
            {
<span class="fc" id="L367">                StringBuilder sb = new StringBuilder(user.getWritableFolders());</span>
<span class="fc" id="L368">                int groupId = -1;</span>
                GroupDetails groupDetails;
<span class="fc" id="L370">                String domainAlias = &quot;&quot;;</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">                for(String group_id:Tools.getTokens(user.getEditableGroups(), &quot;,&quot;))</span>
                {
<span class="fc" id="L373">                    groupId = Tools.getIntValue(group_id,-1);</span>
<span class="fc" id="L374">                    groupDetails = GroupsDB.getInstance().getGroup(groupId);</span>
<span class="fc" id="L375">                    domainAlias = &quot;&quot;;</span>
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">                    if(Tools.isNotEmpty(groupDetails.getDomainName()))</span>
<span class="fc" id="L377">                        domainAlias = MultiDomainFilter.getDomainAlias(groupDetails.getDomainName());</span>
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">                    if(Tools.isNotEmpty(domainAlias))</span>
<span class="nc" id="L379">                        domainAlias = &quot;/&quot;+domainAlias; //NOSONAR</span>

<span class="fc bfc" id="L381" title="All 2 branches covered.">                    for(String directory : new String[]{&quot;/images&quot;,&quot;/files&quot;})</span>
                    {
<span class="fc" id="L383">                        String path = Tools.replace(UploadFileTools.getPageUploadSubDir(-1, groupId, null, directory+domainAlias), &quot;//&quot;, &quot;/&quot;);</span>
                        //replace dvojiteho aliasu, niekedy sa to tam tak doplni a nemam energiu hladat preco a co by sa pokazilo potom
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">                        if (Tools.isNotEmpty(domainAlias))</span>
                        {
<span class="nc" id="L387">                            path = Tools.replace(path, domainAlias+domainAlias, domainAlias);</span>
                        }

<span class="fc bfc" id="L390" title="All 2 branches covered.">                        if (user.isFolderWritable(path)) continue;</span>

<span class="pc bpc" id="L392" title="1 of 2 branches missed.">                        if (sb.isEmpty()==false) sb.append(&quot;\n&quot;);</span>
<span class="fc" id="L393">                        sb.append(path);</span>
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">                        if(path.endsWith(&quot;/&quot;))</span>
<span class="nc" id="L395">                            sb.append(&quot;*&quot;);</span>
                        else
<span class="fc" id="L397">                            sb.append(&quot;/*&quot;);</span>
                    }
                }
<span class="fc" id="L400">                Logger.debug(LogonTools.class, &quot;Adding WritableFolders: &quot;+Tools.replace(sb.toString(), user.getWritableFolders(), &quot;&quot;));</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">                if (sb.isEmpty()==false) sb.append(&quot;\n&quot;);</span>
<span class="fc" id="L402">                user.setWritableFolders(sb.toString()+permWritableFolders);</span>
            }

            //#23245
            //pridame mu prava na grupy z user perm. skupiny
            // pre kazdu skupinu prav pridame prava
<span class="fc bfc" id="L408" title="All 2 branches covered.">            for (PermissionGroupBean permGroup : permissionGroups) {</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">                if (Tools.isNotEmpty(permGroup.getEditableGroups())) {</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                    if (Tools.isEmpty(user.getEditableGroups()))</span>
<span class="nc" id="L411">                        user.setEditableGroups(permGroup.getEditableGroups());</span>
                    else
<span class="nc" id="L413">                        user.setEditableGroups(user.getEditableGroups() + &quot;,&quot; + permGroup.getEditableGroups());</span>
                }
<span class="fc" id="L415">            }</span>
            //pridame mu prava na webstranky (documents) z user perm. skupiny
            // pre kazdu skupinu prav pridame prava
<span class="fc bfc" id="L418" title="All 2 branches covered.">            for (PermissionGroupBean permGroup : permissionGroups) {</span>
<span class="pc bpc" id="L419" title="1 of 2 branches missed.">                if (Tools.isNotEmpty(permGroup.getEditablePages())) {</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">                    if (Tools.isEmpty(user.getEditablePages()))</span>
<span class="nc" id="L421">                        user.setEditablePages(permGroup.getEditablePages());</span>
                    else
<span class="nc" id="L423">                        user.setEditablePages(user.getEditablePages() + &quot;,&quot; + permGroup.getEditablePages());</span>
                }
<span class="fc" id="L425">            }</span>
<span class="fc" id="L426">        } catch (Exception ex) {</span>

<span class="fc" id="L428">        }</span>
<span class="fc" id="L429">    }</span>

	public static void auditLogon(List&lt;String&gt; errors, Identity user, String username, HttpServletRequest request) {
<span class="pc bpc" id="L432" title="1 of 4 branches missed.">		if(errors.isEmpty() &amp;&amp; user != null)</span>
		{
<span class="pc bpc" id="L434" title="2 of 4 branches missed.">			if (Constants.getBoolean(&quot;auditDontLogUsrlogon&quot;)==false) Adminlog.add(Adminlog.TYPE_USER_LOGON, user.getUserId(), &quot;LogonTools - user &quot;+(user.isAdmin() ? &quot;(ADMIN) &quot; : &quot; &quot;)+&quot;successfully loged: name=&quot; + username , -1, -1);</span>
<span class="fc" id="L435">			StatDB.addAdmin(request);</span>
		}
		else
		{
<span class="fc" id="L439">			String lng = PageLng.getUserLng(request);</span>
<span class="fc" id="L440">			Prop prop = Prop.getInstance(lng);</span>
<span class="fc" id="L441">			StringBuffer logErrors = new StringBuffer(&quot;&quot;);</span>
<span class="fc" id="L442">			logErrors.append(&quot; name=&quot;).append(username).append(&quot;\n&quot;);</span>
<span class="fc" id="L443">            Iterator&lt;String&gt; iterator = errors.iterator();</span>
<span class="fc bfc" id="L444" title="All 2 branches covered.">            while(iterator.hasNext())</span>
			{
<span class="fc" id="L446">				String errorKey = iterator.next();</span>
<span class="fc" id="L447">				logErrors.append(prop.getText(errorKey));</span>
<span class="fc bfc" id="L448" title="All 2 branches covered.">				if(iterator.hasNext())</span>
<span class="fc" id="L449">					logErrors.append(&quot;\n&quot;);</span>
<span class="fc" id="L450">			}</span>
<span class="fc" id="L451">			int userId = -1;</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">			if (user != null) userId = user.getUserId();</span>
<span class="fc" id="L453">			Adminlog.add(Adminlog.TYPE_USER_LOGON, userId, &quot;LogonTools - su nejake chyby v logovacom formulari:\n&quot;+logErrors.toString(), -1, -1);</span>
		}
<span class="fc" id="L455">	}</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    public static List&lt;String&gt; logonUser(HttpServletRequest request, String username, String password)
    {
<span class="fc" id="L460">        String logonMethod = Constants.getString(&quot;usrLogonMethod&quot;);</span>
<span class="pc bpc" id="L461" title="5 of 6 branches missed.">        if (Tools.isNotEmpty(logonMethod) &amp;&amp; request.getParameter(&quot;tryNormalLogon&quot;)==null &amp;&amp; request.getAttribute(&quot;tryNormalLogon&quot;)==null)</span>
        {
<span class="nc" id="L463">            int i = logonMethod.lastIndexOf('.');</span>
<span class="nc" id="L464">            String beforePostClass = logonMethod.substring(0, i);</span>
<span class="nc" id="L465">            logonMethod = logonMethod.substring(i+1);</span>
            //String
            try
            {
                //Adminlog.add(Adminlog.TYPE_USER_LOGON,&quot;Logon attempt calling &quot;+beforePostClass+&quot;.&quot;+logonMethod+&quot;, username: &quot; + username,-1,-1);

<span class="nc" id="L471">                Class&lt;?&gt; c = Class.forName(beforePostClass);</span>
<span class="nc" id="L472">                Object o = c.getDeclaredConstructor().newInstance();</span>
                Method m;
<span class="nc" id="L474">                Class&lt;?&gt;[] parameterTypes = new Class&lt;?&gt;[] {String.class, String.class, HttpServletRequest.class};</span>
<span class="nc" id="L475">                Object[] arguments = new Object[] {username, password, request};</span>
<span class="nc" id="L476">                m = c.getMethod(logonMethod, parameterTypes);</span>
<span class="nc" id="L477">                Object result = m.invoke(o, arguments);</span>
<span class="nc" id="L478">                List&lt;String&gt; errors = null;</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">                if (result instanceof List) {</span>
                    try {
<span class="nc" id="L481">                        errors = (List&lt;String&gt;)result;</span>
<span class="nc" id="L482">                    } catch (Exception ex) {</span>
<span class="nc" id="L483">                        Logger.error(LogonTools.class, ex);</span>
<span class="nc" id="L484">                    }</span>
                }
<span class="nc bnc" id="L486" title="All 2 branches missed.">                if (errors == null) errors = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L488">				auditLogon(errors, UsersDB.getCurrentUser(request), username, request);</span>

<span class="nc" id="L490">				return errors;</span>
            }
<span class="nc" id="L492">            catch (Exception ex)</span>
            {
<span class="nc" id="L494">                Adminlog.add(Adminlog.TYPE_USER_LOGON,&quot;Logon attempt calling &quot;+beforePostClass+&quot;.&quot;+logonMethod+&quot;, username: &quot; + username + &quot; failed, error=&quot;+ex.getMessage(),-1,-1);</span>
<span class="nc" id="L495">                sk.iway.iwcm.Logger.error(ex);</span>
            }
        }

<span class="fc" id="L499">        List&lt;String&gt; errors = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L500">        Identity user = new Identity();</span>
<span class="fc" id="L501">        HttpSession session = request.getSession();</span>
		/*
		 * potrebne pre kontrolu hesla, konkretne preto, aby som vedel zistit ci je uzivatel admin,
		 * alebo nie, kedze sa v user nastavuje admin na false a to je mozne nastavit len raz
		 */
<span class="fc" id="L506">        Identity passUser = new Identity();</span>
        try
        {

<span class="fc" id="L510">            boolean passok = false;</span>
<span class="fc" id="L511">            Connection db_conn = DBPool.getConnection(request);</span>
            try
            {
<span class="fc" id="L514">                String sql = &quot;&quot;;</span>

<span class="pc bpc" id="L516" title="1 of 2 branches missed.">                if (&quot;true&quot;.equalsIgnoreCase(request.getParameter(&quot;emailLogon&quot;)))</span>
                {
<span class="nc" id="L518">                    sql = &quot;SELECT * FROM  users WHERE email=?&quot;;</span>
                }
                else
                {
<span class="fc" id="L522">                    sql = &quot;SELECT * FROM  users WHERE login=?&quot;;</span>
                }

<span class="fc" id="L525">                sql += UsersDB.getDomainIdSqlWhere(true);</span>

<span class="fc" id="L527">                PreparedStatement ps = db_conn.prepareStatement(sql);</span>
                try
                {
<span class="fc" id="L530">                    ps.setString(1, username);</span>
<span class="fc" id="L531">                    ResultSet db_result = ps.executeQuery();</span>
                    try
                    {
<span class="fc bfc" id="L534" title="All 2 branches covered.">                        if (db_result.next())</span>
                        {
                            //skontroluj ci je platny datum prihlasenia
<span class="fc" id="L537">                            boolean allowDateLogin = LogonTools.checkAllowLoginDates(db_result);</span>
<span class="pc bpc" id="L538" title="1 of 2 branches missed.">                            if (allowDateLogin == false)</span>
                            {
                                //ma zle heslo, napis chybu
<span class="nc" id="L541">                                errors.add(&quot;error.logon.wrong.pass&quot;);</span>

<span class="nc" id="L543">                                request.setAttribute(&quot;error.logon.wrong.dateLoginDissabled&quot;, &quot;true&quot;);</span>
<span class="nc" id="L544">                                request.setAttribute(&quot;error.logon.wrong.dateLoginDissabled-start&quot;, DB.getDbDate(db_result, &quot;allow_login_start&quot;));</span>
<span class="nc" id="L545">                                request.setAttribute(&quot;error.logon.wrong.dateLoginDissabled-end&quot;, DB.getDbDate(db_result, &quot;allow_login_end&quot;));</span>

<span class="nc" id="L547">                                Adminlog.add(Adminlog.TYPE_USER_LOGON, &quot;LogonAction - login date disabled: name= &quot; + username, -1, -1);</span>
                            }
                            else
                            {
<span class="fc" id="L551">                                String passwordInDb = db_result.getString(&quot;password&quot;);</span>
<span class="fc" id="L552">                                String salt = db_result.getString(&quot;password_salt&quot;);</span>

                                //skontroluj heslo
<span class="fc" id="L555">                                sk.iway.Password pass = new sk.iway.Password();</span>
<span class="pc bpc" id="L556" title="1 of 4 branches missed.">                                if (pass.encrypt(password).equals(db_result.getString(&quot;password&quot;)) || PasswordSecurity.isPasswordCorrect(password, salt, passwordInDb))</span>
                                {
<span class="fc" id="L558">                                    passok = true;</span>

<span class="fc" id="L560">                                    UsersDB.fillUserDetails(passUser, db_result);</span>

<span class="fc" id="L562">                                    UsersDB.fillUserDetails(user, db_result);</span>

<span class="pc bpc" id="L564" title="3 of 4 branches missed.">                                    if (Constants.getBoolean(&quot;enableAdminInWebLogon&quot;) &amp;&amp; user.isAdmin())</span>
                                    {
                                        //kvoli blogom - nacitanie prav

                                        //nacitaj pristupove prava - pouziva sa napr. v module blog - nie je admin (isAdmin bude false, viz nizsie), mame ale jeho prava
<span class="nc" id="L569">                                        LogonTools.setUserPerms(user);</span>
<span class="nc" id="L570">                                        LogonTools.setUserPerms(passUser);</span>

<span class="nc" id="L572">                                        UsersDB.setDisabledItems(user);</span>
<span class="nc" id="L573">                                        UsersDB.setDisabledItems(passUser);</span>
                                    }
                                    else
                                    {
                                        //aby mu nefungovalo pristup do adminu (bezpecnost)
<span class="fc" id="L578">                                        user.setAdmin(false);</span>
                                    }
                                }
                                else
                                {
<span class="fc" id="L583">                                    Logger.error(LogonTools.class,&quot;zle heslo&quot;);</span>
                                    //ma zle heslo, napis chybu
<span class="fc" id="L585">                                    errors.add(&quot;error.logon.wrong.pass&quot;);</span>
<span class="fc" id="L586">                                    request.setAttribute(&quot;error.logon.wrong.pass&quot;, &quot;true&quot;);</span>
                                }

<span class="fc bfc" id="L589" title="All 2 branches covered.">                                if (user.isAuthorized()==false)</span>
                                {
<span class="fc" id="L591">                                    errors.add(&quot;error.logon.user.unknown&quot;);</span>
<span class="fc" id="L592">                                    Logger.error(LogonTools.class,&quot;neautorizovany&quot;);</span>
                                    //ma zle heslo, napis chybu
<span class="pc bpc" id="L594" title="1 of 2 branches missed.">                                    if (Constants.getBoolean(&quot;formLoginProtect&quot;))</span>
                                    {
                                        //nepiseme o aku chybu ide
<span class="fc" id="L597">                                        request.setAttribute(&quot;error.logon.wrong.pass&quot;, &quot;true&quot;);</span>
                                    }
                                    else
                                    {
<span class="nc" id="L601">                                        request.setAttribute(&quot;error.logon.user.unknown&quot;, &quot;true&quot;);</span>
<span class="nc" id="L602">                                        request.setAttribute(&quot;error.logon.user.unknown.notAuthorized&quot;, &quot;true&quot;);</span>
                                    }
                                }
                            }
<span class="fc" id="L606">                        }</span>
                        else
                        {
                            //zadany user neexistuje
<span class="fc" id="L610">                            Logger.error(LogonTools.class,&quot;user neexistuje&quot;);</span>
<span class="fc" id="L611">                            errors.add(&quot;error.logon.user.unknown&quot;);</span>
<span class="pc bpc" id="L612" title="2 of 4 branches missed.">                            if (user != null &amp;&amp; user.isAuthorized()==false)</span>
                            {
                                //nepiseme o aku chybu ide
<span class="fc" id="L615">                                request.setAttribute(&quot;error.logon.wrong.pass&quot;, &quot;true&quot;);</span>
                            }
                            else
                            {
<span class="nc" id="L619">                                request.setAttribute(&quot;error.logon.user.unknown&quot;, &quot;true&quot;);</span>
                            }
                        }
                    }
<span class="fc" id="L623">                    finally { db_result.close(); }</span>
                }
<span class="fc" id="L625">                finally { ps.close(); }</span>
            }
<span class="fc" id="L627">            finally { db_conn.close(); }</span>

<span class="fc bfc" id="L629" title="All 2 branches covered.">            if (passok)</span>
            {
<span class="fc" id="L631">                int checkForAlarmDocId = checkForAlarm(user);</span>
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">                if(checkForAlarmDocId != 0)</span>
                {
<span class="nc" id="L634">                    session.setAttribute(&quot;alarm_warning&quot;, Integer.toString(checkForAlarmDocId));</span>
                }
                else
                {
<span class="fc" id="L638">                    session.setAttribute(&quot;alarm_warning&quot;, &quot;0&quot;);</span>
                }
            }

        }
<span class="nc" id="L643">        catch (Exception ex)</span>
        {
<span class="nc" id="L645">            Logger.error(LogonTools.class,&quot;LogonAction: error&quot;);</span>
<span class="nc" id="L646">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L647">        }</span>

        // Save our logged-in user in the session
<span class="fc" id="L650">        user.setPassword(password);</span>
<span class="fc" id="L651">        user.setValid(true);</span>

<span class="fc bfc" id="L653" title="All 2 branches covered.">        if (user.isAuthorized())</span>
        {
<span class="fc" id="L655">            LogonTools.setUserToSession(session, user);</span>

            //kontrola hesla podla nastavenych podmienok

            //nastavi nove heslo na aktualne
<span class="fc bfc" id="L660" title="All 2 branches covered.">            if(session.getAttribute(Constants.USER_KEY+&quot;_changepassword&quot;) != null)</span>
            {
<span class="fc" id="L662">                String newPassword = request.getParameter(&quot;newPassword&quot;);</span>
<span class="fc" id="L663">                String retypeNewPassword = request.getParameter(&quot;retypeNewPassword&quot;);</span>
<span class="pc bpc" id="L664" title="1 of 2 branches missed.">                if(newPassword.equals(retypeNewPassword))</span>
                {
<span class="fc" id="L666">                    password = newPassword;</span>
                }
                else
                {
<span class="nc" id="L670">                    Logger.error(LogonTools.class,&quot;nove heslo a opakovanie noveho hesla sa nezhoduju&quot;);</span>
<span class="nc" id="L671">                    errors.add(&quot;passwordsNotMatch&quot;);</span>
<span class="nc" id="L672">                    request.setAttribute(&quot;passwordsNotMatch&quot;, &quot;true&quot;);</span>

<span class="nc" id="L674">                    session.removeAttribute(Constants.USER_KEY);</span>

<span class="nc" id="L676">                    Adminlog.add(Adminlog.TYPE_USER_CHANGE_PASSWORD, user.getUserId(), &quot;LogonTools - user (&quot;+user.getLogin()+&quot;) password to change not match&quot;, -1, -1);</span>

<span class="nc" id="L678">                    return errors;</span>
                }
            }
            //END nastavi nove heslo na aktualne

<span class="fc bfc" id="L683" title="All 2 branches covered.">            if(Password.checkPassword(true, password, passUser.isAdmin(), passUser.getUserId(), session, null))</span>
            {
                //updatnem heslo na nove
<span class="fc bfc" id="L686" title="All 2 branches covered.">                if(session.getAttribute(Constants.USER_KEY+&quot;_changepassword&quot;) != null)</span>
                {

                    try
                    {
<span class="fc" id="L691">                        Password pass = new Password();</span>
<span class="fc" id="L692">                        String encryptedPassword = &quot;&quot;;</span>
<span class="fc" id="L693">                        PasswordsHistoryBean passwordsHistoryBean = new PasswordsHistoryBean(user.getUserId(),&quot;&quot;, UsersDB.getSalt(user.getUserId()));</span>
<span class="pc bpc" id="L694" title="1 of 2 branches missed.">                        if (Constants.getBoolean(&quot;passwordUseHash&quot;))</span>
                        {
<span class="fc" id="L696">                            encryptedPassword = PasswordSecurity.calculateHash(password, UsersDB.getSalt(user.getUserId()));</span>
                        }
                        else
                        {
<span class="nc" id="L700">                            encryptedPassword = pass.encrypt(password);</span>
<span class="nc" id="L701">                            passwordsHistoryBean.setSalt(&quot;&quot;);</span>
                        }
<span class="fc" id="L703">                        passwordsHistoryBean.setPassword(encryptedPassword);</span>
<span class="fc" id="L704">                        DB.execute(&quot;UPDATE users SET password=? WHERE user_id=?&quot;, encryptedPassword, Integer.valueOf(user.getUserId()));</span>
<span class="fc" id="L705">                        passwordsHistoryBean.saveIfNotExistsAndDeleteOld();</span>
<span class="fc" id="L706">                        Adminlog.add(Adminlog.TYPE_USER_CHANGE_PASSWORD, user.getUserId(), &quot;LogonTools - user (&quot;+user.getLogin()+&quot;) successfully changed password&quot;, -1, -1);</span>
                    }
<span class="nc" id="L708">                    catch (Exception ex)</span>
                    {
<span class="nc" id="L710">                        sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L711">                    }</span>
                }
<span class="fc" id="L713">                session.removeAttribute(Constants.USER_KEY+&quot;_changepassword&quot;);</span>
            }
            else
            {
<span class="fc" id="L717">                session.removeAttribute(Constants.USER_KEY);</span>
<span class="fc" id="L718">                session.setAttribute(Constants.USER_KEY+&quot;_changepassword&quot;, passUser);</span>
            }
            //END kontrola hesla

        }

<span class="fc" id="L724">        auditLogon(errors, user, username, request);</span>

<span class="fc bfc" id="L726" title="All 2 branches covered.">        if (errors.isEmpty()==false) {</span>
<span class="fc" id="L727">            setLoginBlocked(request);</span>
        }

<span class="fc" id="L730">        return errors;</span>
    }

    public static List&lt;String&gt; logonUserWithAllChecks(HttpServletRequest request, String username, String password) {
<span class="fc" id="L734">        List&lt;String&gt; errors = new ArrayList&lt;&gt;();</span>

        //15888 #11: akceptuje sa len submit cez HTTP POST
<span class="pc bpc" id="L737" title="1 of 2 branches missed.">		if(&quot;post&quot;.equalsIgnoreCase(request.getMethod()) == false) {</span>
<span class="nc" id="L738">            return null;</span>
        }

        //session fixation ochrana
<span class="fc" id="L742">        LogonTools.invalidateSessionOnFirstPost(request);</span>

        //pravdepodobne submit nejakeho robota
<span class="pc bpc" id="L745" title="2 of 4 branches missed.">        if (username == null || password == null) return null;</span>

<span class="fc" id="L747">        String url = PathFilter.getOrigPath(request);</span>
<span class="fc" id="L748">        HttpSession session = request.getSession();</span>
<span class="fc" id="L749">		Prop prop = Prop.getInstance(request);</span>

        //nemoze sa prihlasit lebo sa zle predtym prihlasil
<span class="fc bfc" id="L752" title="All 2 branches covered.">		if(isLoginBlocked(request))</span>
		{
<span class="fc" id="L754">			Logger.error(LogonTools.class, prop.getText(&quot;logon.error.blocked&quot;));</span>
<span class="fc" id="L755">			request.setAttribute(&quot;logon_message&quot;,prop.getText(&quot;logon.error.blocked&quot;));</span>
<span class="fc" id="L756">			request.setAttribute(&quot;error.logon.user.blocked&quot;, &quot;true&quot;);</span>
<span class="pc bpc" id="L757" title="1 of 2 branches missed.">			if (errors.contains(&quot;error.logon.user.blocked&quot;)==false) errors.add(&quot;error.logon.user.blocked&quot;);</span>

<span class="fc" id="L759">			Adminlog.add(Adminlog.TYPE_USER_LOGON,&quot;Logon attempt TIME BLOCKED, username: &quot; + username,-1,-1);</span>
<span class="fc" id="L760">			return errors;</span>
		}

<span class="fc bfc" id="L763" title="All 2 branches covered.">        if(session.getAttribute(Constants.USER_KEY+&quot;_changepassword&quot;) != null)</span>
		{
<span class="fc" id="L765">			String newPassword = request.getParameter(&quot;newPassword&quot;);</span>
<span class="fc" id="L766">			String retypeNewPassword = request.getParameter(&quot;retypeNewPassword&quot;);</span>

<span class="pc bpc" id="L768" title="2 of 4 branches missed.">			if(Tools.isEmpty(newPassword) || Tools.isEmpty(retypeNewPassword))</span>
			{
<span class="nc" id="L770">				errors.add(&quot;passwordsNotMatch&quot;);</span>

<span class="nc" id="L772">				Adminlog.add(Adminlog.TYPE_USER_LOGON,&quot;Logon attempt CHANGE PASSWORD REQUIRED, username: &quot; + username,-1,-1);</span>
<span class="nc" id="L773">				return errors;</span>
			}
		}

<span class="fc" id="L777">        errors = LogonTools.logonUser(request, username, password);</span>

        // Report any errors we have discovered back to the original form
<span class="fc bfc" id="L780" title="All 2 branches covered.">		if (!errors.isEmpty())</span>
		{
<span class="fc" id="L782">			Logger.error(LogonTools.class, &quot;su nejake chyby v logovacom formulari: &quot;+url);</span>
<span class="fc" id="L783">			return errors;</span>
		}

<span class="fc bfc" id="L786" title="All 2 branches covered.">        if(session.getAttribute(Constants.USER_KEY+&quot;_changepassword&quot;) != null) {</span>
<span class="fc" id="L787">            return errors;</span>
        }

<span class="fc" id="L790">        Identity user = UsersDB.getCurrentUser(request);</span>
<span class="pc bpc" id="L791" title="2 of 4 branches missed.">		if (user==null || user.isAuthorized()==false)</span>
		{
            //there is allready logged user, so it means he doesnt' have permission to access this page
<span class="nc" id="L794">            errors.add(&quot;editor.permsDenied&quot;);</span>
<span class="nc" id="L795">			request.setAttribute(&quot;unauthorized&quot;, &quot;unauthorized&quot;);</span>
<span class="nc" id="L796">			return errors;</span>
		}

<span class="fc" id="L799">        callLogonLogoffInterceptor(user, request);</span>

<span class="fc" id="L801">        return errors;</span>
    }

    public static void afterLogon(Identity user, HttpServletRequest request, HttpServletResponse response)
	{
<span class="fc" id="L806">		String afterLogon = Constants.getString(&quot;afterLogonMethod&quot;);</span>
<span class="pc bpc" id="L807" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(afterLogon))</span>
		{
<span class="nc" id="L809">			int i = afterLogon.lastIndexOf('.');</span>
<span class="nc" id="L810">			String customClass = afterLogon.substring(0, i);</span>
<span class="nc" id="L811">			afterLogon = afterLogon.substring(i+1);</span>
			//String
			try
			{
<span class="nc" id="L815">				Class&lt;?&gt; c = Class.forName(customClass);</span>
<span class="nc" id="L816">				Object o = c.getDeclaredConstructor().newInstance();</span>
				Method m;
<span class="nc" id="L818">				Class&lt;?&gt;[] parameterTypes = new Class&lt;?&gt;[] {Identity.class, HttpServletRequest.class, HttpServletResponse.class};</span>
<span class="nc" id="L819">				Object[] arguments = new Object[] {user, request, response};</span>
<span class="nc" id="L820">				m = c.getMethod(afterLogon, parameterTypes);</span>
<span class="nc" id="L821">				m.invoke(o, arguments);</span>
			}
<span class="nc" id="L823">			catch (Exception ex)</span>
			{
<span class="nc" id="L825">				sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L826">			}</span>
		}
<span class="fc" id="L828">	}</span>

	private static void callLogonLogoffInterceptor(UserDetails user, HttpServletRequest request)
	{
<span class="fc" id="L832">		String interceptorClassName = Constants.getString(&quot;stripesLogonLogoffInterceptorClass&quot;);</span>

<span class="pc bpc" id="L834" title="2 of 4 branches missed.">		if (Tools.isEmpty(interceptorClassName) &amp;&amp; request.getAttribute(&quot;afterSaveInterceptor&quot;) != null) {</span>
<span class="nc" id="L835">			interceptorClassName = Tools.getStringValue((String) request.getAttribute(&quot;afterSaveInterceptor&quot;), &quot;&quot;);</span>
		}

<span class="pc bpc" id="L838" title="1 of 2 branches missed.">		if (Tools.isNotEmpty(interceptorClassName)) {</span>
			try
			{
				@SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L842">				Class&lt;? extends AfterLogonLogoffInterceptor&gt; interceptorClass = (Class&lt;? extends AfterLogonLogoffInterceptor&gt;) Class.forName(interceptorClassName);</span>
<span class="nc" id="L843">				AfterLogonLogoffInterceptor interceptor = interceptorClass.getDeclaredConstructor().newInstance();</span>

<span class="nc" id="L845">				interceptor.logon(user, request);</span>
			}
<span class="nc" id="L847">			catch (Exception e)</span>
			{
<span class="nc" id="L849">				sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L850">			}</span>
		}
<span class="fc" id="L852">	}</span>

    public static int checkForAlarm(Identity user)
    {
        int userId;
<span class="fc" id="L857">        int warning = -1;</span>
<span class="fc" id="L858">        int docId = 0;</span>

<span class="fc" id="L860">        int alarmId = 1;</span>
        try
        {
<span class="fc" id="L863">            userId = user.getUserId();</span>
<span class="fc" id="L864">            Connection db_conn = DBPool.getConnection();</span>
            try
            {
<span class="fc" id="L867">                PreparedStatement ps = db_conn.prepareStatement(&quot;SELECT * FROM user_alarm WHERE user_id=?&quot;); //NOSONAR</span>
                try
                {
<span class="fc" id="L870">                    ps.setInt(1, userId);</span>
<span class="fc" id="L871">                    ResultSet rs = ps.executeQuery();</span>
                    try
                    {
<span class="pc bpc" id="L874" title="1 of 2 branches missed.">                        if(rs.next())</span>
                        {
<span class="nc" id="L876">                            warning = rs.getInt(&quot;warning&quot;);</span>
                        }
                    }
<span class="fc" id="L879">                    finally { rs.close(); }</span>
                }
<span class="fc" id="L881">                finally { ps.close(); }</span>

<span class="fc" id="L883">                ps = db_conn.prepareStatement(&quot;SELECT * FROM alarm_action WHERE alarm_id=?&quot;); //NOSONAR</span>
                try
                {
<span class="fc" id="L886">                    ps.setInt(1, alarmId);</span>
<span class="fc" id="L887">                    ResultSet rs = ps.executeQuery();</span>
                    try
                    {
<span class="pc bpc" id="L890" title="1 of 2 branches missed.">                        if(rs.next())</span>
                        {
<span class="nc" id="L892">                            docId = rs.getInt(&quot;doc_id&quot;);</span>
                        }
                    }
<span class="fc" id="L895">                    finally { rs.close(); }</span>
                }
<span class="fc" id="L897">                finally { ps.close(); }</span>
            }
<span class="fc" id="L899">            finally { db_conn.close(); }</span>

<span class="pc bpc" id="L901" title="1 of 2 branches missed.">            if(warning == 1)</span>
            {
<span class="nc" id="L903">                return docId;</span>

            }
            //Logger.println(this,&quot;WARNING: &quot;+ warning);
        }
<span class="nc" id="L908">        catch (Exception ex)</span>
        {
<span class="nc" id="L910">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L911">        }</span>
<span class="fc" id="L912">        return (0);</span>
    }

    /**
     * Ochrana Session Fixation (MFSR pentesty) ktora zabezpeci pri PRVOM odoslani (POST) logon formularu invalidnutie session
     * @param request
     */
    public static void invalidateSessionOnFirstPost(HttpServletRequest request)
    {
<span class="pc bpc" id="L921" title="1 of 2 branches missed.">        if(&quot;post&quot;.equalsIgnoreCase(request.getMethod()) == false) return;</span>

<span class="fc" id="L923">        final String SESSION_KEY = &quot;session_fixation_invalidated&quot;;</span>
        //session fixation - pri prihlaseni vzdy generujeme novu session
<span class="fc bfc" id="L925" title="All 2 branches covered.">        if (request.getSession().getAttribute(SESSION_KEY)==null)</span>
        {
            //toto potrebujeme zachovat po destroyi session (session fixation)
<span class="fc" id="L928">            String[] preservedSessionObjectNames = Tools.getTokens(Constants.getStringExecuteMacro(&quot;logonPreservedSessionObjects&quot;), &quot;,&quot;);</span>
<span class="fc" id="L929">            Map&lt;String, Object&gt; preservedSessionObjects = new Hashtable&lt;&gt;();</span>
<span class="fc bfc" id="L930" title="All 2 branches covered.">            for (String name : preservedSessionObjectNames)</span>
            {
<span class="fc" id="L932">                Object o = request.getSession().getAttribute(name);</span>
<span class="fc bfc" id="L933" title="All 2 branches covered.">                if (o != null) preservedSessionObjects.put(name, o);</span>
            }

<span class="fc" id="L936">            request.getSession(false).invalidate();</span>
<span class="fc" id="L937">            request.getSession().setAttribute(SESSION_KEY, 1);</span>

            //preserve atributov
<span class="fc bfc" id="L940" title="All 2 branches covered.">            for (String name : preservedSessionObjectNames)</span>
            {
<span class="fc" id="L942">                Object o = preservedSessionObjects.get(name);</span>
<span class="fc bfc" id="L943" title="All 2 branches covered.">                if (o != null) request.getSession().setAttribute(name, o);</span>
            }
        }
<span class="fc" id="L946">    }</span>

    /**
     * Ulozi URL pred zobrazenim logon formu na ktoru sa po prihlaseni presmeruje
     * @param request
     */
    public static void saveAfterLogonRedirect(HttpServletRequest request)
    {
<span class="fc" id="L954">        HttpSession session = request.getSession();</span>

<span class="fc" id="L956">        Identity user = UsersDB.getCurrentUser(request);</span>
        //ak uz je prihlaseny user, neulozime (asi len nema prava)
<span class="fc bfc" id="L958" title="All 2 branches covered.">        if (user != null) return;</span>

        //ak uz mame nieco ulozene neprepiseme to
<span class="fc bfc" id="L961" title="All 2 branches covered.">        if (session.getAttribute(&quot;adminAfterLogonRedirect&quot;)!=null) return;</span>

        //bereme orig_path, je potrebne toto volat zo vsetkych miest pred redirectom dalej
        //teoreticky by sa dal pouzit referer, ale skrz viacere presmerovania a bezpecnost to nemozeme pouzit
<span class="fc" id="L965">        String origPath = (String)request.getAttribute(&quot;path_filter_orig_path&quot;);</span>

<span class="fc" id="L967">        Logger.debug(LogonTools.class, &quot;adminAfterLogonRedirect=&quot;+session.getAttribute(&quot;adminAfterLogonRedirect&quot;));</span>

<span class="pc bpc" id="L969" title="3 of 14 branches missed.">        if (origPath != null &amp;&amp; origPath.indexOf(&quot;logon&quot;)==-1 &amp;&amp; origPath.equals(&quot;/admin/&quot;)==false &amp;&amp; origPath.equals(&quot;/admin&quot;)==false &amp;&amp; origPath.indexOf(&quot;/admin/index.jsp&quot;)==-1 &amp;&amp; origPath.indexOf(&quot;/admin/welcome.jsp&quot;)==-1 &amp;&amp; session.getAttribute(&quot;adminAfterLogonRedirect&quot;)==null)</span>
        {
            //ukladame iba taketo cesty, nech sa nam tam neulozi odkaz na css, js alebo nieco podobne
<span class="pc bpc" id="L972" title="3 of 8 branches missed.">            if (origPath.endsWith(&quot;.do&quot;) || origPath.endsWith(&quot;.jsp&quot;) || origPath.endsWith(&quot;/&quot;) || origPath.endsWith(&quot;.action&quot;))</span>
            {
<span class="fc" id="L974">                Logger.debug(LogonTools.class, &quot;mainLink=&quot; + request.getParameter(&quot;mainLink&quot;));</span>
<span class="pc bpc" id="L975" title="1 of 2 branches missed.">                if (request.getParameter(&quot;mainLink&quot;) != null)</span>
                {
<span class="nc" id="L977">                    origPath = request.getParameter(&quot;mainLink&quot;);</span>
                }
                else
                {
<span class="fc" id="L981">                    String QS = (String) request.getAttribute(&quot;path_filter_query_string&quot;);</span>
<span class="fc bfc" id="L982" title="All 2 branches covered.">                    if (Tools.isNotEmpty(QS)) origPath = origPath + &quot;?&quot; + QS;</span>
                }

<span class="fc" id="L985">                Logger.debug(LogonTools.class, &quot;origPath=&quot; + origPath);</span>
<span class="pc bpc" id="L986" title="1 of 2 branches missed.">                if (Tools.isNotEmpty(origPath) &amp;&amp;</span>
<span class="pc bpc" id="L987" title="2 of 4 branches missed.">                        origPath.indexOf(&quot;welcome.jsp&quot;) == -1 &amp;&amp; origPath.indexOf(&quot;refresher&quot;) == -1 &amp;&amp;</span>
<span class="pc bpc" id="L988" title="2 of 4 branches missed.">                        origPath.indexOf(&quot;FCKeditor&quot;) == -1 &amp;&amp; origPath.indexOf(&quot;logon.jsp&quot;) == -1 &amp;&amp;</span>
<span class="pc bpc" id="L989" title="2 of 4 branches missed.">                        origPath.indexOf(&quot;ajax&quot;) == -1 &amp;&amp; origPath.indexOf(&quot;/admin/todo/&quot;) == -1 &amp;&amp;</span>
<span class="pc bpc" id="L990" title="2 of 4 branches missed.">                        origPath.indexOf(&quot;combine.jsp&quot;) == -1 &amp;&amp; origPath.indexOf(&quot;edituser.do&quot;) == -1 &amp;&amp;</span>
<span class="pc bpc" id="L991" title="2 of 4 branches missed.">                        origPath.equals(&quot;/admin/index.jsp&quot;) == false &amp;&amp; origPath.equals(&quot;/admin/&quot;) == false)</span>
                {
<span class="fc" id="L993">                    session.setAttribute(&quot;adminAfterLogonRedirect&quot;, origPath);</span>
                }
            }
        }
<span class="fc" id="L997">    }</span>

    /**
     * Nastavi usera do session a nastavi spring prava
     * @param session
     * @param user
     */
    public static Authentication setUserToSession(HttpSession session, Identity user)
    {
<span class="pc bpc" id="L1006" title="1 of 2 branches missed.">        if (session != null) session.setAttribute(Constants.USER_KEY, user);</span>

        try
        {
            //prihlasenie pre SPRING / REST
            //RequestBean requestBean = SetCharacterEncodingFilter.getCurrentRequestBean();
<span class="pc bpc" id="L1012" title="1 of 2 branches missed.">            if (Constants.getServletContext().getAttribute(&quot;springContext&quot;)!=null)</span>
            {
                //ApplicationContext context = (ApplicationContext) Constants.getServletContext().getAttribute(&quot;springContext&quot;);
                //AuthenticationManager authenticationManager = context.getBean(&quot;authenticationManagerBean&quot;, AuthenticationManager.class);
<span class="fc" id="L1016">                final Authentication authentication = WebjetAuthentificationProvider.authenticate(user);</span>
<span class="fc" id="L1017">                SecurityContextHolder.getContext().setAuthentication(authentication);</span>
<span class="fc" id="L1018">                return authentication;</span>
            }
        }
<span class="nc" id="L1021">        catch (Exception ex)</span>
        {
<span class="nc" id="L1023">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L1024">        }</span>

<span class="nc" id="L1026">        return null;</span>
    }

    /**
     * Test if login is not time/IP blocked
     * @param request
     * @return
     */
    public static boolean isLoginBlocked(HttpServletRequest request) {
<span class="fc" id="L1035">        Cache cache = Cache.getInstance();</span>

<span class="fc" id="L1037">        String ipAddress = Tools.getRemoteIP(request);</span>
<span class="fc" id="L1038">        String LOGON_BLOCKED_IP_CACHE_KEY = &quot;logon_ip_&quot;+ipAddress;</span>
<span class="fc" id="L1039">        String LOGON_BLOCKED_USERNAME_TIME_CACHE_KEY = &quot;logon_blocked_&quot;+ipAddress+&quot;_time&quot;;</span>
<span class="fc" id="L1040">        String LOGON_BLOCKED_USERNAME_COUNT_CACHE_KEY = &quot;logon_blocked_&quot;+ipAddress+&quot;_count&quot;;</span>

<span class="fc" id="L1042">		Calendar cal = (Calendar)cache.getObject(LOGON_BLOCKED_IP_CACHE_KEY);</span>
<span class="fc bfc" id="L1043" title="All 2 branches covered.">        if (cal != null) {</span>
<span class="fc" id="L1044">            Logger.debug(LogonTools.class, &quot;Mam cal: &quot;+Tools.formatDateTimeSeconds(cal.getTimeInMillis()));</span>
        }

        //#20489
<span class="fc" id="L1048">		Calendar calDelay = (Calendar)cache.getObject(LOGON_BLOCKED_USERNAME_TIME_CACHE_KEY);</span>
<span class="pc bpc" id="L1049" title="2 of 6 branches missed.">		if(Constants.getInt(&quot;logonBlockedAfterUnsuccessCount&quot;) &gt; 0 &amp;&amp; Constants.getInt(&quot;logonLoginBlockedDelay&quot;) &gt; 0 &amp;&amp;</span>
<span class="pc bpc" id="L1050" title="1 of 2 branches missed.">				(calDelay == null || calDelay.getTimeInMillis() &lt; Tools.getNow()))</span>
		{
<span class="fc" id="L1052">			Integer userLogonCount = (Integer)cache.getObject(LOGON_BLOCKED_USERNAME_COUNT_CACHE_KEY);</span>
<span class="fc bfc" id="L1053" title="All 2 branches covered.">			if(userLogonCount != null)</span>
			{
<span class="fc" id="L1055">				Logger.debug(LogonTools.class, &quot;Pokus cislo : &quot; + userLogonCount);</span>
				//nastavime blokovanie na login (a je jedno, ze potom zada spravne heslo)
<span class="pc bpc" id="L1057" title="1 of 2 branches missed.">				if( userLogonCount.intValue() &gt; Constants.getInt(&quot;logonBlockedAfterUnsuccessCount&quot;))</span>
				{
<span class="nc" id="L1059">					Calendar cal3 = Calendar.getInstance();</span>
<span class="nc" id="L1060">					cal3.add(Calendar.SECOND, Constants.getInt(&quot;logonLoginBlockedDelay&quot;));</span>
<span class="nc" id="L1061">					Logger.debug(LogonTools.class, &quot;Blokujem ip &quot;+ipAddress+&quot; na &quot; + (Constants.getInt(&quot;logonLoginBlockedDelay&quot;)/60)+&quot; minut&quot;);</span>
<span class="nc" id="L1062">					cal = cal3;</span>
				}
			}
		}
<span class="pc bpc" id="L1066" title="3 of 6 branches missed.">		if(calDelay != null &amp;&amp; (cal == null || calDelay.getTimeInMillis() &gt; cal.getTimeInMillis()))</span>
		{
<span class="fc" id="L1068">			cal = calDelay;</span>
		}
        //nemoze sa prihlasit lebo sa zle predtym prihlasil
<span class="fc bfc" id="L1071" title="All 4 branches covered.">		if(cal != null &amp;&amp; cal.getTimeInMillis() &gt; Tools.getNow())</span>
		{
<span class="fc" id="L1073">            return true;</span>
        }
<span class="fc" id="L1075">        return false;</span>
    }

    /**
     * Cache info about bad credentials/login to block for 10 seconds
     * @param request
     */
    public static void setLoginBlocked(HttpServletRequest request) {
<span class="fc" id="L1083">        Cache cache = Cache.getInstance();</span>

<span class="fc" id="L1085">        String ipAddress = Tools.getRemoteIP(request);</span>
<span class="fc" id="L1086">        String LOGON_BLOCKED_IP_CACHE_KEY = &quot;logon_ip_&quot;+ipAddress;</span>
<span class="fc" id="L1087">        String LOGON_BLOCKED_USERNAME_TIME_CACHE_KEY = &quot;logon_blocked_&quot;+ipAddress+&quot;_time&quot;;</span>
<span class="fc" id="L1088">        String LOGON_BLOCKED_USERNAME_COUNT_CACHE_KEY = &quot;logon_blocked_&quot;+ipAddress+&quot;_count&quot;;</span>

<span class="pc bpc" id="L1090" title="1 of 2 branches missed.">        if (Constants.getInt(&quot;logonBlockedDelay&quot;)&gt;0)</span>
        {
<span class="fc" id="L1092">            Calendar cal2=Calendar.getInstance();</span>
<span class="fc" id="L1093">            cal2.add(Calendar.SECOND, Constants.getInt(&quot;logonBlockedDelay&quot;));</span>
<span class="fc" id="L1094">            cache.setObjectSeconds(LOGON_BLOCKED_IP_CACHE_KEY, cal2, Constants.getInt(&quot;logonBlockedDelay&quot;)+10, false);</span>
        }

<span class="fc" id="L1097">        Integer userLogonCount = (Integer)cache.getObject(LOGON_BLOCKED_USERNAME_COUNT_CACHE_KEY);</span>
<span class="fc bfc" id="L1098" title="All 2 branches covered.">        if(userLogonCount != null)</span>
        {
<span class="fc" id="L1100">            userLogonCount = Integer.valueOf(userLogonCount.intValue()+1);</span>

<span class="fc" id="L1102">            Logger.debug(LogonTools.class, &quot;Pokus cislo : &quot; + userLogonCount);</span>
<span class="fc" id="L1103">            cache.setObjectSeconds(LOGON_BLOCKED_USERNAME_COUNT_CACHE_KEY, userLogonCount, Constants.getInt(&quot;logonLoginBlockedDelay&quot;), false);</span>
            //nastavime blokovanie na login (a je jedno, ze potom zada spravne heslo)
<span class="fc bfc" id="L1105" title="All 2 branches covered.">            if( userLogonCount &gt; Constants.getInt(&quot;logonBlockedAfterUnsuccessCount&quot;))</span>
            {
<span class="fc" id="L1107">                Calendar cal3 = Calendar.getInstance();</span>
<span class="fc" id="L1108">                cal3.add(Calendar.SECOND, Constants.getInt(&quot;logonLoginBlockedDelay&quot;));</span>
<span class="fc" id="L1109">                Logger.debug(LogonTools.class, &quot;Blokujem ip &quot;+ipAddress+&quot; na &quot; + Constants.getInt(&quot;logonLoginBlockedDelay&quot;)+&quot; sekund&quot;);</span>
<span class="fc" id="L1110">                cache.setObjectSeconds(LOGON_BLOCKED_USERNAME_TIME_CACHE_KEY, cal3, Constants.getInt(&quot;logonLoginBlockedDelay&quot;), false);</span>
<span class="fc" id="L1111">            }</span>
        }
        else
        {
            //Logger.debug(UsrLogonAction.class, &quot;Nastavujem pocet pokusov na : 1 a trvanie na &quot;+(Constants.getInt(&quot;logonLoginBlockedDelay&quot;) / 60)+&quot; minut&quot;);
<span class="fc" id="L1116">            cache.setObjectSeconds(LOGON_BLOCKED_USERNAME_COUNT_CACHE_KEY, 1, Constants.getInt(&quot;logonLoginBlockedDelay&quot;), false);</span>
        }
<span class="fc" id="L1118">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>