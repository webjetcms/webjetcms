<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileIndexerTools.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">webjet8v9</a> &gt; <a href="index.source.html" class="el_package">sk.iway.iwcm.common</a> &gt; <span class="el_source">FileIndexerTools.java</span></div><h1>FileIndexerTools.java</h1><pre class="source lang-java linenums">package sk.iway.iwcm.common;

import java.io.BufferedInputStream;
import java.io.File;
import java.io.UnsupportedEncodingException;
import java.lang.reflect.Method;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.StringTokenizer;

import javax.annotation.Nullable;
import javax.servlet.http.HttpServletRequest;

import org.apache.commons.beanutils.BeanUtils;

import sk.iway.Password;
import sk.iway.iwcm.Cache;
import sk.iway.iwcm.Constants;
import sk.iway.iwcm.DBPool;
import sk.iway.iwcm.FileTools;
import sk.iway.iwcm.Logger;
import sk.iway.iwcm.RequestBean;
import sk.iway.iwcm.SetCharacterEncodingFilter;
import sk.iway.iwcm.Tools;
import sk.iway.iwcm.components.file_archiv.FileArchivatorBean;
import sk.iway.iwcm.components.file_archiv.FileArchivatorDB;
import sk.iway.iwcm.database.SimpleQuery;
import sk.iway.iwcm.doc.DocDB;
import sk.iway.iwcm.doc.DocDetails;
import sk.iway.iwcm.doc.GroupDetails;
import sk.iway.iwcm.doc.GroupsDB;
import sk.iway.iwcm.doc.TemplateDetails;
import sk.iway.iwcm.doc.TemplatesDB;
import sk.iway.iwcm.findexer.Excel;
import sk.iway.iwcm.findexer.FileIndexer;
import sk.iway.iwcm.findexer.PDF;
import sk.iway.iwcm.findexer.PoiExtractor;
import sk.iway.iwcm.findexer.ResultBean;
import sk.iway.iwcm.findexer.Rtf;
import sk.iway.iwcm.findexer.Word;
import sk.iway.iwcm.io.IwcmFile;
import sk.iway.iwcm.io.IwcmFsDB;
import sk.iway.iwcm.io.IwcmInputStream;
import sk.iway.iwcm.system.zip.ZipEntry;
import sk.iway.iwcm.system.zip.ZipInputStream;
import sk.iway.iwcm.users.UserDetails;
import sk.iway.iwcm.users.UsersDB;

public class FileIndexerTools {

    private FileIndexerTools() {
        //Utility class
    }

    /**
     * Vymazanie suboru z indexu
     * @param url
     * @return
     */
    public static boolean deleteIndexedFile(String url)
    {

        try
        {
<span class="fc" id="L71">            TemplatesDB tempDB = TemplatesDB.getInstance();</span>
<span class="fc" id="L72">            TemplateDetails temp = tempDB.getTemplate(&quot;files&quot;);</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">            if (temp == null)</span>
            {
<span class="fc" id="L75">                temp = tempDB.getTemplates().get(0);</span>
            }

            //vymaz Stranku s tymto suborom
<span class="fc" id="L79">            StringTokenizer st = new StringTokenizer(getUrlForGroupsTokenize(url), &quot;/&quot;);</span>
<span class="fc" id="L80">            int parentDirId = 0;</span>
            String dirName;
<span class="fc" id="L82">            GroupsDB groupsDB = GroupsDB.getInstance();</span>
            GroupDetails group;
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">            while (st.hasMoreTokens())</span>
            {
<span class="fc" id="L86">                dirName = st.nextToken();</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">                if (st.hasMoreTokens())</span>
                {
                    //je to skutocne adresar
<span class="fc" id="L90">                    group = findGroup(groupsDB.getGroupsAll(), parentDirId, dirName);</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">                    if (group == null)</span>
                    {
                        //adresar neexistuje, takze to nie je indexovane
<span class="fc" id="L94">                        return(true);</span>
                    }
<span class="fc" id="L96">                    parentDirId = group.getGroupId();</span>
                }
                else
                {
<span class="fc" id="L100">                    int docId = getFileDocId(dirName, parentDirId);</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">                    if (docId &lt; 1) docId = DocDB.getInstance().getDocIdFromURLImpl(url+&quot;.html&quot;, null);</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">                    if (docId &gt; 0)</span>
                    {
<span class="fc" id="L104">                        DocDB.deleteDoc(docId, null);</span>
<span class="fc" id="L105">                        return(true);</span>
                    }
<span class="nc" id="L107">                }</span>
            }
        }
<span class="nc" id="L110">        catch (Exception ex)</span>
        {
<span class="nc" id="L112">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="nc" id="L113">        }</span>

<span class="nc" id="L115">        return(false);</span>
    }

    /**
     * najde adresar
     * @param groups - array list adresarov
     * @param parentGroupId - id rodicovskeho adresara
     * @param name - meno adresara
     * @return
     */
    public static GroupDetails findGroup(List&lt;GroupDetails&gt; groups, int parentGroupId, String name)
    {
<span class="fc" id="L127">        String domainName = null;</span>
<span class="fc" id="L128">        RequestBean rb = SetCharacterEncodingFilter.getCurrentRequestBean();</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">        if (rb != null) domainName = rb.getDomain();</span>
<span class="fc" id="L130">        GroupDetails bestMatch = null;</span>
<span class="fc" id="L131">        GroupDetails anyGroup = null;</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">        for (GroupDetails group : groups)</span>
        {
<span class="fc bfc" id="L134" title="All 4 branches covered.">            if (group.getParentGroupId() == parentGroupId &amp;&amp; group.getGroupName().equals(name))</span>
            {
<span class="fc" id="L136">                anyGroup = group;</span>

                //ak este nemame pouzi verziu bez domenoveho mena
<span class="pc bpc" id="L139" title="2 of 4 branches missed.">                if (bestMatch == null &amp;&amp; Tools.isEmpty(group.getDomainName())) bestMatch = group;</span>
                //ak mame aj domenove meno, pouzi verziu s domenovym menom
<span class="pc bpc" id="L141" title="2 of 4 branches missed.">                if (domainName != null &amp;&amp; domainName.equals(group.getDomainName())) {</span>
<span class="fc" id="L142">                    bestMatch = group;</span>
<span class="fc" id="L143">                    break;</span>
                }
            }
<span class="fc" id="L146">        }</span>

<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (bestMatch == null) bestMatch = anyGroup;</span>

<span class="fc" id="L150">        return (bestMatch);</span>
    }

    /**
     * Najde docId pre zadany subor v danom adresari
     * @param fileName - nazov suboru (title stranky)
     * @param dirId - id adresara, v ktorom sa to nachadza
     * @return
     */
    public static int getFileDocId(String fileName, int dirId)
    {
<span class="fc" id="L161">        int docId = -1;</span>
<span class="fc" id="L162">        Connection db_conn = null;</span>
<span class="fc" id="L163">        PreparedStatement ps = null;</span>
<span class="fc" id="L164">        ResultSet rs = null;</span>
        try
        {
<span class="fc" id="L167">            db_conn = DBPool.getConnection();</span>
<span class="fc" id="L168">            ps = db_conn.prepareStatement(&quot;SELECT doc_id FROM documents WHERE title=? AND group_id=?&quot;);</span>
<span class="fc" id="L169">            ps.setString(1, fileName);</span>
<span class="fc" id="L170">            ps.setInt(2, dirId);</span>
<span class="fc" id="L171">            rs = ps.executeQuery();</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">            if (rs.next())</span>
            {
<span class="fc" id="L174">                docId = rs.getInt(&quot;doc_id&quot;);</span>
            }
<span class="fc" id="L176">            rs.close();</span>
<span class="fc" id="L177">            ps.close();</span>
<span class="fc" id="L178">            db_conn.close();</span>
<span class="fc" id="L179">            rs = null;</span>
<span class="fc" id="L180">            ps = null;</span>
<span class="fc" id="L181">            db_conn = null;</span>
        }
<span class="nc" id="L183">        catch (Exception ex)</span>
        {
<span class="nc" id="L185">            sk.iway.iwcm.Logger.error(ex);</span>
        }
        finally
        {
            try
            {
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">                if (rs != null)</span>
<span class="nc" id="L192">                    rs.close();</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">                if (ps != null)</span>
<span class="nc" id="L194">                    ps.close();</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">                if (db_conn != null)</span>
<span class="nc" id="L196">                    db_conn.close();</span>
            }
<span class="nc" id="L198">            catch (Exception ex2)</span>
            {
<span class="fc" id="L200">            }</span>
        }

<span class="fc" id="L203">        return(docId);</span>
    }

    /**
     * Ziska URL pre adresarovu strukturu, ktoru chceme vytvorit
     * @param url
     * @return
     */
    public static String getUrlForGroupsTokenize(String url)
    {
        //vytvor Stranku s tymto suborom
<span class="fc" id="L214">        String urlForTokenize = url;</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;))</span>
        {
<span class="fc" id="L217">            int domainId = CloudToolsForCore.getDomainId();</span>
<span class="fc" id="L218">            GroupDetails domainRootGroup = GroupsDB.getInstance().getGroup(domainId);</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">            if (domainRootGroup!=null)</span>
            {
                ///files adresar vytvarame v domenovom foldri
<span class="fc" id="L222">                urlForTokenize = &quot;/&quot; + domainRootGroup.getGroupName() + url;</span>
            }
        }
<span class="fc" id="L225">        return urlForTokenize;</span>
    }

    /**
     * Fulltext Index File
     * @param url - URL of the file
     * @param user - current user
     */
    public static void indexFile(String url, UserDetails user)
    {
<span class="fc" id="L235">        indexFile(url, user, null, null);</span>
<span class="fc" id="L236">    }</span>

    /**
     * Fulltext Index File
     * @param url - URL of the file
     * @param indexedFiles - optional - list of indexed files, after indexing it will be added with indexed file
     * @param request - HttpServletRequest - can provide additional meta data for indexing from request.getParameter(field_a... field_l, perexGroup, passwordProtected)
     * @return
     */
    public static boolean indexFile(String url, List&lt;ResultBean&gt; indexedFiles, HttpServletRequest request)
	{
<span class="fc" id="L247">		return FileIndexerTools.indexFile(url, UsersDB.getCurrentUser(request), indexedFiles, request);</span>
	}

    /**
     * Fulltext Index File
     * @param fileArchivatorBean
     * @param url
     * @param user
     * @deprecated use {@link #indexFile(String, UserDetails)} instead
     */
    @Deprecated
    public static void indexFile(FileArchivatorBean fileArchivatorBean,String url, UserDetails user)
    {
<span class="nc" id="L260">        indexFile(url, user, null, null);</span>
<span class="nc" id="L261">    }</span>

    /**
     * Fulltext Index File
     * @param url - URL of the file
     * @param user - current user
     * @param indexedFiles - optional - list of indexed files, after indexing it will be added with indexed file
     * @param request - optional - HttpServletRequest - can provide additional meta data for indexing from request.getParameter(field_a... field_l, perexGroup, passwordProtected)
     * @return
     */
    private static boolean indexFile(String url, UserDetails user, @Nullable List&lt;ResultBean&gt; indexedFiles, @Nullable HttpServletRequest request)
    {
<span class="fc" id="L273">        url = Tools.replace(url, &quot;//&quot;, &quot;/&quot;);</span>
<span class="fc" id="L274">        Logger.debug(FileIndexerTools.class,&quot;indexFile(url=&quot;+url+&quot; user=&quot;+user+&quot;)&quot;);</span>

<span class="fc bfc" id="L276" title="All 2 branches covered.">        if (shouldIndexFile(url) == false) {</span>
<span class="fc" id="L277">            Logger.debug(FileIndexerTools.class, &quot;File is in non indexable dir: &quot; + url);</span>
<span class="fc" id="L278">            return false;</span>
        }

<span class="fc" id="L281">        boolean saveOk = false;</span>
        try
        {
<span class="fc" id="L284">            String realPath = Tools.getRealPath(url);</span>
<span class="fc" id="L285">            Logger.debug(FileIndexerTools.class,&quot;realPath: &quot;+realPath);</span>
<span class="fc" id="L286">            String data = null;</span>

<span class="pc bpc" id="L288" title="1 of 2 branches missed.">            if (url.indexOf('.')==-1)</span>
            {
<span class="nc" id="L290">                Logger.error(FileIndexerTools.class,&quot;url musi obsahovat bodku: &quot;+url);</span>
<span class="nc" id="L291">                return false;</span>
            }

<span class="fc" id="L294">            String ext = url.substring(url.lastIndexOf('.')).toLowerCase();</span>

            try
            {
<span class="fc" id="L298">                data = getData(url, realPath, data, ext);</span>
            }
<span class="nc" id="L300">            catch (Exception ex)</span>
            {
<span class="nc" id="L302">                sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L303">            }</span>
            //Logger.debug(FileIndexerTools.class,&quot;data: &quot;+(data != null ? data.length() : &quot;-&quot;));

<span class="pc bpc" id="L306" title="5 of 6 branches missed.">            if (Tools.isEmpty(data) &amp;&amp; Constants.getBoolean(&quot;fileIndexerIndexAllFiles&quot;) &amp;&amp; url.startsWith(&quot;/files/&quot;))</span>
			{
<span class="nc" id="L308">				data = &quot;&lt;p&gt;&lt;a href='&quot;+url+&quot;'&gt;&quot;+url+&quot;&lt;/p&gt;&quot;;</span>
			}
<span class="pc bpc" id="L310" title="2 of 4 branches missed.">            if (data != null &amp;&amp; data.trim().length() &gt; 4)</span>
            {
                //mame text, mozeme zaindexovat

<span class="fc" id="L314">				data = FileIndexerTools.cleanText(url, data);</span>

				//Logger.debug(FileIndexer.class, data);

				//Logger.println(FileIndexer.class,data);
<span class="fc" id="L319">				Logger.println(FileIndexer.class,&quot;done, size=&quot;+data.length());</span>
<span class="fc" id="L320">				ResultBean result = new ResultBean();</span>
<span class="fc" id="L321">				result.setFile(url);</span>
<span class="fc" id="L322">				result.setData(data);</span>

<span class="pc bpc" id="L324" title="1 of 2 branches missed.">				if (indexedFiles!=null) {</span>
<span class="fc" id="L325">                    indexedFiles.add(result);</span>
                }

<span class="fc" id="L328">                StringTokenizer st = new StringTokenizer(getUrlForGroupsTokenize(url), &quot;/&quot;);</span>
<span class="fc" id="L329">                int parentDirId = 0;</span>
<span class="fc" id="L330">                int parentTempId = 1;</span>
                String dirName;
<span class="fc" id="L332">                GroupsDB groupsDB = GroupsDB.getInstance();</span>
<span class="fc" id="L333">                GroupDetails group = null;</span>
<span class="fc" id="L334">                int level = 0;</span>
<span class="fc" id="L335">                int sortPriority = Constants.getInt(&quot;fileIndexerSortPriority&quot;);</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">                while (st.hasMoreTokens())</span>
                {
<span class="fc" id="L338">                    level++;</span>
<span class="fc" id="L339">                    dirName = st.nextToken();</span>

<span class="pc bpc" id="L341" title="3 of 4 branches missed.">                    if ((Constants.getBoolean(&quot;multiDomainEnabled&quot;)==false &amp;&amp; level &gt; 1) ||</span>
<span class="pc bpc" id="L342" title="1 of 4 branches missed.">                            (Constants.getBoolean(&quot;multiDomainEnabled&quot;)==true  &amp;&amp; level &gt; 2))</span>
                    {
                        //automaticke navysovanie priority
<span class="fc" id="L345">                        sortPriority = sortPriority * 10;</span>
                    }

<span class="fc bfc" id="L348" title="All 2 branches covered.">                    if (st.hasMoreTokens())</span>
                    {
<span class="fc" id="L350">                        Logger.debug(FileIndexerTools.class,&quot;dirName: &quot;+dirName);</span>
                        //je to skutocne adresar
<span class="fc" id="L352">                        boolean changed = false;</span>
<span class="fc" id="L353">                        group = findGroup(groupsDB.getGroupsAll(), parentDirId, dirName);</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">                        if (group == null)</span>
                        {
                            //vytvor adresar
<span class="nc" id="L357">                            group = new GroupDetails();</span>
<span class="nc" id="L358">                            changed = true;</span>
                        }
<span class="pc bpc" id="L360" title="2 of 4 branches missed.">                        if (changed || group.getGroupName().equals(dirName)==false ||</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">                                group.getSortPriority()!=sortPriority)</span>
                        {
<span class="pc bpc" id="L363" title="2 of 4 branches missed.">                            if (level==1 &amp;&amp; Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;))</span>
                            {
                                //je to root, s nim nerobime nic
                            }
                            else
                            {
<span class="nc" id="L369">                                group.setGroupName(dirName);</span>
<span class="nc" id="L370">                                group.setNavbar(dirName);</span>
<span class="nc" id="L371">                                group.setParentGroupId(parentDirId);</span>
<span class="nc" id="L372">                                group.setSortPriority(sortPriority);</span>
<span class="nc" id="L373">                                group.setTempId(parentTempId);</span>
<span class="nc" id="L374">                                group.setMenuType(GroupDetails.MENU_TYPE_HIDDEN);</span>

<span class="nc bnc" id="L376" title="All 6 branches missed.">                                if (level==2 &amp;&amp; Constants.getBoolean(&quot;multiDomainEnabled&quot;) &amp;&amp; Constants.getBoolean(&quot;enableStaticFilesExternalDir&quot;)==false)</span>
                                {
                                    //aby sa nam multidomain subfolder nezobrazoval v ceste
<span class="nc" id="L379">                                    group.setNavbar(&quot;&amp;nbsp;&quot;);</span>
<span class="nc" id="L380">                                    group.setUrlDirName(dirName);</span>
                                }

<span class="nc" id="L383">                                groupsDB.setGroup(group);</span>
<span class="nc" id="L384">                                GroupsDB.getInstance(true);</span>
                            }
                        }

<span class="fc" id="L388">                        parentDirId = group.getGroupId();</span>
<span class="fc" id="L389">                        parentTempId = group.getTempId();</span>
<span class="fc" id="L390">                    }</span>
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">                    else if (group != null)</span>
                    {
<span class="fc" id="L393">                        String title = dirName;</span>
<span class="fc" id="L394">                        FileArchivatorBean fab = FileArchivatorDB.getByUrl(url);</span>
<span class="fc" id="L395">                        String domain = null;</span>
                        //pre FA mam domeny, preco to nevyuzit pri hladani docID
<span class="pc bpc" id="L397" title="3 of 4 branches missed.">                        if(fab != null &amp;&amp; fab.getId() &gt; 0)</span>
                        {
<span class="nc" id="L399">                            title = fab.getVirtualFileName();</span>
<span class="nc" id="L400">                            domain = GroupsDB.getInstance().getDomain(fab.getDomainId());</span>
                        }

<span class="fc" id="L403">                        IwcmFile f = new IwcmFile(realPath);</span>

                        //uz sme na konci, dirName je uz fileName
<span class="fc" id="L406">                        Logger.println(FileIndexer.class,&quot;Vytvaram stranku: &quot; + dirName);</span>
<span class="fc" id="L407">                        DocDB docDB = DocDB.getInstance();</span>

<span class="fc" id="L409">                        int docId = docDB.getDocIdFromURLImpl(url+&quot;.html&quot;, domain);</span>
<span class="pc bpc" id="L410" title="1 of 2 branches missed.">                        if (docId &lt; 1) docId = getFileDocId(dirName, group.getGroupId());</span>

<span class="fc" id="L412">                        group = groupsDB.getGroup(parentDirId);</span>

<span class="fc" id="L414">                        DocDetails doc = docDB.getDoc(docId);</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">                        if (doc == null)</span>
                        {
<span class="fc" id="L417">                            doc = new DocDetails();</span>
                        }

                        //suborom nastavujem rovnaku prioritu ako je priorita adresara
<span class="fc" id="L421">                        doc.setGroupId(parentDirId);</span>
<span class="fc" id="L422">                        doc.setAuthorId(user.getUserId());</span>
<span class="fc" id="L423">                        doc.setSortPriority(group.getSortPriority());</span>
<span class="fc" id="L424">                        doc.setTitle(title);</span>
<span class="fc" id="L425">                        doc.setData(data);</span>
<span class="fc" id="L426">                        doc.setExternalLink(url);</span>
<span class="fc" id="L427">                        doc.setVirtualPath(url+&quot;.html&quot;);</span>
<span class="fc" id="L428">                        doc.setNavbar(title +  &quot; (&quot;+Tools.formatFileSize(f.length())+&quot;)&quot;);</span>
                        // Publish start as last modified date of the file
<span class="fc" id="L430">                        doc.setPublishStartString( Tools.formatDateTimeSeconds( f.lastModified() ) );</span>

<span class="pc bpc" id="L432" title="3 of 4 branches missed.">                        boolean searchable = fab == null || fab.getShowFile();</span>
<span class="fc" id="L433">                        doc.setSearchable(searchable);</span>
<span class="fc" id="L434">                        doc.setAvailable(searchable);</span>
<span class="fc" id="L435">                        doc.setCacheable(false);</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">                        if (group!=null) doc.setTempId(group.getTempId());</span>

<span class="pc bpc" id="L438" title="1 of 2 branches missed.">                        if (request != null) {</span>
                            //ak mame v requeste nejake editor hodnoty, nastavme ich, tie z request.getAttribute sa pouzivaju v UnzipAction
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">                            if (request.getParameter(&quot;passwordProtected&quot;)!=null) doc.setPasswordProtected(Tools.join(request.getParameterValues(&quot;passwordProtected&quot;), &quot;,&quot;));</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">                            if (request.getAttribute(&quot;passwordProtected&quot;)!=null) doc.setPasswordProtected((String)request.getAttribute(&quot;passwordProtected&quot;));</span>

<span class="fc" id="L443">                            String[] fields = {&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;G&quot;, &quot;H&quot;, &quot;I&quot;, &quot;J&quot;, &quot;K&quot;, &quot;L&quot;};</span>
<span class="fc bfc" id="L444" title="All 2 branches covered.">                            for (String pismeno : fields)</span>
                            {
<span class="fc" id="L446">                                String value = request.getParameter(&quot;field&quot;+pismeno);</span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">                                if (value==null) value = (String)request.getAttribute(&quot;field&quot;+pismeno);</span>

<span class="pc bpc" id="L449" title="1 of 2 branches missed.">                                if (value != null) BeanUtils.setProperty(doc, &quot;field&quot;+pismeno, value);</span>
                            }
<span class="pc bpc" id="L451" title="1 of 2 branches missed.">                            if (request.getParameter(&quot;perexGroup&quot;)!=null) doc.setPerexGroup(request.getParameterValues(&quot;perexGroup&quot;));</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">                            if(Tools.isNotEmpty(Constants.getString(&quot;beforeFileIndexerEditorSaveMathod&quot;)))</span>
                            {
                                try{
<span class="nc" id="L455">                                    String saveMethod = Constants.getString(&quot;beforeFileIndexerEditorSaveMathod&quot;);</span>
<span class="nc" id="L456">                                    String clazzName = saveMethod.substring( 0, saveMethod.lastIndexOf('.'));</span>
<span class="nc" id="L457">                                    String methodName = saveMethod.substring( clazzName.length() +1 );</span>
<span class="nc" id="L458">                                    Class&lt;?&gt; clazz = Class.forName(clazzName);</span>
<span class="nc" id="L459">                                    Method method = clazz.getMethod(methodName, Class.forName(&quot;sk.iway.iwcm.editor.EditorForm&quot;),Class.forName(&quot;javax.servlet.http.HttpServletRequest&quot;));</span>
<span class="nc" id="L460">                                    method.invoke(null, doc, request);</span>
                                }
<span class="nc" id="L462">                                catch(Exception e){</span>
<span class="nc" id="L463">                                    Logger.debug(FileIndexer.class, &quot;Exception while trying to invoke &quot;+Constants.getString(&quot;beforeFileIndexerEditorSaveMathod&quot;)+&quot; , cause: &quot;+e.getMessage());</span>
<span class="nc" id="L464">                                }</span>
                            }
                        }

<span class="fc" id="L468">                        saveOk = DocDB.saveDoc(doc);</span>
<span class="fc" id="L469">                        docDB.updateInternalCaches(doc.getDocId());</span>

<span class="fc" id="L471">                        result.setDocId(doc.getDocId());</span>
<span class="fc" id="L472">                    }</span>
                }
            }
        }
<span class="nc" id="L476">        catch (Exception ex)</span>
        {
<span class="nc" id="L478">            sk.iway.iwcm.Logger.error(ex);</span>
<span class="fc" id="L479">        }</span>
<span class="fc" id="L480">        return saveOk;</span>
    }

    /**
     * @param url
     * @param data
     * @return
     * @throws UnsupportedEncodingException
     */
    public static String cleanText(String url, String data)
            throws UnsupportedEncodingException {

<span class="pc bpc" id="L492" title="1 of 2 branches missed.">        if (data == null)</span>
        {
<span class="nc" id="L494">            return data;</span>
        }

<span class="fc" id="L497">        byte[] buff = data.getBytes(Constants.FILE_ENCODING);</span>
<span class="fc" id="L498">        int size = buff.length;</span>
        int i;
<span class="fc" id="L500">        boolean replaced = false;</span>
<span class="fc bfc" id="L501" title="All 2 branches covered.">        for (i=0; i&lt;size; i++)</span>
        {
<span class="pc bpc" id="L503" title="6 of 8 branches missed.">            if (buff[i]&gt;0 &amp;&amp; buff[i]&lt;32 &amp;&amp; buff[i]!=10 &amp;&amp; buff[i]!=13)</span>
            {
<span class="nc" id="L505">                replaced = true;</span>
<span class="nc" id="L506">                buff[i] = ' ';</span>
            }
        }
<span class="pc bpc" id="L509" title="1 of 2 branches missed.">        if (replaced)</span>
        {
<span class="nc" id="L511">            Logger.println(FileIndexer.class,&quot;FileIndexer: replacing bad data in &quot; + url);</span>
<span class="nc" id="L512">            data = new String(buff, Constants.FILE_ENCODING);</span>
        }

        //uprav rozdelenia slov na konci riadkov (hlavne z PDF)
<span class="fc" id="L516">        data = Tools.replace(data, &quot;\r&quot;, &quot;&quot;);</span>
        //dlha pomlcka za kratku - orpava kodovania na windows-1250
<span class="fc" id="L518">        data = Tools.replace(data, &quot;â€“&quot;, &quot;-&quot;);</span>
<span class="fc" id="L519">        data = Tools.replace(data, &quot;- \n&quot;, &quot;&quot;);</span>
<span class="fc" id="L520">        data = Tools.replace(data, &quot;-\n&quot;, &quot;&quot;);</span>

<span class="fc" id="L522">        data = Tools.replace(data, &quot;\n&quot;, &quot; &lt;br&gt;\n&quot;);</span>
<span class="fc" id="L523">        data = Tools.replace(data, &quot;FORMTEXT&quot;, &quot;&quot;);</span>
<span class="fc" id="L524">        data = Tools.replace(data, &quot;FORMCHECKBOX&quot;, &quot;&quot;);</span>
<span class="fc" id="L525">        return data;</span>
    }

    /**
     * @param url
     * @param realPath
     * @param data
     * @param ext
     * @return
     */
    public static String getData(String url, String realPath, String data, String ext)
    {
<span class="fc" id="L537">        int maxFileSize = Constants.getInt(&quot;fileIndexerMaxFileSize&quot;);</span>
        //BHR: typy suborov pre ktore nechceme indexovat obsah, napr, zip, rar a pod., sluzi napr ak ho chceme mat indexovany len kvoli statistike zobrazeni
<span class="fc" id="L539">        String fileIndexerNoDataFileExtension = Constants.getString(&quot;fileIndexerNoDataFileExtension&quot;);</span>

<span class="fc" id="L541">        IwcmFile file = new IwcmFile(realPath);</span>

<span class="pc bpc" id="L543" title="2 of 4 branches missed.">        if (maxFileSize &lt; 1 || file.length() &lt; maxFileSize )</span>
        {
<span class="pc bpc" id="L545" title="2 of 4 branches missed.">            if(fileIndexerNoDataFileExtension != null &amp;&amp; Arrays.stream(Tools.getTokens(fileIndexerNoDataFileExtension,&quot;,&quot;)).anyMatch(ext::equals))</span>
            {
<span class="nc" id="L547">                data = &quot;&lt;p&gt;&quot;+ FileTools.getFileNameWithoutExtension(url)+&quot;&lt;/p&gt;&quot;;</span>
            }
            else
            {
<span class="pc bpc" id="L551" title="3 of 6 branches missed.">                if (&quot;.doc&quot;.equals(ext) || &quot;.docx&quot;.equals(ext) || &quot;.dot&quot;.equals(ext) ||</span>
<span class="pc bpc" id="L552" title="3 of 6 branches missed.">                &quot;.xls&quot;.equals(ext) || &quot;.xlsx&quot;.equals(ext) || &quot;.xlt&quot;.equals(ext) ||</span>
<span class="pc bpc" id="L553" title="5 of 10 branches missed.">                &quot;.ppt&quot;.equals(ext) || &quot;.pptx&quot;.equals(ext) || &quot;.pot&quot;.equals(ext) || &quot;.pps&quot;.equals(ext) || &quot;.ppsx&quot;.equals(ext))</span>
                {
<span class="nc" id="L555">                    data = PoiExtractor.getText(realPath);</span>
                }
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">                else if (&quot;.doc&quot;.equals(ext))</span>
                {
<span class="nc" id="L559">                    data = Word.getText(realPath);</span>
                }
<span class="pc bpc" id="L561" title="1 of 2 branches missed.">                else if (&quot;.xls&quot;.equals(ext))</span>
                {
<span class="nc" id="L563">                    data = Excel.getText(realPath);</span>
                }
<span class="pc bpc" id="L565" title="1 of 2 branches missed.">                else if (&quot;.pdf&quot;.equals(ext))</span>
                {
<span class="nc" id="L567">                    data = PDF.getText(realPath);</span>
                }
<span class="pc bpc" id="L569" title="1 of 2 branches missed.">                else if (&quot;.rtf&quot;.equals(ext))</span>
                {
<span class="nc" id="L571">                    data = Rtf.getText(realPath);</span>
                }
<span class="pc bpc" id="L573" title="2 of 6 branches missed.">                else if (&quot;.txt&quot;.equals(ext) || &quot;.csv&quot;.equals(ext) || &quot;.xml&quot;.equals(ext))</span>
                {
<span class="fc" id="L575">                    data = FileTools.readFileContent(url);</span>
                }
<span class="pc bpc" id="L577" title="1 of 2 branches missed.">                else if(&quot;.zip&quot;.equals(ext))</span>
                {
<span class="nc" id="L579">                    data = getArchiveData(url, realPath, ext);</span>
                }
            }
        }
        else
        {
<span class="nc" id="L585">            data = &quot;&lt;p&gt;&quot;+ FileTools.getFileNameWithoutExtension(url)+&quot;&lt;/p&gt;&quot;;</span>
        }

<span class="pc bpc" id="L588" title="1 of 4 branches missed.">        if (Tools.isEmpty(data) &amp;&amp; Constants.getBoolean(&quot;fileIndexerIndexAllFiles&quot;))</span>
        {
<span class="pc bpc" id="L590" title="1 of 2 branches missed.">            if(url.startsWith(&quot;/files/&quot;))</span>
<span class="fc" id="L591">                data = &quot;&lt;p&gt;&lt;a href='&quot;+url+&quot;'&gt;&quot;+url+&quot;&lt;/p&gt;&quot;;</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">            else if(url.startsWith(&quot;/WEB-INF/&quot;))</span>
<span class="nc" id="L593">                data = &quot;&lt;p&gt;&quot;+ FileTools.getFileNameWithoutExtension(url)+&quot;&lt;/p&gt;&quot;;</span>
        }

        try {
<span class="fc" id="L597">            data = cleanText(url, data);</span>
<span class="nc" id="L598">        } catch (UnsupportedEncodingException e) {</span>
<span class="nc" id="L599">            sk.iway.iwcm.Logger.error(e);</span>
<span class="fc" id="L600">        }</span>

<span class="fc" id="L602">        return data;</span>
    }

    private static String getArchiveData(String zipUrl, String realPath, String ext)
    {
<span class="nc" id="L607">        String data = &quot;&quot;;</span>

<span class="nc" id="L609">        String tempUrl = &quot;/WEB-INF/tmp/fileindexer/&quot;+ Password.generatePassword(5)+(new Date().getTime())+&quot;/&quot;;</span>
<span class="nc" id="L610">        String realTempUrl = Tools.getRealPath(tempUrl);</span>
        try
        {
<span class="nc bnc" id="L613" title="All 2 branches missed.">            if(&quot;.zip&quot;.equals(ext))</span>
            {
<span class="nc" id="L615">                IwcmInputStream fis = new IwcmInputStream(realPath);</span>
<span class="nc" id="L616">                ZipInputStream zis = new ZipInputStream(new BufferedInputStream(fis));</span>
                ZipEntry entry;

<span class="nc bnc" id="L619" title="All 2 branches missed.">                while((entry = zis.getNextEntry()) != null)</span>
                {
<span class="nc" id="L621">                    Logger.debug(FileIndexer.class, &quot;Extracting: &quot;+entry);</span>

<span class="nc" id="L623">                    String url = tempUrl;</span>

<span class="nc" id="L625">                    url += entry.getName();</span>

<span class="nc" id="L627">                    final String fullEntryPath = Tools.getRealPath(url);</span>

<span class="nc bnc" id="L629" title="All 2 branches missed.">                    if(entry.getName().endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L630">                        new IwcmFile(fullEntryPath).mkdirs();</span>
<span class="nc" id="L631">                        continue;</span>
                    }
                    else
                    {
<span class="nc" id="L635">                        IwcmFile f = new IwcmFile(fullEntryPath);</span>
<span class="nc" id="L636">                        IwcmFile parent = f.getParentFile();</span>
<span class="nc" id="L637">                        parent.mkdirs();</span>
                    }

<span class="nc" id="L640">                    IwcmFsDB.writeFiletoDest(zis, new File(fullEntryPath), (int)entry.getSize(), false);</span>
<span class="nc" id="L641">                }</span>
<span class="nc" id="L642">                zis.close();</span>
            }
            /*else if(&quot;.rar&quot;.equals(ext))
            {
                File rarFile=new File(realTempUrl);
                if(rarFile.mkdirs() == false)
                    throw new SecurityException(&quot;Unable to create dirs: &quot;+realTempUrl);
                rarFile=new File(realPath);
                final ReadOnlyAccessFile readOnlyAccessFile = new ReadOnlyAccessFile(rarFile);

                final Archive archive = new Archive(readOnlyAccessFile);
                final List&lt;FileHeader&gt; fileHeaders = archive.getFileHeaders();
                for (FileHeader fileHeader : fileHeaders)
                {
                    final String fileNameString = fileHeader.getFileNameString();
                    //write the files to the disk
                    Logger.println(FileIndexer.class,&quot;Unrarring: &quot; + fileNameString);

                    IwcmFile outFile = new IwcmFile(realTempUrl, fileNameString);

                    final IwcmFile parentFolder = outFile.getParentFile();

                    parentFolder.mkdirs();
                    IwcmOutputStream outStream=new IwcmOutputStream(outFile.getAbsolutePath());
                    archive.extractFile(fileHeader,outStream);
                    outStream.close();
                }
                readOnlyAccessFile.close();
            }*/
<span class="nc" id="L671">            IwcmFile tempDir = new IwcmFile(realTempUrl);</span>
<span class="nc" id="L672">            data = getTempDirData(tempDir);</span>
        }
<span class="nc" id="L674">        catch (Exception e)</span>
        {
<span class="nc" id="L676">            sk.iway.iwcm.Logger.error(e);</span>
<span class="nc" id="L677">        }</span>

<span class="nc" id="L679">        return data;</span>
    }

    private static String getTempDirData(IwcmFile dir)
    {
<span class="nc" id="L684">        StringBuilder data=new StringBuilder();</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">        if(dir.isDirectory())</span>
        {
<span class="nc bnc" id="L687" title="All 2 branches missed.">            for(IwcmFile file : dir.listFiles())</span>
            {
<span class="nc bnc" id="L689" title="All 2 branches missed.">                if(file.isDirectory())</span>
                {
<span class="nc" id="L691">                    data.append(getTempDirData(file));</span>
                }
                else
                {
<span class="nc" id="L695">                    String url = file.getVirtualPath();</span>

<span class="nc bnc" id="L697" title="All 2 branches missed.">                    if (url.indexOf('.') &gt; -1)</span>
                    {
<span class="nc" id="L699">                        String ext = url.substring(url.lastIndexOf('.')).toLowerCase();</span>
<span class="nc" id="L700">                        data.append(getData(url, file.getAbsolutePath(), data.toString(), ext)).append('\n');</span>
                    }
                }
<span class="nc" id="L703">                file.delete();</span>
            }
        }
<span class="nc" id="L706">        dir.delete();</span>
<span class="nc" id="L707">        return data.toString();</span>
    }

    /**
     * Check database table dirprop for dir_url, return index_fulltext, search to parents dir
     * @param fileUrl
     * @return
     */
    private static boolean shouldIndexFile(String fileUrl) {

<span class="pc bpc" id="L717" title="1 of 6 branches missed.">        if (!fileUrl.startsWith(&quot;/files/&quot;) || fileUrl.endsWith(&quot;/upload&quot;) || fileUrl.startsWith(&quot;/files/protected/&quot;))</span>
		{
<span class="fc" id="L719">			return false;</span>
		}

<span class="fc bfc" id="L722" title="All 2 branches covered.">        if (fileUrl.contains(Constants.getString(&quot;fileArchivInsertLaterDirPath&quot;)))</span>
        {
<span class="fc" id="L724">            return false;</span>
        }

<span class="fc" id="L727">        String testDir = fileUrl;</span>

<span class="fc" id="L729">        int i = testDir.lastIndexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L730" title="1 of 2 branches missed.">        if (i&gt;0) testDir = testDir.substring(0, i);</span>
<span class="nc" id="L731">        else return false;</span>

<span class="fc" id="L733">        Cache c = Cache.getInstance();</span>
<span class="fc" id="L734">        String key = &quot;FileIndexerTools.shouldIndexDir&quot;;</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L736">        Map&lt;String, Boolean&gt; cachedMap = (Map&lt;String, Boolean&gt;)c.getObject(key);</span>
<span class="fc bfc" id="L737" title="All 2 branches covered.">        if (cachedMap == null) {</span>
<span class="fc" id="L738">            cachedMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L739">            c.setObjectSeconds(key, cachedMap, 300);</span>
        }


<span class="fc" id="L743">        int failsafe = 0;</span>
<span class="pc bpc" id="L744" title="2 of 4 branches missed.">        while (testDir.length() &gt; 0 &amp;&amp; failsafe++&lt;50) {</span>

<span class="fc" id="L746">            Logger.debug(FileIndexerTools.class, &quot;Checking dirprop for dir_url: &quot; + testDir);</span>

<span class="fc" id="L748">            Boolean isIndexed = (new SimpleQuery()).forBooleanWithNull(&quot;SELECT index_fulltext FROM dirprop WHERE dir_url=?&quot;, testDir);</span>
<span class="fc bfc" id="L749" title="All 2 branches covered.">            if (isIndexed != null) {</span>
<span class="fc" id="L750">                cachedMap.put(testDir, isIndexed);</span>
<span class="fc" id="L751">                return isIndexed.booleanValue();</span>
            }

<span class="fc" id="L754">            i = testDir.lastIndexOf(&quot;/&quot;);</span>
<span class="pc bpc" id="L755" title="1 of 2 branches missed.">            if (i&gt;0) testDir = testDir.substring(0, i);</span>
<span class="nc" id="L756">            else testDir = &quot;&quot;;</span>
<span class="fc" id="L757">        }</span>

<span class="nc" id="L759">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>