# Bezpečnostné testy

Zabezpečenie WebJET CMS je podmienené jeho korektnou konfiguráciou a korektným nastavením prístupových práv. Informácie na tejto stránke je potrebné nastaviť pred spustením do produkčnej prevádzky a následne kontrolovať minimálne na kvartálnej báze a vždy pred vykonaním bezpečnostných testov.

## Nastavenie systému

### Skupiny práv

Cez WebJET CMS je možné upravovať aj programové súbory, preto je potrebné pred penetračnými testami nastaviť obmedzenia práv. Odporúčame vytvoriť nižšie uvedené [skupiny práv](../../admin/users/perm-groups.md). **Iné skupiny používateľov, alebo priamo používatelia, by nižšie uvedené jednotkové práva nemali mať povolené**.

**Správa používateľov**

Skupina obsahuje práva, ktoré umožňujú modifikovať oprávnenia. Používateľ s takouto skupinou práv musí byť dostatočne obozretný a musí mu byť jasné, že má najvyššie možnosti práv (pretože dokáže nastavovať práva sám sebe, alebo iným používateľom).

Používateľ s takýmto právom dokáže kompromitovať celý systém (napr. dokáže si nastaviť oprávnenia tak, že dokáže zmazať všetky web stránky, alebo všetky súbory).

Skupine práv nastavte nasledovné práva:

- správa administrátorov - právo umožňuje nastavovať oprávnenia používateľom v administrácii
- Skupiny práv - právo umožňuje nastavovať oprávnenia na skupiny

**Programátor**

Štandardné nastavenie by malo byť také, že používatelia (redaktori) nemôžu nahrávať a modifikovať programové súbory. Programátor ale často potrebuje vykonať rýchlu zmenu (`hotfix`) programového kódu a potrebuje teda modifikovať aj programové súbory. Zároveň má pridané práva pre zmenu všetkých konfiguračných premenných a editáciu všetkých prekladových textov.

Používateľ s takýmto právom dokáže kompromitovať celý systém (napr. dokáže nahrať škodlivý kód, ktorý na serveri môže vykonať ľubovoľnú operáciu vrátane zmazania súborov na serveri, alebo kompletného zmazania databázy).

- Neobmedzené nahrávanie súborov (prípony a veľkosti)
- Konfigurácia - zobrazenie všetkých premenných
- Editácia textov - zobrazenie všetkých textov

Poznámka: zoznam konf. premenných bez oprávnenia "Konfigurácia - zobrazenie všetkých premenných" sa nastavuje v konf. premennej ```configEnabledKeys```, zoznam prekladových kľúčov bez oprávnenia "Editácia textov - zobrazenie všetkých textov" v konf. premennej ```propertiesEnabledKeys```. V prekladových kľúčoch sa zároveň filtruje HTML kód, pravidlá nastavenia sú opísané nižšie v sekcii ```Stored XSS cez úpravu prekladových kľúčov```.

Okrem oprávnení je potrebné povoliť prístup na zápis do adresárov súborového systému:

- ```/apps``` - obsahuje kód aplikácií
- ```/components``` - obsahuje kód aplikácií
- ```/templates``` - obsahuje dizajnové šablóny

Ak je prostredie nasadzované priamo z GIT repozitára a nepredpokladáte vykonanie ```hot-fixov``` priamo cez WebJET CMS nemusíte vyššie uvedené práva na zápis do súborového systému nastavovať. Naviac pre tento prípad odporúčame nastaviť na súborovom systéme oprávnenia zápisu len pre adresáre (ostatné adresáre a súbory majú oprávnenia len na čítanie):

- ```/images``` - obsahuje obrázky nahraté redaktormi CMS
- ```/files``` - obsahuje súbory nahraté redaktormi CMS
- ```/shared``` - obsahuje obrázky a súbory nahraté redaktormi CMS zdieľané medzi doménami
- ```/WEB-INF/tmp``` - obsahuje dočasné súbory CMS
- ```/WEB-INF/imgcache``` - obsahuje generované zmenšeniny a výrezy obrázkov pre použitie cez ```/thumb``` prefix
- ```/WEB-INF/formfiles``` - obsahuje súbory nahraté cez formuláre na web stránke vytvorené cez aplikáciu Formuláre

### Konfigurácia

Nastavte a skontrolujte nasledovné konfiguračné premenné (v administrácii Nastavenia->Konfigurácia):

- ```defaultDisableUpload=true``` - aktivuje režim, v ktorom má používateľ práva na súborový systém len pre nastavené adresáre. Ak nemá nastavený žiaden adresár nebude mať právo zápisu súboru do žiadneho adresára.
- ```fbrowserShowOnlyWritableFolders``` - po nastavení na ```true``` sa v prieskumníkovi zobrazia len súbory na ktoré má používateľ práva, ostatné súbory nebudú ani zobrazené. Štandardne sa zobrazujú aj súbory, na ktoré používateľ nemá práva, nie je ale možné ich modifikovať.
- ```emailProtectionSenderEmail``` - nastavte vhodnú emailovú adresu typu ```noreply@domena.sk```, ktorá sa použije ako email adresa odosielaných emailov (pôvodná hodnota sa nastaví do ```Reply-To``` hlavičky emailu).
- ```adminEnabledIPs``` - obsahuje čiarkou oddelený zoznam IP adries, z ktorých je povolený prístup do ```/admin``` časti.
- ```multidomainAdminHost``` - umožňuje nastaviť samostatnú doménovú adresu pre prístup do ```/admin``` časti, napr. ```cms.domena.sk```. Po nastavení bude volanie ```/admin``` adresy na ostatných doménach vracať chybu 404 - Stránka neexistuje.
- ```serverBeyoundProxy``` - ak je aplikačný server za Load Balancerom / proxy je potrebné nastaviť hodnotu na ```true``` (inak nastavte hodnotu ```false```). Load Balancer musí následne posielať v HTTP hlavičke ```x-forwarded-for``` IP adresu návštevníka web stránky a v hlavičke ```x-forwarded-proto``` protokol (```http``` alebo ```https```). Overte v audite (napr. po vyplnení formuláru na web stránke) korektné zaznamenanie IP adresy návštevníka web stránky.
- ```serverName``` - predvolene ```unknown``` - nastavuje hodnotu HTTP hlavičky ```Server``` pri HTTP odpovedi. Ak máte aplikačný server za Load Balancerom/proxy overte v HTTP odpovedi hodnotu tejto hlavičky a prípadne ju nastavte na Load Balanceri/proxy serveri na vhodnú neznámu hodnotu.

Obmedzenia pre nahrávané súbory redaktormi v administrácii:

- ```FCKConfig.UploadMaxSize[Default][image]``` - predvolene 0 - limit veľkosti v kB pre nahrávanie **obrázkov**, odporúčame nastaviť na hodnotu napr. 10000 pre nahratie max 10 MB obrázka
- ```FCKConfig.UploadMaxSize[Basic][image]``` - predvolene 2048 - limit veľkosti v kB pre nahrávanie **obrázkov** pre používateľov, ktorý **nemajú právo Kompletné menu v editore**
- ```FCKConfig.UploadMaxSize[Default][file]``` - predvolene 0 - limit veľkosti v kB pre nahrávanie **súborov**, odporúčame nastaviť na hodnotu napr. 50000 pre nahratie max 50 MB súboru
- ```FCKConfig.UploadMaxSize[Basic][file]``` - predvolene 2048 - limit veľkosti v kB pre nahrávanie **súborov** pre používateľov, ktorý **nemajú právo Kompletné menu v editore**
- ```FCKConfig.UploadFileTypes[Default][image]``` - predvolene prázdne = bez obmedzní - limity typov **obrázkov**, odporúčame nastaviť na hodnotu ```jpg,jpeg,png,gif,svg,mp3,mp4```. Možnosť povolenia prípony SVG je potrebné zvážiť, viď potencionálne riziko nižšie v bloku ```Stored XSS cez SVG obrázok```.
- ```FCKConfig.UploadFileTypes[Basic][image]```- predvolene ```jpg,jpeg,png,gif,mp4``` - limity typov **obrázkov** pre používateľov, ktorý **nemajú právo Kompletné menu v editore**
- ```FCKConfig.UploadFileTypes[Default][file]``` - predvolene prázdne = bez obmedzní - limity typov **súborov**, odporúčame nastaviť na hodnotu ```pdf,docx,xlsx,pptx,ppsx,zip,rtf```
- ```FCKConfig.UploadFileTypes[Basic][file]``` - predvolene ```doc,docx,xls,xlsx,pdf,zip,rtf``` - limity typov **súborov** pre používateľov, ktorý **nemajú právo Kompletné menu v editore**

Môžete skontrolovať ešte nasledovné konf. premenné:

- ```overviewJsonUrl``` - definuje URL adresu, z ktorej sa číta zoznam noviniek vo WebJETe. Ak používatelia nemajú dostupný internet z prehliadača, môžete nastaviť na hodnotu ```/admin/v9/json/``` pre čítanie z lokálnej inštancie. Používatelia ale nebudú vidieť novinky v nových verziách WebJET CMS.
- ```springSecurityAllowedAuths``` - zoznam povolených metód autorizácie pre REST služby, predvolene `basic,api-token`. Ak projekt nepotrebuje iné ako štandardné prihlásenie cez formulár, nastavte na prázdnu hodnotu. Po zmene hodnoty je potrebné reštartovať aplikačný server.

### HTTP hlavičky

V aplikácii Konfigurácia môžete nastaviť hodnoty bezpečnostných hlavičiek:

- ```contentSecurityPolicy``` - nastavenie hlavičky ```Content-Security-Policy```. Obmedzenie ako má stránka načítavať rôzne zdroje. Ak máte httpS certifikát môžete nastaviť na hodnotu: ```default-src 'none'; script-src https: blob: data: 'unsafe-inline' 'unsafe-eval'; worker-src https: blob:; child-src https: blob:; style-src https: data: 'unsafe-inline' 'unsafe-eval'; img-src https: data: 'unsafe-inline'; font-src https: data:; object-src blob: 'self'; base-uri 'none'; frame-ancestors 'self'; connect-src blob: 'self'; frame-src 'self'```. Predvolene prázdne (hlavička sa nenastavuje).
- ```contentSecurityPolicySvg``` - špecifické obmedzenie pre SVG obrázky z dôvodu ich iného spracovania v Internet Explorer.
- ```featurePolicyHeader``` - hodnota HTTP hlavičky ```Feature-Policy/Permissions-Policy``` (napr.: `microphone 'none'; geolocation 'none'`), viac na: https://developer.mozilla.org/en-US/docs/Web/HTTP/Feature_Policy. Predvolene prázdne.
- ```refererPolicy``` - nastavenie HTTP hlavičky ```Referrer-Policy```, odporúčame nastaviť na hodnotu ```same-origin```. Predvolene ```same-origin```.
- ```serverName``` - hodnota hlavičky ```Server``` v HTTP odpovediach. Predvolene ```unknown```. Nie je možné nastaviť na prázdnu hodnotu, pretože potom tam vloží hlavičku aplikačný server.
- ```strictTransportSecurity``` - predvolene prázdne - nastavuje HTTP hlavičku [Strict-Transport-Security](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) v HTTP odpovediach, čo zabezpečí presmerovanie HTTP požiadaviek na zabezpečený httpS, odporúčame nastaviť na hodnotu: ```max-age=31536000 ; includeSubDomains```. Vyžaduje, aby aplikačný server bol dostupný cez zabezpečený httpS protokol.
- ```xContentTypeOptions``` - hodnota hlavičky ```X-Content-Type-Options``` pre nastavenie určovania typov súborov podľa obsahu (ignorovanie prípony). Predvolene ```nosniff```.
- ```xFrameOptions``` - hodnota hlavičky ```X-Frame-Options``` pre ochranu pred CSRF útokom. Predvolene ```SAMEORIGIN```.
- ```xRobotsTagValue``` - hodnota hlavičky ```X-Robots-Tag``` pre URL adresy nastavené v premennej ```xRobotsTagUrls```. Predvolene ```noindex, nofollow```.
- ```xRobotsTagUrls``` - zoznam začiatkov URL adries oddelených čiarkou pre nastavenie hlavičky ```X-Robots-Tag```. Ak zoznam obsahuje hodnotu ```NOT_SEARCHABLE_PAGE``` nastaví sa hlavička aj pre stránky, ktoré majú vypnuté vyhľadávanie. Predvolene ```/components/,NOT_SEARCHABLE_PAGE```.
- ```xXssProtection```- hodnota hlavičky ```X-XSS-Protection``` pre ochranu pred XSS útokom. Predvolene ```1; mode=block```.

Nastavenie hlavičky ```Access-Control``` pre prístup k REST službám z iných serverov:

- ```accessControlAllowOriginValue``` - hodnota hlavičky ```Access-Control-Allow-Origin``` pre URL nastavene v premennej ```accessControlAllowOriginUrls```. V hodnote môžete použiť makro (viď nižšie). Predvolene nastavené na ```{HTTP_PROTOCOL}://{SERVER_NAME}:{HTTP_PORT}```.
- ```accessControlAllowOriginUrls``` - zoznam začiatkov URL adries oddelených čiarkou pre nastavenie hlavičky ```Access-Control-Allow-Origin```. Predvolene nastavené na ```/rest/,/private/rest/,/admin/rest/```.
- ```accessControlAllowHeaders``` - hodnota pre nastavenie hlavičky ```Access-Control-Allow-Headers```, nastavuje sa len pri generovaní hlavičky ```Access-Control-Allow-Origin```. Predvolene ```Origin, Accept, X-Requested-With, Content-Type, Access-Control-Request-Method, Access-Control-Request-Headers, x-csrf-token```.
- ```accessControlAllowMethods``` - hodnota pre nastavenie hlavičky ```Access-Control-Allow-Methods```, nastavuje sa len pri generovaní hlavičky ```Access-Control-Allow-Origin```. Predvolene ```HEAD,POST,GET,OPTIONS,PUT```.
- ```accessControlMaxAge``` - hodnota pre nastavenie hlavičky ```Access-Control-Max-Age```, nastavuje sa len pri generovaní hlavičky ```Access-Control-Allow-Origin```. Predvolene ```1800```.
- ```accessControlAllowedOrigins``` - ak nie je prázdne, vyžaduje pri požiadavke hlavičku ```origin```, ktorej hodnota sa musí nachádzať v tomto zozname (čiarkou/novým riadkom oddeleny zoznam). Nastavuje sa len pri generovaní hlavičky ```Access-Control-Allow-Origin```. Predvolene prázdne.

Ak potrebujete nastaviť inú HTTP hlavičku môžete použiť aplikáciu [HTTP hlavičky](../../admin/settings/response-header/README.md) v sekcii Nastavenia.

V hodnote môžete použiť makro ```{HTTP_PROTOCOL}, {SERVER_NAME}/{DOMAIN_NAME}/{DOMAIN_ALIAS}, {HTTP_PORT}```, ktoré bude nahradené za hodnotu získanú na serveri. ```SERVER_NAME``` je doménové meno z ```request.getServerName()```, ```DOMAIN_NAME``` a ```DOMAIN_ALIAS``` sú hodnoty domén alebo alias-u nastavené vo web stránkach. Hodnota ```{INSTALL_NAME}``` reprezentuje meno inštalácie. Hodnota ```{HEADER_ORIGIN}``` obsahuje hodnotu HTTP hlavičky ```origin```.

V starších inštaláciách bolo možné nastaviť HTTP hlavičky aj cez konf. premennú ```responseHeaders``` v ktorej viete nastaviť hlavičku pre URL prefix (začiatok URL adresy). Na každý riadok zadáte hodnotu vo formáte: ```url-prefix:hlavička:hodnota```, napríklad:

```
/admin:X-Accel-Buffering:no
/rest/calculators/:Access-Control-Allow-Origin:*
/rest/calculators/:Access-Control-Allow-Headers:origin,x-requested-with,access-control-request-headers,content-type,access-control-request-method,accept,x-csrf-token
/rest/calculators/:Access-Control-Allow-Methods:GET,OPTIONS
```

Hodnoty nastavené cez konf. premennú ```responseHeaders``` sú globálne bez ohľadu na aktuálnu doménu.

### Pravidlá hesiel

Pravidlá pre heslá je možné nastaviť cez nasledovné konfiguračné premenné (pri premennej je v zátvorke uvedená štandardná hodnota):

- ```passwordAdminMinLength``` - Určuje minimálne akej dĺžky ma byť heslo pre administrátora (5).
- ```passwordAdminMinCountOfSpecialSigns``` - Určuje minimálny počet výskytu špeciálnych znakov v hesle pre administrátora (0).
- ```passwordAdminMinUpperCaseLetters``` - Určuje minimálny počet výskytu veľkých písmen v hesle pre administrátora (1).
- ```passwordAdminMinLowerCaseLetters``` - Určuje minimálny počet výskytu malých písmen v hesle pre administrátora (0).
- ```passwordAdminMinCountOfDigits``` - Určuje minimálny počet výskytu čísel v hesle pre administrátora (1).
- ```passwordAdminExpiryDays``` - Určuje počet dní platnosti hesla pre administrátora. Po uplynutí času, bude užívateľ vyzvaný si zmeniť heslo. Hodnota 0 znamená, že sa nekontroluje exspirácia hesla (0).

Podobne sa dajú nastaviť pravidlá hesiel aj pre prihlásenie do zabezpečenej zóny web stránky (nie administrácie), premenné sú rovnaké, ale neobsahujú výraz ```Admin```. Čiže meno premennej je napr. ```passwordMinUpperCaseLetters```.

Nastavením konfiguračnej premennej ```isGoogleAuthRequiredForAdmin``` na ```true``` bude pre prístup do ```/admin``` časti vyžadovaná dvoj faktorové overovanie. Každý používateľ ju vopred musí nastaviť v administrácii kliknutím na svoje meno vpravo hore a zvolením možnosti **Dvojstupňové overovanie**, respektíve otvorením stránky ```/admin/2factorauth.jsp```.

Dvojstupňové overovanie odporúčame nastaviť minimálne na všetky kontá, cez ktoré je možné spravovať používateľské účty a práva a nastavovať konfiguráciu systému.

WebJET kontroluje pri zmene hesla históriu a nepovoľuje opakovane použiť rovnaké heslo. Ovplyvňujú to nasledovné konf. premenné:

- ```passwordHistoryLength``` - počet použitých hesiel používateľa, ktoré sa pamätajú v histórii (predvolene 6).
- ```passwordHistoryEnabled``` - ak je nastavené na ```true``` je kontrolovaná v databáze aj história hesiel a nie je povolené pri zmene hesla použiť také, ktoré bolo v minulosti (predvolene ```true```).

Pri požiadavke na zmenu hesla sú použité nasledovné premenné:

- ```passwordResetValidityInMinutes``` - časová platnosť v minútach pre zaslaný odkaz na zmenu hesla (predvolene 30).
- ```changePasswordPageUrl``` - adresa stránky pre zmenu hesla (predvolene ```/components/user/change_password.jsp```).

### Blokovanie prihlásenia

Po nesprávnej kombinácii mena a hesla WebJET blokuje ďalšie prihlásenie z rovnakej IP adresy. Je možné nastaviť nasledovné konf. premenné:

- `logonBlockedDelay` - čas v sekundách, počas ktorých nebude možné sa znova prihlásiť po zadaní zlého mena/hesla (predvolene 10).
- `logonBlockedAfterUnsuccessCount` - počet neúspešných prihlásení po ktorých sa aplikuje zdržanie definované v `logonLoginBlockedDelay` (predvolene 5).
- `logonLoginBlockedDelay` - čas v sekundách, počas ktorých nebude možné znova sa prihlásiť po zadaní zlého hesla a `logonBlockedAfterUnsuccessCount` počtu neúspešných prihlásení pre zadané prihlasovacie meno (predvolene 60).

Štandardne sa teda aplikuje hodnota 10 sekúnd (`logonBlockedDelay`), ak sa zadá za sebou viac ako 5 krát (`logonBlockedAfterUnsuccessCount`) aplikuje sa zdržanie 60 sekúnd (`logonLoginBlockedDelay`).

Počas času blokovania prihlásenia sa naďalej nezvyšuje počítadlo neúspešných pokusov a nepredlžuje sa čas, keďže nedochádza vôbec k volaniu kódu prihlasovania.

### Algoritmus hashovania hesiel

Od verzie ```2022.40``` sa používa na hashovanie hesiel algoritmus BCrypt v implementácii ```org.springframework.security.crypto.bcrypt.BCrypt```.

Možné nastavenia:

- ```bcryptSaltRounds``` (predvolene 12) - log2 počtu opakovaní saltovania
- ```passwordHashAlgorithm``` (predvolene ```bcrypt```) - meno algoritmu pre hashovanie, možné hodnoty ```bcrypt``` alebo ```sha-512```.

Staršie verzie používali algoritmus ```SHA-512``` so 100 násobným opakovaním. Staršie hash hodnoty hesla sa zmenia na bcrypt algoritmus pri zmene hesla používateľa. Ak chcete vynútiť zmenu algoritmu môžete nastaviť konf. premennú ```passwordAdminExpiryDays``` na nenulové hodnotu, čo vyvolá požiadavku na zmenu hesla po prihlásení používateľa.

### Prihlasovanie do administrácie

Prihlasovanie do administrácie ovplyvňujú už aj vyššie spomenuté konfiguračné premenné:

- ```adminEnabledIPs``` - obsahuje čiarkou oddelený zoznam IP adries, z ktorých je povolený prístup do ```/admin``` časti.
- ```multidomainAdminHost``` - umožňuje nastaviť samostatnú doménovú adresu pre prístup do ```/admin``` časti, napr. ```cms.domena.sk```. Po nastavení bude volanie ```/admin``` adresy na ostatných doménach vracať chybu 404 - Stránka neexistuje.
- ```isGoogleAuthRequiredForAdmin``` - zapnutie dvoj faktorového overovania pri prihlásení do administrácie ```/admin```.
- ```clusterMyNodeType``` - v prípade clustra nastavuje režim uzla, len uzly nastavené na hodnotu ```full``` obsahujú administráciu a umožňujú prihlásenie do nej.
- ```auditDontLogUsrlogon``` - po nastavení na ```true``` sa nebude auditovať bežné (nie administrátorské) prihlásenie používateľa. Vhodné na vysoko zaťažený intranet kde to zbytočne zahlcuje audit (predvolene ```false```).

Používateľ, ktorý sa úspešne autorizuje musí naviac spĺňať nasledovné kritéria:

- ```Schválený používateľ``` - účet musí mať zvolenú uvedenú možnosť.
- ```Začiatok platnosti``` - ak je zadaná hodnota musí byť staršia ako aktuálny dátum.
- ```Koniec platnosti``` - ak je zadaná hodnota musí byť väčšia ako aktuálny dátum.
- ```Povoliť vstup do admin sekcie (správa web sídla)``` - účet musí mať povolenú uvedenú možnosť, inak nie je možný prístup do administrácie.

V prípade špeciálnych požiadaviek na prihlasovanie/overovanie používateľa je možné implementovať vlastnú Java triedu prihlasovania a nastaviť ju cez konf. premennú ```adminLogonMethod```. Následne sa použije zadaná Java trieda namiesto štandardného prihlásenia.

Pri prihlasovaní sa pri nesprávnych údajoch [blokuje prihlásenie](#blokovanie-prihlásenia).

### Overovanie voči LDAP serveru

Pri overovaní používateľa voči LDAP serveru je možné nastaviť nasledovné konf. premenné:

- ```ldapProviderUrl``` - URL adresa LDAP servera pre prihlasovanie cez LDAP v tvare ```ldap://ldap.local:389/DC=firma,DC=com??base```.
- ```ldapPassword``` - prihlasovacie meno technického používateľa pre získanie údajov z LDAP.
- ```ldapUsername``` - prihlasovacie heslo technického používateľa pre získanie údajov z LDAP.
- ```ldapUseSslProtocol``` - použije SSL pri komunikácii s LDAP serverom. Je potrebné mať povolené SSL na porte 636 LDAP servera. Ak sa používa ldapS://, nechať hodnotu na false.
- ```NTLMForbiddenURL``` - URL adresa zamietnutého prístupu (predvolene ```/500.jsp```).
- ```NTLMDomainController``` - meno doménového radiča.
- ```ldapDomainAppend``` - ak je potrebné prihlasovanie s celou doménou tu je možne zadať jej doplnenie k zadanému prihlasovaciemu menu používateľa.
- ```ldapSecurityPrincipalDn``` - nastaví pre LDAP špeciálny ```SECURITY_PRINCIPAL``` napr. ```cn=!USERNAME!,dc=ad,dc=interway,dc=sk``` s tým, že ```!USERNAME!``` zamení za prihlasovacie meno. Pokiaľ je prázdne použije sa ```ldapUsername+ldapDomainAppend```.
- ```ldapFilter``` - prihlasovací filter pre LDAP prihlasovanie s ktorým sa vykoná vyhľadanie konta (predvolene ```(&(objectClass=Person) (&(sAMAccountName=!USERNAME!)))```).
- ```basicNtlmLogonAttrs``` - zoznam atribútov, ktoré sa majú čítať z LDAP servera pri prihlasovaní. Ak je prázdne, overí sa len prihlásenie a používateľ sa neaktualizuje hodnotamy v LDAP serveri. Predvolene ```mail,title,givenName,sn,streetAddress,l,postalCode,co,company,telephoneNumber,mobile,description,memberOf,distinguishedName,thumbnailPhoto```.
- ```ntlmDefaultUserPhoto``` - ak je zadané na neprázdnu hodnotu a používateľ nemá v LDAP fotografiu nastaví fotku podľa zadanej URL adresy.

Nastavenie práv:

Po prihlásení sa automaticky kontroluje zhoda mena skupiny používateľov a skupiny práv voči skupinám v LDAP (atribút ```memberOf```). Ak sa meno zhoduje skupina vo WebJETe sa používateľovi priradí. Okrem toho je možné nastaviť:

- ```NTLMAdminGroupName``` - meno skupiny v LDAP ktorá identifikuje, že konto má prístup do administrácie (napr. WebJETAdmins).
- ```passwordProtectedAutoId``` - čiarkou oddelený zoznam ID skupín používateľov, ktoré budú priradené automaticky používateľovi po úspešnom prihlásení.

### Konfigurácia aplikačného servera Tomcat

Predpokladáme, že web stránka/aplikácia bude dostupná cez zabezpečený httpS protokol. Preto je potrebné nastaviť atribút ```secure="true"```, [HTTP/AJP konektora](https://tomcat.apache.org/tomcat-9.0-doc/config/http.html), aby session cookie bola dostupná len cez zabezpečený httpS protokol. Nastavenie vykonáte v súbore ```tomcat/conf/server.xml```. Atribút `useBodyEncodingForURI="true"` nastavuje rovnaké kódovanie znakov pre URL adresu ako je použité pre telo stránky.

```xml
<Connector
    ...
    secure="true"
    useBodyEncodingForURI="true"
    ...
/>
```

ak použijete nezabezpečený HTTP protokol nebude session cookie v prehliadači akceptovaná a session nebude držaná (prejaví sa to opakovaným zobrazením prihlasovacieho okna hneď po zadaní správnych prihlasovacích údajov).

Aby sa pri zobrazení chyby nezobrazila verzia aplikačného servera `Tomcat` a ```Stack Trace``` je potrebné v server.xml do ```<Host``` elementu pridať konfiguráciu [ErrorReportValve](https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Error_Report_Valve):

```xml
<Host ...>
    <Valve className="org.apache.catalina.valves.ErrorReportValve"
        showReport="false"
        showServerInfo="false" />
</Host>
```

v prípade potreby môžete vytvoriť aj statickú html stránku v kódovaní ```utf-8``` s chybovou správou a nakonfigurovať ju ako:

```xml
<Valve className="org.apache.catalina.valves.ErrorReportValve"
    errorCode.400="webapps/error400.html"
    errorCode.0="webapps/errorOthers.html"
    showReport="false"
    showServerInfo="false" />
```

V konfiguračnom súbore `server.xml` odporúčame správne nastaviť možnosť `defaultHost`. Útočníci môžu modifikovať hlavičku `Host` a teda smerovať požiadavku z internetu napr. na administračný host, ktorý nemusel byť z internetu dostupný (ak na jednom aplikačnom serveri beží administračný aj verejný uzol clustra). Príkladom je použitie `localhost`, ktoré môže byť priradené k administračnému serveru a teda upravená požiadavka môže skončiť na administračnom node.

Hodnotu `defaultHost` odporúčame smerovať na neexistujúci `<Host` element, v takom prípade vyhlási aplikačný server chybu, že taký `host` nepozná. Aplikačný server teda nespracuje neznáme domény. Nevýhoda takéhoto riešenia je, že po pridaní novej domény je potrebné ju pridať ako `<Alias` aj do aplikačného servera.

Ak používate Load Balancer je potrebné zabezpečiť, aby na aplikačné servre posielal len známe (whitelist) domény. Pre neznáme domény musí odpovedať chybou.

```xml
<Engine name="Catalina" defaultHost="localhost">

    <Host name="localhost"...>
        <Alias>admin.domain.eu</Alias>
    </Host>
```

### Notifikácie pri zmene

Odporúčame nastaviť notifikácie posielané bezpečnostnému technikovi na nasledovné typy udalostí:

- ```CONF_UPDATE``` a ```CONF_DELETE``` - zmena/zmazanie konfiguračnej premennej
- ```PROP_UPDATE``` a ```PROP_DELETE``` - zmena/zmazanie prekladového kľúča (cez prekladový kľúč je možné vkladať aj JavaScript kód)

Notifikácie nastavíte v administrácii v časti Audit->Notifikácie. Bezpečnostný technik bude mať prehľad o týchto zmenách a v prípade podozrenia na útok môže zareagovať.

### Bezpečnosť servera

Dôležitá je aj bezpečnosť samotného servera a použitého softvéru. Aktualizujte softvér na aktuálne podporované verzie. Vhodné je inštalovať na server aj antivírus, ktorý bude kontrolovať nahrávané súbory a v prípade detekcie vírusu v súbore zamedzí k tomuto súboru prístup.

## Nastavenie Load Balancera

Ak je pred aplikačnými servermi predradený Load Balancer je potrebné zabezpečiť:

- Smerovať na aplikačné serve len definované domény, aby nemohol nastať útok modifikovaním `Host` hlavičky. Load Balancer nesmie povoliť poslanie neznámej domény na aplikačný server.
- WebJET preberá nastavenie IP adresy z HTTP hlavičky `X-Forwarded-For` pri nastavení konfiguračnej premennej `serverBeyoundProxy=true`. Je teda potrebné zabezpečiť, aby takáto HTTP hlavička neprechádzala z internetu ale Load Balancer ju vždy prepísal na korektnú hodnotu - IP adresu návštevníka. To isté platí pre HTTP hlavičku `x-forwarded-proto`. Nesprávne nastavenie hlavičky môže viesť k sprístupneniu častí, ktoré sú povolené len pre špecifické IP adresy, ako napríklad administrácia.

## Nastavenie WAF

Ak je pred aplikačným serverom predradený `Web Application Firewall/WAF` je potrebné nastaviť **výnimky pre administráciu**. Niektoré HTTP požiadavky v administrácii môžu byť detegované ako útok typu XSS/SQL Injection, pretože HTTP požiadavka môže odosielať JavaScript kód, alebo SQL príkaz. Príkladom je ukladanie web stránky, kde v poli HTML kód do hlavičky môže byť vložený potrebný JavaScript kód, alebo ukladanie záznamov v aplikácii Skripty, kde sa priamo vkladá JavaScript kód.

Ideálne riešenie je použiť cluster riešenie s dedikovaným CMS uzlom v lokálnej sieti, ktorý je nedostupný z vonkajšieho prostredia. Pre tento prípad je možné WAF pre CMS nod nepoužiť.

Administrácia používa REST služby začínajúce na URL adresu `/admin/rest`, viď odporúčania pre [pravidlá URL adries](../../custom-apps/spring/rest-url.md#pravidlá-url-adries). Na WAF je potrebné nastaviť výnimky pre URL adresy začínajúce na:

- `/admin/rest/web-pages` - ukladanie web stránok
- `/admin/rest/components/insert-script` - aplikácia Skripty
- `/admin/v9/settings/translation-keys` - prekladové kľúče - v niektorých prípadoch môže byť potrebné vkladať HTML kód do prekladového kľúča
- `/admin/rest/settings/configuration` - konfigurácia, platí podobné ako pre prekladové kľúče
- `/admin/searchall.jsp` - vyhľadávanie v administrácii, môže byť potrebné hľadať aj HTML/JavaScript výraz
- `/admin/replaceall.jsp` - nahradenie výrazu v administrácii, platí podobné ako pre vyhľadávanie
- `/admin/updatedb.jsp` - vykonanie zadaného SQL príkazu

Ďalšie URL adresy je vhodné nastaviť na základe používaných aplikácií.

## Riešenie bezpečnostných nálezov

- `Sensitive Data Exposure`

Prostredníctvom chybových odpovedí so servera sa podarilo odhaliť typ a verziu použitého webového servera.

Riešenie: overte nastavenie HTTP hlavičky ```Server```, vo WebJETe sa dá prestaviť v konfiguračnej premennej ```serverName```, viď vyššie.

- `RCE via uploaded JSP file`

WebJET CMS umožňuje nahrávanie ľubovoľných súborov vrátane súborov typu JSP, ktoré umožňujú vykonávanie ľubovoľných príkazov na bežiacom serveri.

Chybe sa dá zabrániť nastavení práv pre nahrávanie súborov, alebo úplným zamedzením zápisu programových súborov.

Riešenie: upravte nastavenie práv pre nahrávanie súborov cez konfiguračné premenné ```FCKConfig.Upload*```, viď vyššie.

- `MaliciousFileUpload`

Na serveri chýba antivírusová kontrol, je teda možné na server nahrať škodlivé súbory.

Riešenie: nainštalujte na server antivírus.

- `Missing Secure cookie flag`

Session cookie (`JSESSIONID`) nemá nastavený bezpečnostný atribút `Secure`.

Riešenie: skontrolujte a nastavte ```secure``` atribút v súbore [server.xml](https://tomcat.apache.org/tomcat-9.0-doc/config/http.html) aplikačného servera Tomcat, viď vyššie.

- `Missing HTTP Strict Transport Security policy`

Aplikácia nenastavuje HTTP hlavičku ```Strict Transport Security```.

Riešenie: hodnotu [hlavičky Strict Transport Security](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) je možné nastaviť v konfiguračnej premennej ```strictTransportSecurity=max-age=31536000 ; includeSubDomains```, viď. vyššie.

- `Stored XSS cez SVG obrázok`

SVG súbor umožňuje vložiť do tela aj JavaScript kód, v prípade priameho zobrazenia takéhoto súboru v prehliadači sa JavaScript kód vykoná (pri štandardnom vložení cez ```img``` sa kód nevykoná a zobrazenie je bezpečné).

Riešenie: obmedziť možnosť nahrávania SVG súborov, viď nastavenie práv vyššie. Ako ochranu WebJET CMS generuje pre súbory typu SVG HTTP hlavičku ```Content-Security-Policy``` s hodnotou ```default-src 'self'```, ktorá [zamedzí vykonaniu javascript kódu](https://github.com/digininja/svg_xss) pri priamom zobrazení obrázku. Hodnota je nastaviteľná cez konfiguračnú premennú ```contentSecurityPolicySvg```.

Pre overenie správania vytvorte SVG súbor s nasledovným obsahom, nahrajte ho do WebJET CMS a vložte do testovacej stránky a overte jeho zobrazenia a (ne)vykonanie XSS útoku:

```xml
<?xml version="1.0" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg"> <polygon id="triangle" points="0,0 0,100 100,0" fill="#3e70b7"
stroke="#004400"/>
<script type="text/javascript">
alert("SVG XSS");
</script>
</svg>
```

- `Stored XSS` cez úpravu prekladových kľúčov

Cez prekladové texty je redaktor schopný vykonať útok typu ```Cross Site Scripting``` voči ostatným návštevníkom webu, alebo iným administrátorom.

Prekladové kľúče sa používajú aj na vkladanie HTML kódu (napr. odkazu na obchodné podmienky v kalkulačke, zvýraznenie tučným písmom, nastavenie CSS štylov), preto táto aplikácia technicky umožňuje vkladať aj HTML/JavaScript kód (jedná sa o vlastnosť, nie chybu). Treba si uvedomiť, že redaktor môže vložiť JavaScript kód aj priamo v editore stránok, nie je zásadný dôvod mu v tom zabraňovať aj v editácii prekladových kľúčov.

Riešenie: Minimalizovať počet používateľov s prístupom k aplikácii Prekladové texty. Zároveň používatelia, ktorý nemajú právo "Editácia textov - zobrazenie všetkých textov" majú obmedzené možnosti editácie. Môžu editovať len vybrané kľúče (nastavené cez konf. premennú ```propertiesEnabledKeys```) a zároveň upravená hodnota je filtrovaná a povolí len definované HTML značky a atribúty. Tie sa nastavujú v konf. premennej ```propAllowedTags``` kde sú štandardne povolené značky ```p,div,a,sub,sup,br,strong``` a atribúty v konf. premennej ```propAllowedAttrs``` kde sú štandardne povolené atribúty ```href,src,style,class,rel```. Ak chcete úplne zabrániť možnosti vkladania HTML kódu pre používateľov bez oprávnenia "Editácia textov - zobrazenie všetkých textov" môžete nastaviť konf. premennú ```propAllowedTags``` na prázdnu hodnotu (alebo znak ```-```). Nastavením na znak ```*``` sa ochrana vypne.

Zároveň ako ďalšiu ochranu odporúčame nastaviť notifikácie pri zmene na bezpečnostného technika, viď vyššie.

- `Insecure Deserialization`

Import web stránok obsahuje .xml dokumenty so serializovanými java objektami. Tieto .xml dokumenty je však možné zmeniť a podstrčiť vlastné serializované java objekty typu ```<object class="java.lang.Runtime" method="getRuntime">```, ktoré vykonajú zadanú operáciu priamo na serveri.

Pre úspešnú exploitáciu je potrebné upraviť konf. premennú ```XMLDecoderAllowedClasses```, ktorá obsahuje zoznam povolených deserializovaných objektov a pridať tam hodnotou ```java.lang.Runtime```.

Riešenie: bežný používateľ nesmie mať oprávnenia na úpravu konfiguračných premenných, tie by mala upravovať len vyhradená osoba. Ako ďalšiu ochranu sme priamo do kódu (bez možnosti upraviť tento zoznam) doplnili nepovolené typy objektov, ktoré nie je možné cez konfiguráciu pridať (povoliť).

- `Cookies: Set the 'SameSite' flag as a counter measure to cross-site request forgery`

Pre ```cookies``` je možné nastaviť atribút [SameSite](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie/SameSite) pre zamedzenie posielania cookies pri CSRF útoku (zamedzenie posielania cookies iným doménam).

Aktuálne sa v ```servlet-api``` pripravuje podpora nastavenia tejto hodnoty vo verzii 5.x, čo môže znamenať dlhé čakanie na priamu podporu pri programovaní. Pri použití Apache Tomcat je ale možné túto hodnotu nastaviť v konfigurácii pomocou [CookieProcessor](https://tomcat.apache.org/tomcat-8.5-doc/config/cookie-processor.html), ktorý v štandardnej implementácii umožňuje hodnotu nastaviť:

```xml
<Context>
    ...
    <CookieProcessor sameSiteCookies="strict"/>
</Context>
```