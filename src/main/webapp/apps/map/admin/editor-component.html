<script src="/components/form/event_attacher.js" type="text/javascript"></script>
<script src="/components/form/class_magic.js" type="text/javascript"></script>
<script src="/components/form/check_form_impl.jsp" type="text/javascript"></script>


<style>
    .map-wrapper {
        clear: both;
        margin-top: 15px;
    }

    #previewIframe {
        width: 100%;
        height: 410px;
        display: none;
    }
</style>

<script>
    var coordinates = false;
    var mapKey = null;
    var mapProvider = null;

    function insertIframeDiv() {
        const iframeDiv = document.createElement("div");
        iframeDiv.classList.add("map-wrapper", "col-sm-12");

        const iframe = document.createElement("iframe");
        iframe.id = "previewIframe";
        iframe.src = "/components/iframe_blank.jsp";

        // IFRAME
        iframe.addEventListener("load", function() {
            const iframeDocument = this.contentWindow.document;
            iframeDocument.addEventListener('click', function() {
                var coords = localStorage.getItem('coords');
			    coords = JSON.parse(coords);

                coordinates = true;
                document.getElementById("DTE_Field_latitude").value = coords.lat;
                document.getElementById("DTE_Field_longitude").value = coords.lng;
                document.getElementById("DTE_Field_object").value = "";
            });
        });

        iframeDiv.appendChild(iframe);
        document.getElementById("panel-body-dt-component-datatable-basic").appendChild(iframeDiv);

        const infoDiv = document.createElement("div");
        infoDiv.classList.add("col-sm-12");
        infoDiv.style.textAlign = "center";
        infoDiv.innerHTML = '<p>Kliknutím na mapu môžete upresniť bod, na ktorom sa zobrazí pin.</p><p></p>';
        document.getElementById("panel-body-dt-component-datatable-basic").appendChild(infoDiv);
    }

    function showLookup()
    {
        var object		   = document.getElementById("DTE_Field_object").value.replace('"','').replace('"','');
        var latitude 	   = document.getElementById("DTE_Field_latitude").value.replace('"','').replace('"','');
        var longitude 	   = document.getElementById("DTE_Field_longitude").value.replace('"','').replace('"','');

        var sizeInPercent  = document.getElementById("DTE_Field_sizeInPercent_0").checked;
        var widthPercent   = document.getElementById("DTE_Field_widthPercent").value.replace('"','').replace('"','');
        var heightPercent  = document.getElementById("DTE_Field_heightPercent").value.replace('"','').replace('"','');
        var width 	       = document.getElementById("DTE_Field_widthPx").value.replace('"','').replace('"','');
        var height 	       = document.getElementById("DTE_Field_heightPx").value.replace('"','').replace('"','');

        var zoom 	       = document.getElementById("DTE_Field_zoom").value.replace('"','').replace('"','');
        var showControls   = document.getElementById("DTE_Field_showControls_0").checked;
        var scrollwheel    = document.getElementById("DTE_Field_scrollwheel_0").checked;

        var showLabel      = document.getElementById("DTE_Field_labelAddress_0").checked;
        var label          = document.getElementById("DTE_Field_label").value.replace('"','').replace('"','');
        var closeLabel     = document.getElementById("DTE_Field_closeLabel_0").checked;
        var labelComment   = document.getElementById("DTE_Field_labelComment_0").checked;

        var offsetX 	   = document.getElementById("DTE_Field_offsetX").value.replace('"','').replace('"','');
        var offsetY 	   = document.getElementById("DTE_Field_offsetY").value.replace('"','').replace('"','');

        var mapType;
        if (mapProvider == 'GoogleMap') {
            mapType = "google"
        } else {
            mapType = "open";
        }

        if (sizeInPercent) {
            width = widthPercent;
            height = heightPercent;
        }

        if(labelComment !== true) {
            label = "";
        }

        str = "/components/map/"+mapType+"_map_preview.jsp?object="+object+"&width="+width+"&height="+height+"&zoom="+zoom+"&scrollwheel="+scrollwheel+"&sizeInPercent="+sizeInPercent+"&showContentString="+showLabel;
        str += "&offsetX="+offsetX+"&offsetY="+offsetY+"&label="+label+"&latitude="+latitude+"&longitude="+longitude+"&closeLabel="+closeLabel+"&showControls="+showControls;

        $("#previewIframe").attr("src", str);
        $("#previewIframe").show();
    }

    function addShowMapButtons(parentId, btnKey = "Zobrazit náhled mapy") {
        const wrapper = document.createElement("div");
        wrapper.classList.add("row");
        wrapper.style.marginTop = "15px";

        const colDiv = document.createElement("div");
        colDiv.classList.add("col-sm-4");
        wrapper.appendChild(colDiv);

        const button = document.createElement("button");
        button.classList.add("btn", "btn-primary");
        button.innerText = btnKey;
        button.addEventListener("click", function() {
            showLookup();
            document.getElementById("pills-dt-component-datatable-basic-tab").click();
        });

        const buttonColDiv = document.createElement("div");
        buttonColDiv.classList.add("col-sm-8");
        buttonColDiv.appendChild(button);
        wrapper.appendChild(buttonColDiv);

        // Add to parent
        document.getElementById(parentId).appendChild(wrapper);
    }

    // helper function to find ckEditorInstance in parent window hierarchy and call method
    function callCkEditorMethod(methodName) {
        let currentWindow = window;
        while (currentWindow) {
            try {
                if (currentWindow.ckEditorInstance && typeof currentWindow.ckEditorInstance[methodName] === 'function') {
                    return currentWindow.ckEditorInstance[methodName]();
                }
                if (currentWindow === currentWindow.parent) break;
                currentWindow = currentWindow.parent;
            } catch (e) {
                // cross-origin boundary
                return false;
            }
        }
        return false;
    }

    function appAfterInit(response, datatable) {
        mapProvider = response.data.mapProvider;
        mapKey = response.data.mapKey;

        if(response.data.object == null || response.data.object == "") {
            // object (aka address) is empty, check if latitude and longitude are filled, if yes, show them on map preview
            if(response.data.latitude != null && response.data.latitude != "" && response.data.longitude != null && response.data.longitude != "") {
                coordinates = true;
            }
        }

        window.addEventListener("WJ.DTE.opened", function(e) {
            // Maximalize modal window to have more space for map preview
            callCkEditorMethod('maximalizeWindow');

            // Add buttons to show map preview
            addShowMapButtons("panel-body-dt-component-datatable-basic", "Zobrazit");
            addShowMapButtons("panel-body-dt-component-datatable-mapSettings");
            addShowMapButtons("panel-body-dt-component-datatable-pinSettings");

            // Insert iframe for map preview
            insertIframeDiv();

            setTimeout(function() {
                // Show map preview with current settings after modal is opened and iframe is loaded
                showLookup()
            }, 500);

            const object = document.getElementById("DTE_Field_object");
            const latitude = document.getElementById("DTE_Field_latitude");
            const longitude = document.getElementById("DTE_Field_longitude");
            object.addEventListener("keyup", function() {
                latitude.value = "";
                longitude.value = "";
                coordinates = false;
            });

            const sizeInPercentCheckbox = document.getElementById("DTE_Field_sizeInPercent_0");
            sizeInPercentCheckbox.addEventListener("change", function() {
                if(this.checked !== true) {
                    document.getElementById("DTE_Field_widthPercent").setAttribute("disabled", "disabled");
                    document.getElementById("DTE_Field_heightPercent").setAttribute("disabled", "disabled");

                    document.getElementById("DTE_Field_widthPx").removeAttribute("disabled");
                    document.getElementById("DTE_Field_heightPx").removeAttribute("disabled");
                } else {
                    document.getElementById("DTE_Field_widthPercent").removeAttribute("disabled");
                    document.getElementById("DTE_Field_heightPercent").removeAttribute("disabled");

                    document.getElementById("DTE_Field_widthPx").setAttribute("disabled", "disabled");
                    document.getElementById("DTE_Field_heightPx").setAttribute("disabled", "disabled");
                }
            });
            sizeInPercentCheckbox.dispatchEvent(new Event("change"));

            const labelCommentCheckbox = document.getElementById("DTE_Field_labelComment_0");
            labelCommentCheckbox.addEventListener("change", function() {
                if(this.checked === true) { document.querySelector(".DTE_Field_Name_label").style.display = "flex"; }
                else { document.querySelector(".DTE_Field_Name_label").style.display = "none"; }
            });
            labelCommentCheckbox.dispatchEvent(new Event("change"));
        });
    }

    function appGetComponentCode(componentPath, params, componentDatatable, isInsert) {

        // loop params, if any param is undefined replace it with empty string
        // if boolean value is in array, convert it to true/false
        for (const key in params) {
            if (params[key] === undefined || params[key] === "undefined") {
                params[key] = "";
            } else if (Array.isArray(params[key]) && params[key].length === 1 && typeof params[key][0] === "boolean") {
                params[key] = params[key][0];
            }
        }

        // Determine if content string should be shown
        const showContentString = params["labelAddress"] || params["labelComment"];

        // Determine size parameters
        const sizeParams = params["sizeInPercent"] === false
            ? `widthPercent=${params["widthPercent"]}, heightPercent=${params["heightPercent"]}`
            : `width=${params["widthPx"]}, height=${params["heightPx"]}`;

        // Determine location parameters
        const locationParams = coordinates !== true
            ? `object="${params["object"]}"`
            : `latitude="${params["latitude"]}",longitude="${params["longitude"]}"`;

        // Build URL with all parameters
        const url = `!INCLUDE(/components/map/map.jsp, offsetX=${params["offsetX"]}, offsetY=${params["offsetY"]}, ${sizeParams}, labelAddress=${params["labelAddress"]}, labelComment=${params["labelComment"]}, zoom=${params["zoom"]}, label="${params["label"]}", sizeInPercent=${params["sizeInPercent"]}, showControls=${params["showControls"]}, closeLabel=${params["closeLabel"]}, showContentString=${showContentString}, scrollwheel=${params["scrollwheel"]}, ${locationParams}${mapKey !== "" ? `, key="${mapKey}"` : ""})!`;

        return url;
    }

</script>