<script>

    var innerTable = null;
    var visibilityOptions = [];
    var fields = ["required", "label", "value", "placeholder", "tooltip"];

    function getFieldOption(field) {
        for (var i = 0; i < visibilityOptions.length; i++) {
            var option = visibilityOptions[i];
            if(option.value === field) {
                return option.label;
            }
        }
        return "";
    }

    function appAfterXhr(response) {
        const formSettingsBasicTabCols = ["recipients", "emailTextBefore", "emailTextAfter", "forceTextPlain", "addTechInfo"];
        const formSettingsAdvancedTabCols = ["ccEmails", "bccEmails", "replyTo", "subject", "forward", "forwardFail", "forwardType", "useFormMailDoc", "formmailSendUserInfoDoc", "afterSendInterceptor", "encryptKey", "encrypKeyInfo"];

        let filteredColumns = [];
        response.columns.forEach(function(column) {
            if(column.className != null && column.className.includes("not-formsimple")) {
                //Skip column, do NIOT add to filteredColumns
                return;
            }
            let columNameWithoutPrefix = column.data.replace("formSettings.", "");

            if(formSettingsBasicTabCols.includes(columNameWithoutPrefix)) {
                column["tab"] = "basic";
                column.editor["tab"] = "basic";
                filteredColumns.push(column);
            } else if(formSettingsAdvancedTabCols.includes(columNameWithoutPrefix)) {
                column["tab"] = "advanced";
                column.editor["tab"] = "advanced";
                filteredColumns.push(column);
            } else {
                filteredColumns.push(column);
            }
        });

        // Sort filteredColumns by tab, then first put columns not present in the configured lists,
        // followed by those present ordered by their position in the corresponding list
        const tabOrder = { basic: 0, advanced: 1 };
        filteredColumns.sort(function(a, b) {
            const aTab = a.tab || 'basic';
            const bTab = b.tab || 'basic';

            // 1) Sort by tab
            const tabCmp = (tabOrder[aTab] || 99) - (tabOrder[bTab] || 99);
            if (tabCmp !== 0) return tabCmp;

            // 2) Within same tab: prefer columns not in predefined lists
            const aName = (a.data || '').replace('formSettings.', '');
            const bName = (b.data || '').replace('formSettings.', '');

            const isInAList = aTab === 'basic' ? formSettingsBasicTabCols.includes(aName) : formSettingsAdvancedTabCols.includes(aName);
            const isInBList = bTab === 'basic' ? formSettingsBasicTabCols.includes(bName) : formSettingsAdvancedTabCols.includes(bName);

            if (isInAList !== isInBList) {
                // false (not in list) should come first
                return isInAList ? 1 : -1;
            }

            // 3) Both in list (or both not): if in list, sort by index in the list; otherwise keep stable order
            if (isInAList && isInBList) {
                const aIdx = aTab === 'basic' ? formSettingsBasicTabCols.indexOf(aName) : formSettingsAdvancedTabCols.indexOf(aName);
                const bIdx = bTab === 'basic' ? formSettingsBasicTabCols.indexOf(bName) : formSettingsAdvancedTabCols.indexOf(bName);
                return aIdx - bIdx;
            }

            return 0;
        });

        response.columns = filteredColumns;
    }

    window.datatableLocalJsonUpdate = function(val, conf) {
        //add value to every row if missing
        for (let i=0; i<val.length; i++) {
            if (typeof val[i]['fieldType'] === "undefined") {
                val[i]['fieldType'] = "";
            }
            if (typeof val[i]['required'] === "undefined") {
                val[i]['required'] = "false";
            }
            if (typeof val[i]['label'] === "undefined") {
                val[i]['label'] = "";
            }
            if (typeof val[i]['value'] === "undefined") {
                val[i]['value'] = "";
            }
            if (typeof val[i]['placeholder'] === "undefined") {
                val[i]['placeholder'] = "";
            }
            if (typeof val[i]['tooltip'] === "undefined") {
                val[i]['tooltip'] = "";
            }
        }
        return val;
    };

    async function appAfterInit(response, datatable) {
        //Set visibility options
        visibilityOptions = response.options.optionsTypeVisibility;

        window.addEventListener("WJ.DTE.innerTableInitialized", function(event) {

            if("DTE_Field_editorData" === event.detail.conf.id) {
                if(innerTable != null) return;
                innerTable = event.detail.conf.datatable;

                innerTable.EDITOR.on( 'open', function( e, mode, action ) {
                    $("#DTE_Field_fieldType").on('change', function() {

                        const value = innerTable.EDITOR.field("fieldType").val();
                        let fieldOption = getFieldOption(value);

                        var hideFields = fieldOption.split(",");
                        fields.forEach(function(fieldName) {
                            if(hideFields.includes(fieldName)) {
                                innerTable.EDITOR.field(fieldName).hide();
                                innerTable.EDITOR.field(fieldName).val("");
                            } else {
                                innerTable.EDITOR.field(fieldName).show();
                            }
                        });

                    });
                });
            }
        });
    }

    function appGetComponentCode(componentPath, params, componentDatatable, isInsert) {
        // Prepare include FIRST !!
        let include = "!INCLUDE(" + componentPath;
        include += ", formName=" + params.formName;
        include += ", rowView=" + params.rowView;

        //calling just to get editor data
        let defaultInclude = convertObjectToInludeParams(params);
        let defaulParams = defaultInclude.split(",");
        defaulParams.forEach(function(param) {
            param = param.trim();
            if(param.startsWith("editorData=")) {
                if(param.split("=")[1] !== "") {
                    include += ", " + param;
                } else {
                    include += ", editorData=JTVCJTVE";
                }
            }
        });
        include += ")!";


        let filteredParams = {};
        for (const [key, value] of Object.entries(params)) {
            if (key.startsWith("formSettings.")) {
                let shortKey = key.replace("formSettings.", "");

                if (Array.isArray(value)) {
                    if (value.length > 0) {
                        filteredParams[shortKey] = (value[0] === true) ? true : false;
                        continue;
                    }
                }

                filteredParams[shortKey] = value;
            }
        }

        // ensure backend receives the form name identifier
        filteredParams["formName"] = params.formName;

        fetch("/admin/rest/form-settings/save_attributes", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRF-Token": window.csrfToken
            },
            body: JSON.stringify(filteredParams)
        });

        return include;
    }

</script>