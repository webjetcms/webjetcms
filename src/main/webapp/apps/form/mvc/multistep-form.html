<link rel="stylesheet" type="text/css" href="/components/_common/cleditor/jquery.cleditor.css" />
<script type="text/javascript" src="/components/_common/javascript/jquery.browser.js"></script>
<script type="text/javascript" src="/components/_common/cleditor/jquery.cleditor.js"></script>
<script type="text/javascript" src="/components/_common/cleditor/jquery.cleditor.icon.js"></script>

<div class="multistep-form-app">

    <div class="alert alert-success" style="display:none;">
        <p data-th-text="#{multistep_form.form_save_succ}"></p>
    </div>

    <div class="alert alert-danger" style="display:none;">
        <p data-th-text="#{multistep_form.step_saving_err}"></p>
        <ul style="margin: 0px;">

        </ul>
    </div>

    <!-- Dynamic step content will be injected here -->
    <div id="multistepStepContent">
    </div>
</div>

<script th:inline="javascript">
    //CLEDITOR init
    $.cleditor.messages = []
    $.cleditor.messages['selection_required'] = /*[[#{components.cleditor.messages.selection_required}]]*/ "";
    $.cleditor.messages['cutcopypaste'] = /*[[#{components.cleditor.messages.cutcopypaste_disabled_by_browser}]]*/ "";
    $.cleditor.messages['urlenter'] = /*[[#{components.cleditor.messages.urlenter}]]*/ "";
    $.cleditor.messages['submit'] = /*[[#{components.cleditor.messages.submit}]]*/ "";
    $.cleditor.messages['pastetext'] = /*[[#{components.cleditor.messages.pastetext}]]*/ "";

    $.cleditor.title = []
    $.cleditor.title['bold'] = /*[[#{components.cleditor.title.bold}]]*/ "";
</script>

<script th:inline="javascript">
    let stepPath = /*[[${stepPath}]]*/ "";
    let formName = /*[[${formName}]]*/ "";
    let stepId = /*[[${stepId}]]*/ "";

    // Load step HTML from REST endpoint and inject
    function loadStep(formName, stepId) {
        if(!formName || !stepId) {
            console.warn("Missing formName or stepId; skipping load.");
            return;
        }
        const url = `/rest/multistep-form/get-step?form-name=${encodeURIComponent(formName)}&step-id=${encodeURIComponent(stepId)}`;
        fetch(url, {
            method: 'GET',
            headers: { 'Accept': 'text/html,application/json' }
        })
            .then(async r => {
                if(!r.ok) {
                    const raw = await r.text();
                    let message = 'Chyba pri načítaní kroku.';
                    try {
                        let parsed;
                        try { parsed = JSON.parse(raw); } catch(_) { parsed = {raw}; }
                        await showGlobalErr(parsed);
                    } catch(e) { /* not JSON */ }
                }
                return r.text();
            })
            .then(html => {
                // !! DO NOT use document ... because html contain's js/css that must be executed/loaded
                $("#multistepStepContent").html(html);
                $("#multistepStepContent > form").append(`<button type="submit" class="btn btn-primary" name="saveForm">Submit</button>`);

                // Handle submit event
                document.querySelector("#multistepStepContent > form").addEventListener("submit", async function (event) { await doValidationAndSave(event); });

                // INIT wysiwyg aka cleditor
                window.setTimeout(function() {
                    $("textarea.formsimple-wysiwyg").cleditor({
                        width      : "100%",
                        controls   : "bold italic underline bullets numbering outdent indent image link icon size color highlight pastetext",
                        bodyStyle  : "font: 11px  Arial, Helvetica, sans-serif;"
                    });
                }, 100);
            })
            .catch(err => {
                console.warn('Failed to load step:', err);
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadStep(formName, stepId);
    });

    async function doValidationAndSave(event) {
        event.preventDefault();

        const form = event.currentTarget;
        const url = form.action;

        const result = {};
        form.querySelectorAll("input, textarea, select").forEach(el => {
            if (!el.name) return;

            // Determine value (skip unchecked radios/checkboxes)
            if (el.type === "checkbox" || el.type === "radio") {
            if (!el.checked) return;
            }
            const value = el.value;

            // If name already exists, ensure array and push
            if (Object.prototype.hasOwnProperty.call(result, el.name)) {
            if (Array.isArray(result[el.name])) {
                result[el.name].push(value);
            } else {
                result[el.name] = [ result[el.name], value ];
            }
            } else {
            result[el.name] = value;
            }
        });

        try {
            const resp = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(result)
            });

            const text = await resp.text();
            let parsed;
            try { parsed = JSON.parse(text); } catch(_) { parsed = {raw:text}; }
            if (!resp.ok) {
                await showGlobalErr(parsed);
            } else {
                await postSaveAction(parsed);
            }
        } catch(err) {
            console.error('Network/JS error submitting form', err);
        }
    }

    async function showGlobalErr(response) {
        const message = response.message || "Unknown error occurred.";
        $("div.alert.alert-danger").show();
        $("div.alert.alert-danger > ul").html(`<li><span>${message}</span></li>`);
    }

    async function postSaveAction(response) {
        //Clean all err fields
        $("div.cs-error").text("");

        const fieldErrors = response.fieldErrors || {};
        if(fieldErrors && Object.keys(fieldErrors).length > 0) {
            // There are field errors - display them
            for(const [fieldName, errorMsg] of Object.entries(fieldErrors)) {
                const errDiv = $("div.cs-error-" + fieldName);
                const errorMsgArr = errorMsg.split("\n");
                errDiv.html("");
                let html = "<ul style='margin:0px; padding-left: 20px;'>";
                for(const msg of errorMsgArr) {
                    html += `<li>${msg}</li>`;
                }
                html += "</ul>";
                errDiv.html(html);
            }
        } else {
            // No field errors - possibly proceed to next step or show success message
            const formName = response["form-name"];
            const stepId = response["step-id"];
            if(formName && stepId) {
                if(stepId === -1) {
                    //End of form
                    $("#multistepStepContent").remove();
                    $("div.alert.alert-success").show();
                } else {
                    // Show another step
                    $("div.alert.alert-danger").hide();
                    loadStep(formName, stepId);
                }
            }
        }
    }
</script>

<style>
    div.form-group {
        border: 1px solid;
        margin: 5px;
        padding: 5px;
    }

    div.form-group > label > p {
        padding: 0px;
    }
</style>