<script data-th-inline="javascript">
    let url = "/admin/rest/forms-list/";
    let columns = /*[(${layout.getDataTableColumns("sk.iway.iwcm.components.forms.FormsEntity")})]*/ '';
    const formColumnsToKeep = ["id", "formName", "count", "createDate", "formType"];
    const basicSettingColumns = ["forward", "forwardFail", "isPdf", "allowOnlyOneSubmit", "overwriteOldForms", "doubleOptIn", "messageAsAttach", "messageAsAttachFileName", "encryptKey", "encrypKeyInfo", "useFormDoc", "formmailSendUserInfoDoc"];
    const emailSettingColumns = ["recipients", "ccEmails", "bccEmails", "replyTo", "subject", "forceTextPlain", "formMailEncoding", "addTechInfo", "emailTextBefore", "emailTextAfter"];
    const advancedSettingColumns = ["rowView", "formAddClasses", "formCss", "afterSendInterceptor", "maxSizeInKilobytes", "allowedExtensions", "pictureHeight", "pictureWidth"];
    const deprecatedSettingColumns = ["savedb", "forwardType", "fieldsEmailHeader", "useFormMailDoc"];

    var tabs = [
        { id: 'basic', title: /*[[#{datatable.tab.basic}]]*/ '', selected: true },
        { id: 'settings-basic', title: /*[[#{editor.form_setting.basic_tab}]]*/ '', selected: false },
        { id: 'settings-email', title: /*[[#{editor.form_setting.email_tab}]]*/ '', selected: false },
        { id: 'settings-advanced', title: /*[[#{datatable.tab.advanced}]]*/ '', selected: false },
        { id: 'settings-deprecated', title: /*[[#{editor.form_setting.deprecated_tab}]]*/ '', selected: false },
    ];
</script>

<script type="text/javascript">
    var formsDataTable;

    WJ.breadcrumb({
        id: "forms",
        tabs: [
            {
                url: "/apps/form/admin/",
                title: WJ.translate("forms.formsList.js"),
                active: true
            }
        ]
    });

    window.openFormHtml = function (formName) {
        if(formName == undefined || formName == null) return;
        window.location.href="/apps/form/admin/detail/?formName="+ formName;
    }

    let filteredColumns = [];
    columns.forEach(function(column) {
        if(formColumnsToKeep.includes(column.data)) filteredColumns.push(column);
        else if(column.data.startsWith("formSettings.")) {

            column.hidden = true;
            if(basicSettingColumns.includes(column.data.substring("formSettings.".length)) === true) { column.editor.tab = "settings-basic"; }
            else if(emailSettingColumns.includes(column.data.substring("formSettings.".length)) === true) { column.editor.tab = "settings-email"; }
            else if(advancedSettingColumns.includes(column.data.substring("formSettings.".length)) === true) { column.editor.tab = "settings-advanced"; }
            else if(deprecatedSettingColumns.includes(column.data.substring("formSettings.".length)) === true) { column.editor.tab = "settings-deprecated"; }
            else { column.editor.tab = "settings-basic"; } // Just in case, put it into basic tab

            filteredColumns.push(column);
        }
    });

    window.WJ.DataTable.mergeColumns(filteredColumns, { name: "createDate", title: '[[#{formslist.datum_posledneho}]]' });
    window.WJ.DataTable.mergeColumns(filteredColumns, {
        name:"formName",
        renderFormatLinkTemplate: "javascript:openFormHtml('{{formName}}');",
        renderFormatPrefix: '<i class="ti ti-eye"></i> '
    });
    let columnsFetchPromise = Promise.resolve();

    var editorWasInitialized = false;
    window.domReady.add(function () {
        // !! hide form steps tab link !! - show only in form detail view
        $("a.nav-link[href='/apps/form/admin/form-content/']").hide();

        var order = [];
        order.push([4, 'desc']);

        function initformsDataTable() {
            formsDataTable = WJ.DataTable({
                url:  url,
                columns: filteredColumns,
                id: 'formsDataTable',
                serverSide: false,
                tabs: tabs,
                order: order,
                idAutoOpener: true,
                lastExportColumnName: 'lastExportDate',
                byIdExportColumnName: 'id',
                fetchOnEdit: true,
                fetchOnCreate: true
            });
            formsDataTable.hideButtons(['celledit', 'duplicate', 'import']);

            formsDataTable.button().add(4, {
                extends: 'remove',
                text: '<i class="ti ti-archive"></i>',
                action: function (e, dt, node) {
                    //console.log("Rotate, e=",e," dt=",dt," node=",node);
                    formsDataTable.executeAction("archiveForm");
                },
                init: function ( dt, node, config ) {
                    $.fn.dataTable.Buttons.showIfRowSelected(this, dt);
                },
                className: 'btn btn-outline-secondary',
                attr: {
                    'title': '[[#{components.form.admin_forms.archivuj_formular}]]',
                    'data-toggle': 'tooltip'
                }
            });

            formsDataTable.EDITOR.on('open', function (e, type, action) {
                initEditor();

                let formType = formsDataTable.EDITOR.field('formType').get();
                if("multistep" === formType) {
                    $("#pills-dt-formsDataTable-settings-deprecated-tab").hide();
                } else {
                    $("#pills-dt-formsDataTable-settings-deprecated-tab").show();
                }

                filteredColumns.forEach(function(column) {
                    if("formSettings.id" === column.data) { return; }

                    if(column.data.startsWith("formSettings.")) {
                        let className = column.className;
                        if(className) {
                            let classNames = className.split(" ");

                            if(formType === "simple" && classNames.includes("not-formsimple")) {
                                formsDataTable.EDITOR.field(column.data).hide();
                            } else if(formType === "basic" && classNames.includes("not-form")) {
                                formsDataTable.EDITOR.field(column.data).hide();
                            } else {
                                formsDataTable.EDITOR.field(column.data).show();
                            }
                        }
                    }
                });

                if("create" === action) {
                    formsDataTable.EDITOR.field("formName").enable();
                    formsDataTable.EDITOR.field("count").hide();
                    formsDataTable.EDITOR.field("createDate").hide();
                    $(".DTE_Action_Create").find(".modal-title").text("[[#{editor.form_setting.add_multistep_form}]]");
                } else {
                    formsDataTable.EDITOR.field("formName").disable();
                    formsDataTable.EDITOR.field("count").show();
                    formsDataTable.EDITOR.field("createDate").show();
                }
            });

            function initEditor() {
                if(editorWasInitialized === false) {
                    editorWasInitialized = true;
                    //Show hide file name field based on checkbox
                    $("#DTE_Field_formSettings-messageAsAttach_0").on("change", function() {
                        if($(this).is(":checked")) {
                            $("div.DTE_Field_Name_formSettings\\.messageAsAttachFileName").show();
                        } else {
                            $("div.DTE_Field_Name_formSettings\\.messageAsAttachFileName").hide();
                        }
                    });
                }
            }
        }

        //Initialize after potential dynamic column fetch
        columnsFetchPromise.finally(() => initformsDataTable());

    });
</script>

<table id="formsDataTable" class="datatableInit table"></table>