Feature('pentests.links');

var errorPageText = "Chyba 404 - požadovaná stránka neexistuje";

Scenario('odhlasenie 1', ({I}) => {
    I.logout();
});

Scenario('jquery', ({I}) => {
    //verzia 1.4.1, presunute na /components/_common
    I.amOnPage("/admin/");
    I.executeScript(() => window.location.href='/components/gdpr/jscripts/jquery.cookie.js');
    I.wait(2);
    //pri plnom spusteni sa vela krat vola 404 a vrati to prazdnu stranku
    //I.waitForText("sa nenašla žiadna webová stránka", 4);
    //I.see("sa nenašla žiadna webová stránka");
    //presmerovane I.dontSee("jQuery");
    I.seeInCurrentUrl('/components/_common/javascript/jquery.cookie.js');
});

Scenario('mem.jsp', ({I}) => {
    //overenie, ze mem.jsp sa da volat len z povolenych IP adries
    I.amOnPage("/admin/mem.jsp?printTrace=true");
    I.see("java.runtime.name");
    I.setPlaywrightRequestHeaders({'X-forwarded-for': '8.8.8.8'});
    I.amOnPage("/admin/mem.jsp?printTrace=true");
    I.see(errorPageText);
    I.setPlaywrightRequestHeaders({});
    I.amOnPage("/admin/mem.jsp?printTrace=true");
    I.see("java.runtime.name");
});

Scenario('clear header', ({I}) => {
    I.amOnPage("/admin/");
    I.setPlaywrightRequestHeaders({});
    I.amOnPage("/admin/mem.jsp");
});

Scenario('file download - test logon.jsp', ({I}) => {
    //povodne bolo podolene volanie /components/user/logon.jsp, to je nahradene za forward, pouzivalo sa pre file download
    I.amOnPage("/components/user/logon.jsp");
    I.see(errorPageText);
});

Scenario('file download - cookie test', ({I}) => {
    //skus stiahnut subor
    I.logout();
    //na LB sa zmaze cookie pri volani /files, testneme ze ju setne logon.jsp
    I.clearCookie();

    I.amOnPage("/files/zaheslovane/barepage.png");

    I.dontSee("Kontakt"); //tu mame len zakladny form bez generovanej stranky
    I.see("Zadajte vaše prihlasovacie údaje");
    I.fillField("username", "tester");
    I.fillField("password", secret(I.getDefaultPassword()));
    I.click(".btn-success");
    I.wait(4);
    I.dontSee(errorPageText);
    I.dontSee("Zadajte vaše prihlasovacie údaje");
    //nie som na homepage
    I.dontSee("Naši bankári");

    I.logout();
});

Scenario('file download - peknylogin', ({I}) => {
    //verzia kde mame pekne generovanu stranku, problem na IWAY prostredi s tym, ze pri pristupe na /files sa nepreposlu cookies a
    //zabudne sa linka na subor po prihlaseni (kedze session sa destroyne)
    //cookies sa musi nastavit cez document.cookie v head.jsp a je to pre istotu aj v logon.jsp
    I.logout();
    I.clearCookie();

    I.amOnPage("/files/zaheslovane/peknylogin/barepage.png");

    I.see("Kontakt");
    I.see("Zadajte vaše prihlasovacie údaje");
    I.fillField("username", "tester");
    I.fillField("password", secret(I.getDefaultPassword()));
    I.click(".btn-success");
    I.wait(4);
    I.dontSee(errorPageText);
    I.dontSee("Zadajte vaše prihlasovacie údaje");
    //nie som na homepage
    I.dontSee("Kontakt");

    I.logout();
});

Scenario('file download - peknylogin - zleheslo', ({I}) => {
    //skus stiahnut subor
    I.logout();
    I.clearCookie();

    I.amOnPage("/files/zaheslovane/peknylogin/barepage.png");

    I.see("Kontakt");
    I.see("Zadajte vaše prihlasovacie údaje");
    I.fillField("username", "tester");
    I.fillField("password", secret(I.getDefaultPassword()));
    I.click(".btn-success");
    I.wait(4);
    I.dontSee(errorPageText);
    I.dontSee("Zadajte vaše prihlasovacie údaje");
    //nie som na homepage
    I.dontSee("Kontakt");

    I.logout();
});

Scenario('odhlasenie 2', ({I}) => {
    I.logout();
});

Scenario('forum new', ({I, DTE, Browser}) => {
    var random = I.getRandomText();
    var subject = "Test príspevok "+random;
    var body = "Toto je testovaci prispevok. "+random;

    //povodne bolo mozne volat /components/forum/new.jsp, teraz sa da volat len po zobrazeni fora
    I.amOnPage("/components/forum/new.jsp");
    I.see(errorPageText);

    //zobraz forum a over kliknutie na novy prispevok
    I.amOnPage("/apps/diskusia/?NO_WJTOOLBAR=true");
    I.click("Nový príspevok");
    I.waitForElement("#forum");
    I.see("Poslať notifikáciu pri odpovedi na príspevok");
    I.waitForElement(".cleditorMain", 10);
    I.fillField("authorName", "Autotest");
    I.fillField("authorEmail", "tester@balat.sk");
    I.fillField("subject", subject);
    I.fillField("subject", subject);
    DTE.fillCleditor("#forum", body);

    I.clickCss("div.ui-dialog button.btn.btn-primary");
    I.wait(0.5);
    I.see("Príspevok je uložený");

    //over schovanie dialogu
    I.waitForInvisible("div.ui-dialog");
    I.dontSee("div.ui-dialog");
    I.dontSee("Poslať notifikáciu pri odpovedi na príspevok");

    //over zobrazenie prispevku
    I.waitForText(subject, 10);
    I.see(subject);
    I.see(body);
});

Scenario('tomcat error - version and stack trace ', ({I}) => {
    //nesmie zobrazit 405 - method not allowed
    I.amOnPage("/formmail.do?");
    I.dontSee("Method Not Allowed");
    I.dontSee("Apache Tomcat");
    I.see(errorPageText);

    //nesmie zobrazit Apache Tomcat/9.0.43 a stack trace
    //riesene nastavenim org.apache.catalina.valves.ErrorReportValve v <Host elemente
    I.amOnPage("?[0]");
    I.dontSee("Apache Tomcat");
    I.dontSee("Exception Report");
    I.dontSee("java.lang.IllegalArgumentException");
});

Scenario('topdf', ({I}) => {
    //topdf bez zadaneho docid nesmie nic zobrazit, detto s neexistujucim docid
    I.amOnPage("/topdf");
    I.see(errorPageText);

    I.amOnPage("/topdf/nieco.pdf");
    I.see(errorPageText);

    I.amOnPage("/topdf/nieco.pdf?docid=5");
    I.see(errorPageText);
});
